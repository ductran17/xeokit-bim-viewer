!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).bundle={})}(this,(function(e){"use strict";class t{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(2===arguments.length){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const i=new t;class s{constructor(e){this.id=e,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0}}class r{constructor(){this.items=[]}}class o{constructor(e,t,i,s,r){this.id=e,this.getTitle=t,this.doAction=i,this.getEnabled=s,this.getShown=r,this.itemElement=null,this.subMenu=null,this.enabled=!0}}class n{constructor(e={}){this._id=i.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},!1!==e.hideOnMouseDown&&(document.addEventListener("mousedown",(e=>{e.target.classList.contains("xeokit-context-menu-item")||this.hide()})),document.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{e.target.classList.contains("xeokit-context-menu-item")||this.hide()})),e.items&&(this.items=e.items),this.context=e.context,this.enabled=!1!==e.enabled,this.hide()}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}set items(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI()}get items(){return this._itemsCfg}set enabled(e){(e=!!e)!==this._enabled&&(this._enabled=e,this._enabled||this.hide())}get enabled(){return this._enabled}set context(e){this._context=e}get context(){return this._context}show(e,t){this._context?this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,t),this._shown=!0,this.fire("shown",{}))):console.error("ContextMenu cannot be shown without a context - set context first")}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}destroy(){this._context=null,this._clear(),null!==this._id&&(i.removeItem(this._id),this._id=null)}_clear(){for(let e=0,t=this._menuList.length;e<t;e++){const t=this._menuList[e].menuElement;t.parentElement.removeChild(t)}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}_parseItems(e){const t=e=>{const i=this._getNextId(),n=new s(i);for(let i=0,s=e.length;i<s;i++){const s=e[i],a=new r;n.groups.push(a);for(let e=0,i=s.length;e<i;e++){const i=s[e],r=i.items,l=r&&r.length>0,h=this._getNextId(),c=i.getTitle||(()=>i.title||""),u=i.doAction||i.callback||(()=>{}),d=i.getEnabled||(()=>!0),p=i.getShown||(()=>!0),f=new o(h,c,u,d,p);if(f.parentMenu=n,a.items.push(f),l){const e=t(r);f.subMenu=e,e.parentItem=f}this._itemList.push(f),this._itemMap[f.id]=f}}return this._menuList.push(n),this._menuMap[n.id]=n,n};this._rootMenu=t(e)}_getNextId(){return"ContextMenu_"+this._id+this._nextId++}_createUI(){const e=t=>{this._createMenuUI(t);const i=t.groups;for(let t=0,s=i.length;t<s;t++){const s=i[t].items;for(let t=0,i=s.length;t<i;t++){const i=s[t].subMenu;i&&e(i)}}};e(this._rootMenu)}_createMenuUI(e){const t=e.groups,i=[];if(i.push('<div class="xeokit-context-menu '+e.id+'" style="z-index:300000; position: absolute;">'),i.push("<ul>"),t)for(let e=0,s=t.length;e<s;e++){const r=e,o=s,n=t[e].items;if(n)for(let e=0,t=n.length;e<t;e++){const s=n[e],a=s.subMenu,l=s.title||"";a?i.push('<li id="'+s.id+'" class="xeokit-context-menu-item" style="'+(r===o-1||e<t-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+l+" [MORE]</li>"):i.push('<li id="'+s.id+'" class="xeokit-context-menu-item" style="'+(r===o-1||e<t-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+l+"</li>")}}i.push("</ul>"),i.push("</div>");const s=i.join("");document.body.insertAdjacentHTML("beforeend",s);const r=document.querySelector("."+e.id);e.menuElement=r,r.style["border-radius"]="4px",r.style.display="none",r.style["z-index"]=3e5,r.style.background="white",r.style.border="1px solid black",r.style["box-shadow"]="0 4px 5px 0 gray",r.oncontextmenu=e=>{e.preventDefault()};const o=this;let n=null;if(t)for(let e=0,i=t.length;e<i;e++){const i=t[e].items;if(i)for(let e=0,t=i.length;e<t;e++){const t=i[e],s=t.subMenu;t.itemElement=document.getElementById(t.id),t.itemElement?(t.itemElement.addEventListener("mouseenter",(e=>{e.preventDefault();const i=t.subMenu;if(!i)return void(n&&(o._hideMenu(n.id),n=null));if(n&&n.id!==i.id&&(o._hideMenu(n.id),n=null),!1===t.enabled)return;const s=t.itemElement,r=i.menuElement,a=s.getBoundingClientRect();r.getBoundingClientRect();a.right+200>window.innerWidth?o._showMenu(i.id,a.left-200,a.top-1):o._showMenu(i.id,a.right-5,a.top-1),n=i})),s||(t.itemElement.addEventListener("click",(e=>{e.preventDefault(),o.hide(),o._context&&!1!==t.enabled&&t.doAction&&t.doAction(o._context)})),t.itemElement.addEventListener("mouseenter",(e=>{e.preventDefault(),!1!==t.enabled&&t.doHover&&t.doHover(o._context)})))):console.error("ContextMenu item element not found: "+t.id)}}}_updateItemsTitles(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const t=this._itemList[e],i=t.itemElement;if(!i)continue;const s=t.getShown;if(!s||!s(this._context))continue;const r=t.getTitle(this._context);t.subMenu,i.innerText=r}}_updateItemsEnabledStatus(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const t=this._itemList[e],i=t.itemElement;if(!i)continue;const s=t.getEnabled;if(!s)continue;const r=t.getShown;if(!r)continue;const o=r(this._context);if(t.shown=o,!o){i.style.visibility="hidden",i.style.height="0",i.style.padding="0";continue}i.style.visibility="visible",i.style.height="auto",i.style.padding=null;const n=s(this._context);t.enabled=n,n?i.classList.remove("disabled"):i.classList.add("disabled")}}_showMenu(e,t,i){const s=this._menuMap[e];if(!s)return void console.error("Menu not found: "+e);if(s.shown)return;const r=s.menuElement;r&&(this._showMenuElement(r,t,i),s.shown=!0)}_hideMenu(e){const t=this._menuMap[e];if(!t)return void console.error("Menu not found: "+e);if(!t.shown)return;const i=t.menuElement;i&&(this._hideMenuElement(i),t.shown=!1)}_hideAllMenus(){for(let e=0,t=this._menuList.length;e<t;e++){const t=this._menuList[e];this._hideMenu(t.id)}}_showMenuElement(e,t,i){e.style.display="block";const s=e.offsetHeight,r=e.offsetWidth;i+s>window.innerHeight&&(i=window.innerHeight-s),t+r>window.innerWidth&&(t=window.innerWidth-r),e.style.left=t+"px",e.style.top=i+"px"}_hideMenuElement(e){e.style.display="none"}}class a{constructor(e,t,i){this.id=i&&i.id?i.id:e,this.viewer=t,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,t.addPlugin(this)}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new t),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();r[o]={callback:i,scope:s||this},this._subIdEvents[o]=e;const n=this._events[e];return void 0!==n&&i.call(s||this,n),o}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,(function(e){s.off(r),t.call(i||this,e)}),i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`)}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`)}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`)}send(e,t){}destroy(){this.viewer.removePlugin(this)}}let l=!0,h=l?Float64Array:Float32Array;const c=new h(16),u=new h(16),d=new h(4),p={setDoublePrecisionEnabled(e){l=e,h=l?Float64Array:Float32Array},getDoublePrecisionEnabled:()=>l,MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(e,t){const i=t.indexOf("#");return i===e.length&&t.startsWith(e)?t.substring(i+1):t},globalizeObjectId:(e,t)=>e+"#"+t,vec2:e=>new h(e||2),vec3:e=>new h(e||3),vec4:e=>new h(e||4),mat3:e=>new h(e||9),mat3ToMat4:(e,t=new h(16))=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),mat4:e=>new h(e||16),mat4ToMat3(e,t){},doublesToFloats(e,t,i){const s=new h(2);for(let r=0,o=e.length;r<o;r++)p.splitDouble(e[r],s),t[r]=s[0],i[r]=s[1]},splitDouble(e,t){const i=h.from([e])[0],s=e-i;t[0]=i,t[1]=s},createUUID:(()=>{const e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return()=>{const t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]}-${e[255&i]}${e[i>>8&255]}-${e[i>>16&15|64]}${e[i>>24&255]}-${e[63&s|128]}${e[s>>8&255]}-${e[s>>16&255]}${e[s>>24&255]}${e[255&r]}${e[r>>8&255]}${e[r>>16&255]}${e[r>>24&255]}`}})(),clamp:(e,t,i)=>Math.max(t,Math.min(i,e)),fmod(e,t){if(e<t)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},compareVec3:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2],negateVec3:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t),negateVec4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t),addVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i),addVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i),addVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i),addVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i),subVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i),subVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i),subVec2:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i),geometricMeanVec2(...e){const t=new h(e[0]);for(let i=1;i<e.length;i++)t[0]+=e[i][0],t[1]+=e[i][1];return t[0]/=e.length,t[1]/=e.length,t},subVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i),subScalarVec4:(e,t,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i),mulVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i),mulVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i),mulVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i),mulVec2Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i),divVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i),divVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i),divScalarVec3:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i),divVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i),divVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i),divScalarVec4:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i),dotVec4:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],cross3Vec4(e,t){const i=e[0],s=e[1],r=e[2],o=t[0],n=t[1],a=t[2];return[s*a-r*n,r*o-i*a,i*n-s*o,0]},cross3Vec3(e,t,i){i||(i=e);const s=e[0],r=e[1],o=e[2],n=t[0],a=t[1],l=t[2];return i[0]=r*l-o*a,i[1]=o*n-s*l,i[2]=s*a-r*n,i},sqLenVec4:e=>p.dotVec4(e,e),lenVec4:e=>Math.sqrt(p.sqLenVec4(e)),dotVec3:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],dotVec2:(e,t)=>e[0]*t[0]+e[1]*t[1],sqLenVec3:e=>p.dotVec3(e,e),sqLenVec2:e=>p.dotVec2(e,e),lenVec3:e=>Math.sqrt(p.sqLenVec3(e)),distVec3:(()=>{const e=new h(3);return(t,i)=>p.lenVec3(p.subVec3(t,i,e))})(),lenVec2:e=>Math.sqrt(p.sqLenVec2(e)),distVec2:(()=>{const e=new h(2);return(t,i)=>p.lenVec2(p.subVec2(t,i,e))})(),rcpVec3:(e,t)=>p.divScalarVec3(1,e,t),normalizeVec4(e,t){const i=1/p.lenVec4(e);return p.mulVec4Scalar(e,i,t)},normalizeVec3(e,t){const i=1/p.lenVec3(e);return p.mulVec3Scalar(e,i,t)},normalizeVec2(e,t){const i=1/p.lenVec2(e);return p.mulVec2Scalar(e,i,t)},angleVec3(e,t){let i=p.dotVec3(e,t)/Math.sqrt(p.sqLenVec3(e)*p.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const e=new h(3);return(t,i)=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=p.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=p.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=p.lenVec3(e),i)})(),vecToArray:(()=>{function e(e){return Math.round(1e5*e)/1e5}return t=>{for(let i=0,s=(t=Array.prototype.slice.call(t)).length;i<s;i++)t[i]=e(t[i]);return t}})(),xyzArrayToObject:e=>({x:e[0],y:e[1],z:e[2]}),xyzObjectToArray:(e,t)=>((t=t||p.vec3())[0]=e.x,t[1]=e.y,t[2]=e.z,t),dupMat4:e=>e.slice(0,16),mat4To3:e=>[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]],m4s:e=>[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],setMat4ToZeroes:()=>p.m4s(0),setMat4ToOnes:()=>p.m4s(1),diagonalMat4v:e=>new h([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]),diagonalMat4c:(e,t,i,s)=>p.diagonalMat4v([e,t,i,s]),diagonalMat4s:e=>p.diagonalMat4c(e,e,e,e),identityMat4:(e=new h(16))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),identityMat3:(e=new h(9))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e),isIdentityMat4:e=>1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15],negateMat4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t),addMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i),addMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i),addScalarMat4:(e,t,i)=>p.addMat4Scalar(t,e,i),subMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i),subMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i),subScalarMat4:(e,t,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i),mulMat4(e,t,i){i||(i=e);const s=e[0],r=e[1],o=e[2],n=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],p=e[10],f=e[11],m=e[12],g=e[13],_=e[14],v=e[15],b=t[0],x=t[1],y=t[2],P=t[3],w=t[4],M=t[5],C=t[6],E=t[7],A=t[8],D=t[9],T=t[10],S=t[11],I=t[12],F=t[13],L=t[14],B=t[15];return i[0]=b*s+x*a+y*u+P*m,i[1]=b*r+x*l+y*d+P*g,i[2]=b*o+x*h+y*p+P*_,i[3]=b*n+x*c+y*f+P*v,i[4]=w*s+M*a+C*u+E*m,i[5]=w*r+M*l+C*d+E*g,i[6]=w*o+M*h+C*p+E*_,i[7]=w*n+M*c+C*f+E*v,i[8]=A*s+D*a+T*u+S*m,i[9]=A*r+D*l+T*d+S*g,i[10]=A*o+D*h+T*p+S*_,i[11]=A*n+D*c+T*f+S*v,i[12]=I*s+F*a+L*u+B*m,i[13]=I*r+F*l+L*d+B*g,i[14]=I*o+F*h+L*p+B*_,i[15]=I*n+F*c+L*f+B*v,i},mulMat3(e,t,i){i||(i=new h(9));const s=e[0],r=e[3],o=e[6],n=e[1],a=e[4],l=e[7],c=e[2],u=e[5],d=e[8],p=t[0],f=t[3],m=t[6],g=t[1],_=t[4],v=t[7],b=t[2],x=t[5],y=t[8];return i[0]=s*p+r*g+o*b,i[3]=s*f+r*_+o*x,i[6]=s*m+r*v+o*y,i[1]=n*p+a*g+l*b,i[4]=n*f+a*_+l*x,i[7]=n*m+a*v+l*y,i[2]=c*p+u*g+d*b,i[5]=c*f+u*_+d*x,i[8]=c*m+u*v+d*y,i},mulMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i),mulMat4v4(e,t,i=p.vec4()){const s=t[0],r=t[1],o=t[2],n=t[3];return i[0]=e[0]*s+e[4]*r+e[8]*o+e[12]*n,i[1]=e[1]*s+e[5]*r+e[9]*o+e[13]*n,i[2]=e[2]*s+e[6]*r+e[10]*o+e[14]*n,i[3]=e[3]*s+e[7]*r+e[11]*o+e[15]*n,i},transposeMat4(e,t){const i=e[4],s=e[14],r=e[8],o=e[13],n=e[12],a=e[9];if(!t||e===t){const t=e[1],l=e[2],h=e[3],c=e[6],u=e[7],d=e[11];return e[1]=i,e[2]=r,e[3]=n,e[4]=t,e[6]=a,e[7]=o,e[8]=l,e[9]=c,e[11]=s,e[12]=h,e[13]=u,e[14]=d,e}return t[0]=e[0],t[1]=i,t[2]=r,t[3]=n,t[4]=e[1],t[5]=e[5],t[6]=a,t[7]=o,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=s,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3(e,t){if(t===e){const i=e[1],s=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4(e){const t=e[0],i=e[1],s=e[2],r=e[3],o=e[4],n=e[5],a=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15];return p*c*a*r-h*f*a*r-p*n*u*r+o*f*u*r+h*n*m*r-o*c*m*r-p*c*s*l+h*f*s*l+p*i*u*l-t*f*u*l-h*i*m*l+t*c*m*l+p*n*s*d-o*f*s*d-p*i*a*d+t*f*a*d+o*i*m*d-t*n*m*d-h*n*s*g+o*c*s*g+h*i*a*g-t*c*a*g-o*i*u*g+t*n*u*g},inverseMat4(e,t){t||(t=e);const i=e[0],s=e[1],r=e[2],o=e[3],n=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],_=e[15],v=i*a-s*n,b=i*l-r*n,x=i*h-o*n,y=s*l-r*a,P=s*h-o*a,w=r*h-o*l,M=c*m-u*f,C=c*g-d*f,E=c*_-p*f,A=u*g-d*m,D=u*_-p*m,T=d*_-p*g,S=1/(v*T-b*D+x*A+y*E-P*C+w*M);return t[0]=(a*T-l*D+h*A)*S,t[1]=(-s*T+r*D-o*A)*S,t[2]=(m*w-g*P+_*y)*S,t[3]=(-u*w+d*P-p*y)*S,t[4]=(-n*T+l*E-h*C)*S,t[5]=(i*T-r*E+o*C)*S,t[6]=(-f*w+g*x-_*b)*S,t[7]=(c*w-d*x+p*b)*S,t[8]=(n*D-a*E+h*M)*S,t[9]=(-i*D+s*E-o*M)*S,t[10]=(f*P-m*x+_*v)*S,t[11]=(-c*P+u*x-p*v)*S,t[12]=(-n*A+a*C-l*M)*S,t[13]=(i*A-s*C+r*M)*S,t[14]=(-f*y+m*b-g*v)*S,t[15]=(c*y-u*b+d*v)*S,t},traceMat4:e=>e[0]+e[5]+e[10]+e[15],translationMat4v(e,t){const i=t||p.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v(e,t){const i=t||p.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:(()=>{const e=new h(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,p.translationMat4v(e,r))})(),translationMat4s:(e,t)=>p.translationMat4c(e,e,e,t),translateMat4v:(e,t)=>p.translateMat4c(e[0],e[1],e[2],t),translateMat4c(e,t,i,s){const r=s[3];s[0]+=r*e,s[1]+=r*t,s[2]+=r*i;const o=s[7];s[4]+=o*e,s[5]+=o*t,s[6]+=o*i;const n=s[11];s[8]+=n*e,s[9]+=n*t,s[10]+=n*i;const a=s[15];return s[12]+=a*e,s[13]+=a*t,s[14]+=a*i,s},setMat4Translation:(e,t,i)=>(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=e[15],i),rotationMat4v(e,t,i){const s=p.normalizeVec4([t[0],t[1],t[2],0],[]),r=Math.sin(e),o=Math.cos(e),n=1-o,a=s[0],l=s[1],h=s[2];let c,u,d,f,m,g;return c=a*l,u=l*h,d=h*a,f=a*r,m=l*r,g=h*r,(i=i||p.mat4())[0]=n*a*a+o,i[1]=n*c+g,i[2]=n*d-m,i[3]=0,i[4]=n*c-g,i[5]=n*l*l+o,i[6]=n*u+f,i[7]=0,i[8]=n*d+m,i[9]=n*u-f,i[10]=n*h*h+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(e,t,i,s,r)=>p.rotationMat4v(e,[t,i,s],r),scalingMat4v:(e,t=p.identityMat4())=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scalingMat3v:(e,t=p.identityMat3())=>(t[0]=e[0],t[4]=e[1],t),scalingMat4c:(()=>{const e=new h(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,p.scalingMat4v(e,r))})(),scaleMat4c:(e,t,i,s)=>(s[0]*=e,s[4]*=t,s[8]*=i,s[1]*=e,s[5]*=t,s[9]*=i,s[2]*=e,s[6]*=t,s[10]*=i,s[3]*=e,s[7]*=t,s[11]*=i,s),scaleMat4v(e,t){const i=e[0],s=e[1],r=e[2];return t[0]*=i,t[4]*=s,t[8]*=r,t[1]*=i,t[5]*=s,t[9]*=r,t[2]*=i,t[6]*=s,t[10]*=r,t[3]*=i,t[7]*=s,t[11]*=r,t},scalingMat4s:e=>p.scalingMat4c(e,e,e),rotationTranslationMat4(e,t,i=p.mat4()){const s=e[0],r=e[1],o=e[2],n=e[3],a=s+s,l=r+r,h=o+o,c=s*a,u=s*l,d=s*h,f=r*l,m=r*h,g=o*h,_=n*a,v=n*l,b=n*h;return i[0]=1-(f+g),i[1]=u+b,i[2]=d-v,i[3]=0,i[4]=u-b,i[5]=1-(c+g),i[6]=m+_,i[7]=0,i[8]=d+v,i[9]=m-_,i[10]=1-(c+f),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler(e,t,i=p.vec4()){const s=p.clamp,r=e[0],o=e[4],n=e[8],a=e[1],l=e[5],h=e[9],c=e[2],u=e[6],d=e[10];return"XYZ"===t?(i[1]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,d),i[2]=Math.atan2(-o,r)):(i[0]=Math.atan2(u,l),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(n,d),i[2]=Math.atan2(a,l)):(i[1]=Math.atan2(-c,r),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(s(u,-1,1)),Math.abs(u)<.99999?(i[1]=Math.atan2(-c,d),i[2]=Math.atan2(-o,l)):(i[1]=0,i[2]=Math.atan2(a,r))):"ZYX"===t?(i[1]=Math.asin(-s(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(u,d),i[2]=Math.atan2(a,r)):(i[0]=0,i[2]=Math.atan2(-o,l))):"YZX"===t?(i[2]=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-c,r)):(i[0]=0,i[1]=Math.atan2(n,d))):"XZY"===t&&(i[2]=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(u,l),i[1]=Math.atan2(n,r)):(i[0]=Math.atan2(-h,d),i[1]=0)),i},composeMat4:(e,t,i,s=p.mat4())=>(p.quaternionToRotationMat4(t,s),p.scaleMat4v(i,s),p.translateMat4v(e,s),s),decomposeMat4:(()=>{const e=new h(3),t=new h(16);return function(i,s,r,o){e[0]=i[0],e[1]=i[1],e[2]=i[2];let n=p.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];const a=p.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];const l=p.lenVec3(e);p.determinantMat4(i)<0&&(n=-n),s[0]=i[12],s[1]=i[13],s[2]=i[14],t.set(i);const h=1/n,c=1/a,u=1/l;return t[0]*=h,t[1]*=h,t[2]*=h,t[4]*=c,t[5]*=c,t[6]*=c,t[8]*=u,t[9]*=u,t[10]*=u,p.mat4ToQuaternion(t,r),o[0]=n,o[1]=a,o[2]=l,this}})(),getColMat4(e,t){const i=4*t;return[e[i],e[i+1],e[i+2],e[i+3]]},setRowMat4(e,t,i){e[t]=i[0],e[t+4]=i[1],e[t+8]=i[2],e[t+12]=i[3]},lookAtMat4v(e,t,i,s){s||(s=p.mat4());const r=e[0],o=e[1],n=e[2],a=i[0],l=i[1],h=i[2],c=t[0],u=t[1],d=t[2];if(r===c&&o===u&&n===d)return p.identityMat4();let f,m,g,_,v,b,x,y,P,w;return f=r-c,m=o-u,g=n-d,w=1/Math.sqrt(f*f+m*m+g*g),f*=w,m*=w,g*=w,_=l*g-h*m,v=h*f-a*g,b=a*m-l*f,w=Math.sqrt(_*_+v*v+b*b),w?(w=1/w,_*=w,v*=w,b*=w):(_=0,v=0,b=0),x=m*b-g*v,y=g*_-f*b,P=f*v-m*_,w=Math.sqrt(x*x+y*y+P*P),w?(w=1/w,x*=w,y*=w,P*=w):(x=0,y=0,P=0),s[0]=_,s[1]=x,s[2]=f,s[3]=0,s[4]=v,s[5]=y,s[6]=m,s[7]=0,s[8]=b,s[9]=P,s[10]=g,s[11]=0,s[12]=-(_*r+v*o+b*n),s[13]=-(x*r+y*o+P*n),s[14]=-(f*r+m*o+g*n),s[15]=1,s},lookAtMat4c:(e,t,i,s,r,o,n,a,l)=>p.lookAtMat4v([e,t,i],[s,r,o],[n,a,l],[]),orthoMat4c(e,t,i,s,r,o,n){n||(n=p.mat4());const a=t-e,l=s-i,h=o-r;return n[0]=2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/h,n[11]=0,n[12]=-(e+t)/a,n[13]=-(s+i)/l,n[14]=-(o+r)/h,n[15]=1,n},frustumMat4v(e,t,i){i||(i=p.mat4());const s=[e[0],e[1],e[2],0],r=[t[0],t[1],t[2],0];p.addVec4(r,s,c),p.subVec4(r,s,u);const o=2*s[2],n=u[0],a=u[1],l=u[2];return i[0]=o/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/a,i[6]=0,i[7]=0,i[8]=c[0]/n,i[9]=c[1]/a,i[10]=-c[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*r[2]/l,i[15]=0,i},frustumMat4(e,t,i,s,r,o,n){n||(n=p.mat4());const a=t-e,l=s-i,h=o-r;return n[0]=2*r/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/l,n[6]=0,n[7]=0,n[8]=(t+e)/a,n[9]=(s+i)/l,n[10]=-(o+r)/h,n[11]=-1,n[12]=0,n[13]=0,n[14]=-o*r*2/h,n[15]=0,n},perspectiveMat4(e,t,i,s,r){const o=[],n=[];return o[2]=i,n[2]=s,n[1]=o[2]*Math.tan(e/2),o[1]=-n[1],n[0]=n[1]*t,o[0]=-n[0],p.frustumMat4v(o,n,r)},compareMat4:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15],transformPoint3(e,t,i=p.vec3()){const s=t[0],r=t[1],o=t[2];return i[0]=e[0]*s+e[4]*r+e[8]*o+e[12],i[1]=e[1]*s+e[5]*r+e[9]*o+e[13],i[2]=e[2]*s+e[6]*r+e[10]*o+e[14],i},transformPoint4:(e,t,i=p.vec4())=>(i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i),transformPoints3(e,t,i){const s=i||[],r=t.length;let o,n,a,l;const h=e[0],c=e[1],u=e[2],d=e[3],p=e[4],f=e[5],m=e[6],g=e[7],_=e[8],v=e[9],b=e[10],x=e[11],y=e[12],P=e[13],w=e[14],M=e[15];let C;for(let e=0;e<r;++e)l=t[e],o=l[0],n=l[1],a=l[2],C=s[e]||(s[e]=[0,0,0]),C[0]=h*o+p*n+_*a+y,C[1]=c*o+f*n+v*a+P,C[2]=u*o+m*n+b*a+w,C[3]=d*o+g*n+x*a+M;return s.length=r,s},transformPositions3(e,t,i=t){let s;const r=t.length;let o,n,a;const l=e[0],h=e[1],c=e[2];e[3];const u=e[4],d=e[5],p=e[6];e[7];const f=e[8],m=e[9],g=e[10];e[11];const _=e[12],v=e[13],b=e[14];for(e[15],s=0;s<r;s+=3)o=t[s+0],n=t[s+1],a=t[s+2],i[s+0]=l*o+u*n+f*a+_,i[s+1]=h*o+d*n+m*a+v,i[s+2]=c*o+p*n+g*a+b;return i},transformPositions4(e,t,i=t){let s;const r=t.length;let o,n,a;const l=e[0],h=e[1],c=e[2],u=e[3],d=e[4],p=e[5],f=e[6],m=e[7],g=e[8],_=e[9],v=e[10],b=e[11],x=e[12],y=e[13],P=e[14],w=e[15];for(s=0;s<r;s+=4)o=t[s+0],n=t[s+1],a=t[s+2],i[s+0]=l*o+d*n+g*a+x,i[s+1]=h*o+p*n+_*a+y,i[s+2]=c*o+f*n+v*a+P,i[s+3]=u*o+m*n+b*a+w;return i},transformVec3(e,t,i){const s=t[0],r=t[1],o=t[2];return(i=i||this.vec3())[0]=e[0]*s+e[4]*r+e[8]*o,i[1]=e[1]*s+e[5]*r+e[9]*o,i[2]=e[2]*s+e[6]*r+e[10]*o,i},transformVec4(e,t,i){const s=t[0],r=t[1],o=t[2],n=t[3];return(i=i||p.vec4())[0]=e[0]*s+e[4]*r+e[8]*o+e[12]*n,i[1]=e[1]*s+e[5]*r+e[9]*o+e[13]*n,i[2]=e[2]*s+e[6]*r+e[10]*o+e[14]*n,i[3]=e[3]*s+e[7]*r+e[11]*o+e[15]*n,i},rotateVec2(e,t,i,s=e){const r=Math.cos(i),o=Math.sin(i),n=e[0]-t[0],a=e[1]-t[1];return s[0]=n*r-a*o+t[0],s[1]=n*o+a*r+t[1],e},rotateVec3X(e,t,i,s){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[0],o[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),o[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s},rotateVec3Y(e,t,i,s){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),o[1]=r[1],o[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s},rotateVec3Z(e,t,i,s){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),o[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),o[2]=r[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s},projectVec4(e,t){const i=1/e[3];return(t=t||p.vec2())[0]=e[0]*i,t[1]=e[1]*i,t},unprojectVec3:(()=>{const e=new h(16),t=new h(16),i=new h(16);return function(s,r,o,n){return this.transformVec3(this.mulMat4(this.inverseMat4(r,e),this.inverseMat4(o,t),i),s,n)}})(),lerpVec3(e,t,i,s,r,o){const n=o||p.vec3(),a=(e-t)/(i-t);return n[0]=s[0]+a*(r[0]-s[0]),n[1]=s[1]+a*(r[1]-s[1]),n[2]=s[2]+a*(r[2]-s[2]),n},lerpMat4(e,t,i,s,r,o){const n=o||p.mat4(),a=(e-t)/(i-t);return n[0]=s[0]+a*(r[0]-s[0]),n[1]=s[1]+a*(r[1]-s[1]),n[2]=s[2]+a*(r[2]-s[2]),n[3]=s[3]+a*(r[3]-s[3]),n[4]=s[4]+a*(r[4]-s[4]),n[5]=s[5]+a*(r[5]-s[5]),n[6]=s[6]+a*(r[6]-s[6]),n[7]=s[7]+a*(r[7]-s[7]),n[8]=s[8]+a*(r[8]-s[8]),n[9]=s[9]+a*(r[9]-s[9]),n[10]=s[10]+a*(r[10]-s[10]),n[11]=s[11]+a*(r[11]-s[11]),n[12]=s[12]+a*(r[12]-s[12]),n[13]=s[13]+a*(r[13]-s[13]),n[14]=s[14]+a*(r[14]-s[14]),n[15]=s[15]+a*(r[15]-s[15]),n},flatten(e){const t=[];let i,s,r,o,n;for(i=0,s=e.length;i<s;i++)for(n=e[i],r=0,o=n.length;r<o;r++)t.push(n[r]);return t},identityQuaternion:(e=p.vec4())=>(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e),eulerToQuaternion(e,t,i=p.vec4()){const s=e[0]*p.DEGTORAD/2,r=e[1]*p.DEGTORAD/2,o=e[2]*p.DEGTORAD/2,n=Math.cos(s),a=Math.cos(r),l=Math.cos(o),h=Math.sin(s),c=Math.sin(r),u=Math.sin(o);return"XYZ"===t?(i[0]=h*a*l+n*c*u,i[1]=n*c*l-h*a*u,i[2]=n*a*u+h*c*l,i[3]=n*a*l-h*c*u):"YXZ"===t?(i[0]=h*a*l+n*c*u,i[1]=n*c*l-h*a*u,i[2]=n*a*u-h*c*l,i[3]=n*a*l+h*c*u):"ZXY"===t?(i[0]=h*a*l-n*c*u,i[1]=n*c*l+h*a*u,i[2]=n*a*u+h*c*l,i[3]=n*a*l-h*c*u):"ZYX"===t?(i[0]=h*a*l-n*c*u,i[1]=n*c*l+h*a*u,i[2]=n*a*u-h*c*l,i[3]=n*a*l+h*c*u):"YZX"===t?(i[0]=h*a*l+n*c*u,i[1]=n*c*l+h*a*u,i[2]=n*a*u-h*c*l,i[3]=n*a*l-h*c*u):"XZY"===t&&(i[0]=h*a*l-n*c*u,i[1]=n*c*l-h*a*u,i[2]=n*a*u+h*c*l,i[3]=n*a*l+h*c*u),i},mat4ToQuaternion(e,t=p.vec4()){const i=e[0],s=e[4],r=e[8],o=e[1],n=e[5],a=e[9],l=e[2],h=e[6],c=e[10];let u;const d=i+n+c;return d>0?(u=.5/Math.sqrt(d+1),t[3]=.25/u,t[0]=(h-a)*u,t[1]=(r-l)*u,t[2]=(o-s)*u):i>n&&i>c?(u=2*Math.sqrt(1+i-n-c),t[3]=(h-a)/u,t[0]=.25*u,t[1]=(s+o)/u,t[2]=(r+l)/u):n>c?(u=2*Math.sqrt(1+n-i-c),t[3]=(r-l)/u,t[0]=(s+o)/u,t[1]=.25*u,t[2]=(a+h)/u):(u=2*Math.sqrt(1+c-i-n),t[3]=(o-s)/u,t[0]=(r+l)/u,t[1]=(a+h)/u,t[2]=.25*u),t},vec3PairToQuaternion(e,t,i=p.vec4()){const s=Math.sqrt(p.dotVec3(e,e)*p.dotVec3(t,t));let r=s+p.dotVec3(e,t);return r<1e-8*s?(r=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):p.cross3Vec3(e,t,i),i[3]=r,p.normalizeQuaternion(i)},angleAxisToQuaternion(e,t=p.vec4()){const i=e[3]/2,s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t},quaternionToEuler:(()=>{const e=new h(16);return(t,i,s)=>(s=s||p.vec3(),p.quaternionToRotationMat4(t,e),p.mat4ToEuler(e,i,s),s)})(),mulQuaternions(e,t,i=p.vec4()){const s=e[0],r=e[1],o=e[2],n=e[3],a=t[0],l=t[1],h=t[2],c=t[3];return i[0]=n*a+s*c+r*h-o*l,i[1]=n*l+r*c+o*a-s*h,i[2]=n*h+o*c+s*l-r*a,i[3]=n*c-s*a-r*l-o*h,i},vec3ApplyQuaternion(e,t,i=p.vec3()){const s=t[0],r=t[1],o=t[2],n=e[0],a=e[1],l=e[2],h=e[3],c=h*s+a*o-l*r,u=h*r+l*s-n*o,d=h*o+n*r-a*s,f=-n*s-a*r-l*o;return i[0]=c*h+f*-n+u*-l-d*-a,i[1]=u*h+f*-a+d*-n-c*-l,i[2]=d*h+f*-l+c*-a-u*-n,i},quaternionToMat4(e,t){t=p.identityMat4(t);const i=e[0],s=e[1],r=e[2],o=e[3],n=2*i,a=2*s,l=2*r,h=n*o,c=a*o,u=l*o,d=n*i,f=a*i,m=l*i,g=a*s,_=l*s,v=l*r;return t[0]=1-(g+v),t[1]=f+u,t[2]=m-c,t[4]=f-u,t[5]=1-(d+v),t[6]=_+h,t[8]=m+c,t[9]=_-h,t[10]=1-(d+g),t},quaternionToRotationMat4(e,t){const i=e[0],s=e[1],r=e[2],o=e[3],n=i+i,a=s+s,l=r+r,h=i*n,c=i*a,u=i*l,d=s*a,p=s*l,f=r*l,m=o*n,g=o*a,_=o*l;return t[0]=1-(d+f),t[4]=c-_,t[8]=u+g,t[1]=c+_,t[5]=1-(h+f),t[9]=p-m,t[2]=u-g,t[6]=p+m,t[10]=1-(h+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion(e,t=e){const i=p.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:(e,t=e)=>(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t),inverseQuaternion:(e,t)=>p.normalizeQuaternion(p.conjugateQuaternion(e,t)),quaternionToAngleAxis(e,t=p.vec4()){const i=(e=p.normalizeQuaternion(e,d))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t[3]=s,t},AABB3:e=>new h(e||6),AABB2:e=>new h(e||4),OBB3:e=>new h(e||32),OBB2:e=>new h(e||16),Sphere3:(e,t,i,s)=>new h([e,t,i,s]),transformOBB3(e,t,i=t){let s;const r=t.length;let o,n,a;const l=e[0],h=e[1],c=e[2],u=e[3],d=e[4],p=e[5],f=e[6],m=e[7],g=e[8],_=e[9],v=e[10],b=e[11],x=e[12],y=e[13],P=e[14],w=e[15];for(s=0;s<r;s+=4)o=t[s+0],n=t[s+1],a=t[s+2],i[s+0]=l*o+d*n+g*a+x,i[s+1]=h*o+p*n+_*a+y,i[s+2]=c*o+f*n+v*a+P,i[s+3]=u*o+m*n+b*a+w;return i},containsAABB3:function(e,t){return e[0]<=t[0]&&t[3]<=e[3]&&e[1]<=t[1]&&t[4]<=e[4]&&e[2]<=t[2]&&t[5]<=e[5]},getAABB3Diag:(()=>{const e=new h(3),t=new h(3),i=new h(3);return s=>(e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5],p.subVec3(t,e,i),Math.abs(p.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const e=new h(3),t=new h(3),i=new h(3);return(s,r)=>{e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5];const o=p.subVec3(t,e,i),n=r[0]-s[0],a=s[3]-r[0],l=r[1]-s[1],h=s[4]-r[1],c=r[2]-s[2],u=s[5]-r[2];return o[0]+=n>a?n:a,o[1]+=l>h?l:h,o[2]+=c>u?c:u,Math.abs(p.lenVec3(o))}})(),getAABB3Area:e=>(e[3]-e[0])*(e[4]-e[1])*(e[5]-e[2]),getAABB3Center(e,t){const i=t||p.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},getAABB2Center(e,t){const i=t||p.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},collapseAABB3:(e=p.AABB3())=>(e[0]=p.MAX_DOUBLE,e[1]=p.MAX_DOUBLE,e[2]=p.MAX_DOUBLE,e[3]=p.MIN_DOUBLE,e[4]=p.MIN_DOUBLE,e[5]=p.MIN_DOUBLE,e),AABB3ToOBB3:(e,t=p.OBB3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t),positions3ToAABB3:(()=>{const e=new h(3);return(t,i,s)=>{i=i||p.AABB3();let r,o,n,a=p.MAX_DOUBLE,l=p.MAX_DOUBLE,h=p.MAX_DOUBLE,c=p.MIN_DOUBLE,u=p.MIN_DOUBLE,d=p.MIN_DOUBLE;for(let i=0,f=t.length;i<f;i+=3)s?(e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2],p.decompressPosition(e,s,e),r=e[0],o=e[1],n=e[2]):(r=t[i+0],o=t[i+1],n=t[i+2]),r<a&&(a=r),o<l&&(l=o),n<h&&(h=n),r>c&&(c=r),o>u&&(u=o),n>d&&(d=n);return i[0]=a,i[1]=l,i[2]=h,i[3]=c,i[4]=u,i[5]=d,i}})(),OBB3ToAABB3(e,t=p.AABB3()){let i,s,r,o=p.MAX_DOUBLE,n=p.MAX_DOUBLE,a=p.MAX_DOUBLE,l=p.MIN_DOUBLE,h=p.MIN_DOUBLE,c=p.MIN_DOUBLE;for(let t=0,u=e.length;t<u;t+=4)i=e[t+0],s=e[t+1],r=e[t+2],i<o&&(o=i),s<n&&(n=s),r<a&&(a=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return t[0]=o,t[1]=n,t[2]=a,t[3]=l,t[4]=h,t[5]=c,t},points3ToAABB3(e,t=p.AABB3()){let i,s,r,o=p.MAX_DOUBLE,n=p.MAX_DOUBLE,a=p.MAX_DOUBLE,l=p.MIN_DOUBLE,h=p.MIN_DOUBLE,c=p.MIN_DOUBLE;for(let t=0,u=e.length;t<u;t++)i=e[t][0],s=e[t][1],r=e[t][2],i<o&&(o=i),s<n&&(n=s),r<a&&(a=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return t[0]=o,t[1]=n,t[2]=a,t[3]=l,t[4]=h,t[5]=c,t},points3ToSphere3:(()=>{const e=new h(3);return(t,i)=>{i=i||p.vec4();let s,r=0,o=0,n=0;const a=t.length;for(s=0;s<a;s++)r+=t[s][0],o+=t[s][1],n+=t[s][2];i[0]=r/a,i[1]=o/a,i[2]=n/a;let l,h=0;for(s=0;s<a;s++)l=Math.abs(p.lenVec3(p.subVec3(t[s],i,e))),l>h&&(h=l);return i[3]=h,i}})(),positions3ToSphere3:(()=>{const e=new h(3),t=new h(3);return(i,s)=>{s=s||p.vec4();let r,o=0,n=0,a=0;const l=i.length;let h=0;for(r=0;r<l;r+=3)o+=i[r],n+=i[r+1],a+=i[r+2];const c=l/3;let u;for(s[0]=o/c,s[1]=n/c,s[2]=a/c,r=0;r<l;r+=3)e[0]=i[r],e[1]=i[r+1],e[2]=i[r+2],u=Math.abs(p.lenVec3(p.subVec3(e,s,t))),u>h&&(h=u);return s[3]=h,s}})(),OBB3ToSphere3:(()=>{const e=new h(3),t=new h(3);return(i,s)=>{s=s||p.vec4();let r,o=0,n=0,a=0;const l=i.length,h=l/4;for(r=0;r<l;r+=4)o+=i[r+0],n+=i[r+1],a+=i[r+2];s[0]=o/h,s[1]=n/h,s[2]=a/h;let c,u=0;for(r=0;r<l;r+=4)e[0]=i[r+0],e[1]=i[r+1],e[2]=i[r+2],c=Math.abs(p.lenVec3(p.subVec3(e,s,t))),c>u&&(u=c);return s[3]=u,s}})(),getSphere3Center:(e,t=p.vec3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),getPositionsCenter(e,t=p.vec3()){let i=0,s=0,r=0;for(var o=0,n=e.length;o<n;o+=3)i+=e[o+0],s+=e[o+1],r+=e[o+2];const a=e.length/3;return t[0]=i/a,t[1]=s/a,t[2]=r/a,t},expandAABB3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e),expandAABB3Point3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e),expandAABB3Points3(e,t){for(var i,s,r,o=0,n=t.length;o<n;o+=3)i=t[o],s=t[o+1],r=t[o+2],e[0]>i&&(e[0]=i),e[1]>s&&(e[1]=s),e[2]>r&&(e[2]=r),e[3]<i&&(e[3]=i),e[4]<s&&(e[4]=s),e[5]<r&&(e[5]=r);return e},collapseAABB2:(e=p.AABB2())=>(e[0]=p.MAX_DOUBLE,e[1]=p.MAX_DOUBLE,e[2]=p.MIN_DOUBLE,e[3]=p.MIN_DOUBLE,e),point3AABB3Intersect:(e,t)=>e[0]>t[0]||e[3]<t[0]||e[1]>t[1]||e[4]<t[1]||e[2]>t[2]||e[5]<t[2],planeAABB3Intersect(e,t,i){let s,r;e[0]>0?(s=e[0]*i[0],r=e[0]*i[3]):(s=e[0]*i[3],r=e[0]*i[0]),e[1]>0?(s+=e[1]*i[1],r+=e[1]*i[4]):(s+=e[1]*i[4],r+=e[1]*i[1]),e[2]>0?(s+=e[2]*i[2],r+=e[2]*i[5]):(s+=e[2]*i[5],r+=e[2]*i[2]);if(s<=-t&&r<=-t)return-1;return s>=-t&&r>=-t?1:0},OBB3ToAABB2(e,t=p.AABB2()){let i,s,r,o,n=p.MAX_DOUBLE,a=p.MAX_DOUBLE,l=p.MIN_DOUBLE,h=p.MIN_DOUBLE;for(let t=0,c=e.length;t<c;t+=4)i=e[t+0],s=e[t+1],r=e[t+3]||1,o=1/r,i*=o,s*=o,i<n&&(n=i),s<a&&(a=s),i>l&&(l=i),s>h&&(h=s);return t[0]=n,t[1]=a,t[2]=l,t[3]=h,t},expandAABB2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e),expandAABB2Point2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e),AABB2ToCanvas(e,t,i,s=e){const r=.5*(e[0]+1),o=.5*(e[1]+1),n=.5*(e[2]+1),a=.5*(e[3]+1);return s[0]=Math.floor(r*t),s[1]=i-Math.floor(a*i),s[2]=Math.floor(n*t),s[3]=i-Math.floor(o*i),s},tangentQuadraticBezier:(e,t,i,s)=>2*(1-e)*(i-t)+2*e*(s-i),tangentQuadraticBezier3:(e,t,i,s,r)=>-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*s*(1-e)-3*e*e*s+3*e*e*r,tangentSpline:e=>6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e),catmullRomInterpolate(e,t,i,s,r){const o=.5*(i-e),n=.5*(s-t),a=r*r;return(2*t-2*i+o+n)*(r*a)+(-3*t+3*i-2*o-n)*a+o*r+t},b2p0(e,t){const i=1-e;return i*i*t},b2p1:(e,t)=>2*(1-e)*e*t,b2p2:(e,t)=>e*e*t,b2(e,t,i,s){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,s)},b3p0(e,t){const i=1-e;return i*i*i*t},b3p1(e,t){const i=1-e;return 3*i*i*e*t},b3p2:(e,t)=>3*(1-e)*e*e*t,b3p3:(e,t)=>e*e*e*t,b3(e,t,i,s,r){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,s)+this.b3p3(e,r)},triangleNormal(e,t,i,s=p.vec3()){const r=t[0]-e[0],o=t[1]-e[1],n=t[2]-e[2],a=i[0]-e[0],l=i[1]-e[1],h=i[2]-e[2],c=o*h-n*l,u=n*a-r*h,d=r*l-o*a,f=Math.sqrt(c*c+u*u+d*d);return 0===f?(s[0]=0,s[1]=0,s[2]=0):(s[0]=c/f,s[1]=u/f,s[2]=d/f),s},rayTriangleIntersect:(()=>{const e=new h(3),t=new h(3),i=new h(3),s=new h(3),r=new h(3);return(o,n,a,l,h,c)=>{c=c||p.vec3();const u=p.subVec3(l,a,e),d=p.subVec3(h,a,t),f=p.cross3Vec3(n,d,i),m=p.dotVec3(u,f);if(m<1e-6)return null;const g=p.subVec3(o,a,s),_=p.dotVec3(g,f);if(_<0||_>m)return null;const v=p.cross3Vec3(g,u,r),b=p.dotVec3(n,v);if(b<0||_+b>m)return null;const x=p.dotVec3(d,v)/m;return c[0]=o[0]+x*n[0],c[1]=o[1]+x*n[1],c[2]=o[2]+x*n[2],c}})(),rayPlaneIntersect:(()=>{const e=new h(3),t=new h(3),i=new h(3),s=new h(3);return(r,o,n,a,l,h)=>{h=h||p.vec3(),o=p.normalizeVec3(o,e);const c=p.subVec3(a,n,t),u=p.subVec3(l,n,i),d=p.cross3Vec3(c,u,s);p.normalizeVec3(d,d);const f=-p.dotVec3(n,d),m=-(p.dotVec3(r,d)+f)/p.dotVec3(o,d);return h[0]=r[0]+m*o[0],h[1]=r[1]+m*o[1],h[2]=r[2]+m*o[2],h}})(),cartesianToBarycentric:(()=>{const e=new h(3),t=new h(3),i=new h(3);return(s,r,o,n,a)=>{const l=p.subVec3(n,r,e),h=p.subVec3(o,r,t),c=p.subVec3(s,r,i),u=p.dotVec3(l,l),d=p.dotVec3(l,h),f=p.dotVec3(l,c),m=p.dotVec3(h,h),g=p.dotVec3(h,c),_=u*m-d*d;if(0===_)return null;const v=1/_,b=(m*f-d*g)*v,x=(u*g-d*f)*v;return a[0]=1-b-x,a[1]=x,a[2]=b,a}})(),barycentricInsideTriangle(e){const t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},barycentricToCartesian(e,t,i,s,r=p.vec3()){const o=e[0],n=e[1],a=e[2];return r[0]=t[0]*o+i[0]*n+s[0]*a,r[1]=t[1]*o+i[1]*n+s[1]*a,r[2]=t[2]*o+i[2]*n+s[2]*a,r},mergeVertices(e,t,i,s){const r={},o=[],n=[],a=t?[]:null,l=i?[]:null,h=[];let c,u,d,p;const f=1e4;let m,g,_=0;for(m=0,g=e.length;m<g;m+=3)c=e[m],u=e[m+1],d=e[m+2],p=`${Math.round(c*f)}_${Math.round(u*f)}_${Math.round(d*f)}`,void 0===r[p]&&(r[p]=n.length/3,n.push(c),n.push(u),n.push(d),t&&(a.push(t[m]),a.push(t[m+1]),a.push(t[m+2])),i&&(l.push(i[_]),l.push(i[_+1]))),o[m/3]=r[p],_+=2;for(m=0,g=s.length;m<g;m++)h[m]=o[s[m]];const v={positions:n,indices:h};return a&&(v.normals=a),l&&(v.uv=l),v},buildNormals:(()=>{const e=new h(3),t=new h(3),i=new h(3),s=new h(3),r=new h(3),o=new h(3);return(n,a,l)=>{let h,c;const u=new Array(n.length/3);let d,f,m,g,_,v,b;for(h=0,c=a.length;h<c;h+=3){d=a[h],f=a[h+1],m=a[h+2],e[0]=n[3*d],e[1]=n[3*d+1],e[2]=n[3*d+2],t[0]=n[3*f],t[1]=n[3*f+1],t[2]=n[3*f+2],i[0]=n[3*m],i[1]=n[3*m+1],i[2]=n[3*m+2],p.subVec3(t,e,s),p.subVec3(i,e,r);const l=p.vec3();p.normalizeVec3(p.cross3Vec3(s,r,o),l),u[d]||(u[d]=[]),u[f]||(u[f]=[]),u[m]||(u[m]=[]),u[d].push(l),u[f].push(l),u[m].push(l)}for(l=l&&l.length===n.length?l:new Float32Array(n.length),h=0,c=u.length;h<c;h++){g=u[h].length,_=0,v=0,b=0;for(let e=0;e<g;e++)_+=u[h][e][0],v+=u[h][e][1],b+=u[h][e][2];l[3*h]=_/g,l[3*h+1]=v/g,l[3*h+2]=b/g}return l}})(),buildTangents:(()=>{const e=new h(3),t=new h(3),i=new h(3),s=new h(3),r=new h(3),o=new h(3),n=new h(3);return(a,l,h)=>{const c=new Float32Array(a.length);for(let u=0;u<l.length;u+=3){let d=l[u];const f=a.subarray(3*d,3*d+3),m=h.subarray(2*d,2*d+2);d=l[u+1];const g=a.subarray(3*d,3*d+3),_=h.subarray(2*d,2*d+2);d=l[u+2];const v=a.subarray(3*d,3*d+3),b=h.subarray(2*d,2*d+2),x=p.subVec3(g,f,e),y=p.subVec3(v,f,t),P=p.subVec2(_,m,i),w=p.subVec2(b,m,s),M=1/(P[0]*w[1]-P[1]*w[0]),C=p.mulVec3Scalar(p.subVec3(p.mulVec3Scalar(x,w[1],r),p.mulVec3Scalar(y,P[1],o),n),M,o);let E;for(let e=0;e<3;e++)E=3*l[u+e],c[E]+=C[0],c[E+1]+=C[1],c[E+2]+=C[2]}return c}})(),buildPickTriangles(e,t,i){const s=t.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),o=new Uint8Array(12*s);let n,a,l,h,c,u,d=0,p=0,f=0;for(let i=0;i<s;i+=3)u=d>>24&255,c=d>>16&255,h=d>>8&255,l=255&d,a=t[i],n=3*a,r[p++]=e[n],r[p++]=e[n+1],r[p++]=e[n+2],o[f++]=l,o[f++]=h,o[f++]=c,o[f++]=u,a=t[i+1],n=3*a,r[p++]=e[n],r[p++]=e[n+1],r[p++]=e[n+2],o[f++]=l,o[f++]=h,o[f++]=c,o[f++]=u,a=t[i+2],n=3*a,r[p++]=e[n],r[p++]=e[n+1],r[p++]=e[n+2],o[f++]=l,o[f++]=h,o[f++]=c,o[f++]=u,d++;return{positions:r,colors:o}},faceToVertexNormals(e,t,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},o=[],n={};let a,l,h,c,u;const d=1e4;let f,m,g,_,v,b;for(m=0,_=e.length;m<_;m+=3){f=m/3,l=e[m],h=e[m+1],c=e[m+2],u=`${Math.round(l*d)}_${Math.round(h*d)}_${Math.round(c*d)}`,void 0===r[u]?r[u]=[f]:r[u].push(f);const i=p.normalizeVec3([t[m],t[m+1],t[m+2]]);o[f]=i,a=p.vec4([i[0],i[1],i[2],1]),n[f]=a}for(u in r)if(r.hasOwnProperty(u)){const e=r[u],t=e.length;for(m=0;m<t;m++){const i=e[m];for(a=n[i],g=0;g<t;g++){if(m===g)continue;const t=e[g];v=o[i],b=o[t];Math.abs(p.angleVec3(v,b)/p.DEGTORAD)<s&&(a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a[3]+=1)}}}for(m=0,_=t.length;m<_;m+=3)a=n[m/3],t[m+0]=a[0]/a[3],t[m+1]=a[1]/a[3],t[m+2]=a[2]/a[3]},transformRay:(()=>{const e=new h(4),t=new h(4);return(i,s,r,o,n)=>{e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,p.transformVec4(i,e,t),o[0]=t[0],o[1]=t[1],o[2]=t[2],e[0]=r[0],e[1]=r[1],e[2]=r[2],p.transformVec3(i,e,t),p.normalizeVec3(t),n[0]=t[0],n[1]=t[1],n[2]=t[2]}})(),canvasPosToWorldRay:(()=>{const e=new h(16),t=new h(16),i=new h(4),s=new h(4),r=new h(4),o=new h(4);return(n,a,l,h,c,u)=>{const d=p.mulMat4(l,a,e),f=p.inverseMat4(d,t),m=n.width,g=n.height,_=(h[0]-m/2)/(m/2),v=-(h[1]-g/2)/(g/2);i[0]=_,i[1]=v,i[2]=-1,i[3]=1,p.transformVec4(f,i,s),p.mulVec4Scalar(s,1/s[3]),r[0]=_,r[1]=v,r[2]=1,r[3]=1,p.transformVec4(f,r,o),p.mulVec4Scalar(o,1/o[3]),c[0]=o[0],c[1]=o[1],c[2]=o[2],p.subVec3(o,s,u),p.normalizeVec3(u)}})(),canvasPosToLocalRay:(()=>{const e=new h(3),t=new h(3);return(i,s,r,o,n,a,l)=>{p.canvasPosToWorldRay(i,s,r,n,e,t),p.worldRayToLocalRay(o,e,t,a,l)}})(),worldRayToLocalRay:(()=>{const e=new h(16),t=new h(4),i=new h(4);return(s,r,o,n,a)=>{const l=p.inverseMat4(s,e);t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,p.transformVec4(l,t,i),n[0]=i[0],n[1]=i[1],n[2]=i[2],p.transformVec3(l,o,a)}})(),buildKDTree:(()=>{const e=new Float32Array;function t(i,s,r,o){const n=new h(6),a={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:n};let l,c;for(n[0]=n[1]=n[2]=Number.POSITIVE_INFINITY,n[3]=n[4]=n[5]=Number.NEGATIVE_INFINITY,l=0,c=i.length;l<c;++l){var u=3*i[l];for(let e=0;e<3;++e){const t=3*s[u+e];r[t]<n[0]&&(n[0]=r[t]),r[t]>n[3]&&(n[3]=r[t]),r[t+1]<n[1]&&(n[1]=r[t+1]),r[t+1]>n[4]&&(n[4]=r[t+1]),r[t+2]<n[2]&&(n[2]=r[t+2]),r[t+2]>n[5]&&(n[5]=r[t+2])}}if(i.length<20||o>10)return a.triangles=i,a.leaf=!0,a;e[0]=n[3]-n[0],e[1]=n[4]-n[1],e[2]=n[5]-n[2];let d=0;e[1]>e[d]&&(d=1),e[2]>e[d]&&(d=2),a.splitDim=d;const p=(n[d]+n[d+3])/2,f=new Array(i.length);let m=0;const g=new Array(i.length);let _=0;for(l=0,c=i.length;l<c;++l){const e=s[u=3*i[l]],t=3*s[u+1],o=3*s[u+2];r[3*e+d]<=p||r[t+d]<=p||r[o+d]<=p?f[m++]=i[l]:g[_++]=i[l]}return f.length=m,g.length=_,a.left=t(f,s,r,o+1),a.right=t(g,s,r,o+1),a}return(e,i)=>{const s=e.length/3,r=new Array(s);for(let e=0;e<s;++e)r[e]=e;return t(r,e,i,0)}})(),decompressPosition(e,t,i){(i=i||e)[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressUV(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},octDecodeVec2(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return t[0]=i/o,t[1]=s/o,t[2]=r/o,t},octDecodeVec2s(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],o=e[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);t[s+0]=r/a,t[s+1]=o/a,t[s+2]=n/a,s+=3}return t}};p.buildEdgeIndices=function(){const e=[],t=[],i=[],s=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),h=p.vec3(),c=p.vec3(),u=p.vec3(),d=p.vec3(),f=p.vec3(),m=p.vec3(),g=p.vec3();return function(_,v,b,x){!function(r,o){const n={};let a,l,h,c;const u=Math.pow(10,4);let d,p,f=0;for(d=0,p=r.length;d<p;d+=3)a=r[d],l=r[d+1],h=r[d+2],c=Math.round(a*u)+"_"+Math.round(l*u)+"_"+Math.round(h*u),void 0===n[c]&&(n[c]=f/3,e[f++]=a,e[f++]=l,e[f++]=h),t[d/3]=n[c];for(d=0,p=o.length;d<p;d++)s[d]=t[o[d]],i[s[d]]=o[d]}(_,v),function(t,i){o=0;for(let _=0,v=t;_<v;_+=3){const t=3*s[_],v=3*s[_+1],b=3*s[_+2];i?(n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],a[0]=e[v],a[1]=e[v+1],a[2]=e[v+2],l[0]=e[b],l[1]=e[b+1],l[2]=e[b+2],p.decompressPosition(n,i,h),p.decompressPosition(a,i,c),p.decompressPosition(l,i,u)):(h[0]=e[t],h[1]=e[t+1],h[2]=e[t+2],c[0]=e[v],c[1]=e[v+1],c[2]=e[v+2],u[0]=e[b],u[1]=e[b+1],u[2]=e[b+2]),p.subVec3(u,c,d),p.subVec3(h,c,f),p.cross3Vec3(d,f,m),p.normalizeVec3(m,g);const x=r[o]||(r[o]={normal:p.vec3()});x.normal[0]=g[0],x.normal[1]=g[1],x.normal[2]=g[2],o++}}(v.length,b);const y=[],P=Math.cos(p.DEGTORAD*x),w={};let M,C,E,A,D,T,S,I,F,L,B,R=!1;for(let e=0,t=v.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)M=s[e+i],C=s[e+(i+1)%3],E=Math.min(M,C),A=Math.max(M,C),D=E+","+A,void 0===w[D]?w[D]={index1:E,index2:A,face1:t,face2:void 0}:w[D].face2=t}for(D in w)T=w[D],void 0!==T.face2&&(S=r[T.face1].normal,I=r[T.face2].normal,F=p.dotVec3(S,I),F>P)||(L=i[T.index1],B=i[T.index2],(!R&&L>65535||B>65535)&&(R=!0),y.push(L),y.push(B));return R?new Uint32Array(y):new Uint16Array(y)}}();const f={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var m=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(e){for(var t=[],i=e[0].charCodeAt(0),s=i+e[1],r=i;r<s;++r)t.push(r);return String.fromCharCode.apply(null,t)})).join("");function g(e,t){return(t&&4!==t?[0,6]:[0,6,12,18]).map((function(t){return m.substr(parseInt(e/(1<<t))%64,1)})).reverse().join("")}const _=function(){for(var e={},t=window.location.search.substring(1).split("&"),i=0;i<t.length;i++){var s=t[i].split("=");if(void 0===e[s[0]])e[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof e[s[0]]){var r=[e[s[0]],decodeURIComponent(s[1])];e[s[0]]=r}else e[s[0]].push(decodeURIComponent(s[1]))}return e}();const v={xmlToJson:function e(t,i){if(t.nodeType===t.TEXT_NODE){var s=t.nodeValue;if(null===s.match(/^\s+$/))return s}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var r={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var o=0;o<t.attributes.length;o++){var n=t.attributes[o];r[i[n.nodeName]||n.nodeName]=n.nodeValue}for(var a=0;a<t.childNodes.length;a++){(o=e(t.childNodes[a],i))&&r.children.push(o)}return r}},clone:function(e){return JSON.parse(JSON.stringify(e))},compressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(t){return parseInt(e.substr(t,2),16)}));return g(t[0],2)+[1,4,7,10,13].map((function(e){return g((t[e]<<16)+(t[e+1]<<8)+t[e+2])})).join("")},findNodeOfType:function(e,t){var i=[],s=function(e){e.type===t&&i.push(e),(e.children||[]).forEach((function(e){s(e)}))};return s(e),i},timeout:function(e){return new Promise((function(t,i){setTimeout(t,e)}))},httpRequest:function(e){return new Promise((function(t,i){var s=new XMLHttpRequest;s.open(e.method||"GET",e.url,!0),s.onload=function(r){console.log(e.url,s.readyState,s.status),4===s.readyState&&(200===s.status?t(s.responseXML):i(s.statusText))},s.send(null)}))},loadJSON:function(e,t,i){var s=e=>{};t=t||s,i=i||s;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",e,!0),r.addEventListener("load",(function(e){var s=e.target.response;if(200===this.status){var r;try{r=JSON.parse(s)}catch(e){i(`utils.loadJSON(): Failed to parse JSON response - ${e}`)}t(r)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{t(JSON.parse(s))}catch(e){i(`utils.loadJSON(): Failed to parse JSON response - ${e}`)}}else i(e)}),!1),r.addEventListener("error",(function(e){i(e)}),!1),r.send(null)},loadArraybuffer:function(e,t,i){var s=e=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),i=new Uint8Array(e);for(var n=0;n<o.length;n++)i[n]=o.charCodeAt(n);window.setTimeout((function(){t(e)}),0)}catch(e){window.setTimeout((function(){i(e)}),0)}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("loadArrayBuffer error : "+s.response))},s.send(null)}},queryString:_,isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},isString:function(e){return"string"==typeof e||e instanceof String},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return v.isString(e)||v.isNumeric(e)},isSameComponent:function(e,t){return!(!e||!t)&&(v.isNumeric(e)||v.isString(e)?`${e}`:e.id)===(v.isNumeric(t)||v.isString(t)?`${t}`:t.id)},isFunction:function(e){return"function"==typeof e},isObject:function(e){const t={}.constructor;return!!e&&e.constructor===t},copy:function(e){return v.apply(e,{})},apply:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},apply2:function(e,t){for(const i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},applyIf:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},isEmptyObject:function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0},inQuotes:function(e){return v.isNumeric(e)?`${e}`:`'${e}'`},concat:function(e,t){const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},flattenParentChildHierarchy:function(e){var t=[];return function e(i){i.id=i.uuid,delete i.oid,t.push(i);var s=i.children;if(s)for(var r=0,o=s.length;r<o;r++){s[r].parent=i.id,e(s[r])}i.children=[]}(e),t}},b={},x=new t,y=new class{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}},P={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},w=[];let M,C=0,E=0;const A=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(e){if(e.id){if(A.scenes[e.id])return void console.error(`[ERROR] Scene ${v.inQuotes(e.id)} already exists`)}else e.id=x.addItem({});A.scenes[e.id]=e;const t=e.ticksPerOcclusionTest,i=e.ticksPerRender;b[e.id]={ticksPerOcclusionTest:t,ticksPerRender:i,renderCountdown:i},f.components.scenes++,e.once("destroyed",(()=>{x.removeItem(e.id),delete A.scenes[e.id],delete b[e.id],f.components.scenes--}))},this.clear=function(){let e;for(const t in A.scenes)A.scenes.hasOwnProperty(t)&&(e=A.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete A.scenes[e.id]))},this.scheduleTask=function(e,t){y.push(e),y.push(t)},this.runTasks=function(e=-1){let t,i,s=(new Date).getTime(),r=0;for(;y.length>0&&(e<0||s<e);)t=y.shift(),i=y.shift(),i?t.call(i):t(),s=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return y.length}},D=function(){let e=Date.now();if(C>0){M=e-C;var t=1e3/M;E+=t,w.push(t),w.length>=30&&(E-=w.shift()),f.frame.fps=Math.round(E/w.length)}!function(e){const t=A.runTasks(e+10),i=A.getNumTasks();f.frame.tasksRun=t,f.frame.tasksScheduled=i,f.frame.tasksBudget=10}(e),function(e){for(var t in P.time=e,A.scenes)if(A.scenes.hasOwnProperty(t)){var i=A.scenes[t];P.sceneId=t,P.startTime=i.startTime,P.deltaTime=null!=P.prevTime?P.time-P.prevTime:0,i.fire("tick",P,!0)}P.prevTime=e}(e),function(){const e=A.scenes,t=!1;let i,s,r,o,n;for(n in e)e.hasOwnProperty(n)&&(i=e[n],s=b[n],s||(s=b[n]={}),r=i.ticksPerOcclusionTest,s.ticksPerOcclusionTest!==r&&(s.ticksPerOcclusionTest=r,s.renderCountdown=r),--i.occlusionTestCountdown<=0&&(i.doOcclusionTest(),i.occlusionTestCountdown=r),o=i.ticksPerRender,s.ticksPerRender!==o&&(s.ticksPerRender=o,s.renderCountdown=o),0==--s.renderCountdown&&(i.render(t),s.renderCountdown=o))}(),C=e,void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(D):requestAnimationFrame(D)};void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(D):requestAnimationFrame(D);class T{get type(){return"Component"}get isComponent(){return!0}constructor(e=null,t={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=t.viewer;else{if("Scene"===e.type)this.scene=e;else{if(!(e instanceof T))throw"Invalid param: owner must be a Component";this.scene=e.scene}this._owner=e,this._renderer=this.scene._renderer}this._dontClear=!!t.dontClear,this._renderer=this.scene._renderer,this.meta=t.meta||{},this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(e){return this.type===e}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new t),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();r[o]={callback:i,scope:s||this},this._subIdEvents[o]=e;const n=this._events[e];return void 0!==n&&i.call(s||this,n),o}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,(function(e){s.off(r),t.call(i||this,e)}),i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+v.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const t=e.name;if(!t)return void this.error("Component 'name' expected");let i=e.component;const s=e.sceneDefault,r=e.sceneSingleton,o=e.type,n=e.on,a=!1!==e.recompiles;if(i&&(v.isNumeric(i)||v.isString(i))){const e=i;if(i=this.scene.components[e],!i)return void this.error("Component not found: "+v.inQuotes(e))}if(!i)if(!0===r){const e=this.scene.types[o];for(const t in e)if(e.hasOwnProperty){i=e[t];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===s&&(i=this.scene[t],!i))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+v.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+v.inQuotes(i.id))}this._attachments||(this._attachments={});const l=this._attached[t];let h,c,u;if(l){if(i&&l.id===i.id)return;const e=this._attachments[l.id];for(h=e.subs,c=0,u=h.length;c<u;c++)l.off(h[c]);delete this._attached[t],delete this._attachments[l.id];const s=e.params.onDetached;s&&(v.isFunction(s)?s(l):s.scope?s.callback.call(s.scope,l):s.callback(l)),e.managingLifecycle&&l.destroy()}if(i){const s={params:e,component:i,subs:[],managingLifecycle:false};s.subs.push(i.once("destroyed",(function(){s.params.component=null,this._attach(s.params)}),this)),a&&s.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[t]=i,this._attachments[i.id]=s;const r=e.onAttached;if(r&&(v.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),n){let e,t,r,o;for(e in n)if(n.hasOwnProperty(e)){if(t=n[e],v.isFunction(t)?(r=t,o=null):(r=t.callback,o=t.scope),!r)continue;s.subs.push(i.on(e,r,o))}}}return a&&this.fire("dirty",this),this.fire(t,i),i}_checkComponent(e,t){if(!t.isComponent){if(!v.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(e===t.type){if(t.scene.id===this.scene.id)return t;this.error("Not in same scene: "+t.type)}else this.error("Expected a "+e+" Component")}_checkComponent2(e,t){if(!t.isComponent){if(!v.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(t.scene.id===this.scene.id){for(var i=0,s=e.length;i<s;i++)if(e[i]===t.type)return t;return this.error("Expected component types: "+e),null}this.error("Not in same scene: "+t.type)}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",(()=>{delete this._ownedComponents[e.id]}),this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():A.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(e)){this._ownedComponents[e].destroy(),delete this._ownedComponents[e]}}destroy(){if(this.destroyed)return;let e,t,i,s,r,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(t=this._attachments[e],i=t.component,s=t.subs,r=0,o=s.length;r<o;r++)i.off(s[r]);t.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(i=this._ownedComponents[e],i.destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const S=1,I=4,F=8,L=16,B=32,R=256,k=512,O=1024,N=2048,j=new Float32Array([0,0,0]),V=new Uint16Array([0,0,0]);class z{constructor(e,t,i,s,r,o){this._isObject=t,this.scene=e.scene,this.model=e,this.meshes=s,this._numTriangles=0;for(var n=0,a=this.meshes.length;n<a;n++){const e=this.meshes[n];e.parent=this,this._numTriangles+=e.numTriangles}this.id=i,this.originalSystemId=p.unglobalizeObjectId(e.id,i),this._flags=r,this._aabb=o,this._offsetAABB=p.AABB3(o),this._offset=p.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&e.scene._registerObject(this)}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get aabb(){return this._offsetAABB}get numTriangles(){return this._numTriangles}get visible(){return this._getFlag(S)}set visible(e){if(!!(this._flags&S)!==e){this._flags=e?this._flags|S:this._flags&~S;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(k)}set highlighted(e){if(!!(this._flags&k)!==e){this._flags=e?this._flags|k:this._flags&~k;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(R)}set xrayed(e){if(!!(this._flags&R)!==e){this._flags=e?this._flags|R:this._flags&~R;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(O)}set selected(e){if(!!(this._flags&O)!==e){this._flags=e?this._flags|O:this._flags&~O;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(N)}set edges(e){if(!!(this._flags&N)!==e){this._flags=e?this._flags|N:this._flags&~N;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}get culledVFC(){return!!this._culledVFC}set culledVFC(e){this._culledVFC=e,this.internalSetCulled()}get culledLOD(){return!!this._culledLOD}set culledLOD(e){this._culledLOD=e,this.internalSetCulled()}get culled(){return!!this._culled}set culled(e){this._culled=e,this.internalSetCulled()}internalSetCulled(){let e=!!this._culled||!!this._culledLOD||!!this._culledVFC;if(!!(this._flags&I)!==e){this._flags=e?this._flags|I:this._flags&~I;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(L)}set clippable(e){if(!!(this._flags&L)!==e){this._flags=e?this._flags|L:this._flags&~L;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(B)}set collidable(e){if(!!(this._flags&B)!==e){this._flags=e?this._flags|B:this._flags&~B;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}get pickable(){return this._getFlag(F)}set pickable(e){if(!!(this._flags&F)!==e){this._flags=e?this._flags|F:this._flags&~F;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}get colorize(){if(0===this.meshes.length)return null;const e=this.meshes[0]._colorize;return j[0]=e[0]/255,j[1]=e[1]/255,j[2]=e[2]/255,j}set colorize(e){if(e){V[0]=Math.floor(255*e[0]),V[1]=Math.floor(255*e[1]),V[2]=Math.floor(255*e[2]);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(V)}else for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(null);if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t),this._colorizeUpdated=t}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(0===this.meshes.length)return;const t=null!=e,i=this.meshes[0]._colorize[3];let s=255;if(t){if(e<0?e=0:e>1&&(e=1),s=Math.floor(255*e),i===s)return}else if(s=255,i===s)return;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOpacity(s,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw()}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model._aabbDirty=!0,this.model.glRedraw()}get castsShadow(){return!1}set castsShadow(e){}get receivesShadow(){return!1}set receivesShadow(e){}get saoEnabled(){return this.model.saoEnabled}_getFlag(e){return!!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize(this._flags)}_finalize2(){for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2()}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._objectVisibilityUpdated(this,!1),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this._opacityUpdated&&this.scene._objectColorizeUpdated(this,!1),this._opacityUpdated&&this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._destroy();e._aabbDirty=!0}}const U=p.vec3(),G=function(){const e=new Float64Array(16),t=new Float64Array(4),i=new Float64Array(4);return function(s,r,o){return o=o||e,t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,p.transformVec4(s,t,i),p.setMat4Translation(s,i,o),o.slice()}}();function W(e,t,i,s=1e3){const r=p.getPositionsCenter(e,U),o=Math.round(r[0]/s)*s,n=Math.round(r[1]/s)*s,a=Math.round(r[2]/s)*s;i[0]=o,i[1]=n,i[2]=a;const l=0!==i[0]||0!==i[1]||0!==i[2];if(l)for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]-o,t[i+1]=e[i+1]-n,t[i+2]=e[i+2]-a;return l}function H(e,t,i,s){const r=p.dotVec3(t,i)+e,o=p.normalizeVec3(t,U);return p.mulVec3Scalar(o,-r,s),s}p.vec4(),p.vec4(),p.vec3(),p.vec3(),p.vec3(),p.vec3(),p.vec3();class X extends T{get type(){return"Spinner"}constructor(e,t={}){super(e,t),this._canvas=t.canvas,this._element=null,this._isCustom=!1,t.elementId&&(this._element=document.getElementById(t.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+t.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const e="xeokit-spinner-css";if(document.getElementById(e))return;const t=document.createElement("style");t.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",t.id=e,document.body.appendChild(t)}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}set processes(e){if(e=e||0,this._processes===e)return;if(e<0)return;const t=this._processes;this._processes=e;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}const Y={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},q=document.createElement("canvas");if(q){const e=q.getContext("webgl",{antialias:!0})||q.getContext("experimental-webgl",{antialias:!0});Y.WEBGL=!!e,Y.WEBGL&&(Y.ANTIALIAS=e.getContextAttributes().antialias,e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?Y.FS_MAX_FLOAT_PRECISION="highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?Y.FS_MAX_FLOAT_PRECISION="mediump":Y.FS_MAX_FLOAT_PRECISION="lowp":Y.FS_MAX_FLOAT_PRECISION="mediump",Y.DEPTH_BUFFER_BITS=e.getParameter(e.DEPTH_BITS),Y.MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),Y.MAX_CUBE_MAP_SIZE=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),Y.MAX_RENDERBUFFER_SIZE=e.getParameter(e.MAX_RENDERBUFFER_SIZE),Y.MAX_TEXTURE_UNITS=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),Y.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),Y.MAX_VERTEX_ATTRIBS=e.getParameter(e.MAX_VERTEX_ATTRIBS),Y.MAX_VERTEX_UNIFORM_VECTORS=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),Y.MAX_FRAGMENT_UNIFORM_VECTORS=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),Y.MAX_VARYING_VECTORS=e.getParameter(e.MAX_VARYING_VECTORS),e.getSupportedExtensions().forEach((function(e){Y.SUPPORTED_EXTENSIONS[e]=!0})))}const $=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class Z extends T{constructor(e,t={}){super(e,t),this._backgroundColor=p.vec3([t.backgroundColor?t.backgroundColor[0]:1,t.backgroundColor?t.backgroundColor[1]:1,t.backgroundColor?t.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!t.backgroundColorFromAmbientLight,this.canvas=t.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.optimizeResizeDetection=!0,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.resolutionScale=t.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(t);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(e){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(e){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=null,r=null,o=null,n=null,a=null,l=null,h=null,c=null,u=0;this._tick=this.scene.on("tick",(()=>{if(u++,i._canvasSizeChanged=!1,i.optimizeResizeDetection&&u<10)return;u=0;const e=this.canvas,t=this._resolutionScale!==s,d=window.innerWidth!==r||window.innerHeight!==o,p=e.clientWidth!==n||e.clientHeight!==a,m=e.offsetLeft!==l||e.offsetTop!==h,g=e.parentElement;if(t||d||p||m||g!==c){if(i._canvasSizeChanged=!0,this._spinner._adjustPosition(),t||p||m){const i=e.clientWidth,s=e.clientHeight;if(t||p){let t,i=0;for(const e in A.scenes)A.scenes.hasOwnProperty(e)&&(t=A.scenes[e],i+=Math.round(t.canvas.canvas.clientWidth*this._resolutionScale*(t.canvas.canvas.clientHeight*this._resolutionScale)));f.memory.pixels=i,e.width=Math.round(e.clientWidth*this._resolutionScale),e.height=Math.round(e.clientHeight*this._resolutionScale)}const r=this.boundary;r[0]=e.offsetLeft,r[1]=e.offsetTop,r[2]=i,r[3]=s,t||this.fire("boundary",r),n=i,a=s}t&&(s=this._resolutionScale),d&&(r=window.innerWidth,o=window.innerHeight),m&&(l=e.offsetLeft,h=e.offsetTop),c=g}})),this._spinner=new X(this.scene,{canvas:this.canvas,elementId:t.spinnerElementId})}get type(){return"Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(e){this._backgroundColorFromAmbientLight=!1!==e,this.glRedraw()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get resolutionScale(){return this._resolutionScale}set resolutionScale(e){if((e=e||1)===this._resolutionScale)return;this._resolutionScale=e;const t=this.canvas;t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale),this.glRedraw()}get spinner(){return this._spinner}_createCanvas(){const e="xeokit-canvas-"+p.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}_getElementXY(e){let t=0,i=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<$.length;e++)try{this.gl=this.canvas.getContext($[e],this.contextAttr)}catch(e){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0));{const e=this.gl;let t="__",i=e.activeTexture;e.activeTexture=function(e){t!==e&&(t=e,i.call(this,e))};let s={},r=e.bindTexture;e.bindTexture=function(e,i){s[t]!==i&&(s[t]=i,r.call(this,e,i))}}this.gl&&this.webgl2&&(this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST),this.gl,WebGL2RenderingContext)}getSnapshot(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}class K{constructor(e){this._scene=e,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1}getRTCViewMatrix(e,t){let i=this._rtcViewMats[e];return i||(i=this._getNewMat(),G(this._scene.camera.viewMatrix,t,i),this._rtcViewMats[e]=i),i}getRTCPickViewMatrix(e,t){let i=this._rtcPickViewMats[e];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;G(s,t,i),this._rtcPickViewMats[e]=i}return i}_getNewMat(){let e=this._matPool[this._matPoolNextFreeIndex];return e||(e=p.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}class Q{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this.touchInput=!1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1,this.touchInput=!1}}class J{constructor(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),this.handle){if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const t=i.split("\n"),s=[];for(let e=0;e<t.length;e++)s.push(e+1+": "+t[e]+"\n");this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class ee{constructor(e,t){this.bindTexture=function(i,s){return!!i.bind(s)&&(e.uniform1i(t,s),!0)}}}class te{constructor(e,t){this._gl=e,this.location=t}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}const ie=new t({});function se(e){const t=[];let i,s;for(let r=0,o=e.length;r<o;r++)i=e[r],s=i.indexOf("/"),s>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),t.push(i);return t.join("\n")}function re(e){console.error(e.join("\n"))}class oe{constructor(e,t){this.id=ie.addItem({}),this.source=t,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new J(e,e.VERTEX_SHADER,se(this.source.vertex)),this._fragmentShader=new J(e,e.FRAGMENT_SHADER,se(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void re(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void re(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void re(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void re(this.errors);let t,i,s,r,o;if(this.compiled=!0,this.handle=e.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void re(this.errors);const n=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<n;++i)s=e.getActiveUniform(this.handle,i),s&&(r=s.name,"\0"===r[r.length-1]&&(r=r.substr(0,r.length-1)),o=e.getUniformLocation(this.handle,r),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||35682===s.type||e instanceof WebGL2RenderingContext&&(s.type===e.UNSIGNED_INT_SAMPLER_2D||s.type===e.INT_SAMPLER_2D)?this.samplers[r]=new ee(e,o):this.uniforms[r]=o);const a=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<a;i++)t=e.getActiveAttrib(this.handle,i),t&&(o=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new te(e,o));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,i){if(!this.allocated)return!1;const s=this.samplers[e];return!!s&&s.bindTexture(t,i)}destroy(){this.allocated&&(ie.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class ne{constructor(e,t,i,s,r,o,n,a,l){switch(this._gl=e,this.type=t,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=r,this.normalized=!!n,this.stride=a||0,this.offset=l||0,this._allocate(i)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}class ae{constructor(e,t){this.scene=e,this.aabb=p.AABB3(),this.origin=p.vec3(t),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(e){if(!this.markers[e.id])return;const t=this.markerIndices[e.id];this.positions[3*t+0]=e.worldPos[0],this.positions[3*t+1]=e.worldPos[1],this.positions[3*t+2]=e.worldPos[2],this.positionsDirty=!0}removeMarker(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){for(var e in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let e=0;for(let t=0;t<this.numMarkers;t++)if(this.markerList[t]){const i=this.markerList[t].worldPos;this.positions[e++]=i[0],this.positions[e++]=i[1],this.positions[e++]=i[2],this.indices[t]=t}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}_buildAABB(){const e=this.aabb;p.collapseAABB3(e),p.expandAABB3Points3(e,this.positions);const t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const e=this.scene.canvas.gl,t=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new ne(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const e=this.scene.canvas,t=this.scene.camera.perspective.near,i=e.boundary,s=i[2],r=i[3];let o=0;this.lenOcclusionTestList=0;for(let e=0;e<this.numMarkers;e++){const i=this.markerList[e];if(i.viewPos[2]>-t){i._setVisible(!1);continue}const n=i.canvasPos,a=n[0],l=n[1];a+10<0||l+10<0||a-10>s||l-10>r?i._setVisible(!1):!i.entity||i.entity.visible?i.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=i,this.pixels[o++]=a,this.pixels[o++]=l):i._setVisible(!0):i._setVisible(!1)}}_updateActiveSectionPlanes(){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const t=e[i];if(t.active){const e=p.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return void(this.culledBySectionPlanes=!0);const s=0===e;this.sectionPlanesActive[i]=s}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const le=p.vec3([1,0,0]),he=p.vec3();class ce{constructor(e,t){this._scene=e,this._renderBufferManager=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=e.camera.on("viewMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCameraProjMatrix=e.camera.on("projMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCanvasBoundary=e.canvas.on("boundary",(()=>{this._occlusionTestListDirty=!0}))}addMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i||(i=new ae(this._scene,e.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(e){const t=this._markersToOcclusionLayersMap[e.id];if(!t)return void e.error("Marker has not been added to OcclusionTester");const i=e.origin.join();if(i!==t.originHash){1===t.numMarkers?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);let s=this._occlusionLayers[i];s||(s=new ae(this._scene,e.origin),this._occlusionLayers[i]=t,this._occlusionLayersListDirty=!0),s.addMarker(e),this._markersToOcclusionLayersMap[e.id]=s}else t.markerWorldPosUpdated(e)}removeMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let e=0;for(let t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// OcclusionTester vertex shader"),i.push("in vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_PointSize = 20.0;"),e.logarithmicDepthBufferEnabled?i.push("vFragDepth = 1.0 + clipPos.w;"):i.push("clipPos.z += -0.001;"),i.push("   gl_Position = clipPos;"),i.push("}"),i}_buildFragmentShaderSource(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// OcclusionTester fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e._sectionPlanesState,r=e.camera,o=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}for(let e=0,i=this._occlusionLayersList.length;e<i;e++){const i=this._occlusionLayersList[e];if(i.update(),i.culledBySectionPlanes)continue;const o=i.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,G(r.viewMatrix,o));const n=s.sectionPlanes.length;if(n>0){const e=s.sectionPlanes;for(let s=0;s<n;s++){const r=this._uSectionPlanes[s];if(r){const n=i.sectionPlanesActive[s];if(t.uniform1i(r.active,n?1:0),n){const i=e[s];t.uniform3fv(r.pos,H(i.dist,i.dir,o,he)),t.uniform3fv(r.dir,i.dir)}}}}this._aPosition.bindArrayBuffer(i.positionsBuf);const a=i.indicesBuf;a.bind(),t.drawElements(t.POINTS,a.numItems,a.itemType,0)}}doOcclusionTest(){{const e=this._scene.canvas.resolutionScale,t=255*le[0],i=255*le[1],s=255*le[2];for(let r=0,o=this._occlusionLayersList.length;r<o;r++){const o=this._occlusionLayersList[r];for(let r=0;r<o.lenOcclusionTestList;r++){const n=o.occlusionTestList[r],a=2*r,l=this._readPixelBuf.read(Math.round(o.pixels[a]*e),Math.round(o.pixels[a+1]*e)),h=l[0]===t&&l[1]===i&&l[2]===s;n._setVisible(h)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const ue=p.vec2();class de{constructor(e){this._scene=e,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(e){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let e=!0;this._scene.camera.on("projMatrix",(function(){e=!0}));const t=p.mat4();return()=>(e&&p.inverseMat4(s.camera.projMatrix,t),t)})());const t=this._scene.canvas.gl,i=this._program,s=this._scene,r=s.sao,o=t.drawingBufferWidth,n=t.drawingBufferHeight,a=s.camera.project._state,l=a.near,h=a.far,c=a.matrix,u=this._getInverseProjectMat(),d=Math.random(),f="perspective"===s.camera.projection;ue[0]=o,ue[1]=n,t.viewport(0,0,o,n),t.clearColor(0,0,0,1),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.frontFace(t.CCW),t.clear(t.COLOR_BUFFER_BIT),i.bind(),t.uniform1f(this._uCameraNear,l),t.uniform1f(this._uCameraFar,h),t.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,c),t.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,u),t.uniform1i(this._uPerspective,f),t.uniform1f(this._uScale,r.scale*(h/5)),t.uniform1f(this._uIntensity,r.intensity),t.uniform1f(this._uBias,r.bias),t.uniform1f(this._uKernelRadius,r.kernelRadius),t.uniform1f(this._uMinResolution,r.minResolution),t.uniform2fv(this._uViewport,ue),t.uniform1f(this._uRandomSeed,d);const m=e.getDepthTexture();i.bindTexture(this._uDepthTexture,m,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),t.drawElements(t.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let e=!1;const t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),!e)return;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new oe(i,{vertex:["#version 300 es\n                    precision highp float;\n                    precision highp int;\n                    \n                    in vec3 aPosition;\n                    in vec2 aUV;            \n                    \n                    out vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:[`#version 300 es      \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ${this._numSamples}\n                #define NUM_RINGS 4              \n            \n                in vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                out vec4 outColor;\n   \n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \toutColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }`]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const s=new Float32Array([1,1,0,1,0,0,1,0]),r=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new ne(i,i.ARRAY_BUFFER,r,r.length,3,i.STATIC_DRAW),this._uvBuf=new ne(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new ne(i,i.ELEMENT_ARRAY_BUFFER,o,o.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const pe=new Float32Array(be(17,[0,1])),fe=new Float32Array(be(17,[1,0])),me=new Float32Array(function(e,t){const i=[];for(let s=0;s<=e;s++)i.push(ve(s,t));return i}(17,4)),ge=new Float32Array(2);class _e{constructor(e){this._scene=e,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const e=this._scene.canvas.gl;if(this._program=new oe(e,{vertex:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                in vec3 aPosition;\n                in vec2 aUV;\n                uniform vec2 uViewport;\n                out vec2 vUV;\n                out vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                in vec2        vUV;\n                in vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                out vec4 outColor;\n        \n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    outColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const t=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new ne(e,e.ARRAY_BUFFER,i,i.length,3,e.STATIC_DRAW),this._uvBuf=new ne(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new ne(e,e.ELEMENT_ARRAY_BUFFER,s,s.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(e,t,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let e=!0;this._scene.camera.on("projMatrix",(function(){e=!0}));const t=p.mat4();return()=>(e&&p.inverseMat4(o.camera.projMatrix,t),t)})());const s=this._scene.canvas.gl,r=this._program,o=this._scene,n=s.drawingBufferWidth,a=s.drawingBufferHeight,l=o.camera.project._state,h=l.near,c=l.far;s.viewport(0,0,n,a),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.bind(),ge[0]=n,ge[1]=a,s.uniform2fv(this._uViewport,ge),s.uniform1f(this._uCameraNear,h),s.uniform1f(this._uCameraFar,c),s.uniform1f(this._uDepthCutoff,.01),0===i?s.uniform2fv(this._uSampleOffsets,fe):s.uniform2fv(this._uSampleOffsets,pe),s.uniform1fv(this._uSampleWeights,me);const u=e.getDepthTexture(),d=t.getTexture();r.bindTexture(this._uDepthTexture,u,0),r.bindTexture(this._uOcclusionTexture,d,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function ve(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)}function be(e,t){const i=[];for(let s=0;s<=e;s++)i.push(t[0]*s),i.push(t[1]*s);return i}const xe=function(){const e=document.createElement("canvas"),t=String.fromCharCode;if(!e.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!e.getContext("2d").getImageData,s=!!e.toDataURL,r=!!window.btoa,o=function(e){let i="";const s=e.width,r=e.height;i+="BM";let o=s*r*4+54;i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),o=Math.floor(o/256),i+=t(o%256),i+=t(0,0,0,0,54,0,0,0),i+=t(40,0,0,0);let n=s;i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256),n=Math.floor(n/256),i+=t(n%256);let a=r;i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),a=Math.floor(a/256),i+=t(a%256),i+=t(1,0,32,0),i+=t(0,0,0,0);let l=s*r*4;i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),l=Math.floor(l/256),i+=t(l%256),i+=t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=e.data;let c,u,d,p,f="",m=r;do{for(d=s*(m-1)*4,p="",c=0;c<s;c++)u=4*c,p+=t(h[d+u+2],h[d+u+1],h[d+u],h[d+u+3]);f+=p}while(--m);return function(e){let i,s,r="";if("string"==typeof e)r=e;else for(s=e,i=0;i<s.length;i++)r+=t(s[i]);return btoa(r)}(i+f)},n=function(e){window.open(e)||(document.location.href=e)},a=function(e,t){return"data:"+t+";base64,"+e},l=function(e){const t=document.createElement("img");return t.src=e,t},h=function(e,t,i,s){if(t&&i){const r=document.createElement("canvas");r.width=t,r.height=i,r.style.width=t+"px",r.style.height=i+"px";const o=r.getContext("2d");return s?(o.save(),o.scale(1,-1),o.imageSmoothingEnabled=!0,o.drawImage(e,0,0,e.width,e.height,0,0,t,-i),o.restore()):(o.imageSmoothingEnabled=!0,o.drawImage(e,0,0,e.width,e.height,0,0,t,i)),r}return e};return{saveAsPNG:function(e,t,i,r,o){if(!s)return!1;const a=h(e,i,r,o).toDataURL("image/png");return t?l(a):(n(a),!0)},saveAsJPEG:function(e,t,i,r,o){if(!s)return!1;const a="image/jpeg",c=h(e,i,r,o).toDataURL(a);return 5==c.indexOf(a)&&(t?l(c):(n(c),!0))},saveAsBMP:function(e,t,c,u,d){if(!(s&&i&&r))return!1;const p="image/bmp",f=function(e){const t=parseInt(e.width),i=parseInt(e.height);return e.getContext("2d").getImageData(0,0,t,i)}(h(e,c,u,d)),m=o(f);return t?l(a(m,p)):(n(a(m,p)),!0)}}}();class ye{constructor(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let e,t;const i=this.gl;if(this.size?(e=this.size[0],t=this.size[1]):(e=i.drawingBufferWidth,t=i.drawingBufferHeight),this.buffer){if(this.buffer.width===e&&this.buffer.height===t)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();let r;i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,e,t,0,i.RGBA,i.UNSIGNED_BYTE,null),this._hasDepthTexture&&(r=i.createTexture(),i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_COMPONENT32F,e,t,0,i.DEPTH_COMPONENT,i.FLOAT,null));const o=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,o),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT32F,e,t);const n=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,n),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),this._hasDepthTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,r,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,o),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,n),!i.isFramebuffer(n))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const a=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(a){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+a}this.buffer={framebuf:n,renderbuf:o,texture:s,depthTexture:r,width:e,height:t},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,t){const i=e,s=this.gl.drawingBufferHeight-t,r=new Uint8Array(4),o=this.gl;return o.readPixels(i,s,1,1,o.RGBA,o.UNSIGNED_BYTE,r),r}readImage(e){const t=this.gl,i=this._getImageDataCache(),s=i.pixelData,r=i.canvas,o=i.imageData,n=i.context;t.readPixels(0,0,this.buffer.width,this.buffer.height,t.RGBA,t.UNSIGNED_BYTE,s),o.data.set(s),n.putImageData(o,0,0);const a=e.width||r.width,l=e.height||r.height,h=e.format||"jpeg",c=!0;let u;switch(h){case"jpeg":u=xe.saveAsJPEG(r,!0,a,l,c);break;case"png":u=xe.saveAsPNG(r,!0,a,l,c);break;case"bmp":u=xe.saveAsBMP(r,!0,a,l,c);break;default:console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),u=xe.saveAsJPEG(r,!0,a,l,c)}return u.src}_getImageDataCache(){const e=this.buffer.width,t=this.buffer.height;let i=this._imageDataCache;if(i&&(i.width===e&&i.height===t||(this._imageDataCache=null,i=null)),!i){const s=document.createElement("canvas");s.width=e,s.height=t;const r=s.getContext("2d"),o=r.createImageData(e,t);i={pixelData:new Uint8Array(e*t*4),canvas:s,context:r,imageData:o,width:e,height:t},this._imageDataCache=i}return i}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(){const e=this;return this._texture||(this._texture={renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.texture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.texture),!0)},unbind:function(t){e.buffer&&e.buffer.texture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.depthTexture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0)},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const e=this.gl;e.deleteTexture(this.buffer.texture),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class Pe{constructor(e){this.scene=e,this._renderBuffersBasic={},this._renderBuffersScaled={}}getRenderBuffer(e,t){const i=1===this.scene.canvas.resolutionScale?this._renderBuffersBasic:this._renderBuffersScaled;let s=i[e];return s||(s=new ye(this.scene.canvas.canvas,this.scene.canvas.gl,t),i[e]=s),s}destroy(){for(let e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(let e in this._renderBuffersScaled)this._renderBuffersScaled[e].destroy()}}function we(e,t){if(void 0===e._cachedExtensions&&(e._cachedExtensions={}),void 0!==e._cachedExtensions[t])return e._cachedExtensions[t];let i;switch(t){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(t)}return e._cachedExtensions[t]=i,i}var Me=function(){const e=[],t=[],i=[],s=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),h=p.vec3(),c=p.vec3(),u=p.vec3(),d=p.vec3(),f=p.vec3(),m=p.vec3(),g=p.vec3();return function(_,v,b,x){!function(r,o){const n={};let a,l,h,c;const u=Math.pow(10,4);let d,p,f=0;for(d=0,p=r.length;d<p;d+=3)a=r[d],l=r[d+1],h=r[d+2],c=Math.round(a*u)+"_"+Math.round(l*u)+"_"+Math.round(h*u),void 0===n[c]&&(n[c]=f/3,e[f++]=a,e[f++]=l,e[f++]=h),t[d/3]=n[c];for(d=0,p=o.length;d<p;d++)s[d]=t[o[d]],i[s[d]]=o[d]}(_,v),function(t,i){o=0;for(let _=0,v=t;_<v;_+=3){const t=3*s[_],v=3*s[_+1],b=3*s[_+2];i?(n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],a[0]=e[v],a[1]=e[v+1],a[2]=e[v+2],l[0]=e[b],l[1]=e[b+1],l[2]=e[b+2],p.decompressPosition(n,i,h),p.decompressPosition(a,i,c),p.decompressPosition(l,i,u)):(h[0]=e[t],h[1]=e[t+1],h[2]=e[t+2],c[0]=e[v],c[1]=e[v+1],c[2]=e[v+2],u[0]=e[b],u[1]=e[b+1],u[2]=e[b+2]),p.subVec3(u,c,d),p.subVec3(h,c,f),p.cross3Vec3(d,f,m),p.normalizeVec3(m,g);const x=r[o]||(r[o]={normal:p.vec3()});x.normal[0]=g[0],x.normal[1]=g[1],x.normal[2]=g[2],o++}}(v.length,b);const y=[],P=Math.cos(p.DEGTORAD*x),w={};let M,C,E,A,D,T,S,I,F,L,B,R=!1;for(let e=0,t=v.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)M=s[e+i],C=s[e+(i+1)%3],E=Math.min(M,C),A=Math.max(M,C),D=E+","+A,void 0===w[D]?w[D]={index1:E,index2:A,face1:t,face2:void 0}:w[D].face2=t}for(D in w)T=w[D],void 0!==T.face2&&(S=r[T.face1].normal,I=r[T.face2].normal,F=p.dotVec3(S,I),F>P)||(L=i[T.index1],B=i[T.index2],(!R&&L>65535||B>65535)&&(R=!0),y.push(L),y.push(B));return R?new Uint32Array(y):new Uint16Array(y)}}();class Ce{constructor(e,t,i,s,r=null,o=0){this.model=e,this.object=null,this.parent=null,this.id=t,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=p.AABB3(),this._layer=r,this._portionId=o,this._color=[i[0],i[1],i[2],s],this._colorize=[i[0],i[1],i[2],s],this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.origin=null}_finalize(e){this._layer.initFlags(this._portionId,e,this._transparent)}_finalize2(){this._layer.flushInitFlags&&this._layer.flushInitFlags()}_setVisible(e){this._layer.setVisible(this._portionId,e,this._transparent)}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1)}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1)}_setOpacity(e,t){const i=e<255,s=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),s&&this._layer.setTransparent(this._portionId,t,i)}_setOffset(e){this._layer.setOffset(this._portionId,e)}_setHighlighted(e){this._layer.setHighlighted(this._portionId,e,this._transparent)}_setXRayed(e){this._layer.setXRayed(this._portionId,e,this._transparent)}_setSelected(e){this._layer.setSelected(this._portionId,e,this._transparent)}_setEdges(e){this._layer.setEdges(this._portionId,e,this._transparent)}_setClippable(e){this._layer.setClippable(this._portionId,e,this._transparent)}_setCollidable(e){this._layer.setCollidable(this._portionId,e)}_setPickable(e){this._layer.setPickable(this._portionId,e,this._transparent)}_setCulled(e){this._layer.setCulled(this._portionId,e,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(e,t){}pickTriangleSurface(e){}precisionRayPickSurface(e,t,i,s){return!!this._layer.precisionRayPickSurface&&this._layer.precisionRayPickSurface(this._portionId,e,t,i,s)}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const Ee=1,Ae=4,De=8,Te=16,Se=32,Ie=256,Fe=512,Le=1024,Be=2048,Re=new Float32Array([0,0,0]),ke=new Uint16Array([0,0,0]);class Oe{constructor(e,t,i,s,r,o){this._isObject=t,this.scene=e.scene,this.model=e,this.meshes=s,this._numTriangles=0;for(var n=0,a=this.meshes.length;n<a;n++){const e=this.meshes[n];e.parent=this,this._numTriangles+=e.numTriangles}this.id=i,this.originalSystemId=p.unglobalizeObjectId(e.id,i),this._flags=r,this._aabb=o,this._offsetAABB=p.AABB3(o),this._offset=p.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&e.scene._registerObject(this)}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get aabb(){return this._offsetAABB}get numTriangles(){return this._numTriangles}get visible(){return this._getFlag(Ee)}set visible(e){if(!!(this._flags&Ee)!==e){this._flags=e?this._flags|Ee:this._flags&~Ee;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(Fe)}set highlighted(e){if(!!(this._flags&Fe)!==e){this._flags=e?this._flags|Fe:this._flags&~Fe;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(Ie)}set xrayed(e){if(!!(this._flags&Ie)!==e){this._flags=e?this._flags|Ie:this._flags&~Ie;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(Le)}set selected(e){if(!!(this._flags&Le)!==e){this._flags=e?this._flags|Le:this._flags&~Le;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(Be)}set edges(e){if(!!(this._flags&Be)!==e){this._flags=e?this._flags|Be:this._flags&~Be;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}get culledVFC(){return!!this._culledVFC}set culledVFC(e){this._culledVFC=e,this.internalSetCulled()}get culledLOD(){return!!this._culledLOD}set culledLOD(e){this._culledLOD=e,this.internalSetCulled()}get culled(){return!!this._culled}set culled(e){this._culled=e,this.internalSetCulled()}internalSetCulled(){let e=!!this._culled||!!this._culledLOD||!!this._culledVFC;if(!!(this._flags&Ae)!==e){this._flags=e?this._flags|Ae:this._flags&~Ae;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(Te)}set clippable(e){if(!!(this._flags&Te)!==e){this._flags=e?this._flags|Te:this._flags&~Te;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(Se)}set collidable(e){if(!!(this._flags&Se)!==e){this._flags=e?this._flags|Se:this._flags&~Se;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}get pickable(){return this._getFlag(De)}set pickable(e){if(!!(this._flags&De)!==e){this._flags=e?this._flags|De:this._flags&~De;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}get colorize(){if(0===this.meshes.length)return null;const e=this.meshes[0]._colorize;return Re[0]=e[0]/255,Re[1]=e[1]/255,Re[2]=e[2]/255,Re}set colorize(e){if(e){ke[0]=Math.floor(255*e[0]),ke[1]=Math.floor(255*e[1]),ke[2]=Math.floor(255*e[2]);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(ke)}else for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(null);if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t),this._colorizeUpdated=t}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(0===this.meshes.length)return;const t=null!=e,i=this.meshes[0]._colorize[3];let s=255;if(t){if(e<0?e=0:e>1&&(e=1),s=Math.floor(255*e),i===s)return}else if(s=255,i===s)return;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOpacity(s,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw()}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model._aabbDirty=!0,this.model.glRedraw()}get castsShadow(){return!1}set castsShadow(e){}get receivesShadow(){return!1}set receivesShadow(e){}get saoEnabled(){return this.model.saoEnabled}_getFlag(e){return!!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize(this._flags)}_finalize2(){for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2()}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._objectVisibilityUpdated(this,!1),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this._opacityUpdated&&this.scene._objectColorizeUpdated(this,!1),this._opacityUpdated&&this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._destroy();e._aabbDirty=!0}}const Ne=0,je=1,Ve=2,ze=3,Ue=4,Ge=5,We=6,He=7,Xe=8,Ye=9,qe=10,$e=11,Ze=new t({});class Ke{constructor(e){this.id=Ze.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}destroy(){Ze.removeItem(this.id)}}const Qe=function(){const e=p.mat4(),t=p.mat4();return function(i,s){s=s||p.mat4();const r=i[0],o=i[1],n=i[2],a=i[3]-r,l=i[4]-o,h=i[5]-n,c=65535;return p.identityMat4(e),p.translationMat4v(i,e),p.identityMat4(t),p.scalingMat4v([a/c,l/c,h/c],t),p.mulMat4(e,t,s),s}}();var Je=function(){const e=p.mat4(),t=p.mat4();return function(i,s,r){const o=new Uint16Array(i.length),n=new Float32Array([r[0]!==s[0]?65535/(r[0]-s[0]):0,r[1]!==s[1]?65535/(r[1]-s[1]):0,r[2]!==s[2]?65535/(r[2]-s[2]):0]);let a;for(a=0;a<i.length;a+=3)o[a+0]=Math.max(0,Math.min(65535,Math.floor((i[a+0]-s[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((i[a+1]-s[1])*n[1]))),o[a+2]=Math.max(0,Math.min(65535,Math.floor((i[a+2]-s[2])*n[2])));p.identityMat4(e),p.translationMat4v(s,e),p.identityMat4(t),p.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],t);return{quantized:o,decodeMatrix:p.mulMat4(e,t,p.identityMat4())}}}();var et=function(){const e=p.mat3(),t=p.mat3();return function(i,s,r){const o=new Uint16Array(i.length),n=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let a;for(a=0;a<i.length;a+=2)o[a+0]=Math.max(0,Math.min(65535,Math.floor((i[a+0]-s[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((i[a+1]-s[1])*n[1])));p.identityMat3(e),p.translationMat3v(s,e),p.identityMat3(t),p.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],t);return{quantized:o,decodeMatrix:p.mulMat3(e,t,p.identityMat3())}}}();function tt(e,t,i,s){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),o=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=(1-Math.abs(o))*(r>=0?1:-1),t=(1-Math.abs(r))*(o>=0?1:-1);r=e,o=t}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function it(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function st(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}const rt={getPositionsBounds:function(e){const t=new Float32Array(3),i=new Float32Array(3);let s,r;for(s=0;s<3;s++)t[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<e.length;s+=3)for(r=0;r<3;r++)t[r]=Math.min(t[r],e[s+r]),i[r]=Math.max(i[r],e[s+r]);return{min:t,max:i}},createPositionsDecodeMatrix:Qe,compressPositions:Je,compressPosition:function(e,t,i){const s=new Float32Array([t[3]!==t[0]?65535/(t[3]-t[0]):0,t[4]!==t[1]?65535/(t[4]-t[1]):0,t[5]!==t[2]?65535/(t[5]-t[2]):0]);i[0]=Math.max(0,Math.min(65535,Math.floor((e[0]-t[0])*s[0]))),i[1]=Math.max(0,Math.min(65535,Math.floor((e[1]-t[1])*s[1]))),i[2]=Math.max(0,Math.min(65535,Math.floor((e[2]-t[2])*s[2])))},decompressPositions:function(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressPosition:function(e,t,i){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i},decompressAABB:function(e,t,i=e){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i[3]=e[3]*t[0]+t[12],i[4]=e[4]*t[5]+t[13],i[5]=e[5]*t[10]+t[14],i},getUVBounds:function(e){const t=new Float32Array(2),i=new Float32Array(2);let s,r;for(s=0;s<2;s++)t[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<e.length;s+=2)for(r=0;r<2;r++)t[r]=Math.min(t[r],e[s+r]),i[r]=Math.max(i[r],e[s+r]);return{min:t,max:i}},compressUVs:et,decompressUVs:function(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},compressNormals:function(e){const t=new Int8Array(e.length);let i,s,r,o,n;for(let a=0;a<e.length;a+=3)r=i=tt(e,a,"floor","floor"),s=it(i),o=n=st(e,a,s),i=tt(e,a,"ceil","floor"),s=it(i),o=st(e,a,s),o>n&&(r=i,n=o),i=tt(e,a,"floor","ceil"),s=it(i),o=st(e,a,s),o>n&&(r=i,n=o),i=tt(e,a,"ceil","ceil"),s=it(i),o=st(e,a,s),o>n&&(r=i,n=o),t[a]=r[0],t[a+1]=r[1];return t},decompressNormals:function(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],o=e[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);t[s+0]=r/a,t[s+1]=o/a,t[s+2]=n/a,s+=3}return t},decompressNormal:function(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return t[0]=i/o,t[1]=s/o,t[2]=r/o,t}};class ot extends T{get type(){return"Perspective"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Ke({matrix:p.mat4(),inverseMatrix:p.mat4(),transposedMatrix:p.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=t.fov,this.fovAxis=t.fovAxis,this.near=t.near,this.far=t.far}_update(){const e=this.scene.viewport.boundary,t=e[2]/e[3],i=this._fovAxis;let s=this._fov;("x"===i||"min"===i&&t<1||"max"===i&&t>1)&&(s/=t),s=Math.min(s,120),p.perspectiveMat4(s*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set fov(e){(e=null!=e?e:60)!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){const t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=null!=e?e:2e3;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(p.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(p.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,p.mulMat4v4(this.inverseMatrix,i,s),p.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,p.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class nt extends T{get type(){return"Ortho"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Ke({matrix:p.mat4(),inverseMatrix:p.mat4(),transposedMatrix:p.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const e=this.scene,t=.5*this._scale,i=e.viewport.boundary,s=i[2],r=i[3],o=s/r;let n,a,l,h;s>r?(n=-t,a=t,l=t/o,h=-t/o):(n=-t*o,a=t*o,l=t,h=-t),p.orthoMat4c(n,a,h,l,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(e){null==e&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){const t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=null!=e?e:2e3;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(p.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(p.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,p.mulMat4v4(this.inverseMatrix,i,s),p.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,p.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class at extends T{get type(){return"Frustum"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Ke({matrix:p.mat4(),inverseMatrix:p.mat4(),transposedMatrix:p.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far}_update(){p.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(e){this._left=null!=e?e:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=null!=e?e:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=null!=e?e:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=null!=e?e:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(p.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(p.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,p.mulMat4v4(this.inverseMatrix,i,s),p.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,p.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class lt extends T{get type(){return"CustomProjection"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new Ke({matrix:p.mat4(),inverseMatrix:p.mat4(),transposedMatrix:p.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=t.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(p.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(p.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,p.mulMat4v4(this.inverseMatrix,i,s),p.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,p.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy()}}const ht=p.vec3(),ct=p.vec3(),ut=p.vec3(),dt=p.vec3(),pt=p.vec3(),ft=p.vec3(),mt=p.mat4(),gt=p.mat4(),_t=p.vec3(),vt=p.vec3(),bt=p.vec3(),xt=p.vec3();class yt extends T{get type(){return"Camera"}constructor(e,t={}){super(e,t),this._state=new Ke({deviceMatrix:p.mat4(),hasDeviceMatrix:!1,matrix:p.mat4(),normalMatrix:p.mat4(),inverseMatrix:p.mat4()}),this._perspective=new ot(this),this._ortho=new nt(this),this._frustum=new at(this),this._customProjection=new lt(this),this._project=this._perspective,this._eye=p.vec3([0,0,10]),this._look=p.vec3([0,0,0]),this._up=p.vec3([0,1,0]),this._worldUp=p.vec3([0,1,0]),this._worldRight=p.vec3([1,0,0]),this._worldForward=p.vec3([0,0,-1]),this.deviceMatrix=t.deviceMatrix,this.eye=t.eye,this.look=t.look,this.up=t.up,this.worldAxis=t.worldAxis,this.gimbalLock=t.gimbalLock,this.constrainPitch=t.constrainPitch,this.projection=t.projection,this._perspective.on("matrix",(()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)})),this._ortho.on("matrix",(()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)})),this._frustum.on("matrix",(()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)})),this._customProjection.on("matrix",(()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)}))}_update(){const e=this._state;let t;"ortho"===this.projection?(p.subVec3(this._eye,this._look,_t),p.normalizeVec3(_t,vt),p.mulVec3Scalar(vt,1e3,bt),p.addVec3(this._look,bt,xt),t=xt):t=this._eye,e.hasDeviceMatrix?(p.lookAtMat4v(t,this._look,this._up,gt),p.mulMat4(e.deviceMatrix,gt,e.matrix)):p.lookAtMat4v(t,this._look,this._up,e.matrix),p.inverseMat4(this._state.matrix,this._state.inverseMatrix),p.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let t=p.subVec3(this._eye,this._look,ht);p.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,mt),t=p.transformPoint3(mt,t,ct),this.eye=p.addVec3(this._look,t,ut),this.up=p.transformPoint3(mt,this._up,dt)}orbitPitch(e){if(this._constrainPitch&&(e=p.dotVec3(this._up,this._worldUp)/p.DEGTORAD)<1)return;let t=p.subVec3(this._eye,this._look,ht);const i=p.cross3Vec3(p.normalizeVec3(t,ct),p.normalizeVec3(this._up,ut));p.rotationMat4v(.0174532925*e,i,mt),t=p.transformPoint3(mt,t,dt),this.up=p.transformPoint3(mt,this._up,pt),this.eye=p.addVec3(t,this._look,ft)}yaw(e){let t=p.subVec3(this._look,this._eye,ht);p.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,mt),t=p.transformPoint3(mt,t,ct),this.look=p.addVec3(t,this._eye,ut),this._gimbalLock&&(this.up=p.transformPoint3(mt,this._up,dt))}pitch(e){if(this._constrainPitch&&(e=p.dotVec3(this._up,this._worldUp)/p.DEGTORAD)<1)return;let t=p.subVec3(this._look,this._eye,ht);const i=p.cross3Vec3(p.normalizeVec3(t,ct),p.normalizeVec3(this._up,ut));p.rotationMat4v(.0174532925*e,i,mt),this.up=p.transformPoint3(mt,this._up,ft),t=p.transformPoint3(mt,t,dt),this.look=p.addVec3(t,this._eye,pt)}pan(e){const t=p.subVec3(this._eye,this._look,ht),i=[0,0,0];let s;if(0!==e[0]){const r=p.cross3Vec3(p.normalizeVec3(t,[]),p.normalizeVec3(this._up,ct));s=p.mulVec3Scalar(r,e[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==e[1]&&(s=p.mulVec3Scalar(p.normalizeVec3(this._up,ut),e[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==e[2]&&(s=p.mulVec3Scalar(p.normalizeVec3(t,dt),e[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=p.addVec3(this._eye,i,pt),this.look=p.addVec3(this._look,i,ft)}zoom(e){const t=p.subVec3(this._eye,this._look,ht),i=Math.abs(p.lenVec3(t,ct)),s=Math.abs(i+e);if(s<.5)return;const r=p.normalizeVec3(t,ut);this.eye=p.addVec3(this._look,p.mulVec3Scalar(r,s),dt)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=p.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return p.lenVec3(p.subVec3(this._look,this._eye,ht))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy()}}const Pt=p.vec4(),wt=p.vec3();class Mt{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets);let c=r.eye;e.pickViewMatrix&&(l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),c=e.pickOrigin||c);const u=[c[0]-h[0],c[1]-h[1],c[2]-h[2]];n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i);const d=s._sectionPlanesState.sectionPlanes.length;if(d>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,r=o.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(h){const e=H(i.dist,i.dir,h,wt);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState.lights,o=t.camera.project;s.bind(),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(this._withSAO){const s=t.sao;if(s.possible){const t=i.drawingBufferWidth,r=i.drawingBufferHeight;Pt[0]=t,Pt[1]=r,Pt[2]=s.blendCutoff,Pt[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,Pt),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,10)}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.sectionPlanes.length>0;let r;const o=[];o.push("#version 300 es"),o.push("// Triangles dataTexture draw vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("precision highp usampler2D;"),o.push("precision highp isampler2D;"),o.push("precision highp sampler2D;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("precision mediump usampler2D;"),o.push("precision mediump isampler2D;"),o.push("precision mediump sampler2D;"),o.push("#endif"),o.push("uniform int renderPass;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),o.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),o.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),o.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),o.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),o.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),o.push("uniform highp sampler2D uTextureCameraMatrices;"),o.push("uniform highp sampler2D uTextureModelMatrices;"),o.push("uniform vec3 uCameraEyeRtc;"),o.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("out float isPerspective;")),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++)r=i.lights[e],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")));s&&(o.push("out vec4 vWorldPosition;"),o.push("flat out uint vFlags2;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int polygonIndex = gl_VertexID / 3;"),o.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),o.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),o.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),o.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),o.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),o.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),o.push("   return;"),o.push("} else {"),o.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),o.push("mat4 viewNormalMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 1), 0));"),o.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),o.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),o.push("mat4 worldNormalMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 1), 0), texelFetch (uTextureModelMatrices, ivec2(1, 1), 0), texelFetch (uTextureModelMatrices, ivec2(2, 1), 0), texelFetch (uTextureModelMatrices, ivec2(3, 1), 0));"),o.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),o.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),o.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),o.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),o.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),o.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),o.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),o.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),o.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),o.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),o.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),o.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),o.push("uint solid = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),o.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),o.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),o.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),o.push("uvec4 color = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),o.push("if (color.a == 0u) {"),o.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),o.push("   return;"),o.push("};"),o.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),o.push("vec3 position;"),o.push("position = positions[gl_VertexID % 3];"),o.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*positionsDecodeMatrix)) * vec4(normal,1)).xyz);"),o.push("if (solid != 1u) {"),o.push("if (isPerspectiveMatrix(projMatrix)) {"),o.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(worldMatrix * positionsDecodeMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),o.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),o.push("position = positions[2 - (gl_VertexID % 3)];"),o.push("viewNormal = -viewNormal;"),o.push("}"),o.push("} else {"),o.push("if (viewNormal.z < 0.0) {"),o.push("position = positions[2 - (gl_VertexID % 3)];"),o.push("viewNormal = -viewNormal;"),o.push("}"),o.push("}"),o.push("}"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),o.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),o.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),o.push("vec4 viewPosition = viewMatrix * worldPosition; "),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let e=0,t=i.lights.length;e<t;e++)if(r=i.lights[e],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return o.push("vec3 rgb = vec3(color.rgb) / 255.0;"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2.r;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ct=new Float32Array([1,1,1]);p.vec4();const Et=p.vec3();class At{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets);let c=r.eye;e.pickViewMatrix&&(l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),c=e.pickOrigin||c);const u=[c[0]-h[0],c[1]-h[1],c[2]-h[2]];if(n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i),i===Ge){const e=s.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===ze){const e=s.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Ue){const e=s.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,Ct);const d=s._sectionPlanesState.sectionPlanes.length;if(d>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,r=o.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Et);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture silhouette vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform highp sampler2D uTextureCameraMatrices;"),i.push("uniform highp sampler2D uTextureModelMatrices;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),i.push("mat4 viewNormalMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 1), 0));"),i.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),i.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),i.push("mat4 worldNormalMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 1), 0), texelFetch (uTextureModelMatrices, ivec2(1, 1), 0), texelFetch (uTextureModelMatrices, ivec2(2, 1), 0), texelFetch (uTextureModelMatrices, ivec2(3, 1), 0));"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),i.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),i.push("uint solid = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*positionsDecodeMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(worldMatrix * positionsDecodeMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),i.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),i.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Dt=p.vec3(),Tt=new Float32Array([0,0,0,1]);class St{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets),e.pickViewMatrix&&l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),n.uniform1i(this._uRenderPass,i),i===qe){const e=r.xrayMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Xe){const e=r.highlightMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Ye){const e=r.selectedMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,Tt);n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Dt);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(n.LINES,0,a.numEdgeIndices8Bits)),a.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(n.LINES,0,a.numEdgeIndices16Bits)),a.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(n.LINES,0,a.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform highp sampler2D uTextureCameraMatrices;"),i.push("uniform highp sampler2D uTextureModelMatrices;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),i.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),i.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),i.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),i.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),i.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const It=p.vec3();class Ft{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene;r.camera;const o=r.canvas.gl,n=t._state,a=n.textureState,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),a.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets),e.pickViewMatrix&&a.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),o.uniform1i(this._uRenderPass,i);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,n=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=n.sectionPlanesActivePerLayer[i+t];if(o.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,It);o.uniform3fv(s.pos,e)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}n.numEdgeIndices8Bits>0&&(a.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),o.drawArrays(o.LINES,0,n.numEdgeIndices8Bits)),n.numEdgeIndices16Bits>0&&(a.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),o.drawArrays(o.LINES,0,n.numEdgeIndices16Bits)),n.numEdgeIndices32Bits>0&&(a.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),o.drawArrays(o.LINES,0,n.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform highp sampler2D uTextureCameraMatrices;"),i.push("uniform highp sampler2D uTextureModelMatrices;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),i.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),i.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),i.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("uvec4 color = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),i.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),i.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vec4 rgb = vec4(color.rgba);"),i.push("vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Lt=p.vec3();class Bt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets);let c=o.eye;e.pickViewMatrix&&(l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),c=e.pickOrigin||c);const u=[c[0]-h[0],c[1]-h[1],c[2]-h[2]];if(n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Lt);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=i.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform highp sampler2D uTextureCameraMatrices;"),i.push("uniform highp sampler2D uTextureModelMatrices;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("smooth out vec4 vWorldPosition;"),i.push("flat out uvec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),i.push("mat4 viewNormalMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 1), 0));"),i.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),i.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),i.push("mat4 worldNormalMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 1), 0), texelFetch (uTextureModelMatrices, ivec2(1, 1), 0), texelFetch (uTextureModelMatrices, ivec2(2, 1), 0), texelFetch (uTextureModelMatrices, ivec2(3, 1), 0));"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),i.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),i.push("uint solid = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vPickColor = vec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0)) / 255.0;"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(worldMatrix * positionsDecodeMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*positionsDecodeMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),i.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),i.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uvec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outPickColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Rt=p.vec3();class kt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets);let c=o.eye;e.pickViewMatrix&&(l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),c=e.pickOrigin||c);const u=[c[0]-h[0],c[1]-h[1],c[2]-h[2]];if(n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Rt);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPackedVertexId=i.getAttribute("packedVertexId"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform highp sampler2D uTextureCameraMatrices;"),i.push("uniform highp sampler2D uTextureModelMatrices;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),i.push("mat4 viewNormalMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 1), 0));"),i.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),i.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),i.push("mat4 worldNormalMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 1), 0), texelFetch (uTextureModelMatrices, ivec2(1, 1), 0), texelFetch (uTextureModelMatrices, ivec2(2, 1), 0), texelFetch (uTextureModelMatrices, ivec2(3, 1), 0));"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),i.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),i.push("uint solid = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(worldMatrix * positionsDecodeMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*positionsDecodeMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),i.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),i.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outPackedDepth;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outPackedDepth = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ot=p.vec3();class Nt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets);let c=o.eye;e.pickViewMatrix&&(l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),c=e.pickOrigin||c);const u=[c[0]-h[0],c[1]-h[1],c[2]-h[2]];if(n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i),n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uPickInvisible,e.pickInvisible),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Ot);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick normals vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform highp sampler2D uTextureCameraMatrices;"),i.push("uniform highp sampler2D uTextureModelMatrices;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),i.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),i.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),i.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),i.push("uint solid = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(worldMatrix * positionsDecodeMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("normal = -normal;"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*positionsDecodeMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("normal = -normal;"),i.push("}"),i.push("}"),i.push("}"),i.push("normal = -normal;"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),i.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),i.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vWorldNormal = normal.xyz;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.w;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture pick normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out vec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outNormal = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}p.vec3();class jt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles dataTexture occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(Y.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Triangles dataTexture occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}p.vec4();const Vt=p.vec3();class zt{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this._uTexturePerObjectIdPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this._uTexturePerObjectIdColorsAndFlags,this._uTextureCameraMatrices,this._uTextureModelMatrices,this._uTexturePerObjectIdOffsets);let c=r.eye;e.pickViewMatrix&&(l.bindPickCameraTexture(this._program,this._uTextureCameraMatrices),c=e.pickOrigin||c);const u=[c[0]-h[0],c[1]-h[1],c[2]-h[2]];n.uniform3fv(this._uCameraEyeRtc,u),n.uniform1i(this._uRenderPass,i);const d=s._sectionPlanesState.sectionPlanes.length;if(d>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,r=o.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Vt);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTextureCameraMatrices="uTextureCameraMatrices",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectIdOffsets="uTexturePerObjectIdOffsets",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState;e._lightsState;const i=t.sectionPlanes.length>0,s=[];return s.push("#version 300 es"),s.push("// Triangles dataTexture draw vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("precision highp usampler2D;"),s.push("precision highp isampler2D;"),s.push("precision highp sampler2D;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("precision mediump usampler2D;"),s.push("precision mediump isampler2D;"),s.push("precision mediump sampler2D;"),s.push("#endif"),s.push("uniform int renderPass;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform highp sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),s.push("uniform lowp usampler2D uTexturePerObjectIdColorsAndFlags;"),s.push("uniform highp sampler2D uTexturePerObjectIdOffsets;"),s.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),s.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),s.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),s.push("uniform highp sampler2D uTextureCameraMatrices;"),s.push("uniform highp sampler2D uTextureModelMatrices;"),s.push("uniform vec3 uCameraEyeRtc;"),s.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;"),s.push("out float isPerspective;")),s.push("bool isPerspectiveMatrix(mat4 m) {"),s.push("    return (m[2][3] == - 1.0);"),s.push("}"),s.push("out highp vec2 vHighPrecisionZW;"),i&&(s.push("out vec4 vWorldPosition;"),s.push("flat out uint vFlags2;")),s.push("void main(void) {"),s.push("int polygonIndex = gl_VertexID / 3;"),s.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),s.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),s.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),s.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),s.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),s.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("} else {"),s.push("mat4 viewMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 0), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 0), 0));"),s.push("mat4 viewNormalMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 1), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 1), 0));"),s.push("mat4 projMatrix = mat4 (texelFetch (uTextureCameraMatrices, ivec2(0, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(1, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(2, 2), 0), texelFetch (uTextureCameraMatrices, ivec2(3, 2), 0));"),s.push("mat4 worldMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 0), 0), texelFetch (uTextureModelMatrices, ivec2(1, 0), 0), texelFetch (uTextureModelMatrices, ivec2(2, 0), 0), texelFetch (uTextureModelMatrices, ivec2(3, 0), 0));"),s.push("mat4 worldNormalMatrix = mat4 (texelFetch (uTextureModelMatrices, ivec2(0, 1), 0), texelFetch (uTextureModelMatrices, ivec2(1, 1), 0), texelFetch (uTextureModelMatrices, ivec2(2, 1), 0), texelFetch (uTextureModelMatrices, ivec2(3, 1), 0));"),s.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),s.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),s.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),s.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),s.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),s.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),s.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),s.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),s.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),s.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),s.push("mat4 entityMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0));"),s.push("positionsDecodeMatrix = entityMatrix * positionsDecodeMatrix;"),s.push("uint solid = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),s.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),s.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),s.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),s.push("uvec4 color = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),s.push("if (color.a == 0u) {"),s.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),s.push("   return;"),s.push("};"),s.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),s.push("vec3 position;"),s.push("position = positions[gl_VertexID % 3];"),s.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*positionsDecodeMatrix)) * vec4(normal,1)).xyz);"),s.push("if (solid != 1u) {"),s.push("if (isPerspectiveMatrix(projMatrix)) {"),s.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(worldMatrix * positionsDecodeMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),s.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("} else {"),s.push("if (viewNormal.z < 0.0) {"),s.push("position = positions[2 - (gl_VertexID % 3)];"),s.push("viewNormal = -viewNormal;"),s.push("}"),s.push("}"),s.push("}"),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),s.push("vec4 offset = vec4(texelFetch (uTexturePerObjectIdOffsets, objectIndexCoords, 0).rgb, 0.0);"),s.push("worldPosition.xyz = worldPosition.xyz + offset.xyz;"),s.push("vec4 viewPosition = viewMatrix * worldPosition; "),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2.r;")),s.push("gl_Position = clipPos;"),s.push("vHighPrecisionZW = gl_Position.zw;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),s.push("in highp vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ut=p.vec3();class Gt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,o=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Ut);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(Y.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}p.vec3();class Wt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2")}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),t.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry shadow vertex shader"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible        = (float(flags.x) > 0.0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.sectionPlanes.length>0,i=[];if(i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("varying vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.sectionPlanes.length;s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ht=p.vec4(),Xt=p.vec3(),Yt={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};class qt{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,r=o.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Xt);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(a.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=Y.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=this._program,o=i._lightsState,n=o.lights,a=i.camera.project;r.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(let e=0,t=n.length;e<t;e++){const t=n[e];this._uLightColor[e]&&s.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(s.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&s.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&s.uniform3fv(this._uLightDir[e],t.dir)}if(o.reflectionMaps.length>0&&o.reflectionMaps[0].texture&&this._uReflectionMap&&(r.bindTexture(this._uReflectionMap,o.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),o.lightMaps.length>0&&o.lightMaps[0].texture&&this._uLightMap&&(r.bindTexture(this._uLightMap,o.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._withSAO){const r=i.sao;if(r.possible){const i=s.drawingBufferWidth,o=s.drawingBufferHeight;Ht[0]=i,Ht[1]=o,Ht[2]=r.blendCutoff,Ht[3]=r.blendFactor,s.uniform4fv(this._uSAOParams,Ht),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++}}if(i.logarithmicDepthBufferEnabled){const e=2/(Math.log(a.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.sectionPlanes.length>0,r=t.clippingCaps,o=[];return o.push("// Triangles dataTexture quality draw vertex shader"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),e.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("varying float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),r&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),Y.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,n=[];n.push("// Triangles dataTexture quality draw fragment shader"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(n.push("varying float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("varying float vFragDepth;")),n.push("varying vec4 vViewPosition;"),n.push("varying vec3 vViewNormal;"),n.push("varying vec4 vColor;"),n.push("varying vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("varying vec3 vWorldNormal;"),n.push("uniform mat4 viewMatrix;"),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBAToDepth( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("varying vec4 vWorldPosition;"),n.push("varying vec4 vFlags2;"),o&&n.push("varying vec4 vClipPosition;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}if(n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3    diffuseColor;"),n.push("   float   specularRoughness;"),n.push("   vec3    specularColor;"),n.push("   float   shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = "+Yt[s.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = "+Yt[s.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("void main(void) {"),r){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float alpha = float(vColor.a) / 255.0;"),n.push("vec3  diffuseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(vViewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor               = vec4(outgoingLight.rgb * ambient, alpha);")):n.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("gl_FragColor = fragColor;"),e.logarithmicDepthBufferEnabled&&Y.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const $t=p.vec3();class Zt{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),this._program.bindTexture(this._uTexturePerObjectIdPositionsDecodeMatrix,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerObjectIdPositionsDecodeMatrix),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},1),this._program.bindTexture(this._uTexturePerVertexIdCoordinates,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerVertexIdCoordinates),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},2),this._program.bindTexture(this._uTexturePerObjectIdColorsAndFlags,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerObjectIdColorsAndFlags),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},3),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=e.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,$t);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}a.numIndices8Bits>0&&(this._program.bindTexture(this._uTexturePerPolygonIdPortionIds,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerPolygonIdPortionIds8Bits),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},4),this._program.bindTexture(this._uTexturePerPolygonIdIndices,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerPolygonIdIndices8Bits),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},5),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(this._program.bindTexture(this._uTexturePerPolygonIdPortionIds,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerPolygonIdPortionIds16Bits),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},4),this._program.bindTexture(this._uTexturePerPolygonIdIndices,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerPolygonIdIndices16Bits),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},5),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(this._program.bindTexture(this._uTexturePerPolygonIdPortionIds,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerPolygonIdPortionIds32Bits),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},4),this._program.bindTexture(this._uTexturePerPolygonIdIndices,{bind:function(e){return n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,a.texturePerPolygonIdIndices32Bits),!0},unbind:function(e){n.activeTexture(n["TEXTURE"+e]),n.bindTexture(n.TEXTURE_2D,null)}},5),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPackedVertexId=i.getAttribute("packedVertexId"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this._uTexturePerObjectIdPositionsDecodeMatrix="uTexturePerObjectIdPositionsDecodeMatrix",this._uTexturePerObjectIdColorsAndFlags="uTexturePerObjectIdColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds"}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick flat normals vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in uvec3 packedVertexId;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform sampler2D uTexturePerObjectIdPositionsDecodeMatrix;"),i.push("uniform usampler2D uTexturePerObjectIdColorsAndFlags;"),i.push("uniform usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform isampler2D uTexturePerPolygonIdNormals;"),i.push("uniform usampler2D uTexturePerPolygonIdPortionIds;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("out vec4 vWorldPosition;"),t&&i.push("out int vFlags2;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_normal_index = polygonIndex & 4095;"),i.push("int v_normal_index = polygonIndex >> 12;"),i.push("int h_packed_object_id_index = ((polygonIndex >> 3) / 2) & 4095;"),i.push("int v_packed_object_id_index = ((polygonIndex >> 3) / 2) >> 12;"),i.push("ivec3 packedObjectId = ivec3(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).rgb);"),i.push("int objectIndex;"),i.push("if (((polygonIndex >> 3) % 2) == 0) {"),i.push("  objectIndex = (packedObjectId.r << 4) + (packedObjectId.g >> 4);"),i.push("} else {"),i.push("  objectIndex = ((packedObjectId.g & 15) << 8) + packedObjectId.b;"),i.push("}"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("int h_index = polygonIndex & 4095;"),i.push("int v_index = polygonIndex >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 positionsDecodeMatrix = mat4 (texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectIdPositionsDecodeMatrix, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uTexturePerObjectIdColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position1 = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("vec3 position2 = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("vec3 position3 = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(position3 - position1, position2 - position1));"),i.push("int vertexNumber = gl_VertexID % 3;"),i.push("vec3 position;"),i.push("if (vertexNumber == 0) position = position1;"),i.push("else if (vertexNumber == 1) position = position2;"),i.push("else position = position3;"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags2 = flags2.r;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles dataTexture pick flat normals fragment shader"),s.push("#extension GL_OES_standard_derivatives : enable"),e.logarithmicDepthBufferEnabled&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in int vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("out vec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push("  outNormal = vec4((worldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Kt{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Mt(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Mt(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRenderer(){return this._colorQualityRenderer||(this._colorQualityRenderer=new qt(this._scene,!1)),this._colorQualityRenderer}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new qt(this._scene,!0)),this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new At(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new zt(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Gt(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new St(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Ft(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Bt(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Nt(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Zt(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new kt(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new jt(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Wt(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const Qt={};class Jt{constructor(){this.positions=[],this.metallicRoughness=[],this.indices8Bits=[],this.indices16Bits=[],this.indices32Bits=[],this.edgeIndices8Bits=[],this.edgeIndices16Bits=[],this.edgeIndices32Bits=[],this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perObjectEdgeIndexBaseOffsets=[],this.perTriangleNumberPortionId8Bits=[],this.perTriangleNumberPortionId16Bits=[],this.perTriangleNumberPortionId32Bits=[],this.perEdgeNumberPortionId8Bits=[],this.perEdgeNumberPortionId16Bits=[],this.perEdgeNumberPortionId32Bits=[]}}
/**
   * @author https://github.com/tmarti, with support from https://tribia.com/
   * @license MIT
   * 
   * This file takes a geometry given by { positions, indices }, and returns
   * equivalent { positions, indices } arrays but which only contain unique
   * positions.
   * 
   * The time is O(N logN) with the number of positions due to a pre-sorting
   * step, but is much more GC-friendly and actually faster than the classic O(N)
   * approach based in keeping a hash-based LUT to identify unique positions.
   */let ei=null;function ti(e,t){let i;for(let s=0;s<3;s++)if(0!=(i=ei[3*e+s]-ei[3*t+s]))return i;return 0}let ii=null;function si(e){let t=e.positions,i=e.indices,s=e.edgeIndices;!function(e){if(!(null!==ii&&ii.length>=e)){ii=new Uint32Array(e);for(let t=0;t<e;t++)ii[t]=t}}(t.length/3);let r=ii.slice(0,t.length/3),o=ii.slice(0,t.length/3);ei=t,r.sort(ti);let n=0;o[r[0]]=0;for(let e=1,t=r.length;e<t;e++)0!=ti(r[e],r[e-1])&&n++,o[r[e]]=n;const a=new Uint16Array(3*(n+1));n=0,a[3*n+0]=t[3*r[0]+0],a[3*n+1]=t[3*r[0]+1],a[3*n+2]=t[3*r[0]+2];for(let e=1,i=r.length;e<i;e++)0!=ti(r[e],r[e-1])&&(n++,a[3*n+0]=t[3*r[e]+0],a[3*n+1]=t[3*r[e]+1],a[3*n+2]=t[3*r[e]+2]),o[r[e]]=n;ei=null;let l=new Uint32Array(i.length);for(let e=0,t=i.length;e<t;e++)l[e]=o[i[e]];let h=new Uint32Array(s.length);for(let e=0,t=s.length;e<t;e++)h[e]=o[s[e]];return[a,l,h]}
/**
   * @author https://github.com/tmarti, with support from https://tribia.com/
   * @license MIT
   **/let ri=null;function oi(e,t){let i,s,r,o,n,a,l=3*e,h=3*t;const c=Math.min(i=ri[l],s=ri[l+1],r=ri[l+2]),u=Math.min(o=ri[h],n=ri[h+1],a=ri[h+2]);if(c!=u)return c-u;const d=Math.max(i,s,r),p=Math.max(o,n,a);return d!=p?d-p:0}let ni=null;function ai(e,t){let i=ni[2*e]-ni[2*t];return 0!=i?i:ni[2*e+1]-ni[2*t+1]}function li(e,t,i=!1){const s=e.positions||[],r=function(e,t){let i=new Int32Array(e.length/3);for(let e=0,t=i.length;e<t;e++)i[e]=e;ri=new Int32Array(e.length);for(let i=0,s=e.length;i<s;i++)ri[i]=e[i]>>t;i.sort(oi);const s=new Int32Array(e.length);for(let t=0,r=i.length;t<r;t++)s[3*t+0]=e[3*i[t]+0],s[3*t+1]=e[3*i[t]+1],s[3*t+2]=e[3*i[t]+2];return s}(e.indices||[],t),o=function(e){if(0==(e||[]).length)return[];let t=new Int32Array(e.length/2);for(let e=0,i=t.length;e<i;e++)t[e]=e;for(let t=0,i=e.length;t<i;t+=2)if(e[t]>e[t+1]){let i=e[t];e[t]=e[t+1],e[t+1]=i}ni=new Int32Array(e),t.sort(ai);const i=new Int32Array(e.length);for(let s=0,r=t.length;s<r;s++)i[2*s+0]=e[2*t[s]+0],i[2*s+1]=e[2*t[s]+1];return i}(e.edgeIndices||[]);function n(e,t){if(e>t){let i=e;e=t,t=i}function i(i,s){return i!=e?e-i:s!=t?t-s:0}for(var s=0,r=(o.length>>1)-1;s<=r;){var n=r+s>>1,a=i(o[2*n],o[2*n+1]);if(a>0)s=n+1;else{if(!(a<0))return n;r=n-1}}return-s-1}const a=new Int32Array(o.length/2);a.fill(0);const l=s.length/3;if(l>8*(1<<t))return[e];const h=new Int32Array(l);h.fill(-1);const c=[];function u(){h.fill(-1);let e={positions:[],indices:[],edgeIndices:[],maxNumPositions:(1<<t)-t,numPositions:0,bucketNumber:c.length};return c.push(e),e}let d=u();for(let t=0,i=r.length;t<i;t+=3){let i=0;const l=r[t],c=r[t+1],p=r[t+2];if(-1==h[l]&&i++,-1==h[c]&&i++,-1==h[p]&&i++,i+d.numPositions>d.maxNumPositions&&(d=u()),d.bucketNumber>8)return[e];let f;-1==h[l]&&(h[l]=d.numPositions++,d.positions.push(s[3*l]),d.positions.push(s[3*l+1]),d.positions.push(s[3*l+2])),-1==h[c]&&(h[c]=d.numPositions++,d.positions.push(s[3*c]),d.positions.push(s[3*c+1]),d.positions.push(s[3*c+2])),-1==h[p]&&(h[p]=d.numPositions++,d.positions.push(s[3*p]),d.positions.push(s[3*p+1]),d.positions.push(s[3*p+2])),d.indices.push(h[l]),d.indices.push(h[c]),d.indices.push(h[p]),(f=n(l,c))>=0&&0==a[f]&&(a[f]=1,d.edgeIndices.push(h[o[2*f]]),d.edgeIndices.push(h[o[2*f+1]])),(f=n(l,p))>=0&&0==a[f]&&(a[f]=1,d.edgeIndices.push(h[o[2*f]]),d.edgeIndices.push(h[o[2*f+1]])),(f=n(c,p))>=0&&0==a[f]&&(a[f]=1,d.edgeIndices.push(h[o[2*f]]),d.edgeIndices.push(h[o[2*f+1]]))}const p=t/8*2,f=t/8,m=2*s.length+(r.length+o.length)*p;let g=0,_=-s.length/3;return c.forEach((e=>{g+=2*e.positions.length+(e.indices.length+e.edgeIndices.length)*f,_+=e.positions.length/3})),g>m?[e]:(i&&function(e,t){const i={};let s=0;e.forEach((e=>{let t=e.indices,r=e.edgeIndices,o=e.positions;for(var n=0,a=t.length;n<a;n+=3){var l=o[3*t[n]]+"_"+o[3*t[n]+1]+"_"+o[3*t[n]+2]+"/"+o[3*t[n+1]]+"_"+o[3*t[n+1]+1]+"_"+o[3*t[n+1]+2]+"/"+o[3*t[n+2]]+"_"+o[3*t[n+2]+1]+"_"+o[3*t[n+2]+2];i[l]=!0}s+=e.edgeIndices.length/2;for(n=0,a=r.length;n<a;n+=2)l=o[3*r[n]]+"_"+o[3*r[n]+1]+"_"+o[3*r[n]+2]+"/"+o[3*r[n+1]]+"_"+o[3*r[n+1]+1]+"_"+o[3*r[n+1]+2]+"/"}));{let e=t.indices;t.edgeIndices;let s=t.positions;for(var r=0,o=e.length;r<o;r+=3){var n=s[3*e[r]]+"_"+s[3*e[r]+1]+"_"+s[3*e[r]+2]+"/"+s[3*e[r+1]]+"_"+s[3*e[r+1]+1]+"_"+s[3*e[r+1]+2]+"/"+s[3*e[r+2]]+"_"+s[3*e[r+2]+1]+"_"+s[3*e[r+2]+2];if(!(n in i))throw console.log("Not found "+n),"Ohhhh!"}}}(c,e),c)}const hi={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTextureEdgeIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalPolygons:0,totalPolygons8Bits:0,totalPolygons16Bits:0,totalPolygons32Bits:0,totalEdges:0,totalEdges8Bits:0,totalEdges16Bits:0,totalEdges32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(hi,null,4));let e=0;Object.keys(hi).forEach((t=>{t.startsWith("size")&&(e+=hi[t])})),console.log(`Total size ${e} bytes (${(e/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(e/hi.totalPolygons).toFixed(2)}`);let t={};Object.keys(hi).forEach((i=>{i.startsWith("size")&&(t[i]=`${(hi[i]/e*100).toFixed(2)} % of total`)})),console.log(JSON.stringify({percentualRamUsage:t},null,4))};class ci{constructor(e,t,i,s,r=null){this._gl=e,this._texture=t,this._textureWidth=i,this._textureHeight=s,this._textureData=r}bindTexture(e,t,i){return e.bindTexture(t,this,i)}bind(e){return this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),!0}unbind(e){}}class ui{constructor(){this.texturePerObjectIdColorsAndFlags=null,this.texturePerObjectIdOffsets=null,this.texturePerObjectIdPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerPolygonIdPortionIds8Bits=null,this.texturePerPolygonIdPortionIds16Bits=null,this.texturePerPolygonIdPortionIds32Bits=null,this.texturePerEdgeIdPortionIds8Bits=null,this.texturePerEdgeIdPortionIds16Bits=null,this.texturePerEdgeIdPortionIds32Bits=null,this.texturePerPolygonIdIndices8Bits=null,this.texturePerPolygonIdIndices16Bits=null,this.texturePerPolygonIdIndices32Bits=null,this.texturePerPolygonIdEdgeIndices8Bits=null,this.texturePerPolygonIdEdgeIndices16Bits=null,this.texturePerPolygonIdEdgeIndices32Bits=null,this.textureCameraMatrices=null,this.texturePickCameraMatrices=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerPolygonIdIndices8Bits,16:this.texturePerPolygonIdIndices16Bits,32:this.texturePerPolygonIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerPolygonIdPortionIds8Bits,16:this.texturePerPolygonIdPortionIds16Bits,32:this.texturePerPolygonIdPortionIds32Bits},this.edgeIndicesPerBitnessTextures={8:this.texturePerPolygonIdEdgeIndices8Bits,16:this.texturePerPolygonIdEdgeIndices16Bits,32:this.texturePerPolygonIdEdgeIndices32Bits},this.edgeIndicesPortionIdsPerBitnessTextures={8:this.texturePerEdgeIdPortionIds8Bits,16:this.texturePerEdgeIdPortionIds16Bits,32:this.texturePerEdgeIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,r,o,n){this.texturePerObjectIdPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectIdColorsAndFlags.bindTexture(e,s,3),this.textureCameraMatrices.bindTexture(e,r,4),this.textureModelMatrices.bindTexture(e,o,5),this.texturePerObjectIdOffsets.bindTexture(e,n,6)}bindPickCameraTexture(e,t){this.texturePickCameraMatrices.bindTexture(e,t,4)}bindTriangleIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,7),this.indicesPerBitnessTextures[s].bindTexture(e,i,8)}bindEdgeIndicesTextures(e,t,i,s){this.edgeIndicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,7),this.edgeIndicesPerBitnessTextures[s].bindTexture(e,i,8)}}class di{disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}generateCameraDataTexture(e,t,i,s,r=!0){const o=e.createTexture();e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,4,3),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null);const n=new ci(e,o,4,3);let a=!0;if(n._updateViewMatrix=(i,r)=>{e.bindTexture(e.TEXTURE_2D,n._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,4,1,e.RGBA,e.FLOAT,new Float32Array(s?G(i,s):i)),e.texSubImage2D(e.TEXTURE_2D,0,0,1,4,1,e.RGBA,e.FLOAT,new Float32Array(t.viewNormalMatrix)),e.texSubImage2D(e.TEXTURE_2D,0,0,2,4,1,e.RGBA,e.FLOAT,new Float32Array(r))},r){const e=()=>{a&&(a=!1,n._updateViewMatrix(t.viewMatrix,t.project.matrix))};t.on("matrix",(()=>a=!0)),i.on("rendering",e),e()}return n}generatePeformanceModelDataTexture(e,t){const i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,4,2),e.texSubImage2D(e.TEXTURE_2D,0,0,0,4,1,e.RGBA,e.FLOAT,new Float32Array(t.worldMatrix)),e.texSubImage2D(e.TEXTURE_2D,0,0,1,4,1,e.RGBA,e.FLOAT,new Float32Array(t.worldNormalMatrix)),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,i,4,2)}generateTextureForColorsAndFlags(e,t,i,s,r,o,n){const a=t.length;this.numPortions=a;const l=4096,h=Math.ceil(a/512);if(0==h)throw"texture height == 0";const c=new Uint8Array(16384*h);hi.sizeDataColorsAndFlags+=c.byteLength,hi.numberOfTextures++;for(let e=0;e<a;e++)c.set(t[e],32*e+0),c.set(i[e],32*e+4),c.set([0,0,0,0],32*e+8),c.set([0,0,0,0],32*e+12),c.set([s[e]>>24&255,s[e]>>16&255,s[e]>>8&255,255&s[e]],32*e+16),c.set([r[e]>>24&255,r[e]>>16&255,r[e]>>8&255,255&r[e]],32*e+20),c.set([o[e]>>24&255,o[e]>>16&255,o[e]>>8&255,255&o[e]],32*e+24),c.set([n[e]?1:0,0,0,0],32*e+28);const u=e.createTexture();return e.bindTexture(e.TEXTURE_2D,u),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,l,h),e.texSubImage2D(e.TEXTURE_2D,0,0,0,l,h,e.RGBA_INTEGER,e.UNSIGNED_BYTE,c,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new ci(e,u,l,h,c)}generateTextureForObjectOffsets(e,t){const i=512,s=Math.ceil(t/i);if(0==s)throw"texture height == 0";var r=new Float32Array(1536*s).fill(0);hi.sizeDataTextureOffsets+=r.byteLength,hi.numberOfTextures++;const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RGB,e.FLOAT,r,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s,r)}generateTextureForPositionsDecodeMatrices(e,t,i){const s=t.length;if(0==s)throw"num decode+entity matrices == 0";const r=4096,o=Math.ceil(s/512);var n=new Float32Array(16384*o);hi.sizeDataPositionDecodeMatrices+=n.byteLength,hi.numberOfTextures++;for(var a=0;a<t.length;a++)n.set(t[a],32*a),n.set(i[a],32*a+16);const l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,r,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,o,e.RGBA,e.FLOAT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new ci(e,l,r,o)}generateTextureFor8BitIndices(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=4096,s=Math.ceil(t.length/3/i);if(0==s)throw"texture height == 0";const r=new Uint8Array(i*s*3);hi.sizeDataTextureIndices+=r.byteLength,hi.numberOfTextures++,r.fill(0),r.set(t,0);const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RGB_INTEGER,e.UNSIGNED_BYTE,r,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s)}generateTextureFor16BitIndices(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=4096,s=Math.ceil(t.length/3/i);if(0==s)throw"texture height == 0";const r=new Uint16Array(i*s*3);hi.sizeDataTextureIndices+=r.byteLength,hi.numberOfTextures++,r.fill(0),r.set(t,0);const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RGB_INTEGER,e.UNSIGNED_SHORT,r,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s)}generateTextureFor32BitIndices(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=4096,s=Math.ceil(t.length/3/i);if(0==s)throw"texture height == 0";const r=new Uint32Array(i*s*3);hi.sizeDataTextureIndices+=r.byteLength,hi.numberOfTextures++,r.fill(0),r.set(t,0);const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RGB_INTEGER,e.UNSIGNED_INT,r,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s)}generateTextureFor8BitsEdgeIndices(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=4096,s=Math.ceil(t.length/2/i);if(0==s)throw"texture height == 0";const r=new Uint8Array(i*s*2);hi.sizeDataTextureEdgeIndices+=r.byteLength,hi.numberOfTextures++,r.fill(0),r.set(t,0);const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RG_INTEGER,e.UNSIGNED_BYTE,r,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s)}generateTextureFor16BitsEdgeIndices(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=4096,s=Math.ceil(t.length/2/i);if(0==s)throw"texture height == 0";const r=new Uint16Array(i*s*2);hi.sizeDataTextureEdgeIndices+=r.byteLength,hi.numberOfTextures++,r.fill(0),r.set(t,0);const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RG_INTEGER,e.UNSIGNED_SHORT,r,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s)}generateTextureFor32BitsEdgeIndices(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=4096,s=Math.ceil(t.length/2/i);if(0==s)throw"texture height == 0";const r=new Uint32Array(i*s*2);hi.sizeDataTextureEdgeIndices+=r.byteLength,hi.numberOfTextures++,r.fill(0),r.set(t,0);const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RG_INTEGER,e.UNSIGNED_INT,r,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new ci(e,o,i,s)}generateTextureForPositions(e,t){const i=t.length/3,s=4096,r=Math.ceil(i/s);if(0==r)throw"texture height == 0";const o=new Uint16Array(s*r*3);hi.sizeDataTexturePositions+=o.byteLength,hi.numberOfTextures++,o.fill(0),o.set(t,0);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_SHORT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new ci(e,n,s,r)}generateTextureForPackedPortionIds(e,t){if(0==t.length)return{texture:null,textureHeight:0};const i=t.length,s=4096,r=Math.ceil(i/s);if(0==r)throw"texture height == 0";const o=new Uint16Array(s*r);o.set(t,0),hi.sizeDataTexturePortionIds+=o.byteLength,hi.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RED_INTEGER,e.UNSIGNED_SHORT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new ci(e,n,s,r)}}const pi=p.identityMat4();p.mat4(),p.mat4();const fi=p.vec4([0,0,0,1]),mi=p.vec4([0,0,0,1]),gi=p.vec4([0,0,0,1]),_i=p.OBB3(),vi=new Uint8Array(4),bi=new Float32Array(3),xi=p.vec3(),yi=p.vec3(),Pi=p.vec3(),wi=p.vec3(),Mi=p.vec3(),Ci=p.vec3(),Ei=p.vec3();let Ai=0;class Di{constructor(e,t){this._layerNumber=Ai++,hi.numberOfLayers++,this.sortId=`TrianglesDataTextureLayer-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._dataTextureRenderers=function(e){const t=e.id;let i=Qt[t];return i||(i=new Kt(e),Qt[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Qt[t],i._destroy()}))),i}(e.scene),this.model=e,this._buffer=new Jt,this._dataTextureState=new ui,this.dataTextureGenerator=new di,this._state=new Ke({metallicRoughnessBuf:null,positionsDecodeMatrix:p.mat4(),textureState:this._dataTextureState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=p.collapseAABB3(),this._portions=[],this._finalized=!1,this._subPortionIdMapping=[],this._instancedGeometrySubPortionData={},this.aabb=p.collapseAABB3()}canCreatePortion(e,t=null){if(this._finalized)throw"Already finalized";const i=this._state,s=e.preparedBuckets.length;this._numPortions+s>65536&&hi.cannotCreatePortion.because10BitsObjectId++;let r=this._numPortions+s<=65536;if(!(null!==t&&t+"#0"in this._instancedGeometrySubPortionData)){const t=Math.max(i.numIndices8Bits,i.numIndices16Bits,i.numIndices32Bits);let s=0,o=e.indices.length/3;e.preparedBuckets.forEach((e=>{s+=e.positions.length/3})),(i.numVertices+s>16777216||t+o>16777216)&&hi.cannotCreatePortion.becauseTextureSize++,r&&=i.numVertices+s<=16777216&&t+o<=16777216}return r}createPortion(e,t=null){if(this._finalized)throw"Already finalized";const i=null!==t;let s=this._subPortionIdMapping.length;const r=[];this._subPortionIdMapping.push(r);const o=i?t.aabb:e.aabb;return e.preparedBuckets.forEach(((s,n)=>{let a;if(i){const t=e.id+"#"+n;t in this._instancedGeometrySubPortionData||(this._instancedGeometrySubPortionData[t]=this.createSubPortionGeometry(s)),a=this._instancedGeometrySubPortionData[t]}else a=this.createSubPortionGeometry(s);const l=p.collapseAABB3(),h=this.createSubPortionObject(i?t:e,a,s.positions,e.positionsDecodeMatrix,i?t.origin:e.origin,l,i,e.solid);p.expandAABB3(o,l),r.push(h)})),this.model.numPortions++,s}createSubPortionGeometry(e){const t=this._state;if(e.indices){const t=8*Math.ceil(e.indices.length/3/8)*3;hi.overheadSizeAlignementIndices+=2*(t-e.indices.length);const i=new Uint32Array(t);i.fill(0),i.set(e.indices),e.indices=i}if(e.edgeIndices){const t=8*Math.ceil(e.edgeIndices.length/2/8)*2;hi.overheadSizeAlignementEdgeIndices+=2*(t-e.edgeIndices.length);const i=new Uint32Array(t);i.fill(0),i.set(e.edgeIndices),e.edgeIndices=i}const i=e.positions,s=e.indices,r=e.edgeIndices,o=this._buffer,n=o.positions.length/3,a=i.length/3;for(let e=0,t=i.length;e<t;e++)o.positions.push(i[e]);let l,h,c=0;if(s){let e;c=s.length/3,e=a<=256?o.indices8Bits:a<=65536?o.indices16Bits:o.indices32Bits,l=e.length/3;for(let t=0,i=s.length;t<i;t++)e.push(s[t])}let u=0;if(r){let e;u=r.length/2,e=a<=256?o.edgeIndices8Bits:a<=65536?o.edgeIndices16Bits:o.edgeIndices32Bits,h=e.length/2;for(let t=0,i=r.length;t<i;t++)e.push(r[t])}return t.numVertices+=a,hi.numberOfGeometries++,{vertexBase:n,numVertices:a,numTriangles:c,numEdges:u,indicesBase:l,edgeIndicesBase:h}}createSubPortionObject(e,t,i,s,r,o,n,a){const l=e.color;e.metallic,e.roughness;const h=e.colors,c=e.opacity,u=e.meshMatrix,d=e.worldMatrix,f=e.pickColor;this.model.scene;const m=this._buffer,g=this._state;if(m.perObjectPositionsDecodeMatrices.push(s),n?m.perObjectInstancePositioningMatrices.push(u):m.perObjectInstancePositioningMatrices.push(pi),n){const e=p.collapseAABB3();p.expandAABB3Points3(e,i),rt.decompressAABB(e,s);const t=p.AABB3ToOBB3(e);for(let e=0,i=t.length;e<i;e+=4)fi[0]=t[e+0],fi[1]=t[e+1],fi[2]=t[e+2],p.transformPoint4(u,fi,mi),d?(p.transformPoint4(d,mi,gi),p.expandAABB3Point3(o,gi)):p.expandAABB3Point3(o,mi)}else if(s){const e=rt.getPositionsBounds(i),t=rt.decompressPosition(e.min,s,[]),r=rt.decompressPosition(e.max,s,[]);o[0]=t[0],o[1]=t[1],o[2]=t[2],o[3]=r[0],o[4]=r[1],o[5]=r[2],d&&(p.AABB3ToOBB3(o,_i),p.transformOBB3(d,_i),p.OBB3ToAABB3(_i,o))}else if(u)for(let e=0,t=i.length;e<t;e+=3)fi[0]=i[e+0],fi[1]=i[e+1],fi[2]=i[e+2],p.transformPoint4(u,fi,mi),i[e+0]=mi[0],i[e+1]=mi[1],i[e+2]=mi[2],p.expandAABB3Point3(this._modelAABB,mi),d?(p.transformPoint4(d,mi,gi),p.expandAABB3Point3(o,gi)):p.expandAABB3Point3(o,mi);else for(let e=0,t=i.length;e<t;e+=3)fi[0]=i[e+0],fi[1]=i[e+1],fi[2]=i[e+2],p.expandAABB3Point3(this._modelAABB,fi),d?(p.transformPoint4(d,fi,mi),p.expandAABB3Point3(o,mi)):p.expandAABB3Point3(o,fi);r&&(this._state.origin=r,o[0]+=r[0],o[1]+=r[1],o[2]+=r[2],o[3]+=r[0],o[4]+=r[1],o[5]+=r[2]),p.expandAABB3(this.aabb,o),m.perObjectSolid.push(a),h?m.perObjectColors.push([255*h[0],255*h[1],255*h[2],255]):l&&m.perObjectColors.push([l[0],l[1],l[2],c]),m.perObjectPickColors.push(f),m.perObjectVertexBases.push(t.vertexBase);{let e;e=t.numVertices<=256?g.numIndices8Bits:t.numVertices<=65536?g.numIndices16Bits:g.numIndices32Bits,m.perObjectIndexBaseOffsets.push(e/3-t.indicesBase)}{let e;e=t.numVertices<=256?g.numEdgeIndices8Bits:t.numVertices<=65536?g.numEdgeIndices16Bits:g.numEdgeIndices32Bits,m.perObjectEdgeIndexBaseOffsets.push(e/2-t.edgeIndicesBase)}const _=this._portions.length;if(t.numTriangles>0){let e,i=3*t.numTriangles;t.numVertices<=256?(e=m.perTriangleNumberPortionId8Bits,g.numIndices8Bits+=i,hi.totalPolygons8Bits+=t.numTriangles):t.numVertices<=65536?(e=m.perTriangleNumberPortionId16Bits,g.numIndices16Bits+=i,hi.totalPolygons16Bits+=t.numTriangles):(e=m.perTriangleNumberPortionId32Bits,g.numIndices32Bits+=i,hi.totalPolygons32Bits+=t.numTriangles),hi.totalPolygons+=t.numTriangles;for(let i=0;i<t.numTriangles;i+=8)e.push(_)}if(t.numEdges>0){let e,i=2*t.numEdges;t.numVertices<=256?(e=m.perEdgeNumberPortionId8Bits,g.numEdgeIndices8Bits+=i,hi.totalEdges8Bits+=t.numEdges):t.numVertices<=65536?(e=m.perEdgeNumberPortionId16Bits,g.numEdgeIndices16Bits+=i,hi.totalEdges16Bits+=t.numEdges):(e=m.perEdgeNumberPortionId32Bits,g.numEdgeIndices32Bits+=i,hi.totalEdges32Bits+=t.numEdges),hi.totalEdges+=t.numEdges;for(let i=0;i<t.numEdges;i+=8)e.push(_)}return m.perObjectOffsets.push([0,0,0]),this._portions.push({numVerts:t.numTriangles}),this._numPortions++,hi.numberOfPortions++,_}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this._dataTextureState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectIdColorsAndFlags=this.dataTextureGenerator.generateTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectEdgeIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectIdOffsets=this.dataTextureGenerator.generateTextureForObjectOffsets(i,this._numPortions),t.texturePerObjectIdPositionsDecodeMatrix=this.dataTextureGenerator.generateTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices,s.perObjectInstancePositioningMatrices),t.texturePerVertexIdCoordinates=this.dataTextureGenerator.generateTextureForPositions(i,s.positions),t.texturePerPolygonIdPortionIds8Bits=this.dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perTriangleNumberPortionId8Bits),t.texturePerPolygonIdPortionIds16Bits=this.dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perTriangleNumberPortionId16Bits),t.texturePerPolygonIdPortionIds32Bits=this.dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perTriangleNumberPortionId32Bits),s.perEdgeNumberPortionId8Bits.length>0&&(t.texturePerEdgeIdPortionIds8Bits=this.dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perEdgeNumberPortionId8Bits)),s.perEdgeNumberPortionId16Bits.length>0&&(t.texturePerEdgeIdPortionIds16Bits=this.dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perEdgeNumberPortionId16Bits)),s.perEdgeNumberPortionId32Bits.length>0&&(t.texturePerEdgeIdPortionIds32Bits=this.dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perEdgeNumberPortionId32Bits)),s.indices8Bits.length>0&&(t.texturePerPolygonIdIndices8Bits=this.dataTextureGenerator.generateTextureFor8BitIndices(i,s.indices8Bits)),s.indices16Bits.length>0&&(t.texturePerPolygonIdIndices16Bits=this.dataTextureGenerator.generateTextureFor16BitIndices(i,s.indices16Bits)),s.indices32Bits.length>0&&(t.texturePerPolygonIdIndices32Bits=this.dataTextureGenerator.generateTextureFor32BitIndices(i,s.indices32Bits)),s.edgeIndices8Bits.length>0&&(t.texturePerPolygonIdEdgeIndices8Bits=this.dataTextureGenerator.generateTextureFor8BitsEdgeIndices(i,s.edgeIndices8Bits)),s.edgeIndices16Bits.length>0&&(t.texturePerPolygonIdEdgeIndices16Bits=this.dataTextureGenerator.generateTextureFor16BitsEdgeIndices(i,s.edgeIndices16Bits)),s.edgeIndices32Bits.length>0&&(t.texturePerPolygonIdEdgeIndices32Bits=this.dataTextureGenerator.generateTextureFor32BitsEdgeIndices(i,s.edgeIndices32Bits)),this.model._modelMatricesTexture||(this.model._modelMatricesTexture=this.dataTextureGenerator.generatePeformanceModelDataTexture(i,this.model)),t.textureModelMatrices=this.model._modelMatricesTexture,this.model.cameraTexture||(this.model.cameraTexture=this.dataTextureGenerator.generateCameraDataTexture(this.model.scene.canvas.gl,this.model.scene.camera,this.model.scene,this._state.origin.slice())),t.textureCameraMatrices=this.model.cameraTexture,this.model.pickCameraTexture||(this.model.pickCameraTexture=this.dataTextureGenerator.generateCameraDataTexture(this.model.scene.canvas.gl,this.model.scene.camera,this.model.scene,this._state.origin.slice(),!1)),t.texturePickCameraMatrices=this.model.pickCameraTexture,t.finalize(),this._buffer=null,this._instancedGeometrySubPortionData={},this._finalized=!0}isEmpty(){return 0==this._numPortions}initFlags(e,t,i){t&Ee&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&Fe&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&Ie&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&Le&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&Te&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Be&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&De&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&Ae&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&Ee?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&Fe?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&Ie?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&Le?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Be?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&Te?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}beginDeferredFlags(){this._deferredSetFlagsActive=!0}commitDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dataTextureState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectIdColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectIdColorsAndFlags._textureWidth,t.texturePerObjectIdColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectIdColorsAndFlags._textureData),e.bindTexture(e.TEXTURE_2D,t.texturePerObjectIdOffsets._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectIdOffsets._textureWidth,t.texturePerObjectIdOffsets._textureHeight,e.RGB,e.FLOAT,t.texturePerObjectIdOffsets._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&Ae?(this._numCulledLayerPortions+=this._subPortionIdMapping[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._subPortionIdMapping[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&De?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._subPortionIdMapping[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetColor(i[e],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;vi[0]=t[0],vi[1]=t[1],vi[2]=t[2],vi[3]=t[3],i.texturePerObjectIdColorsAndFlags._textureData.set(vi,32*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(s.bindTexture(s.TEXTURE_2D,i.texturePerObjectIdColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,vi))}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const r=this._subPortionIdMapping[e];for(let e=0,s=r.length;e<s;e++)this._subPortionSetFlags(r[e],t,i)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=!!(t&Ee),o=!!(t&Ie),n=!!(t&Fe),a=!!(t&Le),l=!!(t&Ae);let h,c;h=!r||l||o?Ne:i?Ve:je,c=!r||l?Ne:a?Ue:n?ze:o?Ge:Ne;let u=0;u=!r||l?Ne:a?Ye:n?Xe:o?qe:!!(t&Be)?i?He:We:Ne;let d=r&&!l&&!!(t&De)?$e:Ne;const p=this._dataTextureState,f=this.model.scene.canvas.gl;vi[0]=h,vi[1]=c,vi[2]=u,vi[3]=d,p.texturePerObjectIdColorsAndFlags._textureData.set(vi,32*e+8),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(f.bindTexture(f.TEXTURE_2D,p.texturePerObjectIdColorsAndFlags._texture),f.texSubImage2D(f.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,f.RGBA_INTEGER,f.UNSIGNED_BYTE,vi))}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._subPortionIdMapping[e];for(let e=0,i=s.length;e<i;e++)this._subPortionSetFlags2(s[e],t)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&Te?255:0,r=this._dataTextureState,o=this.model.scene.canvas.gl;vi[0]=s,vi[1]=0,vi[2]=1,vi[3]=2,r.texturePerObjectIdColorsAndFlags._textureData.set(vi,32*e+12),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(o.bindTexture(o.TEXTURE_2D,r.texturePerObjectIdColorsAndFlags._texture),o.texSubImage2D(o.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,o.RGBA_INTEGER,o.UNSIGNED_BYTE,vi))}_setDeferredFlags2(){}setOffset(e,t){const i=this._subPortionIdMapping[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetOffset(i[e],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;bi[0]=t[0],bi[1]=t[1],bi[2]=t[2],i.texturePerObjectIdOffsets._textureData.set(bi,3*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(s.bindTexture(s.TEXTURE_2D,i.texturePerObjectIdOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,bi))}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled?this._dataTextureRenderers.colorQualityRendererWithSAO&&this._dataTextureRenderers.colorQualityRendererWithSAO.drawLayer(t,this,je):this._dataTextureRenderers.colorRendererWithSAO&&this._dataTextureRenderers.colorRendererWithSAO.drawLayer(t,this,je):t.pbrEnabled&&this.model.pbrEnabled?this._dataTextureRenderers.colorQualityRenderer&&this._dataTextureRenderers.colorQualityRenderer.drawLayer(t,this,je):this._dataTextureRenderers.colorRenderer&&this._dataTextureRenderers.colorRenderer.drawLayer(t,this,je))}_updateBackfaceCull(e,t){const i=this.model.backfaces||e.sectioned;if(t.backfaces!==i){const e=t.gl;i?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled?this._dataTextureRenderers.colorQualityRenderer&&this._dataTextureRenderers.colorQualityRenderer.drawLayer(t,this,Ve):this._dataTextureRenderers.colorRenderer&&this._dataTextureRenderers.colorRenderer.drawLayer(t,this,Ve))}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.depthRenderer&&this._dataTextureRenderers.depthRenderer.drawLayer(t,this,je))}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.normalsRenderer&&this._dataTextureRenderers.normalsRenderer.drawLayer(t,this,je))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.silhouetteRenderer&&this._dataTextureRenderers.silhouetteRenderer.drawLayer(t,this,Ge))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.silhouetteRenderer&&this._dataTextureRenderers.silhouetteRenderer.drawLayer(t,this,ze))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.silhouetteRenderer&&this._dataTextureRenderers.silhouetteRenderer.drawLayer(t,this,Ue))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._dataTextureRenderers.edgesColorRenderer&&this._dataTextureRenderers.edgesColorRenderer.drawLayer(t,this,We)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._dataTextureRenderers.edgesColorRenderer&&this._dataTextureRenderers.edgesColorRenderer.drawLayer(t,this,He)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._dataTextureRenderers.edgesRenderer&&this._dataTextureRenderers.edgesRenderer.drawLayer(t,this,Xe)}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._dataTextureRenderers.edgesRenderer&&this._dataTextureRenderers.edgesRenderer.drawLayer(t,this,Ye)}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._dataTextureRenderers.edgesRenderer&&this._dataTextureRenderers.edgesRenderer.drawLayer(t,this,qe)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.occlusionRenderer&&this._dataTextureRenderers.occlusionRenderer.drawLayer(t,this,je))}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.shadowRenderer&&this._dataTextureRenderers.shadowRenderer.drawLayer(t,this,je))}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.pickMeshRenderer&&this._dataTextureRenderers.pickMeshRenderer.drawLayer(t,this,$e))}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.pickDepthRenderer&&this._dataTextureRenderers.pickDepthRenderer.drawLayer(t,this,$e))}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._dataTextureRenderers.pickNormalsRenderer&&this._dataTextureRenderers.pickNormalsRenderer.drawLayer(t,this,$e))}precisionRayPickSurface(e,t,i,s,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const o=this._state,n=this._portions[e];if(!n)return this.model.error("portion not found: "+e),!1;const a=n.quantizedPositions,l=n.indices,h=o.origin,c=n.offset,u=xi,d=yi;u.set(h?p.subVec3(t,h,Pi):t),d.set(i),c&&p.subVec3(u,c),p.transformRay(this.model.worldNormalMatrix,u,d,u,d);const f=wi,m=Mi,g=Ci;let _=!1,v=0;const b=Ei;for(let e=0,i=l.length;e<i;e+=3){const i=3*l[e],n=3*l[e+1],x=3*l[e+2];if(f[0]=a[i],f[1]=a[i+1],f[2]=a[i+2],m[0]=a[n],m[1]=a[n+1],m[2]=a[n+2],g[0]=a[x],g[1]=a[x+1],g[2]=a[x+2],p.decompressPosition(f,o.positionsDecodeMatrix),p.decompressPosition(m,o.positionsDecodeMatrix),p.decompressPosition(g,o.positionsDecodeMatrix),p.rayTriangleIntersect(u,d,f,m,g,b)){p.transformPoint3(this.model.worldMatrix,b,b),c&&p.addVec3(b,c),h&&p.addVec3(b,h);const e=Math.abs(p.lenVec3(p.subVec3(b,t,[])));(!_||e>v)&&(v=e,s.set(b),r&&p.triangleNormal(f,m,g,r),_=!0)}}return _&&r&&(p.transformVec3(this.model.worldNormalMatrix,r,r),p.normalizeVec3(r)),_}destroy(){const e=this._state;e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.destroy()}}class Ti{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}let Si=!1;const Ii=[];class Fi{constructor(e,t){this.triangleLODLevels=e,this.nodesInLOD={},this.triangleCountInLOD={},this.targetFps=t,this.lodLevelIndex=0,this.consecutiveFramesWithTargetFps=0,this.consecutiveFramesWithoutTargetFps=0}initializeLodState(e){if(0==e._nodeList.length)return;const t=e._nodeList;let i={},s={};for(let e=0,o=t.length;e<o;e++){const o=t[e];let n,a;for(n=0,a=this.triangleLODLevels.length;n<a&&!(o.numTriangles>=this.triangleLODLevels[n]);n++);var r=this.triangleLODLevels[n]||0;r in i||(i[r]=[]),i[r].push(o),r in s||(s[r]=0),s[r]+=o.numTriangles}this.nodesInLOD=i,this.triangleCountInLOD=s}}class Li{constructor(e,t,i){this.model=e,this.lodState=new Fi(t,i),console.time("initializeLodState"),this.lodState.initializeLodState(e),console.timeEnd("initializeLodState"),function(e,t){if(!Si){Si=!0;const t=4;let i=new Array(t),s=0,r=-1,o=Date.now(),n=0;e.on("rendering",(function(){if(-1!=r)for(let e=0,t=Ii.length;e<t;e++)Ii[e].applyLodCulling(r)})),e.on("rendered",(function(){o=Date.now(),window.requestAnimationFrame((function(){s++;const e=Date.now();n=e-o,o=e,i[s%t]=n;let a=0;if(s>t){for(let e=0;e<t;e++)a+=i[e];r=t/a*1e3}}))}));{let t=0,i=t;e.camera.on("matrix",(function(){i=t})),e.on("tick",(function(){if(t-i>3)for(let e=0,t=Ii.length;e<t;e++)Ii[e].resetLodCulling();t++}))}}Ii.push(t)}(this.model.scene,this)}_increaseLODLevelIndex(){const e=this.lodState;if(e.lodLevelIndex==e.triangleLODLevels.length)return!1;const t=e.nodesInLOD[e.triangleLODLevels[e.lodLevelIndex]]||[];for(let e=0,i=t.length;e<i;e++)t[e].culledLOD=!0;return e.lodLevelIndex++,!0}_decreaseLODLevelIndex(){const e=this.lodState;if(0==e.lodLevelIndex)return!1;const t=e.nodesInLOD[e.triangleLODLevels[e.lodLevelIndex-1]]||[];for(let e=0,i=t.length;e<i;e++)t[e].culledLOD=!1;return e.lodLevelIndex--,!0}applyLodCulling(e){let t=this.lodState;const i=this.model;i.beginDeferredFlagsInAllLayers();let s=!1;return e<t.targetFps?++t.consecutiveFramesWithoutTargetFps>0&&(t.consecutiveFramesWithoutTargetFps=0,s=this._increaseLODLevelIndex()):e>t.targetFps+4&&++t.consecutiveFramesWithTargetFps>1&&(t.consecutiveFramesWithTargetFps=0,s=this._decreaseLODLevelIndex()),i.commitDeferredFlagsInAllLayers(),s&&console.log("LOD level = "+t.lodLevelIndex),s}resetLodCulling(){const e=this.model;e.beginDeferredFlagsInAllLayers();let t=!1,i=!1;do{t|=i=this._decreaseLODLevelIndex()}while(i);return e.commitDeferredFlagsInAllLayers(),t&&console.log("LOD resetted"),t}}var Bi={},Ri={};!function(e){if("object"==typeof Ri&&void 0!==Bi)Bi.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).RBush3D=e()}}((function(){return function e(t,i,s){function r(n,a){if(!i[n]){if(!t[n]){var l="function"==typeof require&&require;if(!a&&l)return l(n,!0);if(o)return o(n,!0);var h=new Error("Cannot find module '"+n+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[n]={exports:{}};t[n][0].call(c.exports,(function(e){return r(t[n][1][e]||e)}),c,c.exports,e,t,i,s)}return i[n].exports}for(var o="function"==typeof require&&require,n=0;n<s.length;n++)r(s[n]);return r}({1:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var s=e("quickselect"),r=[],o=function(e){return r.push(e)},n=function(e){e&&(o(e),c(e)||e.children.forEach(n))},a=function(e){var t=r.pop();return t?(t.children=e,t.height=1,t.leaf=!0,t.minX=1/0,t.minY=1/0,t.minZ=1/0,t.maxX=-1/0,t.maxY=-1/0,t.maxZ=-1/0):t={children:e,height:1,leaf:!0,minX:1/0,minY:1/0,minZ:1/0,maxX:-1/0,maxY:-1/0,maxZ:-1/0},t},l=[],h=function(e,t){var i=l.pop();return i?(i.dist=e,i.node=t):i={dist:e,node:t},i},c=function(e){return e.leaf},u=function(e,t){return e.leaf},d=function(e,t,i){if(!i)return t.indexOf(e);for(var s=0;s<t.length;s++)if(i(e,t[s]))return s;return-1},p=function(e){f(e,0,e.children.length,e)},f=function(e,t,i,s){var r=s;r?(r.minX=1/0,r.minY=1/0,r.minZ=1/0,r.maxX=-1/0,r.maxY=-1/0,r.maxZ=-1/0):r=a([]);for(var o=t,n=void 0;o<i;o++)n=e.children[o],m(r,n);return r},m=function(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.minZ=Math.min(e.minZ,t.minZ),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e.maxZ=Math.max(e.maxZ,t.maxZ),e},g=function(e){return(e.maxX-e.minX)*(e.maxY-e.minY)*(e.maxZ-e.minZ)},_=function(e){return e.maxX-e.minX+(e.maxY-e.minY)+(e.maxZ-e.minZ)},v=function(e,t){var i=Math.min(e.minX,t.minX),s=Math.min(e.minY,t.minY),r=Math.min(e.minZ,t.minZ);return(Math.max(e.maxX,t.maxX)-i)*(Math.max(e.maxY,t.maxY)-s)*(Math.max(e.maxZ,t.maxZ)-r)},b=function(e,t){var i=Math.max(e.minX,t.minX),s=Math.max(e.minY,t.minY),r=Math.max(e.minZ,t.minZ),o=Math.min(e.maxX,t.maxX),n=Math.min(e.maxY,t.maxY),a=Math.min(e.maxZ,t.maxZ);return Math.max(0,o-i)*Math.max(0,n-s)*Math.max(0,a-r)},x=function(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&e.minZ<=t.minZ&&t.maxX<=e.maxX&&t.maxY<=e.maxY&&t.maxZ<=e.maxZ};i.intersects=function(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.minZ<=e.maxZ&&t.maxX>=e.minX&&t.maxY>=e.minY&&t.maxZ>=e.minZ},i.boxRayIntersects=function(e,t,i,s,r,o,n){var a=(e.minX-t)*r,l=(e.maxX-t)*r,h=(e.minY-i)*o,c=(e.maxY-i)*o,u=(e.minZ-s)*n,d=(e.maxZ-s)*n,p=Math.min(u,d),f=Math.max(u,d),m=Math.min(h,c),g=Math.max(h,c),_=Math.min(a,l),v=Math.max(a,l),b=Math.max(0,_,m,p);return Math.min(v,g,f)>=b?b:1/0};var y=function(e,t,i,r,o){for(var n,a=[t,i];a.length;)(i=a.pop())-(t=a.pop())<=r||(n=t+Math.ceil((i-t)/r/2)*r,s(e,n,t,i,o),a.push(t,n,n,i))},P=function(e,t){return e.minX-t.minX},w=function(e,t){return e.minY-t.minY},M=function(e,t){return e.minZ-t.minZ},C=function(){function e(e){void 0===e&&(e=16),this.maxEntries=Math.max(e,8),this.minEntries=Math.max(4,Math.ceil(.4*this.maxEntries)),this.clear()}return e.alloc=function(){return this.pool.pop()||new this},e.free=function(e){e.clear(),this.pool.push(e)},e.prototype.searchCustom=function(e,t){var i=this.data,s=[];if(!e(i,u(i)))return s;for(var r=[];i;){for(var o=0,n=i.children.length;o<n;o++){var a=i.children[o];e(a,u(i))&&(u(i)?s.push(a):t(a)?this._all(a,s):r.push(a))}i=r.pop()}return s},e.prototype.analyzeTriangles=function(e){void 0===e&&(e=this.data);var t=0;if(c(e))for(var i=0,s=e.children.length;i<s;i++)t+=e.children[i].numTriangles;else for(i=0,s=e.children.length;i<s;i++)t+=this.analyzeTriangles(e.children[i]);return e.totalTriangles=t},e.prototype.groupNodesByNumTrianglesThreshold=function(e,t){void 0===t&&(this.analyzeTriangles(),t=this.data);for(var i=[],s=0,r=t.children.length;s<r;s++){var o=t.children[s];i.push({item:o,triangles:o.totalTriangles||o.numTriangles})}i.sort((function(e,t){return-(e.item.triangles-t.item.triangles)}));var n=[],a=[],l=0;for(s=0,r=i.length;s<r;s++){var h=i[s];if(l+h.triangles<e)a.push(h),l+=h.triangles;else if(a.length&&(n.push(a),a=[],l=0),l+h.triangles<e)s--;else if(u(t,h.item))n.push([h]);else{for(var c=this.groupNodesByNumTrianglesThreshold(e,h.item),d=[],p=0,f=0,m=c.length;f<m-1;f++)n.push(c[s]);if(c.length>1){for(f=0,m=(c=c[c.length-1]).length;f<m;f++)(p+=c[f].triangles)<e?d.push(c[f]):(0==p&&d.push(c[f]),n.push(d),p=0,d=[]);d.forEach((function(e){a.push(e),l+=e.triangles}))}}}return a.length&&n.push(a),n},e.prototype.search=function(e){var t=this.data,s=[];if(!i.intersects(e,t))return s;for(var r=[];t;){for(var o=0,n=t.children.length;o<n;o++){var a=t.children[o];i.intersects(e,a)&&(u(t)?s.push(a):x(e,a)?this._all(a,s):r.push(a))}t=r.pop()}return s},e.prototype.collides=function(e){var t=this.data;if(!i.intersects(e,t))return!1;for(var s=[];t;){for(var r=0,o=t.children.length;r<o;r++){var n=t.children[r];if(i.intersects(e,n)){if(u(t)||x(e,n))return!0;s.push(n)}}t=s.pop()}return!1},e.prototype.raycastInv=function(e,t,s,r,o,n,a){void 0===a&&(a=1/0);var c=this.data;if(r===1/0&&o===1/0&&n===1/0)return h(1/0,void 0);if(i.boxRayIntersects(c,e,t,s,r,o,n)===1/0)return h(1/0,void 0);for(var d,p=[h(0,c)],f=function(e,t){var i=p[e];p[e]=p[t],p[t]=i},m=function(){var e=p[0],t=p.length-1;p[0]=p[t],p.length=t;for(var i=0;;){var s=i<<1|1;if(s>=t)break;var r=s+1;if(r<t&&p[r].dist<p[s].dist&&(s=r),p[i].dist<p[s].dist)break;f(i,s),i=s}return function(e){l.push(e)}(e),e.node},g=function(e,t){var i=p.length;for(p.push(h(e,t));i>0;){var s=i-1>>1;if(p[s].dist<=p[i].dist)break;f(i,s),i=s}},_=a;p.length&&p[0].dist<_;)for(var v=0,b=(c=m()).children.length;v<b;v++){var x=c.children[v],y=i.boxRayIntersects(x,e,t,s,r,o,n);if(u(c)){if(y<_){if(0===y)return h(y,x);_=y,d=x}}else g(y,x)}return h(_<a?_:1/0,d)},e.prototype.raycast=function(e,t,i,s,r,o,n){return void 0===n&&(n=1/0),this.raycastInv(e,t,i,1/s,1/r,1/o,n)},e.prototype.all=function(){return this._all(this.data,[])},e.prototype.load=function(e){if(!e||!e.length)return this;if(e.length<this.minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var s=this.build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this.splitRoot(this.data,s);else{if(this.data.height<s.height){var r=this.data;this.data=s,s=r}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},e.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},e.prototype.clear=function(){return this.data&&n(this.data),this.data=a([]),this},e.prototype.remove=function(e,t){if(!e)return this;for(var i,s,r=this.data,o=0,n=!1,a=[],l=[];r||a.length;){if(r||(r=a.pop(),o=l.pop(),s=a[a.length-1],n=!0),c(r)&&-1!==(i=d(e,r.children,t)))return r.children.splice(i,1),a.push(r),this.condense(a),this;n||c(r)||!x(r,e)?s?(o++,r=s.children[o],n=!1):r=void 0:(a.push(r),l.push(o),o=0,s=r,r=r.children[0])}return this},e.prototype.toJSON=function(){return this.data},e.prototype.fromJSON=function(e){return n(this.data),this.data=e,this},e.prototype.build=function(e,t,i,s){var r,o=i-t+1,n=this.maxEntries;if(o<=n)return r=a(e.slice(t,i+1)),p(r),r;s||(s=Math.ceil(Math.log(o)/Math.log(n)),n=Math.ceil(o/Math.pow(n,s-1))),(r=a([])).leaf=!1,r.height=s;var l=Math.ceil(o/n),h=l*Math.ceil(Math.pow(n,2/3)),c=l*Math.ceil(Math.pow(n,1/3));y(e,t,i,c,P);for(var u=t;u<=i;u+=c){var d=Math.min(u+c-1,i);y(e,u,d,h,w);for(var f=u;f<=d;f+=h){var m=Math.min(f+h-1,d);y(e,f,m,l,M);for(var g=f;g<=m;g+=l){var _=Math.min(g+l-1,m);r.children.push(this.build(e,g,_,s-1))}}}return p(r),r},e.prototype._all=function(e,t){for(var i=[];e;)c(e)?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},e.prototype.chooseSubtree=function(e,t,i,s){for(var r,o,n;s.push(t),!c(t)&&s.length-1!==i;){r=o=1/0;for(var a=0,l=t.children.length;a<l;a++){var h=t.children[a],u=g(h),d=v(e,h)-u;d<o?(o=d,r=u<r?u:r,n=h):d===o&&u<r&&(r=u,n=h)}t=n||t.children[0]}return t},e.prototype.split=function(e,t){var i=e[t],s=i.children.length,r=this.minEntries;this.chooseSplitAxis(i,r,s);var o=this.chooseSplitIndex(i,r,s),n=a(i.children.splice(o,i.children.length-o));n.height=i.height,n.leaf=i.leaf,p(i),p(n),t?e[t-1].children.push(n):this.splitRoot(i,n)},e.prototype.splitRoot=function(e,t){this.data=a([e,t]),this.data.height=e.height+1,this.data.leaf=!1,p(this.data)},e.prototype.chooseSplitIndex=function(e,t,i){for(var s,r=1/0,o=1/0,n=t;n<=i-t;n++){var a=f(e,0,n),l=f(e,n,i),h=b(a,l),c=g(a)+g(l);h<r?(r=h,s=n,o=c<o?c:o):h===r&&c<o&&(o=c,s=n)}return s},e.prototype.chooseSplitAxis=function(e,t,i){var s=this.allDistMargin(e,t,i,P),r=this.allDistMargin(e,t,i,w),o=this.allDistMargin(e,t,i,M);s<r&&s<o?e.children.sort(P):r<s&&r<o&&e.children.sort(w)},e.prototype.allDistMargin=function(e,t,i,s){e.children.sort(s);for(var r=f(e,0,t),o=f(e,i-t,i),n=_(r)+_(o),a=t;a<i-t;a++){var l=e.children[a];m(r,l),n+=_(r)}for(a=i-t-1;a>=t;a--){l=e.children[a];m(o,l),n+=_(o)}return n},e.prototype.adjustParentBBoxes=function(e,t,i){for(var s=i;s>=0;s--)m(t[s],e)},e.prototype.condense=function(e){for(var t=e.length-1,i=void 0;t>=0;t--)0===e[t].children.length?t>0?((i=e[t-1].children).splice(i.indexOf(e[t]),1),o(e[t])):this.clear():p(e[t])},e.prototype._insert=function(e,t,i){var s=[],r=this.chooseSubtree(e,this.data,t,s);for(r.children.push(e),m(r,e);t>=0&&s[t].children.length>this.maxEntries;)this.split(s,t),t--;this.adjustParentBBoxes(e,s,t)},e.pool=[],e}();i.RBush3D=C},{quickselect:2}],2:[function(e,t,i){!function(e,s){"object"==typeof i&&void 0!==t?t.exports=s():e.quickselect=s()}(this,(function(){function e(i,s,r,o,n){for(;o>r;){if(o-r>600){var a=o-r+1,l=s-r+1,h=Math.log(a),c=.5*Math.exp(2*h/3),u=.5*Math.sqrt(h*c*(a-c)/a)*(l-a/2<0?-1:1);e(i,s,Math.max(r,Math.floor(s-l*c/a+u)),Math.min(o,Math.floor(s+(a-l)*c/a+u)),n)}var d=i[s],p=r,f=o;for(t(i,r,s),n(i[o],d)>0&&t(i,r,o);p<f;){for(t(i,p,f),p++,f--;n(i[p],d)<0;)p++;for(;n(i[f],d)>0;)f--}0===n(i[r],d)?t(i,r,f):t(i,++f,o),f<=s&&(r=f+1),s<=f&&(o=f-1)}}function t(e,t,i){var s=e[t];e[t]=e[i],e[i]=s}function i(e,t){return e<t?-1:e>t?1:0}return function(t,s,r,o,n){e(t,s,r||0,o||t.length-1,n||i)}}))},{}]},{},[1])(1)}));var ki=Bi.exports.RBush3D,Oi=function(e){function t(e){var t=0;return e.meshes.forEach((function(e){t+=e.numTriangles})),t}function i(e,t){var i={pos:{x:0,y:0},left:0,right:e,top:0,bottom:t,dir:0};function s(){(0==i.dir&&i.pos.x+1>=i.right||1==i.dir&&i.pos.y+1>=i.bottom||2==i.dir&&i.pos.x-1<=i.left-1||3==i.dir&&i.pos.y-1<=i.top-1)&&(i.dir=(i.dir+1)%4,0==i.dir&&i.left++,1==i.dir&&i.top++,2==i.dir&&i.right--,3==i.dir&&i.bottom--),0==i.dir&&i.pos.x++,1==i.dir&&i.pos.y++,2==i.dir&&i.pos.x--,3==i.dir&&i.pos.y--}for(var r=[],o=e*t;r.length<o;s())r.push(i.pos.x+"_"+i.pos.y);return r}var s,r,o,n,a=0,l=(r=function(t,i){for(var s=i||function(e){return!0},r=(e.aabbTree.data.maxX-e.aabbTree.data.minX)/10,o=(e.aabbTree.data.maxZ-e.aabbTree.data.minZ)/10,n=[],a=e.aabbTree.data.minX,l=0;l<10;l++,a+=r)for(var h=e.aabbTree.data.minZ,c=0;c<10;c++,h+=o)n.push({minX:a,maxX:a+r,minY:-1e8,maxY:1e8,minZ:h,maxZ:h+o,indexX:l,indexZ:c});var u={cellsByEntity:{},entitiesByCell:{},cellsX:10,cellsZ:10};return(n||[]).forEach((function(t){e.aabbTree.search(t).filter((function(e){return s(e.entity)})).forEach((function(e){var i=e.entity.id;u.cellsByEntity[i]=u.cellsByEntity[i]||{cells:[],entity:e.entity},u.cellsByEntity[i].cells.push(t);var s=t.indexX+"_"+t.indexZ;u.entitiesByCell[s]=u.entitiesByCell[s]||{entities:[],cell:t},u.entitiesByCell[s].entities.push(e.entity)}))})),u}((s={cellSideInMeters:.05,entityFilterFunc:function(e){return!0},maxPolygonsPerCluster:9e4,minPercentOfClustredPolygons:.9}).cellSideInMeters,s.entityFilterFunc),o=function(e,i){var s={},r=0;Object.keys(i).forEach((function(e){var o=i[e].cells.length,n=t(i[e].entity);s[o]=(s[o]||0)+n,r+=n}));var o=Object.keys(s);o.sort((function(e,t){return e-t}));for(var n=0,a=0,l=0;l<o.length&&a<e;l++)n=o[l],a+=s[n]/r;return{maxCellsPerEntity:n,polygonStats:{percentClustered:a,numberClustered:Math.round(a*r),numberUnclustered:r-Math.round(a*r)}}}(s.minPercentOfClustredPolygons,r.cellsByEntity),n=function(e,s,r,o,n,a){var l={},h={accumEntities:[]},c=[];i(e,s).forEach((function(e){var i=function(e,t,i,s){return(i[e]||{entities:[]}).entities.filter((function(e){return s[e.id].cells.length<=t}))}(e,r,o,n).filter((function(e){return!(e.id in l)}));i.forEach((function(e){l[e.id]=!0})),i.sort((function(e,i){return t(e)-t(i)}));var s=h.accumEntities.concat(i),u=[],d=a,p=0;do{for(;p<s.length;p++){var f=s[p],m=t(f);m>d&&(c.push(u),u=[],d=a),u.push(f),d-=m}}while(p<s.length);h.accumEntities=u})),h.accumEntities.length&&c.push(h.accumEntities);var u=[];Object.keys(n).forEach((function(e){e in l||u.push(n[e].entity)}));var d=a,p=[];u.forEach((function(e){var i=t(e);i>d&&(c.push(p),p=[],d=a),p.push(e),d-=i})),p.length&&c.push(p);var f={};return c.forEach((function(e,t){e.forEach((function(e){f[e.id]=t}))})),{clusters:c,entityIdToClusterIdMapping:f}}(r.cellsX,r.cellsZ,o.maxCellsPerEntity,r.entitiesByCell,r.cellsByEntity,s.maxPolygonsPerCluster),{clusters:{total:n.clusters.length},clusteringResult:n});a+=l.clusters.total,console.log("Total clusters: "+a);var h=[];return l.clusteringResult.clusters.forEach((function(e){e.forEach((function(e){h.push(e.id)}))})),l.orderedEntityIds=h,l};
/**
   * @author https://github.com/tmarti, with support from https://tribia.com/
   * @license MIT
   */function Ni(e,t){t.length;const i=e.length,s=[],r=[];function o(e){for(let i=0,s=e.meshIds.length;i<s;i++)if(t[e.meshIds[i]].geometryId)return!0;return!1}for(let n=0;n<i;n++){const i=e[n];if(o(i)){r.push(n);continue}const a=p.collapseAABB3();let l=0;i.meshIds.forEach((e=>{const i=t[e],s=rt.getPositionsBounds(i.positions),r=rt.decompressPosition(s.min,i.positionsDecodeMatrix,[]),o=rt.decompressPosition(s.max,i.positionsDecodeMatrix,[]);r[0]+=i.origin[0],r[1]+=i.origin[1],r[2]+=i.origin[2],o[0]+=i.origin[0],o[1]+=i.origin[1],o[2]+=i.origin[2],p.expandAABB3Point3(a,r),p.expandAABB3Point3(a,o),l+=Math.round(i.indices.length/3)})),s[n]={aabb:a,numTriangles:l,entityId:i.id}}let n,a=[],l={};if(Object.keys(s).length>0){n=
/**
   * @author https://github.com/tmarti, with support from https://tribia.com/
   * @license MIT
   */
function(e){const t=[];for(let i=0,s=e.length;i<s;i++){const s=e[i];s&&t.push({minX:s.aabb[0],minY:s.aabb[1],minZ:s.aabb[2],maxX:s.aabb[3],maxY:s.aabb[4],maxZ:s.aabb[5],entity:{id:i,xeokitId:s.entityId,meshes:[{numTriangles:s.numTriangles}]},numTriangles:s.numTriangles})}const i=new ki(4);return i.load(t),i}(s);let e=Oi({aabbTree:n});a=e.orderedEntityIds,l=e.clusteringResult.entityIdToClusterIdMapping}return{orderedClusteredIndexes:a,entityIdToClusterIdMapping:l,instancedIndexes:r,rTreeBasedAabbTree:n}}let ji=p.vec3();const Vi=256,zi=180/Math.PI,Ui=new Float32Array(262144);for(let e=-256;e<Vi;e++)for(let t=-256;t<Vi;t++){const i=(e+Vi<<9)+(t+Vi),s=Math.max(Math.abs(e),Math.abs(t));Ui[i]=Math.atan2(e/s,t/s)}function Gi(e,t){const i=Vi/Math.max(Math.abs(e),Math.abs(t)),s=Math.round(e*i)+255,r=Math.round(t*i)+255;return Ui[(s<<9)+r]}const Wi=256;class Hi{constructor(){this._aabbTree=null,this._orderedMeshList=[],this._orderedEntityList=[],this._frustumProps={dirty:!0,wMultiply:1,hMultiply:1},this._cullFrame=0,this.finalized=!1}initializeVfcState(e,t){if(this.finalized)throw"Already finalized";const i=Ni(e,t);this._aabbTree=i.rTreeBasedAabbTree;for(let s=0,r=i.orderedClusteredIndexes.length;s<r;s++){const r=i.orderedClusteredIndexes[s],o=i.entityIdToClusterIdMapping[r],n=e[r],a=[];for(let e=0,i=n.meshIds.length;e<i;e++){const i=n.meshIds[e];t[i].id=this._orderedMeshList.length,a.push(this._orderedMeshList.length),this._orderedMeshList.push({clusterNumber:o,mesh:t[i]})}n.meshIds=a,this._orderedEntityList.push(n)}for(let s=0,r=i.instancedIndexes.length;s<r;s++){let r=e[i.instancedIndexes[s]];const o=[];for(let e=0,i=r.meshIds.length;e<i;e++){const i=r.meshIds[e];t[i].id=this._orderedMeshList.length,o.push(this._orderedMeshList.length),this._orderedMeshList.push({clusterNumber:99999,mesh:t[i]})}r.meshIds=o,this._orderedEntityList.push(r)}}finalize(e,t){if(this.finalized)throw"Already finalized";let i=-1;for(let s=0,r=this._orderedMeshList.length;s<r;s++){const{clusterNumber:r,mesh:o}=this._orderedMeshList[s];-1!=i&&i!=r&&t.call(e),e.createMesh(o),i=r}for(let t=0,i=this._orderedEntityList.length;t<i;t++)e.createEntity(this._orderedEntityList[t]);this._orderedMeshList=[],this._orderedEntityList=[],this.finalized=!0}applyViewFrustumCulling(e){if(!this.finalized)throw"Not finalized";if(!this._aabbTree)return;this._canvasElement||(this._canvasElement=e.scene.canvas.canvas),this._camera||(this._camera=e.scene.camera),this._ensureFrustumPropsUpdated(e),this._initializeCullingDataIfNeeded(e);const t=this._searchVisibleNodesWithFrustumCulling();this._cullFrame++,this._markVisibleFrameOfVisibleNodes(t,this._cullFrame),this._cullNonVisibleNodes(e,this._cullFrame)}_initializeCullingDataIfNeeded(e){if(this._internalNodesList)return;if(!this._aabbTree)return;const t=this._aabbTree.all();let i=0;t.forEach((e=>{i=Math.max(i,e.entity.id)}));const s=new Array(i+1);t.forEach((t=>{s[t.entity.id]=e._nodes[t.entity.xeokitId]})),this._internalNodesList=s,this._lastVisibleFrameOfNodes=new Array(s.length),this._lastVisibleFrameOfNodes.fill(0)}_searchVisibleNodesWithFrustumCulling(){return this._aabbTree.searchCustom(((e,t)=>this._aabbIntersectsCameraFrustum(e,t)),(e=>this._aabbContainedInCameraFrustum(e)))}_markVisibleFrameOfVisibleNodes(e,t){const i=this._lastVisibleFrameOfNodes;for(let s=0,r=e.length;s<r;s++)i[e[s].entity.id]=t}_cullNonVisibleNodes(e,t){const i=this._internalNodesList,s=this._lastVisibleFrameOfNodes;e.beginDeferredFlagsInAllLayers();for(let e=0,r=i.length;e<r;e++)i[e]&&(i[e].culledVFC=s[e]!==t);e.commitDeferredFlagsInAllLayers()}_getPointsForBBox(e){for(var t=[],i=0;i<8;i++)t.push([1&i?e.maxX:e.minX,2&i?e.maxY:e.minY,4&i?e.maxZ:e.minZ]);return t}_aabbIntersectsCameraFrustum(e,t){if(t)return!0;if("ortho"==this._camera.projection)return this._frustumProps.dirty=!1,!0;var i=this._aabbIntersectsCameraFrustum_internal(e);return!!((4096&i||!(1&i||2&i)||1&i)&&(8192&i||!(16&i||32&i)||16&i)&&(16384&i||!(i&Wi||512&i)||i&Wi))}_aabbContainedInCameraFrustum(e){if("ortho"==this._camera.projection)return this._frustumProps.dirty=!1,!0;var t=e._check;return 1&t&&16&t&&t&Wi}_ensureFrustumPropsUpdated(e){const t=Math.min(this._canvasElement.width,this._canvasElement.height);this._frustumProps.wMultiply=this._canvasElement.width/t,this._frustumProps.hMultiply=this._canvasElement.height/t;const i=this._canvasElement.width/this._canvasElement.height;let s=this._camera.perspective.fov;i<1&&(s/=i),s=Math.min(s,120),this._frustumProps.fov=s;const r=p.inverseMat4(e.worldMatrix,p.mat4()),o=p.transformVec3(this._camera.eye,r,[0,0,0]),n=p.transformVec3(this._camera.look,r,[0,0,0]);this._frustumProps.forward=p.normalizeVec3(p.subVec3(n,o,[0,0,0]),[0,0,0]),this._frustumProps.up=p.normalizeVec3(this._camera.up,[0,0,0]),this._frustumProps.right=p.normalizeVec3(p.cross3Vec3(this._frustumProps.forward,this._frustumProps.up,[0,0,0]),[0,0,0]),this._frustumProps.eye=o.slice(),this._frustumProps.CAM_FACTOR_1=this._frustumProps.fov/2*this._frustumProps.wMultiply/zi,this._frustumProps.CAM_FACTOR_2=this._frustumProps.fov/2*this._frustumProps.hMultiply/zi}_aabbIntersectsCameraFrustum_internal(e){var t=e._points||this._getPointsForBBox(e);e._points=t;var i=819;window._debug&&(window._debug=!1);for(var s=0,r=t.length;s<r;s++){var o=t[s],n=ji;n[0]=o[0]-this._frustumProps.eye[0],n[1]=o[1]-this._frustumProps.eye[1],n[2]=o[2]-this._frustumProps.eye[2];var a=p.dotVec3(n,this._frustumProps.forward);a<0?(i|=4,i&=-2):(i|=8,i&=-3);var l=Gi(p.dotVec3(n,this._frustumProps.right),a);Math.abs(l)>this._frustumProps.CAM_FACTOR_1?(i|=l<0?64:128,i&=-17):i&=-33;var h=Gi(p.dotVec3(n,this._frustumProps.up),a);Math.abs(h)>this._frustumProps.CAM_FACTOR_2?(i|=h<0?1024:2048,i&=-257):i&=-513}return 4&i&&8&i&&(i|=4096),64&i&&128&i&&(i|=8192),1024&i&&2048&i&&(i|=16384),e._check=i,i}}class Xi{constructor(e){this.model=e,this.entities=[],this.meshes=[],this.finalized=!1}addEntity(e){if(this.finalized)throw"Already finalized";this.entities.push(e)}addMesh(e){if(this.finalized)throw"Already finalized";this.meshes.push(e)}finalize(e){if(this.finalized)throw"Already finalized";this.finalized=!0,this.vfcState=new Hi,console.time("initializeVfcState"),this.vfcState.initializeVfcState(this.entities,this.meshes),console.timeEnd("initializeVfcState"),console.time("finalizeVfcState"),this.vfcState.finalize(this.model,e),console.timeEnd("finalizeVfcState");const t=this;this.model.scene.on("rendering",(()=>this.applyViewFrustumCulling.call(t)))}applyViewFrustumCulling(){if(!this.finalized)throw"Not finalized";this.vfcState.applyViewFrustumCulling(this.model)}}const Yi=p.vec3(),qi=p.mat4(),$i=p.vec3([1,1,1]),Zi=p.vec3([0,0,0]),Ki=p.vec3([0,0,0]),Qi=p.identityQuaternion();class Ji extends T{constructor(e,t={}){if(super(e,t),!(this.scene.canvas.gl instanceof WebGL2RenderingContext))throw"Using a DataTextureSceneModel requires the usage of webgl2";this._enableVertexWelding=!t.disableVertexWelding,this._enableIndexRebucketing=!t.disableIndexRebucketing,this._targetLodFps=t.targetLodFps,t.enableViewFrustumCulling&&(this._vfcManager=new Xi(this)),this._aabb=p.collapseAABB3(),this._aabbDirty=!1,this._layerList=[],this._nodeList=[],this._currentDataTextureLayer=null,this._instancingGeometries={},this._preparedInstancingGeometries={},this._meshes={},this._nodes={},this.renderFlags=new Ti,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.backfaces=t.backfaces,this._origin=p.vec3(t.origin||[0,0,0]),this._position=p.vec3(t.position||[0,0,0]),this._rotation=p.vec3(t.rotation||[0,0,0]),this._quaternion=p.vec4(t.quaternion||[0,0,0,1]),t.rotation&&p.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=p.vec3(t.scale||[1,1,1]),this._worldMatrix=p.mat4(),p.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=p.mat4(),p.inverseMat4(this._worldMatrix,this._worldNormalMatrix),p.transposeMat4(this._worldNormalMatrix),(t.matrix||t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=p.mat4(),this._viewNormalMatrix=p.mat4(),this._viewMatrixDirty=!0,this._worldMatrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==t.saoEnabled,this._pbrEnabled=!!t.pbrEnabled,this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewMatrixDirty=!0}))}get isPerformanceModel(){return!0}get objects(){return this._nodes}get origin(){return this._origin}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(p.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),p.inverseMat4(this._viewMatrix,this._viewNormalMatrix),p.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(p.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),p.inverseMat4(this._viewMatrix,this._viewNormalMatrix),p.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw()}get entityList(){return this._nodeList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){return this._aabbDirty&&this._rebuildAABB(),this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return 0}get numPoints(){return 0}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].visible=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].xrayed=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].highlighted=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].selected=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].edges=e;this.glRedraw()}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].culled=e;this.glRedraw()}get clippable(){return this._clippable}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].clippable=e;this.glRedraw()}get collidable(){return this._collidable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].collidable=e}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].pickable=e}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].colorize=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].opacity=e}get castsShadow(){return this._castsShadow}set castsShadow(e){(e=!1!==e)!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createGeometry(e){e.positionsCompressed&&!e.positions&&(e.positions=e.positionsCompressed);const t=e.id;if(null==t)return void this.error("Config missing: id");if(t in this._instancingGeometries)return void this.error("Geometry already created: "+t);const i=e.primitive;if(null==i)return void this.error("Config missing: primitive");const s=e.origin||e.rtcCenter,r=s?p.addVec3(this._origin,s,Yi):this._origin;switch(i){case"triangles":case"solid":case"surface":this._instancingGeometries[e.id]=v.apply({origin:r,layerIndex:0},e),this._numTriangles+=e.indices?Math.round(e.indices.length/3):0;break;case"lines":case"points":throw"Not supported at the moment"}this.numGeometries++}createMesh(e){if(e.positionsCompressed&&!e.positions&&(e.positions=e.positionsCompressed),this._vfcManager&&!this._vfcManager.finalized)return e.color&&(e.color=e.color.slice()),e.positionsDecodeMatrix&&(e.positionsDecodeMatrix=e.positionsDecodeMatrix.slice()),void this._vfcManager.addMesh(e);let t=e.id;if(null==t)return void this.error("Config missing: id");if(this._meshes[t])return void this.error("DataTextureSceneModel already has a Mesh with this ID: "+t);const i=e.geometryId,s=void 0!==i;let r=null;r=s?this._instancingGeometries[i]:e;let o=null;if(s&&i in this._preparedInstancingGeometries)o=this._preparedInstancingGeometries[i];else{let e=r.primitive||"triangles";"triangles"!==e&&"solid"!==e&&"surface"!==e&&(this.error(`Unsupported value for 'primitive': '${e}' - supported values are 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`),e="triangles");let t=r.positions;if(!t)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;let n=r.indices,a=r.edgeIndices;if(!r.indices&&"triangles"===e)return this.error("Config missing for triangles primitive: indices (no meshIds provided, so expecting geometry arrays instead)"),null;a||(a=Me(t,n,null,this._edgeThreshold)),r.edgeIndices=a,o=function(e,t,i){let s,r,o,n;t?[s,r,o]=si({positions:e.positions,indices:e.indices,edgeIndices:e.edgeIndices}):(s=e.positions,r=e.indices,o=e.edgeIndices),n=i?li({positions:s,indices:r,edgeIndices:o},s.length/3>65536?16:8):[{positions:s,indices:r,edgeIndices:o}];return e.preparedBuckets=n,e}(r,this._enableVertexWelding,this._enableIndexRebucketing),s&&(this._preparedInstancingGeometries[i]=o)}let n,a=this._currentDataTextureLayer;null===a||a.canCreatePortion(o,s?i:null)||(a.finalize(),delete this._currentDataTextureLayer,a=null),a||(a=new Di(this,{layerIndex:0,origin:e.origin}),this._layerList.push(a),this._currentDataTextureLayer=a);const l=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],h=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,c=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,u=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,d=new Ce(this,t,l,h),f=d.pickId,m=new Uint8Array([255&f,f>>8&255,f>>16&255,f>>24&255]),g=p.collapseAABB3();if(o.solid="solid"==o.primitive,s){let t,s=this._worldMatrixNonIdentity?this._worldMatrix:null;if(e.matrix)t=e.matrix;else{const i=e.scale||$i,s=e.position||Zi,r=e.rotation||Ki;p.eulerToQuaternion(r,"XYZ",Qi),t=p.composeMat4(s,Qi,i,qi)}n=a.createPortion(o,{origin:e.origin,geometryId:i,color:l,metallic:c,roughness:u,opacity:h,meshMatrix:t,worldMatrix:s,aabb:g,pickColor:m}),p.expandAABB3(this._aabb,g),this._numTriangles+=o.indices.length/3,d.numTriangles=o.indices.length/3,d.origin=o.origin}else{let t=null;if(!e.positionsDecodeMatrix){const e=p.vec3(),i=[];W(positions,i,e)&&(positions=i,t=p.addVec3(this._origin,e,e))}const i=e.origin||e.rtcCenter;t=i?t?p.addVec3(this._origin,i,Yi):i:this._origin;const s=this._worldMatrixNonIdentity?this._worldMatrix:null;let r;if(!e.positionsDecodeMatrix)if(e.matrix)r=e.matrix;else{const t=e.scale||$i,i=e.position||Zi,s=e.rotation||Ki;p.eulerToQuaternion(s,"XYZ",Qi),r=p.composeMat4(i,Qi,t,qi)}switch(e.primitive||"triangles"){case"triangles":case"solid":case"surface":n=a.createPortion(v.apply({origin:t,color:l,metallic:c,roughness:u,colors:e.colors,colorsCompressed:e.colorsCompressed,opacity:h,meshMatrix:r,worldMatrix:s,aabb:g,pickColor:m},o));const i=Math.round(o.indices.length/3);this._numTriangles+=i,d.numTriangles=i;break;case"lines":case"points":throw"Not supported at the moment"}p.expandAABB3(this._aabb,g),this.numGeometries++,d.origin=t}d.parent=null,d._layer=a,d._portionId=n,d.aabb=g,this._meshes[t]=d}createEntity(e){if(this._vfcManager&&!this._vfcManager.finalized)return void this._vfcManager.addEntity(e);let t=e.id;void 0===t?t=p.createUUID():this.scene.components[t]&&(this.error("Scene already has a Component with this ID: "+t+" - will assign random ID"),t=p.createUUID());const i=e.meshIds;if(void 0===i)return void this.error("Config missing: meshIds");let s=[];for(let e=0,t=i.length;e<t;e++){const t=i[e],r=this._meshes[t];r?r.parent?this.error("Mesh with ID "+t+" already belongs to object with ID "+r.parent.id+" - ignoring this mesh"):s.push(r):this.error("Mesh with this ID not found: "+t+" - ignoring this mesh")}let r,o=0;if(this._visible&&!1!==e.visible&&(o|=Ee),this._pickable&&!1!==e.pickable&&(o|=De),this._culled&&!1!==e.culled&&(o|=Ae),this._clippable&&!1!==e.clippable&&(o|=Te),this._collidable&&!1!==e.collidable&&(o|=Se),this._edges&&!1!==e.edges&&(o|=Be),this._xrayed&&!1!==e.xrayed&&(o|=Ie),this._highlighted&&!1!==e.highlighted&&(o|=Fe),this._selected&&!1!==e.selected&&(o|=Le),1===s.length)r=s[0].aabb;else{r=p.collapseAABB3();for(let e=0,t=s.length;e<t;e++)p.expandAABB3(r,s[e].aabb)}const n=new Oe(this,e.isObject,t,s,o,r);return this._nodeList.push(n),this._nodes[t]=n,this.numEntities++,n}finalize(){if(!this.destroyed){this.beginDeferredFlagsInAllLayers(),this._vfcManager&&this._vfcManager.finalize((function(){this._currentDataTextureLayer&&(this._currentDataTextureLayer.finalize(),delete this._currentDataTextureLayer,this._currentDataTextureLayer=null)})),this._currentDataTextureLayer&&this._currentDataTextureLayer.finalize();for(let e=0,t=this._nodeList.length;e<t;e++){this._nodeList[e]._finalize()}for(let e=0,t=this._nodeList.length;e<t;e++){this._nodeList[e]._finalize2()}this._layerList.sort(((e,t)=>e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0));for(let e=0,t=this._layerList.length;e<t;e++){this._layerList[e].layerIndex=e}this.commitDeferredFlagsInAllLayers(),this.glRedraw(),this.scene._aabbDirty=!0,this._instancingGeometries={},this._preparedInstancingGeometries={},this._targetLodFps&&(this.lodCullingManager=new Li(this,[2e3,600,150,80,20],this._targetLodFps))}}_rebuildAABB(){p.collapseAABB3(this._aabb);for(let e=0,t=this._nodeList.length;e<t;e++){const t=this._nodeList[e];p.expandAABB3(this._aabb,t.aabb)}this._aabbDirty=!1}stateSortCompare(e,t){}rebuildRenderFlags(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this._layerList.length,e.numVisibleLayers=0;for(let t=0,i=this._layerList.length;t<i;t++){const i=this._layerList[t];this._getActiveSectionPlanesForLayer(i)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}beginDeferredFlagsInAllLayers(){for(let e=0,t=this._layerList.length;e<t;e++){this._layerList[e].beginDeferredFlags()}}commitDeferredFlagsInAllLayers(){for(let e=0,t=this._layerList.length;e<t;e++){this._layerList[e].commitDeferredFlags()}}_getActiveSectionPlanesForLayer(e){const t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,r=e.layerIndex*s;if(s>0)for(let e=0;e<s;e++){i[e].active?(t.sectionPlanesActivePerLayer[r+e]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[r+e]=!1}return!0}_updateRenderFlags(){if(0===this.numVisibleLayerPortions)return;if(this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0))}if(this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}drawColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawColorOpaque(t,e)}}drawColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawColorTransparent(t,e)}}drawDepth(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawDepth(t,e)}}drawNormals(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawNormals(t,e)}}drawSilhouetteXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawSilhouetteXRayed(t,e)}}drawSilhouetteHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawSilhouetteHighlighted(t,e)}}drawSilhouetteSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawSilhouetteSelected(t,e)}}drawEdgesColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesColorOpaque(t,e)}}drawEdgesColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesColorTransparent(t,e)}}drawEdgesXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesXRayed(t,e)}}drawEdgesHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesHighlighted(t,e)}}drawEdgesSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesSelected(t,e)}}drawOcclusion(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawOcclusion(t,e)}}drawShadow(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawShadow(t,e)}}drawPickMesh(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawPickMesh(t,e)}}drawPickDepths(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawPickDepths(t,e)}}drawPickNormals(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawPickNormals(t,e)}}destroy(){this.scene.camera.off(this._onCameraViewMatrix);for(let e=0,t=this._layerList.length;e<t;e++)this._layerList[e].destroy();for(let e=0,t=this._nodeList.length;e<t;e++)this._nodeList[e]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),super.destroy()}}const es=function(e,i){i=i||{};const s=new K(e),r=e.canvas.canvas,o=e.canvas.gl,n=!!i.transparent,a=i.alphaDepthMask,l=new t({});let h={},c={},u=!0,d=!0,m=!0,g=!0,_=!0,v=!0,b=!0,x=!0;const y=new Pe(e);let P=!1;const w=new de(e),M=new _e(e);function C(){u&&(!function(){for(let e in h)if(h.hasOwnProperty(e)){const t=h[e],i=t.drawableMap,s=t.drawableListPreCull;let r=0;for(let e in i)i.hasOwnProperty(e)&&(s[r++]=i[e]);s.length=r}}(),u=!1,d=!0),d&&(!function(){for(let e in h)if(h.hasOwnProperty(e)){const t=h[e];t.isStateSortable&&t.drawableListPreCull.sort(t.stateSortCompare)}}(),d=!1,m=!0),m&&function(){for(let e in h)if(h.hasOwnProperty(e)){const t=h[e],i=t.drawableListPreCull,s=t.drawableList;let r=0;for(let e=0,t=i.length;e<t;e++){const t=i[e];t.rebuildRenderFlags(),t.renderFlags.culled||(s[r++]=t)}s.length=r}}()}function E(e){if(!e.castsShadow)return;const t=e.getShadowRenderBuf();if(t){t.bind(),s.reset(),s.backfaces=!0,s.frontface=!0,s.shadowViewMatrix=e.getShadowViewMatrix(),s.shadowProjMatrix=e.getShadowProjMatrix(),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,1),o.enable(o.DEPTH_TEST),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];!1!==i.visible&&i.castsShadow&&i.drawShadow&&(i.renderFlags.colorOpaque&&i.drawShadow(s))}}t.unbind()}}this._occlusionTester=null,this.capabilities={astcSupported:!!we(o,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!we(o,"WEBGL_compressed_texture_etc"),dxtSupported:!!we(o,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!we(o,"EXT_texture_compression_bptc"),pvrtcSupported:!(!we(o,"WEBGL_compressed_texture_pvrtc")&&!we(o,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(e){g=e,m=!0},this.setEdgesEnabled=function(e){_=e,m=!0},this.setSAOEnabled=function(e){v=e,m=!0},this.setPBREnabled=function(e){b=e,m=!0},this.setColorTextureEnabled=function(e){x=e,m=!0},this.needStateSort=function(){d=!0},this.shadowsDirty=function(){},this.imageDirty=function(){m=!0},this.webglContextLost=function(){},this.webglContextRestored=function(e){w.init(),M.init(),m=!0},this.addDrawable=function(e,t){const i=t.type;if(!i)return void console.error("Renderer#addDrawable() : drawable with ID "+e+" has no 'type' - ignoring");let s=h[i];s||(s={type:t.type,count:0,isStateSortable:t.isStateSortable,stateSortCompare:t.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},h[i]=s),s.count++,s.drawableMap[e]=t,c[e]=t,u=!0},this.removeDrawable=function(e){const t=c[e];if(!t)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+e+" - ignoring");const i=t.type,s=h[i];--s.count<=0?delete h[i]:delete s.drawableMap[e],delete c[e],u=!0},this.getPickID=function(e){return l.addItem(e)},this.putPickID=function(e){l.removeItem(e)},this.clear=function(t){if(o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),n)o.clearColor(1,1,1,1);else{const t=e.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():e.canvas.backgroundColor;o.clearColor(t[0],t[1],t[2],1)}o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},this.needsRender=function(){return m||u||d},this.render=function(t){(t=t||{}).force&&(m=!0),C(),m&&(!function(t){const i=e.sao;v&&i.possible&&function(t){const i=e.sao,r=y.getRenderBuffer("saoDepth",{depthTexture:!0});r.bind(),r.clear(),function(e){s.reset(),s.pass=e.pass,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),!1!==e.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];!0!==i.culled&&!1!==i.visible&&i.drawDepth&&i.saoEnabled&&(i.renderFlags.colorOpaque&&i.drawDepth(s))}}}(t),r.unbind();const n=y.getRenderBuffer("saoOcclusion");if(n.bind(),n.clear(),w.render(r),n.unbind(),i.blur){const e=y.getRenderBuffer("saoOcclusion2");e.bind(),e.clear(),M.render(r,n,0),e.unbind(),n.bind(),n.clear(),M.render(r,e,1),n.unbind()}}(t);(function(){let t=e._lightsState.lights;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.castsShadow&&E(i)}})(),function(t){const i=[],r=[],l=[],c=[],u=[],d=[],p=[],m=[],P=[],w=[],M=[],C=[],E=[],A=[],D=[],T=[];{const S=e._lightsState.getAmbientColorAndIntensity();if(s.reset(),s.pass=t.pass,s.withSAO=!1,s.pbrEnabled=b&&!!e.pbrEnabled,s.colorTextureEnabled=x&&!!e.colorTextureEnabled,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),n)o.clearColor(0,0,0,0);else{const t=e.canvas.backgroundColorFromAmbientLight?S:e.canvas.backgroundColor;o.clearColor(t[0],t[1],t[2],1)}o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),o.lineWidth(1),s.lineWidth=1;const I=e.sao.possible;if(v&&I){const e=y.getRenderBuffer("saoOcclusion");s.occlusionTexture=e?e.getTexture():null}else s.occlusionTexture=null;let F,L,B;const R=Date.now();!1!==t.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);let k=0,O=0,N=0,j=0,V=0,z=0,U=0,G=0,W=0,H=0,X=0,q=0,$=0,Z=0,K=0,Q=0;for(let e in h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(F=0,L=t.length;F<L;F++){if(B=t[F],!0===B.culled||!1===B.visible)continue;const e=B.renderFlags;e.colorOpaque&&(v&&I&&B.saoEnabled?i[k++]=B:B.drawColorOpaque(s)),g&&e.colorTransparent&&(l[N++]=B),e.xrayedSilhouetteTransparent&&(p[U++]=B),e.xrayedSilhouetteOpaque&&(u[V++]=B),e.highlightedSilhouetteTransparent&&(M[X++]=B),e.highlightedSilhouetteOpaque&&(P[W++]=B),e.selectedSilhouetteTransparent&&(D[K++]=B),e.selectedSilhouetteOpaque&&(E[$++]=B),_&&(e.edgesOpaque&&(r[O++]=B),e.edgesTransparent&&(c[j++]=B)),e.selectedEdgesTransparent&&(T[Q++]=B),e.selectedEdgesOpaque&&(A[Z++]=B),e.xrayedEdgesTransparent&&(m[G++]=B),e.xrayedEdgesOpaque&&(d[z++]=B),e.highlightedEdgesTransparent&&(C[q++]=B),e.highlightedEdgesOpaque&&(w[H++]=B)}}if(k>0)for(s.withSAO=!0,F=0;F<k;F++)i[F].drawColorOpaque(s);if(O>0)for(F=0;F<O;F++)r[F].drawEdgesColorOpaque(s);if(V>0)for(F=0;F<V;F++)u[F].drawSilhouetteXRayed(s);if(z>0)for(F=0;F<z;F++)d[F].drawEdgesXRayed(s);if(U>0||G>0||N>0||j>0){if(o.enable(o.CULL_FACE),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):(o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)),s.backfaces=!1,a||o.depthMask(!1),(N>0||j>0)&&o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),j>0)for(F=0;F<j;F++)B=c[F],B.drawEdgesColorTransparent(s);if(N>0)for(F=0;F<N;F++)B=l[F],B.drawColorTransparent(s);if(G>0)for(F=0;F<G;F++)m[F].drawEdgesXRayed(s);if(U>0)for(F=0;F<U;F++)p[F].drawSilhouetteXRayed(s);o.disable(o.BLEND),a||o.depthMask(!0)}if(W>0||H>0){if(s.lastProgramId=null,e.highlightMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),H>0)for(F=0;F<H;F++)w[F].drawEdgesHighlighted(s);if(W>0)for(F=0;F<W;F++)P[F].drawSilhouetteHighlighted(s)}if(X>0||q>0||W>0){if(s.lastProgramId=null,e.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.enable(o.CULL_FACE),q>0)for(F=0;F<q;F++)C[F].drawEdgesHighlighted(s);if(X>0)for(F=0;F<X;F++)M[F].drawSilhouetteHighlighted(s);o.disable(o.BLEND)}if($>0||Z>0){if(s.lastProgramId=null,e.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),Z>0)for(F=0;F<Z;F++)A[F].drawEdgesSelected(s);if($>0)for(F=0;F<$;F++)E[F].drawSilhouetteSelected(s)}if(K>0||Q>0){if(s.lastProgramId=null,e.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),Q>0)for(F=0;F<Q;F++)T[F].drawEdgesSelected(s);if(K>0)for(F=0;F<K;F++)D[F].drawSilhouetteSelected(s);o.disable(o.BLEND)}const J=Date.now(),ee=f.frame;ee.renderTime=(J-R)/1e3,ee.drawElements=s.drawElements,ee.drawArrays=s.drawArrays,ee.useProgram=s.useProgram,ee.bindTexture=s.bindTexture,ee.bindArray=s.bindArray;const te=Y.MAX_TEXTURE_IMAGE_UNITS;for(let e=0;e<te;e++)o.activeTexture(o.TEXTURE0+e);o.bindTexture(o.TEXTURE_CUBE_MAP,null),o.bindTexture(o.TEXTURE_2D,null);const ie=Y.MAX_VERTEX_ATTRIBS;for(let e=0;e<ie;e++)o.disableVertexAttribArray(e)}}(t)}(t),f.frame.frameCount++,m=!1)},this.pick=function(){const t=p.vec3(),i=p.mat4(),n=p.mat4(),a=p.vec3(),c=p.vec3([0,1,0]),u=new Q,d=p.vec2(),f=p.vec3(),m=p.vec3(),g=p.vec3(),_=p.vec3(),v=p.vec3();return function(b,x=u){let P;x.reset(),C();let w=null,M=null;if(x.pickSurface=b.pickSurface,b.canvasPos)f[0]=b.canvasPos[0],f[1]=b.canvasPos[1],w=e.camera.viewMatrix,M=e.camera.projMatrix,x.canvasPos=b.canvasPos;else{const s=p.frustumMat4(-1,1,-1,1,.01,e.camera.project.far,i);b.matrix?(w=b.matrix,M=s):(m.set(b.origin||[0,0,0]),g.set(b.direction||[0,0,1]),P=p.addVec3(m,g,t),a[0]=Math.random(),a[1]=Math.random(),a[2]=Math.random(),p.normalizeVec3(a),p.cross3Vec3(g,a,c),w=p.lookAtMat4v(m,P,c,n),M=s,x.origin=m,x.direction=g),f[0]=.5*r.clientWidth,f[1]=.5*r.clientHeight}if(null!==w)for(let e in h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i instanceof Ji&&i.pickCameraTexture&&i.pickCameraTexture._updateViewMatrix(w,M)}}const E=y.getRenderBuffer("pick");E.bind();const D=function(t,i,r,n,a,c){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=c.origin,s.pickViewMatrix=r,s.pickProjMatrix=n,s.pickInvisible=!!a.pickInvisible,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const u=a.includeEntityIds,d=a.excludeEntityIds;for(let e in h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];!i.drawPickMesh||!0===i.culled||!0!==a.pickInvisible&&!1===i.visible||!1===i.pickable||(u&&!u[i.id]||d&&d[i.id]||i.drawPickMesh(s))}}const p=e.canvas.resolutionScale,f=t.read(Math.round(i[0]*p),Math.round(i[1]*p));let m=f[0]+256*f[1]+256*f[2]*256+256*f[3]*256*256;if(m<0)return;return l.items[m]}(E,f,w,M,b,x);if(!D)return E.unbind(),null;const T=D.delegatePickedEntity?D.delegatePickedEntity():D;return T?(b.pickSurface&&(b.pickSurfacePrecision&&e.pickSurfacePrecisionEnabled?(b.canvasPos&&p.canvasPosToWorldRay(e.canvas.canvas,w,M,f,m,g),D.precisionRayPickSurface(m,g,_,v)&&(x.worldPos=_,!1!==b.pickSurfaceNormal&&(x.worldNormal=v),x.pickSurfacePrecision=!0)):D.canPickTriangle&&D.canPickTriangle()?(!function(t,i,r,n,a,l){if(!i.drawPickTriangles)return;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=l.origin,s.pickViewMatrix=n,s.pickProjMatrix=a,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),i.drawPickTriangles(s);const h=e.canvas.resolutionScale,c=t.read(Math.round(r[0]*h),Math.round(r[1]*h));let u=c[0]+256*c[1]+256*c[2]*256+256*c[3]*256*256;u*=3,l.primIndex=u}(E,D,f,w,M,x),D.pickTriangleSurface(w,M,x),x.pickSurfacePrecision=!1):D.canPickWorldPos&&D.canPickWorldPos()&&(d[0]=e.camera.project.near,d[1]=e.camera.project.far,A(E,D,f,w,M,d,x),!1!==b.pickSurfaceNormal&&function(t,i,r,n,a,l){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=l.origin,s.pickViewMatrix=n,s.pickProjMatrix=a,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),i.drawPickNormals(s);const h=e.canvas.resolutionScale,c=t.read(Math.round(r[0]*h),Math.round(r[1]*h)),u=[c[0]/256-.5,c[1]/256-.5,c[2]/256-.5];p.normalizeVec3(u),l.worldNormal=u}(E,D,f,w,M,x),x.pickSurfacePrecision=!1)),E.unbind(),x.entity=T,x):(E.unbind(),null)}}();const A=function(){const t=p.vec4(),i=p.vec4(),n=p.vec4(),a=p.vec4(),l=p.vec4(),h=p.mat4(),c=p.mat4(),u=p.mat4();return function(d,f,m,g,_,v,b){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=b.origin,s.pickViewMatrix=g,s.pickProjMatrix=_,s.pickZNear=v[0],s.pickZFar=v[1],o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),f.drawPickDepths(s);const x=e.canvas.resolutionScale,y=function(e){const t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256],i=[1/16777216,1/65536,1/256,1];return p.dotVec4(t,i)}(d.read(Math.round(m[0]*x),Math.round(m[1]*x))),P=(m[0]-r.clientWidth/2)/(r.clientWidth/2),w=-(m[1]-r.clientHeight/2)/(r.clientHeight/2),M=f.origin;let C;if(M){const e=G(g,M,h);C=p.mulMat4(_,e,c)}else C=p.mulMat4(_,g,c);const E=p.inverseMat4(C,u);t[0]=P,t[1]=w,t[2]=-1,t[3]=1;let A=p.transformVec4(E,t);A=p.mulVec4Scalar(A,1/A[3]),i[0]=P,i[1]=w,i[2]=1,i[3]=1;let D=p.transformVec4(E,i);D=p.mulVec4Scalar(D,1/D[3]);const T=p.subVec3(D,A,n),S=p.addVec3(A,p.mulVec4Scalar(T,y,a),l);M&&p.addVec3(S,M),b.worldPos=S}}();this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new ce(e,y),this._occlusionTester.addMarker(t),e.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(e){this._occlusionTester.markerWorldPosUpdated(e)},this.removeMarker=function(e){this._occlusionTester.removeMarker(e)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){C(),this._occlusionTester.bindRenderBuf(),s.reset(),s.backfaces=!0,s.frontface=!0,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in h)if(h.hasOwnProperty(e)){const t=h[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.drawOcclusion&&!0!==i.culled&&!1!==i.visible&&!1!==i.pickable&&i.drawOcclusion(s)}}this._occlusionTester.drawMarkers(s),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(e,t,i,s){const r=y.getRenderBuffer("snapshot");let o,n,a,l;for(r.bind(),r.clear(),this.render({force:!0,opaqueOnly:s}),n=0;n<i;n++)a=2*n,l=4*n,o=r.read(e[a],e[a+1]),t[l]=o[0],t[l+1]=o[1],t[l+2]=o[2],t[l+3]=o[3];r.unbind(),m=!0},this.beginSnapshot=function(){const e=y.getRenderBuffer("snapshot");e.bind(),e.clear(),P=!0},this.renderSnapshot=function(){if(!P)return;y.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),m=!0},this.readSnapshot=function(e){return y.getRenderBuffer("snapshot").readImage(e)},this.endSnapshot=function(){if(!P)return;y.getRenderBuffer("snapshot").unbind(),P=!1},this.destroy=function(){h={},c={},y.destroy(),w.destroy(),M.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class ts extends T{constructor(e,t={}){super(e,t),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=t.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=p.vec2(),this._keyboardEventsElement=t.keyboardEventsElement||document,this._bindEvents()}_bindEvents(){if(!this._eventsBound){this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=e=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===this.KEY_CTRL?this.ctrlDown=!0:e.keyCode===this.KEY_ALT?this.altDown=!0:e.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[e.keyCode]=!0,this.fire("keydown",e.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=e=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===this.KEY_CTRL?this.ctrlDown=!1:e.keyCode===this.KEY_ALT?this.altDown=!1:e.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[e.keyCode]=!1,this.fire("keyup",e.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=e=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(e),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=e=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(e),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=e=>{if(this.enabled){switch(e.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0}this._getMouseCanvasPos(e),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=e=>{if(this.enabled){switch(e.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=e=>{if(this.enabled){switch(e.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(e),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=e=>{if(this.enabled){switch(e.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(e),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault()}}),this.element.addEventListener("mousemove",this._mouseMoveListener=e=>{this.enabled&&(this._getMouseCanvasPos(e),this.fire("mousemove",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault())}),this.element.addEventListener("wheel",this._mouseWheelListener=(e,t)=>{if(!this.enabled)return;const i=Math.max(-1,Math.min(1,40*-e.deltaY));this.fire("mousewheel",i,!0)},{passive:!0});{let e,t;const i=2;this.on("mousedown",(i=>{e=i[0],t=i[1]})),this.on("mouseup",(s=>{e>=s[0]-i&&e<=s[0]+i&&t>=s[1]-i&&t<=s[1]+i&&this.fire("mouseclicked",s,!0)}))}this._eventsBound=!0}}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getMouseCanvasPos(e){if(e){let t=e.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;this.mouseCanvasPos[0]=e.pageX-i,this.mouseCanvasPos[1]=e.pageY-s}else e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}getEnabled(){return this.enabled}setKeyboardEnabled(e){this.keyboardEnabled=e}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}class is extends T{get type(){return"Viewport"}constructor(e,t={}){super(e,t),this._state=new Ke({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(e){const t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class ss extends T{get type(){return"Light"}get isLight(){return!0}constructor(e,t={}){super(e,t)}}class rs extends ss{get type(){return"DirLight"}constructor(e,t={}){super(e,t),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=i.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=s.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new Ke({type:"dir",dir:p.vec3([1,1,1]),color:p.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=p.identityMat4());const e=this.scene.camera,t=this._state.dir,i=e.look,s=[i[0]-t[0],i[1]-t[1],i[2]-t[2]],r=[0,1,0];p.lookAtMat4v(s,i,r,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=p.identityMat4()),p.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new ye(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class os extends ss{get type(){return"AmbientLight"}constructor(e,t={}){super(e,t),this._state={type:"ambient",color:p.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){this._state.intensity=void 0!==e?e:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class ns extends T{get type(){return"Geometry"}get isGeometry(){return!0}constructor(e,t={}){super(e,t),f.memory.meshes++}destroy(){super.destroy(),f.memory.meshes--}}const as=f.memory,ls=p.AABB3();class hs extends ns{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Ke({compressGeometry:!!t.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(this._state.compressGeometry){const e=rt.getPositionsBounds(t.positions),s=rt.compressPositions(t.positions,e.min,e.max);i.positions=s.quantized,i.positionsDecodeMatrix=s.decodeMatrix}else i.positions=t.positions.constructor===Float32Array?t.positions:new Float32Array(t.positions);if(t.colors&&(i.colors=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors)),t.uv)if(this._state.compressGeometry){const e=rt.getUVBounds(t.uv),s=rt.compressUVs(t.uv,e.min,e.max);i.uv=s.quantized,i.uvDecodeMatrix=s.decodeMatrix}else i.uv=t.uv.constructor===Float32Array?t.uv:new Float32Array(t.uv);t.normals&&(this._state.compressGeometry?i.normals=rt.compressNormals(t.normals):i.normals=t.normals.constructor===Float32Array?t.normals:new Float32Array(t.normals)),t.indices&&(i.indices=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices),"triangles"===this._state.primitiveName&&(this._numTriangles=t.indices.length/3)),this._buildHash(),as.meshes++,this._buildVBOs()}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new ne(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),as.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new ne(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),as.positions+=e.positionsBuf.numItems),e.normals){let i=e.compressGeometry;e.normalsBuf=new ne(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),as.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new ne(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),as.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new ne(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),as.uvs+=e.uvBuf.numItems)}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=Me(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new ne(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),as.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=p.buildPickTriangles(e.positions,e.indices,e.compressGeometry),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new ne(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new ne(t,t.ARRAY_BUFFER,r,r.length,4,t.STATIC_DRAW,!0),as.positions+=this._pickTrianglePositionsBuf.numItems,as.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),rt.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.compressGeometry){const i=rt.getPositionsBounds(e),s=rt.compressPositions(e,i.min,i.max);e=s.quantized,t.positionsDecodeMatrix=s.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),rt.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),rt.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=p.AABB3()),p.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=p.OBB3()),p.positions3ToAABB3(this._state.positions,ls,this._state.positionsDecodeMatrix),p.AABB3ToOBB3(ls,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),as.meshes--}}function cs(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=e.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=e.center,o=r?r[0]:0,n=r?r[1]:0,a=r?r[2]:0,l=-t+o,h=-i+n,c=-s+a,u=t+o,d=i+n,p=s+a;return v.apply(e,{positions:[u,d,p,l,d,p,l,h,p,u,h,p,u,d,p,u,h,p,u,h,c,u,d,c,u,d,p,u,d,c,l,d,c,l,d,p,l,d,p,l,d,c,l,h,c,l,h,p,l,h,c,u,h,c,u,h,p,l,h,p,u,h,c,l,h,c,l,d,c,u,d,c],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}class us extends T{get type(){return"Material"}constructor(e,t={}){super(e,t),f.memory.materials++}destroy(){super.destroy(),f.memory.materials--}}const ds={opaque:0,mask:1,blend:2},ps=["opaque","mask","blend"];class fs extends us{get type(){return"PhongMaterial"}constructor(e,t={}){super(e,t),this._state=new Ke({type:"PhongMaterial",ambient:p.vec3([1,1,1]),diffuse:p.vec3([1,1,1]),specular:p.vec3([1,1,1]),emissive:p.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.alpha=t.alpha,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,t.ambientMap&&(this._ambientMap=this._checkComponent("Texture",t.ambientMap)),t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",t.reflectivityMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",t.diffuseFresnel)),t.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",t.specularFresnel)),t.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",t.emissiveFresnel)),t.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",t.alphaFresnel)),t.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",t.reflectivityFresnel)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this._makeHash()}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=void 0!==e?e:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=void 0!==e?e:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){let t=ds[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return ps[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const ms={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class gs extends us{get type(){return"EmphasisMaterial"}get presets(){return ms}constructor(e,t={}){super(e,t),this._state=new Ke({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),this._preset="default",t.preset?(this.preset=t.preset,void 0!==t.fill&&(this.fill=t.fill),t.fillColor&&(this.fillColor=t.fillColor),void 0!==t.fillAlpha&&(this.fillAlpha=t.fillAlpha),void 0!==t.edges&&(this.edges=t.edges),t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth),void 0!==t.backfaces&&(this.backfaces=t.backfaces),void 0!==t.glowThrough&&(this.glowThrough=t.glowThrough)):(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.backfaces=t.backfaces,this.glowThrough=t.glowThrough)}set fill(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=null!=e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set glowThrough(e){e=!1!==e,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw())}get glowThrough(){return this._state.glowThrough}set preset(e){if(e=e||"default",this._preset===e)return;const t=ms[e];t?(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.glowThrough=t.glowThrough,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(ms).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const _s={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class vs extends us{get type(){return"EdgeMaterial"}get presets(){return _s}constructor(e,t={}){super(e,t),this._state=new Ke({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",t.preset?(this.preset=t.preset,t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth)):(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth),this.edges=!1!==t.edges}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=_s[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(_s).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const bs={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class xs extends T{constructor(e,t={}){super(e,t),this._units="meters",this._scale=1,this._origin=p.vec3([0,0,0]),this.units=t.units,this.scale=t.scale,this.origin=t.origin}get unitsInfo(){return bs}set units(e){e||(e="meters");bs[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}get units(){return this._units}set scale(e){(e=e||1)<=0?this.error("scale value should be larger than zero"):(this._scale=e,this.fire("scale",this._scale))}get scale(){return this._scale}set origin(e){if(!e)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(e,t=p.vec3(3)){t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2]}realToWorldPos(e,t=p.vec3(3)){return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}class ys extends T{constructor(e,t={}){super(e,t);const i=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|mobile)\/?\s*(\.?\d+(\.\d+)*)/i),s=i&&"safari"===i[1].toLowerCase();this._supported=!s&&Y.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=t.enabled,this.kernelRadius=t.kernelRadius,this.intensity=t.intensity,this.bias=t.bias,this.scale=t.scale,this.minResolution=t.minResolution,this.numSamples=t.numSamples,this.blur=t.blur,this.blendCutoff=t.blendCutoff,this.blendFactor=t.blendFactor}get supported(){return this._supported}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported)return!1;if(!this._enabled)return!1;const e=this.scene.camera.projection;return"customProjection"!==e&&"frustum"!==e}get active(){return this._active}set kernelRadius(e){null==e&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(e){null==e&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}get intensity(){return this._intensity}set bias(e){null==e&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}get bias(){return this._bias}set scale(e){null==e&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}get scale(){return this._scale}set minResolution(e){null==e&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(e){null==e&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}get numSamples(){return this._numSamples}set blur(e){e=!1!==e,this._blur!==e&&(this._blur=e,this.glRedraw())}get blur(){return this._blur}set blendCutoff(e){null==e&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(e){null==e&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}const Ps={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class ws extends us{get type(){return"PointsMaterial"}get presets(){return Ps}constructor(e,t={}){super(e,t),this._state=new Ke({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),t.preset?(this.preset=t.preset,void 0!==t.pointSize&&(this.pointSize=t.pointSize),void 0!==t.roundPoints&&(this.roundPoints=t.roundPoints),void 0!==t.perspectivePoints&&(this.perspectivePoints=t.perspectivePoints),void 0!==t.minPerspectivePointSize&&(this.minPerspectivePointSize=t.minPerspectivePointSize),void 0!==t.maxPerspectivePointSize&&(this.maxPerspectivePointSize=t.minPerspectivePointSize)):(this._preset="default",this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize),this.filterIntensity=t.filterIntensity,this.minIntensity=t.minIntensity,this.maxIntensity=t.maxIntensity}set pointSize(e){this._state.pointSize=e||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(e){e=!1!==e,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(e){e=!1!==e,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(e){e=!1!==e,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}get filterIntensity(){return this._state.filterIntensity}set minIntensity(e){this._state.minIntensity=null!=e?e:0,this.glRedraw()}get minIntensity(){return this._state.minIntensity}set maxIntensity(e){this._state.maxIntensity=null!=e?e:1,this.glRedraw()}get maxIntensity(){return this._state.maxIntensity}set preset(e){if(e=e||"default",this._preset===e)return;const t=Ps[e];t?(this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Ps).join(", "))}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy()}}const Ms={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class Cs extends us{get type(){return"LinesMaterial"}get presets(){return Ms}constructor(e,t={}){super(e,t),this._state=new Ke({type:"LinesMaterial",lineWidth:null}),t.preset?(this.preset=t.preset,void 0!==t.lineWidth&&(this.lineWidth=t.lineWidth)):(this._preset="default",this.lineWidth=t.lineWidth)}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=Ms[e];t?(this.lineWidth=t.lineWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Ms).join(", "))}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function Es(e,t){const i={};let s,r;for(let o=0,n=t.length;o<n;o++)s=t[o],r=e.component[s],r?r.isEntity?i[s]=!0:e.warn("pick(): Component is not an Entity: "+s):e.warn("pick(): Component not found: "+s);return i}class As extends T{get type(){return"Scene"}constructor(e,t={}){super(null,t);const i=t.canvasElement||document.getElementById(t.canvasId);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";const s=!!t.transparent,r=!!t.alphaDepthMask;this._aabbDirty=!0,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.bitmaps={},this.lineSets={},this.realWorldOffset=t.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new Z(this,{dontClear:!0,canvas:i,spinnerElementId:t.spinnerElementId,transparent:s,webgl2:!1!==t.webgl2,contextAttr:t.contextAttr||{},backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,premultipliedAlpha:t.premultipliedAlpha}),this.canvas.on("boundary",(()=>{this.glRedraw()})),this.canvas.on("webglContextFailed",(()=>{alert("xeokit failed to find WebGL!")})),this._renderer=new es(this,{transparent:s,alphaDepthMask:r}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;let e=null;this.getHash=function(){if(e)return e;const t=this.sectionPlanes;if(0===t.length)return this.hash=";";const i=[];for(let e=0,s=t.length;e<s;e++)i.push("cp");return i.push(";"),e=i.join(""),e},this.addSectionPlane=function(t){this.sectionPlanes.push(t),e=null},this.removeSectionPlane=function(t){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===t.id)return this.sectionPlanes.splice(i,1),void(e=null)}},this._lightsState=new function(){const e=p.vec4([0,0,0,0]),t=p.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const e=[],t=this.lights;let s;for(let i=0,r=t.length;i<r;i++)s=t[i],e.push("/"),e.push(s.type),e.push("world"===s.space?"w":"v"),s.castsShadow&&e.push("sh");return this.lightMaps.length>0&&e.push("/lm"),this.reflectionMaps.length>0&&e.push("/rm"),e.push(";"),i=e.join(""),i},this.addLight=function(e){this.lights.push(e),s=null,i=null},this.removeLight=function(e){for(let t=0,r=this.lights.length;t<r;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),s&&s.id===e.id&&(s=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(let t=0,s=this.reflectionMaps.length;t<s;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(let t=0,s=this.lightMaps.length;t<s;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!s)for(let e=0,t=this.lights.length;e<t;e++){const t=this.lights[e];if("ambient"===t.type){s=t;break}}if(s){const e=s.color,i=s.intensity;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=i,t}return e}},this.input=new ts(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:t.keyboardEventsElement}),this.metrics=new xs(this,{units:t.units,scale:t.scale,origin:t.origin}),this.sao=new ys(this,{enabled:t.saoEnabled}),this.ticksPerRender=t.ticksPerRender,this.ticksPerOcclusionTest=t.ticksPerOcclusionTest,this.passes=t.passes,this.clearEachPass=t.clearEachPass,this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.gammaFactor=t.gammaFactor,this._entityOffsetsEnabled=!!t.entityOffsetsEnabled,this._pickSurfacePrecisionEnabled=!!t.pickSurfacePrecisionEnabled,this._logarithmicDepthBufferEnabled=!!t.logarithmicDepthBufferEnabled,this._pbrEnabled=!!t.pbrEnabled,this._colorTextureEnabled=!1!==t.colorTextureEnabled,A._addScene(this),this._initDefaults(),this._viewport=new is(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new yt(this,{id:"default.camera",dontClear:!0}),new os(this,{color:[1,1,1],intensity:.7}),new rs(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new rs(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(()=>{this._renderer.imageDirty()}))}_initDefaults(){}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+v.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=p.createUUID();this.components[e.id]=e;const t=e.type;let i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}_removeComponent(e){var t=e.id,i=e.type;delete this.components[t];const s=this.types[i];s&&(delete s[t],v.isEmptyObject(s)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}_bitmapCreated(e){this.bitmaps[e.id]=e,this.scene.fire("bitmapCreated",e,!0)}_lineSetCreated(e){this.lineSets[e.id]=e,this.scene.fire("lineSetCreated",e,!0)}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}_bitmapDestroyed(e){delete this.bitmaps[e.id],this.scene.fire("bitmapDestroyed",e,!0)}_lineSetDestroyed(e){delete this.lineSets[e.id],this.scene.fire("lineSetDestroyed",e,!0)}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}_registerModel(e){this.models[e.id]=e,this._modelIds=null}_deregisterModel(e){const t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t)}_registerObject(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}_deregisterObject(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(e,t=!0){e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0)}_objectXRayedUpdated(e,t=!0){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null,t&&this.fire("objectXRayed",e,!0)}_objectHighlightedUpdated(e,t=!0){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null,t&&this.fire("objectHighlighted",e,!0)}_objectSelectedUpdated(e,t=!0){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null,t&&this.fire("objectSelected",e,!0)}_objectColorizeUpdated(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_objectOpacityUpdated(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}_objectOffsetUpdated(e,t){!t||0===t[0]&&0===t[1]&&0===t[2]?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}get capabilities(){return this._renderer.capabilities}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get pickSurfacePrecisionEnabled(){return this._pickSurfacePrecisionEnabled}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set pbrEnabled(e){this._pbrEnabled=!!e,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}set colorTextureEnabled(e){this._colorTextureEnabled=!!e,this.glRedraw()}get colorTextureEnabled(){return this._colorTextureEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(e){e&&A.runTasks();const t={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!e&&!this._renderer.needsRender())return;t.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let r,o;for(r=0;r<i;r++)t.pass=r,this.fire("rendering",t,!0),o=s||0===r,this._renderer.render({pass:r,clear:o,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{const t=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=p.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(e){null==e?e=1:(!v.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){null==e?e=20:(!v.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){null==e?e=1:(!v.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}get passes(){return this._passes}set clearEachPass(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){(e=!!e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){(e=null==e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||cs(hs)}get material(){return this.components["default.material"]||new fs(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new gs(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new gs(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new gs(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new vs(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new ws(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new Cs(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=p.vec3());const e=this.aabb;this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=p.AABB3());let e,t=p.MAX_DOUBLE,i=p.MAX_DOUBLE,s=p.MAX_DOUBLE,r=p.MIN_DOUBLE,o=p.MIN_DOUBLE,n=p.MIN_DOUBLE;const a=this._collidables;let l,h=!1;for(const c in a)if(a.hasOwnProperty(c)){if(l=a[c],!1===l.collidable)continue;e=l.aabb,e[0]<t&&(t=e[0]),e[1]<i&&(i=e[1]),e[2]<s&&(s=e[2]),e[3]>r&&(r=e[3]),e[4]>o&&(o=e[4]),e[5]>n&&(n=e[5]),h=!0}h||(t=-100,i=-100,s=-100,r=100,o=100,n=100),this._aabb[0]=t,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=o,this._aabb[5]=n,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e,t){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.matrix||e.origin&&e.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=e.includeEntities||e.include;i&&(e.includeEntityIds=Es(this,i));const s=e.excludeEntities||e.exclude;return s&&(e.excludeEntityIds=Es(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(t=this._renderer.pick(e,t))?(t.entity&&t.entity.fire&&t.entity.fire("picked",t),t):void 0}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}clearSectionPlanes(){const e=Object.keys(this.sectionPlanes);for(let t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}clearBitmaps(){const e=Object.keys(this.bitmaps);for(let t=0,i=e.length;t<i;t++)this.bitmaps[e[t]].destroy()}clearLines(){const e=Object.keys(this.lineSets);for(let t=0,i=e.length;t<i;t++)this.lineSets[e[t]].destroy()}getAABB(e){if(void 0===e)return this.aabb;if(v.isString(e)){const t=this.objects[e];if(t&&t.aabb)return t.aabb;e=[e]}if(0===e.length)return this.aabb;let t,i=p.MAX_DOUBLE,s=p.MAX_DOUBLE,r=p.MAX_DOUBLE,o=p.MIN_DOUBLE,n=p.MIN_DOUBLE,a=p.MIN_DOUBLE;if(this.withObjects(e,(e=>{if(e.collidable){const l=e.aabb;l[0]<i&&(i=l[0]),l[1]<s&&(s=l[1]),l[2]<r&&(r=l[2]),l[3]>o&&(o=l[3]),l[4]>n&&(n=l[4]),l[5]>a&&(a=l[5]),t=!0}})),t){const e=p.AABB3();return e[0]=i,e[1]=s,e[2]=r,e[3]=o,e[4]=n,e[5]=a,e}return this.aabb}setObjectsVisible(e,t){return this.withObjects(e,(e=>{const i=e.visible!==t;return e.visible=t,i}))}setObjectsCollidable(e,t){return this.withObjects(e,(e=>{const i=e.collidable!==t;return e.collidable=t,i}))}setObjectsCulled(e,t){return this.withObjects(e,(e=>{const i=e.culled!==t;return e.culled=t,i}))}setObjectsSelected(e,t){return this.withObjects(e,(e=>{const i=e.selected!==t;return e.selected=t,i}))}setObjectsHighlighted(e,t){return this.withObjects(e,(e=>{const i=e.highlighted!==t;return e.highlighted=t,i}))}setObjectsXRayed(e,t){return this.withObjects(e,(e=>{const i=e.xrayed!==t;return e.xrayed=t,i}))}setObjectsEdges(e,t){return this.withObjects(e,(e=>{const i=e.edges!==t;return e.edges=t,i}))}setObjectsColorized(e,t){return this.withObjects(e,(e=>{e.colorize=t}))}setObjectsOpacity(e,t){return this.withObjects(e,(e=>{const i=e.opacity!==t;return e.opacity=t,i}))}setObjectsPickable(e,t){return this.withObjects(e,(e=>{const i=e.pickable!==t;return e.pickable=t,i}))}setObjectsOffset(e,t){this.withObjects(e,(e=>{e.offset=t}))}withObjects(e,t){v.isString(e)&&(e=[e]);let i=!1;for(let s=0,r=e.length;s<r;s++){const r=e[s];let o=this.objects[r];if(o)i=t(o)||i;else{const e=this.modelIds;for(let s=0,n=e.length;s<n;s++){const n=e[s],a=p.globalizeObjectId(n,r);o=this.objects[a],o&&(i=t(o)||i)}}}return i}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Ds=1e3,Ts=1001,Ss=1002,Is=1003,Fs=1004,Ls=1005,Bs=1006,Rs=1007,ks=1008,Os=1008,Ns=1023,js=33776,Vs=33777,zs=33778,Us=33779,Gs=35840,Ws=35842,Hs=37492,Xs=37496,Ys=37808,qs=36492,$s=3e3,Zs=3001,Ks=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene._lightsState,r=e._geometry._state,o=e._state.billboard,n=e._state.stationary,a=i.sectionPlanes.length>0,l=!!r.compressGeometry,h=[];h.push("#version 300 es"),h.push("// Lambertian drawing vertex shader"),h.push("in vec3 position;"),h.push("uniform mat4 modelMatrix;"),h.push("uniform mat4 viewMatrix;"),h.push("uniform mat4 projMatrix;"),h.push("uniform vec4 colorize;"),h.push("uniform vec3 offset;"),l&&h.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(h.push("uniform float logDepthBufFC;"),h.push("out float vFragDepth;"),h.push("bool isPerspectiveMatrix(mat4 m) {"),h.push("    return (m[2][3] == - 1.0);"),h.push("}"),h.push("out float isPerspective;"));a&&h.push("out vec4 vWorldPosition;");if(h.push("uniform vec4 lightAmbient;"),h.push("uniform vec4 materialColor;"),h.push("uniform vec3 materialEmissive;"),r.normalsBuf){h.push("in vec3 normal;"),h.push("uniform mat4 modelNormalMatrix;"),h.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(h.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&h.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&h.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(h.push("uniform vec3 lightPos"+e+";"),h.push("uniform vec3 lightDir"+e+";")))}l&&(h.push("vec3 octDecode(vec2 oct) {"),h.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),h.push("    if (v.z < 0.0) {"),h.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),h.push("    }"),h.push("    return normalize(v);"),h.push("}"))}h.push("out vec4 vColor;"),"points"===r.primitiveName&&h.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(h.push("void billboard(inout mat4 mat) {"),h.push("   mat[0][0] = 1.0;"),h.push("   mat[0][1] = 0.0;"),h.push("   mat[0][2] = 0.0;"),"spherical"===o&&(h.push("   mat[1][0] = 0.0;"),h.push("   mat[1][1] = 1.0;"),h.push("   mat[1][2] = 0.0;")),h.push("   mat[2][0] = 0.0;"),h.push("   mat[2][1] = 0.0;"),h.push("   mat[2][2] =1.0;"),h.push("}"));h.push("void main(void) {"),h.push("vec4 localPosition = vec4(position, 1.0); "),h.push("vec4 worldPosition;"),l&&h.push("localPosition = positionsDecodeMatrix * localPosition;");r.normalsBuf&&(l?h.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):h.push("vec4 localNormal = vec4(normal, 0.0); "),h.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),h.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));h.push("mat4 viewMatrix2 = viewMatrix;"),h.push("mat4 modelMatrix2 = modelMatrix;"),n&&h.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(h.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),h.push("billboard(modelMatrix2);"),h.push("billboard(viewMatrix2);"),h.push("billboard(modelViewMatrix);"),r.normalsBuf&&(h.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),h.push("billboard(modelNormalMatrix2);"),h.push("billboard(viewNormalMatrix2);"),h.push("billboard(modelViewNormalMatrix);")),h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r.normalsBuf&&h.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(h.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),h.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),h.push("float lambertian = 1.0;"),r.normalsBuf)for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?h.push("viewLightDir = normalize(lightDir"+e+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?h.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):h.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?h.push("viewLightDir = normalize(lightDir"+e+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);")}h.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),h.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}h.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),a&&h.push("vWorldPosition = worldPosition;");"points"===r.primitiveName&&h.push("gl_PointSize = pointSize;");h.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(h.push("vFragDepth = 1.0 + clipPos.w;"),h.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return h.push("gl_Position = clipPos;"),h.push("}"),h}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState;e._material._state;const s=e._geometry._state,r=i.sectionPlanes.length>0,o=t.gammaOutput,n=[];n.push("#version 300 es"),n.push("// Lambertian drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;"));if(r){n.push("in vec4 vWorldPosition;"),n.push("uniform bool clippable;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}n.push("in vec4 vColor;"),o&&(n.push("uniform float gammaFactor;"),n.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}"points"===s.primitiveName&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}"));t.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");o?n.push("outColor = linearToGamma(vColor, gammaFactor);"):n.push("outColor = vColor;");return n.push("}"),n}(e)):(this.vertex=function(e){const t=e.scene;e._material;const i=e._state,s=t._sectionPlanesState,r=e._geometry._state,o=t._lightsState;let n;const a=i.billboard,l=i.background,h=i.stationary,c=function(e){if(!e._geometry._state.uvBuf)return!1;const t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),u=er(e),d=s.sectionPlanes.length>0,p=Js(e),f=!!r.compressGeometry,m=[];m.push("#version 300 es"),m.push("// Drawing vertex shader"),m.push("in  vec3 position;"),f&&m.push("uniform mat4 positionsDecodeMatrix;");m.push("uniform  mat4 modelMatrix;"),m.push("uniform  mat4 viewMatrix;"),m.push("uniform  mat4 projMatrix;"),m.push("out  vec3 vViewPosition;"),m.push("uniform  vec3 offset;"),d&&m.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(m.push("uniform float logDepthBufFC;"),m.push("out float vFragDepth;"),m.push("bool isPerspectiveMatrix(mat4 m) {"),m.push("    return (m[2][3] == - 1.0);"),m.push("}"),m.push("out float isPerspective;"));o.lightMaps.length>0&&m.push("out    vec3 vWorldNormal;");if(u){m.push("in  vec3 normal;"),m.push("uniform    mat4 modelNormalMatrix;"),m.push("uniform    mat4 viewNormalMatrix;"),m.push("out    vec3 vViewNormal;");for(let e=0,t=o.lights.length;e<t;e++)n=o.lights[e],"ambient"!==n.type&&("dir"===n.type&&m.push("uniform vec3 lightDir"+e+";"),"point"===n.type&&m.push("uniform vec3 lightPos"+e+";"),"spot"===n.type&&(m.push("uniform vec3 lightPos"+e+";"),m.push("uniform vec3 lightDir"+e+";")),"dir"===n.type&&"view"===n.space||m.push("out vec4 vViewLightReverseDirAndDist"+e+";"));f&&(m.push("vec3 octDecode(vec2 oct) {"),m.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),m.push("    if (v.z < 0.0) {"),m.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),m.push("    }"),m.push("    return normalize(v);"),m.push("}"))}c&&(m.push("in vec2 uv;"),m.push("out vec2 vUV;"),f&&m.push("uniform mat3 uvDecodeMatrix;"));r.colors&&(m.push("in vec4 color;"),m.push("out vec4 vColor;"));"points"===r.primitiveName&&m.push("uniform float pointSize;");"spherical"!==a&&"cylindrical"!==a||(m.push("void billboard(inout mat4 mat) {"),m.push("   mat[0][0] = 1.0;"),m.push("   mat[0][1] = 0.0;"),m.push("   mat[0][2] = 0.0;"),"spherical"===a&&(m.push("   mat[1][0] = 0.0;"),m.push("   mat[1][1] = 1.0;"),m.push("   mat[1][2] = 0.0;")),m.push("   mat[2][0] = 0.0;"),m.push("   mat[2][1] = 0.0;"),m.push("   mat[2][2] =1.0;"),m.push("}"));if(p){m.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(m.push("uniform mat4 shadowViewMatrix"+e+";"),m.push("uniform mat4 shadowProjMatrix"+e+";"),m.push("out vec4 vShadowPosFromLight"+e+";"))}m.push("void main(void) {"),m.push("vec4 localPosition = vec4(position, 1.0); "),m.push("vec4 worldPosition;"),f&&m.push("localPosition = positionsDecodeMatrix * localPosition;");u&&(f?m.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):m.push("vec4 localNormal = vec4(normal, 0.0); "),m.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),m.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));m.push("mat4 viewMatrix2           = viewMatrix;"),m.push("mat4 modelMatrix2          = modelMatrix;"),h?m.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):l&&m.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);");"spherical"===a||"cylindrical"===a?(m.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),m.push("billboard(modelMatrix2);"),m.push("billboard(viewMatrix2);"),m.push("billboard(modelViewMatrix);"),u&&(m.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),m.push("billboard(modelNormalMatrix2);"),m.push("billboard(viewNormalMatrix2);"),m.push("billboard(modelViewNormalMatrix);")),m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("worldPosition.xyz = worldPosition.xyz + offset;"),m.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(m.push("worldPosition = modelMatrix2 * localPosition;"),m.push("worldPosition.xyz = worldPosition.xyz + offset;"),m.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(u){m.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&m.push("vWorldNormal = worldNormal;"),m.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),m.push("vec3 tmpVec3;"),m.push("float lightDist;");for(let e=0,t=o.lights.length;e<t;e++)n=o.lights[e],"ambient"!==n.type&&("dir"===n.type&&"world"===n.space&&(m.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+e+", 0.0) ).xyz;"),m.push("vViewLightReverseDirAndDist"+e+" = vec4(-tmpVec3, 0.0);")),"point"===n.type&&("world"===n.space?(m.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+e+", 1.0)).xyz - viewPosition.xyz;"),m.push("lightDist = abs(length(tmpVec3));")):(m.push("tmpVec3 = lightPos"+e+".xyz - viewPosition.xyz;"),m.push("lightDist = abs(length(tmpVec3));")),m.push("vViewLightReverseDirAndDist"+e+" = vec4(tmpVec3, lightDist);")))}c&&(f?m.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):m.push("vUV = uv;"));r.colors&&m.push("vColor = color;");"points"===r.primitiveName&&m.push("gl_PointSize = pointSize;");d&&m.push("vWorldPosition = worldPosition;");m.push("   vViewPosition = viewPosition.xyz;"),m.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(m.push("vFragDepth = 1.0 + clipPos.w;"),m.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));l&&m.push("clipPos.z = clipPos.w;");if(m.push("gl_Position = clipPos;"),p){m.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),m.push("vec4 tempx; ");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&m.push("vShadowPosFromLight"+e+" = texUnitConverter * shadowProjMatrix"+e+" * (shadowViewMatrix"+e+" * worldPosition); ")}return m.push("}"),m}(e),this.fragment=function(e){const t=e.scene;t.canvas.gl;const i=e._material,s=e._geometry._state,r=e.scene._sectionPlanesState,o=e.scene._lightsState,n=e._material._state,a=r.sectionPlanes.length>0,l=er(e),h=s.uvBuf,c="PhongMaterial"===n.type,u="MetallicMaterial"===n.type,d="SpecularMaterial"===n.type,p=Js(e);t.gammaInput;const f=t.gammaOutput,m=[];m.push("#version 300 es"),m.push("// Drawing fragment shader"),m.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),m.push("precision highp float;"),m.push("precision highp int;"),m.push("#else"),m.push("precision mediump float;"),m.push("precision mediump int;"),m.push("#endif"),t.logarithmicDepthBufferEnabled&&(m.push("in float isPerspective;"),m.push("uniform float logDepthBufFC;"),m.push("in float vFragDepth;"));p&&(m.push("float unpackDepth (vec4 color) {"),m.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),m.push("  return dot(color, bitShift);"),m.push("}"));m.push("uniform float gammaFactor;"),m.push("vec4 linearToLinear( in vec4 value ) {"),m.push("  return value;"),m.push("}"),m.push("vec4 sRGBToLinear( in vec4 value ) {"),m.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),m.push("}"),m.push("vec4 gammaToLinear( in vec4 value) {"),m.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),m.push("}"),f&&(m.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),m.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),m.push("}"));if(a){m.push("in vec4 vWorldPosition;"),m.push("uniform bool clippable;");for(var g=0;g<r.sectionPlanes.length;g++)m.push("uniform bool sectionPlaneActive"+g+";"),m.push("uniform vec3 sectionPlanePos"+g+";"),m.push("uniform vec3 sectionPlaneDir"+g+";")}l&&(o.lightMaps.length>0&&(m.push("uniform samplerCube lightMap;"),m.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&m.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&m.push("uniform mat4 viewMatrix;"),m.push("#define PI 3.14159265359"),m.push("#define RECIPROCAL_PI 0.31830988618"),m.push("#define RECIPROCAL_PI2 0.15915494"),m.push("#define EPSILON 1e-6"),m.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),m.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),m.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),m.push("}"),m.push("struct IncidentLight {"),m.push("   vec3 color;"),m.push("   vec3 direction;"),m.push("};"),m.push("struct ReflectedLight {"),m.push("   vec3 diffuse;"),m.push("   vec3 specular;"),m.push("};"),m.push("struct Geometry {"),m.push("   vec3 position;"),m.push("   vec3 viewNormal;"),m.push("   vec3 worldNormal;"),m.push("   vec3 viewEyeDir;"),m.push("};"),m.push("struct Material {"),m.push("   vec3    diffuseColor;"),m.push("   float   specularRoughness;"),m.push("   vec3    specularColor;"),m.push("   float   shine;"),m.push("};"),c&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(m.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(m.push("   vec3 irradiance = "+Qs[o.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),m.push("   irradiance *= PI;"),m.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(m.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),m.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),m.push("   radiance *= PI;"),m.push("   reflectedLight.specular     += radiance;")),m.push("}")),m.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),m.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),m.push("   vec3 irradiance = dotNL * directLight.color * PI;"),m.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),m.push("}")),(u||d)&&(m.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),m.push("   float r = ggxRoughness + 0.0001;"),m.push("   return (2.0 / (r * r) - 2.0);"),m.push("}"),m.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),m.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),m.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),m.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),m.push("}"),o.reflectionMaps.length>0&&(m.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),m.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),m.push("   vec3 envMapColor = "+Qs[o.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),m.push("  return envMapColor;"),m.push("}")),m.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),m.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),m.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),m.push("}"),m.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),m.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),m.push("   return 1.0 / ( gl * gv );"),m.push("}"),m.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),m.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),m.push("   return 0.5 / max( gv + gl, EPSILON );"),m.push("}"),m.push("float D_GGX(const in float alpha, const in float dotNH) {"),m.push("   float a2 = ( alpha * alpha );"),m.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),m.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),m.push("}"),m.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),m.push("   float alpha = ( roughness * roughness );"),m.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),m.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),m.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),m.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),m.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),m.push("   vec3  F = F_Schlick( specularColor, dotLH );"),m.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),m.push("   float D = D_GGX( alpha, dotNH );"),m.push("   return F * (G * D);"),m.push("}"),m.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),m.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),m.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),m.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),m.push("   vec4 r = roughness * c0 + c1;"),m.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),m.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),m.push("   return specularColor * AB.x + AB.y;"),m.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(m.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(m.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),m.push("   irradiance *= PI;"),m.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(m.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),m.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),m.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),m.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),m.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),m.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),m.push("}")),m.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),m.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),m.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),m.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),m.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),m.push("}")));m.push("in vec3 vViewPosition;"),s.colors&&m.push("in vec4 vColor;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&m.push("in vec2 vUV;");l&&(o.lightMaps.length>0&&m.push("in vec3 vWorldNormal;"),m.push("in vec3 vViewNormal;"));n.ambient&&m.push("uniform vec3 materialAmbient;");n.baseColor&&m.push("uniform vec3 materialBaseColor;");void 0!==n.alpha&&null!==n.alpha&&m.push("uniform vec4 materialAlphaModeCutoff;");n.emissive&&m.push("uniform vec3 materialEmissive;");n.diffuse&&m.push("uniform vec3 materialDiffuse;");void 0!==n.glossiness&&null!==n.glossiness&&m.push("uniform float materialGlossiness;");void 0!==n.shininess&&null!==n.shininess&&m.push("uniform float materialShininess;");n.specular&&m.push("uniform vec3 materialSpecular;");void 0!==n.metallic&&null!==n.metallic&&m.push("uniform float materialMetallic;");void 0!==n.roughness&&null!==n.roughness&&m.push("uniform float materialRoughness;");void 0!==n.specularF0&&null!==n.specularF0&&m.push("uniform float materialSpecularF0;");h&&i._ambientMap&&(m.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&m.push("uniform mat4 ambientMapMatrix;"));h&&i._baseColorMap&&(m.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&m.push("uniform mat4 baseColorMapMatrix;"));h&&i._diffuseMap&&(m.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&m.push("uniform mat4 diffuseMapMatrix;"));h&&i._emissiveMap&&(m.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&m.push("uniform mat4 emissiveMapMatrix;"));l&&h&&i._metallicMap&&(m.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&m.push("uniform mat4 metallicMapMatrix;"));l&&h&&i._roughnessMap&&(m.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&m.push("uniform mat4 roughnessMapMatrix;"));l&&h&&i._metallicRoughnessMap&&(m.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&m.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(m.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&m.push("uniform mat4 normalMapMatrix;"),m.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),m.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),m.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),m.push("      vec2 st0 = dFdx( uv.st );"),m.push("      vec2 st1 = dFdy( uv.st );"),m.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),m.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),m.push("      vec3 N = normalize( surf_norm );"),m.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),m.push("      mat3 tsn = mat3( S, T, N );"),m.push("      return normalize( tsn * mapN );"),m.push("}"));h&&i._occlusionMap&&(m.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&m.push("uniform mat4 occlusionMapMatrix;"));h&&i._alphaMap&&(m.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&m.push("uniform mat4 alphaMapMatrix;"));l&&h&&i._specularMap&&(m.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&m.push("uniform mat4 specularMapMatrix;"));l&&h&&i._glossinessMap&&(m.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&m.push("uniform mat4 glossinessMapMatrix;"));l&&h&&i._specularGlossinessMap&&(m.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&m.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(m.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),m.push("    float fr = abs(dot(eyeDir, normal));"),m.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),m.push("    return pow(finalFr, power);"),m.push("}"),i._diffuseFresnel&&(m.push("uniform float  diffuseFresnelCenterBias;"),m.push("uniform float  diffuseFresnelEdgeBias;"),m.push("uniform float  diffuseFresnelPower;"),m.push("uniform vec3   diffuseFresnelCenterColor;"),m.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(m.push("uniform float  specularFresnelCenterBias;"),m.push("uniform float  specularFresnelEdgeBias;"),m.push("uniform float  specularFresnelPower;"),m.push("uniform vec3   specularFresnelCenterColor;"),m.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(m.push("uniform float  alphaFresnelCenterBias;"),m.push("uniform float  alphaFresnelEdgeBias;"),m.push("uniform float  alphaFresnelPower;"),m.push("uniform vec3   alphaFresnelCenterColor;"),m.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(m.push("uniform float  materialSpecularF0FresnelCenterBias;"),m.push("uniform float  materialSpecularF0FresnelEdgeBias;"),m.push("uniform float  materialSpecularF0FresnelPower;"),m.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),m.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(m.push("uniform float  emissiveFresnelCenterBias;"),m.push("uniform float  emissiveFresnelEdgeBias;"),m.push("uniform float  emissiveFresnelPower;"),m.push("uniform vec3   emissiveFresnelCenterColor;"),m.push("uniform vec3   emissiveFresnelEdgeColor;")));if(m.push("uniform vec4   lightAmbient;"),l)for(let e=0,t=o.lights.length;e<t;e++){const t=o.lights[e];"ambient"!==t.type&&(m.push("uniform vec4 lightColor"+e+";"),"point"===t.type&&m.push("uniform vec3 lightAttenuation"+e+";"),"dir"===t.type&&"view"===t.space&&m.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&"view"===t.space?m.push("uniform vec3 lightPos"+e+";"):m.push("in vec4 vViewLightReverseDirAndDist"+e+";"))}if(p)for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(m.push("in vec4 vShadowPosFromLight"+e+";"),m.push("uniform sampler2D shadowMap"+e+";"));if(m.push("uniform vec4 colorize;"),m.push("out vec4 outColor;"),m.push("void main(void) {"),a){m.push("if (clippable) {"),m.push("  float dist = 0.0;");for(g=0;g<r.sectionPlanes.length;g++)m.push("if (sectionPlaneActive"+g+") {"),m.push("   dist += clamp(dot(-sectionPlaneDir"+g+".xyz, vWorldPosition.xyz - sectionPlanePos"+g+".xyz), 0.0, 1000.0);"),m.push("}");m.push("  if (dist > 0.0) { discard; }"),m.push("}")}"points"===s.primitiveName&&(m.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),m.push("float r = dot(cxy, cxy);"),m.push("if (r > 1.0) {"),m.push("   discard;"),m.push("}"));m.push("float occlusion = 1.0;"),n.ambient?m.push("vec3 ambientColor = materialAmbient;"):m.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");n.diffuse?m.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?m.push("vec3 diffuseColor = materialBaseColor;"):m.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");s.colors&&m.push("diffuseColor *= vColor.rgb;");n.emissive?m.push("vec3 emissiveColor = materialEmissive;"):m.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");n.specular?m.push("vec3 specular = materialSpecular;"):m.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==n.alpha?m.push("float alpha = materialAlphaModeCutoff[0];"):m.push("float alpha = 1.0;");s.colors&&m.push("alpha *= vColor.a;");void 0!==n.glossiness?m.push("float glossiness = materialGlossiness;"):m.push("float glossiness = 1.0;");void 0!==n.metallic?m.push("float metallic = materialMetallic;"):m.push("float metallic = 1.0;");void 0!==n.roughness?m.push("float roughness = materialRoughness;"):m.push("float roughness = 1.0;");void 0!==n.specularF0?m.push("float specularF0 = materialSpecularF0;"):m.push("float specularF0 = 1.0;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(m.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),m.push("vec2 textureCoord;"));h&&i._ambientMap&&(i._ambientMap._state.matrix?m.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),m.push("ambientTexel = "+Qs[i._ambientMap._state.encoding]+"(ambientTexel);"),m.push("ambientColor *= ambientTexel.rgb;"));h&&i._diffuseMap&&(i._diffuseMap._state.matrix?m.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),m.push("diffuseTexel = "+Qs[i._diffuseMap._state.encoding]+"(diffuseTexel);"),m.push("diffuseColor *= diffuseTexel.rgb;"),m.push("alpha *= diffuseTexel.a;"));h&&i._baseColorMap&&(i._baseColorMap._state.matrix?m.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),m.push("baseColorTexel = "+Qs[i._baseColorMap._state.encoding]+"(baseColorTexel);"),m.push("diffuseColor *= baseColorTexel.rgb;"),m.push("alpha *= baseColorTexel.a;"));h&&i._emissiveMap&&(i._emissiveMap._state.matrix?m.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),m.push("emissiveTexel = "+Qs[i._emissiveMap._state.encoding]+"(emissiveTexel);"),m.push("emissiveColor = emissiveTexel.rgb;"));h&&i._alphaMap&&(i._alphaMap._state.matrix?m.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("alpha *= texture(alphaMap, textureCoord).r;"));h&&i._occlusionMap&&(i._occlusionMap._state.matrix?m.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("occlusion *= texture(occlusionMap, textureCoord).r;"));if(l&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){h&&i._normalMap?(i._normalMap._state.matrix?m.push("textureCoord = (normalMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):m.push("vec3 viewNormal = normalize(vViewNormal);"),h&&i._specularMap&&(i._specularMap._state.matrix?m.push("textureCoord = (specularMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("specular *= texture(specularMap, textureCoord).rgb;")),h&&i._glossinessMap&&(i._glossinessMap._state.matrix?m.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("glossiness *= texture(glossinessMap, textureCoord).r;")),h&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?m.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),m.push("specular *= specGlossRGB.rgb;"),m.push("glossiness *= specGlossRGB.a;")),h&&i._metallicMap&&(i._metallicMap._state.matrix?m.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("metallic *= texture(metallicMap, textureCoord).r;")),h&&i._roughnessMap&&(i._roughnessMap._state.matrix?m.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("roughness *= texture(roughnessMap, textureCoord).r;")),h&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?m.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):m.push("textureCoord = texturePos.xy;"),m.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),m.push("metallic *= metalRoughRGB.b;"),m.push("roughness *= metalRoughRGB.g;")),m.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(m.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),m.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(m.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),m.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(m.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),m.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(m.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),m.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),m.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),m.push("   discard;"),m.push("}"),m.push("IncidentLight  light;"),m.push("Material       material;"),m.push("Geometry       geometry;"),m.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),m.push("vec3           viewLightDir;"),c&&(m.push("material.diffuseColor      = diffuseColor;"),m.push("material.specularColor     = specular;"),m.push("material.shine             = materialShininess;")),d&&(m.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),m.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),m.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),m.push("material.specularColor     = specular;")),u&&(m.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),m.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),m.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),m.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),m.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&m.push("geometry.worldNormal   = normalize(vWorldNormal);"),m.push("geometry.viewNormal    = viewNormal;"),m.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&m.push("computePhongLightMapping(geometry, material, reflectedLight);"),(d||u)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&m.push("computePBRLightMapping(geometry, material, reflectedLight);"),m.push("float shadow = 1.0;"),m.push("float shadowAcneRemover = 0.007;"),m.push("vec3 fragmentDepth;"),m.push("float texelSize = 1.0 / 1024.0;"),m.push("float amountInLight = 0.0;"),m.push("vec3 shadowCoord;"),m.push("vec4 rgbaDepth;"),m.push("float depth;");for(let e=0,t=o.lights.length;e<t;e++){const t=o.lights[e];"ambient"!==t.type&&("dir"===t.type&&"view"===t.space?m.push("viewLightDir = -normalize(lightDir"+e+");"):"point"===t.type&&"view"===t.space?m.push("viewLightDir = normalize(lightPos"+e+" - vViewPosition);"):m.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+e+".xyz);"),p&&t.castsShadow?(m.push("shadow = 0.0;"),m.push("fragmentDepth = vShadowPosFromLight"+e+".xyz;"),m.push("fragmentDepth.z -= shadowAcneRemover;"),m.push("for (int x = -3; x <= 3; x++) {"),m.push("  for (int y = -3; y <= 3; y++) {"),m.push("      float texelDepth = unpackDepth(texture(shadowMap"+e+", fragmentDepth.xy + vec2(x, y) * texelSize));"),m.push("      if (fragmentDepth.z < texelDepth) {"),m.push("          shadow += 1.0;"),m.push("      }"),m.push("  }"),m.push("}"),m.push("shadow = shadow / 9.0;"),m.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a * shadow);")):m.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a );"),m.push("light.direction = viewLightDir;"),c&&m.push("computePhongLighting(light, geometry, material, reflectedLight);"),(d||u)&&m.push("computePBRLighting(light, geometry, material, reflectedLight);"))}c?m.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):m.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else m.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),m.push("vec3 outgoingLight = emissiveColor + ambientColor;");m.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),f&&m.push("fragColor = linearToGamma(fragColor, gammaFactor);");m.push("outColor = fragColor;"),t.logarithmicDepthBufferEnabled&&m.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return m.push("}"),m}(e))},Qs={};function Js(e){if(!e.receivesShadow)return!1;const t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(let e=0,i=t.length;e<i;e++)if(t[e].castsShadow)return!0;return!1}function er(e){const t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}Qs[3e3]="linearToLinear",Qs[3001]="sRGBToLinear";const tr=p.vec3(),ir=new t({}),sr=function(e,t){this.id=ir.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Ks(t),this._allocate(t)},rr={};sr.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";");let s=rr[i];if(!s){if(s=new sr(i,e),s.errors)return console.log(s.errors.join("\n")),null;rr[i]=s,f.memory.programs++}return s._useCount++,s},sr.prototype.put=function(){0==--this._useCount&&(ir.removeItem(this.id),this._program&&this._program.destroy(),delete rr[this._hash],f.memory.programs--)},sr.prototype.webglContextRestored=function(){this._program=null},sr.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=Y.MAX_TEXTURE_UNITS,s=t.scene,r=t._material,o=s.canvas.gl,n=this._program,a=t._state,l=t._material._state,h=t._geometry._state,c=s.camera,u=t.origin,d=a.background;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,d&&o.depthFunc(o.LEQUAL),this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,u?e.getRTCViewMatrix(a.originHash,u):c.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,c.viewNormalMatrix),a.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const i=s._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const s=r.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,s?1:0),s){const s=i[t];o.uniform3fv(e.pos,u?H(s.dist,s.dir,u,tr):s.pos),o.uniform3fv(e.dir,s.dir)}}}}}if(l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;const t=l.backfaces;e.backfaces!==t&&(t?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=t);const s=l.frontface;switch(e.frontface!==s&&(s?o.frontFace(o.CCW):o.frontFace(o.CW),e.frontface=s),e.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(n.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,r._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(n.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,r._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const t=r._baseColorMap;t&&t._state.texture&&this._uBaseColorMap&&(n.bindTexture(this._uBaseColorMap,t._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,t._state.matrix));const s=r._metallicMap;s&&s._state.texture&&this._uMetallicMap&&(n.bindTexture(this._uMetallicMap,s._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,s._state.matrix));const a=r._roughnessMap;a&&a._state.texture&&this._uRoughnessMap&&(n.bindTexture(this._uRoughnessMap,a._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,a._state.matrix));const h=r._metallicRoughnessMap;h&&h._state.texture&&this._uMetallicRoughnessMap&&(n.bindTexture(this._uMetallicRoughnessMap,h._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,h._state.matrix)),(p=r._emissiveMap)&&p._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,p._state.matrix)),(f=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f._state.matrix)),(m=r._alphaMap)&&m._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,m._state.matrix)),(g=r._normalMap)&&g._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,g._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const c=r._diffuseMap;c&&c._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,c._state.matrix));const u=r._specularMap;u&&u._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,u._state.matrix));const d=r._glossinessMap;d&&d._state.texture&&this._uGlossinessMap&&(n.bindTexture(this._uGlossinessMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,d._state.matrix));const _=r._specularGlossinessMap;var p,f,m,g;_&&_._state.texture&&this._uSpecularGlossinessMap&&(n.bindTexture(this._uSpecularGlossinessMap,_._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,_._state.matrix)),(p=r._emissiveMap)&&p._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,p._state.matrix)),(f=r._occlusionMap)&&f._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,f._state.matrix)),(m=r._alphaMap)&&m._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,m._state.matrix)),(g=r._normalMap)&&g._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,g._state.matrix))}this._lastMaterialId=l.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,t.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),this._uColorize){const e=a.colorize,t=this._lastColorize;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]||(o.uniform4fv(this._uColorize,e),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3])}o.uniform3fv(this._uOffset,a.offset),h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),e.bindArray++),h.indicesBuf&&(h.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=h.id),h.indicesBuf?(o.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),e.drawElements++):h.positions&&(o.drawArrays(o.TRIANGLES,0,h.positions.numItems),e.drawArrays++),d&&o.depthFunc(o.LESS)},sr.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl,s=e._material,r=t._lightsState,o=t._sectionPlanesState,n=e._material._state;if(this._program=new oe(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=a.getLocation("uvDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC"));const l=r.lights;let h;for(var c=0,u=l.length;c<u;c++){switch(h=l[c],h.type){case"ambient":this._uLightAmbient[c]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[c]=a.getLocation("lightColor"+c),this._uLightPos[c]=null,this._uLightDir[c]=a.getLocation("lightDir"+c);break;case"point":this._uLightColor[c]=a.getLocation("lightColor"+c),this._uLightPos[c]=a.getLocation("lightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=a.getLocation("lightAttenuation"+c);break;case"spot":this._uLightColor[c]=a.getLocation("lightColor"+c),this._uLightPos[c]=a.getLocation("lightPos"+c),this._uLightDir[c]=a.getLocation("lightDir"+c),this._uLightAttenuation[c]=a.getLocation("lightAttenuation"+c)}h.castsShadow&&(this._uShadowViewMatrix[c]=a.getLocation("shadowViewMatrix"+c),this._uShadowProjMatrix[c]=a.getLocation("shadowProjMatrix"+c))}r.lightMaps.length>0&&(this._uLightMap="lightMap"),r.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(c=0,u=o.sectionPlanes.length;c<u;c++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+c),pos:a.getLocation("sectionPlanePos"+c),dir:a.getLocation("sectionPlaneDir"+c)});switch(this._uPointSize=a.getLocation("pointSize"),n.type){case"LambertMaterial":this._uMaterialColor=a.getLocation("materialColor"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=a.getLocation("materialAmbient"),this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=a.getLocation("materialShininess"),s._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=a.getLocation("ambientMapMatrix")),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=a.getLocation("reflectivityMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=a.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=a.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=a.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=a.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=a.getLocation("diffuseFresnelPower")),s._specularFresnel&&(this._uSpecularFresnelEdgeBias=a.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=a.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=a.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=a.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=a.getLocation("specularFresnelPower")),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias=a.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=a.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=a.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=a.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=a.getLocation("alphaFresnelPower")),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=a.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=a.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=a.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=a.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=a.getLocation("reflectivityFresnelPower")),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=a.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=a.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=a.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=a.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=a.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=a.getLocation("materialBaseColor"),this._uMaterialMetallic=a.getLocation("materialMetallic"),this._uMaterialRoughness=a.getLocation("materialRoughness"),this._uMaterialSpecularF0=a.getLocation("materialSpecularF0"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),s._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=a.getLocation("baseColorMapMatrix")),s._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=a.getLocation("metallicMapMatrix")),s._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=a.getLocation("roughnessMapMatrix")),s._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=a.getLocation("metallicRoughnessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialGlossiness=a.getLocation("materialGlossiness"),this._uMaterialReflectivity=a.getLocation("reflectivityFresnel"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),s._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=a.getLocation("glossinessMapMatrix")),s._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=a.getLocation("materialSpecularGlossinessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"))}this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aUV=a.getAttribute("uv"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._uClippable=a.getLocation("clippable"),this._uColorize=a.getLocation("colorize"),this._uOffset=a.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},sr.prototype._bindProgram=function(e){const t=Y.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,o=i.camera.project;let n;const a=this._program;if(a.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}for(var l=0,h=r.lights.length;l<h;l++)if(n=r.lights[l],this._uLightAmbient[l])s.uniform4f(this._uLightAmbient[l],n.color[0],n.color[1],n.color[2],n.intensity);else if(this._uLightColor[l]&&s.uniform4f(this._uLightColor[l],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[l]&&(s.uniform3fv(this._uLightPos[l],n.pos),this._uLightAttenuation[l]&&s.uniform1f(this._uLightAttenuation[l],n.attenuation)),this._uLightDir[l]&&s.uniform3fv(this._uLightDir[l],n.dir),n.castsShadow){this._uShadowViewMatrix[l]&&s.uniformMatrix4fv(this._uShadowViewMatrix[l],!1,n.getShadowViewMatrix()),this._uShadowProjMatrix[l]&&s.uniformMatrix4fv(this._uShadowProjMatrix[l],!1,n.getShadowProjMatrix());const i=n.getShadowRenderBuf();i&&(a.bindTexture("shadowMap"+l,i.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++)}r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(a.bindTexture(this._uLightMap,r.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(a.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=e.textureUnit};class or{constructor(e){this.vertex=function(e){const t=e.scene,i=t._lightsState,s=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),r=t._sectionPlanesState.sectionPlanes.length>0,o=!!e._geometry._state.compressGeometry,n=e._state.billboard,a=e._state.stationary,l=[];l.push("#version 300 es"),l.push("// EmphasisFillShaderSource vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),o&&l.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;"));r&&l.push("out vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(l.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&l.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&l.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&l.push("uniform vec3 lightPos"+e+";"))}o&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("out vec4 vColor;"),("spherical"===n||"cylindrical"===n)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===n&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),o&&l.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(o?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),a&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?l.push("viewLightDir = normalize(lightDir"+e+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else{if("point"!==t.type)continue;"view"===t.space?l.push("viewLightDir = normalize(lightPos"+e+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&l.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return l.push("gl_Position = clipPos;"),l.push("}"),l}(e),this.fragment=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene.gammaOutput,r=i.sectionPlanes.length>0,o=[];o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===e._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e)}}const nr=new t({}),ar=p.vec3(),lr=function(e,t){this.id=nr.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new or(t),this._allocate(t)},hr={};lr.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=hr[t];return i||(i=new lr(t,e),hr[t]=i,f.memory.programs++),i._useCount++,i},lr.prototype.put=function(){0==--this._useCount&&(nr.removeItem(this.id),this._program&&this._program.destroy(),delete hr[this._hash],f.memory.programs--)},lr.prototype.webglContextRestored=function(){this._program=null},lr.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene,r=s.camera,o=s.canvas.gl,n=0===i?t._xrayMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,l=t._geometry._state,h=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?e.getRTCViewMatrix(a.originHash,h):r.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const i=s._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const s=r.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,s?1:0),s){const s=i[t];o.uniform3fv(e.pos,h?H(s.dist,s.dir,h,ar):s.pos),o.uniform3fv(e.dir,s.dir)}}}}}if(n.id!==this._lastMaterialId){const t=n.fillColor,i=n.backfaces;e.backfaces!==i&&(i?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=i),o.uniform4f(this._uFillColor,t[0],t[1],t[2],n.fillAlpha),this._lastMaterialId=n.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,t.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),e.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),e.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++):l.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,l.positionsBuf.numItems),e.drawArrays++)},lr.prototype._allocate=function(e){const t=e.scene,i=t._lightsState,s=t._sectionPlanesState,r=t.canvas.gl;if(this._program=new oe(r,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let e=0,t=i.lights.length;e<t;e++){switch(i.lights[e].type){case"ambient":this._uLightAmbient[e]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[e]=o.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=o.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=o.getLocation("lightColor"+e),this._uLightPos[e]=o.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=o.getLocation("lightAttenuation"+e)}}this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+e),pos:o.getLocation("sectionPlanePos"+e),dir:o.getLocation("sectionPlaneDir"+e)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},lr.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState,r=t.camera,o=r.project;if(this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];this._uLightAmbient[e]?i.uniform4f(this._uLightAmbient[e],t.color[0],t.color[1],t.color[2],t.intensity):(this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class cr{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Edges drawing vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec4 edgeColor;"),n.push("uniform vec3 offset;"),s&&n.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));i&&n.push("out vec4 vWorldPosition;");n.push("out vec4 vColor;"),("spherical"===r||"cylindrical"===r)&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n.push("vColor = edgeColor;"),i&&n.push("vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene.gammaOutput,r=i.sectionPlanes.length>0,o=[];o.push("#version 300 es"),o.push("// Edges drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e)}}const ur=new t({}),dr=p.vec3(),pr=function(e,t){this.id=ur.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new cr(t),this._allocate(t)},fr={};pr.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=fr[t];return i||(i=new pr(t,e),fr[t]=i,f.memory.programs++),i._useCount++,i},pr.prototype.put=function(){0==--this._useCount&&(ur.removeItem(this.id),this._program&&this._program.destroy(),delete fr[this._hash],f.memory.programs--)},pr.prototype.webglContextRestored=function(){this._program=null},pr.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene,r=s.camera,o=s.canvas.gl;let n;const a=t._state,l=t._geometry,h=l._state,c=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(a.originHash,c):r.viewMatrix),a.clippable){const e=s._sectionPlanesState.sectionPlanes.length;if(e>0){const i=s._sectionPlanesState.sectionPlanes,r=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const s=r.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,s?1:0),s){const s=i[t];o.uniform3fv(e.pos,c?H(s.dist,s.dir,c,dr):s.pos),o.uniform3fv(e.dir,s.dir)}}}}}switch(i){case 0:n=t._xrayMaterial._state;break;case 1:n=t._highlightMaterial._state;break;case 2:n=t._selectedMaterial._state;break;default:n=t._edgeMaterial._state}if(n.id!==this._lastMaterialId){const t=n.backfaces;if(e.backfaces!==t&&(t?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=t),e.lineWidth!==n.edgeWidth&&(o.lineWidth(n.edgeWidth),e.lineWidth=n.edgeWidth),this._uEdgeColor){const e=n.edgeColor,t=n.edgeAlpha;o.uniform4f(this._uEdgeColor,e[0],e[1],e[2],t)}this._lastMaterialId=n.id}let u;o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),h.primitive===o.TRIANGLES?u=l._getEdgeIndices():h.primitive===o.LINES&&(u=h.indicesBuf),u&&(h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),e.bindArray++),u.bind(),e.bindArray++,this._lastGeometryId=h.id),o.drawElements(o.LINES,u.numItems,u.itemType,0),e.drawElements++)},pr.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new oe(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+e),pos:r.getLocation("sectionPlanePos"+e),dir:r.getLocation("sectionPlaneDir"+e)});this._uEdgeColor=r.getLocation("edgeColor"),this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},pr.prototype._bindProgram=function(e){const t=this._program,i=this._scene,s=i.canvas.gl,r=i.camera.project;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),i.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class mr{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Mesh picking vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("out vec4 vViewPosition;"),n.push("uniform vec3 offset;"),s&&n.push("uniform mat4 positionsDecodeMatrix;");i&&n.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==r&&"cylindrical"!==r||(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"));n.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),n.push("   worldPosition.xyz = worldPosition.xyz + offset;"),n.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&n.push("   vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("#version 300 es"),r.push("// Mesh picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(r.push("uniform vec4 pickColor;"),s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   outColor = pickColor; "),r.push("}"),r}(e)}}const gr=p.vec3(),_r=function(e,t){this._hash=e,this._shaderSource=new mr(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},vr={};_r.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=vr[t];if(!i){if(i=new _r(t,e),i.errors)return console.log(i.errors.join("\n")),null;vr[t]=i,f.memory.programs++}return i._useCount++,i},_r.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete vr[this._hash],f.memory.programs--)},_r.prototype.webglContextRestored=function(){this._program=null},_r.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._state,o=t._material._state,n=t._geometry._state,a=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCPickViewMatrix(r.originHash,a):e.pickViewMatrix),r.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const r=i._sectionPlanesState.sectionPlanes,o=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const i=o.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=r[t];s.uniform3fv(e.pos,a?H(i.dist,i.dir,a,gr):i.pos),s.uniform3fv(e.dir,i.dir)}}}}}if(o.id!==this._lastMaterialId){const t=o.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=o.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=o.id}s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=n.id);var l=t._state.pickID;const h=l>>24&255,c=l>>16&255,u=l>>8&255,d=255&l;s.uniform4f(this._uPickColor,d/255,u/255,c/255,h/255),n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&s.drawArrays(s.TRIANGLES,0,n.positions.numItems)},_r.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new oe(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uPickColor=s.getLocation("pickColor"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null},_r.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),e.useProgram++,t.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._lastMaterialId=null,this._lastGeometryId=null};class br{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry;e._state.billboard,e._state.stationary;const r=[];r.push("#version 300 es"),r.push("// Surface picking vertex shader"),r.push("in vec3 position;"),r.push("in vec4 color;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform vec3 offset;"),i&&(r.push("uniform bool clippable;"),r.push("out vec4 vWorldPosition;"));t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;"),r.push("bool isPerspectiveMatrix(mat4 m) {"),r.push("    return (m[2][3] == - 1.0);"),r.push("}"),r.push("out float isPerspective;"));r.push("out vec4 vColor;"),s&&r.push("uniform mat4 positionsDecodeMatrix;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),s&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("   vec4 worldPosition = modelMatrix * localPosition; "),r.push("   worldPosition.xyz = worldPosition.xyz + offset;"),r.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&r.push("   vWorldPosition = worldPosition;");r.push("   vColor = color;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return r.push("gl_Position = clipPos;"),r.push("}"),r}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("#version 300 es"),r.push("// Surface picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),r.push("in vec4 vColor;"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(let e=0;e<i.sectionPlanes.length;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0;e<i.sectionPlanes.length;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   outColor = vColor;"),r.push("}"),r}(e)}}const xr=p.vec3(),yr=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new br(t),this._allocate(t)},Pr={};yr.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=Pr[t];if(!i){if(i=new yr(t,e),i.errors)return console.log(i.errors.join("\n")),null;Pr[t]=i,f.memory.programs++}return i._useCount++,i},yr.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Pr[this._hash],f.memory.programs--)},yr.prototype.webglContextRestored=function(){this._program=null},yr.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._state,o=t._material._state,n=t._geometry,a=t._geometry._state,l=t.origin,h=o.backfaces,c=o.frontface,u=i.camera.project,d=n._getPickTrianglePositions(),p=n._getPickTriangleColors();if(this._program.bind(),e.useProgram++,i.logarithmicDepthBufferEnabled){const e=2/(Math.log(u.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}if(s.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCPickViewMatrix(r.originHash,l):e.pickViewMatrix),r.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const r=i._sectionPlanesState.sectionPlanes,o=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const i=o.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=r[t];s.uniform3fv(e.pos,l?H(i.dist,i.dir,l,xr):i.pos),s.uniform3fv(e.dir,i.dir)}}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),e.backfaces!==h&&(h?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=h),e.frontface!==c&&(c?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=c),s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(d,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(d),p.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,p.itemSize,p.itemType,!0,0,0),s.drawArrays(a.primitive,0,d.numItems/3)},yr.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new oe(i,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))};class wr{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.sectionPlanes.length>0,s=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Mesh occlusion vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec3 offset;"),s&&n.push("uniform mat4 positionsDecodeMatrix;");i&&n.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = 1.0;"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = 1.0;"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));i&&n.push("   vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("#version 300 es"),r.push("// Mesh occlusion fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}r.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("}"),r}(e)}}const Mr=p.vec3(),Cr=function(e,t){this._hash=e,this._shaderSource=new wr(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Er={};Cr.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.occlusionHash].join(";");let i=Er[t];if(!i){if(i=new Cr(t,e),i.errors)return console.log(i.errors.join("\n")),null;Er[t]=i,f.memory.programs++}return i._useCount++,i},Cr.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Er[this._hash],f.memory.programs--)},Cr.prototype.webglContextRestored=function(){this._program=null},Cr.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._material._state,o=t._state,n=t._geometry._state,a=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){const t=r.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=r.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=r.id}const l=i.camera;if(s.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCViewMatrix(o.originHash,a):l.viewMatrix),o.clippable){const e=i._sectionPlanesState.sectionPlanes.length;if(e>0){const r=i._sectionPlanesState.sectionPlanes,o=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e){const i=o.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=r[t];s.uniform3fv(e.pos,a?H(i.dist,i.dir,a,Mr):i.pos),s.uniform3fv(e.dir,i.dir)}}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=n.id),n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&s.drawArrays(s.TRIANGLES,0,n.positions.numItems)},Cr.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new oe(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Cr.prototype._bindProgram=function(e){const t=this._scene,i=t.camera.project,s=t.canvas.gl;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class Ar{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=[];s.push("// Mesh shadow vertex shader"),s.push("in vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform vec3 offset;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");t&&s.push("out vec4 vWorldPosition;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("worldPosition = modelMatrix * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&s.push("vWorldPosition = worldPosition;");return s.push("   gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){const t=e.scene;t.canvas.gl;const i=t._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];if(r.push("// Mesh shadow fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("vec4 encodeFloat( const in float depth ) {"),r.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),r.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),r.push("  vec4 comp = fract(depth * bitShift);"),r.push("  comp -= comp.xxyz * bitMask;"),r.push("  return comp;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("outColor = encodeFloat(gl_FragCoord.z);"),r.push("}"),r}(e)}}const Dr=function(e,t){this._hash=e,this._shaderSource=new Ar(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Tr={};Dr.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,t._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let s=Tr[i];if(!s){if(s=new Dr(i,e),s.errors)return console.log(s.errors.join("\n")),null;Tr[i]=s,f.memory.programs++}return s._useCount++,s},Dr.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Tr[this._hash],f.memory.programs--)},Dr.prototype.webglContextRestored=function(){this._program=null},Dr.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene.canvas.gl,s=t._material._state,r=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){const t=s.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const r=s.frontface;e.frontface!==r&&(r?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=r),e.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),e.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),r.combineGeometry){const s=t.vertexBufs;s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=s.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combineGeometry?r.indicesBufCombined&&(r.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=r.id),r.combineGeometry?r.indicesBufCombined&&(i.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),e.drawElements++):r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++):r.positions&&(i.drawArrays(i.TRIANGLES,0,r.positions.numItems),e.drawArrays++)},Dr.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new oe(i,this._shaderSource),this._scene=t,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Dr.prototype._bindProgram=function(e){this._program||this._allocate(mesh);const t=this._scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.sectionPlanes.length>0){let e,t,r,o,n;for(let a=0,l=this._uSectionPlanes.length;a<l;a++)e=this._uSectionPlanes[a],t=e.active,r=s.sectionPlanes[a],t&&i.uniform1i(t,r.active),o=e.pos,o&&i.uniform3fv(e.pos,r.pos),n=e.dir,n&&i.uniform3fv(e.dir,r.dir)}};const Sr=p.OBB3(),Ir=p.vec4(),Fr=p.vec4(),Lr=p.vec4(),Br=p.vec3([1,0,0]),Rr=p.vec3([0,1,0]),kr=p.vec3([0,0,1]),Or=p.vec3(3),Nr=p.vec3(3),jr=p.identityMat4();class Vr extends T{constructor(e,t={}){super(e,t),this.originalSystemId=t.originalSystemId||this.id,this.renderFlags=new Ti,this._state=new Ke({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:!1!==t.occluder,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,background:!!t.background,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:p.vec3(),origin:null,originHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=p.vec3(),this._quaternion=p.identityQuaternion(),this._rotation=p.vec3(),this._position=p.vec3(),this._worldMatrix=p.identityMat4(),this._worldNormalMatrix=p.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const i=t.origin||t.rtcCenter;if(i&&(this._state.origin=p.vec3(i),this._state.originHash=i.join()),t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=e}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile()}get type(){return"Mesh"}get isMesh(){return!0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set rotation(e){this._rotation.set(e||[0,0,0]),p.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),p.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=p.identityMat4()),p.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(e){this.__localMatrix||(this.__localMatrix=p.identityMat4()),this.__localMatrix.set(e||jr),p.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(e){e?(this._state.origin||(this._state.origin=p.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this.origin}set rtcCenter(e){this.origin=e}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()}get xrayed(){return this._state.xrayed}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())}get highlighted(){return this._state.highlighted}set highlighted(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())}get selected(){return this._state.selected}set selected(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())}get edges(){return this._state.edges}set edges(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get culled(){return this._state.culled}set culled(e){this._state.culled=!!e,this.glRedraw()}get clippable(){return this._state.clippable}set clippable(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get collidable(){return this._state.collidable}set collidable(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get pickable(){return this._state.pickable}set pickable(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}get castsShadow(){return this._state.castsShadow}set castsShadow(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}get saoEnabled(){return!1}get colorize(){return this._state.colorize}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);const i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1);const i=null!=e;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get isDrawable(){return!0}get isStateSortable(){return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=sr.get(this),this._emphasisFillRenderer=lr.get(this),this._emphasisEdgesRenderer=pr.get(this));const t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=_r.get(this)),this._state.occluder){const e=this._makeOcclusionHash();this._state.occlusionHash!==e&&(this._state.occlusionHash=e,this._putOcclusionRenderer(),this._occlusionRenderer=Cr.get(this))}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)p.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=p.mat4()),p.transposeMat4(this._worldMatrix,this._worldNormalMatrix),p.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=p.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){p.transformOBB3(e,this._geometry.obb,Sr),p.OBB3ToAABB3(Sr,t);const i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.origin){const e=this._state.origin;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]}}rotate(e,t){return Ir[0]=e[0],Ir[1]=e[1],Ir[2]=e[2],Ir[3]=t*p.DEGTORAD,p.angleAxisToQuaternion(Ir,Fr),p.mulQuaternions(this.quaternion,Fr,Lr),this.quaternion=Lr,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Ir[0]=e[0],Ir[1]=e[1],Ir[2]=e[2],Ir[3]=t*p.DEGTORAD,p.angleAxisToQuaternion(Ir,Fr),p.mulQuaternions(Fr,this.quaternion,Fr),this}rotateX(e){return this.rotate(Br,e)}rotateY(e){return this.rotate(Rr,e)}rotateZ(e){return this.rotate(kr,e)}translate(e,t){return p.vec3ApplyQuaternion(this.quaternion,e,Or),p.mulVec3Scalar(Or,t,Nr),p.addVec3(this.position,Nr,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(Br,e)}translateY(e){return this.translate(Rr,e)}translateZ(e){return this.translate(kr,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}rebuildRenderFlags(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}_updateRenderFlags(){const e=this.renderFlags,t=this._state;if(t.xrayed){const t=this._xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges){this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0}if(t.selected){const t=this._selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){const t=this._highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const t=e[i],s=this.renderFlags;if(t.active)if(this._state.origin){const e=p.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return!1;const r=0===e;s.sectionPlanesActivePerLayer[i]=r}else s.sectionPlanesActivePerLayer[i]=!0;else s.sectionPlanesActivePerLayer[i]=!1}}return!0}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=sr.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=sr.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=lr.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=lr.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=lr.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=pr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=pr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=pr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=pr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=pr.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawOcclusion(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=Cr.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=Dr.get(this)))&&this._shadowRenderer.drawMesh(e,this)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=_r.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=yr.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,t,i){zr(this,e,t,i)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const zr=function(){const e=p.vec3(),t=p.vec3(),i=p.vec3(),s=p.vec3(),r=p.vec3(),o=p.vec3(),n=p.vec4(),a=p.vec3(),l=p.vec3(),h=p.vec3(),c=p.vec3(),u=p.vec3(),d=p.vec3(),f=p.vec3(),m=p.vec3(),g=p.vec3(),_=p.vec4(),v=p.vec4(),b=p.vec4(),x=p.vec3(),y=p.vec3(),P=p.vec3(),w=p.vec3(),M=p.vec3(),C=p.vec3(),E=p.vec3(),A=p.vec3(),D=p.vec3(),T=p.vec3(),S=p.vec3();return function(I,F,L,B){var R=B.primIndex;if(null!=R&&R>-1){const j=I.geometry._state,V=I.scene,z=V.camera,U=V.canvas;if("triangles"===j.primitiveName){B.primitive="triangle";const V=R,G=j.indices,W=j.positions;let H,X,Y,q;if(G){var k=G[V+0],O=G[V+1],N=G[V+2];o[0]=k,o[1]=O,o[2]=N,B.indices=o,H=3*k,X=3*O,Y=3*N}else H=3*V,X=H+3,Y=X+3;if(i[0]=W[H+0],i[1]=W[H+1],i[2]=W[H+2],s[0]=W[X+0],s[1]=W[X+1],s[2]=W[X+2],r[0]=W[Y+0],r[1]=W[Y+1],r[2]=W[Y+2],j.compressGeometry){const e=j.positionsDecodeMatrix;e&&(rt.decompressPosition(i,e,i),rt.decompressPosition(s,e,s),rt.decompressPosition(r,e,r))}B.canvasPos?(q=B.canvasPos,p.canvasPosToLocalRay(U.canvas,F,L,I.worldMatrix,q,e,t)):B.origin&&B.direction&&p.worldRayToLocalRay(I.worldMatrix,B.origin,B.direction,e,t),p.normalizeVec3(t),p.rayPlaneIntersect(e,t,i,s,r,n),B.localPos=n,B.position=n,_[0]=n[0],_[1]=n[1],_[2]=n[2],_[3]=1,p.transformVec4(I.worldMatrix,_,v),a[0]=v[0],a[1]=v[1],a[2]=v[2],B.worldPos=a,p.transformVec4(z.matrix,v,b),l[0]=b[0],l[1]=b[1],l[2]=b[2],B.viewPos=l,p.cartesianToBarycentric(n,i,s,r,h),B.bary=h;const $=j.normals;if($){if(j.compressGeometry){const e=3*k,t=3*O,i=3*N;rt.decompressNormal($.subarray(e,e+2),c),rt.decompressNormal($.subarray(t,t+2),u),rt.decompressNormal($.subarray(i,i+2),d)}else c[0]=$[H],c[1]=$[H+1],c[2]=$[H+2],u[0]=$[X],u[1]=$[X+1],u[2]=$[X+2],d[0]=$[Y],d[1]=$[Y+1],d[2]=$[Y+2];const e=p.addVec3(p.addVec3(p.mulVec3Scalar(c,h[0],x),p.mulVec3Scalar(u,h[1],y),P),p.mulVec3Scalar(d,h[2],w),M);B.worldNormal=p.normalizeVec3(p.transformVec3(I.worldNormalMatrix,e,C))}const Z=j.uv;if(Z){if(f[0]=Z[2*k],f[1]=Z[2*k+1],m[0]=Z[2*O],m[1]=Z[2*O+1],g[0]=Z[2*N],g[1]=Z[2*N+1],j.compressGeometry){const e=j.uvDecodeMatrix;e&&(rt.decompressUV(f,e,f),rt.decompressUV(m,e,m),rt.decompressUV(g,e,g))}B.uv=p.addVec3(p.addVec3(p.mulVec2Scalar(f,h[0],E),p.mulVec2Scalar(m,h[1],A),D),p.mulVec2Scalar(g,h[2],T),S)}}}}}();function Ur(e={}){let t=e.radiusTop||1;t<0&&(console.error("negative radiusTop not allowed - will invert"),t*=-1);let i=e.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);let s=e.height||1;s<0&&(console.error("negative height not allowed - will invert"),s*=-1);let r=e.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let o=e.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const n=!!e.openEnded;let a=e.center;const l=a?a[0]:0,h=a?a[1]:0,c=a?a[2]:0,u=s/2,d=s/o,p=2*Math.PI/r,f=1/r,m=(t-i)/o,g=[],_=[],b=[],x=[];let y,P,w,M,C,E,A,D,T,S,I;const F=(90-180*Math.atan(s/(i-t))/Math.PI)/90;for(y=0;y<=o;y++)for(C=t-y*m,E=u-y*d,P=0;P<=r;P++)w=Math.sin(P*p),M=Math.cos(P*p),_.push(C*w),_.push(F),_.push(C*M),b.push(P*f),b.push(1*y/o),g.push(C*w+l),g.push(E+h),g.push(C*M+c);for(y=0;y<o;y++)for(P=0;P<=r;P++)A=y*(r+1)+P,D=A+r,x.push(A),x.push(D),x.push(D+1),x.push(A),x.push(D+1),x.push(A+1);if(!n&&t>0){for(T=g.length/3,_.push(0),_.push(1),_.push(0),b.push(.5),b.push(.5),g.push(0+l),g.push(u+h),g.push(0+c),P=0;P<=r;P++)w=Math.sin(P*p),M=Math.cos(P*p),S=.5*Math.sin(P*p)+.5,I=.5*Math.cos(P*p)+.5,_.push(t*w),_.push(1),_.push(t*M),b.push(S),b.push(I),g.push(t*w+l),g.push(u+h),g.push(t*M+c);for(P=0;P<r;P++)a=T,A=T+1+P,x.push(A),x.push(A+1),x.push(a)}if(!n&&i>0){for(T=g.length/3,_.push(0),_.push(-1),_.push(0),b.push(.5),b.push(.5),g.push(0+l),g.push(0-u+h),g.push(0+c),P=0;P<=r;P++)w=Math.sin(P*p),M=Math.cos(P*p),S=.5*Math.sin(P*p)+.5,I=.5*Math.cos(P*p)+.5,_.push(i*w),_.push(-1),_.push(i*M),b.push(S),b.push(I),g.push(i*w+l),g.push(0-u+h),g.push(i*M+c);for(P=0;P<r;P++)a=T,A=T+1+P,x.push(a),x.push(A+1),x.push(A)}return v.apply(e,{positions:g,normals:_,uv:b,indices:x})}function Gr(e={}){const t=e.lod||1,i=e.center?e.center[0]:0,s=e.center?e.center[1]:0,r=e.center?e.center[2]:0;let o=e.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let n=e.heightSegments||18;n<0&&(console.error("negative heightSegments not allowed - will invert"),n*=-1),n=Math.floor(t*n),n<18&&(n=18);let a=e.widthSegments||18;a<0&&(console.error("negative widthSegments not allowed - will invert"),a*=-1),a=Math.floor(t*a),a<18&&(a=18);const l=[],h=[],c=[],u=[];let d,p,f,m,g,_,b,x,y,P,w,M,C,E,A;for(d=0;d<=n;d++)for(f=d*Math.PI/n,m=Math.sin(f),g=Math.cos(f),p=0;p<=a;p++)_=2*p*Math.PI/a,b=Math.sin(_),x=Math.cos(_),y=x*m,P=g,w=b*m,M=1-p/a,C=d/n,h.push(y),h.push(P),h.push(w),c.push(M),c.push(C),l.push(i+o*y),l.push(s+o*P),l.push(r+o*w);for(d=0;d<n;d++)for(p=0;p<a;p++)E=d*(a+1)+p,A=E+a+1,u.push(E+1),u.push(A+1),u.push(A),u.push(E+1),u.push(A),u.push(E);return v.apply(e,{positions:l,normals:h,uv:c,indices:u})}class Wr extends T{get type(){return"SectionPlane"}constructor(e,t={}){super(e,t),this._state=new Ke({active:!0,pos:p.vec3(),dir:p.vec3(),dist:0}),this.active=t.active,this.pos=t.pos,this.dir=t.dir,this.scene._sectionPlaneCreated(this)}set active(e){this._state.active=!1!==e,this.glRedraw(),this.fire("active",this._state.active)}get active(){return this._state.active}set pos(e){this._state.pos.set(e||[0,0,0]),this._state.dist=-p.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos)}get pos(){return this._state.pos}set dir(e){this._state.dir.set(e||[0,0,-1]),this._state.dist=-p.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir)}get dir(){return this._state.dir}get dist(){return this._state.dist}flipDir(){const e=this._state.dir;e[0]*=-1,e[1]*=-1,e[2]*=-1,this._state.dist=-p.dotVec3(this._state.pos,this._state.dir),this.fire("dir",this._state.dir),this.glRedraw()}destroy(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),super.destroy()}}const Hr=p.vec4(4),Xr=p.vec4(),Yr=p.vec4(),qr=p.vec3([1,0,0]),$r=p.vec3([0,1,0]),Zr=p.vec3([0,0,1]),Kr=p.vec3(3),Qr=p.vec3(3),Jr=p.identityMat4();class eo extends T{constructor(e,t={}){if(super(e,t),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=p.vec3(),this._quaternion=p.identityQuaternion(),this._rotation=p.vec3(),this._position=p.vec3(),this._offset=p.vec3(),this._localMatrix=p.identityMat4(),this._worldMatrix=p.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this.origin=t.origin,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.children){const e=t.children;for(let i=0,s=e.length;i<s;i++)this.addChild(e[i],t.inheritStates)}if(t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'")}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this))}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set origin(e){e?(this._origin||(this._origin=p.vec3()),this._origin.set(e)):this._origin&&(this._origin=null);for(let t=0,i=this._children.length;t<i;t++)this._children[t].origin=e;this.glRedraw()}get origin(){return this._origin}set rtcCenter(e){this.origin=e}get rtcCenter(){return this.origin}get numTriangles(){return this._numTriangles}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e)}get visible(){return this._visible}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e)}get xrayed(){return this._xrayed}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e)}get highlighted(){return this._highlighted}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e)}get selected(){return this._selected}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].edges=e}get edges(){return this._edges}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].culled=e}get culled(){return this._culled}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].clippable=e}get clippable(){return this._clippable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].collidable=e}get collidable(){return this._collidable}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].pickable=e}get pickable(){return this._pickable}set colorize(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(let e=0,i=this._children.length;e<i;e++)this._children[e].colorize=t;if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t)}}get colorize(){return this._colorize.slice(0,3)}set opacity(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1;for(let t=0,i=this._children.length;t<i;t++)this._children[t].opacity=e;if(this._isObject){const t=null!=e;this.scene._objectOpacityUpdated(this,t)}}get opacity(){return this._colorize[3]}set castsShadow(e){e=!!e,this._castsShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].castsShadow=e}get castsShadow(){return this._castsShadow}set receivesShadow(e){e=!!e,this._receivesShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].receivesShadow=e}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return!1}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this._children.length;e<t;e++)this._children[e].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e)}get offset(){return this._offset}get isNode(){return!0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty()}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)p.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._children)for(let t=0,i=e._children.length;t<i;t++)this._setSubtreeAABBsDirty(e._children[t])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=p.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{let e;p.collapseAABB3(this._aabb);for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e.collidable&&p.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}addChild(e,t){if(v.isNumeric(e)||v.isString(e)){const t=e;if(!(e=this.scene.component[t]))return void this.warn("Component not found: "+v.inQuotes(t));if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+t)}else{if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+e.id);if(e._parentNode){if(e._parentNode.id===this.id)return void this.warn("Already a child: "+e.id);e._parentNode.removeChild(e)}}if(e.id,e.scene.id===this.scene.id)return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e;this.error("Child not in same Scene: "+e.id)}removeChild(e){for(let t=0,i=this._children.length;t<i;t++)if(this._children[t].id===e.id)return e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=e.numTriangles)}removeChildren(){let e;for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty()}get numChildren(){return this._children.length}get children(){return this._children}set parent(e){if(v.isNumeric(e)||v.isString(e)){const t=e;if(!(e=this.scene.components[t]))return void this.warn("Node not found: "+v.inQuotes(t));if(!e.isNode)return void this.error("Not a Node: "+e.id)}e.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===e.id?this.warn("Already a child of Node: "+e.id):e.addChild(this):this.error("Node not in same Scene: "+e.id)}get parent(){return this._parentNode}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),p.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),p.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=p.identityMat4()),this._localMatrix.set(e||Jr),p.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=p.identityMat4()),p.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return Hr[0]=e[0],Hr[1]=e[1],Hr[2]=e[2],Hr[3]=t*p.DEGTORAD,p.angleAxisToQuaternion(Hr,Xr),p.mulQuaternions(this.quaternion,Xr,Yr),this.quaternion=Yr,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Hr[0]=e[0],Hr[1]=e[1],Hr[2]=e[2],Hr[3]=t*p.DEGTORAD,p.angleAxisToQuaternion(Hr,Xr),p.mulQuaternions(Xr,this.quaternion,Xr),this}rotateX(e){return this.rotate(qr,e)}rotateY(e){return this.rotate($r,e)}rotateZ(e){return this.rotate(Zr,e)}translate(e,t){return p.vec3ApplyQuaternion(this.quaternion,e,Kr),p.mulVec3Scalar(Kr,t,Qr),p.addVec3(this.position,Qr,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(qr,e)}translateY(e){return this.translate($r,e)}translateZ(e){return this.translate(Zr,e)}get type(){return"Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const e=this._children.splice();let t;for(let i=0,s=e.length;i<s;i++)t=e[i],t.destroy()}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}function to(e,t,i=null){let s;const r=t;if(1009===r)return e.UNSIGNED_BYTE;if(1017===r)return e.UNSIGNED_SHORT_4_4_4_4;if(1018===r)return e.UNSIGNED_SHORT_5_5_5_1;if(1010===r)return e.BYTE;if(1011===r)return e.SHORT;if(1012===r)return e.UNSIGNED_SHORT;if(1013===r)return e.INT;if(1014===r)return e.UNSIGNED_INT;if(1015===r)return e.FLOAT;if(1016===r)return e.HALF_FLOAT;if(1021===r)return e.ALPHA;if(r===Ns)return e.RGBA;if(1024===r)return e.LUMINANCE;if(1025===r)return e.LUMINANCE_ALPHA;if(1026===r)return e.DEPTH_COMPONENT;if(1027===r)return e.DEPTH_STENCIL;if(1028===r)return e.RED;if(1022===r)return e.RGBA;if(1029===r)return e.RED_INTEGER;if(1030===r)return e.RG;if(1031===r)return e.RG_INTEGER;if(1033===r)return e.RGBA_INTEGER;if(r===js||r===Vs||r===zs||r===Us)if(i===Zs){const t=we(e,"WEBGL_compressed_texture_s3tc_srgb");if(null===t)return null;if(r===js)return t.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(r===Vs)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(r===zs)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(r===Us)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(s=we(e,"WEBGL_compressed_texture_s3tc"),null===s)return null;if(r===js)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(r===Vs)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(r===zs)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(r===Us)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(r===Gs||35841===r||r===Ws||35843===r){const t=we(e,"WEBGL_compressed_texture_pvrtc");if(null===t)return null;if(r===Gs)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===r)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(r===Ws)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===r)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===r){const t=we(e,"WEBGL_compressed_texture_etc1");return null!==t?t.COMPRESSED_RGB_ETC1_WEBGL:null}if(r===Hs||r===Xs){const t=we(e,"WEBGL_compressed_texture_etc");if(null===t)return null;if(r===Hs)return i===Zs?t.COMPRESSED_SRGB8_ETC2:t.COMPRESSED_RGB8_ETC2;if(r===Xs)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC}if(r===Ys||37809===r||37810===r||37811===r||37812===r||37813===r||37814===r||37815===r||37816===r||37817===r||37818===r||37819===r||37820===r||37821===r){const t=we(e,"WEBGL_compressed_texture_astc");if(null===t)return null;if(r===Ys)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:t.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:t.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:t.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:t.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:t.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:t.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:t.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:t.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:t.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:t.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:t.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:t.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:t.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===r)return i===Zs?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:t.COMPRESSED_RGBA_ASTC_12x12_KHR}if(r===qs){const t=we(e,"EXT_texture_compression_bptc");if(null===t)return null;if(r===qs)return i===Zs?t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:t.COMPRESSED_RGBA_BPTC_UNORM_EXT}return 1020===r?e.UNSIGNED_INT_24_8:r===Ds?e.REPEAT:r===Ts?e.CLAMP_TO_EDGE:r===Fs||r===Ls?e.NEAREST_MIPMAP_LINEAR:r===Rs?e.LINEAR_MIPMAP_NEAREST:r===Os?e.LINEAR_MIPMAP_LINEAR:r===Is?e.NEAREST:r===Bs?e.LINEAR:null}const io=new Uint8Array([0,0,0,1]);class so{constructor({gl:e,target:t,format:i,type:s,wrapS:r,wrapT:o,wrapR:n,encoding:a,preloadColor:l,premultiplyAlpha:h,flipY:c}){this.gl=e,this.target=t||e.TEXTURE_2D,this.format=i||Ns,this.type=s||1009,this.internalFormat=null,this.premultiplyAlpha=!!h,this.flipY=!!c,this.unpackAlignment=4,this.wrapS=r||Ds,this.wrapT=o||Ds,this.wrapR=n||Ds,this.encoding=a||Zs,this.texture=e.createTexture(),l&&this.setPreloadColor(l),this.allocated=!0}setPreloadColor(e){e?(io[0]=Math.floor(255*e[0]),io[1]=Math.floor(255*e[1]),io[2]=Math.floor(255*e[2]),io[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(io[0]=0,io[1]=0,io[2]=0,io[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),this.target===t.TEXTURE_CUBE_MAP){const e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=e.length;i<s;i++)t.texImage2D(e[i],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,io)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,io);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t={}){const i=this.gl;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR);let s=!1;i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const r=to(i,this.minFilter);i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,r),r!==i.NEAREST_MIPMAP_NEAREST&&r!==i.LINEAR_MIPMAP_NEAREST&&r!==i.NEAREST_MIPMAP_LINEAR&&r!==i.LINEAR_MIPMAP_LINEAR||(s=!0);const o=to(i,this.magFilter);o&&i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,o);const n=to(i,this.wrapS);n&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,n);const a=to(i,this.wrapT);a&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,a);const l=to(i,this.format,this.encoding),h=to(i,this.type),c=ro(i,this.internalFormat,l,h,this.encoding,!1);if(this.target===i.TEXTURE_CUBE_MAP){if(v.isArray(e)){const t=e,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let e=0,r=s.length;e<r;e++)i.texImage2D(s[e],0,c,l,h,t[e])}}else i.texImage2D(i.TEXTURE_2D,0,c,l,h,e);s&&i.generateMipmap(this.target),i.bindTexture(this.target,null)}setCompressedData({mipmaps:e,props:t={}}){const i=this.gl,s=e.length;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR),i.activeTexture(i.TEXTURE0+0),i.bindTexture(this.target,this.texture);let r=e.length>1;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const o=to(i,this.wrapS);o&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,o);const n=to(i,this.wrapT);if(n&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,n),this.type===i.TEXTURE_3D||this.type===i.TEXTURE_2D_ARRAY){const e=to(i,this.wrapR);e&&i.texParameteri(this.target,i.TEXTURE_WRAP_R,e),i.texParameteri(this.type,i.TEXTURE_WRAP_R,e)}r?(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,oo(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,oo(i,this.magFilter))):(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,to(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,to(i,this.magFilter)));const a=to(i,this.format,this.encoding),l=to(i,this.type),h=ro(i,this.internalFormat,a,l,this.encoding,!1);i.texStorage2D(i.TEXTURE_2D,s,h,e[0].width,e[0].height);for(let t=0,s=e.length;t<s;t++){const s=e[t];this.format!==Ns?null!==a?i.compressedTexSubImage2D(i.TEXTURE_2D,t,0,0,s.width,s.height,a,s.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):i.texSubImage2D(i.TEXTURE_2D,t,0,0,s.width,s.height,a,l,s.data)}i.bindTexture(this.target,null)}setProps(e){const t=this.gl;t.bindTexture(this.target,this.texture),this._uploadProps(e),t.bindTexture(this.target,null)}_uploadProps(e){const t=this.gl;if(void 0!==e.format&&(this.format=e.format),void 0!==e.internalFormat&&(this.internalFormat=e.internalFormat),void 0!==e.encoding&&(this.encoding=e.encoding),void 0!==e.type&&(this.type=e.type),void 0!==e.minFilter){const i=to(t,e.minFilter);i&&(this.minFilter=e.minFilter,t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(void 0!==e.magFilter){const i=to(t,e.magFilter);i&&(this.magFilter=e.magFilter,t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i))}if(void 0!==e.wrapS){const i=to(t,e.wrapS);i&&(this.wrapS=e.wrapS,t.texParameteri(this.target,t.TEXTURE_WRAP_S,i))}if(void 0!==e.wrapT){const i=to(t,e.wrapT);i&&(this.wrapT=e.wrapT,t.texParameteri(this.target,t.TEXTURE_WRAP_T,i))}}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function ro(e,t,i,s,r,o=!1){if(null!==t){if(void 0!==e[t])return e[t];console.warn("Attempt to use non-existing WebGL internal format '"+t+"'")}let n=i;return i===e.RED&&(s===e.FLOAT&&(n=e.R32F),s===e.HALF_FLOAT&&(n=e.R16F),s===e.UNSIGNED_BYTE&&(n=e.R8)),i===e.RG&&(s===e.FLOAT&&(n=e.RG32F),s===e.HALF_FLOAT&&(n=e.RG16F),s===e.UNSIGNED_BYTE&&(n=e.RG8)),i===e.RGBA&&(s===e.FLOAT&&(n=e.RGBA32F),s===e.HALF_FLOAT&&(n=e.RGBA16F),s===e.UNSIGNED_BYTE&&(n=r===Zs&&!1===o?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(n=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(n=e.RGB5_A1)),n!==e.R16F&&n!==e.R32F&&n!==e.RG16F&&n!==e.RG32F&&n!==e.RGBA16F&&n!==e.RGBA32F||we(e,"EXT_color_buffer_float"),n}function oo(e,t){return t===Is||1004===t||1005===t?e.NEAREST:e.LINEAR}function no(e){if(!ao(e.width)||!ao(e.height)){const t=document.createElement("canvas");t.width=lo(e.width),t.height=lo(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function ao(e){return 0==(e&e-1)}function lo(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class ho extends T{get type(){return"Texture"}constructor(e,t={}){super(e,t),this._state=new Ke({texture:new so({gl:this.scene.canvas.gl}),matrix:p.identityMat4(),hasMatrix:t.translate&&(0!==t.translate[0]||0!==t.translate[1])||!!t.rotate||t.scale&&(0!==t.scale[0]||0!==t.scale[1]),minFilter:this._checkMinFilter(t.minFilter),magFilter:this._checkMagFilter(t.magFilter),wrapS:this._checkWrapS(t.wrapS),wrapT:this._checkWrapT(t.wrapT),flipY:this._checkFlipY(t.flipY),encoding:this._checkEncoding(t.encoding)}),this._src=null,this._image=null,this._translate=p.vec2([0,0]),this._scale=p.vec2([1,1]),this._rotate=p.vec2([0,0]),this._matrixDirty=!1,this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,t.src?this.src=t.src:t.image&&(this.image=t.image),f.memory.textures++}_checkMinFilter(e){return(e=e||Os)!==Bs&&e!==Rs&&e!==Os&&e!==Ls&&e!==Fs&&(this.error("Unsupported value for 'minFilter' - supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, NearestMipMapLinearFilter and LinearMipMapLinearFilter. Defaulting to LinearMipMapLinearFilter."),e=Os),e}_checkMagFilter(e){return(e=e||Bs)!==Bs&&e!==Is&&(this.error("Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),e=Bs),e}_checkWrapS(e){return(e=e||Ds)!==Ts&&e!==Ss&&e!==Ds&&(this.error("Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=Ds),e}_checkWrapT(e){return(e=e||Ds)!==Ts&&e!==Ss&&e!==Ds&&(this.error("Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=Ds),e}_checkFlipY(e){return!!e}_checkEncoding(e){return(e=e||$s)!==$s&&e!==Zs&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=$s),e}_webglContextRestored(){this._state.texture=new so({gl:this.scene.canvas.gl}),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const e=this._state;if(this._matrixDirty){let t,i;0===this._translate[0]&&0===this._translate[1]||(t=p.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=p.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?p.mulMat4(t,i):i),0!==this._rotate&&(i=p.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?p.mulMat4(t,i):i),t&&(e.matrix=t),this._matrixDirty=!1}this.glRedraw()}set image(e){this._image=no(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let i=new Image;i.onload=function(){i=no(i),t._state.texture.setImage(i,t._state),t.scene.loading--,t.glRedraw(),t.scene.canvas.spinner.processes--},i.src=e,this._src=e,this._image=null}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),f.memory.textures--}}const co=f.memory,uo=p.AABB3();class po extends ns{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new Ke({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._aabb=null,this._obb=p.OBB3();const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(t.indices){var r;if(t.positionsDecodeMatrix);else{const e=rt.getPositionsBounds(t.positions),o=rt.compressPositions(t.positions,e.min,e.max);r=o.quantized,i.positionsDecodeMatrix=o.decodeMatrix,i.positionsBuf=new ne(s,s.ARRAY_BUFFER,r,r.length,3,s.STATIC_DRAW),co.positions+=i.positionsBuf.numItems,p.positions3ToAABB3(t.positions,this._aabb),p.positions3ToAABB3(r,uo,i.positionsDecodeMatrix),p.AABB3ToOBB3(uo,this._obb)}if(t.colors){const e=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors);i.colorsBuf=new ne(s,s.ARRAY_BUFFER,e,e.length,4,s.STATIC_DRAW),co.colors+=i.colorsBuf.numItems}if(t.uv){const e=rt.getUVBounds(t.uv),r=rt.compressUVs(t.uv,e.min,e.max),o=r.quantized;i.uvDecodeMatrix=r.decodeMatrix,i.uvBuf=new ne(s,s.ARRAY_BUFFER,o,o.length,2,s.STATIC_DRAW),co.uvs+=i.uvBuf.numItems}if(t.normals){const e=rt.compressNormals(t.normals);let r=i.compressGeometry;i.normalsBuf=new ne(s,s.ARRAY_BUFFER,e,e.length,3,s.STATIC_DRAW,r),co.normals+=i.normalsBuf.numItems}{const e=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices);i.indicesBuf=new ne(s,s.ELEMENT_ARRAY_BUFFER,e,e.length,1,s.STATIC_DRAW),co.indices+=i.indicesBuf.numItems;const o=Me(r,e,i.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new ne(s,s.ELEMENT_ARRAY_BUFFER,o,o.length,1,s.STATIC_DRAW),"triangles"===this._state.primitiveName&&(this._numTriangles=t.indices.length/3)}this._buildHash(),co.meshes++}else this.error("Config expected: indices");else this.error("Config expected: positions")}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positionsBuf&&t.push("p"),e.colorsBuf&&t.push("c"),(e.normalsBuf||e.autoVertexNormals)&&t.push("n"),e.uvBuf&&t.push("u"),t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),co.meshes--}}var fo={};function mo(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);let s=e.xSegments||1;s<0&&(console.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);let r=e.xSegments||1;r<0&&(console.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);const o=e.center,n=o?o[0]:0,a=o?o[1]:0,l=o?o[2]:0,h=t/2,c=i/2,u=Math.floor(s)||1,d=Math.floor(r)||1,p=u+1,f=d+1,m=t/u,g=i/d,_=new Float32Array(p*f*3),b=new Float32Array(p*f*3),x=new Float32Array(p*f*2);let y,P,w,M,C,E,A,D=0,T=0;for(y=0;y<f;y++){const e=y*g-c;for(P=0;P<p;P++)w=P*m-h,_[D]=w+n,_[D+1]=a,_[D+2]=-e+l,b[D+2]=-1,x[T]=P/u,x[T+1]=(d-y)/d,D+=3,T+=2}D=0;const S=new(_.length/3>65535?Uint32Array:Uint16Array)(u*d*6);for(y=0;y<d;y++)for(P=0;P<u;P++)M=P+p*y,C=P+p*(y+1),E=P+1+p*(y+1),A=P+1+p*y,S[D]=A,S[D+1]=C,S[D+2]=M,S[D+3]=A,S[D+4]=E,S[D+5]=C,D+=6;return v.apply(e,{positions:_,normals:b,uv:x,indices:S})}function go(e={}){let t=e.radius||1;t<0&&(console.error("negative radius not allowed - will invert"),t*=-1),t*=.5;let i=e.tube||.3;i<0&&(console.error("negative tube not allowed - will invert"),i*=-1);let s=e.radialSegments||32;s<0&&(console.error("negative radialSegments not allowed - will invert"),s*=-1),s<4&&(s=4);let r=e.tubeSegments||24;r<0&&(console.error("negative tubeSegments not allowed - will invert"),r*=-1),r<4&&(r=4);let o=e.arc||2*Math.PI;o<0&&(console.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);const n=e.center;let a=n?n[0]:0,l=n?n[1]:0;const h=n?n[2]:0,c=[],u=[],d=[],f=[];let m,g,_,b,x,y,P,w,M,C,E,A;for(w=0;w<=r;w++)for(P=0;P<=s;P++)m=P/s*o,g=.785398+w/r*Math.PI*2,a=t*Math.cos(m),l=t*Math.sin(m),_=(t+i*Math.cos(g))*Math.cos(m),b=(t+i*Math.cos(g))*Math.sin(m),x=i*Math.sin(g),c.push(_+a),c.push(b+l),c.push(x+h),d.push(1-P/s),d.push(w/r),y=p.normalizeVec3(p.subVec3([_,b,x],[a,l,h],[]),[]),u.push(y[0]),u.push(y[1]),u.push(y[2]);for(w=1;w<=r;w++)for(P=1;P<=s;P++)M=(s+1)*w+P-1,C=(s+1)*(w-1)+P-1,E=(s+1)*(w-1)+P,A=(s+1)*w+P,f.push(M),f.push(C),f.push(E),f.push(E),f.push(A),f.push(M);return v.apply(e,{positions:c,normals:u,uv:d,indices:f})}fo.load=function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(e){t(e.target.response)},i.send()},fo.save=function(e,t){var i="data:application/octet-stream;base64,"+btoa(fo.parse._buffToStr(e));window.location.href=i},fo.clone=function(e){return JSON.parse(JSON.stringify(e))},fo.bin={},fo.bin.f=new Float32Array(1),fo.bin.fb=new Uint8Array(fo.bin.f.buffer),fo.bin.rf=function(e,t){for(var i=fo.bin.f,s=fo.bin.fb,r=0;r<4;r++)s[r]=e[t+r];return i[0]},fo.bin.rsl=function(e,t){return e[t]|e[t+1]<<8},fo.bin.ril=function(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24},fo.bin.rASCII0=function(e,t){for(var i="";0!=e[t];)i+=String.fromCharCode(e[t++]);return i},fo.bin.wf=function(e,t,i){new Float32Array(e.buffer,t,1)[0]=i},fo.bin.wsl=function(e,t,i){e[t]=i,e[t+1]=i>>8},fo.bin.wil=function(e,t,i){e[t]=i,e[t+1]=i>>8,e[t+2]=i>>16,e[t+3]},fo.parse={},fo.parse._buffToStr=function(e){for(var t=new Uint8Array(e),i="",s=0;s<t.length;s++)i=i.concat(String.fromCharCode(t[s]));return i},fo.parse._strToBuff=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),s=0;s<e.length;s++)i[s]=e.charCodeAt(s);return t},fo.parse._readLine=function(e,t){for(var i="";10!=e[t];)i+=String.fromCharCode(e[t++]);return i},fo.parse.fromJSON=function(e){return JSON.parse(fo.parse._buffToStr(e))},fo.parse.toJSON=function(e){var t=JSON.stringify(e);return fo.parse._strToBuff(t)},fo.parse.fromOBJ=function(e){for(var t={groups:{},c_verts:[],c_uvt:[],c_norms:[],i_verts:[],i_uvt:[],i_norms:[]},i={from:0,to:0},s=0,r=new Uint8Array(e);s<r.length;){var o=fo.parse._readLine(r,s);s+=o.length+1;var n=(o=(o=o.replace(/ +(?= )/g,"")).replace(/(^\s+|\s+$)/g,"")).split(" ");if("g"==n[0]&&(i.to=t.i_verts.length,null==t.groups[n[1]]&&(t.groups[n[1]]={from:t.i_verts.length,to:0}),i=t.groups[n[1]]),"v"==n[0]){var a=parseFloat(n[1]),l=parseFloat(n[2]),h=parseFloat(n[3]);t.c_verts.push(a,l,h)}if("vt"==n[0]){a=parseFloat(n[1]),l=1-parseFloat(n[2]);t.c_uvt.push(a,l)}if("vn"==n[0]){a=parseFloat(n[1]),l=parseFloat(n[2]),h=parseFloat(n[3]);t.c_norms.push(a,l,h)}if("f"==n[0]){var c=n[1].split("/"),u=n[2].split("/"),d=n[3].split("/"),p=parseInt(c[0])-1,f=parseInt(u[0])-1,m=parseInt(d[0])-1,g=parseInt(c[1])-1,_=parseInt(u[1])-1,v=parseInt(d[1])-1,b=parseInt(c[2])-1,x=parseInt(u[2])-1,y=parseInt(d[2])-1,P=t.c_verts.length/3,w=t.c_uvt.length/2,M=t.c_norms.length/3;if(p<0&&(p=P+p+1),f<0&&(f=P+f+1),m<0&&(m=P+m+1),g<0&&(g=w+g+1),_<0&&(_=w+_+1),v<0&&(v=w+v+1),b<0&&(b=M+b+1),x<0&&(x=M+x+1),y<0&&(y=M+y+1),t.i_verts.push(p,f,m),t.i_uvt.push(g,_,v),t.i_norms.push(b,x,y),5==n.length){var C=n[4].split("/"),E=parseInt(C[0])-1,A=parseInt(C[1])-1,D=parseInt(C[2])-1;E<0&&(E=P+E+1),A<0&&(A=w+A+1),D<0&&(D=M+D+1),t.i_verts.push(p,m,E),t.i_uvt.push(g,v,A),t.i_norms.push(b,y,D)}}}return i.to=t.i_verts.length,t},fo.parse.fromMD2=function(e){e=new Uint8Array(e);var t={},i={};i.ident=fo.bin.ril(e,0),i.version=fo.bin.ril(e,4),i.skinwidth=fo.bin.ril(e,8),i.skinheight=fo.bin.ril(e,12),i.framesize=fo.bin.ril(e,16),i.num_skins=fo.bin.ril(e,20),i.num_vertices=fo.bin.ril(e,24),i.num_st=fo.bin.ril(e,28),i.num_tris=fo.bin.ril(e,32),i.num_glcmds=fo.bin.ril(e,36),i.num_frames=fo.bin.ril(e,40),i.offset_skins=fo.bin.ril(e,44),i.offset_st=fo.bin.ril(e,48),i.offset_tris=fo.bin.ril(e,52),i.offset_frames=fo.bin.ril(e,56),i.offset_glcmds=fo.bin.ril(e,60),i.offset_end=fo.bin.ril(e,64);var s=i.offset_st;t.c_uvt=[];for(var r=0;r<i.num_st;r++){var o=fo.bin.rsl(e,s)/i.skinwidth,n=fo.bin.rsl(e,s+2)/i.skinheight;t.c_uvt.push(o,n),s+=4}s=i.offset_tris;var a=[],l=[];t.i_verts=a,t.i_uvt=l;for(r=0;r<i.num_tris;r++)a.push(fo.bin.rsl(e,s),fo.bin.rsl(e,s+2),fo.bin.rsl(e,s+4)),l.push(fo.bin.rsl(e,s+6),fo.bin.rsl(e,s+8),fo.bin.rsl(e,s+10)),s+=12;s=i.offset_skins;t.skins=[];for(r=0;r<i.num_skins;r++)t.skins.push(fo.bin.rASCII0(e,s)),s+=64;s=i.offset_frames;t.frames=[];var h=fo.parse.fromMD2._normals;for(r=0;r<i.num_frames;r++){var c={},u=fo.bin.rf(e,s),d=fo.bin.rf(e,s+4),p=fo.bin.rf(e,s+8);s+=12;var f=fo.bin.rf(e,s),m=fo.bin.rf(e,s+4),g=fo.bin.rf(e,s+8);s+=12,c.name=fo.bin.rASCII0(e,s),s+=16,c.verts=[],c.norms=[];for(var _=0;_<i.num_vertices;_++)c.verts.push(e[s]*u+f,e[s+1]*d+m,e[s+2]*p+g),c.norms.push(h[3*e[s+3]],h[3*e[s+3]+1],h[3*e[s+3]+2]),s+=4;t.frames.push(c)}return t},fo.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325],fo.parse.fromCollada=function(e){var t=fo.parse._buffToStr(e),i=(new DOMParser).parseFromString(t,"text/xml"),s={},r=(i=i.childNodes[0]).getElementsByTagName("asset")[0],o=i.getElementsByTagName("library_geometries")[0],n=i.getElementsByTagName("library_images")[0],a=i.getElementsByTagName("library_materials")[0],l=i.getElementsByTagName("library_effects")[0];return r&&(s.asset=fo.parse.fromCollada._asset(r)),o&&(s.geometries=fo.parse.fromCollada._libGeometries(o)),n&&(s.images=fo.parse.fromCollada._libImages(n)),a&&(s.materials=fo.parse.fromCollada._libMaterials(a)),l&&(s.effects=fo.parse.fromCollada._libEffects(l)),s},fo.parse.fromCollada._asset=function(e){return{created:e.getElementsByTagName("created")[0].textContent,modified:e.getElementsByTagName("modified")[0].textContent,up_axis:e.getElementsByTagName("up_axis")[0].textContent}},fo.parse.fromCollada._libGeometries=function(e){e=e.getElementsByTagName("geometry");for(var t=[],i=0;i<e.length;i++){var s=e[i],r=fo.parse.fromCollada._getMesh(s.getElementsByTagName("mesh")[0]);t.push(r)}return t},fo.parse.fromCollada._getMesh=function(e){for(var t={},i=e.getElementsByTagName("source"),s=t.sources={},r=0;r<i.length;r++){for(var o=i[r].getElementsByTagName("float_array")[0].textContent.split(" "),n=o.length-(""==o[o.length-1]?1:0),a=new Array(n),l=0;l<n;l++)a[l]=parseFloat(o[l]);s[i[r].getAttribute("id")]=a}t.triangles=[];var h=e.getElementsByTagName("triangles");if(null==h)return t;for(r=0;r<h.length;r++){var c={},u=h[r];c.material=u.getAttribute("material");var d=u.getElementsByTagName("input"),p=[];for(l=0;l<d.length;l++){var f=d[l];a=[];p[parseInt(f.getAttribute("offset"))]=a;var m=f.getAttribute("semantic");c["s_"+m]="VERTEX"==m?e.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):f.getAttribute("source").substring(1),c["i_"+m]=a,s[c["s_"+m]]}var g=u.getElementsByTagName("p")[0].textContent.split(" "),_=3*Math.floor(g.length/3);for(l=0;l<_;l++)p[l%d.length].push(parseInt(g[l]));t.triangles.push(c)}return t},fo.parse.fromCollada._libImages=function(e){e=e.getElementsByTagName("image");for(var t={},i=0;i<e.length;i++)t[e[i].getAttribute("id")]=e[i].getElementsByTagName("init_from")[0].textContent;return t},fo.parse.fromCollada._libMaterials=function(e){e=e.getElementsByTagName("material");for(var t={},i=0;i<e.length;i++)t[e[i].getAttribute("name")]=e[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return t},fo.parse.fromCollada._libEffects=function(e){e=e.getElementsByTagName("effect");for(var t={},i=0;i<e.length;i++){for(var s={},r=e[i].getElementsByTagName("newparam"),o=0;o<r.length;o++){var n=r[o].getElementsByTagName("surface")[0];n&&(s.surface=n.getElementsByTagName("init_from")[0].textContent)}t[e[i].getAttribute("id")]=s}return t},fo.parse.from3DS=function(e){e=new Uint8Array(e);var t={};if(19789!=fo.bin.rsl(e,0))return null;for(var i=fo.bin.ril(e,2),s=6;s<i;){var r=fo.bin.rsl(e,s),o=fo.bin.ril(e,s+2);15677==r&&(t.edit=fo.parse.from3DS._edit3ds(e,s,o)),45056==r&&(t.keyf=fo.parse.from3DS._keyf3ds(e,s,o)),s+=o}return t},fo.parse.from3DS._edit3ds=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=fo.bin.rsl(e,r),n=fo.bin.ril(e,r+2);16384==o&&(null==s.objects&&(s.objects=[]),s.objects.push(fo.parse.from3DS._edit_object(e,r,n))),r+=n}return s},fo.parse.from3DS._keyf3ds=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=fo.bin.rsl(e,r),n=fo.bin.ril(e,r+2);45058==o&&(null==s.desc&&(s.desc=[]),s.desc.push(fo.parse.from3DS._keyf_objdes(e,r,n))),r+=n}return s},fo.parse.from3DS._keyf_objdes=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=fo.bin.rsl(e,r),n=fo.bin.ril(e,r+2);45072==o&&(s.hierarchy=fo.parse.from3DS._keyf_objhierarch(e,r,n)),45073==o&&(s.dummy_name=fo.bin.rASCII0(e,r+6)),r+=n}return s},fo.parse.from3DS._keyf_objhierarch=function(e,t,i){var s={},r=t+6;return s.name=fo.bin.rASCII0(e,r),r+=s.name.length+1,s.hierarchy=fo.bin.rsl(e,r+4),s},fo.parse.from3DS._edit_object=function(e,t,i){var s={},r=t+6;for(s.name=fo.bin.rASCII0(e,r),r+=s.name.length+1;r<t+i;){var o=fo.bin.rsl(e,r),n=fo.bin.ril(e,r+2);16640==o&&(s.mesh=fo.parse.from3DS._obj_trimesh(e,r,n)),r+=n}return s},fo.parse.from3DS._obj_trimesh=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=fo.bin.rsl(e,r),n=fo.bin.ril(e,r+2);16656==o&&(s.vertices=fo.parse.from3DS._tri_vertexl(e,r,n)),16672==o&&(s.indices=fo.parse.from3DS._tri_facel1(e,r,n)),16704==o&&(s.uvt=fo.parse.from3DS._tri_mappingcoors(e,r,n)),16736==o&&(s.local=fo.parse.from3DS._tri_local(e,r,n)),r+=n}return s},fo.parse.from3DS._tri_vertexl=function(e,t,i){var s=[],r=t+6,o=fo.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)s.push(fo.bin.rf(e,r)),s.push(fo.bin.rf(e,r+4)),s.push(fo.bin.rf(e,r+8)),r+=12;return s},fo.parse.from3DS._tri_facel1=function(e,t,i){var s=[],r=t+6,o=fo.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)s.push(fo.bin.rsl(e,r)),s.push(fo.bin.rsl(e,r+2)),s.push(fo.bin.rsl(e,r+4)),r+=8;return s},fo.parse.from3DS._tri_mappingcoors=function(e,t,i){var s=[],r=t+6,o=fo.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)s.push(fo.bin.rf(e,r)),s.push(1-fo.bin.rf(e,r+4)),r+=8;return s},fo.parse.from3DS._tri_local=function(e,t,i){var s={},r=t+6;return s.X=[fo.bin.rf(e,r),fo.bin.rf(e,r+4),fo.bin.rf(e,r+8)],r+=12,s.Y=[fo.bin.rf(e,r),fo.bin.rf(e,r+4),fo.bin.rf(e,r+8)],r+=12,s.Z=[fo.bin.rf(e,r),fo.bin.rf(e,r+4),fo.bin.rf(e,r+8)],r+=12,s.C=[fo.bin.rf(e,r),fo.bin.rf(e,r+4),fo.bin.rf(e,r+8)],r+=12,s},fo.parse.fromBIV=function(e){e=new Uint8Array(e);var t={},i={};return i.id=fo.bin.ril(e,0),i.verS=fo.bin.ril(e,4),i.texS=fo.bin.ril(e,8),i.indS=fo.bin.ril(e,12),i.verO=fo.bin.ril(e,16),i.verL=fo.bin.ril(e,20),i.texO=fo.bin.ril(e,24),i.texL=fo.bin.ril(e,28),i.indO=fo.bin.ril(e,32),i.indL=fo.bin.ril(e,36),0!=i.verO&&(t.vertices=fo.parse.fromBIV._readFloats(e,i.verO,i.verL)),0!=i.texO&&(t.uvt=fo.parse.fromBIV._readFloats(e,i.texO,i.texL)),0!=i.indO&&(t.indices=fo.parse.fromBIV._readInts(e,i.indO,i.indL,i.indS)),t},fo.parse.toBIV=function(e){for(var t=0,i=0;i<e.indices.length;i++)t=Math.max(t,e.indices[i]);var s=32;t<=65535&&(s=16);var r=40;e.vertices&&(r+=4*e.vertices.length),e.uvt&&(r+=4*e.uvt.length),e.indices&&(r+=e.indices.length*s/8);var o=new Uint8Array(r);fo.bin.wil(o,0,1769365870),fo.bin.wil(o,4,32),fo.bin.wil(o,8,32),fo.bin.wil(o,12,s);var n=40;return e.vertices&&(fo.bin.wil(o,16,n),fo.bin.wil(o,20,4*e.vertices.length),fo.parse.fromBIV._writeFloats(o,n,e.vertices),n+=4*e.vertices.length),e.uvt&&(fo.bin.wil(o,24,n),fo.bin.wil(o,28,4*e.uvt.length),fo.parse.fromBIV._writeFloats(o,n,e.uvt),n+=4*e.uvt.length),e.indices&&(fo.bin.wil(o,32,n),fo.bin.wil(o,36,4*e.indices.length),fo.parse.fromBIV._writeInts(o,n,e.indices,s)),o.buffer},fo.parse.fromBIV._readFloats=function(e,t,i){for(var s=[],r=0;r<i/4;r++)s.push(fo.bin.rf(e,t+4*r));return s},fo.parse.fromBIV._writeFloats=function(e,t,i){for(var s=0;s<i.length;s++)fo.bin.wf(e,t+4*s,i[s])},fo.parse.fromBIV._readInts=function(e,t,i,s){for(var r=[],o=0;o<i/4;o++)16==s&&r.push(fo.bin.rsl(e,t+2*o)),32==s&&r.push(fo.bin.ril(e,t+4*o));return r},fo.parse.fromBIV._writeInts=function(e,t,i,s){for(var r=0;r<i.length;r++)16==s&&fo.bin.wsl(e,t+2*r,i[r]),32==s&&fo.bin.wil(e,t+4*r,i[r])},fo.gen={},fo.gen.Plane=function(e,t,i,s){i||(i=1),s||(s=1);for(var r={verts:[],inds:[],uvt:[]},o=e+1,n=t+1,a=0;a<n;a++)for(var l=0;l<o;l++){var h=l*(2/e)-1,c=a*(2/t)-1;r.verts.push(h,c,0),r.uvt.push(i*l/e,s*a/t),a<t&&l<e&&r.inds.push(a*o+l,a*o+l+1,(a+1)*o+l,a*o+l+1,(a+1)*o+l,(a+1)*o+l+1)}return r},fo.gen.Cube=function(){return{verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,.5,1/4,1/4,.5,.5,.5,1,1/4,3/4,1/4,1,.5,3/4,.5,0,1/4,1/4,1/4,0,.5,1/4,.5,3/4,1/4,.5,1/4,3/4,.5,.5,.5,1/4,1/4,.5,1/4,1/4,0,.5,0,1/4,.5,.5,.5,1/4,3/4,.5,3/4]}},fo.gen.Sphere=function(e,t){for(var i={verts:[],inds:[],uvt:[]},s=e+1,r=t+1,o=0;o<r;o++)for(var n=0;n<s;n++){var a=-Math.PI/2+o*Math.PI/t,l=2*n*Math.PI/e,h=Math.cos(a)*Math.cos(l),c=Math.sin(a),u=Math.cos(a)*Math.sin(l);i.verts.push(h,c,u),i.uvt.push(n/e,o/t),o<t&&n<e&&i.inds.push(s*o+n,s*o+n+1,s*(o+1)+n,s*o+n+1,s*(o+1)+n,s*(o+1)+n+1)}return i},fo.mat={},fo.mat.scale=function(e,t,i){return[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]},fo.mat.translate=function(e,t,i){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1]},fo.mat.rotateDeg=function(e,t,i){var s=Math.PI/180;return fo.mat.rotate(e*s,t*s,i*s)},fo.mat.rotate=function(e,t,i){var s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=e,o=t,n=i,a=Math.cos(r),l=Math.cos(o),h=Math.cos(n),c=Math.sin(r),u=Math.sin(o),d=Math.sin(n);return s[0]=l*h,s[1]=-l*d,s[2]=u,s[4]=a*d+c*u*h,s[5]=a*h-c*u*d,s[6]=-c*l,s[8]=c*d-a*u*h,s[9]=c*h+a*u*d,s[10]=a*l,s},fo.edit={},fo.edit.interpolate=function(e,t,i,s){for(var r=0;r<e.length;r++)i[r]=e[r]+s*(t[r]-e[r])},fo.edit.transform=function(e,t){for(var i=0;i<e.length;i+=3){var s=e[i],r=e[i+1],o=e[i+2];e[i+0]=t[0]*s+t[4]*r+t[8]*o+t[12],e[i+1]=t[1]*s+t[5]*r+t[9]*o+t[13],e[i+2]=t[2]*s+t[6]*r+t[10]*o+t[14]}},fo.edit.unwrap=function(e,t,i){for(var s=new Array(Math.floor(e.length/3)*i),r=0;r<e.length;r++)for(var o=0;o<i;o++)s[r*i+o]=t[e[r]*i+o];return s},fo.edit.remap=function(e,t,i,s){for(var r=new Array(i.length),o=0;o<e.length;o++)for(var n=0;n<s;n++)r[t[o]*s+n]=i[e[o]*s+n];return r},fo.utils={},fo.utils.getAABB=function(e){var t,i,s,r,o,n;r=o=n=-(t=i=s=999999999);for(var a=0;a<e.length;a+=3){var l=e[a+0],h=e[a+1],c=e[a+2];l<t&&(t=l),l>r&&(r=l),h<i&&(i=h),h>o&&(o=h),c<s&&(s=c),h>n&&(n=c)}return{min:{x:t,y:i,z:s},max:{x:r,y:o,z:n}}};class _o extends T{constructor(e,t={}){super(e,t),this._type=t.type||(t.src?t.src.split(".").pop():null)||"jpg",this._pos=p.vec3(t.pos||[0,0,0]),this._up=p.vec3(t.up||[0,1,0]),this._normal=p.vec3(t.normal||[0,0,1]),this._height=t.height||1,this._origin=p.vec3(),this._rtcPos=p.vec3(),this._imageSize=p.vec2(),this._texture=new ho(this),this._image=new Image,"jpg"!==this._type&&"png"!==this._type&&(this.error('Unsupported type - defaulting to "jpg"'),this._type="jpg"),this._node=new eo(this,{matrix:p.inverseMat4(p.lookAtMat4v(this._pos,p.subVec3(this._pos,this._normal,p.mat4()),this._up,p.mat4())),children:[this._bitmapMesh=new Vr(this,{scale:[1,1,1],rotation:[-90,0,0],collidable:t.collidable,pickable:t.pickable,opacity:t.opacity,clippable:t.clippable,geometry:new hs(this,mo({center:[0,0,0],xSize:1,zSize:1,xSegments:2,zSegments:2})),material:new fs(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:this._texture,emissiveMap:this._texture,backfaces:!0})})]}),t.image?this.image=t.image:t.src?this.src=t.src:t.imageData&&(this.imageData=t.imageData),this.scene._bitmapCreated(this)}set visible(e){this._bitmapMesh.visible=e}get visible(){return this._bitmapMesh.visible}set image(e){this._image=e,this._image&&(this._texture.image=this._image,this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updateBitmapMeshScale())}get image(){return this._image}set src(e){if(e){this._image.onload=()=>{this._texture.image=this._image,this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updateBitmapMeshScale()},this._image.src=e;switch(e.split(".").pop()){case"jpeg":case"jpg":this._type="jpg";break;case"png":this._type="png"}}}get src(){return this._image.src}set imageData(e){this._image.onload=()=>{this._texture.image=image,this._imageSize[0]=image.width,this._imageSize[1]=image.height,this._updateBitmapMeshScale()},this._image.src=e}get imageData(){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=this._image.width,e.height=this._image.height,t.drawImage(this._image,0,0),e.toDataURL("jpg"===this._type?"image/jpeg":"image/png")}set type(e){"png"===(e=e||"jpg")&&"jpg"===e||(this.error("Unsupported value for `type` - supported types are `jpg` and `png` - defaulting to `jpg`"),e="jpg"),this._type=e}get type(){return this._type}get pos(){return this._pos}get normal(){return this._normal}get up(){return this._up}set height(e){this._height=null==e?1:e,this._image&&this._updateBitmapMeshScale()}get height(){return this._height}set collidable(e){this._bitmapMesh.collidable=!1!==e}get collidable(){return this._bitmapMesh.collidable}set clippable(e){this._bitmapMesh.clippable=!1!==e}get clippable(){return this._bitmapMesh.clippable}set pickable(e){this._bitmapMesh.pickable=!1!==e}get pickable(){return this._bitmapMesh.pickable}set opacity(e){this._bitmapMesh.opacity=e}get opacity(){return this._bitmapMesh.opacity}destroy(){super.destroy(),this.scene._bitmapDestroyed(this)}_updateBitmapMeshScale(){const e=this._imageSize[1]/this._imageSize[0];this._bitmapMesh.scale=[this._height*e,1,this._height]}}class vo extends T{constructor(e,t={}){if(super(e,t),this._positions=t.positions||[],this._origin=p.vec3(t.origin||[0,0,0]),t.indices)this._indices=t.indices;else{this._indices=[];for(let e=0,t=this._positions.length/3-1;e<t;e+=2)this._indices.push(e),this._indices.push(e+1)}this._mesh=new Vr(this,{visible:t.visible,clippable:t.clippable,collidable:t.collidable,geometry:new po(this,{primitive:"lines",positions:this._positions,indices:this._indices,origin:t.origin}),material:new fs(this,{diffuse:t.color||[0,0,0],emissive:t.color||[0,0,0]})}),this.scene._lineSetCreated(this)}set visible(e){this._mesh.visible=e}get visible(){return this._mesh.visible}get positions(){return this._positions}get indices(){return this._indices}destroy(){super.destroy(),this.scene._lineSetDestroyed(this)}}const bo=p.vec3(),xo=p.vec3(),yo=p.vec3(),Po=p.vec3();class wo extends a{constructor(e,t={}){super("BCFViewpoints",e,t),this.originatingSystem=t.originatingSystem||"xeokit.io",this.authoringTool=t.authoringTool||"xeokit.io"}getViewpoint(e={}){const t=this.viewer.scene,i=t.camera,s=t.realWorldOffset,r=!0===e.reverseClippingPlanes;let o={},n=p.normalizeVec3(p.subVec3(i.look,i.eye,p.vec3())),a=i.eye,l=i.up;i.yUp&&(n=Eo(n),a=Eo(a),l=Eo(l));const h=Mo(p.addVec3(a,s));"ortho"===i.projection?o.orthogonal_camera={camera_view_point:h,camera_direction:Mo(n),camera_up_vector:Mo(l),view_to_world_scale:i.ortho.scale}:o.perspective_camera={camera_view_point:h,camera_direction:Mo(n),camera_up_vector:Mo(l),field_of_view:i.perspective.fov};const c=t.sectionPlanes;for(let e in c)if(c.hasOwnProperty(e)){let t=c[e];if(!t.active)continue;let n,a=t.pos;n=r?p.negateVec3(t.dir,p.vec3()):t.dir,i.yUp&&(a=Eo(a),n=Eo(n)),p.addVec3(a,s),a=Mo(a),n=Mo(n),o.clipping_planes||(o.clipping_planes=[]),o.clipping_planes.push({location:a,direction:n})}const u=t.lineSets;for(let e in u)if(u.hasOwnProperty(e)){const t=u[e];o.lines||(o.lines=[]);const i=t.positions,s=t.indices;for(let e=0,t=s.length/2;e<t;e++){const t=s[2*e],r=s[2*e+1];o.lines.push({start_point:{x:i[3*t+0],y:i[3*t+1],z:i[3*t+2]},end_point:{x:i[3*r+0],y:i[3*r+1],z:i[3*r+2]}})}}const d=t.bitmaps;for(let e in d)if(d.hasOwnProperty(e)){let t=d[e],r=t.pos,n=t.normal,a=t.up;i.yUp&&(r=Eo(r),n=Eo(n),a=Eo(a)),p.addVec3(r,s),o.bitmaps||(o.bitmaps=[]),o.bitmaps.push({bitmap_type:t.type,bitmap_data:t.imageData,location:Mo(r),normal:Mo(n),up:Mo(a),height:t.height})}o.components={visibility:{view_setup_hints:{spaces_visible:!!e.spacesVisible,space_boundaries_visible:!!e.spaceBoundariesVisible,openings_visible:!!e.openingsVisible}}};const f=new Set(t.opacityObjectIds),m=new Set(t.xrayedObjectIds),g=new Set(t.colorizedObjectIds),_=Object.values(t.objects).filter((e=>f.has(e.id)||g.has(e.id)||m.has(e.id))).reduce(((e,i)=>{let s,r=function(e){let t="";return t+=Math.round(255*e[0]).toString(16).padStart(2,"0"),t+=Math.round(255*e[1]).toString(16).padStart(2,"0"),t+=Math.round(255*e[2]).toString(16).padStart(2,"0"),t}(i.colorize);i.xrayed?(s=0===t.xrayMaterial.fillAlpha&&0!==t.xrayMaterial.edgeAlpha?.1:t.xrayMaterial.fillAlpha,s=Math.round(255*s).toString(16).padStart(2,"0"),r=s+r):f.has(i.id)&&(s=Math.round(255*i.opacity).toString(16).padStart(2,"0"),r=s+r),e[r]||(e[r]=[]);const o=i.id,n=i.originalSystemId,a={ifc_guid:n,originating_system:this.originatingSystem};return n!==o&&(a.authoring_tool_id=o),e[r].push(a),e}),{}),v=Object.entries(_).map((([e,t])=>({color:e,components:t})));o.components.coloring=v;const b=t.objectIds,x=t.visibleObjects,y=t.visibleObjectIds,P=b.filter((e=>!x[e])),w=t.selectedObjectIds;return e.defaultInvisible||y.length<P.length?(o.components.visibility.exceptions=this._createBCFComponents(y),o.components.visibility.default_visibility=!1):(o.components.visibility.exceptions=this._createBCFComponents(P),o.components.visibility.default_visibility=!0),o.components.selection=this._createBCFComponents(w),!1!==e.snapshot&&(o.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),o}_createBCFComponents(e){const t=this.viewer.scene,i=[];for(let s=0,r=e.length;s<r;s++){const r=e[s],o=t.objects[r];if(o){const e={ifc_guid:o.originalSystemId,originating_system:this.originatingSystem};o.originalSystemId!==r&&(e.authoring_tool_id=r),i.push(e)}}return i}setViewpoint(e,t={}){if(!e)return;const i=this.viewer,s=i.scene,r=s.camera,o=!1!==t.rayCast,n=!1!==t.immediate,a=!1!==t.reset,l=s.realWorldOffset,h=!0===t.reverseClippingPlanes;if(s.clearSectionPlanes(),e.clipping_planes&&e.clipping_planes.forEach((function(e){let t=Co(e.location,bo),i=Co(e.direction,bo);h&&p.negateVec3(i),p.subVec3(t,l),r.yUp&&(t=Ao(t),i=Ao(i)),new Wr(s,{pos:t,dir:i})})),s.clearLines(),e.lines){const t=[],i=[];let r=0;e.lines.forEach((e=>{e.start_point&&e.end_point&&(t.push(e.start_point.x),t.push(e.start_point.y),t.push(e.start_point.z),t.push(e.end_point.x),t.push(e.end_point.y),t.push(e.end_point.z),i.push(r++),i.push(r++))})),new vo(s,{positions:t,indices:i,clippable:!1,collidable:!0})}if(s.clearBitmaps(),e.bitmaps&&e.bitmaps.forEach((function(e){const t=e.bitmap_type||"jpg",i=e.bitmap_data;let o=Co(e.location,xo),n=Co(e.normal,yo),a=Co(e.up,Po),l=e.height||1;t&&i&&o&&n&&a&&(r.yUp&&(o=Ao(o),n=Ao(n),a=Ao(a)),new _o(s,{src:i,type:t,pos:o,normal:n,up:a,clippable:!1,collidable:!0,height:l}))})),a&&(s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsHighlighted(s.highlightedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1)),e.components){if(e.components.visibility){e.components.visibility.default_visibility?(s.setObjectsVisible(s.objectIds,!0),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((e=>this._withBCFComponent(t,e,(e=>e.visible=!1))))):(s.setObjectsVisible(s.objectIds,!1),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((e=>this._withBCFComponent(t,e,(e=>e.visible=!0)))));const r=e.components.visibility.view_setup_hints;r&&(!1===r.spaces_visible&&s.setObjectsVisible(i.metaScene.getObjectIDsByType("IfcSpace"),!1),!1===r.openings_visible&&s.setObjectsVisible(i.metaScene.getObjectIDsByType("IfcOpening"),!1),r.space_boundaries_visible)}e.components.selection&&(s.setObjectsSelected(s.selectedObjectIds,!1),e.components.selection.forEach((e=>this._withBCFComponent(t,e,(e=>e.selected=!0))))),e.components.coloring&&e.components.coloring.forEach((e=>{let i=e.color,s=0,r=!1;8===i.length&&(s=parseInt(i.substring(0,2),16)/256,s<=1&&s>=.95&&(s=1),i=i.substring(2),r=!0);const o=[parseInt(i.substring(0,2),16)/256,parseInt(i.substring(2,4),16)/256,parseInt(i.substring(4,6),16)/256];e.components.map((e=>this._withBCFComponent(t,e,(e=>{e.colorize=o,r&&(e.opacity=s)}))))}))}if(e.perspective_camera||e.orthogonal_camera){let a,h,c,u;if(e.perspective_camera?(a=Co(e.perspective_camera.camera_view_point,bo),h=Co(e.perspective_camera.camera_direction,bo),c=Co(e.perspective_camera.camera_up_vector,bo),r.perspective.fov=e.perspective_camera.field_of_view,u="perspective"):(a=Co(e.orthogonal_camera.camera_view_point,bo),h=Co(e.orthogonal_camera.camera_direction,bo),c=Co(e.orthogonal_camera.camera_up_vector,bo),r.ortho.scale=e.orthogonal_camera.view_to_world_scale,u="ortho"),p.subVec3(a,l),r.yUp&&(a=Ao(a),h=Ao(h),c=Ao(c)),o){const e=s.pick({pickSurface:!0,origin:a,direction:h});h=e?e.worldPos:p.addVec3(a,h,bo)}else h=p.addVec3(a,h,bo);n?(r.eye=a,r.look=h,r.up=c,r.projection=u):i.cameraFlight.flyTo({eye:a,look:h,up:c,duration:t.duration,projection:u})}}_withBCFComponent(e,t,i){const s=this.viewer,r=s.scene;if(t.authoring_tool_id&&t.originating_system===this.originatingSystem){const o=t.authoring_tool_id,n=r.objects[o];if(n)return void i(n);if(e.updateCompositeObjects){if(s.metaScene.metaObjects[o])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(o),i)}}if(t.ifc_guid){const o=t.ifc_guid,n=r.objects[o];if(n)return void i(n);if(e.updateCompositeObjects){if(s.metaScene.metaObjects[o])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(o),i)}Object.keys(r.models).forEach((t=>{const n=p.globalizeObjectId(t,o),a=r.objects[n];if(a)i(a);else if(e.updateCompositeObjects){s.metaScene.metaObjects[n]&&r.withObjects(s.metaScene.getObjectIDsInSubtree(n),i)}}))}}destroy(){super.destroy()}}function Mo(e){return{x:e[0],y:e[1],z:e[2]}}function Co(e,t){return(t=new Float64Array(3))[0]=e.x,t[1]=e.y,t[2]=e.z,t}function Eo(e){return new Float64Array([e[0],-e[2],e[1]])}function Ao(e){return new Float64Array([e[0],e[2],-e[1]])}p.vec3();class Do{constructor(e={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=e.messages,this.locale=e.locale}set messages(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}loadMessages(e={}){for(let t in e)this._messages[t]=e[t];this.messages=this._messages}clearMessages(){this.messages={}}get locales(){return this._locales}set locale(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}get locale(){return this._locale}translate(e,t){const i=this._messages[this._locale];if(!i)return null;const s=To(e,i);return s?t?So(s,t):s:null}translatePlurals(e,t,i){const s=this._messages[this._locale];if(!s)return null;let r=To(e,s);return r=0===(t=parseInt(""+t,10))?r.zero:t>1?r.other:r.one,r?(r=So(r,[t]),i&&(r=So(r,i)),r):null}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];if(s)for(const e in s)if(s.hasOwnProperty(e)){s[e].callback(t)}}on(e,i){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new t),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let s=this._eventSubs[e];s||(s={},this._eventSubs[e]=s);const r=this._eventSubIDMap.addItem();s[r]={callback:i},this._eventSubEvents[r]=e;const o=this._events[e];return void 0!==o&&i(o),r}off(e){if(null==e)return;if(!this._eventSubEvents)return;const t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._eventSubIDMap.removeItem(e)}}}function To(e,t){if(t[e])return t[e];const i=e.split(".");let s=t;for(let e=0,t=i.length;s&&e<t;e++){s=s[i[e]]}return s}function So(e,t=[]){return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,i){return"{{"===e?"{":"}}"===e?"}":t[i]}))}p.vec3();const Io=p.vec3(),Fo=p.vec3(),Lo=p.vec3(),Bo=p.vec3(),Ro=p.vec3();class ko extends T{get type(){return"CameraFlightAnimation"}constructor(e,t={}){super(e,t),this._look1=p.vec3(),this._eye1=p.vec3(),this._up1=p.vec3(),this._look2=p.vec3(),this._eye2=p.vec3(),this._up2=p.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==t.easing,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail}flyTo(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;const s=this.scene.camera,r=!!e.projection&&e.projection!==s.projection;let o,n,a,l,h;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)o=e.aabb;else if(6===e.length)o=e;else if(e.eye&&e.look||e.up)n=e.eye,a=e.look,l=e.up;else if(e.eye)n=e.eye;else if(e.look)a=e.look;else{let s=e;if((v.isNumeric(s)||v.isString(s))&&(h=s,s=this.scene.components[h],!s))return this.error("Component not found: "+v.inQuotes(h)),void(t&&(i?t.call(i):t()));r||(o=s.aabb||this.scene.aabb)}const c=e.poi;if(o){if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return;if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return;o=o.slice();const t=p.getAABB3Center(o);this._look2=c||t;const i=p.subVec3(this._eye1,this._look1,Io),s=p.normalizeVec3(i),r=c?p.getAABB3DiagPoint(o,c):p.getAABB3Diag(o),n=e.fitFOV||this._fitFOV,a=Math.abs(r/Math.tan(n*p.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*a,this._eye2[1]=this._look2[1]+s[1]*a,this._eye2[2]=this._look2[2]+s[2]*a,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(n||a||l)&&(this._flyingEyeLookUp=!!n&&!!a&&!!l,this._flyingEye=!!n&&!a,this._flyingLook=!!a&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),a&&(this._look2[0]=a[0],this._look2[1]=a[1],this._look2[2]=a[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));r?("ortho"===e.projection&&"ortho"!==s.projection&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),"perspective"===e.projection&&"perspective"!==s.projection&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(e.duration?1e3*e.duration:this._duration),this._flying=!0,A.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var i,s,r,o,n;if(e.aabb)i=e.aabb;else if(6===e.length)i=e;else if(e.eye||e.look||e.up)r=e.eye,o=e.look,n=e.up;else{let t=e;if((v.isNumeric(t)||v.isString(t))&&(s=t,t=this.scene.components[s],!t))return void this.error("Component not found: "+v.inQuotes(s));i=t.aabb||this.scene.aabb}const a=e.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var l=a?p.getAABB3DiagPoint(i,a):p.getAABB3Diag(i);let s;o=a||p.getAABB3Center(i,o),this._trail?p.subVec3(t.look,o,Ro):p.subVec3(t.eye,t.look,Ro),p.normalizeVec3(Ro);s=(void 0!==e.fit?e.fit:this._fit)?Math.abs(l/Math.tan((e.fitFOV||this._fitFOV)*p.DEGTORAD)):p.lenVec3(p.subVec3(t.eye,t.look,Io)),p.mulVec3Scalar(Ro,s),t.eye=p.addVec3(o,Ro,Io),t.look=o,this.scene.camera.ortho.scale=1.1*l}else(r||o||n)&&(r&&(t.eye=r),o&&(t.look=o),n&&(t.up=n));e.projection&&(t.projection=e.projection)}_update(){if(!this._flying)return;let e=(Date.now()-this._time1)/(this._time2-this._time1);const t=e>=1;e>1&&(e=1);const i=this.easing?ko._ease(e,0,1,1):e,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(p.subVec3(s.eye,s.look,Ro),s.eye=p.lerpVec3(i,0,1,this._eye1,this._eye2,Lo),s.look=p.subVec3(Lo,Ro,Fo)):this._flyingLook&&(s.look=p.lerpVec3(i,0,1,this._look1,this._look2,Fo),s.up=p.lerpVec3(i,0,1,this._up1,this._up2,Bo)):this._flyingEyeLookUp&&(s.eye=p.lerpVec3(i,0,1,this._eye1,this._eye2,Lo),s.look=p.lerpVec3(i,0,1,this._look1,this._look2,Fo),s.up=p.lerpVec3(i,0,1,this._up1,this._up2,Bo)),this._projection2){const t="ortho"===this._projection2?ko._easeOutExpo(e,0,1,1):ko._easeInCubic(e,0,1,1);s.customProjection.matrix=p.lerpMat4(t,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1);if(t)return s.ortho.scale=this._orthoScale2,void this.stop();A.scheduleTask(this._update,this)}static _ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}static _easeInCubic(e,t,i,s){return i*(e/=s)*e*e+t}static _easeOutExpo(e,t,i,s){return i*(1-Math.pow(2,-10*e/s))+t}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=e?1e3*e:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=!1!==e}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}class Oo extends T{get type(){return"CameraPathAnimation"}constructor(e,t={}){super(e,t),this._cameraFlightAnimation=new ko(this),this._t=0,this.state=Oo.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=t.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=t.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const e=this._cameraPath;if(!e)return;let t,i;const s=performance.now(),r=this._lastTime?.001*(s-this._lastTime):0;if(this._lastTime=s,0!==r)switch(this.state){case Oo.SCRUBBING:return;case Oo.PLAYING:if(this._t+=this._playingRate*r,t=this._cameraPath.frames.length,0===t||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[t-1].t)return this.state=Oo.SCRUBBING,this._t=this._cameraPath.frames[t-1].t,void this.fire("stopped");e.loadFrame(this._t);break;case Oo.PLAYING_TO:i=this._t+this._playingRate*r*this._playingDir,(this._playingDir<0&&i<=this._playingToT||this._playingDir>0&&i>=this._playingToT)&&(i=this._playingToT,this.state=Oo.SCRUBBING,this.fire("stopped")),this._t=i,e.loadFrame(this._t)}}_ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}set cameraPath(e){this._cameraPath=e}get cameraPath(){return this._cameraPath}set rate(e){this._playingRate=e}get rate(){return this._playingRate}play(){this._cameraPath&&(this._lastTime=null,this.state=Oo.PLAYING)}playToT(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=Oo.PLAYING_TO)}playToFrame(e){const t=this._cameraPath;if(!t)return;const i=t.frames[e];i?this.playToT(i.t):this.error("playToFrame - frame index out of range: "+e)}flyToFrame(e,t){const i=this._cameraPath;if(!i)return;const s=i.frames[e];s?(this.state=Oo.SCRUBBING,this._cameraFlightAnimation.flyTo(s,t)):this.error("flyToFrame - frame index out of range: "+e)}scrubToT(e){const t=this._cameraPath;if(!t)return;this.scene.camera&&(this._t=e,t.loadFrame(this._t),this.state=Oo.SCRUBBING)}scrubToFrame(e){const t=this._cameraPath;if(!t)return;if(!this.scene.camera)return;t.frames[e]?(t.loadFrame(this._t),this.state=Oo.SCRUBBING):this.error("playToFrame - frame index out of range: "+e)}stop(){this.state=Oo.SCRUBBING,this.fire("stopped")}destroy(){super.destroy(),this.scene.off(this._tick)}}Oo.STOPPED=0,Oo.SCRUBBING=1,Oo.PLAYING=2,Oo.PLAYING_TO=3,p.vec3(),p.vec3(),p.vec3(),p.vec3([0,-1,0]),p.vec4([0,0,0,1]);const No=p.vec3(),jo=p.vec3(),Vo=p.mat4();class zo{constructor(){this.normal=p.vec3(),this.offset=0,this.testVertex=p.vec3()}set(e,t,i,s){const r=1/Math.sqrt(e*e+t*t+i*i);this.normal[0]=e*r,this.normal[1]=t*r,this.normal[2]=i*r,this.offset=s*r,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}}class Uo{constructor(){this.planes=[new zo,new zo,new zo,new zo,new zo,new zo]}}function Go(e,t){let i=Uo.INSIDE;const s=No,r=jo;s[0]=t[0],s[1]=t[1],s[2]=t[2],r[0]=t[3],r[1]=t[4],r[2]=t[5];const o=[s,r];for(let t=0;t<6;++t){const s=e.planes[t];if(s.normal[0]*o[s.testVertex[0]][0]+s.normal[1]*o[s.testVertex[1]][1]+s.normal[2]*o[s.testVertex[2]][2]+s.offset<0)return Uo.OUTSIDE;s.normal[0]*o[1-s.testVertex[0]][0]+s.normal[1]*o[1-s.testVertex[1]][1]+s.normal[2]*o[1-s.testVertex[2]][2]+s.offset<0&&(i=Uo.INTERSECT)}return i}Uo.INSIDE=0,Uo.INTERSECT=1,Uo.OUTSIDE=2;const Wo=p.vec3();class Ho{constructor(e){if(this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,e){const t=e.metaScene.scene;this.saveObjects(t,e)}}saveObjects(e,t,i){const s=t.rootMetaObject;if(!s)return;const r=s.getObjectIDsInSubtree();this.numObjects=0,this._mask=i?v.apply(i,{}):null;const o=e.objects,n=!i||i.visible,a=!i||i.edges,l=!i||i.xrayed,h=!i||i.highlighted,c=!i||i.selected,u=!i||i.clippable,d=!i||i.pickable,p=!i||i.colorize,f=!i||i.opacity;for(var m=0,g=r.length;m<g;m++){const e=o[r[m]];if(e){if(n&&(this.objectsVisible[m]=e.visible),a&&(this.objectsEdges[m]=e.edges),l&&(this.objectsXrayed[m]=e.xrayed),h&&(this.objectsHighlighted[m]=e.highlighted),c&&(this.objectsSelected[m]=e.selected),u&&(this.objectsClippable[m]=e.clippable),d&&(this.objectsPickable[m]=e.pickable),p){const t=e.colorize;this.objectsColorize[3*m+0]=t[0],this.objectsColorize[3*m+1]=t[1],this.objectsColorize[3*m+2]=t[2]}f&&(this.objectsOpacity[m]=e.opacity),this.numObjects++}}}restoreObjects(e,t){const i=t.rootMetaObject;if(!i)return;const s=i.getObjectIDsInSubtree(),r=this._mask,o=!r||r.visible,n=!r||r.edges,a=!r||r.xrayed,l=!r||r.highlighted,h=!r||r.selected,c=!r||r.clippable,u=!r||r.pickable,d=!r||r.colorize,p=!r||r.opacity,f=e.objects;for(var m=0,g=s.length;m<g;m++){const e=f[s[m]];e&&(o&&(e.visible=this.objectsVisible[m]),n&&(e.edges=this.objectsEdges[m]),a&&(e.xrayed=this.objectsXrayed[m]),l&&(e.highlighted=this.objectsHighlighted[m]),h&&(e.selected=this.objectsSelected[m]),c&&(e.clippable=this.objectsClippable[m]),u&&(e.pickable=this.objectsPickable[m]),d&&(Wo[0]=this.objectsColorize[3*m+0],Wo[1]=this.objectsColorize[3*m+1],Wo[2]=this.objectsColorize[3*m+2],e.colorize=Wo),p&&(e.opacity=this.objectsOpacity[m]))}}}p.vec3();class Xo{constructor(e,t,i,s,r=null,o=0){this.model=e,this.object=null,this.parent=null,this.id=t,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=p.AABB3(),this._layer=r,this._portionId=o,this._color=[i[0],i[1],i[2],s],this._colorize=[i[0],i[1],i[2],s],this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.origin=null}_finalize(e){this._layer.initFlags(this._portionId,e,this._transparent)}_finalize2(){this._layer.flushInitFlags&&this._layer.flushInitFlags()}_setVisible(e){this._layer.setVisible(this._portionId,e,this._transparent)}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1)}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1)}_setOpacity(e,t){const i=e<255,s=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),s&&this._layer.setTransparent(this._portionId,t,i)}_setOffset(e){this._layer.setOffset(this._portionId,e)}_setHighlighted(e){this._layer.setHighlighted(this._portionId,e,this._transparent)}_setXRayed(e){this._layer.setXRayed(this._portionId,e,this._transparent)}_setSelected(e){this._layer.setSelected(this._portionId,e,this._transparent)}_setEdges(e){this._layer.setEdges(this._portionId,e,this._transparent)}_setClippable(e){this._layer.setClippable(this._portionId,e,this._transparent)}_setCollidable(e){this._layer.setCollidable(this._portionId,e)}_setPickable(e){this._layer.setPickable(this._portionId,e,this._transparent)}_setCulled(e){this._layer.setCulled(this._portionId,e,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(e,t){}pickTriangleSurface(e){}precisionRayPickSurface(e,t,i,s){return!!this._layer.precisionRayPickSurface&&this._layer.precisionRayPickSurface(this._portionId,e,t,i,s)}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const Yo=new class{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(e){let t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}getFloat32Array(e){let t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}};let qo=0;const $o=0,Zo=1,Ko=2,Qo=3,Jo=4,en=5,tn=6,sn=7,rn=8,on=9,nn=10,an=11,ln=p.vec4(),hn=p.vec3();class cn{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,r=o.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(l){const e=H(i.dist,i.dir,l,hn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState.lights,o=t.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(this._withSAO){const s=t.sao;if(s.possible){const t=i.drawingBufferWidth,r=i.drawingBufferHeight;ln[0]=t,ln[1]=r,ln[2]=s.blendCutoff,ln[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,ln),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.sectionPlanes.length>0;let r;const o=[];o.push("#version 300 es"),o.push("// Triangles batching draw vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec4 flags;"),o.push("in vec4 flags2;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++)r=i.lights[e],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")));o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out vec4 vFlags2;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let e=0,t=i.lights.length;e<t;e++)if(r=i.lights[e],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const un=p.vec4(),dn=p.vec3();class pn{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,r=o.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t],o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(l){const e=H(i.dist,i.dir,l,dn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState.lights,o=t.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(this._withSAO){const s=t.sao;if(s.possible){const t=i.drawingBufferWidth,r=i.drawingBufferHeight;un[0]=t,un[1]=r,un[2]=s.blendCutoff,un[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,un),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching flat-shading draw vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._lightsState,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching flat-shading draw fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),s){r.push("in vec4 vWorldPosition;"),r.push("in vec4 vFlags2;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";")}r.push("uniform mat4 viewMatrix;"),r.push("uniform vec4 lightAmbient;");for(let e=0,i=t.lights.length;e<i;e++){const i=t.lights[e];"ambient"!==i.type&&(r.push("uniform vec4 lightColor"+e+";"),"dir"===i.type&&r.push("uniform vec3 lightDir"+e+";"),"point"===i.type&&r.push("uniform vec3 lightPos"+e+";"),"spot"===i.type&&(r.push("uniform vec3 lightPos"+e+";"),r.push("uniform vec3 lightDir"+e+";")))}if(r.push("in vec4 vViewPosition;"),r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}r.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),r.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),r.push("float lambertian = 1.0;"),r.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),r.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),r.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,i=t.lights.length;e<i;e++){const i=t.lights[e];if("ambient"!==i.type){if("dir"===i.type)"view"===i.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===i.type)"view"===i.space?r.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):r.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==i.type)continue;"view"===i.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}r.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),r.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return r.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):r.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled&&r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const fn=new Float32Array([1,1,1]),mn=p.vec3();class gn{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===en){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uSilhouetteColor,t[0],t[1],t[2],i)}else if(i===Qo){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uSilhouetteColor,t[0],t[1],t[2],i)}else if(i===Jo){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uSilhouetteColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uSilhouetteColor,fn);const h=l?G(o.viewMatrix,l):o.viewMatrix;n.uniformMatrix4fv(this._uViewMatrix,!1,h),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,mn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSilhouetteColor=i.getLocation("silhouetteColor"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aColor=i.getAttribute("color"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 color;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching silhouette fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("outColor = vColor;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const _n=p.vec3(),vn=new Float32Array([0,0,0,1]);class bn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===nn){const e=r.xrayMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===rn){const e=r.highlightMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===on){const e=r.selectedMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,vn);n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,o=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,_n);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.edgeIndicesBuf.bind(),n.drawElements(n.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const xn=p.vec3();class yn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,o=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,xn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.edgeIndicesBuf.bind(),n.drawElements(n.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Pn=p.vec3();class wn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=e.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,c),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Pn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(a.pickColorsBuf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 pickColor;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Mn=p.vec3();class Cn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);const h=e.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Mn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const En=p.vec3();class An{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=e.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,En);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(a.normalsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Dn=p.vec3();class Tn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.canvas.gl,n=t._state,a=r.camera,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?G(a.viewMatrix,l):a.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,n=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=n.sectionPlanesActivePerLayer[i+t];if(o.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Dn);o.uniform3fv(s.pos,e)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),o.drawElements(o.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Sn=p.vec3();class In{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,o=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Sn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching depth fragment shader"),s.push("precision highp float;"),s.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("const float   packUpScale = 256. / 255.;"),s.push("const float   unpackDownscale = 255. / 256.;"),s.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),s.push("const float   shiftRight8 = 1.0 / 256.;"),s.push("vec4 packDepthToRGBA( const in float v ) {"),s.push("    vec4 r = vec4( fract( v * packFactors ), v );"),s.push("    r.yzw -= r.xyz * shiftRight8;"),s.push("    return r * packUpScale;"),s.push("}"),s.push("in vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,f.memory.programs--}}const Fn=p.vec3();class Ln{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,o=s.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Fn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Bn=p.vec3();class Rn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){const i=this._scene,s=i.canvas.gl,r=t._state;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),this._aPosition.bindArrayBuffer(r.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(r.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(r.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(r.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(r.offsetsBuf),r.indicesBuf.bind();const o=i._sectionPlanesState.sectionPlanes.length;if(o>0){const e=i._sectionPlanesState.sectionPlanes,r=t.layerIndex*o,n=model.renderFlags,a=t._state.origin;for(let t=0;t<o;t++){const i=this._uSectionPlanes[t];if(i){const o=n.sectionPlanesActivePerLayer[r+t];if(s.uniform1i(i.active,o?1:0),o){const r=e[t];if(a){const e=H(r.dist,r.dir,a,Bn);s.uniform3fv(i.pos,e)}else s.uniform3fv(i.pos,r.pos);s.uniform3fv(i.dir,r.dir)}}}}s.drawElements(s.TRIANGLES,r.indicesBuf.numItems,r.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2")}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),t.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry shadow vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  bool visible        = (float(flags.x) > 0.0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.sectionPlanes.length>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.sectionPlanes.length;s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    outColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const kn=p.vec4(),On=p.vec3();class Nn{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=Y.MAX_TEXTURE_IMAGE_UNITS,r=this._scene,o=r.camera,n=t.model,a=r.canvas.gl,l=t._state,h=t._state.origin,c=l.textureSet,u=r._lightsState;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,n.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,n.worldNormalMatrix);const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,s=n.renderFlags;for(let t=0;t<d;t++){const r=this._uSectionPlanes[t];if(r){const o=s.sectionPlanesActivePerLayer[i+t];if(a.uniform1i(r.active,o?1:0),o){const i=e[t];if(h){const e=H(i.dist,i.dir,h,On);a.uniform3fv(r.pos,e)}else a.uniform3fv(r.pos,i.pos);a.uniform3fv(r.dir,i.dir)}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(l.normalsBuf),this._aUV&&this._aUV.bindArrayBuffer(l.uvBuf),this._aColor&&this._aColor.bindArrayBuffer(l.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(l.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(l.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(l.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(l.offsetsBuf),u.reflectionMaps.length>0&&u.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,u.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++),u.lightMaps.length>0&&u.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,u.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++),this._withSAO){const t=r.sao;if(t.possible){const i=a.drawingBufferWidth,r=a.drawingBufferHeight;kn[0]=i,kn[1]=r,kn[2]=t.blendCutoff,kn[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,kn),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++}}this._program.bindTexture(this._uBaseColorMap,c.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uMetallicRoughMap,c.metallicRoughnessTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uEmissiveMap,c.emissiveTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uNormalMap,c.normalsTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uAOMap,c.occlusionTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,l.indicesBuf.bind(),a.drawElements(a.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aUV=s.getAttribute("uv"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uBaseColorMap="uBaseColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState.lights,o=t.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.sectionPlanes.length>0,r=t.clippingCaps,o=[];return o.push("#version 300 es"),o.push("// Triangles batching quality draw vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("precision highp usampler2D;"),o.push("precision highp isampler2D;"),o.push("precision highp sampler2D;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("precision mediump usampler2D;"),o.push("precision mediump isampler2D;"),o.push("precision mediump sampler2D;"),o.push("#endif"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec2 uv;"),o.push("in vec2 metallicRoughness;"),o.push("in vec4 flags;"),o.push("in vec4 flags2;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),o.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("out vec4 vViewPosition;"),o.push("out vec3 vViewNormal;"),o.push("out vec4 vColor;"),o.push("out vec2 vUV;"),o.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("out vec3 vWorldNormal;"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out vec4 vFlags2;"),r&&o.push("out vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),o.push("vFragDepth = 1.0 + clipPos.w;")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Triangles batching quality draw fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uBaseColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),n.push("uniform sampler2D uAOMap;"),n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),n.push("uniform mat4 viewMatrix;"),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;"),o&&n.push("in vec4 vClipPosition;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}if(n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),n.push("              return surf_norm;"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3  diffuseColor;"),n.push("   float specularRoughness;"),n.push("   vec3  specularColor;"),n.push("   float shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 baseColorTexel = sRGBToLinear(texture(uBaseColorMap, vUV));"),n.push("baseColor *= baseColorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("float aoFactor = texture(uAOMap, vUV).r;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const jn=p.vec3();class Vn{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=e.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,jn);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick flat normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("out vec4 vWorldPosition;"),t&&i.push("out vec4 vFlags2;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags2 = flags2;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick flat normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push("  outColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const zn=p.vec4(),Un=p.vec3();class Gn{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=Y.MAX_TEXTURE_IMAGE_UNITS,r=this._scene,o=r.camera,n=t.model,a=r.canvas.gl,l=t._state,h=t._state.origin,c=l.textureSet;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,n.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,s=n.renderFlags;for(let t=0;t<u;t++){const r=this._uSectionPlanes[t];if(r){const o=s.sectionPlanesActivePerLayer[i+t];if(a.uniform1i(r.active,o?1:0),o){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Un);a.uniform3fv(r.pos,e)}else a.uniform3fv(r.pos,i.pos);a.uniform3fv(r.dir,i.dir)}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(l.uvBuf),this._aColor&&this._aColor.bindArrayBuffer(l.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(l.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(l.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(l.offsetsBuf),c&&c.colorTexture&&(this._program.bindTexture(this._uColorMap,c.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s),this._withSAO){const t=r.sao;if(t.possible){const i=a.drawingBufferWidth,r=a.drawingBufferHeight;zn[0]=i,zn[1]=r,zn[2]=t.blendCutoff,zn[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,zn),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++}}l.indicesBuf.bind(),a.drawElements(a.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aUV=s.getAttribute("uv"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uColorMap="uColorMap",this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState.lights,o=t.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching color texture vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec2 uv;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("out vec2 vUV;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._lightsState,s=e._sectionPlanesState,r=s.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching color texture fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),o.push("uniform sampler2D uColorMap;"),this._withSAO&&(o.push("uniform sampler2D uOcclusionTexture;"),o.push("uniform vec4      uSAOParams;"),o.push("const float       packUpscale = 256. / 255.;"),o.push("const float       unpackDownScale = 255. / 256.;"),o.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),o.push("float unpackRGBToFloat( const in vec4 v ) {"),o.push("    return dot( v, unPackFactors );"),o.push("}")),o.push("uniform float gammaFactor;"),o.push("vec4 linearToLinear( in vec4 value ) {"),o.push("  return value;"),o.push("}"),o.push("vec4 sRGBToLinear( in vec4 value ) {"),o.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),o.push("}"),o.push("vec4 gammaToLinear( in vec4 value) {"),o.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),o.push("}"),t&&(o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}")),r){o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";")}o.push("uniform mat4 viewMatrix;"),o.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")))}if(o.push("in vec4 vViewPosition;"),o.push("in vec4 vColor;"),o.push("in vec2 vUV;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=s.sectionPlanes.length;e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { "),o.push("      discard;"),o.push("  }"),o.push("}")}o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;"),o.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),o.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),o.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return o.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),t?o.push("vec4 colorTexel = color * sRGBToLinear(texture(uColorMap, vUV));"):o.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),o.push("float opacity = color.a;"),this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):o.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&o.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Wn{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new cn(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new cn(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new pn(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new pn(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new Gn(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new Gn(this._scene,!0)),this._colorTextureRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new Nn(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Nn(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new gn(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new In(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Ln(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new bn(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new yn(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new wn(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new An(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Vn(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Cn(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Tn(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Rn(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const Hn={};class Xn{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const Yn=p.mat4(),qn=p.mat4();function $n(e,t,i){const s=e.length,r=new Uint16Array(s),o=t[0],n=t[1],a=t[2],l=t[3]-o,h=t[4]-n,c=t[5]-a,u=65525,d=u/l,f=u/h,m=u/c,g=e=>e>=0?e:0;for(let t=0;t<s;t+=3)r[t+0]=Math.floor(g(e[t+0]-o)*d),r[t+1]=Math.floor(g(e[t+1]-n)*f),r[t+2]=Math.floor(g(e[t+2]-a)*m);return p.identityMat4(Yn),p.translationMat4v(t,Yn),p.identityMat4(qn),p.scalingMat4v([l/u,h/u,c/u],qn),p.mulMat4(Yn,qn,i),r}function Zn(e,t,i){let s=e[0]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])),r=e[1]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]));if(e[2]<0){let e=s,t=r;e=(1-Math.abs(r))*(s>=0?1:-1),t=(1-Math.abs(s))*(r>=0?1:-1),s=e,r=t}return new Int8Array([Math[t](127.5*s+(s<0?-1:0)),Math[i](127.5*r+(r<0?-1:0))])}function Kn(e,t,i,s){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),o=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=(1-Math.abs(o))*(r>=0?1:-1),t=(1-Math.abs(r))*(o>=0?1:-1);r=e,o=t}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function Qn(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function Jn(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}const ea=p.mat4(),ta=p.mat4(),ia=p.vec4([0,0,0,1]),sa=p.vec4([0,0,0,1]),ra=p.vec4([0,0,0,1]),oa=p.OBB3(),na=p.vec3(),aa=p.vec3(),la=p.vec3(),ha=p.vec3(),ca=p.vec3(),ua=p.vec3(),da=p.vec3();class pa{constructor(e){this.model=e.model,this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals")+(e.textureSet&&e.textureSet.colorTexture?"-colorTexture":"")+(e.textureSet&&e.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=e.layerIndex,this._batchingRenderers=function(e){const t=e.id;let i=Hn[t];return i||(i=new Wn(e),Hn[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Hn[t],i._destroy()}))),i}(e.model.scene),this._buffer=new Xn(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Ke({origin:p.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:p.mat4(),uvDecodeMatrix:null,textureSet:e.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=p.collapseAABB3(),this._portions=[],this._numVerts=0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.uvDecodeMatrix?(this._state.uvDecodeMatrix=p.mat3(e.uvDecodeMatrix),this._preCompressedNormalsExpected=!0):this._preCompressedNormalsExpected=!1,e.origin&&this._state.origin.set(e.origin),this.aabb=p.collapseAABB3(),this.solid=!!e.solid}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e){if(this._finalized)throw"Already finalized";const t=e.positions,i=e.positionsCompressed,s=e.normals,r=e.normalsCompressed,o=e.uv,n=e.uvCompressed,a=e.colors,l=e.colorsCompressed,h=e.indices,c=e.edgeIndices,u=e.color,d=e.metallic,f=e.roughness,m=e.opacity,g=e.meshMatrix,_=e.worldMatrix,v=e.worldAABB,b=e.pickColor,x=this.model.scene,y=this._buffer,P=y.positions.length/3;let w;if(this._preCompressedPositionsExpected){if(!i)throw"positionsCompressed expected";w=i.length/3;for(let e=0,t=i.length;e<t;e++)y.positions.push(i[e]);const e=rt.getPositionsBounds(i),t=rt.decompressPosition(e.min,this._state.positionsDecodeMatrix,[]),s=rt.decompressPosition(e.max,this._state.positionsDecodeMatrix,[]);v[0]=t[0],v[1]=t[1],v[2]=t[2],v[3]=s[0],v[4]=s[1],v[5]=s[2],_&&(p.AABB3ToOBB3(v,oa),p.transformOBB3(_,oa),p.OBB3ToAABB3(oa,v))}else{if(!t)throw"positions expected";w=t.length/3;const e=t.length,i=y.positions.length;for(let e=0,i=t.length;e<i;e++)y.positions.push(t[e]);if(g)for(let t=i,s=i+e;t<s;t+=3)ia[0]=y.positions[t+0],ia[1]=y.positions[t+1],ia[2]=y.positions[t+2],p.transformPoint4(g,ia,sa),y.positions[t+0]=sa[0],y.positions[t+1]=sa[1],y.positions[t+2]=sa[2],p.expandAABB3Point3(this._modelAABB,sa),_?(p.transformPoint4(_,sa,ra),p.expandAABB3Point3(v,ra)):p.expandAABB3Point3(v,sa);else for(let t=i,s=i+e;t<s;t+=3)ia[0]=y.positions[t+0],ia[1]=y.positions[t+1],ia[2]=y.positions[t+2],p.expandAABB3Point3(this._modelAABB,ia),_?(p.transformPoint4(_,ia,sa),p.expandAABB3Point3(v,sa)):p.expandAABB3Point3(v,ia)}if(this._state.origin){const e=this._state.origin;v[0]+=e[0],v[1]+=e[1],v[2]+=e[2],v[3]+=e[0],v[4]+=e[1],v[5]+=e[2]}if(p.expandAABB3(this.aabb,v),r&&r.length>0)for(let e=0,t=r.length;e<t;e++)y.normals.push(r[e]);else if(s&&s.length>0){const e=ea;g?p.inverseMat4(p.transposeMat4(g,ta),e):p.identityMat4(e,e),function(e,t,i,s,r){function o(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}let n,a,l,h,c,u,d=new Float32Array([0,0,0,0]),f=new Float32Array([0,0,0,0]);for(u=0;u<i;u+=3)d[0]=t[u],d[1]=t[u+1],d[2]=t[u+2],p.transformVec3(e,d,f),p.normalizeVec3(f,f),l=n=Zn(f,"floor","floor"),a=Qn(n),h=c=o(f,a),n=Zn(f,"ceil","floor"),a=Qn(n),h=o(f,a),h>c&&(l=n,c=h),n=Zn(f,"floor","ceil"),a=Qn(n),h=o(f,a),h>c&&(l=n,c=h),n=Zn(f,"ceil","ceil"),a=Qn(n),h=o(f,a),h>c&&(l=n,c=h),s[r+u+0]=l[0],s[r+u+1]=l[1],s[r+u+2]=0}(e,s,s.length,y.normals,y.normals.length)}if(a)for(let e=0,t=a.length;e<t;e+=3)y.colors.push(255*a[e]),y.colors.push(255*a[e+1]),y.colors.push(255*a[e+2]),y.colors.push(255);else if(l)for(let e=0,t=a.length;e<t;e+=3)y.colors.push(a[e]),y.colors.push(a[e+1]),y.colors.push(a[e+2]),y.colors.push(255);else if(u){const e=u[0],t=u[1],i=u[2],s=m;for(let r=0;r<w;r++)y.colors.push(e),y.colors.push(t),y.colors.push(i),y.colors.push(s)}const M=null!=d?d:0,C=null!=f?f:255;for(let e=0;e<w;e++)y.metallicRoughness.push(M),y.metallicRoughness.push(C);if(o&&o.length>0)for(let e=0,t=o.length;e<t;e++)y.uv.push(o[e]);else if(n&&n.length>0)for(let e=0,t=n.length;e<t;e++)y.uv.push(n[e]);if(h)for(let e=0,t=h.length;e<t;e++)y.indices.push(P+h[e]);if(c)for(let e=0,t=c.length;e<t;e++)y.edgeIndices.push(P+c[e]);{const e=y.pickColors.length;for(let t=e,i=e+4*w;t<i;t+=4)y.pickColors.push(b[0]),y.pickColors.push(b[1]),y.pickColors.push(b[2]),y.pickColors.push(b[3])}if(x.entityOffsetsEnabled)for(let e=0;e<w;e++)y.offsets.push(0),y.offsets.push(0),y.offsets.push(0);const E=this._portions.length,A={vertsBaseIndex:P,numVerts:w};return x.pickSurfacePrecisionEnabled&&(h&&(A.indices=h),x.entityOffsetsEnabled&&(A.offset=new Float32Array(3))),this._portions.push(A),this._numPortions++,this.model.numPortions++,this._numVerts+=A.numVerts,E}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){const s=this._preCompressedPositionsExpected?new Uint16Array(i.positions):$n(i.positions,this._modelAABB,e.positionsDecodeMatrix);if(e.positionsBuf=new ne(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(let e=0,t=this._portions.length;e<t;e++){const t=this._portions[e],i=3*t.vertsBaseIndex,r=i+3*t.numVerts;t.quantizedPositions=s.slice(i,r)}}if(i.normals.length>0){const s=new Int8Array(i.normals);let r=!0;e.normalsBuf=new ne(t,t.ARRAY_BUFFER,s,i.normals.length,3,t.STATIC_DRAW,r)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;e.colorsBuf=new ne(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,r)}if(i.uv.length>0)if(e.uvDecodeMatrix){let s=!1;e.uvBuf=new ne(t,t.ARRAY_BUFFER,i.uv,i.uv.length,2,t.STATIC_DRAW,s)}else{const s=rt.getUVBounds(i.uv),r=rt.compressUVs(i.uv,s.min,s.max),o=r.quantized;let n=!1;e.uvDecodeMatrix=p.mat3(r.decodeMatrix),e.uvBuf=new ne(t,t.ARRAY_BUFFER,o,o.length,2,t.STATIC_DRAW,n)}if(i.metallicRoughness.length>0){const s=new Uint8Array(i.metallicRoughness);let r=!1;e.metallicRoughnessBuf=new ne(t,t.ARRAY_BUFFER,s,i.metallicRoughness.length,2,t.STATIC_DRAW,r)}if(i.positions.length>0){const s=i.positions.length/3*4,r=new Uint8Array(s),o=new Uint8Array(s);let n=!1,a=!0;e.flagsBuf=new ne(t,t.ARRAY_BUFFER,r,r.length,4,t.DYNAMIC_DRAW,n),e.flags2Buf=new ne(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,a)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;e.pickColorsBuf=new ne(t,t.ARRAY_BUFFER,s,i.pickColors.length,4,t.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new ne(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new ne(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}if(i.edgeIndices.length>0){const s=new Uint32Array(i.edgeIndices);e.edgeIndicesBuf=new ne(t,t.ELEMENT_ARRAY_BUFFER,s,i.edgeIndices.length,1,t.STATIC_DRAW)}this._state.pbrSupported=!!(e.metallicRoughnessBuf&&e.uvBuf&&e.normalsBuf&&e.textureSet&&e.textureSet.colorTexture&&e.textureSet.metallicRoughnessTexture),this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0}isEmpty(){return!this._state.indicesBuf}initFlags(e,t,i){t&S&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&R&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&O&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&L&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&F&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&I&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&S?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&R?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&O?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&L?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&I?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&F?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e,s=this._portions[i],r=4*s.vertsBaseIndex,o=4*s.numVerts,n=this._scratchMemory.getUInt8Array(o),a=t[0],l=t[1],h=t[2],c=t[3];for(let e=0;e<o;e+=4)n[e+0]=a,n[e+1]=l,n[e+2]=h,n[e+3]=c;this._state.colorsBuf&&this._state.colorsBuf.setData(n,r,o)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=e,o=this._portions[r],n=4*o.vertsBaseIndex,a=4*o.numVerts,l=!!(t&S),h=!!(t&R),c=!!(t&k),u=!!(t&O),d=!!(t&N),p=!!(t&F),f=!!(t&I);let m,g;m=!l||f||h||c&&!this.model.scene.highlightMaterial.glowThrough||u&&!this.model.scene.selectedMaterial.glowThrough?$o:i?Ko:Zo,g=!l||f?$o:u?Jo:c?Qo:h?en:$o;let _=0;_=!l||f?$o:u?on:c?rn:h?nn:d?i?sn:tn:$o;let v=l&&!f&&p?an:$o;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Uint8Array(4*this._numVerts));for(let e=n,t=n+a;e<t;e+=4)this._deferredFlagValues[e+0]=m,this._deferredFlagValues[e+1]=g,this._deferredFlagValues[e+2]=_,this._deferredFlagValues[e+3]=v}else if(this._state.flagsBuf){const e=this._scratchMemory.getUInt8Array(a);for(let t=0;t<a;t+=4)e[t+0]=m,e[t+1]=g,e[t+2]=_,e[t+3]=v;this._state.flagsBuf.setData(e,n,a)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}_setFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=e,r=this._portions[s],o=4*r.vertsBaseIndex,n=4*r.numVerts,a=t&L?255:0;if(i){this._setDeferredFlag2Values||(this._setDeferredFlag2Values=new Uint8Array(4*this._numVerts));for(let e=o,t=o+n;e<t;e+=4)this._setDeferredFlag2Values[e]=a}else if(this._state.flags2Buf){const e=this._scratchMemory.getUInt8Array(n);for(let t=0;t<n;t+=4)e[t+0]=a;this._state.flags2Buf.setData(e,o,n)}}_setDeferredFlags2(){this._setDeferredFlag2Values&&(this._state.flags2Buf.setData(this._setDeferredFlag2Values),this._setDeferredFlag2Values=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=e,s=this._portions[i],r=3*s.vertsBaseIndex,o=3*s.numVerts,n=this._scratchMemory.getFloat32Array(o),a=t[0],l=t[1],h=t[2];for(let e=0;e<o;e+=3)n[e+0]=a,n[e+1]=l,n[e+2]=h;this._state.offsetsBuf&&this._state.offsetsBuf.setData(n,r,o),this.model.scene.pickSurfacePrecisionEnabled&&(s.offset[0]=t[0],s.offset[1]=t[1],s.offset[2]=t[2])}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._batchingRenderers.pbrRendererWithSAO&&this._batchingRenderers.pbrRendererWithSAO.drawLayer(t,this,Zo):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._batchingRenderers.colorTextureRendererWithSAO&&this._batchingRenderers.colorTextureRendererWithSAO.drawLayer(t,this,Zo):this._state.normalsBuf?this._batchingRenderers.colorRendererWithSAO&&this._batchingRenderers.colorRendererWithSAO.drawLayer(t,this,Zo):this._batchingRenderers.flatColorRendererWithSAO&&this._batchingRenderers.flatColorRendererWithSAO.drawLayer(t,this,Zo):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._batchingRenderers.pbrRenderer&&this._batchingRenderers.pbrRenderer.drawLayer(t,this,Zo):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._batchingRenderers.colorTextureRenderer&&this._batchingRenderers.colorTextureRenderer.drawLayer(t,this,Zo):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,Zo):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(t,this,Zo))}_updateBackfaceCull(e,t){const i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){const e=t.gl;i?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._batchingRenderers.pbrRenderer&&this._batchingRenderers.pbrRenderer.drawLayer(t,this,Ko):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._batchingRenderers.colorTextureRenderer&&this._batchingRenderers.colorTextureRenderer.drawLayer(t,this,Ko):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,Ko):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(t,this,Ko))}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.depthRenderer&&this._batchingRenderers.depthRenderer.drawLayer(t,this,Zo))}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.normalsRenderer&&this._batchingRenderers.normalsRenderer.drawLayer(t,this,Zo))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,en))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,Qo))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,Jo))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(t,this,tn)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(t,this,sn)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,rn)}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,on)}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(t,this,nn)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.occlusionRenderer&&this._batchingRenderers.occlusionRenderer.drawLayer(t,this,Zo))}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.shadowRenderer&&this._batchingRenderers.shadowRenderer.drawLayer(t,this,Zo))}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickMeshRenderer&&this._batchingRenderers.pickMeshRenderer.drawLayer(t,this,an))}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickDepthRenderer&&this._batchingRenderers.pickDepthRenderer.drawLayer(t,this,an))}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._batchingRenderers.pickNormalsFlatRenderer&&this._batchingRenderers.pickNormalsFlatRenderer.drawLayer(t,this,an))}precisionRayPickSurface(e,t,i,s,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const o=this._state,n=this._portions[e];if(!n)return this.model.error("portion not found: "+e),!1;const a=n.quantizedPositions,l=n.indices,h=o.origin,c=n.offset,u=na,d=aa;u.set(h?p.subVec3(t,h,la):t),d.set(i),c&&p.subVec3(u,c),p.transformRay(this.model.worldNormalMatrix,u,d,u,d);const f=ha,m=ca,g=ua;let _=!1,v=0;const b=da;for(let e=0,i=l.length;e<i;e+=3){const i=3*l[e],n=3*l[e+1],x=3*l[e+2];if(f[0]=a[i],f[1]=a[i+1],f[2]=a[i+2],m[0]=a[n],m[1]=a[n+1],m[2]=a[n+2],g[0]=a[x],g[1]=a[x+1],g[2]=a[x+2],p.decompressPosition(f,o.positionsDecodeMatrix),p.decompressPosition(m,o.positionsDecodeMatrix),p.decompressPosition(g,o.positionsDecodeMatrix),p.rayTriangleIntersect(u,d,f,m,g,b)){p.transformPoint3(this.model.worldMatrix,b,b),c&&p.addVec3(b,c),h&&p.addVec3(b,h);const e=Math.abs(p.lenVec3(p.subVec3(b,t,[])));(!_||e>v)&&(v=e,s.set(b),r&&p.triangleNormal(f,m,g,r),_=!0)}}return _&&r&&(p.transformVec3(this.model.worldNormalMatrix,r,r),p.normalizeVec3(r)),_}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}const fa=p.vec4(),ma=p.vec3();class ga{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,ma);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(a.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(a.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(a.modelNormalMatrixCol2Buf),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aNormal.bindArrayBuffer(l.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),e.drawElements++,n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState.lights,r=t.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=s.length;e<t;e++){const t=s[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(this._withSAO){const s=t.sao;if(s.possible){const t=i.drawingBufferWidth,r=i.drawingBufferHeight;fa[0]=t,fa[1]=r,fa[2]=s.blendCutoff,fa[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,fa),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.sectionPlanes.length>0;let r,o,n;const a=[];for(a.push("#version 300 es"),a.push("// Instancing geometry drawing vertex shader"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec2 normal;"),a.push("in vec4 color;"),a.push("in vec4 flags;"),a.push("in vec4 flags2;"),e.entityOffsetsEnabled&&a.push("in vec3 offset;"),a.push("in vec4 modelMatrixCol0;"),a.push("in vec4 modelMatrixCol1;"),a.push("in vec4 modelMatrixCol2;"),a.push("in vec4 modelNormalMatrixCol0;"),a.push("in vec4 modelNormalMatrixCol1;"),a.push("in vec4 modelNormalMatrixCol2;"),a.push("uniform mat4 worldMatrix;"),a.push("uniform mat4 worldNormalMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 viewNormalMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("uniform vec4 lightAmbient;"),r=0,o=i.lights.length;r<o;r++)n=i.lights[r],"ambient"!==n.type&&(a.push("uniform vec4 lightColor"+r+";"),"dir"===n.type&&a.push("uniform vec3 lightDir"+r+";"),"point"===n.type&&a.push("uniform vec3 lightPos"+r+";"),"spot"===n.type&&(a.push("uniform vec3 lightPos"+r+";"),a.push("uniform vec3 lightDir"+r+";")));for(a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),s&&(a.push("out vec4 vWorldPosition;"),a.push("out vec4 vFlags2;")),a.push("out vec4 vColor;"),a.push("void main(void) {"),a.push("if (int(flags.x) != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),a.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&a.push("      worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),a.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),a.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),r=0,o=i.lights.length;r<o;r++)if(n=i.lights[r],"ambient"!==n.type){if("dir"===n.type)"view"===n.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");else if("point"===n.type)"view"===n.space?a.push("viewLightDir = -normalize(lightPos"+r+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+r+", 0.0)).xyz);");else{if("spot"!==n.type)continue;"view"===n.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+r+".rgb * lightColor"+r+".a);")}return a.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags2 = flags2;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor                = vec4(vColor.rgb * ambient, 1.0);")):s.push("    outColor           = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const _a=p.vec4(),va=p.vec3();class ba{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,va);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState.lights,r=t.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=s.length;e<t;e++){const t=s[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(this._withSAO){const s=t.sao;if(s.possible){const t=i.drawingBufferWidth,r=i.drawingBufferHeight;_a[0]=t,_a[1]=r,_a[2]=s.blendCutoff,_a[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,_a),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry flat-shading drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState;let s,r;const o=t.sectionPlanes.length>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry flat-shading drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}for(n.push("uniform mat4 viewMatrix;"),n.push("uniform vec4 lightAmbient;"),s=0,r=i.lights.length;s<r;s++){const e=i.lights[s];"ambient"!==e.type&&(n.push("uniform vec4 lightColor"+s+";"),"dir"===e.type&&n.push("uniform vec3 lightDir"+s+";"),"point"===e.type&&n.push("uniform vec3 lightPos"+s+";"),"spot"===e.type&&(n.push("uniform vec3 lightPos"+s+";"),n.push("uniform vec3 lightDir"+s+";")))}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),o){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }"),n.push("}")}for(n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),s=0,r=i.lights.length;s<r;s++){const e=i.lights[s];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?n.push("viewLightDir = normalize(lightDir"+s+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?n.push("viewLightDir = -normalize(lightPos"+s+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+s+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?n.push("viewLightDir = normalize(lightDir"+s+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+s+".rgb * lightColor"+s+".a);")}}return n.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):n.push("    outColor           = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const xa=p.vec3();class ya{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t.model.scene),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===en){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uSilhouetteColor,t[0],t[1],t[2],i)}else if(i===Qo){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uSilhouetteColor,t[0],t[1],t[2],i)}else if(i===Jo){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uSilhouetteColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uSilhouetteColor,p.vec3([1,1,1]));n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,xa);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aColor&&(this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0),this._aColor&&n.vertexAttribDivisor(this._aColor.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSilhouetteColor=s.getLocation("silhouetteColor"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aColor=s.getAttribute("color"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 color;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing fill fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Pa=p.vec3(),wa=new Float32Array([0,0,0,1]);class Ma{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===nn){const e=r.xrayMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===rn){const e=r.highlightMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===on){const e=r.selectedMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,wa);n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Pa);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aFlags&&(this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.edgeIndicesBuf.bind(),n.drawElementsInstanced(n.LINES,l.edgeIndicesBuf.numItems,l.edgeIndicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles instancing edges vertex shader"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ca=p.vec3();class Ea{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Ca);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.edgeIndicesBuf.bind(),n.drawElementsInstanced(n.LINES,l.edgeIndicesBuf.numItems,l.edgeIndicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0),this._aFlags&&n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Triangles instancing edges vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Aa=p.vec3();class Da{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i);const c=e.pickViewMatrix||o.viewMatrix,u=h?G(c,h):c;if(n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(a.pickColorsBuf),n.vertexAttribDivisor(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind();const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Aa);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aPickColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._uRenderPass=s.getLocation("renderPass"),this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 pickColor;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ta=p.vec3();class Sa{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.canvas.gl,n=t._state,a=n.geometry,l=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const h=r.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);const c=e.pickViewMatrix||h.viewMatrix,u=l?G(c,l):c;if(o.uniformMatrix4fv(this._uViewMatrix,!1,u),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),o.uniform1f(this._uPickZNear,e.pickZNear),o.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,n=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=n.sectionPlanesActivePerLayer[i+t];if(o.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Ta);o.uniform3fv(s.pos,e)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),o.vertexAttribDivisor(this._aModelMatrixCol0.location,1),o.vertexAttribDivisor(this._aModelMatrixCol1.location,1),o.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),o.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),o.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),o.vertexAttribDivisor(this._aOffset.location,1)),a.indicesBuf.bind(),o.drawElementsInstanced(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,n.numInstances),o.vertexAttribDivisor(this._aModelMatrixCol0.location,0),o.vertexAttribDivisor(this._aModelMatrixCol1.location,0),o.vertexAttribDivisor(this._aModelMatrixCol2.location,0),o.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&o.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ia=p.vec3();class Fa{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);const c=e.pickViewMatrix||o.viewMatrix,u=h?G(c,h):c;if(n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Ia);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(a.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(a.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(a.modelNormalMatrixCol2Buf),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aNormal.bindArrayBuffer(l.normalsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec2 normal;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("in vec4 modelNormalMatrixCol0;"),i.push("in vec4 modelNormalMatrixCol1;"),i.push("in vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),t&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const La=p.vec3();class Ba{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,La);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1)),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aColor&&n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("in float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ra=p.vec3();class ka{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Ra);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry depth drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Instancing geometry depth drawing fragment shader"),o.push("precision highp float;"),o.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("in vec2 vHighPrecisionZW;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),o.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Oa=p.vec3();class Na{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Oa);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aNormal.bindArrayBuffer(l.normalsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2&&(this._aFlags2=s.getAttribute("flags2")),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ja=p.vec3();class Va{constructor(e){this._scene=e,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){const i=t.model,s=i.scene,r=s.canvas.gl,o=t._state,n=o.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),r.vertexAttribDivisor(this._aModelMatrixCol0.location,1),r.vertexAttribDivisor(this._aModelMatrixCol1.location,1),r.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),r.vertexAttribDivisor(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),r.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),r.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),r.vertexAttribDivisor(this._aFlags2.location,1));const a=s._sectionPlanesState.sectionPlanes.length;if(a>0){const e=s._sectionPlanesState.sectionPlanes,o=t.layerIndex*a,n=i.renderFlags,l=t._state.origin;for(let t=0;t<a;t++){const i=this._uSectionPlanes[t];if(i){const s=n.sectionPlanesActivePerLayer[o+t];if(r.uniform1i(i.active,s?1:0),s){const s=e[t];if(l){const e=H(s.dist,s.dir,l,ja);r.uniform3fv(i.pos,e)}else r.uniform3fv(i.pos,s.pos);r.uniform3fv(i.dir,s.dir)}}}}n.indicesBuf.bind(),r.drawElementsInstanced(r.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,o.numInstances),r.vertexAttribDivisor(this._aModelMatrixCol0.location,0),r.vertexAttribDivisor(this._aModelMatrixCol1.location,0),r.vertexAttribDivisor(this._aModelMatrixCol2.location,0),r.vertexAttribDivisor(this._aColor.location,0),r.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&r.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&r.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2")}_bindProgram(e,t){const i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry shadow drawing vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const za=p.vec4(),Ua=p.vec3(),Ga={3e3:"linearToLinear",3001:"sRGBToLinear"};class Wa{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=Y.MAX_TEXTURE_IMAGE_UNITS,r=t.model,o=this._scene,n=o.camera,a=o.canvas.gl,l=t._state,h=l.origin,c=l.textureSet,u=l.geometry,d=o._lightsState;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(n.viewMatrix,h):n.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,n.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,r.worldNormalMatrix);const p=o._sectionPlanesState.sectionPlanes.length;if(p>0){const e=o._sectionPlanesState.sectionPlanes,i=t.layerIndex*p,s=r.renderFlags;for(let t=0;t<p;t++){const r=this._uSectionPlanes[t];if(r){const o=s.sectionPlanesActivePerLayer[i+t];if(a.uniform1i(r.active,o?1:0),o){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Ua);a.uniform3fv(r.pos,e)}else a.uniform3fv(r.pos,i.pos);a.uniform3fv(r.dir,i.dir)}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,u.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,u.uvDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(l.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(l.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(l.modelNormalMatrixCol2Buf),a.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(u.positionsBuf),this._aNormal.bindArrayBuffer(u.normalsBuf),this._aUV&&this._aUV.bindArrayBuffer(u.uvBuf),this._aColor.bindArrayBuffer(l.colorsBuf),a.vertexAttribDivisor(this._aColor.location,1),this._aMetallicRoughness.bindArrayBuffer(l.metallicRoughnessBuf),a.vertexAttribDivisor(this._aMetallicRoughness.location,1),this._aFlags.bindArrayBuffer(l.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(l.flags2Buf),a.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(l.offsetsBuf),a.vertexAttribDivisor(this._aOffset.location,1)),d.reflectionMaps.length>0&&d.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,d.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++),d.lightMaps.length>0&&d.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,d.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++),this._withSAO){const t=o.sao;if(t.possible){const i=a.drawingBufferWidth,r=a.drawingBufferHeight;za[0]=i,za[1]=r,za[2]=t.blendCutoff,za[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,za),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,e.bindTexture++}}c&&(this._program.bindTexture(this._uBaseColorMap,c.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uMetallicRoughMap,c.metallicRoughnessTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uEmissiveMap,c.emissiveTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s,this._program.bindTexture(this._uNormalMap,c.normalsTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s),u.indicesBuf.bind(),a.drawElementsInstanced(a.TRIANGLES,u.indicesBuf.numItems,u.indicesBuf.itemType,0,l.numInstances),e.drawElements++,a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,0),a.vertexAttribDivisor(this._aColor.location,0),a.vertexAttribDivisor(this._aMetallicRoughness.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(var n=0,a=r.length;n<a;n++)switch(o=r[n],o.type){case"dir":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=null,this._uLightDir[n]=s.getLocation("lightDir"+n);break;case"point":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=s.getLocation("lightPos"+n),this._uLightDir[n]=null,this._uLightAttenuation[n]=s.getLocation("lightAttenuation"+n);break;case"spot":this._uLightColor[n]=s.getLocation("lightColor"+n),this._uLightPos[n]=s.getLocation("lightPos"+n),this._uLightDir[n]=s.getLocation("lightDir"+n),this._uLightAttenuation[n]=s.getLocation("lightAttenuation"+n)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._aUV=s.getAttribute("uv"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._uBaseColorMap="uBaseColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState.lights,r=t.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=s.length;e<t;e++){const t=s[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.sectionPlanes.length>0,r=t.clippingCaps,o=[];return o.push("#version 300 es"),o.push("// Instancing geometry quality drawing vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec2 uv;"),o.push("in vec2 metallicRoughness;"),o.push("in vec4 flags;"),o.push("in vec4 flags2;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("in vec4 modelNormalMatrixCol0;"),o.push("in vec4 modelNormalMatrixCol1;"),o.push("in vec4 modelNormalMatrixCol2;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),o.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("out vec4 vViewPosition;"),o.push("out vec3 vViewNormal;"),o.push("out vec4 vColor;"),o.push("out vec2 vUV;"),o.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("out vec3 vWorldNormal;"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out vec4 vFlags2;"),r&&o.push("out vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),o.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Instancing geometry quality drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uBaseColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in vec4 vFlags2;"),o&&n.push("in vec4 vClipPosition;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}if(n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),n.push("uniform mat4 viewMatrix;"),n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),n.push("              return normalize(surf_norm );"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3    diffuseColor;"),n.push("   float   specularRoughness;"),n.push("   vec3    specularColor;"),n.push("   float   shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = "+Ga[s.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = "+Ga[s.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (float(vFlags2.x) > 0.0);"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 baseColorTexel = sRGBToLinear(texture(uBaseColorMap, vUV));"),n.push("baseColor *= baseColorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction = normalize(lightDir"+e+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction = normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction = normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction = normalize(lightDir"+e+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ha=p.vec3();class Xa{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.geometry,h=t._state.origin;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);const c=e.pickViewMatrix||o.viewMatrix,u=h?G(c,h):c;if(n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t],r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(h){const e=H(i.dist,i.dir,h,Ha);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(l.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),l.indicesBuf.bind(),n.drawElementsInstanced(n.TRIANGLES,l.indicesBuf.numItems,l.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&i.push("out vec4 vFlags2;"),i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push("  outColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ya=p.vec4(),qa=p.vec3();class $a{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=Y.MAX_TEXTURE_IMAGE_UNITS,r=t.model,o=r.scene,n=o.camera,a=o.canvas.gl,l=t._state,h=l.geometry,c=t._state.origin,u=l.textureSet;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,c?G(n.viewMatrix,c):n.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,r.worldMatrix);const d=o._sectionPlanesState.sectionPlanes.length;if(d>0){const e=o._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,s=r.renderFlags;for(let t=0;t<d;t++){const r=this._uSectionPlanes[t];if(r){const o=s.sectionPlanesActivePerLayer[i+t];if(a.uniform1i(r.active,o?1:0),o){const i=e[t];if(c){const e=H(i.dist,i.dir,c,qa);a.uniform3fv(r.pos,e)}else a.uniform3fv(r.pos,i.pos);a.uniform3fv(r.dir,i.dir)}}}}if(a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(l.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(l.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(l.modelMatrixCol2Buf),a.vertexAttribDivisor(this._aModelMatrixCol0.location,1),a.vertexAttribDivisor(this._aModelMatrixCol1.location,1),a.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aUV.bindArrayBuffer(h.uvBuf),this._aColor.bindArrayBuffer(l.colorsBuf),a.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(l.flagsBuf),a.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(l.flags2Buf),a.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(l.offsetsBuf),a.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),a.drawElementsInstanced(a.TRIANGLES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,l.numInstances),e.drawElements++,a.vertexAttribDivisor(this._aModelMatrixCol0.location,0),a.vertexAttribDivisor(this._aModelMatrixCol1.location,0),a.vertexAttribDivisor(this._aModelMatrixCol2.location,0),a.vertexAttribDivisor(this._aColor.location,0),a.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisor(this._aOffset.location,0),u&&u.colorTexture&&(this._program.bindTexture(this._uColorMap,u.colorTexture.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%s),this._withSAO){const t=o.sao;if(t.possible){const i=a.drawingBufferWidth,s=a.drawingBufferHeight;Ya[0]=i,Ya[1]=s,Ya[2]=t.blendCutoff,Ya[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,Ya),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,0)}}}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aUV=s.getAttribute("uv"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uColorMap="uColorMap",this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState.lights,r=t.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=s.length;e<t;e++){const t=s[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec2 uv;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("out vec2 vUV;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState;let r,o;const n=i.sectionPlanes.length>0,a=[];if(a.push("#version 300 es"),a.push("// Instancing geometry drawing fragment shader"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&(a.push("in float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("in float vFragDepth;")),a.push("uniform sampler2D uColorMap;"),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),t&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),n){a.push("in vec4 vWorldPosition;"),a.push("in vec4 vFlags2;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)a.push("uniform bool sectionPlaneActive"+e+";"),a.push("uniform vec3 sectionPlanePos"+e+";"),a.push("uniform vec3 sectionPlaneDir"+e+";")}for(a.push("uniform mat4 viewMatrix;"),a.push("uniform vec4 lightAmbient;"),r=0,o=s.lights.length;r<o;r++){const e=s.lights[r];"ambient"!==e.type&&(a.push("uniform vec4 lightColor"+r+";"),"dir"===e.type&&a.push("uniform vec3 lightDir"+r+";"),"point"===e.type&&a.push("uniform vec3 lightPos"+r+";"),"spot"===e.type&&(a.push("uniform vec3 lightPos"+r+";"),a.push("uniform vec3 lightDir"+r+";")))}if(a.push("in vec4 vViewPosition;"),a.push("in vec4 vColor;"),a.push("in vec2 vUV;"),a.push("out vec4 outColor;"),a.push("void main(void) {"),n){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let e=0,t=i.sectionPlanes.length;e<t;e++)a.push("if (sectionPlaneActive"+e+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }"),a.push("}")}for(a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),a.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),a.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),a.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),r=0,o=s.lights.length;r<o;r++){const e=s.lights[r];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?a.push("viewLightDir = -normalize(lightPos"+r+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+r+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+r+".rgb * lightColor"+r+".a);")}}return a.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),t?a.push("vec4 colorTexel = color * sRGBToLinear(texture(uColorMap, vUV));"):a.push("vec4 colorTexel = color * texture(uColorMap, vUV);"),a.push("float opacity = color.a;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),a.push("   outColor                = vec4(vColor.rgb * colorTexel.rgb * ambient, opacity);")):a.push("   outColor                = vec4(vColor.rgb * colorTexel.rgb, opacity);"),t&&a.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&a.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Za{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new ga(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new ga(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new ba(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new ba(this._scene,!0)),this._flatColorRendererWithSAO}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new Wa(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Wa(this._scene,!0)),this._pbrRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new $a(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new $a(this._scene,!0)),this._colorTextureRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ya(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new ka(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Na(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Ma(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Ea(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Da(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Fa(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Xa(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Sa(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Ba(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Va(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const Ka={};const Qa=new Uint8Array(4),Ja=p.vec4([0,0,0,1]),el=p.vec4([0,0,0,1]),tl=p.vec4([0,0,0,1]),il=new Float32Array(3),sl=p.vec3(),rl=p.vec3(),ol=p.vec3(),nl=p.vec3(),al=p.vec3(),ll=p.vec3(),hl=p.vec3();class cl{constructor(e){this.model=e.model,this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._instancingRenderers=function(e){const t=e.id;let i=Ka[t];return i||(i=new Za(e),Ka[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Ka[t],i._destroy()}))),i}(e.model.scene),this._aabb=p.collapseAABB3();const t={numInstances:0,obb:p.OBB3(),origin:p.vec3(),geometry:e.geometry,textureSet:e.textureSet,pbrSupported:!1};this._state=new Ke(t),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],e.origin&&this._state.origin.set(e.origin),this._finalized=!1,this.aabb=p.collapseAABB3(),this.solid=!!e.solid}createPortion(e){const t=e.color,i=e.metallic,s=e.roughness,r=e.opacity,o=e.meshMatrix,n=e.worldMatrix,a=e.aabb,l=e.pickColor;if(this._finalized)throw"Already finalized";const h=t[0],c=t[1],u=t[2];if(t[3],this._colors.push(h),this._colors.push(c),this._colors.push(u),this._colors.push(r),this._metallicRoughness.push(null!=i?i:0),this._metallicRoughness.push(null!=s?s:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.geometry.normalsBuf){let e=p.transposeMat4(o,p.mat4()),t=p.inverseMat4(e);this._modelNormalMatrixCol0.push(t[0]),this._modelNormalMatrixCol0.push(t[4]),this._modelNormalMatrixCol0.push(t[8]),this._modelNormalMatrixCol0.push(t[12]),this._modelNormalMatrixCol1.push(t[1]),this._modelNormalMatrixCol1.push(t[5]),this._modelNormalMatrixCol1.push(t[9]),this._modelNormalMatrixCol1.push(t[13]),this._modelNormalMatrixCol2.push(t[2]),this._modelNormalMatrixCol2.push(t[6]),this._modelNormalMatrixCol2.push(t[10]),this._modelNormalMatrixCol2.push(t[14])}this._pickColors.push(l[0]),this._pickColors.push(l[1]),this._pickColors.push(l[2]),this._pickColors.push(l[3]),p.collapseAABB3(a);const d=this._state.geometry.obb,f=d.length;for(let e=0;e<f;e+=4)Ja[0]=d[e+0],Ja[1]=d[e+1],Ja[2]=d[e+2],p.transformPoint4(o,Ja,el),n?(p.transformPoint4(n,el,tl),p.expandAABB3Point3(a,tl)):p.expandAABB3Point3(a,el);if(this._state.origin){const e=this._state.origin;a[0]+=e[0],a[1]+=e[1],a[2]+=e[2],a[3]+=e[0],a[4]+=e[1],a[5]+=e[2]}p.expandAABB3(this.aabb,a),this._state.numInstances++;const m=this._portions.length,g={};return this.model.scene.pickSurfacePrecisionEnabled&&(g.matrix=o.slice(),g.inverseMatrix=null,g.normalMatrix=null),this._portions.push(g),this._numPortions++,this.model.numPortions++,m}finalize(){if(this._finalized)throw"Already finalized";const e=this._state,t=e.geometry,i=e.textureSet,s=this.model.scene.canvas.gl,r=this._colors.length,o=r;if(r>0){let e=!1;this._state.colorsBuf=new ne(s,s.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,s.DYNAMIC_DRAW,e),this._colors=[]}if(this._metallicRoughness.length>0){const e=new Uint8Array(this._metallicRoughness);let t=!1;this._state.metallicRoughnessBuf=new ne(s,s.ARRAY_BUFFER,e,this._metallicRoughness.length,2,s.STATIC_DRAW,t)}if(o>0){let e=!1,t=!0;this._state.flagsBuf=new ne(s,s.ARRAY_BUFFER,new Uint8Array(o),o,4,s.DYNAMIC_DRAW,e),this._state.flags2Buf=new ne(s,s.ARRAY_BUFFER,new Uint8Array(o),o,4,s.DYNAMIC_DRAW,t)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,s.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,s.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,s.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,s.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.geometry.normalsBuf&&(this._state.modelNormalMatrixCol0Buf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,s.STATIC_DRAW,e),this._state.modelNormalMatrixCol1Buf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,s.STATIC_DRAW,e),this._state.modelNormalMatrixCol2Buf=new ne(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,s.STATIC_DRAW,e),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])}if(this._pickColors.length>0){const e=!1;this._state.pickColorsBuf=new ne(s,s.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,s.STATIC_DRAW,e),this._pickColors=[]}this._state.pbrSupported=!!(e.metallicRoughnessBuf&&t.uvBuf&&t.normalsBuf&&i&&i.colorTexture&&i.metallicRoughnessTexture),this._state.colorTextureSupported=!!t.uvBuf&&!!i&&!!i.colorTexture,this._finalized=!0}initFlags(e,t,i){t&S&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&R&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&O&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&L&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&F&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&I&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&S?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&R?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&O?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&L?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&F?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&I?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Qa[0]=t[0],Qa[1]=t[1],Qa[2]=t[2],Qa[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(Qa,4*e,4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&S),r=!!(t&R),o=!!(t&k),n=!!(t&O),a=!!(t&N),l=!!(t&F),h=!!(t&I);let c,u;c=!s||h||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?$o:i?Ko:Zo,u=!s||h?$o:n?Jo:o?Qo:r?en:$o;let d=0;d=!s||h?$o:n?on:o?rn:r?nn:a?i?sn:tn:$o;let p=s&&!h&&l?an:$o;Qa[0]=c,Qa[1]=u,Qa[2]=d,Qa[3]=p,this._state.flagsBuf&&this._state.flagsBuf.setData(Qa,4*e,4)}_setFlags2(e,t){if(!this._finalized)throw"Not finalized";const i=t&L?255:0;Qa[0]=i,this._state.flags2Buf&&this._state.flags2Buf.setData(Qa,4*e,4)}setOffset(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(il[0]=t[0],il[1]=t[1],il[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(il,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(e,t){if(this._numCulledLayerPortions===this._numPortions||0===this._numVisibleLayerPortions||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions)return;this._updateBackfaceCull(e,t);const i=this._state.geometry;t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._instancingRenderers.pbrRendererWithSAO&&this._instancingRenderers.pbrRendererWithSAO.drawLayer(t,this,Zo):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._instancingRenderers.colorTextureRendererWithSAO&&this._instancingRenderers.colorTextureRendererWithSAO.drawLayer(t,this,Zo):i.normalsBuf?this._instancingRenderers.colorRendererWithSAO&&this._instancingRenderers.colorRendererWithSAO.drawLayer(t,this,Zo):this._instancingRenderers.flatColorRendererWithSAO&&this._instancingRenderers.flatColorRendererWithSAO.drawLayer(t,this,Zo):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._instancingRenderers.pbrRenderer&&this._instancingRenderers.pbrRenderer.drawLayer(t,this,Zo):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._instancingRenderers.colorTextureRenderer&&this._instancingRenderers.colorTextureRenderer.drawLayer(t,this,Zo):i.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(t,this,Zo):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(t,this,Zo)}_updateBackfaceCull(e,t){const i=this.model.backfaces||!this.solid||e.sectioned;if(t.backfaces!==i){const e=t.gl;i?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),t.backfaces=i}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._instancingRenderers.pbrRenderer&&this._instancingRenderers.pbrRenderer.drawLayer(t,this,Ko):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._instancingRenderers.colorTextureRenderer&&this._instancingRenderers.colorTextureRenderer.drawLayer(t,this,Ko):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(t,this,Ko):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(t,this,Ko))}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.depthRenderer&&this._instancingRenderers.depthRenderer.drawLayer(t,this,Zo))}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.normalsRenderer&&this._instancingRenderers.normalsRenderer.drawLayer(t,this,Zo))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,en))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,Qo))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(t,this,Jo))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(t,this,tn)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(t,this,sn)}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,nn)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,rn)}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(t,this,on)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.occlusionRenderer&&this._instancingRenderers.occlusionRenderer.drawLayer(t,this,Zo))}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.shadowRenderer&&this._instancingRenderers.shadowRenderer.drawLayer(t,this,Zo))}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickMeshRenderer&&this._instancingRenderers.pickMeshRenderer.drawLayer(t,this,an))}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickDepthRenderer&&this._instancingRenderers.pickDepthRenderer.drawLayer(t,this,an))}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._instancingRenderers.pickNormalsRenderer&&this._instancingRenderers.pickNormalsRenderer.drawLayer(t,this,an))}precisionRayPickSurface(e,t,i,s,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const o=this._state.geometry,n=this._state,a=this._portions[e];if(!a)return this.model.error("portion not found: "+e),!1;a.inverseMatrix||(a.inverseMatrix=p.inverseMat4(a.matrix,p.mat4())),r&&!a.normalMatrix&&(a.normalMatrix=p.transposeMat4(a.inverseMatrix,p.mat4()));const l=o.quantizedPositions,h=o.indices,c=n.origin,u=a.offset,d=sl,f=rl;d.set(c?p.subVec3(t,c,ol):t),f.set(i),u&&p.subVec3(d,u),p.transformRay(this.model.worldNormalMatrix,d,f,d,f),p.transformRay(a.inverseMatrix,d,f,d,f);const m=nl,g=al,_=ll;let v=!1,b=0;const x=hl;for(let e=0,i=h.length;e<i;e+=3){const i=3*h[e+0],o=3*h[e+1],y=3*h[e+2];if(m[0]=l[i],m[1]=l[i+1],m[2]=l[i+2],g[0]=l[o],g[1]=l[o+1],g[2]=l[o+2],_[0]=l[y],_[1]=l[y+1],_[2]=l[y+2],p.decompressPosition(m,n.positionsDecodeMatrix),p.decompressPosition(g,n.positionsDecodeMatrix),p.decompressPosition(_,n.positionsDecodeMatrix),p.rayTriangleIntersect(d,f,m,g,_,x)){p.transformPoint3(a.matrix,x,x),p.transformPoint3(this.model.worldMatrix,x,x),u&&p.addVec3(x,u),c&&p.addVec3(x,c);const e=Math.abs(p.lenVec3(p.subVec3(x,t,[])));(!v||e>b)&&(b=e,s.set(x),r&&p.triangleNormal(m,g,_,r),v=!0)}}return v&&r&&(p.transformVec3(a.normalMatrix,r,r),p.transformVec3(this.model.worldNormalMatrix,r,r),p.normalizeVec3(r)),v}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}const ul=p.vec3();class dl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=t._state.origin;if(t.geometry,!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),n.lineWidth(s.linesMaterial.lineWidth);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*h,r=o.renderFlags;for(let t=0;t<h;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(l){const e=H(i.dist,i.dir,l,ul);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),a.indicesBuf.bind(),n.drawElements(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Lines batching color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const pl=new Float32Array([1,1,1]),fl=p.vec3();class ml{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin;if(t.geometry,!this._program&&(this._allocate(),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===en){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Qo){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Jo){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,pl);const h=l?G(o.viewMatrix,l):o.viewMatrix;n.uniformMatrix4fv(this._uViewMatrix,!1,h),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.lineWidth(r.linesMaterial.lineWidth);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,fl);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Lines batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class gl{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new dl(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ml(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}const _l={};class vl{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[]}}const bl=p.vec4([0,0,0,1]),xl=p.vec4([0,0,0,1]),yl=p.vec4([0,0,0,1]),Pl=p.OBB3();class wl{constructor(e){this.layerIndex=e.layerIndex,this._batchingRenderers=function(e){const t=e.id;let i=_l[t];return i||(i=new gl(e),_l[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete _l[t],i._destroy()}))),i}(e.model.scene),this.model=e.model,this._buffer=new vl(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Ke({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,positionsDecodeMatrix:p.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=p.collapseAABB3(),this._portions=[],this._numVerts=0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=p.vec3(e.origin)),this.aabb=p.collapseAABB3()}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e){if(this._finalized)throw"Already finalized";const t=e.positions,i=e.positionsCompressed,s=e.indices,r=e.color,o=e.opacity,n=e.meshMatrix,a=e.worldMatrix,l=e.worldAABB;e.pickColor;const h=this._buffer,c=h.positions.length/3;let u;if(this._preCompressedPositionsExpected){if(!i)throw"positionsCompressed expected";u=i.length/3;for(let e=0,t=i.length;e<t;e++)h.positions.push(i[e]);const e=rt.getPositionsBounds(i),t=rt.decompressPosition(e.min,this._state.positionsDecodeMatrix,[]),s=rt.decompressPosition(e.max,this._state.positionsDecodeMatrix,[]);l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=s[0],l[4]=s[1],l[5]=s[2],a&&(p.AABB3ToOBB3(l,Pl),p.transformOBB3(a,Pl),p.OBB3ToAABB3(Pl,l))}else{if(!t)throw"positions expected";u=t.length/3;const e=t.length,i=h.positions.length;for(let e=0,i=t.length;e<i;e++)h.positions.push(t[e]);if(n)for(let t=i,s=i+e;t<s;t+=3)bl[0]=h.positions[t+0],bl[1]=h.positions[t+1],bl[2]=h.positions[t+2],p.transformPoint4(n,bl,xl),h.positions[t+0]=xl[0],h.positions[t+1]=xl[1],h.positions[t+2]=xl[2],p.expandAABB3Point3(this._modelAABB,xl),a?(p.transformPoint4(a,xl,yl),p.expandAABB3Point3(l,yl)):p.expandAABB3Point3(l,xl);else for(let t=i,s=i+e;t<s;t+=3)bl[0]=h.positions[t+0],bl[1]=h.positions[t+1],bl[2]=h.positions[t+2],p.expandAABB3Point3(this._modelAABB,bl),a?(p.transformPoint4(a,bl,xl),p.expandAABB3Point3(l,xl)):p.expandAABB3Point3(l,bl)}if(this._state.origin){const e=this._state.origin;l[0]+=e[0],l[1]+=e[1],l[2]+=e[2],l[3]+=e[0],l[4]+=e[1],l[5]+=e[2]}if(p.expandAABB3(this.aabb,l),r){const e=r[0],t=r[1],i=r[2],s=o;for(let r=0;r<u;r++)h.colors.push(e),h.colors.push(t),h.colors.push(i),h.colors.push(s)}if(s)for(let e=0,t=s.length;e<t;e++)h.indices.push(s[e]+c);if(this.model.scene.entityOffsetsEnabled)for(let e=0;e<u;e++)h.offsets.push(0),h.offsets.push(0),h.offsets.push(0);const d=this._portions.length/2;return this._portions.push(c),this._portions.push(u),this._numPortions++,this.model.numPortions++,this._numVerts+=u,d}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){const s=new Uint16Array(i.positions);e.positionsBuf=new ne(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}else{const s=$n(new Float32Array(i.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new ne(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;e.colorsBuf=new ne(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,r)}if(i.colors.length>0){const s=i.colors.length,r=new Uint8Array(s),o=new Uint8Array(s);let n=!1,a=!0;e.flagsBuf=new ne(t,t.ARRAY_BUFFER,r,r.length,4,t.DYNAMIC_DRAW,n),e.flags2Buf=new ne(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,a)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new ne(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new ne(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&S&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&R&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&O&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&L&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&F&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&I&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&S?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&R?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&O?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&L?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&I?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&F?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),n=t[0],a=t[1],l=t[2],h=t[3];for(let e=0;e<r;e+=4)o[e+0]=n,o[e+1]=a,o[e+2]=l,o[e+3]=h;this._state.colorsBuf.setData(o,s,r)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=2*e,o=4*this._portions[r],n=4*this._portions[r+1];this._scratchMemory.getUInt8Array(n);const a=!!(t&S),l=!!(t&R),h=!!(t&k),c=!!(t&O),u=!!(t&F),d=!!(t&I);let p,f;p=!a||d||l||h&&!this.model.scene.highlightMaterial.glowThrough||c&&!this.model.scene.selectedMaterial.glowThrough?$o:i?Ko:Zo,f=!a||d?$o:c?Jo:h?Qo:l?en:$o;let m=a&&!d&&u?an:$o;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Uint8Array(4*this._numVerts));for(let e=o,t=o+n;e<t;e+=4)this._deferredFlagValues[e+0]=p,this._deferredFlagValues[e+1]=f,this._deferredFlagValues[e+2]=0,this._deferredFlagValues[e+3]=m}else if(this._state.flagsBuf){const e=this._scratchMemory.getUInt8Array(n);for(let t=0;t<n;t+=4)e[t+0]=p,e[t+1]=f,e[t+2]=0,e[t+3]=m;this._state.flagsBuf.setData(e,o,n)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}_setFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=2*e,r=4*this._portions[s],o=4*this._portions[s+1],n=t&L?255:0;if(i){this._setDeferredFlag2Values||(this._setDeferredFlag2Values=new Uint8Array(4*this._numVerts));for(let e=r,t=r+o;e<t;e+=4)this._setDeferredFlag2Values[e]=n}else{const e=this._scratchMemory.getUInt8Array(o);for(let t=0;t<o;t+=4)e[t+0]=n;this._state.flags2Buf.setData(e,r,o)}}_setDeferredFlags2(){this._setDeferredFlag2Values&&(this._state.flags2Buf.setData(this._setDeferredFlag2Values),this._setDeferredFlag2Values=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*e,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),n=t[0],a=t[1],l=t[2];for(let e=0;e<r;e+=3)o[e+0]=n,o[e+1]=a,o[e+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,Zo)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(t,this,Ko)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,en)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,Qo)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(t,this,Jo)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e){}drawPickDepths(e){}drawPickNormals(e){}drawOcclusion(e){}drawShadow(e){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicesBuf=null),e.destroy()}}const Ml=p.vec3();class Cl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.lineWidth(r.linesMaterial.lineWidth);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Ml);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),e.drawElements++,n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Lines instancing color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Lines instancing color fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):o.push("    outColor           = vColor;"),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const El=p.vec3();class Al{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=t.geometry;if(!this._program&&(this._allocate(t.model.scene),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===en){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Qo){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Jo){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,p.vec3([1,1,1]));n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.lineWidth(r.linesMaterial.lineWidth);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,o=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,El);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),h.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,h.indicesBuf.numItems,h.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Lines instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 color;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Lines instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Dl{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Cl(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Al(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}const Tl={};const Sl=new Uint8Array(4),Il=p.vec4([0,0,0,1]),Fl=p.vec4([0,0,0,1]),Ll=p.vec4([0,0,0,1]),Bl=new Float32Array(3);class Rl{constructor(e){this.model=e.model,this.geometry=e.geometry,this.material=e.material,this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._linesInstancingRenderers=function(e){const t=e.id;let i=Tl[t];return i||(i=new Dl(e),Tl[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Tl[t],i._destroy()}))),i}(e.model.scene),this._aabb=p.collapseAABB3(),this._state=new Ke({obb:p.OBB3(),numInstances:0,origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.origin&&(this._state.origin=p.vec3(e.origin)),this._finalized=!1,this.aabb=p.collapseAABB3()}createPortion(e){const t=e.color,i=e.opacity,s=e.meshMatrix,r=e.worldMatrix,o=e.aabb;if(this._finalized)throw"Already finalized";const n=t[0],a=t[1],l=t[2];t[3],this._colors.push(n),this._colors.push(a),this._colors.push(l),this._colors.push(i),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(s[0]),this._modelMatrixCol0.push(s[4]),this._modelMatrixCol0.push(s[8]),this._modelMatrixCol0.push(s[12]),this._modelMatrixCol1.push(s[1]),this._modelMatrixCol1.push(s[5]),this._modelMatrixCol1.push(s[9]),this._modelMatrixCol1.push(s[13]),this._modelMatrixCol2.push(s[2]),this._modelMatrixCol2.push(s[6]),this._modelMatrixCol2.push(s[10]),this._modelMatrixCol2.push(s[14]),p.collapseAABB3(o);const h=this._state.obb,c=h.length;for(let e=0;e<c;e+=4)Il[0]=h[e+0],Il[1]=h[e+1],Il[2]=h[e+2],p.transformPoint4(s,Il,Fl),r?(p.transformPoint4(r,Fl,Ll),p.expandAABB3Point3(o,Ll)):p.expandAABB3Point3(o,Fl);if(this._state.origin){const e=this._state.origin;o[0]+=e[0],o[1]+=e[1],o[2]+=e[2],o[3]+=e[0],o[4]+=e[1],o[5]+=e[2]}p.expandAABB3(this.aabb,o),this._state.numInstances++;const u=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,u}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._colors.length,i=t;if(t>0){let t=!1;this._state.colorsBuf=new ne(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,t),this._colors=[]}if(i>0){let t=!1,s=!0;this._state.flagsBuf=new ne(e,e.ARRAY_BUFFER,new Uint8Array(i),i,4,e.DYNAMIC_DRAW,t),this._state.flags2Buf=new ne(e,e.ARRAY_BUFFER,new Uint8Array(i),i,4,e.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;this._state.offsetsBuf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,t),this._offsets=[]}if(this._modelMatrixCol0.length>0){const t=!1;this._state.modelMatrixCol0Buf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol1Buf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol2Buf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this._finalized=!0}initFlags(e,t,i){t&S&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&R&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&O&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&L&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&F&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&I&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&S?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&R?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&O?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&L?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&F?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&I?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Sl[0]=t[0],Sl[1]=t[1],Sl[2]=t[2],Sl[3]=t[3],this._state.colorsBuf.setData(Sl,4*e,4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&S),r=!!(t&R),o=!!(t&k),n=!!(t&O),a=!!(t&N),l=!!(t&F),h=!!(t&I);let c,u;c=!s||h||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?$o:i?Ko:Zo,u=!s||h?$o:n?Jo:o?Qo:r?en:$o;let d=0;d=!s||h?$o:n?on:o?rn:r?nn:a?i?sn:tn:$o;let p=s&&!h&&l?an:$o;Sl[0]=c,Sl[1]=u,Sl[2]=d,Sl[3]=p,this._state.flagsBuf.setData(Sl,4*e,4)}_setFlags2(e,t){if(!this._finalized)throw"Not finalized";const i=t&L?255:0;Sl[0]=i,this._state.flags2Buf.setData(Sl,4*e,4)}setOffset(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(Bl[0]=t[0],Bl[1]=t[1],Bl[2]=t[2],this._state.offsetsBuf.setData(Bl,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(t,this,Zo)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(t,this,Ko)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,en)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,Qo)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(t,this,Jo)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesXRayed(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawOcclusion(e,t){}drawShadow(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawPickNormals(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy()}}const kl=p.vec3();class Ol{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=t._state.origin,h=s.pointsMaterial;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const c=s._sectionPlanesState.sectionPlanes.length;if(c>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,r=o.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const o=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,o?1:0),o){const i=e[t];if(l){const e=H(i.dist,i.dir,l,kl);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),h.filterIntensity&&n.uniform2f(this._uIntensityRange,h.minIntensity,h.maxIntensity),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),n.uniform1f(this._uPointSize,h.pointSize);const u="ortho"===s.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,u),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems),e.drawArrays++}_allocate(){const e=this._scene,t=e.pointsMaterial._state,i=e.canvas.gl;if(this._program=new oe(i,this._buildShader(e)),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial,s=[];return s.push("#version 300 es"),s.push("// Points batching color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),i.filterIntensity&&s.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),i.filterIntensity&&(s.push("float intensity = float(color.a) / 255.0;"),s.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {")),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),i.filterIntensity&&s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Nl=new Float32Array([1,1,1]),jl=p.vec3();class Vl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===en){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Qo){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Jo){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,Nl);const c=l?G(o.viewMatrix,l):o.viewMatrix;n.uniformMatrix4fv(this._uViewMatrix,!1,c),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,jl);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),n.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform vec4 color;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Points batching silhouette vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),e.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("outColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const zl=p.vec3();class Ul{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state;this._program||this._allocate(t),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=e.pickViewMatrix||o.viewMatrix,u=l?G(c,l):c;if(n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,u),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,zl);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(a.pickColorsBuf),n.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 pickColor;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Gl=p.vec3();class Wl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state;this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);const c=e.pickViewMatrix||o.viewMatrix,u=l?G(c,l):c;if(n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*d,o=s.renderFlags;for(let t=0;t<d;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Gl);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),n.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batched pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points batched pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Hl=p.vec3();class Xl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.canvas.gl,n=t._state,a=r.camera,l=t._state.origin,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?G(a.viewMatrix,l):a.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*c,n=s.renderFlags;for(let t=0;t<c;t++){const s=this._uSectionPlanes[t];if(s){const r=n.sectionPlanesActivePerLayer[i+t];if(o.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,Hl);o.uniform3fv(s.pos,e)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),o.uniform1f(this._uPointSize,h.pointSize);const u="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,u),o.drawArrays(o.POINTS,0,n.positionsBuf.numItems)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("  gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("// Points batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Yl{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Ol(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Vl(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Ul(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Wl(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Xl(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const ql={};class $l{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[]}}const Zl=p.vec4(),Kl=p.vec4(),Ql=p.vec4([0,0,0,1]),Jl=p.vec4([0,0,0,1]),eh=p.vec4([0,0,0,1]),th=p.OBB3();class ih{constructor(e){this.model=e.model,this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._pointsBatchingRenderers=function(e){const t=e.id;let i=ql[t];return i||(i=new Yl(e),ql[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete ql[t],i._destroy()}))),i}(e.model.scene),this._buffer=new $l(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Ke({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,positionsDecodeMatrix:p.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=p.collapseAABB3(),this._portions=[],this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=p.vec3(e.origin)),this.aabb=p.collapseAABB3()}canCreatePortion(e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts}createPortion(e){if(this._finalized)throw"Already finalized";const t=e.positions,i=e.positionsCompressed,s=e.color,r=e.colorsCompressed,o=e.colors,n=e.meshMatrix,a=e.worldMatrix,l=e.worldAABB,h=e.pickColor,c=this._buffer,u=c.positions.length/3;let d;if(this._preCompressedPositionsExpected){if(!i)throw"positionsCompressed expected";for(let e=0,t=i.length;e<t;e++)c.positions.push(i[e]);const e=rt.getPositionsBounds(i),t=rt.decompressPosition(e.min,this._state.positionsDecodeMatrix,Zl),s=rt.decompressPosition(e.max,this._state.positionsDecodeMatrix,Kl);l[0]=t[0],l[1]=t[1],l[2]=t[2],l[3]=s[0],l[4]=s[1],l[5]=s[2],a&&(p.AABB3ToOBB3(l,th),p.transformOBB3(a,th),p.OBB3ToAABB3(th,l)),d=i.length/3}else{if(!t)throw"positions expected";d=t.length/3;const e=t.length,i=c.positions.length;for(let e=0,i=t.length;e<i;e++)c.positions.push(t[e]);if(n)for(let t=i,s=i+e;t<s;t+=3)Ql[0]=c.positions[t+0],Ql[1]=c.positions[t+1],Ql[2]=c.positions[t+2],p.transformPoint4(n,Ql,Jl),c.positions[t+0]=Jl[0],c.positions[t+1]=Jl[1],c.positions[t+2]=Jl[2],p.expandAABB3Point3(this._modelAABB,Jl),a?(p.transformPoint4(a,Jl,eh),p.expandAABB3Point3(l,eh)):p.expandAABB3Point3(l,Jl);else for(let t=i,s=i+e;t<s;t+=3)Ql[0]=c.positions[t+0],Ql[1]=c.positions[t+1],Ql[2]=c.positions[t+2],p.expandAABB3Point3(this._modelAABB,Ql),a?(p.transformPoint4(a,Ql,Jl),p.expandAABB3Point3(l,Jl)):p.expandAABB3Point3(l,Ql)}if(this._state.origin){const e=this._state.origin;l[0]+=e[0],l[1]+=e[1],l[2]+=e[2],l[3]+=e[0],l[4]+=e[1],l[5]+=e[2]}if(p.expandAABB3(this.aabb,l),r)for(let e=0,t=r.length;e<t;e++)c.colors.push(r[e]);else if(o)for(let e=0,t=o.length;e<t;e++)c.colors.push(255*o[e]);else if(s){const e=s[0],t=s[1],i=s[2],r=1;for(let s=0;s<d;s++)c.colors.push(e),c.colors.push(t),c.colors.push(i),c.colors.push(r)}{const e=c.pickColors.length;for(let t=e,i=e+4*d;t<i;t+=4)c.pickColors.push(h[0]),c.pickColors.push(h[1]),c.pickColors.push(h[2]),c.pickColors.push(h[3])}if(this.model.scene.entityOffsetsEnabled)for(let e=0;e<d;e++)c.offsets.push(0),c.offsets.push(0),c.offsets.push(0);const f=this._portions.length/2;return this._portions.push(u),this._portions.push(d),this._numPortions++,this.model.numPortions++,f}finalize(){if(this._finalized)return void this.model.error("Already finalized");const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){const s=new Uint16Array(i.positions);e.positionsBuf=new ne(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}else{const s=$n(new Float32Array(i.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new ne(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;e.colorsBuf=new ne(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.STATIC_DRAW,r)}if(i.positions.length>0){const s=i.positions.length/3*4,r=new Uint8Array(s),o=new Uint8Array(s);let n=!1,a=!0;e.flagsBuf=new ne(t,t.ARRAY_BUFFER,r,r.length,4,t.DYNAMIC_DRAW,n),e.flags2Buf=new ne(t,t.ARRAY_BUFFER,o,o.length,4,t.DYNAMIC_DRAW,a)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;e.pickColorsBuf=new ne(t,t.ARRAY_BUFFER,s,i.pickColors.length,4,t.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new ne(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&S&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&R&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&O&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&L&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&F&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&I&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&S?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&R?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&O?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized"}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&L?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&I?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&F?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),n=t[0],a=t[1],l=t[2];for(let e=0;e<r;e+=4)o[e+0]=n,o[e+1]=a,o[e+2]=l;this._state.colorsBuf.setData(o,s,r)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=2*e,r=4*this._portions[s],o=4*this._portions[s+1],n=this._scratchMemory.getUInt8Array(o),a=!!(t&S),l=!!(t&R),h=!!(t&k),c=!!(t&O),u=!!(t&F),d=!!(t&I);let p,f;p=!a||d||l||h&&!this.model.scene.highlightMaterial.glowThrough||c&&!this.model.scene.selectedMaterial.glowThrough?$o:i?Ko:Zo,f=!a||d?$o:c?Jo:h?Qo:l?en:$o;let m=a&&!d&&u?an:$o;for(let e=0;e<o;e+=4)n[e+0]=p,n[e+1]=f,n[e+2]=0,n[e+3]=m;this._state.flagsBuf.setData(n,r,o)}_setFlags2(e,t){if(!this._finalized)throw"Not finalized";const i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),n=t&L?255:0;for(let e=0;e<r;e+=4)o[e+0]=n;this._state.flags2Buf.setData(o,s,r)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*e,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),n=t[0],a=t[1],l=t[2];for(let e=0;e<r;e+=3)o[e+0]=n,o[e+1]=a,o[e+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(t,this,Zo)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(t,this,Ko)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,en)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,Qo)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(t,this,Jo)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickMeshRenderer&&this._pointsBatchingRenderers.pickMeshRenderer.drawLayer(t,this,an)}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickDepthRenderer&&this._pointsBatchingRenderers.pickDepthRenderer.drawLayer(t,this,an)}drawPickNormals(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.occlusionRenderer&&this._pointsBatchingRenderers.occlusionRenderer.drawLayer(t,this,Zo)}drawShadow(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}const sh=p.vec3();class rh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state,c=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),this._aPosition.bindArrayBuffer(c.positionsBuf),this._aColor.bindArrayBuffer(c.colorsBuf),h.filterIntensity&&n.uniform2f(this._uIntensityRange,h.minIntensity,h.maxIntensity);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,sh);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),n.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArraysInstanced(n.POINTS,0,c.positionsBuf.numItems,a.numInstances),e.drawArrays++,n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.pointsMaterial._state,i=e.canvas.gl;if(this._program=new oe(i,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),i.filterIntensity&&s.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),i.filterIntensity&&(s.push("float intensity = float(color.a) / 255.0;"),s.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {")),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),i.filterIntensity&&s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const oh=p.vec3();class nh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state,c=t.geometry;if(!this._program&&(this._allocate(t.model.scene),this.errors))return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),i===en){const e=r.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Qo){const e=r.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Jo){const e=r.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,p.vec3([1,1,1]));n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,oh);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(c.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf,n.UNSIGNED_BYTE,!0),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),n.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArraysInstanced(n.POINTS,0,c.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("silhouetteColor"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 color;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 silhouetteColor;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("vColor = vec4(float(silhouetteColor.r) / 255.0, float(silhouetteColor.g) / 255.0, float(silhouetteColor.b) / 255.0, float(color.a) / 255.0);"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ah=p.vec3();class lh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state,c=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),n.uniform1i(this._uRenderPass,i);const u=e.pickViewMatrix||o.viewMatrix,d=l?G(u,l):u;if(n.uniformMatrix4fv(this._uViewMatrix,!1,d),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.project.far+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(a.pickColorsBuf),n.vertexAttribDivisor(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(c.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),n.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,p);const f=r._sectionPlanesState.sectionPlanes.length;if(f>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*f,o=s.renderFlags;for(let t=0;t<f;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,ah);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.drawArraysInstanced(n.POINTS,0,c.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aPickColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._uRenderPass=s.getLocation("renderPass"),this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing pick mesh vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 pickColor;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick mesh fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const hh=p.vec3();class ch{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.canvas.gl,n=t._state,a=t._state.origin,l=r.pointsMaterial._state,h=t.geometry;if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const c=r.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);const u=e.pickViewMatrix||c.viewMatrix,d=a?G(u,a):u;if(o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),o.uniform1f(this._uPickZNear,e.pickZNear),o.uniform1f(this._uPickZFar,e.pickZFar),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t)}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*p,n=s.renderFlags;for(let t=0;t<p;t++){const s=this._uSectionPlanes[t];if(s){const r=n.sectionPlanesActivePerLayer[i+t];if(o.uniform1i(s.active,r?1:0),r){const i=e[t];if(a){const e=H(i.dist,i.dir,a,hh);o.uniform3fv(s.pos,e)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),o.vertexAttribDivisor(this._aModelMatrixCol0.location,1),o.vertexAttribDivisor(this._aModelMatrixCol1.location,1),o.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(h.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),o.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),o.vertexAttribDivisor(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),o.vertexAttribDivisor(this._aOffset.location,1)),o.uniform1f(this._uPointSize,l.pointSize);const f="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,f),o.drawArraysInstanced(o.POINTS,0,h.positionsBuf.numItems,n.numInstances),o.vertexAttribDivisor(this._aModelMatrixCol0.location,0),o.vertexAttribDivisor(this._aModelMatrixCol1.location,0),o.vertexAttribDivisor(this._aModelMatrixCol2.location,0),o.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&o.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&o.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const uh=p.vec3();class dh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state,c=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,uh);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(c.colorsBuf),n.vertexAttribDivisor(this._aColor.location,1)),this._aPosition.bindArrayBuffer(c.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),n.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArraysInstanced(n.POINTS,0,c.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),this._aColor&&n.vertexAttribDivisor(this._aColor.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing occlusion vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ph=p.vec3();class fh{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,h=r.pointsMaterial._state,c=t.geometry;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),n.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*u,o=s.renderFlags;for(let t=0;t<u;t++){const s=this._uSectionPlanes[t];if(s){const r=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,r?1:0),r){const i=e[t];if(l){const e=H(i.dist,i.dir,l,ph);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}}}this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisor(this._aModelMatrixCol0.location,1),n.vertexAttribDivisor(this._aModelMatrixCol1.location,1),n.vertexAttribDivisor(this._aModelMatrixCol2.location,1),n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,c.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(c.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisor(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisor(this._aFlags2.location,1)),n.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:n.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));n.uniform1f(this._uNearPlaneHeight,d),n.drawArraysInstanced(n.POINTS,0,c.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisor(this._aModelMatrixCol0.location,0),n.vertexAttribDivisor(this._aModelMatrixCol1.location,0),n.vertexAttribDivisor(this._aModelMatrixCol2.location,0),n.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.sectionPlanes.length;t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 flags;"),s.push("in vec4 flags2;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.sectionPlanes.length>0,o=[];if(o.push("#version 300 es"),o.push("// Points instancing depth vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in vec4 vFlags2;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}"),o.push("out vec4 outColor;"),o.push("void main(void) {"),e.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const mh=p.vec3();class gh{constructor(e){this._scene=e,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t){const i=t.model,s=i.scene,r=s.canvas.gl,o=t._state;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,t)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,geometry.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),r.vertexAttribDivisor(this._aModelMatrixCol0.location,1),r.vertexAttribDivisor(this._aModelMatrixCol1.location,1),r.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),r.vertexAttribDivisor(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),r.vertexAttribDivisor(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),r.vertexAttribDivisor(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),r.vertexAttribDivisor(this._aFlags2.location,1));const n=s._sectionPlanesState.sectionPlanes.length;if(n>0){const e=s._sectionPlanesState.sectionPlanes,o=t.layerIndex*n,a=i.renderFlags,l=t._state.origin;for(let t=0;t<n;t++){const i=this._uSectionPlanes[t];if(i){const s=a.sectionPlanesActivePerLayer[o+t];if(r.uniform1i(i.active,s?1:0),s){const s=e[t];if(l){const e=H(s.dist,s.dir,l,mh);r.uniform3fv(i.pos,e)}else r.uniform3fv(i.pos,s.pos);r.uniform3fv(i.dir,s.dir)}}}}r.uniform1f(this._uPointSize,10),r.drawArraysInstanced(r.POINTS,0,o.positionsBuf.numItems,o.numInstances),r.vertexAttribDivisor(this._aModelMatrixCol0.location,0),r.vertexAttribDivisor(this._aModelMatrixCol1.location,0),r.vertexAttribDivisor(this._aModelMatrixCol2.location,0),r.vertexAttribDivisor(this._aColor.location,0),r.vertexAttribDivisor(this._aFlags.location,0),this._aFlags2&&r.vertexAttribDivisor(this._aFlags2.location,0),this._aOffset&&r.vertexAttribDivisor(this._aOffset.location,0)}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new oe(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize")}_bindProgram(e,t){const i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry shadow drawing vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in vec4 flags;"),i.push("in vec4 flags2;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in vec4 vFlags2;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.sectionPlanes.length;e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class _h{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new rh(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new nh(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new fh(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new lh(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new ch(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new dh(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new gh(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const vh={};const bh=new Uint8Array(4),xh=p.vec4([0,0,0,1]),yh=p.vec4([0,0,0,1]),Ph=p.vec4([0,0,0,1]),wh=new Float32Array(3);class Mh{constructor(e){this.model=e.model,this.geometry=e.geometry,this.material=e.material,this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._pointsInstancingRenderers=function(e){const t=e.id;let i=vh[t];return i||(i=new _h(e),vh[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete vh[t],i._destroy()}))),i}(e.model.scene),this._aabb=p.collapseAABB3(),this._state=new Ke({obb:p.OBB3(),numInstances:0,origin:e.origin?p.vec3(e.origin):null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._finalized=!1,this.aabb=p.collapseAABB3()}createPortion(e){const t=e.meshMatrix,i=e.worldMatrix,s=e.aabb,r=e.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(t[0]),this._modelMatrixCol0.push(t[4]),this._modelMatrixCol0.push(t[8]),this._modelMatrixCol0.push(t[12]),this._modelMatrixCol1.push(t[1]),this._modelMatrixCol1.push(t[5]),this._modelMatrixCol1.push(t[9]),this._modelMatrixCol1.push(t[13]),this._modelMatrixCol2.push(t[2]),this._modelMatrixCol2.push(t[6]),this._modelMatrixCol2.push(t[10]),this._modelMatrixCol2.push(t[14]),this._pickColors.push(r[0]),this._pickColors.push(r[1]),this._pickColors.push(r[2]),this._pickColors.push(r[3]),p.collapseAABB3(s);const o=this._state.obb,n=o.length;for(let e=0;e<n;e+=4)xh[0]=o[e+0],xh[1]=o[e+1],xh[2]=o[e+2],p.transformPoint4(t,xh,yh),i?(p.transformPoint4(i,yh,Ph),p.expandAABB3Point3(s,Ph)):p.expandAABB3Point3(s,yh);if(this._state.origin){const e=this._state.origin;s[0]+=e[0],s[1]+=e[1],s[2]+=e[2],s[3]+=e[0],s[4]+=e[1],s[5]+=e[2]}p.expandAABB3(this.aabb,s),this._state.numInstances++;const a=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,a}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._pickColors.length;if(t>0){let i=!1,s=!0;this._state.flagsBuf=new ne(e,e.ARRAY_BUFFER,new Uint8Array(t),t,4,e.DYNAMIC_DRAW,i),this._state.flags2Buf=new ne(e,e.ARRAY_BUFFER,new Uint8Array(t),t,4,e.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;this._state.offsetsBuf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,t),this._offsets=[]}if(this._modelMatrixCol0.length>0){const t=!1;this._state.modelMatrixCol0Buf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol1Buf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol2Buf=new ne(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){const t=!1;this._state.pickColorsBuf=new ne(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,t),this._pickColors=[]}this._finalized=!0}initFlags(e,t,i){t&S&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&k&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&R&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&O&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&L&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&N&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&F&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&I&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i),this._setFlags2(e,t)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&S?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&k?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&R?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&O?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&N?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&L?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&F?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&I?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";bh[0]=t[0],bh[1]=t[1],bh[2]=t[2],this._state.colorsBuf.setData(bh,3*e,3)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&S),r=!!(t&R),o=!!(t&k),n=!!(t&O),a=!!(t&N),l=!!(t&F),h=!!(t&I);let c,u;c=!s||h||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?$o:i?Ko:Zo,u=!s||h?$o:n?Jo:o?Qo:r?en:$o;let d=0;d=!s||h?$o:n?on:o?rn:r?nn:a?i?sn:tn:$o;let p=s&&!h&&l?an:$o;bh[0]=c,bh[1]=u,bh[2]=d,bh[3]=p,this._state.flagsBuf.setData(bh,4*e,4)}_setFlags2(e,t){if(!this._finalized)throw"Not finalized";const i=t&L?255:0;bh[0]=i,this._state.flags2Buf.setData(bh,4*e,4)}setOffset(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(wh[0]=t[0],wh[1]=t[1],wh[2]=t[2],this._state.offsetsBuf.setData(wh,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(t,this,Zo)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(t,this,Ko)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,en)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,Qo)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(t,this,Jo)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.occlusionRenderer&&this._pointsInstancingRenderers.occlusionRenderer.drawLayer(t,this,Zo)}drawShadow(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickMeshRenderer&&this._pointsInstancingRenderers.pickMeshRenderer.drawLayer(t,this,an)}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickDepthRenderer&&this._pointsInstancingRenderers.pickDepthRenderer.drawLayer(t,this,an)}drawPickNormals(e,t){}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.flags2Buf&&(e.flags2Buf.destroy(),e.flags2Buf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}class Ch{constructor(e){this.id=e.id,this.colorTexture=e.colorTexture,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.normalsTexture=e.normalsTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture}destroy(){}}class Eh{constructor(e,t,i){this.id=i.id,this.model=i.model,this.primitive=i.primitive,this.positions=null,this.positionsCompressed=null,this.quantizedPositions=null,this.positionsDecodeMatrix=p.mat4(),this.normals=null,this.normalsCompressed=null,this.colors=null,this.colorsCompressed=null,this.uv=null,this.uvCompressed=null,this.uvDecodeMatrix=null,this.indices=null,this.numIndices=0,this.obb=p.OBB3(),this.positionsBuf=null,this.normalsBuf=null,this.edgeIndicesBuf=null,this.uvBuf=null,this.colorsBuf=null;const s=t.scene.pickSurfacePrecisionEnabled,r=t.scene.canvas.gl;if(i.positionsCompressed&&i.positionsCompressed.length>0){const e=!1;this.positionsBuf=new ne(r,r.ARRAY_BUFFER,i.positionsCompressed,i.positionsCompressed.length,3,r.STATIC_DRAW,e),this.positionsDecodeMatrix.set(i.positionsDecodeMatrix);const t=p.collapseAABB3();p.expandAABB3Points3(t,i.positionsCompressed),rt.decompressAABB(t,this.positionsDecodeMatrix),p.AABB3ToOBB3(t,this.obb),s&&(this.quantizedPositions=i.positionsCompressed)}else if(i.positions&&i.positions.length>0){const e=i.positions.length,t=p.collapseAABB3();p.expandAABB3Points3(t,i.positions),p.AABB3ToOBB3(t,this.obb);const o=$n(i.positions,t,this.positionsDecodeMatrix);let n=!1;this.positionsBuf=new ne(r,r.ARRAY_BUFFER,o,e,3,r.STATIC_DRAW,n),s&&(this.quantizedPositions=o)}if(i.normalsCompressed&&i.normalsCompressed.length>0){const e=!0;this.normalsBuf=new ne(r,r.ARRAY_BUFFER,i.normalsCompressed,i.normalsCompressed.length,3,r.STATIC_DRAW,e)}else if(i.normals&&i.normals.length>0){const e=function(e){const t=e.length,i=new Int8Array(t);let s,r,o,n,a;for(let l=0;l<t;l+=3)o=s=Kn(e,l,"floor","floor"),r=Qn(s),n=a=Jn(e,l,r),s=Kn(e,l,"ceil","floor"),r=Qn(s),n=Jn(e,l,r),n>a&&(o=s,a=n),s=Kn(e,l,"floor","ceil"),r=Qn(s),n=Jn(e,l,r),n>a&&(o=s,a=n),s=Kn(e,l,"ceil","ceil"),r=Qn(s),n=Jn(e,l,r),n>a&&(o=s,a=n),i[l+0]=o[0],i[l+1]=o[1],i[l+2]=0;return i}(i.normals),t=!0;this.normalsBuf=new ne(r,r.ARRAY_BUFFER,e,e.length,3,r.STATIC_DRAW,t)}if(i.colorsCompressed&&i.colorsCompressed.length>0){const e=new Uint8Array(i.colorsCompressed),t=!1;this.colorsBuf=new ne(r,r.ARRAY_BUFFER,e,e.length,4,r.STATIC_DRAW,t)}else if(i.colors&&i.colors.length>0){const e=i.colors,t=new Uint8Array(e.length);for(let i=0,s=e.length;i<s;i++)t[i]=255*e[i];const s=!1;this.colorsBuf=new ne(r,r.ARRAY_BUFFER,t,t.length,4,r.STATIC_DRAW,s)}if(i.uvCompressed&&i.uvCompressed.length>0){const e=new Uint16Array(i.uvCompressed);this.uvDecodeMatrix=p.mat4(i.uvDecodeMatrix),this.uvBuf=new ne(r,r.ARRAY_BUFFER,i.uvCompressed,e.length,2,r.STATIC_DRAW,!1)}else if(i.uv&&i.uv.length>0){const e=rt.getUVBounds(i.uv),t=rt.compressUVs(i.uv,e.min,e.max),s=t.quantized;this.uvDecodeMatrix=t.decodeMatrix,this.uvBuf=new ne(r,r.ARRAY_BUFFER,s,s.length,2,r.STATIC_DRAW,!1)}if(i.indices&&i.indices.length>0&&(this.indicesBuf=new ne(r,r.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.indices),i.indices.length,1,r.STATIC_DRAW),s&&(this.indices=i.indices),this.numIndices=i.indices.length),"triangles"===i.primitive||"solid"===i.primitive||"surface"===i.primitive){let e=i.edgeIndices;e||(e=Me(i.positions,i.indices,null,i.edgeThreshold||10)),this.edgeIndicesBuf=new ne(r,r.ELEMENT_ARRAY_BUFFER,new Uint32Array(e),e.length,1,r.STATIC_DRAW)}}destroy(){}}class Ah{constructor(e){this.id=e.id,this.texture=e.texture}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}}const Dh={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};const Th=new class{constructor(e,t,i){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i}itemStart(e){this.itemsTotal++,!1===this.isLoading&&void 0!==this.onStart&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0}itemEnd(e){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())}itemError(e){void 0!==this.onError&&this.onError(e)}resolveURL(e){return this.urlModifier?this.urlModifier(e):e}setURLModifier(e){return this.urlModifier=e,this}addHandler(e,t){return this.handlers.push(e,t),this}removeHandler(e){const t=this.handlers.indexOf(e);return-1!==t&&this.handlers.splice(t,2),this}getHandler(e){for(let t=0,i=this.handlers.length;t<i;t+=2){const i=this.handlers[t],s=this.handlers[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return s}return null}};const Sh={};class Ih extends class{constructor(e){this.manager=void 0!==e?e:Th,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise((function(s,r){i.load(e,s,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}{constructor(e){super(e)}load(e,t,i,s){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=Dh.get(e);if(void 0!==r)return this.manager.itemStart(e),setTimeout((()=>{t&&t(r),this.manager.itemEnd(e)}),0),r;if(void 0!==Sh[e])return void Sh[e].push({onLoad:t,onProgress:i,onError:s});Sh[e]=[],Sh[e].push({onLoad:t,onProgress:i,onError:s});const o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),n=this.mimeType,a=this.responseType;fetch(o).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body.getReader)return t;const i=Sh[e],s=t.body.getReader(),r=t.headers.get("Content-Length"),o=r?parseInt(r):0,n=0!==o;let a=0;const l=new ReadableStream({start(e){!function t(){s.read().then((({done:s,value:r})=>{if(s)e.close();else{a+=r.byteLength;const s=new ProgressEvent("progress",{lengthComputable:n,loaded:a,total:o});for(let e=0,t=i.length;e<t;e++){const t=i[e];t.onProgress&&t.onProgress(s)}e.enqueue(r),t()}}))}()}});return new Response(l)}throw Error(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`)})).then((e=>{switch(a){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,n)));case"json":return e.json();default:if(void 0===n)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(n),i=t&&t[1]?t[1].toLowerCase():void 0,s=new TextDecoder(i);return e.arrayBuffer().then((e=>s.decode(e)))}}})).then((t=>{Dh.add(e,t);const i=Sh[e];delete Sh[e];for(let e=0,s=i.length;e<s;e++){const s=i[e];s.onLoad&&s.onLoad(t)}})).catch((t=>{const i=Sh[e];if(void 0===i)throw this.manager.itemError(e),t;delete Sh[e];for(let e=0,s=i.length;e<s;e++){const s=i[e];s.onError&&s.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Fh{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:t,msg:i,transfer:s}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(i,s)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((i=>{const s=this._getIdleWorker();-1!==s?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})}))}destroy(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}let Lh=0;class Bh{constructor({viewer:e,transcoderPath:t,workerLimit:i}){this._transcoderPath=t||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new Fh,this._workerSourceURL="",i&&this._workerPool.setWorkerLimit(i);const s=e.capabilities;this._workerConfig={astcSupported:s.astcSupported,etc1Supported:s.etc1Supported,etc2Supported:s.etc2Supported,dxtSupported:s.dxtSupported,bptcSupported:s.bptcSupported,pvrtcSupported:s.pvrtcSupported},this._supportedFileTypes=["xkt2"]}_init(){if(!this._transcoderPending){const e=new Ih;e.setPath(this._transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new Ih;i.setPath(this._transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const s=i.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([t,s]).then((([e,t])=>{const i=Bh.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(Bh.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(Bh.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(Bh.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this._workerSourceURL=URL.createObjectURL(new Blob([s])),this._transcoderBinary=t,this._workerPool.setWorkerCreator((()=>{const e=new Worker(this._workerSourceURL),t=this._transcoderBinary.slice(0);return e.postMessage({type:"init",config:this._workerConfig,transcoderBinary:t},[t]),e}))})),Lh>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),Lh++}return this._transcoderPending}transcode(e,t,i={}){return new Promise(((s,r)=>{const o=i;this._init().then((()=>this._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:o},e))).then((e=>{const i=e.data,{mipmaps:o,width:n,height:a,format:l,type:h,error:c,dfdTransferFn:u,dfdFlags:d}=i;if("error"===h)return r(c);t.setCompressedData({mipmaps:o,props:{format:l,minFilter:1===o.length?Bs:ks,magFilter:1===o.length?Bs:ks,encoding:2===u?Zs:$s,premultiplyAlpha:!!(1&d)}}),s()}))}))}destroy(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),Lh--}}Bh.BasisFormat={ETC1S:0,UASTC_4x4:1},Bh.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},Bh.EngineFormat={RGBAFormat:Ns,RGBA_ASTC_4x4_Format:Ys,RGBA_BPTC_Format:qs,RGBA_ETC2_EAC_Format:Xs,RGBA_PVRTC_4BPPV1_Format:Ws,RGBA_S3TC_DXT5_Format:Us,RGB_ETC1_Format:36196,RGB_ETC2_Format:Hs,RGB_PVRTC_4BPPV1_Format:Gs,RGB_S3TC_DXT1_Format:js},Bh.BasisWorker=function(){let e,t,i;const s=_EngineFormat,r=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",(function(n){const c=n.data;switch(c.type){case"init":e=c.config,u=c.transcoderBinary,t=new Promise((e=>{i={wasmBinary:u,onRuntimeInitialized:e},BASIS(i)})).then((()=>{i.initializeBasis(),void 0===i.KTX2File&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{width:t,height:n,hasAlpha:u,mipmaps:d,format:p,dfdTransferFn:f,dfdFlags:m}=function(t){const n=new i.KTX2File(new Uint8Array(t));function c(){n.close(),n.delete()}if(!n.isValid())throw c(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");const u=n.isUASTC()?o.UASTC_4x4:o.ETC1S,d=n.getWidth(),p=n.getHeight(),f=n.getLevels(),m=n.getHasAlpha(),g=n.getDFDTransferFunc(),_=n.getDFDFlags(),{transcoderFormat:v,engineFormat:b}=function(t,i,n,c){let u,d;const p=t===o.ETC1S?a:l;for(let s=0;s<p.length;s++){const r=p[s];if(e[r.if]&&(r.basisFormat.includes(t)&&!(c&&r.transcoderFormat.length<2)&&(!r.needsPowerOfTwo||h(i)&&h(n))))return u=r.transcoderFormat[c?1:0],d=r.engineFormat[c?1:0],{transcoderFormat:u,engineFormat:d}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),u=r.RGBA32,d=s.RGBAFormat,{transcoderFormat:u,engineFormat:d}}(u,d,p,m);if(!d||!p||!f)throw c(),new Error("KTX2TextureTranscoder: Invalid texture");if(!n.startTranscoding())throw c(),new Error("KTX2TextureTranscoder: .startTranscoding failed");const x=[];for(let e=0;e<f;e++){const t=n.getImageLevelInfo(e,0,0),i=t.origWidth,s=t.origHeight,r=new Uint8Array(n.getImageTranscodedSizeInBytes(e,0,0,v));if(!n.transcodeImage(r,e,0,0,v,0,-1,-1))throw c(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");x.push({data:r,width:i,height:s})}return c(),{width:d,height:p,hasAlpha:m,mipmaps:x,format:b,dfdTransferFn:g,dfdFlags:_}}(c.buffers[0]),g=[];for(let e=0;e<d.length;++e)g.push(d[e].data.buffer);self.postMessage({type:"transcode",id:c.id,width:t,height:n,hasAlpha:u,mipmaps:d,format:p,dfdTransferFn:f,dfdFlags:m},g)}catch(e){console.error(`[KTX2TextureTranscoder.BasisWorker]: ${e}`),self.postMessage({type:"error",id:c.id,error:e.message})}}))}var u}));const n=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[r.ASTC_4x4,r.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.BC7_M5,r.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.BC1,r.BC3],engineFormat:[s.RGB_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.ETC1,r.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.ETC1],engineFormat:[s.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.PVRTC1_4_RGB,r.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=n.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=n.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function h(e){return e<=2||0==(e&e-1)&&0!==e}};const Rh={};const kh=p.vec3(),Oh=p.mat4(),Nh=p.vec3([1,1,1]),jh=p.vec3([0,0,0]),Vh=p.vec3([0,0,0]),zh=p.identityQuaternion(),Uh="defaultColorTexture",Gh="defaultMetalRoughTexture",Wh="defaultNormalsTexture",Hh="defaultEmissiveTexture",Xh="defaultOcclusionTexture",Yh="defaultTextureSet";class qh extends T{constructor(e,t={}){super(e,t),this._textureTranscoder=t.textureTranscoder||function(e){const t=e.scene.id;let i=Rh[t];return i||(i=new Bh({viewer:e}),Rh[t]=i,e.scene.on("destroyed",(()=>{delete Rh[t],i.destroy()}))),i}(this.scene.viewer),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this._aabb=p.collapseAABB3(),this._aabbDirty=!1,this._layerList=[],this._nodeList=[],this._lastOrigin=null,this._lastPositionsDecodeMatrix=null,this._lastNormals=null,this._instancingLayers={},this._currentBatchingLayers={},this._scratchMemory=(qo++,Yo),this._geometries={},this._textures={},this._textureSets={},this._meshes={},this._nodes={},this.renderFlags=new Ti,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=t.edgeThreshold||10,this._origin=p.vec3(t.origin||[0,0,0]),this._position=p.vec3(t.position||[0,0,0]),this._rotation=p.vec3(t.rotation||[0,0,0]),this._quaternion=p.vec4(t.quaternion||[0,0,0,1]),t.rotation&&p.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=p.vec3(t.scale||[1,1,1]),this._worldMatrix=p.mat4(),p.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=p.mat4(),p.inverseMat4(this._worldMatrix,this._worldNormalMatrix),p.transposeMat4(this._worldNormalMatrix),(t.matrix||t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=p.mat4(),this._viewNormalMatrix=p.mat4(),this._viewMatrixDirty=!0,this._worldMatrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==t.saoEnabled,this._pbrEnabled=!1!==t.pbrEnabled,this._colorTextureEnabled=!1!==t.colorTextureEnabled,this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewMatrixDirty=!0})),this._createDefaultTextureSet(),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.backfaces=t.backfaces}_createDefaultTextureSet(){const e=new Ah({id:Uh,texture:new so({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),t=new Ah({id:Gh,texture:new so({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),i=new Ah({id:Wh,texture:new so({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),s=new Ah({id:Hh,texture:new so({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),r=new Ah({id:Xh,texture:new so({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures.defaultColorTexture=e,this._textures.defaultMetalRoughTexture=t,this._textures.defaultNormalsTexture=i,this._textures.defaultEmissiveTexture=s,this._textures.defaultOcclusionTexture=r,this._textureSets.defaultTextureSet=new Ch({id:Yh,model:this,colorTexture:e,metallicRoughnessTexture:t,normalsTexture:i,emissiveTexture:s,occlusionTexture:r})}get isPerformanceModel(){return!0}get objects(){return this._nodes}get origin(){return this._origin}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(p.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),p.inverseMat4(this._viewMatrix,this._viewNormalMatrix),p.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(p.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),p.inverseMat4(this._viewMatrix,this._viewNormalMatrix),p.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw()}get entityList(){return this._nodeList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){return this._aabbDirty&&this._rebuildAABB(),this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].visible=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].xrayed=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].highlighted=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].selected=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].edges=e;this.glRedraw()}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].culled=e;this.glRedraw()}get clippable(){return this._clippable}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].clippable=e;this.glRedraw()}get collidable(){return this._collidable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].collidable=e}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].pickable=e}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].colorize=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let t=0,i=this._nodeList.length;t<i;t++)this._nodeList[t].opacity=e}get castsShadow(){return this._castsShadow}set castsShadow(e){(e=!1!==e)!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get colorTextureEnabled(){return this._colorTextureEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createGeometry(e){const t=e.id;if(null==t)return void this.error("Config missing: id");if(this._geometries[t])return void this.error("Geometry already created: "+t);const i=e.primitive;if(null==i)return void this.error("Param expected: primitive");if("points"!==i&&"lines"!==i&&"triangles"!==i&&"solid"!==i&&"surface"!==i)return void this.error(`Unsupported value for 'primitive': '${i}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`);if(!e.positions&&!e.positionsCompressed)return this.error("Param expected: `positions` or `positionsCompressed'"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix)return this.error("Param expected: `positionsDecodeMatrix` (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!e.indices&&"points"!==i)return this.error(`Param expected: indices (required for '${i}' primitive type)`),null;const s=new Eh(t,this,e);this._geometries[t]=s,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++}createTexture(e){const t=e.id;if(null==t)return void this.error("Config missing: id");if(this._textures[t])return void this.error("Texture already created: "+t);if(!e.src&&!e.image&&!e.buffers)return this.error("Param expected: `src`, `image' or 'buffers'"),null;let i=e.minFilter||ks;i!==Bs&&i!==Rs&&i!==ks&&i!==Ls&&i!==Fs&&(this.error("[createTexture] Unsupported value for 'minFilter' - \n            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, \n            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter."),i=ks);let s=e.magFilter||Bs;s!==Bs&&s!==Is&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),s=Bs);let r=e.wrapS||Ds;r!==Ts&&r!==Ss&&r!==Ds&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),r=Ds);let o=e.wrapT||Ds;o!==Ts&&o!==Ss&&o!==Ds&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=Ds);let n=e.wrapR||Ds;n!==Ts&&n!==Ss&&n!==Ds&&(this.error("[createTexture] Unsupported value for 'wrapR' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),n=Ds);let a=e.encoding||$s;a!==$s&&a!==Zs&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),a=$s);const l=new so({gl:this.scene.canvas.gl,minFilter:i,magFilter:s,wrapS:r,wrapT:o,wrapR:n,encoding:a});if(e.preloadColor&&l.setPreloadColor(e.preloadColor),e.image){const t=e.image;t.crossOrigin="Anonymous",l.setImage(t,{minFilter:i,magFilter:s,wrapS:r,wrapT:o,wrapR:n,flipY:e.flipY,encoding:a})}else if(e.src){const t=e.src.split(".").pop();switch(t){case"jpeg":case"jpg":case"png":case"gif":const h=new Image;h.onload=()=>{l.setImage(h,{minFilter:i,magFilter:s,wrapS:r,wrapT:o,wrapR:n,flipY:e.flipY,encoding:a}),this.glRedraw()},h.src=e.src;break;default:this._textureTranscoder?v.loadArraybuffer(e.src,(e=>{e.byteLength?this._textureTranscoder.transcode([e],l).then((()=>{this.glRedraw()})):this.error("Can't create texture from 'src': file data is zero length")}),(function(e){this.error(`Can't create texture from 'src': ${e}`)})):this.error(`Can't create texture from 'src' - VBOSceneModel needs to be configured with a TextureTranscoder for this file type ('${t}')`)}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,l).then((()=>{this.glRedraw()})):this.error("Can't create texture from 'buffers' - VBOSceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[t]=new Ah({id:t,texture:l})}createTextureSet(e){const t=e.id;if(null==t)return void this.error("Config missing: id");if(this._textureSets[t])return void this.error(`Texture set already created: ${t}`);let i,s,r,o,n;if(void 0!==e.colorTextureId&&null!==e.colorTextureId){if(i=this._textures[e.colorTextureId],!i)return void this.error(`Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`)}else i=this._textures.defaultColorTexture;if(void 0!==e.metallicRoughnessTextureId&&null!==e.metallicRoughnessTextureId){if(s=this._textures[e.metallicRoughnessTextureId],!s)return void this.error(`Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`)}else s=this._textures.defaultMetalRoughTexture;if(void 0!==e.normalsTextureId&&null!==e.normalsTextureId){if(r=this._textures[e.normalsTextureId],!r)return void this.error(`Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`)}else r=this._textures.defaultNormalsTexture;if(void 0!==e.emissiveTextureId&&null!==e.emissiveTextureId){if(o=this._textures[e.emissiveTextureId],!o)return void this.error(`Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`)}else o=this._textures.defaultEmissiveTexture;if(void 0!==e.occlusionTextureId&&null!==e.occlusionTextureId){if(n=this._textures[e.occlusionTextureId],!n)return void this.error(`Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`)}else n=this._textures.defaultOcclusionTexture;const a=new Ch({id:t,model:this,colorTexture:i,metallicRoughnessTexture:s,normalsTexture:r,emissiveTexture:o,occlusionTexture:n});this._textureSets[t]=a}createMesh(e){let t=e.id;if(null==t)return void this.error("Config missing: id");if(this._meshes[t])return void this.error(`VBOSceneModel already has a mesh with this ID: ${t}`);const i=e.geometryId,s=void 0!==e.geometryId;if(s&&!this._geometries[e.geometryId])return void this.error(`Geometry not found: ${e.geometryId} - ensure that you create it first with createGeometry()`);const r=e.textureSetId||Yh;if(r&&!this._textureSets[r])return void this.error(`Texture set not found: ${r} - ensure that you create it first with createTextureSet()`);let o;const n=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],a=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,l=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,h=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,c=new Xo(this,t,n,a),u=c.pickId,d=new Uint8Array([255&u,u>>8&255,u>>16&255,u>>24&255]),f=p.collapseAABB3();let m;if(s){let t,s=this._worldMatrixNonIdentity?this._worldMatrix:null;if(e.matrix)t=e.matrix;else{const i=e.scale||Nh,s=e.position||jh,r=e.rotation||Vh;p.eulerToQuaternion(r,"XYZ",zh),t=p.composeMat4(s,zh,i,Oh)}const u=e.origin||e.rtcCenter,g=u?p.addVec3(this._origin,u,kh):this._origin,_=this._getInstancingLayer(g,r,i);m=_,o=_.createPortion({color:n,metallic:l,roughness:h,opacity:a,meshMatrix:t,worldMatrix:s,aabb:f,pickColor:d}),p.expandAABB3(this._aabb,f);const v=Math.round(_.numIndices/3);this._numTriangles+=v,c.numTriangles=v,c.origin=g}else{let t=e.primitive;if(null==t&&(t="triangles"),"points"!==t&&"lines"!==t&&"triangles"!==t&&"solid"!==t&&"surface"!==t)return void this.error(`Unsupported value for 'primitive': '${t}'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.`);if(!e.positions&&!e.positionsCompressed)return this.error("Param expected: 'positions' or 'positionsCompressed'  ('geometryId' is absent)"),null;if(e.positions&&e.positionsCompressed)return this.error("Only one param expected, not both: 'positions' or 'positionsCompressed' ('geometryId' is absent)"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix)return this.error("Param expected: 'positionsDecodeMatrix' (required for 'positionsCompressed'; 'geometryId' is absent)"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: `uvDecodeMatrix` (required for `uvCompressed'; 'geometryId' is absent)"),null;if(!e.indices&&"points"!==t)return this.error(`Param expected: indices (required for '${t}' primitive type)`),null;if(!e.indices&&"points"!==t)return this.error("Config expected: indices (no meshIds provided, so expecting geometry arrays instead)"),null;let i=e.indices,s=e.edgeIndices,u=e.origin||e.rtcCenter?p.addVec3(this._origin,e.origin||e.rtcCenter,kh):this._origin,g=e.positions;if(g){const e=p.vec3(),t=[];W(g,t,e)&&(g=t,u=p.addVec3(u,e,e))}let _=!1;if(this._lastOrigin?p.compareVec3(this._lastOrigin,u)||(_=!0,this._lastOrigin.set(u)):(_=!0,this._lastOrigin=p.vec3(u)),e.positionsDecodeMatrix&&(this._lastPositionsDecodeMatrix?p.compareMat4(this._lastPositionsDecodeMatrix,e.positionsDecodeMatrix)||(_=!0,this._lastPositionsDecodeMatrix.set(e.positionsDecodeMatrix)):(_=!0,this._lastPositionsDecodeMatrix=p.mat4(e.positionsDecodeMatrix))),e.uvDecodeMatrix&&(this._lastUVDecodeMatrix?p.compareMat4(this._lastUVDecodeMatrix,e.uvDecodeMatrix)||(_=!0,this._lastUVDecodeMatrix.set(e.uvDecodeMatrix)):(_=!0,this._lastUVDecodeMatrix=p.mat4(e.uvDecodeMatrix))),e.textureSetId&&this._lastTextureSetId!==e.textureSetId&&(_=!0,this._lastTextureSetId=e.textureSetId),_){for(let e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].finalize();this._currentBatchingLayers={}}const v=!!e.normals&&e.normals.length>0;if("triangles"===t||"solid"===t||"surface"===t){if(null!==this._lastNormals&&v!==this._lastNormals)for(let e in this._currentBatchingLayers)this._currentBatchingLayers[e]&&(this._currentBatchingLayers[e].finalize(),delete this._currentBatchingLayers[e]);this._lastNormals=v}const b=this._worldMatrixNonIdentity?this._worldMatrix:null;let x;if(!e.positionsDecodeMatrix)if(e.matrix)x=e.matrix;else{const t=e.scale||Nh,i=e.position||jh,s=e.rotation||Vh;p.eulerToQuaternion(s,"XYZ",zh),x=p.composeMat4(i,zh,t,Oh)}const y=r?this._textureSets[r]:null,P=`${t}-${e.normals&&e.normals.length>0?1:0}-${e.normalsCompressed&&e.normalsCompressed.length>0?1:0}-${e.colors&&e.colors.length>0?1:0}-${e.colorsCompressed&&e.colorsCompressed.length>0?1:0}-${e.uv&&e.uv.length>0?1:0}-${e.uvCompressed&&e.uvCompressed.length>0?1:0}`;m=this._currentBatchingLayers[P];const w=(g||e.positionsCompressed).length;switch(t){case"triangles":case"solid":case"surface":m&&(m.canCreatePortion(w,i.length)||(m.finalize(),delete this._currentBatchingLayers[P],m=null)),m||(m=new pa({model:this,textureSet:y,layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:u,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===t,autoNormals:!v}),this._layerList.push(m),this._currentBatchingLayers[P]=m),s||(s=Me(g||e.positionsCompressed,i,null,this._edgeThreshold)),o=m.createPortion({positions:g,positionsCompressed:e.positionsCompressed,normals:e.normals,normalsCompressed:e.normalsCompressed,colors:e.colors,colorsCompressed:e.colorsCompressed,uv:e.uv,uvCompressed:e.uvCompressed,indices:i,edgeIndices:s,color:n,opacity:a,metallic:l,roughness:h,meshMatrix:x,worldMatrix:b,worldAABB:f,pickColor:d});const r=Math.round(i.length/3);this._numTriangles+=r,c.numTriangles=r;break;case"lines":m&&(m.canCreatePortion(w,i.length)||(m.finalize(),delete this._currentBatchingLayers[P],m=null)),m||(m=new wl({model:this,layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:u,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(m),this._currentBatchingLayers[P]=m),o=m.createPortion({positions:g,positionsCompressed:e.positionsCompressed,indices:i,colors:e.colors,colorsCompressed:e.colorsCompressed,color:n,opacity:a,meshMatrix:x,worldMatrix:b,worldAABB:f,pickColor:d}),this._numLines+=Math.round(i.length/2);break;case"points":m&&(m.canCreatePortion(w)||(m.finalize(),delete this._currentBatchingLayers[P],m=null)),m||(m=new ih({model:this,layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,origin:u,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(m),this._currentBatchingLayers[P]=m),o=m.createPortion({positions:g,positionsCompressed:e.positionsCompressed,colors:e.colors,colorsCompressed:e.colorsCompressed,color:n,opacity:a,meshMatrix:x,worldMatrix:b,worldAABB:f,pickColor:d}),this._numPoints+=Math.round(w/3)}p.expandAABB3(this._aabb,f),this.numGeometries++,c.origin=u}c.parent=null,c._layer=m,c._portionId=o,c.aabb=f,this._meshes[t]=c}_getInstancingLayer(e,t,i){const s=`${e[0]}.${e[1]}.${e[2]}.${t}.${i}`;let r,o=this._instancingLayers[s];if(o)return o;if(void 0!==t&&(r=this._textureSets[t],!r))return void this.error(`TextureSet not found: ${t} - ensure that you create it first with createTextureSet()`);const n=this._geometries[i];if(this._geometries[i]){switch(n.primitive){case"triangles":case"surface":o=new cl({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0,solid:!1});break;case"solid":o=new cl({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0,solid:!0});break;case"lines":o=new Rl({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0});break;case"points":o=new Mh({model:this,textureSet:r,geometry:n,origin:e,layerIndex:0})}return this._instancingLayers[s]=o,this._layerList.push(o),o}this.error(`Geometry not found: ${i} - ensure that you create it first with createGeometry()`)}createEntity(e){let t=e.id;void 0===t?t=p.createUUID():this.scene.components[t]&&(this.error("Scene already has a Component with this ID: "+t+" - will assign random ID"),t=p.createUUID());const i=e.meshIds;if(void 0===i)return void this.error("Config missing: meshIds");let s=[];for(let e=0,t=i.length;e<t;e++){const t=i[e],r=this._meshes[t];r?r.parent?this.error("Mesh with ID "+t+" already belongs to object with ID "+r.parent.id+" - ignoring this mesh"):s.push(r):this.error("Mesh with this ID not found: "+t+" - ignoring this mesh")}let r,o=0;if(this._visible&&!1!==e.visible&&(o|=S),this._pickable&&!1!==e.pickable&&(o|=F),this._culled&&!1!==e.culled&&(o|=I),this._clippable&&!1!==e.clippable&&(o|=L),this._collidable&&!1!==e.collidable&&(o|=B),this._edges&&!1!==e.edges&&(o|=N),this._xrayed&&!1!==e.xrayed&&(o|=R),this._highlighted&&!1!==e.highlighted&&(o|=k),this._selected&&!1!==e.selected&&(o|=O),1===s.length)r=s[0].aabb;else{r=p.collapseAABB3();for(let e=0,t=s.length;e<t;e++)p.expandAABB3(r,s[e].aabb)}const n=new z(this,e.isObject,t,s,o,r);return this._nodeList.push(n),this._nodes[t]=n,this.numEntities++,n}finalize(){if(!this.destroyed){for(const e in this._instancingLayers)this._instancingLayers.hasOwnProperty(e)&&this._instancingLayers[e].finalize();for(let e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].finalize();this._currentBatchingLayers={};for(let e=0,t=this._nodeList.length;e<t;e++){this._nodeList[e]._finalize()}for(let e=0,t=this._nodeList.length;e<t;e++){this._nodeList[e]._finalize2()}this._layerList.sort(((e,t)=>e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0));for(let e=0,t=this._layerList.length;e<t;e++){this._layerList[e].layerIndex=e}this.glRedraw(),this.scene._aabbDirty=!0}}_rebuildAABB(){p.collapseAABB3(this._aabb);for(let e=0,t=this._nodeList.length;e<t;e++){const t=this._nodeList[e];p.expandAABB3(this._aabb,t.aabb)}this._aabbDirty=!1}stateSortCompare(e,t){}rebuildRenderFlags(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this._layerList.length,e.numVisibleLayers=0;for(let t=0,i=this._layerList.length;t<i;t++){const i=this._layerList[t];this._getActiveSectionPlanesForLayer(i)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}_getActiveSectionPlanesForLayer(e){const t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,r=e.layerIndex*s;if(s>0)for(let e=0;e<s;e++){i[e].active?(t.sectionPlanesActivePerLayer[r+e]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[r+e]=!1}return!0}_updateRenderFlags(){if(0===this.numVisibleLayerPortions)return;if(this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0))}if(this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}drawColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawColorOpaque(t,e)}}drawColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawColorTransparent(t,e)}}drawDepth(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawDepth(t,e)}}drawNormals(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawNormals(t,e)}}drawSilhouetteXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawSilhouetteXRayed(t,e)}}drawSilhouetteHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawSilhouetteHighlighted(t,e)}}drawSilhouetteSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawSilhouetteSelected(t,e)}}drawEdgesColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesColorOpaque(t,e)}}drawEdgesColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesColorTransparent(t,e)}}drawEdgesXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesXRayed(t,e)}}drawEdgesHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesHighlighted(t,e)}}drawEdgesSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawEdgesSelected(t,e)}}drawOcclusion(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawOcclusion(t,e)}}drawShadow(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawShadow(t,e)}}drawPickMesh(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawPickMesh(t,e)}}drawPickDepths(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawPickDepths(t,e)}}drawPickNormals(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this._layerList[s].drawPickNormals(t,e)}}destroy(){for(let e in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(e)&&this._currentBatchingLayers[e].destroy();this._currentBatchingLayers={},this.scene.camera.off(this._onCameraViewMatrix);for(let e=0,t=this._layerList.length;e<t;e++)this._layerList[e].destroy();for(let e=0,t=this._nodeList.length;e<t;e++)this._nodeList[e]._destroy();Object.entries(this._geometries).forEach((([e,t])=>{t.destroy()})),this._geometries={},this._textures={},this._textureSets={},this._meshes={},this._nodes={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==qo&&(qo--,0===qo&&Yo._clear()),super.destroy()}}const $h=p.vec4(),Zh=p.vec4(),Kh=p.vec3(),Qh=p.vec3(),Jh=p.vec3(),ec=p.vec4(),tc=p.vec4(),ic=p.vec4();class sc{constructor(e){this._scene=e}dollyToCanvasPos(e,t,i){let s=!1;const r=this._scene.camera;if(e){const t=p.subVec3(e,r.eye,Kh);s=p.lenVec3(t)<i}if("perspective"===r.projection){r.ortho.scale=r.ortho.scale-i;const s=this._unproject(t,ec),o=p.subVec3(s,r.eye,ic),n=p.mulVec3Scalar(p.normalizeVec3(o),-i,[]);if(r.eye=[r.eye[0]-n[0],r.eye[1]-n[1],r.eye[2]-n[2]],r.look=[r.look[0]-n[0],r.look[1]-n[1],r.look[2]-n[2]],e){const t=p.subVec3(e,r.eye,Kh),i=p.lenVec3(t),s=p.mulVec3Scalar(p.normalizeVec3(p.subVec3(r.look,r.eye,Qh)),i);r.look=[r.eye[0]+s[0],r.eye[1]+s[1],r.eye[2]+s[2]]}}else if("ortho"===r.projection){const e=this._unproject(t,ec);r.ortho.scale=r.ortho.scale-i,r.ortho._update();const s=this._unproject(t,tc),o=p.subVec3(s,e,ic),n=p.mulVec3Scalar(p.normalizeVec3(p.subVec3(r.look,r.eye,Kh)),-i,Qh),a=p.addVec3(o,n,Jh);r.eye=[r.eye[0]-a[0],r.eye[1]-a[1],r.eye[2]-a[2]],r.look=[r.look[0]-a[0],r.look[1]-a[1],r.look[2]-a[2]]}return s}_unproject(e,t){const i=this._scene.camera,s=i.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),n=[0,0,-1,1],a=p.dotVec4(n,r)/p.dotVec4(n,o);return i.project.unproject(e,a,$h,Zh,t),t}destroy(){}}const rc=p.vec3(),oc=p.vec3(),nc=p.vec3(),ac=p.vec4(),lc=p.vec4(),hc=p.vec4();class cc{constructor(e,t){this._scene=e,this._configs=t,this._pivotWorldPos=p.vec3(),this._cameraOffset=p.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotViewPos=p.vec4(),this._pivotProjPos=p.vec4(),this._pivotCanvasPos=p.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(()=>{this._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(()=>{this._cameraDirty=!0})),this._onTick=this._scene.on("tick",(()=>{this.updatePivotElement()}))}updatePivotElement(){const e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){p.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,p.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=t.boundary,s=i[2],r=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*r/2);let o=t._lastBoundingClientRect;if(!o||t._canvasSizeChanged){const e=t.canvas;o=t._lastBoundingClientRect=e.getBoundingClientRect()}this._pivotElement&&(this._pivotElement.style.left=Math.floor(o.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(o.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}setPivotElement(e){this._pivotElement=e}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const e=this._scene.camera;let t=p.lookAtMat4v(e.eye,e.look,e.worldUp);p.transformPoint3(t,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=p.distVec3(e.eye,i),t=p.inverseMat4(t);const s=p.transformVec3(t,this._cameraOffset),r=p.vec3();if(p.subVec3(e.eye,i,r),p.addVec3(r,s),e.zUp){const e=r[1];r[1]=r[2],r[2]=e}this._radius=p.lenVec3(r),this._polar=Math.acos(r[1]/this._radius),this._azimuth=Math.atan2(r[0],r[2]),this._pivoting=!0}_cameraLookingDownwards(){const e=this._scene.camera,t=p.normalizeVec3(p.subVec3(e.look,e.eye,rc)),i=p.cross3Vec3(t,e.worldUp,oc);return p.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}setCanvasPivotPos(e){const t=this._scene.camera,i=Math.abs(p.distVec3(this._scene.center,t.eye)),s=t.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),n=[0,0,-1,1],a=p.dotVec4(n,r)/p.dotVec4(n,o),l=ac;t.project.unproject(e,a,lc,hc,l);const h=p.normalizeVec3(p.subVec3(l,t.eye,rc)),c=p.addVec3(t.eye,p.mulVec3Scalar(h,i,oc),nc);this.setPivotPos(c)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(e,t){if(!this._pivoting)return;if(0===e&&0===t)return;const i=this._scene.camera;var s=-e;const r=-t;1===i.worldUp[2]&&(s=-s),this._azimuth+=.01*-s,this._polar+=.01*r,this._polar=p.clamp(this._polar,.001,Math.PI-.001);const o=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){const e=o[1];o[1]=o[2],o[2]=e}const n=p.lenVec3(p.subVec3(i.look,i.eye,p.vec3())),a=this.getPivotPos();p.addVec3(o,a);let l=p.lookAtMat4v(o,a,i.worldUp);l=p.inverseMat4(l);const h=p.transformVec3(l,this._cameraOffset);l[12]-=h[0],l[13]-=h[1],l[14]-=h[2];const c=[l[8],l[9],l[10]];i.eye=[l[12],l[13],l[14]],p.subVec3(i.eye,p.mulVec3Scalar(c,n),i.look),i.up=[l[4],l[5],l[6]],this.showPivot()}showPivot(){this._shown||(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible",this._shown=!0,this._hideTimeout=window.setTimeout((()=>{this.hidePivot()}),1e3)))}hidePivot(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class uc{constructor(e,t){this._scene=e.scene,this._cameraControl=e,this._scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault()},this._configs=t,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=p.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1}update(){if(!this._configs.pointerEnabled)return;if(!this.schedulePickEntity&&!this.schedulePickSurface)return;this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;const e=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const t=this.pickResult.canvasPos;if(t[0]===this.pickCursorPos[0]&&t[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=e,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){const e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){const e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1}}destroy(){}}const dc=p.vec2();class pc{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController;let n,a,l,h=0,c=0,u=0,d=0,f=!1;const m=p.vec3();let g=!0;const _=this._scene.canvas.canvas,v=[];function b(e=!0){_.style.cursor="move",h=s.pointerCanvasPos[0],c=s.pointerCanvasPos[1],u=s.pointerCanvasPos[0],d=s.pointerCanvasPos[1],e&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(f=!0,m.set(o.pickResult.worldPos)):f=!1)}document.addEventListener("keydown",this._documentKeyDownHandler=t=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;const s=t.keyCode;v[s]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=t=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;const s=t.keyCode;v[s]=!1}),_.addEventListener("mousedown",this._mouseDownHandler=t=>{if(i.active&&i.pointerEnabled)switch(t.which){case 1:v[e.input.KEY_SHIFT]||i.planView?(n=!0,b()):(n=!0,b(!1));break;case 2:a=!0,b();break;case 3:l=!0,i.panRightClick&&b()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{if(!i.active||!i.pointerEnabled)return;if(!n&&!a&&!l)return;const t=e.canvas.boundary,o=t[2],u=t[3],d=s.pointerCanvasPos[0],g=s.pointerCanvasPos[1];if(v[e.input.KEY_SHIFT]||i.planView||!i.panRightClick&&a||i.panRightClick&&l){const t=d-h,i=g-c,s=e.camera;if("perspective"===s.projection){const o=Math.abs(f?p.lenVec3(p.subVec3(m,e.camera.eye,[])):e.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=1.5*t*o/u,r.panDeltaY+=1.5*i*o/u}else r.panDeltaX+=.5*s.ortho.scale*(t/u),r.panDeltaY+=.5*s.ortho.scale*(i/u)}else!n||a||l||i.planView||(i.firstPerson?(r.rotateDeltaY-=(d-h)/o*i.dragRotationRate/2,r.rotateDeltaX+=(g-c)/u*(i.dragRotationRate/4)):(r.rotateDeltaY-=(d-h)/o*(1.5*i.dragRotationRate),r.rotateDeltaX+=(g-c)/u*(1.5*i.dragRotationRate)));h=d,c=g}),_.addEventListener("mousemove",this._canvasMouseMoveHandler=e=>{i.active&&i.pointerEnabled&&s.mouseover&&(g=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=e=>{if(i.active&&i.pointerEnabled)switch(e.which){case 1:case 2:case 3:n=!1,a=!1,l=!1}}),_.addEventListener("mouseup",this._mouseUpHandler=e=>{if(i.active&&i.pointerEnabled){if(3===e.which){!function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y}(e,dc);const i=dc[0],s=dc[1];Math.abs(i-u)<3&&Math.abs(s-d)<3&&t.cameraControl.fire("rightClick",{pagePos:[Math.round(e.pageX),Math.round(e.pageY)],canvasPos:dc,event:e},!0)}_.style.removeProperty("cursor")}}),_.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled});const x=1/60;let y=null;_.addEventListener("wheel",this._mouseWheelHandler=e=>{if(!i.active||!i.pointerEnabled)return;const t=performance.now()/1e3;var o=null!==y?t-y:0;y=t,o>.05&&(o=.05),o<x&&(o=x);const n=Math.max(-1,Math.min(1,40*-e.deltaY));if(0===n)return;const a=n/Math.abs(n);r.dollyDelta+=-a*o*i.mouseWheelDollyRate,g&&(s.followPointerDirty=!0,g=!1)},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}const fc=p.vec3(),mc=p.vec3(),gc=p.vec3(),_c=p.vec3(),vc=p.vec3(),bc={eye:p.vec3(),look:p.vec3(),up:p.vec3()};class xc{constructor(e,t,i,s){this._scene=e;const r=t.cameraControl,o=e.camera;this._onSceneKeyDown=e.input.on("keydown",(()=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;if(!s.mouseover)return;const n=r._isKeyDownForAction(r.AXIS_VIEW_RIGHT),a=r._isKeyDownForAction(r.AXIS_VIEW_BACK),l=r._isKeyDownForAction(r.AXIS_VIEW_LEFT),h=r._isKeyDownForAction(r.AXIS_VIEW_FRONT),c=r._isKeyDownForAction(r.AXIS_VIEW_TOP),u=r._isKeyDownForAction(r.AXIS_VIEW_BOTTOM);if(!(n||a||l||h||c||u))return;const d=e.aabb,f=p.getAABB3Diag(d);p.getAABB3Center(d,fc);const m=Math.abs(f/Math.tan(t.cameraFlight.fitFOV*p.DEGTORAD)),g=1.1*f;bc.orthoScale=g,n?(bc.eye.set(p.addVec3(fc,p.mulVec3Scalar(o.worldRight,m,mc),vc)),bc.look.set(fc),bc.up.set(o.worldUp)):a?(bc.eye.set(p.addVec3(fc,p.mulVec3Scalar(o.worldForward,m,mc),vc)),bc.look.set(fc),bc.up.set(o.worldUp)):l?(bc.eye.set(p.addVec3(fc,p.mulVec3Scalar(o.worldRight,-m,mc),vc)),bc.look.set(fc),bc.up.set(o.worldUp)):h?(bc.eye.set(p.addVec3(fc,p.mulVec3Scalar(o.worldForward,-m,mc),vc)),bc.look.set(fc),bc.up.set(o.worldUp)):c?(bc.eye.set(p.addVec3(fc,p.mulVec3Scalar(o.worldUp,m,mc),vc)),bc.look.set(fc),bc.up.set(p.normalizeVec3(p.mulVec3Scalar(o.worldForward,1,gc),_c))):u&&(bc.eye.set(p.addVec3(fc,p.mulVec3Scalar(o.worldUp,-m,mc),vc)),bc.look.set(fc),bc.up.set(p.normalizeVec3(p.mulVec3Scalar(o.worldForward,-1,gc)))),!i.firstPerson&&i.followPointer&&t.pivotController.setPivotPos(fc),t.cameraFlight.duration>0?t.cameraFlight.flyTo(bc,(()=>{t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot()})):(t.cameraFlight.jumpTo(bc),t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot())}))}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown)}}class yc{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.pivotController,a=t.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let l=!1,h=!1;const c=this._scene.canvas.canvas,u=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i&&i.entity?i.entity.aabb:e.aabb;if(s){const i=e.camera;p.subVec3(i.eye,i.look,[]),t.cameraFlight.flyTo({aabb:r})}else t.cameraFlight.flyTo({aabb:r})};c.addEventListener("mousemove",this._canvasMouseMoveHandler=t=>{if(!i.active||!i.pointerEnabled)return;if(l||h)return;const r=a.hasSubs("hover"),n=a.hasSubs("hoverOut"),c=a.hasSubs("hoverOff"),u=a.hasSubs("hoverSurface");if(r||n||c||u)if(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=u,o.update(),o.pickResult){const t=o.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&a.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),a.fire("hoverEnter",o.pickResult,!0),this._lastPickedEntityId=t),a.fire("hover",o.pickResult,!0),o.pickResult.worldPos&&a.fire("hoverSurface",o.pickResult,!0)}else void 0!==this._lastPickedEntityId&&(a.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),a.fire("hoverOff",{canvasPos:o.pickCursorPos},!0)}),c.addEventListener("mousedown",this._canvasMouseDownHandler=t=>{1===t.which&&(l=!0),3===t.which&&(h=!0);if(1===t.which&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=t.clientX,s.mouseDownClientY=t.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),1===t.which))){const t=o.pickResult;t&&t.worldPos?(n.setPivotPos(t.worldPos),n.startPivot()):(i.smartPivot?n.setCanvasPivotPos(s.pointerCanvasPos):n.setPivotPos(e.camera.look),n.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=e=>{1===e.which&&(l=!1),3===e.which&&(h=!1)}),c.addEventListener("mouseup",this._canvasMouseUpHandler=r=>{if(!i.active||!i.pointerEnabled)return;if(!(1===r.which))return;if(n.hidePivot(),Math.abs(r.clientX-s.mouseDownClientX)>3||Math.abs(r.clientY-s.mouseDownClientY)>3)return;const l=a.hasSubs("picked"),h=a.hasSubs("pickedNothing"),c=a.hasSubs("pickedSurface"),d=a.hasSubs("doublePicked"),f=a.hasSubs("doublePickedSurface"),m=a.hasSubs("doublePickedNothing");if(!(i.doublePickFlyTo||d||f||m))return(l||h||c)&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=c,o.update(),o.pickResult?(a.fire("picked",o.pickResult,!0),o.pickedSurface&&a.fire("pickedSurface",o.pickResult,!0)):a.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),void(this._clicks=0);if(this._clicks++,1===this._clicks){o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo,o.schedulePickSurface=c,o.update();const e=o.pickResult,r=o.pickedSurface;this._timeout=setTimeout((()=>{e?(a.fire("picked",e,!0),r&&(a.fire("pickedSurface",e,!0),!i.firstPerson&&i.followPointer&&(t.pivotController.setPivotPos(e.worldPos),t.pivotController.startPivot()&&t.pivotController.showPivot()))):a.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0}),i.doubleClickTimeFrame)}else{if(null!==this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo||d||f,o.schedulePickSurface=o.schedulePickEntity&&f,o.update(),o.pickResult){if(a.fire("doublePicked",o.pickResult,!0),o.pickedSurface&&a.fire("doublePickedSurface",o.pickResult,!0),i.doublePickFlyTo&&(u(o.pickResult),!i.firstPerson&&i.followPointer)){const e=o.pickResult.entity.aabb,i=p.getAABB3Center(e);t.pivotController.setPivotPos(i),t.pivotController.startPivot()&&t.pivotController.showPivot()}}else if(a.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(u(),!i.firstPerson&&i.followPointer)){const i=e.aabb,s=p.getAABB3Center(i);t.pivotController.setPivotPos(s),t.pivotController.startPivot()&&t.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class Pc{constructor(e,t,i,s,r){this._scene=e;const o=e.input,n=[],a=e.canvas.canvas;let l=!0;this._onSceneMouseMove=o.on("mousemove",(()=>{l=!0})),this._onSceneKeyDown=o.on("keydown",(t=>{i.active&&i.pointerEnabled&&e.input.keyboardEnabled&&s.mouseover&&(n[t]=!0,t===o.KEY_SHIFT&&(a.style.cursor="move"))})),this._onSceneKeyUp=o.on("keyup",(t=>{i.active&&i.pointerEnabled&&e.input.keyboardEnabled&&s.mouseover&&(n[t]=!1,t===o.KEY_SHIFT&&(a.style.cursor=null))})),this._onTick=e.on("tick",(a=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;if(!s.mouseover)return;const h=t.cameraControl,c=a.deltaTime/1e3;if(!i.planView){const e=h._isKeyDownForAction(h.ROTATE_Y_POS,n),s=h._isKeyDownForAction(h.ROTATE_Y_NEG,n),o=h._isKeyDownForAction(h.ROTATE_X_POS,n),a=h._isKeyDownForAction(h.ROTATE_X_NEG,n),l=c*i.keyboardRotationRate;(e||s||o||a)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),e?r.rotateDeltaY+=l:s&&(r.rotateDeltaY-=l),o?r.rotateDeltaX+=l:a&&(r.rotateDeltaX-=l),!i.firstPerson&&i.followPointer&&t.pivotController.startPivot())}if(!n[o.KEY_CTRL]&&!n[o.KEY_ALT]){const e=h._isKeyDownForAction(h.DOLLY_BACKWARDS,n),o=h._isKeyDownForAction(h.DOLLY_FORWARDS,n);if(e||o){const n=c*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),o?r.dollyDelta-=n:e&&(r.dollyDelta+=n),l&&(s.followPointerDirty=!0,l=!1)}}const u=h._isKeyDownForAction(h.PAN_FORWARDS,n),d=h._isKeyDownForAction(h.PAN_BACKWARDS,n),p=h._isKeyDownForAction(h.PAN_LEFT,n),f=h._isKeyDownForAction(h.PAN_RIGHT,n),m=h._isKeyDownForAction(h.PAN_UP,n),g=h._isKeyDownForAction(h.PAN_DOWN,n),_=(n[o.KEY_ALT]?.3:1)*c*i.keyboardPanRate;(u||d||p||f||m||g)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),g?r.panDeltaY+=_:m&&(r.panDeltaY+=-_),f?r.panDeltaX+=-_:p&&(r.panDeltaX+=_),d?r.panDeltaZ+=_:u&&(r.panDeltaZ+=-_))}))}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp)}}const wc=.001,Mc=p.vec3();class Cc{constructor(e,t,i,s,r){this._scene=e;const o=e.camera,n=t.pickController,a=t.pivotController,l=t.panController;let h=1,c=1,u=null;this._onTick=e.on("tick",(()=>{if(!i.active||!i.pointerEnabled)return;let t="default";if(Math.abs(r.dollyDelta)<wc&&(r.dollyDelta=0),Math.abs(r.rotateDeltaX)<wc&&(r.rotateDeltaX=0),Math.abs(r.rotateDeltaY)<wc&&(r.rotateDeltaY=0),0===r.rotateDeltaX&&0===r.rotateDeltaY||(r.dollyDelta=0),i.followPointer&&--h<=0&&(h=1,0!==r.dollyDelta)){if(0===r.rotateDeltaY&&0===r.rotateDeltaX&&i.followPointer&&s.followPointerDirty&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.pickResult&&n.pickResult.worldPos?u=n.pickResult.worldPos:(c=1,u=null),s.followPointerDirty=!1),u){const t=Math.abs(p.lenVec3(p.subVec3(u,e.camera.eye,Mc)));c=t/i.dollyProximityThreshold}c<i.dollyMinSpeed&&(c=i.dollyMinSpeed)}const d=r.dollyDelta*c;if(0===r.rotateDeltaY&&0===r.rotateDeltaX||(!i.firstPerson&&i.followPointer&&a.getPivoting()?(a.continuePivot(r.rotateDeltaY,r.rotateDeltaX),a.showPivot()):(0!==r.rotateDeltaX&&(i.firstPerson?o.pitch(-r.rotateDeltaX):o.orbitPitch(r.rotateDeltaX)),0!==r.rotateDeltaY&&(i.firstPerson?o.yaw(r.rotateDeltaY):o.orbitYaw(r.rotateDeltaY))),r.rotateDeltaX*=i.rotationInertia,r.rotateDeltaY*=i.rotationInertia,t="grabbing"),Math.abs(r.panDeltaX)<wc&&(r.panDeltaX=0),Math.abs(r.panDeltaY)<wc&&(r.panDeltaY=0),Math.abs(r.panDeltaZ)<wc&&(r.panDeltaZ=0),0!==r.panDeltaX||0!==r.panDeltaY||0!==r.panDeltaZ){const e=p.vec3();let s,n;if(e[0]=r.panDeltaX,e[1]=r.panDeltaY,e[2]=r.panDeltaZ,i.constrainVertical){o.xUp?(s=o.eye[0],n=o.look[0]):o.yUp?(s=o.eye[1],n=o.look[1]):o.zUp&&(s=o.eye[2],n=o.look[2]),o.pan(e);const t=o.eye,i=o.look;o.xUp?(t[0]=s,i[0]=n):o.yUp?(t[1]=s,i[1]=n):o.zUp&&(t[2]=s,i[2]=n),o.eye=t,o.look=i}else o.pan(e);t="grabbing"}if(r.panDeltaX*=i.panInertia,r.panDeltaY*=i.panInertia,r.panDeltaZ*=i.panInertia,0!==d){if(t=d<0?"zoom-in":"zoom-out",i.firstPerson){let e,t;if(i.constrainVertical&&(o.xUp?(e=o.eye[0],t=o.look[0]):o.yUp?(e=o.eye[1],t=o.look[1]):o.zUp&&(e=o.eye[2],t=o.look[2])),i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-d)&&(s.followPointerDirty=!0)}else o.pan([0,0,d]),o.ortho.scale=o.ortho.scale-d;if(i.constrainVertical){const i=o.eye,s=o.look;o.xUp?(i[0]=e,s[0]=t):o.yUp?(i[1]=e,s[1]=t):o.zUp&&(i[2]=e,s[2]=t),o.eye=i,o.look=s}}else if(i.planView)if(i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-d)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+d,o.zoom(d);else if(i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-d)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+d,o.zoom(d);r.dollyDelta*=i.dollyInertia}n.fireEvents(),document.body.style.cursor=t}))}destroy(){this._scene.off(this._onTick)}}class Ec{constructor(e,t,i,s,r){this._scene=e;const o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=e=>{Ac(e,o,s.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=e=>{i.active&&i.pointerEnabled&&(Ac(e,o,s.pointerCanvasPos),s.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=e=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}function Ac(e,t,i){if(e){const{x:s,y:r}=t.getBoundingClientRect();i[0]=e.clientX-s,i[1]=e.clientY-r}else e=window.event,i[0]=e.x,i[1]=e.y;return i}const Dc=function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t};class Tc{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.pivotController,a=p.vec2(),l=p.vec2(),h=p.vec2(),c=p.vec2(),u=[],d=this._scene.canvas.canvas;let f=0,m=!1;this._onTick=e.on("tick",(()=>{m=!1})),d.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{if(!i.active||!i.pointerEnabled)return;t.preventDefault();const r=t.touches,l=t.changedTouches;for(s.touchStartTime=Date.now(),1===r.length&&1===l.length&&(Dc(r[0],a),i.followPointer&&(o.pickCursorPos=a,o.schedulePickSurface=!0,o.update(),i.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(n.setPivotPos(o.pickResult.worldPos),!i.firstPerson&&n.startPivot()&&n.showPivot()):(i.smartPivot?n.setCanvasPivotPos(s.pointerCanvasPos):n.setPivotPos(e.camera.look),!i.firstPerson&&n.startPivot()&&n.showPivot()))));u.length<r.length;)u.push(p.vec2());for(let e=0,t=r.length;e<t;++e)Dc(r[e],u[e]);f=r.length}),d.addEventListener("touchmove",this._canvasTouchMoveHandler=t=>{if(!i.active||!i.pointerEnabled)return;if(t.stopPropagation(),t.preventDefault(),m)return;m=!0;const n=e.canvas.boundary,a=n[2],d=n[3],g=t.touches;if(t.touches.length===f){if(1===f){Dc(g[0],l),p.subVec2(l,u[0],c);const t=c[0],o=c[1];if(null!==s.longTouchTimeout&&(Math.abs(t)>i.longTapRadius||Math.abs(o)>i.longTapRadius)&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),i.planView){const s=e.camera;if("perspective"===s.projection){const n=Math.abs(e.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=t*n/d*i.touchPanRate,r.panDeltaY+=o*n/d*i.touchPanRate}else r.panDeltaX+=.5*s.ortho.scale*(t/d)*i.touchPanRate,r.panDeltaY+=.5*s.ortho.scale*(o/d)*i.touchPanRate}else r.rotateDeltaY-=t/a*(1*i.dragRotationRate),r.rotateDeltaX+=o/d*(1.5*i.dragRotationRate)}else if(2===f){const t=g[0],n=g[1];Dc(t,l),Dc(n,h);const a=p.geometricMeanVec2(u[0],u[1]),c=p.geometricMeanVec2(l,h),f=p.vec2();p.subVec2(a,c,f);const m=f[0],_=f[1],v=e.camera,b=p.distVec2([t.pageX,t.pageY],[n.pageX,n.pageY]),x=(p.distVec2(u[0],u[1])-b)*i.touchDollyRate;if(r.dollyDelta=x,Math.abs(x)<1)if("perspective"===v.projection){const t=o.pickResult?o.pickResult.worldPos:e.center,s=Math.abs(p.lenVec3(p.subVec3(t,e.camera.eye,[])))*Math.tan(v.perspective.fov/2*Math.PI/180);r.panDeltaX-=m*s/d*i.touchPanRate,r.panDeltaY-=_*s/d*i.touchPanRate}else r.panDeltaX-=.5*v.ortho.scale*(m/d)*i.touchPanRate,r.panDeltaY-=.5*v.ortho.scale*(_/d)*i.touchPanRate;s.pointerCanvasPos=c}for(let e=0;e<f;++e)Dc(g[e],u[e])}})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}const Sc=function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t};class Ic{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.cameraControl;let a;const l=[],h=new Float32Array(2);let c=-1,u=-1;const d=this._scene.canvas.canvas,f=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i?i.entity.aabb:e.aabb;if(s){const i=e.camera;p.subVec3(i.eye,i.look,[]),t.cameraFlight.flyTo({aabb:r})}else t.cameraFlight.flyTo({aabb:r})};d.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{if(!i.active||!i.pointerEnabled)return;null!==s.longTouchTimeout&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null);const r=e.touches,o=e.changedTouches;if(a=Date.now(),1===r.length&&1===o.length){c=a,Sc(r[0],h);const o=h[0],n=h[1],l=r[0].pageX,u=r[0].pageY;s.longTouchTimeout=setTimeout((()=>{t.cameraControl.fire("rightClick",{pagePos:[Math.round(l),Math.round(u)],canvasPos:[Math.round(o),Math.round(n)],event:e},!0),s.longTouchTimeout=null}),i.longTapTimeout)}else c=-1;for(;l.length<r.length;)l.push(new Float32Array(2));for(let e=0,t=r.length;e<t;++e)Sc(r[e],l[e]);l.length=r.length},{passive:!0}),d.addEventListener("touchend",this._canvasTouchEndHandler=e=>{if(!i.active||!i.pointerEnabled)return;const t=Date.now(),r=e.touches,a=e.changedTouches,d=n.hasSubs("pickedSurface");null!==s.longTouchTimeout&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),0===r.length&&1===a.length&&c>-1&&t-c<150&&(u>-1&&c-u<325?(Sc(a[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=d,o.update(),o.pickResult?(o.pickResult.touchInput=!0,n.fire("doublePicked",o.pickResult),o.pickedSurface&&n.fire("doublePickedSurface",o.pickResult),i.doublePickFlyTo&&f(o.pickResult)):(n.fire("doublePickedNothing"),i.doublePickFlyTo&&f()),u=-1):p.distVec2(l[0],h)<4&&(Sc(a[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=d,o.update(),o.pickResult?(o.pickResult.touchInput=!0,n.fire("picked",o.pickResult),o.pickedSurface&&n.fire("pickedSurface",o.pickResult)):n.fire("pickedNothing"),u=t),c=-1),l.length=r.length;for(let e=0,t=r.length;e<t;++e)l[e][0]=r[e].pageX,l[e][1]=r[e].pageY},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}class Fc extends T{constructor(e,t={}){super(e,t),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=e=>{e.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:p.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:p.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new uc(this,this._configs),pivotController:new cc(i,this._configs),panController:new sc(i),cameraFlight:new ko(this,{duration:.5})},this._handlers=[new Ec(this.scene,this._controllers,this._configs,this._states,this._updates),new Tc(this.scene,this._controllers,this._configs,this._states,this._updates),new pc(this.scene,this._controllers,this._configs,this._states,this._updates),new xc(this.scene,this._controllers,this._configs,this._states,this._updates),new yc(this.scene,this._controllers,this._configs,this._states,this._updates),new Ic(this.scene,this._controllers,this._configs,this._states,this._updates),new Pc(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new Cc(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=t.navMode,t.planView&&(this.planView=t.planView),this.constrainVertical=t.constrainVertical,t.keyboardLayout?this.keyboardLayout=t.keyboardLayout:this.keyMap=t.keyMap,this.doublePickFlyTo=t.doublePickFlyTo,this.panRightClick=t.panRightClick,this.active=t.active,this.followPointer=t.followPointer,this.rotationInertia=t.rotationInertia,this.keyboardPanRate=t.keyboardPanRate,this.touchPanRate=t.touchPanRate,this.keyboardRotationRate=t.keyboardRotationRate,this.dragRotationRate=t.dragRotationRate,this.touchDollyRate=t.touchDollyRate,this.dollyInertia=t.dollyInertia,this.dollyProximityThreshold=t.dollyProximityThreshold,this.dollyMinSpeed=t.dollyMinSpeed,this.panInertia=t.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=t.keyboardDollyRate,this.mouseWheelDollyRate=t.mouseWheelDollyRate}set keyMap(e){if(e=e||"qwerty",v.isString(e)){const t=this.scene.input,i={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[t.KEY_A],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_Z],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[t.KEY_Q],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_W],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6]}this._keyMap=i}else{const t=e;this._keyMap=t}}get keyMap(){return this._keyMap}_isKeyDownForAction(e,t){const i=this._keyMap[e];if(!i)return!1;t||(t=this.scene.input.keyDown);for(let e=0,s=i.length;e<s;e++){if(t[i[e]])return!0}return!1}set pivotElement(e){this._controllers.pivotController.setPivotElement(e)}set active(e){this._configs.active=!1!==e}get active(){return this._configs.active}set navMode(e){"firstPerson"!==(e=e||"orbit")&&"orbit"!==e&&"planView"!==e&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson="firstPerson"===e,this._configs.planView="planView"===e,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}get navMode(){return this._configs.navMode}set pointerEnabled(e){this._reset(),this._configs.pointerEnabled=!!e}_reset(){for(let e=0,t=this._handlers.length;e<t;e++){const t=this._handlers[e];t.reset&&t.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(e){this._configs.followPointer=!1!==e}get followPointer(){return this._configs.followPointer}set pivotPos(e){this._controllers.pivotController.setPivotPos(e)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(e){this._configs.constrainVertical=!!e}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(e){this._configs.doublePickFlyTo=!1!==e}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(e){this._configs.panRightClick=!1!==e}get panRightClick(){return this._configs.panRightClick}set rotationInertia(e){this._configs.rotationInertia=null!=e?e:0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(e){this._configs.keyboardPanRate=null!=e?e:5}set touchPanRate(e){this._configs.touchPanRate=null!=e?e:1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(e){this._configs.keyboardRotationRate=null!=e?e:90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(e){this._configs.dragRotationRate=null!=e?e:360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(e){this._configs.keyboardDollyRate=null!=e?e:15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(e){this._configs.touchDollyRate=null!=e?e:.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(e){this._configs.mouseWheelDollyRate=null!=e?e:100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(e){this._configs.dollyInertia=null!=e?e:0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(e){this._configs.dollyProximityThreshold=null!=e?e:35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(e){this._configs.dollyMinSpeed=null!=e?e:.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(e){this._configs.panInertia=null!=e?e:.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(e){"qwerty"!==(e=e||"qwerty")&&"azerty"!==e&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}set smartPivot(e){this._configs.smartPivot=!1!==e}get smartPivot(){return this._configs.smartPivot}set doubleClickTimeFrame(e){this._configs.doubleClickTimeFrame=null!=e?e:250}get doubleClickTimeFrame(){return this._configs.doubleClickTimeFrame}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let e=0,t=this._handlers.length;e<t;e++){const t=this._handlers[e];t.destroy&&t.destroy()}}_destroyControllers(){for(let e=0,t=this._controllers.length;e<t;e++){const t=this._controllers[e];t.destroy&&t.destroy()}}}class Lc{constructor(e,t,i,s,r,o,n,a,l){this.id=t,this.projectId=i,this.revisionId=s,this.author=r,this.createdAt=o,this.creatingApplication=n,this.schema=a,this.metaScene=e,this.propertySets=l,this.rootMetaObject=null,this.rootMetaObjects=[]}getJSON(){const e=[];!function t(i){const s={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(s.parent=i.parent.id),e.push(s);const r=i.children;if(r)for(let e=0,i=r.length;e<i;e++)t(r[e])}(this.rootMetaObject);return{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:e}}}class Bc{constructor(e,t,i,s,r,o,n,a,l){this.metaModel=e,this.metaModels=[e],this.id=t,this.originalSystemId=i,this.name=s,this.type=r,this.propertySets=o,null!=n&&(this.parent=n),null!=a&&(this.children=a),null!=l&&(this.external=l)}getObjectIDsInSubtree(){const e=[];return function t(i){if(!i)return;e.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)t(s[r])}(this),e}withMetaObjectsInSubtree(e){!function t(i){if(!i)return;e(i);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)t(s[r])}(this)}getObjectIDsInSubtreeByType(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=e[i];const r=[];return function e(i){if(!i)return;t[i.type]&&r.push(i.id);const s=i.children;if(s)for(var o=0,n=s.length;o<n;o++)e(s[o])}(this),r}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class Rc{constructor(e,t,i,s,r){this.name=e,this.type=i,this.value=t,this.valueType=s,this.description=r}}class kc{constructor(e,t,i,s,r){if(this.id=e,this.originalSystemId=t,this.name=i,this.type=s,this.properties=[],r)for(let e=0,t=r.length;e<t;e++){const t=r[e];this.properties.push(new Rc(t.name,t.value,t.type,t.valueType,t.description))}}}class Oc{constructor(e,t){this.viewer=e,this.scene=t,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this.rootMetaObjects={},this._typeCounts={},this._eventSubs={}}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}off(e){}createMetaModel(e,t,i={}){const s=t.projectId||"none",r=t.revisionId||"none",o=t.propertySets||[],n=t.metaObjects||[],a=t.author,l=t.createdAt,h=t.creatingApplication,c=t.schema,u=new Lc(this,e,s,r,a,l,h,c,[],null);this.metaModels[e]=u;for(let e=0,t=o.length;e<t;e++){const t=o[e],i=t.id,s=new kc(i,t.originalSystemId,t.name,t.type,t.properties);u.propertySets[i]=s,this.propertySets[i]=s}const d=[],p=[],f=[];for(let e=0,t=n.length;e<t;e++){const t=n[e];t.type,d.push(t)}for(let e=0,t=d.length;e<t;e++){let t=d[e];const i=this.metaObjects[t.id];i?(i.metaModels.push(u),p.push(i)):f.push(t)}for(let e=0,t=f.length;e<t;e++){const t=f[e],i=t.type,s=t.id,r=t.id,o=t.name,n=[];if(t.propertySetIds&&t.propertySetIds.length>0)for(let e=0,i=t.propertySetIds.length;e<i;e++){const i=t.propertySetIds[e],s=u.propertySets[i];s&&n.push(s)}const a=null,l=null,h=t.external,c=new Bc(u,s,r,o,i,n,a,l,h);c._parentId=t.parent,this.metaObjects[s]=c,(this.metaObjectsByType[i]||(this.metaObjectsByType[i]={}))[s]=c,void 0===this._typeCounts[i]?this._typeCounts[i]=1:this._typeCounts[i]++,p.push(c),void 0===t.parent||t.parent}for(let e=0,t=p.length;e<t;e++){const t=p[e],i=t.id;if(void 0!==t._parentId&&null!==t._parentId||t.parent){if(t._parentId){const e=t._parentId;t._parentId=null;let i=this.metaObjects[e];i&&(t.parent=i,i.children=i.children||[],i.children.push(t))}}else u.rootMetaObject=t,u.rootMetaObjects[i]=t,this.rootMetaObjects[i]=t}return this.fire("metaModelCreated",e),u}destroyMetaModel(e){const t=this.metaModels[e];t&&(this._removeMetaModel(t),this.fire("metaModelDestroyed",e))}_removeMetaModel(e){const t=this.metaObjects,i=this.metaObjectsByType;let s=e=>{delete t[e.id];const r=i[e.type];r&&r[e.id]&&(delete r[e.id],0==--this._typeCounts[e.type]&&(delete this._typeCounts[e.type],delete i[e.type]));const o=e.children;if(o)for(let e=0,t=o.length;e<t;e++){const t=o[e];s(t)}};s(e.rootMetaObject);for(let t in e.propertySets)e.propertySets.hasOwnProperty(t)&&delete this.propertySets[t];delete this.metaModels[e.id]}getObjectIDsByType(e){const t=this.metaObjectsByType[e];return t?Object.keys(t):[]}getObjectIDsInSubtree(e,t,i){const s=[],r=this.metaObjects[e],o=t&&t.length>0?Nc(t):null,n=i&&i.length>0?Nc(i):null;return function e(t){if(!t)return;var i=!0;(n&&n[t.type]||o&&!o[t.type])&&(i=!1),i&&s.push(t.id);const r=t.children;if(r)for(var a=0,l=r.length;a<l;a++)e(r[a])}(r),s}withMetaObjectsInSubtree(e,t){const i=this.metaObjects[e];i&&i.withMetaObjectsInSubtree(t)}}function Nc(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=!0;return t}class jc{constructor(e){this.language="en",this.localeService=e.localeService||new Do,this.scene=new As(this,{canvasId:e.canvasId,canvasElement:e.canvasElement,keyboardEventsElement:e.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:!1!==e.preserveDrawingBuffer,premultipliedAlpha:!!e.premultipliedAlpha,antialias:!1!==e.antialias},spinnerElementId:e.spinnerElementId,transparent:!1!==e.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:e.units,scale:e.scale,origin:e.origin,saoEnabled:e.saoEnabled,alphaDepthMask:!1!==e.alphaDepthMask,entityOffsetsEnabled:!!e.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!e.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!e.logarithmicDepthBufferEnabled,pbrEnabled:!!e.pbrEnabled,colorTextureEnabled:!1!==e.colorTextureEnabled}),this.metaScene=new Oc(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new ko(this.scene,{duration:.5}),this.cameraControl=new Fc(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}get capabilities(){return this.scene.capabilities}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`)}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`)}addPlugin(e){this._plugins.push(e)}removePlugin(e){for(let t=0,i=this._plugins.length;t<i;t++){const i=this._plugins[t];if(i===e)return i.clear&&i.clear(),void this._plugins.splice(t,1)}}sendToPlugins(e,t){for(let i=0,s=this._plugins.length;i<s;i++){const s=this._plugins[i];s.send&&s.send(e,t)}}clear(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(e={}){const t=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting");const i=void 0!==e.width&&void 0!==e.height,s=this.scene.canvas.canvas,r=s.clientWidth,o=s.clientHeight,n=s.style.width,a=s.style.height,l=e.width?Math.floor(e.width):s.width,h=e.height?Math.floor(e.height):s.height;i&&(s.style.width=l+"px",s.style.height=h+"px"),this.scene._renderer.renderSnapshot();const c=this.scene._renderer.readSnapshot(e);return i&&(s.style.width=n,s.style.height=a,s.width=r,s.height=o,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),c}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const e=this._plugins.slice();for(let t=0,i=e.length;t<i;t++){e[t].destroy()}this.scene.destroy()}}class Vc extends a{constructor(e,t={}){super("FastNav",e),this._hideColorTexture=!1!==t.hideColorTexture,this._hidePBR=!1!==t.hidePBR,this._hideSAO=!1!==t.hideSAO,this._hideEdges=!1!==t.hideEdges,this._hideTransparentObjects=!!t.hideTransparentObjects,this._scaleCanvasResolution=!!t.scaleCanvasResolution,this._scaleCanvasResolutionFactor=t.scaleCanvasResolutionFactor||.6,this._delayBeforeRestore=!1!==t.delayBeforeRestore,this._delayBeforeRestoreSeconds=t.delayBeforeRestoreSeconds||.5;let i=1e3*this._delayBeforeRestoreSeconds,s=!1;const r=()=>{i=1e3*this._delayBeforeRestoreSeconds,s||(e.scene._renderer.setColorTextureEnabled(!this._hideColorTexture),e.scene._renderer.setPBREnabled(!this._hidePBR),e.scene._renderer.setSAOEnabled(!this._hideSAO),e.scene._renderer.setTransparentEnabled(!this._hideTransparentObjects),e.scene._renderer.setEdgesEnabled(!this._hideEdges),this._scaleCanvasResolution?e.scene.canvas.resolutionScale=this._scaleCanvasResolutionFactor:e.scene.canvas.resolutionScale=1,s=!0)};this._onCanvasBoundary=e.scene.canvas.on("boundary",r),this._onCameraMatrix=e.scene.camera.on("matrix",r),this._onSceneTick=e.scene.on("tick",(t=>{s&&(i-=t.deltaTime,(!this._delayBeforeRestore||i<=0)&&(e.scene.canvas.resolutionScale=1,e.scene._renderer.setEdgesEnabled(!0),e.scene._renderer.setColorTextureEnabled(!0),e.scene._renderer.setPBREnabled(!0),e.scene._renderer.setSAOEnabled(!0),e.scene._renderer.setTransparentEnabled(!0),s=!1))}));let o=!1;this._onSceneMouseDown=e.scene.input.on("mousedown",(()=>{o=!0})),this._onSceneMouseUp=e.scene.input.on("mouseup",(()=>{o=!1})),this._onSceneMouseMove=e.scene.input.on("mousemove",(()=>{o&&r()}))}get hideColorTexture(){return this._hideColorTexture}set hideColorTexture(e){this._hideColorTexture=e}get hidePBR(){return this._hidePBR}set hidePBR(e){this._hidePBR=e}get hideSAO(){return this._hideSAO}set hideSAO(e){this._hideSAO=e}get hideEdges(){return this._hideEdges}set hideEdges(e){this._hideEdges=e}get hideTransparentObjects(){return this._hideTransparentObjects}set hideTransparentObjects(e){this._hideTransparentObjects=!1!==e}get scaleCanvasResolution(){return this._scaleCanvasResolution}set scaleCanvasResolution(e){this._scaleCanvasResolution=e}get scaleCanvasResolutionFactor(){return this._scaleCanvasResolutionFactor}set scaleCanvasResolutionFactor(e){this._scaleCanvasResolutionFactor=e||.6}get delayBeforeRestore(){return this._delayBeforeRestore}set delayBeforeRestore(e){this._delayBeforeRestore=e}get delayBeforeRestoreSeconds(){return this._delayBeforeRestoreSeconds}set delayBeforeRestoreSeconds(e){this._delayBeforeRestoreSeconds=null!=e?e:.5}send(e,t){}destroy(){this.viewer.scene.camera.off(this._onCameraMatrix),this.viewer.scene.canvas.off(this._onCanvasBoundary),this.viewer.scene.input.off(this._onSceneMouseDown),this.viewer.scene.input.off(this._onSceneMouseUp),this.viewer.scene.input.off(this._onSceneMouseMove),this.viewer.scene.off(this._onSceneTick),super.destroy()}}Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser);const zc="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);function Uc(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}zc&&parseFloat(zc[1]);const Gc="object"!=typeof process||"[object process]"!==String(process)||process.browser,Wc="undefined"!=typeof window&&void 0!==window.orientation,Hc="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);function Xc(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}Hc&&parseFloat(Hc[1]);class Yc{constructor(e,t){Xc(this,"name",void 0),Xc(this,"workerThread",void 0),Xc(this,"isRunning",!0),Xc(this,"result",void 0),Xc(this,"_resolve",(()=>{})),Xc(this,"_reject",(()=>{})),this.name=e,this.workerThread=t,this.result=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Uc(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Uc(this.isRunning),this.isRunning=!1,this._reject(e)}}class qc{}const $c=new Map;function Zc(e){Uc(e.source&&!e.url||!e.source&&e.url);let t=$c.get(e.source||e.url);return t||(e.url&&(t=function(e){if(!e.startsWith("http"))return e;return Kc((t=e,"try {\n  importScripts('".concat(t,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")));var t}(e.url),$c.set(e.url,t)),e.source&&(t=Kc(e.source),$c.set(e.source,t))),Uc(t),t}function Kc(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function Qc(e,t=!0,i){const s=i||new Set;if(e){if(Jc(e))s.add(e);else if(Jc(e.buffer))s.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const i in e)Qc(e[i],t,s)}else;return void 0===i?Array.from(s):[]}function Jc(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}const eu=()=>{};class tu{static isSupported(){return"undefined"!=typeof Worker&&Gc||void 0!==typeof qc}constructor(e){Xc(this,"name",void 0),Xc(this,"source",void 0),Xc(this,"url",void 0),Xc(this,"terminated",!1),Xc(this,"worker",void 0),Xc(this,"onMessage",void 0),Xc(this,"onError",void 0),Xc(this,"_loadableURL","");const{name:t,source:i,url:s}=e;Uc(i||s),this.name=t,this.source=i,this.url=s,this.onMessage=eu,this.onError=e=>console.log(e),this.worker=Gc?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=eu,this.onError=eu,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||Qc(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+="worker ".concat(this.name," from ").concat(this.url,". "),e.message&&(t+="".concat(e.message," in ")),e.lineno&&(t+=":".concat(e.lineno,":").concat(e.colno)),new Error(t)}_createBrowserWorker(){this._loadableURL=Zc({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>console.error(e),e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);e=new qc(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new qc(this.source,{eval:!0})}return e.on("message",(e=>{this.onMessage(e)})),e.on("error",(e=>{this.onError(e)})),e.on("exit",(e=>{})),e}}class iu{static isSupported(){return tu.isSupported()}constructor(e){Xc(this,"name","unnamed"),Xc(this,"source",void 0),Xc(this,"url",void 0),Xc(this,"maxConcurrency",1),Xc(this,"maxMobileConcurrency",1),Xc(this,"onDebug",(()=>{})),Xc(this,"reuseWorkers",!0),Xc(this,"props",{}),Xc(this,"jobQueue",[]),Xc(this,"idleQueue",[]),Xc(this,"count",0),Xc(this,"isDestroyed",!1),this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,t=((e,t,i)=>e.done(i)),i=((e,t)=>e.error(t))){const s=new Promise((s=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:s}),this)));return this._startQueuedJob(),await s}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new Yc(t.name,e);e.onMessage=e=>t.onMessage(i,e.type,e.payload),e.onError=e=>t.onError(i,e),t.onStart(i);try{await i.result}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new tu({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Wc?this.maxMobileConcurrency:this.maxConcurrency}}const su={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class ru{static isSupported(){return tu.isSupported()}static getWorkerFarm(e={}){return ru._workerFarm=ru._workerFarm||new ru({}),ru._workerFarm.setProps(e),ru._workerFarm}constructor(e){Xc(this,"props",void 0),Xc(this,"workerPools",new Map),this.props={...su},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:i,url:s}=e;let r=this.workerPools.get(t);return r||(r=new iu({name:t,source:i,url:s}),r.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,r)),r}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}Xc(ru,"_workerFarm",void 0);const ou={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},nu=ou.window||ou.self||ou.global,au=ou.process||{},lu="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source",hu=!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(e){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,i=e||t;return!!(i&&i.indexOf("Electron")>=0)}();class cu{constructor(e,t,i="sessionStorage"){this.storage=function(e){try{const t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),t}catch(e){return null}}(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function uu(e,t,i,s=600){const r=e.src.replace(/\(/g,"%28").replace(/\)/g,"%29");e.width>s&&(i=Math.min(i,s/e.width));const o=e.width*i,n=e.height*i,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(r,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}const du={BLACK:30,RED:31,GREEN:32,YELLOW:33,BLUE:34,MAGENTA:35,CYAN:36,WHITE:37,BRIGHT_BLACK:90,BRIGHT_RED:91,BRIGHT_GREEN:92,BRIGHT_YELLOW:93,BRIGHT_BLUE:94,BRIGHT_MAGENTA:95,BRIGHT_CYAN:96,BRIGHT_WHITE:97};function pu(e){return"string"==typeof e?du[e.toUpperCase()]||du.WHITE:e}function fu(e,t){if(!e)throw new Error(t||"Assertion failed")}function mu(){let e;if(hu&&nu.performance)e=nu.performance.now();else if(au.hrtime){const t=au.hrtime();e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}const gu={debug:hu&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},_u={enabled:!0,level:0};function vu(){}const bu={},xu={once:!0};function yu(e){for(const t in e)for(const i in e[t])return i||"untitled";return"empty"}class Pu{constructor({id:e}={id:""}){this.id=e,this.VERSION=lu,this._startTs=mu(),this._deltaTs=mu(),this.LOG_THROTTLE_TIMEOUT=0,this._storage=new cu("__probe-".concat(this.id,"__"),_u),this.userData={},this.timeStamp("".concat(this.id," started")),function(e,t=["constructor"]){const i=Object.getPrototypeOf(e),s=Object.getOwnPropertyNames(i);for(const i of s)"function"==typeof e[i]&&(t.find((e=>i===e))||(e[i]=e[i].bind(e)))}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((mu()-this._startTs).toPrecision(10))}getDelta(){return Number((mu()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}assert(e,t){fu(e,t)}warn(e){return this._getLogFunction(0,e,gu.warn,arguments,xu)}error(e){return this._getLogFunction(0,e,gu.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,gu.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,gu.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,gu.debug||gu.info,arguments,xu)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||vu,i&&[i],{tag:yu(t)}):vu}image({logLevel:e,priority:t,image:i,message:s="",scale:r=1}){return this._shouldLog(e||t)?hu?function({image:e,message:t="",scale:i=1}){if("string"==typeof e){const s=new Image;return s.onload=()=>{const e=uu(s,t,i);console.log(...e)},s.src=e,vu}const s=e.nodeName||"";if("img"===s.toLowerCase())return console.log(...uu(e,t,i)),vu;if("canvas"===s.toLowerCase()){const s=new Image;return s.onload=()=>console.log(...uu(s,t,i)),s.src=e.toDataURL(),vu}return vu}({image:i,message:s,scale:r}):function({image:e,message:t="",scale:i=1}){let s=null;try{s=module.require("asciify-image")}catch(e){}if(s)return()=>s(e,{fit:"box",width:"".concat(Math.round(80*i),"%")}).then((e=>console.log(e)));return vu}({image:i,message:s,scale:r}):vu}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||vu)}group(e,t,i={collapsed:!1}){i=Mu({logLevel:e,message:t,opts:i});const{collapsed:s}=i;return i.method=(s?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(e,t,i={}){return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||vu)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=wu(e)}_getLogFunction(e,t,i,s=[],r){if(this._shouldLog(e)){r=Mu({logLevel:e,message:t,args:s,opts:r}),fu(i=i||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=mu();const o=r.tag||r.message;if(r.once){if(bu[o])return vu;bu[o]=mu()}return t=function(e,t,i){if("string"==typeof t){const n=i.time?function(e,t=8){const i=Math.max(t-e.length,0);return"".concat(" ".repeat(i)).concat(e)}(function(e){let t;return t=e<10?"".concat(e.toFixed(2),"ms"):e<100?"".concat(e.toFixed(1),"ms"):e<1e3?"".concat(e.toFixed(0),"ms"):"".concat((e/1e3).toFixed(2),"s"),t}(i.total)):"";t=i.time?"".concat(e,": ").concat(n,"  ").concat(t):"".concat(e,": ").concat(t),s=t,r=i.color,o=i.background,hu||"string"!=typeof s||(r&&(r=pu(r),s="[".concat(r,"m").concat(s,"[39m")),o&&(r=pu(o),s="[".concat(o+10,"m").concat(s,"[49m"))),t=s}var s,r,o;return t}(this.id,r.message,r),i.bind(console,t,...r.args)}return vu}}function wu(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return fu(Number.isFinite(t)&&t>=0),t}function Mu(e){const{logLevel:t,message:i}=e;e.logLevel=wu(t);const s=e.args?Array.from(e.args):[];for(;s.length&&s.shift()!==i;);switch(e.args=s,typeof t){case"string":case"function":void 0!==i&&s.unshift(i),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());const r=typeof e.message;return fu("string"===r||"object"===r),Object.assign(e,e.opts)}Pu.VERSION=lu,new Pu({id:"loaders.gl"});function Cu(){return!("object"==typeof process&&"[object process]"===String(process)&&!process.browser)||function(e){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof process&&"object"==typeof process.versions&&Boolean(process.versions.electron))return!0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent,i=e||t;return!!(i&&i.indexOf("Electron")>=0)}()}new class{constructor(){Xc(this,"console",void 0),this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}};const Eu={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:"undefined"!=typeof global&&global,document:"undefined"!=typeof document&&document,process:"object"==typeof process&&process},Au=Eu.window||Eu.self||Eu.global,Du=Eu.process||{},Tu="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";Cu();class Su{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";Xc(this,"storage",void 0),Xc(this,"id",void 0),Xc(this,"config",{}),this.storage=function(e){try{const t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),t}catch(e){return null}}(i),this.id=e,this.config={},Object.assign(this.config,t),this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){return this.config={},this.updateConfiguration(e)}updateConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}return this}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function Iu(e,t,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const r=e.src.replace(/\(/g,"%28").replace(/\)/g,"%29");e.width>s&&(i=Math.min(i,s/e.width));const o=e.width*i,n=e.height*i,a=["font-size:1px;","padding:".concat(Math.floor(n/2),"px ").concat(Math.floor(o/2),"px;"),"line-height:".concat(n,"px;"),"background:url(".concat(r,");"),"background-size:".concat(o,"px ").concat(n,"px;"),"color:transparent;"].join("");return["".concat(t," %c+"),a]}let Fu;function Lu(e){return"string"==typeof e?Fu[e.toUpperCase()]||Fu.WHITE:e}function Bu(e,t){if(!e)throw new Error(t||"Assertion failed")}function Ru(){let e;var t,i;if(Cu&&"performance"in Au)e=null==Au||null===(t=Au.performance)||void 0===t||null===(i=t.now)||void 0===i?void 0:i.call(t);else if("hrtime"in Du){var s;const t=null==Du||null===(s=Du.hrtime)||void 0===s?void 0:s.call(Du);e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}!function(e){e[e.BLACK=30]="BLACK",e[e.RED=31]="RED",e[e.GREEN=32]="GREEN",e[e.YELLOW=33]="YELLOW",e[e.BLUE=34]="BLUE",e[e.MAGENTA=35]="MAGENTA",e[e.CYAN=36]="CYAN",e[e.WHITE=37]="WHITE",e[e.BRIGHT_BLACK=90]="BRIGHT_BLACK",e[e.BRIGHT_RED=91]="BRIGHT_RED",e[e.BRIGHT_GREEN=92]="BRIGHT_GREEN",e[e.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",e[e.BRIGHT_BLUE=94]="BRIGHT_BLUE",e[e.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",e[e.BRIGHT_CYAN=96]="BRIGHT_CYAN",e[e.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(Fu||(Fu={}));const ku={debug:Cu&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},Ou={enabled:!0,level:0};function Nu(){}const ju={},Vu={once:!0};class zu{constructor(){let{id:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};Xc(this,"id",void 0),Xc(this,"VERSION",Tu),Xc(this,"_startTs",Ru()),Xc(this,"_deltaTs",Ru()),Xc(this,"_storage",void 0),Xc(this,"userData",{}),Xc(this,"LOG_THROTTLE_TIMEOUT",0),this.id=e,this._storage=new Su("__probe-".concat(this.id,"__"),Ou),this.userData={},this.timeStamp("".concat(this.id," started")),function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const i=Object.getPrototypeOf(e),s=Object.getOwnPropertyNames(i);for(const i of s)"function"==typeof e[i]&&(t.find((e=>i===e))||(e[i]=e[i].bind(e)))}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((Ru()-this._startTs).toPrecision(10))}getDelta(){return Number((Ru()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._storage.updateConfiguration({enabled:e}),this}setLevel(e){return this._storage.updateConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.updateConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){Bu(e,t)}warn(e){return this._getLogFunction(0,e,ku.warn,arguments,Vu)}error(e){return this._getLogFunction(0,e,ku.error,arguments)}deprecated(e,t){return this.warn("`".concat(e,"` is deprecated and will be removed in a later version. Use `").concat(t,"` instead"))}removed(e,t){return this.error("`".concat(e,"` has been removed. Use `").concat(t,"` instead"))}probe(e,t){return this._getLogFunction(e,t,ku.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,ku.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){for(var i=arguments.length,s=new Array(i>2?i-2:0),r=2;r<i;r++)s[r-2]=arguments[r];return this._getLogFunction(e,t,ku.debug||ku.info,arguments,Vu)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||Nu,i&&[i],{tag:Wu(t)}):Nu}image(e){let{logLevel:t,priority:i,image:s,message:r="",scale:o=1}=e;return this._shouldLog(t||i)?Cu?function(e){let{image:t,message:i="",scale:s=1}=e;if("string"==typeof t){const e=new Image;return e.onload=()=>{const t=Iu(e,i,s);console.log(...t)},e.src=t,Nu}const r=t.nodeName||"";if("img"===r.toLowerCase())return console.log(...Iu(t,i,s)),Nu;if("canvas"===r.toLowerCase()){const e=new Image;return e.onload=()=>console.log(...Iu(e,i,s)),e.src=t.toDataURL(),Nu}return Nu}({image:s,message:r,scale:o}):function(e){let{image:t,message:i="",scale:s=1}=e,r=null;try{r=module.require("asciify-image")}catch(e){}if(r)return()=>r(t,{fit:"box",width:"".concat(Math.round(80*s),"%")}).then((e=>console.log(e)));return Nu}({image:s,message:r,scale:o}):Nu}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||Nu)}group(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const s=Gu({logLevel:e,message:t,opts:i}),{collapsed:r}=i;return s.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||Nu)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Uu(e)}_getLogFunction(e,t,i,s,r){if(this._shouldLog(e)){r=Gu({logLevel:e,message:t,args:s,opts:r}),Bu(i=i||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=Ru();const o=r.tag||r.message;if(r.once){if(ju[o])return Nu;ju[o]=Ru()}return t=function(e,t,i){if("string"==typeof t){const n=i.time?function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;const i=Math.max(t-e.length,0);return"".concat(" ".repeat(i)).concat(e)}(function(e){let t;return t=e<10?"".concat(e.toFixed(2),"ms"):e<100?"".concat(e.toFixed(1),"ms"):e<1e3?"".concat(e.toFixed(0),"ms"):"".concat((e/1e3).toFixed(2),"s"),t}(i.total)):"";t=i.time?"".concat(e,": ").concat(n,"  ").concat(t):"".concat(e,": ").concat(t),s=t,r=i.color,o=i.background,Cu||"string"!=typeof s||(r&&(r=Lu(r),s="[".concat(r,"m").concat(s,"[39m")),o&&(r=Lu(o),s="[".concat(o+10,"m").concat(s,"[49m"))),t=s}var s,r,o;return t}(this.id,r.message,r),i.bind(console,t,...r.args)}return Nu}}function Uu(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return Bu(Number.isFinite(t)&&t>=0),t}function Gu(e){const{logLevel:t,message:i}=e;e.logLevel=Uu(t);const s=e.args?Array.from(e.args):[];for(;s.length&&s.shift()!==i;);switch(typeof t){case"string":case"function":void 0!==i&&s.unshift(i),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());const r=typeof e.message;return Bu("string"===r||"object"===r),Object.assign(e,{args:s},e.opts)}function Wu(e){for(const t in e)for(const i in e[t])return i||"untitled";return"empty"}var Hu,Xu,Yu,qu,$u,Zu,Ku,Qu,Ju;let ed;Xc(zu,"VERSION",Tu),new zu({id:"loaders.gl"}),(Ju=Hu||(Hu={}))[Ju.NONE=0]="NONE",Ju[Ju.BASISLZ=1]="BASISLZ",Ju[Ju.ZSTD=2]="ZSTD",Ju[Ju.ZLIB=3]="ZLIB",function(e){e[e.BASICFORMAT=0]="BASICFORMAT"}(Xu||(Xu={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.ETC1S=163]="ETC1S",e[e.UASTC=166]="UASTC"}(Yu||(Yu={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.SRGB=1]="SRGB"}(qu||(qu={})),function(e){e[e.UNSPECIFIED=0]="UNSPECIFIED",e[e.LINEAR=1]="LINEAR",e[e.SRGB=2]="SRGB",e[e.ITU=3]="ITU",e[e.NTSC=4]="NTSC",e[e.SLOG=5]="SLOG",e[e.SLOG2=6]="SLOG2"}($u||($u={})),function(e){e[e.ALPHA_STRAIGHT=0]="ALPHA_STRAIGHT",e[e.ALPHA_PREMULTIPLIED=1]="ALPHA_PREMULTIPLIED"}(Zu||(Zu={})),function(e){e[e.RGB=0]="RGB",e[e.RRR=3]="RRR",e[e.GGG=4]="GGG",e[e.AAA=15]="AAA"}(Ku||(Ku={})),function(e){e[e.RGB=0]="RGB",e[e.RGBA=3]="RGBA",e[e.RRR=4]="RRR",e[e.RRRG=5]="RRRG"}(Qu||(Qu={})),function(e){e[e.NONE=0]="NONE",e[e.Null=1]="Null",e[e.Int=2]="Int",e[e.Float=3]="Float",e[e.Binary=4]="Binary",e[e.Utf8=5]="Utf8",e[e.Bool=6]="Bool",e[e.Decimal=7]="Decimal",e[e.Date=8]="Date",e[e.Time=9]="Time",e[e.Timestamp=10]="Timestamp",e[e.Interval=11]="Interval",e[e.List=12]="List",e[e.Struct=13]="Struct",e[e.Union=14]="Union",e[e.FixedSizeBinary=15]="FixedSizeBinary",e[e.FixedSizeList=16]="FixedSizeList",e[e.Map=17]="Map",e[e.Dictionary=-1]="Dictionary",e[e.Int8=-2]="Int8",e[e.Int16=-3]="Int16",e[e.Int32=-4]="Int32",e[e.Int64=-5]="Int64",e[e.Uint8=-6]="Uint8",e[e.Uint16=-7]="Uint16",e[e.Uint32=-8]="Uint32",e[e.Uint64=-9]="Uint64",e[e.Float16=-10]="Float16",e[e.Float32=-11]="Float32",e[e.Float64=-12]="Float64",e[e.DateDay=-13]="DateDay",e[e.DateMillisecond=-14]="DateMillisecond",e[e.TimestampSecond=-15]="TimestampSecond",e[e.TimestampMillisecond=-16]="TimestampMillisecond",e[e.TimestampMicrosecond=-17]="TimestampMicrosecond",e[e.TimestampNanosecond=-18]="TimestampNanosecond",e[e.TimeSecond=-19]="TimeSecond",e[e.TimeMillisecond=-20]="TimeMillisecond",e[e.TimeMicrosecond=-21]="TimeMicrosecond",e[e.TimeNanosecond=-22]="TimeNanosecond",e[e.DenseUnion=-23]="DenseUnion",e[e.SparseUnion=-24]="SparseUnion",e[e.IntervalDayTime=-25]="IntervalDayTime",e[e.IntervalYearMonth=-26]="IntervalYearMonth"}(ed||(ed={}));const td={IfcOpeningElement:{pickable:!1,visible:!1},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.4},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.3},DEFAULT:{}};function id(e,t={}){const i="lightgrey",s=t.hoverColor||"rgba(0,0,0,0.4)",r=500,o=r+r/3,n=o/24,a=[{boundary:[6,6,6,6],color:t.frontColor||t.color||"#55FF55"},{boundary:[18,6,6,6],color:t.backColor||t.color||"#55FF55"},{boundary:[12,6,6,6],color:t.leftColor||t.color||"#FF5555"},{boundary:[0,6,6,6],color:t.rightColor||t.color||"#FF5555"},{boundary:[6,0,6,6],color:t.topColor||t.color||"#7777FF"},{boundary:[6,12,6,6],color:t.bottomColor||t.color||"#7777FF"}],l=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];t.frontColor||t.color,t.backColor||t.color,t.leftColor||t.color,t.rightColor||t.color,t.topColor||t.color,t.bottomColor||t.color;const h=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}];for(let e=0,t=l.length;e<t;e++)p.normalizeVec3(l[e].dir,l[e].dir),p.normalizeVec3(l[e].up,l[e].up);for(let e=0,t=h.length;e<t;e++)p.normalizeVec3(h[e].dir,h[e].dir),p.normalizeVec3(h[e].up,h[e].up);var c=h;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=o,this._textureCanvas.height=r,this._textureCanvas.style.width=o+"px",this._textureCanvas.style.height="500px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=i,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6;document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);const u=this._textureCanvas.getContext("2d");let d=!1;function f(){for(let e=0,t=a.length;e<t;e++){const t=a[e],i=t.boundary,s=Math.round(i[0]*n),r=Math.round(i[1]*n),o=Math.round(i[2]*n),l=Math.round(i[3]*n);u.fillStyle=t.color,u.fillRect(s,r,o,l)}for(let e=0,a=c.length;e<a;e++){let a,h,d,p;const f=c[e],g=f.boundaries;for(var t=0,r=g.length;t<r;t++){const e=g[t];a=Math.round(e[0]*n),h=Math.round(e[1]*n),d=Math.round(e[2]*n),p=Math.round(e[3]*n),f.highlighted&&(u.fillStyle=f.highlighted?s:f.color||i,u.fillRect(a,h,d,p))}if(f.label){u.fillStyle="black",u.font="60px sans-serif",u.textAlign="center";var o=a+.5*d,l=h+.7*p;u.fillText(m(f.label),o,l,80)}}e.scene.glRedraw()}const m=function(){const t={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},i={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},s={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"};return function(r){const o=d?i:t,n=o?o[r]:null;return n?e.localeService.translate(n)||s[n]||n:r}}();this.setZUp=function(){d=!0,c=l,this.clear()},this.setYUp=function(){d=!1,c=h,this.clear()},this.clear=function(){u.fillStyle=i,u.fillRect(0,0,o,r);for(var e=0,t=c.length;e<t;e++){c[e].highlighted=!1}f()},this.getArea=function(e){const t=e[0]*o,i=r-e[1]*r;for(var s=0,a=c.length;s<a;s++){const e=c[s].boundaries;for(var l=0,h=e.length;l<h;l++){const r=e[l];if(t>=r[0]*n&&t<=(r[0]+r[2])*n&&i>=r[1]*n&&i<=(r[1]+r[3])*n)return s}}return-1},this.setAreaHighlighted=function(e,t){var i=c[e];if(!i)throw"Area not found: "+e;i.highlighted=!!t,f()},this.getAreaDir=function(e){var t=c[e];if(!t)throw"Unknown area: "+e;return t.dir},this.getAreaUp=function(e){var t=c[e];if(!t)throw"Unknown area: "+e;return t.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}class sd extends a{constructor(e,t={}){super("NavCube",e,t),e.navCube=this;try{this._navCubeScene=new As(e,{canvasId:t.canvasId,canvasElement:t.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1}catch(e){return void this.error(e)}const i=this._navCubeScene;i.clearLights(),new rs(i,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new rs(i,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new rs(i,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=i.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,i.edgeMaterial.edgeColor=[.2,.2,.2],i.edgeMaterial.edgeAlpha=.6,this._zUp=Boolean(e.camera.zUp);var s=this;this._synchCamera=function(){var t=p.rotationMat4c(-90*p.DEGTORAD,1,0,0),i=p.vec3(),r=p.vec3(),o=p.vec3();return function(){var n=e.camera.eye,a=e.camera.look,l=e.camera.up;i=p.mulVec3Scalar(p.normalizeVec3(p.subVec3(n,a,i)),5),s._zUp?(p.transformVec3(t,i,r),p.transformVec3(t,l,o),s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=p.transformVec3(t,i,r),s._navCubeCamera.up=p.transformPoint3(t,l,o)):(s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=i,s._navCubeCamera.up=l)}}(),this._cubeTextureCanvas=new id(e,t),this._cubeSampler=new ho(i,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:Ts,wrapT:Ts}),this._cubeMesh=new Vr(i,{geometry:new hs(i,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new fs(i,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=!1===t.shadowVisible?null:new Vr(i,{geometry:new hs(i,Ur({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new fs(i,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1}),this._onCameraMatrix=e.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=e.camera.on("worldAxis",(()=>{e.camera.zUp?(this._zUp=!0,this._cubeTextureCanvas.setZUp(),this._repaint(),this._synchCamera()):e.camera.yUp&&(this._zUp=!1,this._cubeTextureCanvas.setYUp(),this._repaint(),this._synchCamera())})),this._onCameraFOV=e.camera.perspective.on("fov",(e=>{this._synchProjection&&(this._navCubeCamera.perspective.fov=e)})),this._onCameraProjection=e.camera.on("projection",(e=>{this._synchProjection&&(this._navCubeCamera.projection="ortho"===e||"perspective"===e?e:"perspective")}));var r=-1;function o(e){var t=[0,0];if(e){for(var i=e.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t}var n,a,l=null,h=null,c=!1,u=!1,d=.5;s._navCubeCanvas.addEventListener("mouseenter",s._onMouseEnter=function(e){u=!0}),s._navCubeCanvas.addEventListener("mouseleave",s._onMouseLeave=function(e){u=!1}),s._navCubeCanvas.addEventListener("mousedown",s._onMouseDown=function(e){if(1===e.which){l=e.x,h=e.y,n=e.clientX,a=e.clientY;var t=o(e),s=i.pick({canvasPos:t});c=!!s}}),document.addEventListener("mouseup",s._onMouseUp=function(e){if(1===e.which&&(c=!1,null!==l)){var t=o(e),n=i.pick({canvasPos:t,pickSurface:!0});if(n&&n.uv){var a=s._cubeTextureCanvas.getArea(n.uv);if(a>=0&&(document.body.style.cursor="pointer",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),a>=0)){if(s._cubeTextureCanvas.setAreaHighlighted(a,!0),r=a,s._repaint(),e.x<l-3||e.x>l+3||e.y<h-3||e.y>h+3)return;var u=s._cubeTextureCanvas.getAreaDir(a);if(u){var d=s._cubeTextureCanvas.getAreaUp(a);f(u,d,(function(){r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),document.body.style.cursor="pointer",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),a>=0&&(s._cubeTextureCanvas.setAreaHighlighted(a,!1),r=-1,s._repaint())}))}}}}}),document.addEventListener("mousemove",s._onMouseMove=function(t){if(r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),1!==t.buttons||c){if(c){var l=t.clientX,h=t.clientY;return document.body.style.cursor="move",void function(t,i){var s=(t-n)*-d,r=(i-a)*-d;e.camera.orbitYaw(s),e.camera.orbitPitch(-r),n=t,a=i}(l,h)}if(u){var p=o(t),f=i.pick({canvasPos:p,pickSurface:!0});if(f){if(f.uv){document.body.style.cursor="pointer";var m=s._cubeTextureCanvas.getArea(f.uv);if(m===r)return;r>=0&&s._cubeTextureCanvas.setAreaHighlighted(r,!1),m>=0&&(s._cubeTextureCanvas.setAreaHighlighted(m,!0),s._repaint(),r=m)}}else document.body.style.cursor="default",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1)}}});var f=function(){var t=p.vec3();return function(i,r,o){var n=s._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,a=p.getAABB3Diag(n);p.getAABB3Center(n,t);var l=Math.abs(a/Math.tan(s._cameraFitFOV*p.DEGTORAD));e.cameraControl.pivotPos=t,s._cameraFly?e.cameraFlight.flyTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*a,fitFOV:s._cameraFitFOV,duration:s._cameraFlyDuration},o):e.cameraFlight.jumpTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*a,fitFOV:s._cameraFitFOV},o)}}();this._onUpdated=e.localeService.on("updated",(()=>{this._cubeTextureCanvas.clear(),this._repaint()})),this.setVisible(t.visible),this.setCameraFitFOV(t.cameraFitFOV),this.setCameraFly(t.cameraFly),this.setCameraFlyDuration(t.cameraFlyDuration),this.setFitVisible(t.fitVisible),this.setSynchProjection(t.synchProjection)}send(e,t){if("language"===e)this._cubeTextureCanvas.clear(),this._repaint()}_repaint(){const e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e}setVisible(e=!0){this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow&&(this._shadow.visible=e),this._navCubeCanvas.style.visibility=e?"visible":"hidden")}getVisible(){return!!this._navCubeCanvas&&this._cubeMesh.visible}setFitVisible(e=!1){this._fitVisible=e}getFitVisible(){return this._fitVisible}setCameraFly(e=!0){this._cameraFly=e}getCameraFly(){return this._cameraFly}setCameraFitFOV(e=45){this._cameraFitFOV=e}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(e=.5){this._cameraFlyDuration=e}getCameraFlyDuration(){return this._cameraFlyDuration}setSynchProjection(e=!1){this._synchProjection=e}getSynchProjection(){return this._synchProjection}destroy(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy()}}p.vec3();const rd=new Float64Array([0,0,1]),od=new Float64Array(4);class nd{constructor(e){this.id=null,this._viewer=e.viewer,this._visible=!1,this._pos=p.vec3(),this._origin=p.vec3(),this._rtcPos=p.vec3(),this._baseDir=p.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents()}_setSectionPlane(e){this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),e&&(this.id=e.id,this._setPos(e.pos),this._setDir(e.dir),this._sectionPlane=e,this._onSectionPlanePos=e.on("pos",(()=>{this._setPos(this._sectionPlane.pos)})),this._onSectionPlaneDir=e.on("dir",(()=>{this._ignoreNextSectionPlaneDirUpdate?this._ignoreNextSectionPlaneDirUpdate=!1:this._setDir(this._sectionPlane.dir)})))}get sectionPlane(){return this._sectionPlane}_setPos(e){this._pos.set(e),function(e,t,i){const s=Float32Array.from([e[0]])[0],r=e[0]-s,o=Float32Array.from([e[1]])[0],n=e[1]-o,a=Float32Array.from([e[2]])[0],l=e[2]-a;t[0]=s,t[1]=o,t[2]=a,i[0]=r,i[1]=n,i[2]=l}(this._pos,this._origin,this._rtcPos),this._rootNode.origin=this._origin,this._rootNode.position=this._rtcPos}_setDir(e){this._baseDir.set(e),this._rootNode.quaternion=p.vec3PairToQuaternion(rd,e,od)}_setSectionPlaneDir(e){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=e)}setVisible(e=!0){if(this._visible!==e){var t;for(t in this._visible=e,this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].visible=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].visible=e)}}getVisible(){return this._visible}setCulled(e){var t;for(t in this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].culled=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].culled=e)}_createNodes(){const e=!1,t=this._viewer.scene,i=.01;this._rootNode=new eo(t,{position:[0,0,0],scale:[5,5,5]});const s=this._rootNode,r={arrowHead:new hs(s,Ur({radiusTop:.001,radiusBottom:.07,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new hs(s,Ur({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),arrowHeadHandle:new hs(s,Ur({radiusTop:.09,radiusBottom:.09,radialSegments:8,heightSegments:1,height:.37,openEnded:!1})),curve:new hs(s,go({radius:.8,tube:i,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),curveHandle:new hs(s,go({radius:.8,tube:.06,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),hoop:new hs(s,go({radius:.8,tube:i,radialSegments:64,tubeSegments:8,arc:2*Math.PI})),axis:new hs(s,Ur({radiusTop:i,radiusBottom:i,radialSegments:20,heightSegments:1,height:1,openEnded:!1})),axisHandle:new hs(s,Ur({radiusTop:.08,radiusBottom:.08,radialSegments:20,heightSegments:1,height:1,openEnded:!1}))},o={pickable:new fs(s,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),red:new fs(s,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new gs(s,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6}),green:new fs(s,{diffuse:[0,1,0],emissive:[0,1,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightGreen:new gs(s,{edges:!1,fill:!0,fillColor:[0,1,0],fillAlpha:.6}),blue:new fs(s,{diffuse:[0,0,1],emissive:[0,0,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightBlue:new gs(s,{edges:!1,fill:!0,fillColor:[0,0,1],fillAlpha:.2}),center:new fs(s,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),highlightBall:new gs(s,{edges:!1,fill:!0,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1}),highlightPlane:new gs(s,{edges:!0,edgeWidth:3,fill:!1,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1})};this._displayMeshes={plane:s.addChild(new Vr(s,{geometry:new hs(s,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new fs(s,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new gs(s,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1]}),e),planeFrame:s.addChild(new Vr(s,{geometry:new hs(s,go({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new fs(s,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new gs(s,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45]}),e),xCurve:s.addChild(new Vr(s,{geometry:r.curve,material:o.red,matrix:function(){const e=p.rotationMat4v(90*p.DEGTORAD,[0,1,0],p.identityMat4()),t=p.rotationMat4v(270*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),xCurveHandle:s.addChild(new Vr(s,{geometry:r.curveHandle,material:o.pickable,matrix:function(){const e=p.rotationMat4v(90*p.DEGTORAD,[0,1,0],p.identityMat4()),t=p.rotationMat4v(270*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),xCurveArrow1:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.red,matrix:function(){const e=p.translateMat4c(0,-.07,-.8,p.identityMat4()),t=p.scaleMat4v([.6,.6,.6],p.identityMat4()),i=p.rotationMat4v(0*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(p.mulMat4(e,t,p.identityMat4()),i,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),xCurveArrow2:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.red,matrix:function(){const e=p.translateMat4c(0,-.8,-.07,p.identityMat4()),t=p.scaleMat4v([.6,.6,.6],p.identityMat4()),i=p.rotationMat4v(90*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(p.mulMat4(e,t,p.identityMat4()),i,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),yCurve:s.addChild(new Vr(s,{geometry:r.curve,material:o.green,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),yCurveHandle:s.addChild(new Vr(s,{geometry:r.curveHandle,material:o.pickable,rotation:[-90,0,0],pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),yCurveArrow1:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.green,matrix:function(){const e=p.translateMat4c(.07,0,-.8,p.identityMat4()),t=p.scaleMat4v([.6,.6,.6],p.identityMat4()),i=p.rotationMat4v(90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(p.mulMat4(e,t,p.identityMat4()),i,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),yCurveArrow2:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.green,matrix:function(){const e=p.translateMat4c(.8,0,-.07,p.identityMat4()),t=p.scaleMat4v([.6,.6,.6],p.identityMat4()),i=p.rotationMat4v(90*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(p.mulMat4(e,t,p.identityMat4()),i,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zCurve:s.addChild(new Vr(s,{geometry:r.curve,material:o.blue,matrix:p.rotationMat4v(180*p.DEGTORAD,[1,0,0],p.identityMat4()),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zCurveHandle:s.addChild(new Vr(s,{geometry:r.curveHandle,material:o.pickable,matrix:p.rotationMat4v(180*p.DEGTORAD,[1,0,0],p.identityMat4()),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zCurveCurveArrow1:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=p.translateMat4c(.8,-.07,0,p.identityMat4()),t=p.scaleMat4v([.6,.6,.6],p.identityMat4());return p.mulMat4(e,t,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zCurveArrow2:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=p.translateMat4c(.05,-.8,0,p.identityMat4()),t=p.scaleMat4v([.6,.6,.6],p.identityMat4()),i=p.rotationMat4v(90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(p.mulMat4(e,t,p.identityMat4()),i,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),center:s.addChild(new Vr(s,{geometry:new hs(s,Gr({radius:.05})),material:o.center,pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),xAxisArrow:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.red,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),xAxisArrowHandle:s.addChild(new Vr(s,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),xAxis:s.addChild(new Vr(s,{geometry:r.axis,material:o.red,matrix:function(){const e=p.translateMat4c(0,.5,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),xAxisHandle:s.addChild(new Vr(s,{geometry:r.axisHandle,material:o.pickable,matrix:function(){const e=p.translateMat4c(0,.5,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),yAxisArrow:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.green,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(180*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yAxisArrowHandle:s.addChild(new Vr(s,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(180*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,opacity:.2}),e),yShaft:s.addChild(new Vr(s,{geometry:r.axis,material:o.green,position:[0,-.5,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yShaftHandle:s.addChild(new Vr(s,{geometry:r.axisHandle,material:o.pickable,position:[0,-.5,0],pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrow:s.addChild(new Vr(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[.8,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrowHandle:s.addChild(new Vr(s,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[.8,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),e),zShaft:s.addChild(new Vr(s,{geometry:r.axis,material:o.blue,matrix:function(){const e=p.translateMat4c(0,.5,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1}),e),zAxisHandle:s.addChild(new Vr(s,{geometry:r.axisHandle,material:o.pickable,matrix:function(){const e=p.translateMat4c(0,.5,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),clippable:!1,pickable:!0,collidable:!0,visible:!1}),e)},this._affordanceMeshes={planeFrame:s.addChild(new Vr(s,{geometry:new hs(s,go({center:[0,0,0],radius:2,tube:i,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new fs(s,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new gs(s,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45]}),e),xHoop:s.addChild(new Vr(s,{geometry:r.hoop,material:o.red,highlighted:!0,highlightMaterial:o.highlightRed,matrix:function(){const e=p.rotationMat4v(90*p.DEGTORAD,[0,1,0],p.identityMat4()),t=p.rotationMat4v(270*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yHoop:s.addChild(new Vr(s,{geometry:r.hoop,material:o.green,highlighted:!0,highlightMaterial:o.highlightGreen,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zHoop:s.addChild(new Vr(s,{geometry:r.hoop,material:o.blue,highlighted:!0,highlightMaterial:o.highlightBlue,matrix:p.rotationMat4v(180*p.DEGTORAD,[1,0,0],p.identityMat4()),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),e),xAxisArrow:s.addChild(new Vr(s,{geometry:r.arrowHeadBig,material:o.red,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[0,0,1],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),yAxisArrow:s.addChild(new Vr(s,{geometry:r.arrowHeadBig,material:o.green,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(180*p.DEGTORAD,[1,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrow:s.addChild(new Vr(s,{geometry:r.arrowHeadBig,material:o.blue,matrix:function(){const e=p.translateMat4c(0,1.1,0,p.identityMat4()),t=p.rotationMat4v(-90*p.DEGTORAD,[.8,0,0],p.identityMat4());return p.mulMat4(t,e,p.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e)}}_bindEvents(){const e=this;var t=!1;const i=-1,s=0,r=1,o=2,n=3,a=4,l=5,h=this._rootNode;var c=null,u=null;const d=p.vec2(),f=p.vec3([1,0,0]),m=p.vec3([0,1,0]),g=p.vec3([0,0,1]),_=this._viewer.scene.canvas.canvas,v=this._viewer.camera,b=this._viewer.scene;{const e=p.vec3([0,0,0]);let t=-1;this._onCameraViewMatrix=b.camera.on("viewMatrix",(()=>{})),this._onCameraProjMatrix=b.camera.on("projMatrix",(()=>{})),this._onSceneTick=b.on("tick",(()=>{const i=Math.abs(p.lenVec3(p.subVec3(b.camera.eye,this._pos,e)));if(i!==t&&"perspective"===v.projection){const e=.07*(Math.tan(v.perspective.fov*p.DEGTORAD)*i);h.scale=[e,e,e],t=i}if("ortho"===v.projection){const e=v.ortho.scale/10;h.scale=[e,e,e],t=i}}))}const x=function(){const e=new Float64Array(2);return function(t){if(t){for(var i=t.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e}}(),y=function(){const t=p.mat4();return function(i,s){return p.quaternionToMat4(e._rootNode.quaternion,t),p.transformVec3(t,i,s),p.normalizeVec3(s),s}}();var P=function(){const e=p.vec3();return function(t){const i=Math.abs(t[0]);return i>Math.abs(t[1])&&i>Math.abs(t[2])?p.cross3Vec3(t,[0,1,0],e):p.cross3Vec3(t,[1,0,0],e),p.cross3Vec3(e,t,e),p.normalizeVec3(e),e}}();const w=function(){const t=p.vec3(),i=p.vec3(),s=p.vec4();return function(r,o,n){y(r,s);const a=P(s,o,n);C(o,a,t),C(n,a,i),p.subVec3(i,t);const l=p.dotVec3(i,s);e._pos[0]+=s[0]*l,e._pos[1]+=s[1]*l,e._pos[2]+=s[2]*l,e._rootNode.position=e._pos,e._sectionPlane&&(e._sectionPlane.pos=e._pos)}}();var M=function(){const t=p.vec4(),i=p.vec4(),s=p.vec4(),r=p.vec4();return function(o,n,a){y(o,r);if(!(C(n,r,t)&&C(a,r,i))){const e=P(r,n,a);C(n,e,t,1),C(a,e,i,1);var l=p.dotVec3(t,r);t[0]-=l*r[0],t[1]-=l*r[1],t[2]-=l*r[2],l=p.dotVec3(i,r),i[0]-=l*r[0],i[1]-=l*r[1],i[2]-=l*r[2]}p.normalizeVec3(t),p.normalizeVec3(i),l=p.dotVec3(t,i),l=p.clamp(l,-1,1);var h=Math.acos(l)*p.RADTODEG;p.cross3Vec3(t,i,s),p.dotVec3(s,r)<0&&(h=-h),e._rootNode.rotate(o,h),E()}}(),C=function(){const t=p.vec4([0,0,0,1]),i=p.mat4();return function(s,r,o,n){n=n||0,t[0]=s[0]/_.width*2-1,t[1]=-(s[1]/_.height*2-1),t[2]=0,t[3]=1,p.mulMat4(v.projMatrix,v.viewMatrix,i),p.inverseMat4(i),p.transformVec4(i,t,t),p.mulVec4Scalar(t,1/t[3]);var a=v.eye;p.subVec4(t,a,t);const l=e._sectionPlane.pos;var h=-p.dotVec3(l,r)-n,c=p.dotVec3(r,t);if(Math.abs(c)>.005){var u=-(p.dotVec3(r,a)+h)/c;return p.mulVec3Scalar(t,u,o),p.addVec3(o,a),p.subVec3(o,l,o),!0}return!1}}();const E=function(){const t=p.vec3(),i=p.mat4();return function(){e.sectionPlane&&(p.quaternionToMat4(h.quaternion,i),p.transformVec3(i,[0,0,1],t),e._setSectionPlaneDir(t))}}();var A,D=!1;this._onCameraControlHover=this._viewer.cameraControl.on("hoverEnter",(e=>{if(!this._visible)return;if(D)return;var h;t=!1,A&&(A.visible=!1);switch(e.entity.id){case this._displayMeshes.xAxisArrowHandle.id:case this._displayMeshes.xAxisHandle.id:h=this._affordanceMeshes.xAxisArrow,c=s;break;case this._displayMeshes.yAxisArrowHandle.id:case this._displayMeshes.yShaftHandle.id:h=this._affordanceMeshes.yAxisArrow,c=r;break;case this._displayMeshes.zAxisArrowHandle.id:case this._displayMeshes.zAxisHandle.id:h=this._affordanceMeshes.zAxisArrow,c=o;break;case this._displayMeshes.xCurveHandle.id:h=this._affordanceMeshes.xHoop,c=n;break;case this._displayMeshes.yCurveHandle.id:h=this._affordanceMeshes.yHoop,c=a;break;case this._displayMeshes.zCurveHandle.id:h=this._affordanceMeshes.zHoop,c=l;break;default:return void(c=i)}h&&(h.visible=!0),A=h,t=!0})),this._onCameraControlHoverLeave=this._viewer.cameraControl.on("hoverOut",(e=>{this._visible&&(A&&(A.visible=!1),A=null,c=i)})),_.addEventListener("mousedown",this._canvasMouseDownListener=e=>{if(e.preventDefault(),this._visible&&t&&(this._viewer.cameraControl.pointerEnabled=!1,1===e.which)){D=!0;var i=x(e);u=c,d[0]=i[0],d[1]=i[1]}}),_.addEventListener("mousemove",this._canvasMouseMoveListener=e=>{if(!this._visible)return;if(!D)return;var t=x(e);const i=t[0],h=t[1];switch(u){case s:w(f,d,t);break;case r:w(m,d,t);break;case o:w(g,d,t);break;case n:M(f,d,t);break;case a:M(m,d,t);break;case l:M(g,d,t)}d[0]=i,d[1]=h}),_.addEventListener("mouseup",this._canvasMouseUpListener=e=>{this._visible&&(this._viewer.cameraControl.pointerEnabled=!0,D&&(e.which,D=!1,t=!1))}),_.addEventListener("wheel",this._canvasWheelListener=e=>{if(this._visible)Math.max(-1,Math.min(1,40*-e.deltaY))})}_destroy(){this._unbindEvents(),this._destroyNodes()}_unbindEvents(){const e=this._viewer,t=e.scene,i=t.canvas.canvas,s=e.camera,r=e.cameraControl;t.off(this._onSceneTick),i.removeEventListener("mousedown",this._canvasMouseDownListener),i.removeEventListener("mousemove",this._canvasMouseMoveListener),i.removeEventListener("mouseup",this._canvasMouseUpListener),i.removeEventListener("wheel",this._canvasWheelListener),s.off(this._onCameraViewMatrix),s.off(this._onCameraProjMatrix),r.off(this._onCameraControlHover),r.off(this._onCameraControlHoverLeave)}_destroyNodes(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={}}}class ad{constructor(e,t,i){this.id=i.id,this._sectionPlane=i,this._mesh=new Vr(t,{id:i.id,geometry:new hs(t,cs({xSize:.5,ySize:.5,zSize:.001})),material:new fs(t,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new vs(t,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new gs(t,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new gs(t,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});{const e=p.vec3([0,0,0]),t=p.vec3(),i=p.vec3([0,0,1]),s=p.vec4(4),r=p.vec3(),o=()=>{const o=this._sectionPlane.scene.center,n=[-this._sectionPlane.dir[0],-this._sectionPlane.dir[1],-this._sectionPlane.dir[2]];p.subVec3(o,this._sectionPlane.pos,e);const a=-p.dotVec3(n,e);p.normalizeVec3(n),p.mulVec3Scalar(n,a,t);const l=p.vec3PairToQuaternion(i,this._sectionPlane.dir,s);r[0]=.1*t[0],r[1]=.1*t[1],r[2]=.1*t[2],this._mesh.quaternion=l,this._mesh.position=r};this._onSectionPlanePos=this._sectionPlane.on("pos",o),this._onSectionPlaneDir=this._sectionPlane.on("dir",o)}this._highlighted=!1,this._selected=!1}setHighlighted(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0]}getHighlighted(){return this._highlighted}setSelected(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1}getSelected(){return this._selected}destroy(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}class ld{constructor(e,t){if(!(t.onHoverEnterPlane&&t.onHoverLeavePlane&&t.onClickedNothing&&t.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=e,this._viewer=e.viewer,this._onHoverEnterPlane=t.onHoverEnterPlane,this._onHoverLeavePlane=t.onHoverLeavePlane,this._onClickedNothing=t.onClickedNothing,this._onClickedPlane=t.onClickedPlane,this._visible=!0,this._planes={},this._canvas=t.overviewCanvas,this._scene=new As(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new rs(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new rs(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new rs(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;{const e=this._scene.camera,t=p.rotationMat4c(-90*p.DEGTORAD,1,0,0),i=p.vec3(),s=p.vec3(),r=p.vec3();this._synchCamera=()=>{const o=this._viewer.camera.eye,n=this._viewer.camera.look,a=this._viewer.camera.up;p.mulVec3Scalar(p.normalizeVec3(p.subVec3(o,n,i)),7),this._zUp?(p.transformVec3(t,i,s),p.transformVec3(t,a,r),e.look=[0,0,0],e.eye=p.transformVec3(t,i,s),e.up=p.transformPoint3(t,a,r)):(e.look=[0,0,0],e.eye=i,e.up=a)}}this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(e=>{this._scene.camera.perspective.fov=e}));var i=null;this._onInputMouseMove=this._scene.input.on("mousemove",(e=>{const t=this._scene.pick({canvasPos:e});if(t){if(!i||t.entity.id!==i.id){if(i){this._planes[i.id]&&this._onHoverLeavePlane(i.id)}i=t.entity;this._planes[i.id]&&this._onHoverEnterPlane(i.id)}}else i&&(this._onHoverLeavePlane(i.id),i=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=()=>{if(i){this._planes[i.id]&&this._onClickedPlane(i.id)}else this._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=()=>{i&&(this._onHoverLeavePlane(i.id),i=null)}),this.setVisible(t.overviewVisible)}addSectionPlane(e){this._planes[e.id]=new ad(this,this._scene,e)}setPlaneHighlighted(e,t){const i=this._planes[e];i&&i.setHighlighted(t)}setPlaneSelected(e,t){const i=this._planes[e];i&&i.setSelected(t)}removeSectionPlane(e){const t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id])}setVisible(e=!0){this._visible=e,this._canvas.style.visibility=e?"visible":"hidden"}getVisible(){return this._visible}destroy(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}const hd=p.AABB3(),cd=p.vec3();class ud extends a{constructor(e,t={}){if(super("SectionPlanes",e),this._freeControls=[],this._sectionPlanes=e.scene.sectionPlanes,this._controls={},this._shownControlId=null,null!==t.overviewCanvasId&&void 0!==t.overviewCanvasId){const e=document.getElementById(t.overviewCanvasId);e?this._overview=new ld(this,{overviewCanvas:e,visible:t.overviewVisible,onHoverEnterPlane:e=>{this._overview.setPlaneHighlighted(e,!0)},onHoverLeavePlane:e=>{this._overview.setPlaneHighlighted(e,!1)},onClickedPlane:e=>{if(this.getShownControl()===e)return void this.hideControl();this.showControl(e);const t=this.sectionPlanes[e].pos;hd.set(this.viewer.scene.aabb),p.getAABB3Center(hd,cd),hd[0]+=t[0]-cd[0],hd[1]+=t[1]-cd[1],hd[2]+=t[2]-cd[2],hd[3]+=t[0]-cd[0],hd[4]+=t[1]-cd[1],hd[5]+=t[2]-cd[2],this.viewer.cameraFlight.flyTo({aabb:hd,fitFOV:65})},onClickedNothing:()=>{this.hideControl()}}):this.warn("Can't find overview canvas: '"+t.overviewCanvasId+"' - will create plugin without overview")}this._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(e=>{this._sectionPlaneCreated(e)}))}setOverviewVisible(e){this._overview&&this._overview.setVisible(e)}getOverviewVisible(){if(this._overview)return this._overview.getVisible()}get sectionPlanes(){return this._sectionPlanes}createSectionPlane(e={}){void 0!==e.id&&null!==e.id&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);return new Wr(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0})}_sectionPlaneCreated(e){const t=this._freeControls.length>0?this._freeControls.pop():new nd(this);t._setSectionPlane(e),t.setVisible(!1),this._controls[e.id]=t,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",(()=>{this._sectionPlaneDestroyed(e)}))}flipSectionPlanes(){const e=this.viewer.scene.sectionPlanes;for(let t in e){e[t].flipDir()}}showControl(e){const t=this._controls[e];t?(this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e):this.error("Control not found: "+e)}getShownControl(){return this._shownControlId}hideControl(){for(var e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null}destroySectionPlane(e){var t=this.viewer.scene.sectionPlanes[e];t?(this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+e)}_sectionPlaneDestroyed(e){this._overview&&this._overview.removeSectionPlane(e);const t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t))}clear(){const e=Object.keys(this._sectionPlanes);for(var t=0,i=e.length;t<i;t++)this.destroySectionPlane(e[t])}send(e,t){switch(e){case"snapshotStarting":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!0);break;case"snapshotFinished":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!1);break;case"clearSectionPlanes":this.clear()}}destroy(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),super.destroy()}_destroyFreeControls(){for(var e=this._freeControls.pop();e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}p.vec3(),p.vec3(),p.mat4();const dd=[];class pd extends a{constructor(e,t={}){if(super("TreeViewPlugin",e),this.errors=[],this.valid=!0,t.containerElement){for(let e=0;;e++)if(!dd[e]){dd[e]=this,this._index=e,this._id=`tree-${e}`;break}if(this._containerElement=t.containerElement,this._metaModels={},this._autoAddModels=!1!==t.autoAddModels,this._autoExpandDepth=t.autoExpandDepth||0,this._sortNodes=!1!==t.sortNodes,this._pruneEmptyNodes=!1!==t.pruneEmptyNodes,this._viewer=e,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._rootName=t.rootName,this._sortNodes=t.sortNodes,this._pruneEmptyNodes=t.pruneEmptyNodes,this._showListItemElementId=null,this._containerElement.oncontextmenu=e=>{e.preventDefault()},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",(e=>{if(this._muteSceneEvents)return;const t=e.id,i=this._objectNodes[t];if(!i)return;const s=e.visible;if(!(s!==i.checked))return;this._muteTreeEvents=!0,i.checked=s,s?i.numVisibleEntities++:i.numVisibleEntities--;const r=document.getElementById(`checkbox-${i.nodeId}`);r&&(r.checked=s);let o=i.parent;for(;o;){o.checked=s,s?o.numVisibleEntities++:o.numVisibleEntities--;const e=document.getElementById(`checkbox-${o.nodeId}`);if(e){const t=o.numVisibleEntities>0;t!==e.checked&&(e.checked=t)}o=o.parent}this._muteTreeEvents=!1})),this._onObjectXrayed=this._viewer.scene.on("objectXRayed",(e=>{if(this._muteSceneEvents)return;const t=e.id,i=this._objectNodes[t];if(!i)return;this._muteTreeEvents=!0;const s=e.xrayed;if(!(s!==i.xrayed))return;i.xrayed=s;const r=i.nodeId,o=document.getElementById(r);null!==o&&(s?o.classList.add("xrayed-node"):o.classList.remove("xrayed-node")),this._muteTreeEvents=!1})),this._switchExpandHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._expandSwitchElement(t)},this._switchCollapseHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._collapseSwitchElement(t)},this._checkboxChangeHandler=e=>{if(this._muteTreeEvents)return;this._muteSceneEvents=!0;const t=e.target,i=t.checked,s=t.id.replace("checkbox-",""),r=this._nodeNodes[s],o=this._viewer.scene.objects;let n=0;this._withNodeTree(r,(e=>{const t=e.objectId,s=`checkbox-${e.nodeId}`,r=o[t],a=0===e.children.length;e.numVisibleEntities=i?e.numEntities:0,a&&i!==e.checked&&n++,e.checked=i;const l=document.getElementById(s);l&&(l.checked=i),r&&(r.visible=i)}));let a=r.parent;for(;a;){a.checked=i;const e=document.getElementById(`checkbox-${a.nodeId}`);i?a.numVisibleEntities+=n:a.numVisibleEntities-=n;const t=a.numVisibleEntities>0;t!==e.checked&&(e.checked=t),a=a.parent}this._muteSceneEvents=!1},this._hierarchy=t.hierarchy||"containment",this._autoExpandDepth=t.autoExpandDepth||0,this._autoAddModels){const e=Object.keys(this.viewer.metaScene.metaModels);for(let t=0,i=e.length;t<i;t++){const i=e[t];this.addModel(i)}this.viewer.scene.on("modelLoaded",(e=>{this.viewer.metaScene.metaModels[e]&&this.addModel(e)}))}this.hierarchy=t.hierarchy}else this.error("Config expected: containerElement")}set hierarchy(e){"containment"!==(e=e||"containment")&&"storeys"!==e&&"types"!==e&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy!==e&&(this._hierarchy=e,this._createNodes())}get hierarchy(){return this._hierarchy}addModel(e,t={}){if(!this._containerElement)return;const i=this.viewer.scene.models[e];if(!i)throw"Model not found: "+e;const s=this.viewer.metaScene.metaModels[e];s?this._metaModels[e]?this.warn("Model already added: "+e):(this._metaModels[e]=s,i.on("destroyed",(()=>{this.removeModel(i.id)})),this._createNodes()):this.error("MetaModel not found: "+e)}removeModel(e){if(!this._containerElement)return;this._metaModels[e]&&(delete this._metaModels[e],this._createNodes())}showNode(e){this._showListItemElementId&&this.unShowNode();const t=this._objectNodes[e];if(!t)return;const i=t.nodeId,s="switch-"+i,r=document.getElementById(s);if(r)return this._expandSwitchElement(r),void r.scrollIntoView();const o=[];o.unshift(t);let n=t.parent;for(;n;)o.unshift(n),n=n.parent;for(let e=0,t=o.length;e<t;e++){const t="switch-"+o[e].nodeId,i=document.getElementById(t);i&&this._expandSwitchElement(i)}const a=i,l=document.getElementById(a);l.scrollIntoView({block:"center"}),l.classList.add("highlighted-node"),this._showListItemElementId=a}unShowNode(){if(!this._showListItemElementId)return;const e=document.getElementById(this._showListItemElementId);e?(e.classList.remove("highlighted-node"),this._showListItemElementId=null):this._showListItemElementId=null}expandToDepth(e){this.collapse();const t=(i,s)=>{if(s===e)return;const r="switch-"+i.nodeId,o=document.getElementById(r);if(o){this._expandSwitchElement(o);const e=i.children;for(var n=0,a=e.length;n<a;n++){const i=e[n];t(i,s+1)}}};for(let e=0,i=this._rootNodes.length;e<i;e++){const i=this._rootNodes[e];t(i,0)}}collapse(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e].objectId;this._collapseNode(t)}}withNodeTree(e,t){t(e);const i=e.children;if(i)for(let e=0,s=i.length;e<s;e++)this.withNodeTree(i[e],t)}destroy(){this._containerElement&&(this._metaModels={},this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0),delete dd[this._index],super.destroy())}_createNodes(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._validate(),this.valid||"storeys"!==this._hierarchy?this._createEnabledNodes():this._createDisabledNodes()}_validate(){if(this.errors=[],"storeys"===this._hierarchy)this.valid=this._validateMetaModelForStoreysHierarchy();else this.valid=this._rootNodes.length>0;return this.valid}_validateMetaModelForStoreysHierarchy(e=0,t,i){return!0}_createEnabledNodes(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),0===this._rootNodes.length&&this.error("Failed to build storeys hierarchy");break;case"types":this._createTypesNodes();break;default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)}_createDisabledNodes(){const e=document.createElement("ul");this._rootElement=e,this._containerElement.appendChild(e);const t=this._viewer.metaScene.rootMetaObjects;for(let i in t){const s=t[i],r=s.type,o=s.name,n=o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r,a=document.createElement("li");e.appendChild(a);const l=document.createElement("a");l.href="#",l.textContent="!",l.classList.add("warn"),l.classList.add("warning"),a.appendChild(l);const h=document.createElement("span");h.textContent=n,a.appendChild(h)}}_findEmptyNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._findEmptyNodes2(e[t])}_findEmptyNodes2(e,t=0){const i=this.viewer.scene,s=e.children,r=e.id,o=i.objects[r];if(e._countEntities=0,o&&e._countEntities++,s)for(let t=0,i=s.length;t<i;t++){const i=s[t];i._countEntities=this._findEmptyNodes2(i),e._countEntities+=i._countEntities}return e._countEntities}_createStoreysNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createStoreysNodes2(e[t],null,null,null)}_createStoreysNodes2(e,t,i,s){if(this._pruneEmptyNodes&&0===e._countEntities)return;const r=e.type,o=e.name,n=e.children,a=e.id;if("IfcBuilding"===r)t={nodeId:`${this._id}-${a}`,objectId:a,title:this._rootName||(o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r),type:r,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t;else if("IfcBuildingStorey"===r){if(!t)return void this.error("Failed to build storeys hierarchy for model '"+this.metaModel.id+"' - model does not have an IfcBuilding object, or is not an IFC model");i={nodeId:`${this._id}-${a}`,objectId:a,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r,type:r,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t.children.push(i),this._objectNodes[i.objectId]=i,this._nodeNodes[i.nodeId]=i,s={}}else if(i){if(this._viewer.scene.objects[a]){let e=(s=s||{})[r];e||(e={nodeId:`${this._id}-${i.objectId}-${r}`,objectId:`${i.objectId}-${r}`,title:r,type:r,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},i.children.push(e),this._objectNodes[e.objectId]=e,this._nodeNodes[e.nodeId]=e,s[r]=e);const t={nodeId:`${this._id}-${a}`,objectId:a,title:o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r,type:r,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};e.children.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t}}if(n)for(let e=0,r=n.length;e<r;e++){const r=n[e];this._createStoreysNodes2(r,t,i,s)}}_createTypesNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createTypesNodes2(e[t],null,null)}_createTypesNodes2(e,t,i){if(this._pruneEmptyNodes&&0===e._countEntities)return;const s=e.type,r=e.name,o=e.children,n=e.id;if(e.parent){if(t){if(this._viewer.scene.objects[n]){let e=i[s];e||(e={nodeId:`${this._id}-${t.objectId}-${s}`,objectId:`${t.objectId}-${s}`,title:s,type:s,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t.children.push(e),this._objectNodes[e.objectId]=e,this._nodeNodes[e.nodeId]=e,i[s]=e);const o={nodeId:`${this._id}-${n}`,objectId:n,title:r&&""!==r&&"Default"!==r?r:s,type:s,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};e.children.push(o),this._objectNodes[o.objectId]=o,this._nodeNodes[o.nodeId]=o}}}else t={nodeId:`${this._id}-${n}`,objectId:n,title:this._rootName||(r&&""!==r&&"Undefined"!==r&&"Default"!==r?r:s),type:s,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t,i={};if(o)for(let e=0,s=o.length;e<s;e++){const s=o[e];this._createTypesNodes2(s,t,i)}}_createContainmentNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createContainmentNodes2(e[t],null)}_createContainmentNodes2(e,t){if(this._pruneEmptyNodes&&0===e._countEntities)return;const i=e.type,s=e.name||i,r=e.children,o=e.id,n={nodeId:`${this._id}-${o}`,objectId:o,title:t?s&&""!==s&&"Undefined"!==s&&"Default"!==s?s:i:this._rootName||s,type:i,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};if(t?t.children.push(n):this._rootNodes.push(n),this._objectNodes[n.objectId]=n,this._nodeNodes[n.nodeId]=n,r)for(let e=0,t=r.length;e<t;e++){const t=r[e];this._createContainmentNodes2(t,n)}}_doSortNodes(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e];this._sortChildren(t)}}_sortChildren(e){const t=e.children;if(t&&0!==t.length){"storeys"===this._hierarchy&&"IfcBuilding"===e.type?t.sort(this._getSpatialSortFunc()):t.sort(this._alphaSortFunc);for(let e=0,i=t.length;e<i;e++){const i=t[e];this._sortChildren(i)}}}_getSpatialSortFunc(){const e=this.viewer,t=e.scene,i=t.camera,s=e.metaScene;return this._spatialSortFunc||(this._spatialSortFunc=(e,r)=>{e.aabb&&r.aabb||(e.aabb||(e.aabb=t.getAABB(s.getObjectIDsInSubtree(e.objectId))),r.aabb||(r.aabb=t.getAABB(s.getObjectIDsInSubtree(r.objectId))));let o=0;return o=i.xUp?0:i.yUp?1:2,e.aabb[o]>r.aabb[o]?-1:e.aabb[o]<r.aabb[o]?1:0})}_alphaSortFunc(e,t){const i=e.title.toUpperCase(),s=t.title.toUpperCase();return i<s?-1:i>s?1:0}_synchNodesToEntities(){const e=Object.keys(this.viewer.metaScene.metaObjects),t=this._viewer.metaScene.metaObjects,i=this._viewer.scene.objects;for(let s=0,r=e.length;s<r;s++){const r=e[s];if(t[r]){const e=this._objectNodes[r];if(e){const t=i[r];if(t){const i=t.visible;e.numEntities=1,e.xrayed=t.xrayed,i?(e.numVisibleEntities=1,e.checked=!0):(e.numVisibleEntities=0,e.checked=!1);let s=e.parent;for(;s;)s.numEntities++,i&&(s.numVisibleEntities++,s.checked=!0),s=s.parent}}}}}_withNodeTree(e,t){t(e);const i=e.children;if(i)for(let e=0,s=i.length;e<s;e++)this._withNodeTree(i[e],t)}_createTrees(){if(0===this._rootNodes.length)return;const e=this._rootNodes.map((e=>this._createNodeElement(e))),t=document.createElement("ul");e.forEach((e=>{t.appendChild(e)})),this._containerElement.appendChild(t),this._rootElement=t}_createNodeElement(e){const t=document.createElement("li"),i=e.nodeId;if(e.xrayed&&t.classList.add("xrayed-node"),t.id=i,e.children.length>0){const e="switch-"+i,s=document.createElement("a");s.href="#",s.id=e,s.textContent="+",s.classList.add("plus"),s.addEventListener("click",this._switchExpandHandler),t.appendChild(s)}const s=document.createElement("input");s.id=`checkbox-${i}`,s.type="checkbox",s.checked=e.checked,s.style["pointer-events"]="all",s.addEventListener("change",this._checkboxChangeHandler),t.appendChild(s);const r=document.createElement("span");return r.textContent=e.title,t.appendChild(r),r.oncontextmenu=t=>{this.fire("contextmenu",{event:t,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),t.preventDefault()},r.onclick=t=>{this.fire("nodeTitleClicked",{event:t,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),t.preventDefault()},t}_expandSwitchElement(e){const t=e.parentElement;if(t.getElementsByTagName("li")[0])return;const i=t.id,s=this._nodeNodes[i].children.map((e=>this._createNodeElement(e))),r=document.createElement("ul");s.forEach((e=>{r.appendChild(e)})),t.appendChild(r),e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",this._switchExpandHandler),e.addEventListener("click",this._switchCollapseHandler)}_collapseNode(e){const t="switch-"+e,i=document.getElementById(t);this._collapseSwitchElement(i)}_collapseSwitchElement(e){if(!e)return;const t=e.parentElement;if(!t)return;const i=t.querySelector("ul");i&&(t.removeChild(i),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",this._switchCollapseHandler),e.addEventListener("click",this._switchExpandHandler))}}class fd{constructor(){}getMetaModel(e,t,i){v.loadJSON(e,(e=>{t(e)}),(function(e){i(e)}))}getXKT(e,t,i){var s=()=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),i=new Uint8Array(e);for(var n=0;n<o.length;n++)i[n]=o.charCodeAt(n);t(e)}catch(e){i(e)}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("getXKT error : "+s.response))},s.send(null)}}}
/*! pako 2.0.4 https://github.com/nodeca/pako @license (MIT AND Zlib) */!function(t,i){"object"==typeof e&&"undefined"!=typeof module?i(e):"function"==typeof define&&define.amd?define(["exports"],i):i((t="undefined"!=typeof globalThis?globalThis:t||self).pako={})}(void 0,(function(e){function t(e){let t=e.length;for(;--t>=0;)e[t]=0}const i=256,s=286,r=30,o=15,n=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),a=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),l=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),h=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),c=new Array(576);t(c);const u=new Array(60);t(u);const d=new Array(512);t(d);const p=new Array(256);t(p);const f=new Array(29);t(f);const m=new Array(r);function g(e,t,i,s,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=s,this.max_length=r,this.has_stree=e&&e.length}let _,v,b;function x(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}t(m);const y=e=>e<256?d[e]:d[256+(e>>>7)],P=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},w=(e,t,i)=>{e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,P(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},M=(e,t,i)=>{w(e,i[2*t],i[2*t+1])},C=(e,t)=>{let i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1},E=(e,t,i)=>{const s=new Array(16);let r,n,a=0;for(r=1;r<=o;r++)s[r]=a=a+i[r-1]<<1;for(n=0;n<=t;n++){let t=e[2*n+1];0!==t&&(e[2*n]=C(s[t]++,t))}},A=e=>{let t;for(t=0;t<s;t++)e.dyn_ltree[2*t]=0;for(t=0;t<r;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0},D=e=>{e.bi_valid>8?P(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},T=(e,t,i,s)=>{const r=2*t,o=2*i;return e[r]<e[o]||e[r]===e[o]&&s[t]<=s[i]},S=(e,t,i)=>{const s=e.heap[i];let r=i<<1;for(;r<=e.heap_len&&(r<e.heap_len&&T(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!T(t,s,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=s},I=(e,t,s)=>{let r,o,l,h,c=0;if(0!==e.last_lit)do{r=e.pending_buf[e.d_buf+2*c]<<8|e.pending_buf[e.d_buf+2*c+1],o=e.pending_buf[e.l_buf+c],c++,0===r?M(e,o,t):(l=p[o],M(e,l+i+1,t),h=n[l],0!==h&&(o-=f[l],w(e,o,h)),r--,l=y(r),M(e,l,s),h=a[l],0!==h&&(r-=m[l],w(e,r,h)))}while(c<e.last_lit);M(e,256,t)},F=(e,t)=>{const i=t.dyn_tree,s=t.stat_desc.static_tree,r=t.stat_desc.has_stree,n=t.stat_desc.elems;let a,l,h,c=-1;for(e.heap_len=0,e.heap_max=573,a=0;a<n;a++)0!==i[2*a]?(e.heap[++e.heap_len]=c=a,e.depth[a]=0):i[2*a+1]=0;for(;e.heap_len<2;)h=e.heap[++e.heap_len]=c<2?++c:0,i[2*h]=1,e.depth[h]=0,e.opt_len--,r&&(e.static_len-=s[2*h+1]);for(t.max_code=c,a=e.heap_len>>1;a>=1;a--)S(e,i,a);h=n;do{a=e.heap[1],e.heap[1]=e.heap[e.heap_len--],S(e,i,1),l=e.heap[1],e.heap[--e.heap_max]=a,e.heap[--e.heap_max]=l,i[2*h]=i[2*a]+i[2*l],e.depth[h]=(e.depth[a]>=e.depth[l]?e.depth[a]:e.depth[l])+1,i[2*a+1]=i[2*l+1]=h,e.heap[1]=h++,S(e,i,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const i=t.dyn_tree,s=t.max_code,r=t.stat_desc.static_tree,n=t.stat_desc.has_stree,a=t.stat_desc.extra_bits,l=t.stat_desc.extra_base,h=t.stat_desc.max_length;let c,u,d,p,f,m,g=0;for(p=0;p<=o;p++)e.bl_count[p]=0;for(i[2*e.heap[e.heap_max]+1]=0,c=e.heap_max+1;c<573;c++)u=e.heap[c],p=i[2*i[2*u+1]+1]+1,p>h&&(p=h,g++),i[2*u+1]=p,u>s||(e.bl_count[p]++,f=0,u>=l&&(f=a[u-l]),m=i[2*u],e.opt_len+=m*(p+f),n&&(e.static_len+=m*(r[2*u+1]+f)));if(0!==g){do{for(p=h-1;0===e.bl_count[p];)p--;e.bl_count[p]--,e.bl_count[p+1]+=2,e.bl_count[h]--,g-=2}while(g>0);for(p=h;0!==p;p--)for(u=e.bl_count[p];0!==u;)d=e.heap[--c],d>s||(i[2*d+1]!==p&&(e.opt_len+=(p-i[2*d+1])*i[2*d],i[2*d+1]=p),u--)}})(e,t),E(i,c,e.bl_count)},L=(e,t,i)=>{let s,r,o=-1,n=t[1],a=0,l=7,h=4;for(0===n&&(l=138,h=3),t[2*(i+1)+1]=65535,s=0;s<=i;s++)r=n,n=t[2*(s+1)+1],++a<l&&r===n||(a<h?e.bl_tree[2*r]+=a:0!==r?(r!==o&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,o=r,0===n?(l=138,h=3):r===n?(l=6,h=3):(l=7,h=4))},B=(e,t,i)=>{let s,r,o=-1,n=t[1],a=0,l=7,h=4;for(0===n&&(l=138,h=3),s=0;s<=i;s++)if(r=n,n=t[2*(s+1)+1],!(++a<l&&r===n)){if(a<h)do{M(e,r,e.bl_tree)}while(0!=--a);else 0!==r?(r!==o&&(M(e,r,e.bl_tree),a--),M(e,16,e.bl_tree),w(e,a-3,2)):a<=10?(M(e,17,e.bl_tree),w(e,a-3,3)):(M(e,18,e.bl_tree),w(e,a-11,7));a=0,o=r,0===n?(l=138,h=3):r===n?(l=6,h=3):(l=7,h=4)}};let R=!1;const k=(e,t,i,s)=>{w(e,0+(s?1:0),3),((e,t,i,s)=>{D(e),s&&(P(e,i),P(e,~i)),e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i})(e,t,i,!0)};var O=e=>{R||((()=>{let e,t,i,h,x;const y=new Array(16);for(i=0,h=0;h<28;h++)for(f[h]=i,e=0;e<1<<n[h];e++)p[i++]=h;for(p[i-1]=h,x=0,h=0;h<16;h++)for(m[h]=x,e=0;e<1<<a[h];e++)d[x++]=h;for(x>>=7;h<r;h++)for(m[h]=x<<7,e=0;e<1<<a[h]-7;e++)d[256+x++]=h;for(t=0;t<=o;t++)y[t]=0;for(e=0;e<=143;)c[2*e+1]=8,e++,y[8]++;for(;e<=255;)c[2*e+1]=9,e++,y[9]++;for(;e<=279;)c[2*e+1]=7,e++,y[7]++;for(;e<=287;)c[2*e+1]=8,e++,y[8]++;for(E(c,287,y),e=0;e<r;e++)u[2*e+1]=5,u[2*e]=C(e,5);_=new g(c,n,257,s,o),v=new g(u,a,0,r,o),b=new g(new Array(0),l,0,19,7)})(),R=!0),e.l_desc=new x(e.dyn_ltree,_),e.d_desc=new x(e.dyn_dtree,v),e.bl_desc=new x(e.bl_tree,b),e.bi_buf=0,e.bi_valid=0,A(e)},N=(e,t,s,r)=>{let o,n,a=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,s=4093624447;for(t=0;t<=31;t++,s>>>=1)if(1&s&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<i;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),F(e,e.l_desc),F(e,e.d_desc),a=(e=>{let t;for(L(e,e.dyn_ltree,e.l_desc.max_code),L(e,e.dyn_dtree,e.d_desc.max_code),F(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*h[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),o=e.opt_len+3+7>>>3,n=e.static_len+3+7>>>3,n<=o&&(o=n)):o=n=s+5,s+4<=o&&-1!==t?k(e,t,s,r):4===e.strategy||n===o?(w(e,2+(r?1:0),3),I(e,c,u)):(w(e,4+(r?1:0),3),((e,t,i,s)=>{let r;for(w(e,t-257,5),w(e,i-1,5),w(e,s-4,4),r=0;r<s;r++)w(e,e.bl_tree[2*h[r]+1],3);B(e,e.dyn_ltree,t-1),B(e,e.dyn_dtree,i-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),I(e,e.dyn_ltree,e.dyn_dtree)),A(e),r&&D(e)},j=(e,t,s)=>(e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&s,e.last_lit++,0===t?e.dyn_ltree[2*s]++:(e.matches++,t--,e.dyn_ltree[2*(p[s]+i+1)]++,e.dyn_dtree[2*y(t)]++),e.last_lit===e.lit_bufsize-1),V=e=>{w(e,2,3),M(e,256,c),(e=>{16===e.bi_valid?(P(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)},z={_tr_init:O,_tr_stored_block:k,_tr_flush_block:N,_tr_tally:j,_tr_align:V};var U=(e,t,i,s)=>{let r=65535&e|0,o=e>>>16&65535|0,n=0;for(;0!==i;){n=i>2e3?2e3:i,i-=n;do{r=r+t[s++]|0,o=o+r|0}while(--n);r%=65521,o%=65521}return r|o<<16|0};const G=new Uint32Array((()=>{let e,t=[];for(var i=0;i<256;i++){e=i;for(var s=0;s<8;s++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t})());var W=(e,t,i,s)=>{const r=G,o=s+i;e^=-1;for(let i=s;i<o;i++)e=e>>>8^r[255&(e^t[i])];return-1^e},H={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},X={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Y,_tr_stored_block:q,_tr_flush_block:$,_tr_tally:Z,_tr_align:K}=z,{Z_NO_FLUSH:Q,Z_PARTIAL_FLUSH:J,Z_FULL_FLUSH:ee,Z_FINISH:te,Z_BLOCK:ie,Z_OK:se,Z_STREAM_END:re,Z_STREAM_ERROR:oe,Z_DATA_ERROR:ne,Z_BUF_ERROR:ae,Z_DEFAULT_COMPRESSION:le,Z_FILTERED:he,Z_HUFFMAN_ONLY:ce,Z_RLE:ue,Z_FIXED:de,Z_DEFAULT_STRATEGY:pe,Z_UNKNOWN:fe,Z_DEFLATED:me}=X,ge=258,_e=262,ve=103,be=113,xe=666,ye=(e,t)=>(e.msg=H[t],t),Pe=e=>(e<<1)-(e>4?9:0),we=e=>{let t=e.length;for(;--t>=0;)e[t]=0};let Me=(e,t,i)=>(t<<e.hash_shift^i)&e.hash_mask;const Ce=e=>{const t=e.state;let i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))},Ee=(e,t)=>{$(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Ce(e.strm)},Ae=(e,t)=>{e.pending_buf[e.pending++]=t},De=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},Te=(e,t,i,s)=>{let r=e.avail_in;return r>s&&(r=s),0===r?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),i),1===e.state.wrap?e.adler=U(e.adler,t,r,i):2===e.state.wrap&&(e.adler=W(e.adler,t,r,i)),e.next_in+=r,e.total_in+=r,r)},Se=(e,t)=>{let i,s,r=e.max_chain_length,o=e.strstart,n=e.prev_length,a=e.nice_match;const l=e.strstart>e.w_size-_e?e.strstart-(e.w_size-_e):0,h=e.window,c=e.w_mask,u=e.prev,d=e.strstart+ge;let p=h[o+n-1],f=h[o+n];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do{if(i=t,h[i+n]===f&&h[i+n-1]===p&&h[i]===h[o]&&h[++i]===h[o+1]){o+=2,i++;do{}while(h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&o<d);if(s=ge-(d-o),o=d-ge,s>n){if(e.match_start=t,n=s,s>=a)break;p=h[o+n-1],f=h[o+n]}}}while((t=u[t&c])>l&&0!=--r);return n<=e.lookahead?n:e.lookahead},Ie=e=>{const t=e.w_size;let i,s,r,o,n;do{if(o=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-_e)){e.window.set(e.window.subarray(t,t+t),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,s=e.hash_size,i=s;do{r=e.head[--i],e.head[i]=r>=t?r-t:0}while(--s);s=t,i=s;do{r=e.prev[--i],e.prev[i]=r>=t?r-t:0}while(--s);o+=t}if(0===e.strm.avail_in)break;if(s=Te(e.strm,e.window,e.strstart+e.lookahead,o),e.lookahead+=s,e.lookahead+e.insert>=3)for(n=e.strstart-e.insert,e.ins_h=e.window[n],e.ins_h=Me(e,e.ins_h,e.window[n+1]);e.insert&&(e.ins_h=Me(e,e.ins_h,e.window[n+3-1]),e.prev[n&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=n,n++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<_e&&0!==e.strm.avail_in)},Fe=(e,t)=>{let i,s;for(;;){if(e.lookahead<_e){if(Ie(e),e.lookahead<_e&&t===Q)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=Me(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-_e&&(e.match_length=Se(e,i)),e.match_length>=3)if(s=Z(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=Me(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Me(e,e.ins_h,e.window[e.strstart+1]);else s=Z(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(s&&(Ee(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===te?(Ee(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Ee(e,!1),0===e.strm.avail_out)?1:2},Le=(e,t)=>{let i,s,r;for(;;){if(e.lookahead<_e){if(Ie(e),e.lookahead<_e&&t===Q)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=Me(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-_e&&(e.match_length=Se(e,i),e.match_length<=5&&(e.strategy===he||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,s=Z(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=Me(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,s&&(Ee(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(s=Z(e,0,e.window[e.strstart-1]),s&&Ee(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(s=Z(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===te?(Ee(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Ee(e,!1),0===e.strm.avail_out)?1:2};function Be(e,t,i,s,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=s,this.func=r}const Re=[new Be(0,0,0,0,((e,t)=>{let i=65535;for(i>e.pending_buf_size-5&&(i=e.pending_buf_size-5);;){if(e.lookahead<=1){if(Ie(e),0===e.lookahead&&t===Q)return 1;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;const s=e.block_start+i;if((0===e.strstart||e.strstart>=s)&&(e.lookahead=e.strstart-s,e.strstart=s,Ee(e,!1),0===e.strm.avail_out))return 1;if(e.strstart-e.block_start>=e.w_size-_e&&(Ee(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===te?(Ee(e,!0),0===e.strm.avail_out?3:4):(e.strstart>e.block_start&&(Ee(e,!1),e.strm.avail_out),1)})),new Be(4,4,8,4,Fe),new Be(4,5,16,8,Fe),new Be(4,6,32,32,Fe),new Be(4,4,16,16,Le),new Be(8,16,32,32,Le),new Be(8,16,128,128,Le),new Be(8,32,128,256,Le),new Be(32,128,258,1024,Le),new Be(32,258,258,4096,Le)];function ke(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=me,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),we(this.dyn_ltree),we(this.dyn_dtree),we(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),we(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),we(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Oe=e=>{if(!e||!e.state)return ye(e,oe);e.total_in=e.total_out=0,e.data_type=fe;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?42:be,e.adler=2===t.wrap?0:1,t.last_flush=Q,Y(t),se},Ne=e=>{const t=Oe(e);return t===se&&(e=>{e.window_size=2*e.w_size,we(e.head),e.max_lazy_match=Re[e.level].max_lazy,e.good_match=Re[e.level].good_length,e.nice_match=Re[e.level].nice_length,e.max_chain_length=Re[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0})(e.state),t},je=(e,t,i,s,r,o)=>{if(!e)return oe;let n=1;if(t===le&&(t=6),s<0?(n=0,s=-s):s>15&&(n=2,s-=16),r<1||r>9||i!==me||s<8||s>15||t<0||t>9||o<0||o>de)return ye(e,oe);8===s&&(s=9);const a=new ke;return e.state=a,a.strm=e,a.wrap=n,a.gzhead=null,a.w_bits=s,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=t,a.strategy=o,a.method=i,Ne(e)};var Ve=(e,t)=>{let i,s;if(!e||!e.state||t>ie||t<0)return e?ye(e,oe):oe;const r=e.state;if(!e.output||!e.input&&0!==e.avail_in||r.status===xe&&t!==te)return ye(e,0===e.avail_out?ae:oe);r.strm=e;const o=r.last_flush;if(r.last_flush=t,42===r.status)if(2===r.wrap)e.adler=0,Ae(r,31),Ae(r,139),Ae(r,8),r.gzhead?(Ae(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),Ae(r,255&r.gzhead.time),Ae(r,r.gzhead.time>>8&255),Ae(r,r.gzhead.time>>16&255),Ae(r,r.gzhead.time>>24&255),Ae(r,9===r.level?2:r.strategy>=ce||r.level<2?4:0),Ae(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(Ae(r,255&r.gzhead.extra.length),Ae(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(e.adler=W(e.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69):(Ae(r,0),Ae(r,0),Ae(r,0),Ae(r,0),Ae(r,0),Ae(r,9===r.level?2:r.strategy>=ce||r.level<2?4:0),Ae(r,3),r.status=be);else{let t=me+(r.w_bits-8<<4)<<8,i=-1;i=r.strategy>=ce||r.level<2?0:r.level<6?1:6===r.level?2:3,t|=i<<6,0!==r.strstart&&(t|=32),t+=31-t%31,r.status=be,De(r,t),0!==r.strstart&&(De(r,e.adler>>>16),De(r,65535&e.adler)),e.adler=1}if(69===r.status)if(r.gzhead.extra){for(i=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>i&&(e.adler=W(e.adler,r.pending_buf,r.pending-i,i)),Ce(e),i=r.pending,r.pending!==r.pending_buf_size));)Ae(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>i&&(e.adler=W(e.adler,r.pending_buf,r.pending-i,i)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=73)}else r.status=73;if(73===r.status)if(r.gzhead.name){i=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>i&&(e.adler=W(e.adler,r.pending_buf,r.pending-i,i)),Ce(e),i=r.pending,r.pending===r.pending_buf_size)){s=1;break}s=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,Ae(r,s)}while(0!==s);r.gzhead.hcrc&&r.pending>i&&(e.adler=W(e.adler,r.pending_buf,r.pending-i,i)),0===s&&(r.gzindex=0,r.status=91)}else r.status=91;if(91===r.status)if(r.gzhead.comment){i=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>i&&(e.adler=W(e.adler,r.pending_buf,r.pending-i,i)),Ce(e),i=r.pending,r.pending===r.pending_buf_size)){s=1;break}s=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,Ae(r,s)}while(0!==s);r.gzhead.hcrc&&r.pending>i&&(e.adler=W(e.adler,r.pending_buf,r.pending-i,i)),0===s&&(r.status=ve)}else r.status=ve;if(r.status===ve&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&Ce(e),r.pending+2<=r.pending_buf_size&&(Ae(r,255&e.adler),Ae(r,e.adler>>8&255),e.adler=0,r.status=be)):r.status=be),0!==r.pending){if(Ce(e),0===e.avail_out)return r.last_flush=-1,se}else if(0===e.avail_in&&Pe(t)<=Pe(o)&&t!==te)return ye(e,ae);if(r.status===xe&&0!==e.avail_in)return ye(e,ae);if(0!==e.avail_in||0!==r.lookahead||t!==Q&&r.status!==xe){let i=r.strategy===ce?((e,t)=>{let i;for(;;){if(0===e.lookahead&&(Ie(e),0===e.lookahead)){if(t===Q)return 1;break}if(e.match_length=0,i=Z(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(Ee(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===te?(Ee(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Ee(e,!1),0===e.strm.avail_out)?1:2})(r,t):r.strategy===ue?((e,t)=>{let i,s,r,o;const n=e.window;for(;;){if(e.lookahead<=ge){if(Ie(e),e.lookahead<=ge&&t===Q)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=e.strstart-1,s=n[r],s===n[++r]&&s===n[++r]&&s===n[++r])){o=e.strstart+ge;do{}while(s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&r<o);e.match_length=ge-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=Z(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=Z(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(Ee(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===te?(Ee(e,!0),0===e.strm.avail_out?3:4):e.last_lit&&(Ee(e,!1),0===e.strm.avail_out)?1:2})(r,t):Re[r.level].func(r,t);if(3!==i&&4!==i||(r.status=xe),1===i||3===i)return 0===e.avail_out&&(r.last_flush=-1),se;if(2===i&&(t===J?K(r):t!==ie&&(q(r,0,0,!1),t===ee&&(we(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),Ce(e),0===e.avail_out))return r.last_flush=-1,se}return t!==te?se:r.wrap<=0?re:(2===r.wrap?(Ae(r,255&e.adler),Ae(r,e.adler>>8&255),Ae(r,e.adler>>16&255),Ae(r,e.adler>>24&255),Ae(r,255&e.total_in),Ae(r,e.total_in>>8&255),Ae(r,e.total_in>>16&255),Ae(r,e.total_in>>24&255)):(De(r,e.adler>>>16),De(r,65535&e.adler)),Ce(e),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?se:re)},ze=(e,t)=>{let i=t.length;if(!e||!e.state)return oe;const s=e.state,r=s.wrap;if(2===r||1===r&&42!==s.status||s.lookahead)return oe;if(1===r&&(e.adler=U(e.adler,t,i,0)),s.wrap=0,i>=s.w_size){0===r&&(we(s.head),s.strstart=0,s.block_start=0,s.insert=0);let e=new Uint8Array(s.w_size);e.set(t.subarray(i-s.w_size,i),0),t=e,i=s.w_size}const o=e.avail_in,n=e.next_in,a=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,Ie(s);s.lookahead>=3;){let e=s.strstart,t=s.lookahead-2;do{s.ins_h=Me(s,s.ins_h,s.window[e+3-1]),s.prev[e&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=e,e++}while(--t);s.strstart=e,s.lookahead=2,Ie(s)}return s.strstart+=s.lookahead,s.block_start=s.strstart,s.insert=s.lookahead,s.lookahead=0,s.match_length=s.prev_length=2,s.match_available=0,e.next_in=n,e.input=a,e.avail_in=o,s.wrap=r,se},Ue={deflateInit:(e,t)=>je(e,t,me,15,8,pe),deflateInit2:je,deflateReset:Ne,deflateResetKeep:Oe,deflateSetHeader:(e,t)=>e&&e.state?2!==e.state.wrap?oe:(e.state.gzhead=t,se):oe,deflate:Ve,deflateEnd:e=>{if(!e||!e.state)return oe;const t=e.state.status;return 42!==t&&69!==t&&73!==t&&91!==t&&t!==ve&&t!==be&&t!==xe?ye(e,oe):(e.state=null,t===be?ye(e,ne):se)},deflateSetDictionary:ze,deflateInfo:"pako deflate (from Nodeca project)"};const Ge=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var We=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(const t in i)Ge(i,t)&&(e[t]=i[t])}}return e},He=e=>{let t=0;for(let i=0,s=e.length;i<s;i++)t+=e[i].length;const i=new Uint8Array(t);for(let t=0,s=0,r=e.length;t<r;t++){let r=e[t];i.set(r,s),s+=r.length}return i};let Xe=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){Xe=!1}const Ye=new Uint8Array(256);for(let e=0;e<256;e++)Ye[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Ye[254]=Ye[254]=1;var qe=e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,i,s,r,o,n=e.length,a=0;for(r=0;r<n;r++)i=e.charCodeAt(r),55296==(64512&i)&&r+1<n&&(s=e.charCodeAt(r+1),56320==(64512&s)&&(i=65536+(i-55296<<10)+(s-56320),r++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(a),o=0,r=0;o<a;r++)i=e.charCodeAt(r),55296==(64512&i)&&r+1<n&&(s=e.charCodeAt(r+1),56320==(64512&s)&&(i=65536+(i-55296<<10)+(s-56320),r++)),i<128?t[o++]=i:i<2048?(t[o++]=192|i>>>6,t[o++]=128|63&i):i<65536?(t[o++]=224|i>>>12,t[o++]=128|i>>>6&63,t[o++]=128|63&i):(t[o++]=240|i>>>18,t[o++]=128|i>>>12&63,t[o++]=128|i>>>6&63,t[o++]=128|63&i);return t},$e=(e,t)=>{const i=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let s,r;const o=new Array(2*i);for(r=0,s=0;s<i;){let t=e[s++];if(t<128){o[r++]=t;continue}let n=Ye[t];if(n>4)o[r++]=65533,s+=n-1;else{for(t&=2===n?31:3===n?15:7;n>1&&s<i;)t=t<<6|63&e[s++],n--;n>1?o[r++]=65533:t<65536?o[r++]=t:(t-=65536,o[r++]=55296|t>>10&1023,o[r++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&Xe)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let i="";for(let s=0;s<t;s++)i+=String.fromCharCode(e[s]);return i})(o,r)},Ze=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let i=t-1;for(;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+Ye[e[i]]>t?i:t};var Ke=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Qe=Object.prototype.toString,{Z_NO_FLUSH:Je,Z_SYNC_FLUSH:et,Z_FULL_FLUSH:tt,Z_FINISH:it,Z_OK:st,Z_STREAM_END:rt,Z_DEFAULT_COMPRESSION:ot,Z_DEFAULT_STRATEGY:nt,Z_DEFLATED:at}=X;function lt(e){this.options=We({level:ot,method:at,chunkSize:16384,windowBits:15,memLevel:8,strategy:nt},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ke,this.strm.avail_out=0;let i=Ue.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==st)throw new Error(H[i]);if(t.header&&Ue.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?qe(t.dictionary):"[object ArrayBuffer]"===Qe.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,i=Ue.deflateSetDictionary(this.strm,e),i!==st)throw new Error(H[i]);this._dict_set=!0}}function ht(e,t){const i=new lt(t);if(i.push(e,!0),i.err)throw i.msg||H[i.err];return i.result}lt.prototype.push=function(e,t){const i=this.strm,s=this.options.chunkSize;let r,o;if(this.ended)return!1;for(o=t===~~t?t:!0===t?it:Je,"string"==typeof e?i.input=qe(e):"[object ArrayBuffer]"===Qe.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;)if(0===i.avail_out&&(i.output=new Uint8Array(s),i.next_out=0,i.avail_out=s),(o===et||o===tt)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(r=Ue.deflate(i,o),r===rt)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),r=Ue.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===st;if(0!==i.avail_out){if(o>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(0===i.avail_in)break}else this.onData(i.output)}return!0},lt.prototype.onData=function(e){this.chunks.push(e)},lt.prototype.onEnd=function(e){e===st&&(this.result=He(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var ct={Deflate:lt,deflate:ht,deflateRaw:function(e,t){return(t=t||{}).raw=!0,ht(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,ht(e,t)},constants:X};var ut=function(e,t){let i,s,r,o,n,a,l,h,c,u,d,p,f,m,g,_,v,b,x,y,P,w,M,C;const E=e.state;i=e.next_in,M=e.input,s=i+(e.avail_in-5),r=e.next_out,C=e.output,o=r-(t-e.avail_out),n=r+(e.avail_out-257),a=E.dmax,l=E.wsize,h=E.whave,c=E.wnext,u=E.window,d=E.hold,p=E.bits,f=E.lencode,m=E.distcode,g=(1<<E.lenbits)-1,_=(1<<E.distbits)-1;e:do{p<15&&(d+=M[i++]<<p,p+=8,d+=M[i++]<<p,p+=8),v=f[d&g];t:for(;;){if(b=v>>>24,d>>>=b,p-=b,b=v>>>16&255,0===b)C[r++]=65535&v;else{if(!(16&b)){if(0==(64&b)){v=f[(65535&v)+(d&(1<<b)-1)];continue t}if(32&b){E.mode=12;break e}e.msg="invalid literal/length code",E.mode=30;break e}x=65535&v,b&=15,b&&(p<b&&(d+=M[i++]<<p,p+=8),x+=d&(1<<b)-1,d>>>=b,p-=b),p<15&&(d+=M[i++]<<p,p+=8,d+=M[i++]<<p,p+=8),v=m[d&_];i:for(;;){if(b=v>>>24,d>>>=b,p-=b,b=v>>>16&255,!(16&b)){if(0==(64&b)){v=m[(65535&v)+(d&(1<<b)-1)];continue i}e.msg="invalid distance code",E.mode=30;break e}if(y=65535&v,b&=15,p<b&&(d+=M[i++]<<p,p+=8,p<b&&(d+=M[i++]<<p,p+=8)),y+=d&(1<<b)-1,y>a){e.msg="invalid distance too far back",E.mode=30;break e}if(d>>>=b,p-=b,b=r-o,y>b){if(b=y-b,b>h&&E.sane){e.msg="invalid distance too far back",E.mode=30;break e}if(P=0,w=u,0===c){if(P+=l-b,b<x){x-=b;do{C[r++]=u[P++]}while(--b);P=r-y,w=C}}else if(c<b){if(P+=l+c-b,b-=c,b<x){x-=b;do{C[r++]=u[P++]}while(--b);if(P=0,c<x){b=c,x-=b;do{C[r++]=u[P++]}while(--b);P=r-y,w=C}}}else if(P+=c-b,b<x){x-=b;do{C[r++]=u[P++]}while(--b);P=r-y,w=C}for(;x>2;)C[r++]=w[P++],C[r++]=w[P++],C[r++]=w[P++],x-=3;x&&(C[r++]=w[P++],x>1&&(C[r++]=w[P++]))}else{P=r-y;do{C[r++]=C[P++],C[r++]=C[P++],C[r++]=C[P++],x-=3}while(x>2);x&&(C[r++]=C[P++],x>1&&(C[r++]=C[P++]))}break}}break}}while(i<s&&r<n);x=p>>3,i-=x,p-=x<<3,d&=(1<<p)-1,e.next_in=i,e.next_out=r,e.avail_in=i<s?s-i+5:5-(i-s),e.avail_out=r<n?n-r+257:257-(r-n),E.hold=d,E.bits=p};const dt=15,pt=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ft=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),mt=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),gt=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var _t=(e,t,i,s,r,o,n,a)=>{const l=a.bits;let h,c,u,d,p,f,m=0,g=0,_=0,v=0,b=0,x=0,y=0,P=0,w=0,M=0,C=null,E=0;const A=new Uint16Array(16),D=new Uint16Array(16);let T,S,I,F=null,L=0;for(m=0;m<=dt;m++)A[m]=0;for(g=0;g<s;g++)A[t[i+g]]++;for(b=l,v=dt;v>=1&&0===A[v];v--);if(b>v&&(b=v),0===v)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(_=1;_<v&&0===A[_];_++);for(b<_&&(b=_),P=1,m=1;m<=dt;m++)if(P<<=1,P-=A[m],P<0)return-1;if(P>0&&(0===e||1!==v))return-1;for(D[1]=0,m=1;m<dt;m++)D[m+1]=D[m]+A[m];for(g=0;g<s;g++)0!==t[i+g]&&(n[D[t[i+g]]++]=g);if(0===e?(C=F=n,f=19):1===e?(C=pt,E-=257,F=ft,L-=257,f=256):(C=mt,F=gt,f=-1),M=0,g=0,m=_,p=o,x=b,y=0,u=-1,w=1<<b,d=w-1,1===e&&w>852||2===e&&w>592)return 1;for(;;){T=m-y,n[g]<f?(S=0,I=n[g]):n[g]>f?(S=F[L+n[g]],I=C[E+n[g]]):(S=96,I=0),h=1<<m-y,c=1<<x,_=c;do{c-=h,r[p+(M>>y)+c]=T<<24|S<<16|I|0}while(0!==c);for(h=1<<m-1;M&h;)h>>=1;if(0!==h?(M&=h-1,M+=h):M=0,g++,0==--A[m]){if(m===v)break;m=t[i+n[g]]}if(m>b&&(M&d)!==u){for(0===y&&(y=b),p+=_,x=m-y,P=1<<x;x+y<v&&(P-=A[x+y],!(P<=0));)x++,P<<=1;if(w+=1<<x,1===e&&w>852||2===e&&w>592)return 1;u=M&d,r[u]=b<<24|x<<16|p-o|0}}return 0!==M&&(r[p+M]=m-y<<24|64<<16|0),a.bits=b,0};const{Z_FINISH:vt,Z_BLOCK:bt,Z_TREES:xt,Z_OK:yt,Z_STREAM_END:Pt,Z_NEED_DICT:wt,Z_STREAM_ERROR:Mt,Z_DATA_ERROR:Ct,Z_MEM_ERROR:Et,Z_BUF_ERROR:At,Z_DEFLATED:Dt}=X,Tt=12,St=30,It=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Ft(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Lt=e=>{if(!e||!e.state)return Mt;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=1,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,yt},Bt=e=>{if(!e||!e.state)return Mt;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Lt(e)},Rt=(e,t)=>{let i;if(!e||!e.state)return Mt;const s=e.state;return t<0?(i=0,t=-t):(i=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Mt:(null!==s.window&&s.wbits!==t&&(s.window=null),s.wrap=i,s.wbits=t,Bt(e))},kt=(e,t)=>{if(!e)return Mt;const i=new Ft;e.state=i,i.window=null;const s=Rt(e,t);return s!==yt&&(e.state=null),s};let Ot,Nt,jt=!0;const Vt=e=>{if(jt){Ot=new Int32Array(512),Nt=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(_t(1,e.lens,0,288,Ot,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;_t(2,e.lens,0,32,Nt,0,e.work,{bits:5}),jt=!1}e.lencode=Ot,e.lenbits=9,e.distcode=Nt,e.distbits=5},zt=(e,t,i,s)=>{let r;const o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),s>=o.wsize?(o.window.set(t.subarray(i-o.wsize,i),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>s&&(r=s),o.window.set(t.subarray(i-s,i-s+r),o.wnext),(s-=r)?(o.window.set(t.subarray(i-s,i),0),o.wnext=s,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var Ut=(e,t)=>{let i,s,r,o,n,a,l,h,c,u,d,p,f,m,g,_,v,b,x,y,P,w,M=0;const C=new Uint8Array(4);let E,A;const D=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return Mt;i=e.state,i.mode===Tt&&(i.mode=13),n=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,s=e.input,a=e.avail_in,h=i.hold,c=i.bits,u=a,d=l,w=yt;e:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;c<16;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(2&i.wrap&&35615===h){i.check=0,C[0]=255&h,C[1]=h>>>8&255,i.check=W(i.check,C,2,0),h=0,c=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&h)<<8)+(h>>8))%31){e.msg="incorrect header check",i.mode=St;break}if((15&h)!==Dt){e.msg="unknown compression method",i.mode=St;break}if(h>>>=4,c-=4,P=8+(15&h),0===i.wbits)i.wbits=P;else if(P>i.wbits){e.msg="invalid window size",i.mode=St;break}i.dmax=1<<i.wbits,e.adler=i.check=1,i.mode=512&h?10:Tt,h=0,c=0;break;case 2:for(;c<16;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(i.flags=h,(255&i.flags)!==Dt){e.msg="unknown compression method",i.mode=St;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=St;break}i.head&&(i.head.text=h>>8&1),512&i.flags&&(C[0]=255&h,C[1]=h>>>8&255,i.check=W(i.check,C,2,0)),h=0,c=0,i.mode=3;case 3:for(;c<32;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}i.head&&(i.head.time=h),512&i.flags&&(C[0]=255&h,C[1]=h>>>8&255,C[2]=h>>>16&255,C[3]=h>>>24&255,i.check=W(i.check,C,4,0)),h=0,c=0,i.mode=4;case 4:for(;c<16;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}i.head&&(i.head.xflags=255&h,i.head.os=h>>8),512&i.flags&&(C[0]=255&h,C[1]=h>>>8&255,i.check=W(i.check,C,2,0)),h=0,c=0,i.mode=5;case 5:if(1024&i.flags){for(;c<16;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}i.length=h,i.head&&(i.head.extra_len=h),512&i.flags&&(C[0]=255&h,C[1]=h>>>8&255,i.check=W(i.check,C,2,0)),h=0,c=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&(p=i.length,p>a&&(p=a),p&&(i.head&&(P=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(s.subarray(o,o+p),P)),512&i.flags&&(i.check=W(i.check,s,p,o)),a-=p,o+=p,i.length-=p),i.length))break e;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===a)break e;p=0;do{P=s[o+p++],i.head&&P&&i.length<65536&&(i.head.name+=String.fromCharCode(P))}while(P&&p<a);if(512&i.flags&&(i.check=W(i.check,s,p,o)),a-=p,o+=p,P)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===a)break e;p=0;do{P=s[o+p++],i.head&&P&&i.length<65536&&(i.head.comment+=String.fromCharCode(P))}while(P&&p<a);if(512&i.flags&&(i.check=W(i.check,s,p,o)),a-=p,o+=p,P)break e}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;c<16;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(h!==(65535&i.check)){e.msg="header crc mismatch",i.mode=St;break}h=0,c=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Tt;break;case 10:for(;c<32;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}e.adler=i.check=It(h),h=0,c=0,i.mode=11;case 11:if(0===i.havedict)return e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,i.hold=h,i.bits=c,wt;e.adler=i.check=1,i.mode=Tt;case Tt:if(t===bt||t===xt)break e;case 13:if(i.last){h>>>=7&c,c-=7&c,i.mode=27;break}for(;c<3;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}switch(i.last=1&h,h>>>=1,c-=1,3&h){case 0:i.mode=14;break;case 1:if(Vt(i),i.mode=20,t===xt){h>>>=2,c-=2;break e}break;case 2:i.mode=17;break;case 3:e.msg="invalid block type",i.mode=St}h>>>=2,c-=2;break;case 14:for(h>>>=7&c,c-=7&c;c<32;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if((65535&h)!=(h>>>16^65535)){e.msg="invalid stored block lengths",i.mode=St;break}if(i.length=65535&h,h=0,c=0,i.mode=15,t===xt)break e;case 15:i.mode=16;case 16:if(p=i.length,p){if(p>a&&(p=a),p>l&&(p=l),0===p)break e;r.set(s.subarray(o,o+p),n),a-=p,o+=p,l-=p,n+=p,i.length-=p;break}i.mode=Tt;break;case 17:for(;c<14;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(i.nlen=257+(31&h),h>>>=5,c-=5,i.ndist=1+(31&h),h>>>=5,c-=5,i.ncode=4+(15&h),h>>>=4,c-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=St;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;c<3;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}i.lens[D[i.have++]]=7&h,h>>>=3,c-=3}for(;i.have<19;)i.lens[D[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,E={bits:i.lenbits},w=_t(0,i.lens,0,19,i.lencode,0,i.work,E),i.lenbits=E.bits,w){e.msg="invalid code lengths set",i.mode=St;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;M=i.lencode[h&(1<<i.lenbits)-1],g=M>>>24,_=M>>>16&255,v=65535&M,!(g<=c);){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(v<16)h>>>=g,c-=g,i.lens[i.have++]=v;else{if(16===v){for(A=g+2;c<A;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(h>>>=g,c-=g,0===i.have){e.msg="invalid bit length repeat",i.mode=St;break}P=i.lens[i.have-1],p=3+(3&h),h>>>=2,c-=2}else if(17===v){for(A=g+3;c<A;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}h>>>=g,c-=g,P=0,p=3+(7&h),h>>>=3,c-=3}else{for(A=g+7;c<A;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}h>>>=g,c-=g,P=0,p=11+(127&h),h>>>=7,c-=7}if(i.have+p>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=St;break}for(;p--;)i.lens[i.have++]=P}}if(i.mode===St)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=St;break}if(i.lenbits=9,E={bits:i.lenbits},w=_t(1,i.lens,0,i.nlen,i.lencode,0,i.work,E),i.lenbits=E.bits,w){e.msg="invalid literal/lengths set",i.mode=St;break}if(i.distbits=6,i.distcode=i.distdyn,E={bits:i.distbits},w=_t(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,E),i.distbits=E.bits,w){e.msg="invalid distances set",i.mode=St;break}if(i.mode=20,t===xt)break e;case 20:i.mode=21;case 21:if(a>=6&&l>=258){e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,i.hold=h,i.bits=c,ut(e,d),n=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,s=e.input,a=e.avail_in,h=i.hold,c=i.bits,i.mode===Tt&&(i.back=-1);break}for(i.back=0;M=i.lencode[h&(1<<i.lenbits)-1],g=M>>>24,_=M>>>16&255,v=65535&M,!(g<=c);){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(_&&0==(240&_)){for(b=g,x=_,y=v;M=i.lencode[y+((h&(1<<b+x)-1)>>b)],g=M>>>24,_=M>>>16&255,v=65535&M,!(b+g<=c);){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}h>>>=b,c-=b,i.back+=b}if(h>>>=g,c-=g,i.back+=g,i.length=v,0===_){i.mode=26;break}if(32&_){i.back=-1,i.mode=Tt;break}if(64&_){e.msg="invalid literal/length code",i.mode=St;break}i.extra=15&_,i.mode=22;case 22:if(i.extra){for(A=i.extra;c<A;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}i.length+=h&(1<<i.extra)-1,h>>>=i.extra,c-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;M=i.distcode[h&(1<<i.distbits)-1],g=M>>>24,_=M>>>16&255,v=65535&M,!(g<=c);){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(0==(240&_)){for(b=g,x=_,y=v;M=i.distcode[y+((h&(1<<b+x)-1)>>b)],g=M>>>24,_=M>>>16&255,v=65535&M,!(b+g<=c);){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}h>>>=b,c-=b,i.back+=b}if(h>>>=g,c-=g,i.back+=g,64&_){e.msg="invalid distance code",i.mode=St;break}i.offset=v,i.extra=15&_,i.mode=24;case 24:if(i.extra){for(A=i.extra;c<A;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}i.offset+=h&(1<<i.extra)-1,h>>>=i.extra,c-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=St;break}i.mode=25;case 25:if(0===l)break e;if(p=d-l,i.offset>p){if(p=i.offset-p,p>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=St;break}p>i.wnext?(p-=i.wnext,f=i.wsize-p):f=i.wnext-p,p>i.length&&(p=i.length),m=i.window}else m=r,f=n-i.offset,p=i.length;p>l&&(p=l),l-=p,i.length-=p;do{r[n++]=m[f++]}while(--p);0===i.length&&(i.mode=21);break;case 26:if(0===l)break e;r[n++]=i.length,l--,i.mode=21;break;case 27:if(i.wrap){for(;c<32;){if(0===a)break e;a--,h|=s[o++]<<c,c+=8}if(d-=l,e.total_out+=d,i.total+=d,d&&(e.adler=i.check=i.flags?W(i.check,r,d,n-d):U(i.check,r,d,n-d)),d=l,(i.flags?h:It(h))!==i.check){e.msg="incorrect data check",i.mode=St;break}h=0,c=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;c<32;){if(0===a)break e;a--,h+=s[o++]<<c,c+=8}if(h!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=St;break}h=0,c=0}i.mode=29;case 29:w=Pt;break e;case St:w=Ct;break e;case 31:return Et;default:return Mt}return e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,i.hold=h,i.bits=c,(i.wsize||d!==e.avail_out&&i.mode<St&&(i.mode<27||t!==vt))&&zt(e,e.output,e.next_out,d-e.avail_out),u-=e.avail_in,d-=e.avail_out,e.total_in+=u,e.total_out+=d,i.total+=d,i.wrap&&d&&(e.adler=i.check=i.flags?W(i.check,r,d,e.next_out-d):U(i.check,r,d,e.next_out-d)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Tt?128:0)+(20===i.mode||15===i.mode?256:0),(0===u&&0===d||t===vt)&&w===yt&&(w=At),w},Gt={inflateReset:Bt,inflateReset2:Rt,inflateResetKeep:Lt,inflateInit:e=>kt(e,15),inflateInit2:kt,inflate:Ut,inflateEnd:e=>{if(!e||!e.state)return Mt;let t=e.state;return t.window&&(t.window=null),e.state=null,yt},inflateGetHeader:(e,t)=>{if(!e||!e.state)return Mt;const i=e.state;return 0==(2&i.wrap)?Mt:(i.head=t,t.done=!1,yt)},inflateSetDictionary:(e,t)=>{const i=t.length;let s,r,o;return e&&e.state?(s=e.state,0!==s.wrap&&11!==s.mode?Mt:11===s.mode&&(r=1,r=U(r,t,i,0),r!==s.check)?Ct:(o=zt(e,t,i,i),o?(s.mode=31,Et):(s.havedict=1,yt))):Mt},inflateInfo:"pako inflate (from Nodeca project)"};var Wt=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Ht=Object.prototype.toString,{Z_NO_FLUSH:Xt,Z_FINISH:Yt,Z_OK:qt,Z_STREAM_END:$t,Z_NEED_DICT:Zt,Z_STREAM_ERROR:Kt,Z_DATA_ERROR:Qt,Z_MEM_ERROR:Jt}=X;function ei(e){this.options=We({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ke,this.strm.avail_out=0;let i=Gt.inflateInit2(this.strm,t.windowBits);if(i!==qt)throw new Error(H[i]);if(this.header=new Wt,Gt.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=qe(t.dictionary):"[object ArrayBuffer]"===Ht.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=Gt.inflateSetDictionary(this.strm,t.dictionary),i!==qt)))throw new Error(H[i])}function ti(e,t){const i=new ei(t);if(i.push(e),i.err)throw i.msg||H[i.err];return i.result}ei.prototype.push=function(e,t){const i=this.strm,s=this.options.chunkSize,r=this.options.dictionary;let o,n,a;if(this.ended)return!1;for(n=t===~~t?t:!0===t?Yt:Xt,"[object ArrayBuffer]"===Ht.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;){for(0===i.avail_out&&(i.output=new Uint8Array(s),i.next_out=0,i.avail_out=s),o=Gt.inflate(i,n),o===Zt&&r&&(o=Gt.inflateSetDictionary(i,r),o===qt?o=Gt.inflate(i,n):o===Qt&&(o=Zt));i.avail_in>0&&o===$t&&i.state.wrap>0&&0!==e[i.next_in];)Gt.inflateReset(i),o=Gt.inflate(i,n);switch(o){case Kt:case Qt:case Zt:case Jt:return this.onEnd(o),this.ended=!0,!1}if(a=i.avail_out,i.next_out&&(0===i.avail_out||o===$t))if("string"===this.options.to){let e=Ze(i.output,i.next_out),t=i.next_out-e,r=$e(i.output,e);i.next_out=t,i.avail_out=s-t,t&&i.output.set(i.output.subarray(e,e+t),0),this.onData(r)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(o!==qt||0!==a){if(o===$t)return o=Gt.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===i.avail_in)break}}return!0},ei.prototype.onData=function(e){this.chunks.push(e)},ei.prototype.onEnd=function(e){e===qt&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=He(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var ii={Inflate:ei,inflate:ti,inflateRaw:function(e,t){return(t=t||{}).raw=!0,ti(e,t)},ungzip:ti,constants:X};const{Deflate:si,deflate:ri,deflateRaw:oi,gzip:ni}=ct,{Inflate:ai,inflate:li,inflateRaw:hi,ungzip:ci}=ii;var ui=si,di=ri,pi=oi,fi=ni,mi=ai,gi=li,_i=hi,vi=ci,bi=X,xi={Deflate:ui,deflate:di,deflateRaw:pi,gzip:fi,Inflate:mi,inflate:gi,inflateRaw:_i,ungzip:vi,constants:bi};e.Deflate=ui,e.Inflate=mi,e.constants=bi,e.default=xi,e.deflate=di,e.deflateRaw=pi,e.gzip=fi,e.inflate=gi,e.inflateRaw=_i,e.ungzip=vi,Object.defineProperty(e,"__esModule",{value:!0})}));var md=Object.freeze({__proto__:null});let gd=window.pako||md;gd.inflate||(gd=gd.default);const _d=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const vd={version:1,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11]}}(i),o=function(e){return{positions:new Uint16Array(gd.inflate(e.positions).buffer),normals:new Int8Array(gd.inflate(e.normals).buffer),indices:new Uint32Array(gd.inflate(e.indices).buffer),edgeIndices:new Uint32Array(gd.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(gd.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(gd.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(gd.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(gd.inflate(e.meshColors).buffer),entityIDs:gd.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(gd.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(gd.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(gd.inflate(e.positionsDecodeMatrix).buffer)}}(r);!function(e,t,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,n=i.indices,a=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,c=i.meshEdgesIndices,u=i.meshColors,d=JSON.parse(i.entityIDs),f=i.entityMeshes,m=i.entityIsObjects,g=l.length,_=f.length;for(let b=0;b<_;b++){const x=d[b],y=t.globalizeObjectIds?p.globalizeObjectId(s.id,x):x,P=e.metaScene.metaObjects[y],w={},M={};if(P){if(t.excludeTypesMap&&P.type&&t.excludeTypesMap[P.type])continue;if(t.includeTypesMap&&P.type&&!t.includeTypesMap[P.type])continue;const e=t.objectDefaults?t.objectDefaults[P.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(w.visible=!1),!1===e.pickable&&(w.pickable=!1),e.colorize&&(M.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(M.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;const C=b===_-1,E=[];for(let e=f[b],t=C?f.length:f[b+1];e<t;e++){const t=e===g-1,d=y+".mesh."+e,p=_d(u.subarray(4*e,4*e+3)),f=u[4*e+3]/255;s.createMesh(v.apply(M,{id:d,primitive:"triangles",positionsCompressed:r.subarray(l[e],t?r.length:l[e+1]),normalsCompressed:o.subarray(l[e],t?r.length:l[e+1]),indices:n.subarray(h[e],t?n.length:h[e+1]),edgeIndices:a.subarray(c[e],t?a.length:c[e+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:p,opacity:f})),E.push(d)}s.createEntity(v.apply(w,{id:y,isObject:1===m[b],meshIds:E}))}}(e,t,o,s)}};let bd=window.pako||md;bd.inflate||(bd=bd.default);const xd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const yd={version:2,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11],entityMeshIds:e[12],entityMatrices:e[13],entityUsesInstancing:e[14]}}(i),o=function(e){return{positions:new Uint16Array(bd.inflate(e.positions).buffer),normals:new Int8Array(bd.inflate(e.normals).buffer),indices:new Uint32Array(bd.inflate(e.indices).buffer),edgeIndices:new Uint32Array(bd.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(bd.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(bd.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(bd.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(bd.inflate(e.meshColors).buffer),entityIDs:bd.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(bd.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(bd.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(bd.inflate(e.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(bd.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(bd.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(bd.inflate(e.entityUsesInstancing).buffer)}}(r);!function(e,t,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,n=i.indices,a=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,c=i.meshEdgesIndices,u=i.meshColors,d=JSON.parse(i.entityIDs),f=i.entityMeshes,m=i.entityIsObjects,g=i.entityMeshIds,_=i.entityMatrices,b=i.entityUsesInstancing,x=l.length,y=f.length,P={};for(let w=0;w<y;w++){const M=d[w],C=t.globalizeObjectIds?p.globalizeObjectId(s.id,M):M,E=e.metaScene.metaObjects[C],A={},D={},T=_.subarray(16*w,16*w+16);if(E){if(t.excludeTypesMap&&E.type&&t.excludeTypesMap[E.type])continue;if(t.includeTypesMap&&E.type&&!t.includeTypesMap[E.type])continue;const e=t.objectDefaults?t.objectDefaults[E.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(A.visible=!1),!1===e.pickable&&(A.pickable=!1),e.colorize&&(D.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(D.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;const S=w===y-1,I=[];for(let e=f[w],t=S?g.length:f[w+1];e<t;e++){const t=g[e],d=t===x-1,p=C+".mesh."+t,f=xd(u.subarray(4*t,4*t+3)),m=u[4*t+3]/255,_=r.subarray(l[t],d?r.length:l[t+1]),y=o.subarray(l[t],d?r.length:l[t+1]),M=n.subarray(h[t],d?n.length:h[t+1]),E=a.subarray(c[t],d?a.length:c[t+1]);if(1===b[w]){const e="geometry."+t;e in P||(s.createGeometry({id:e,positionsCompressed:_,normalsCompressed:y,indices:M,edgeIndices:E,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),P[e]=!0),s.createMesh(v.apply(D,{id:p,color:f,opacity:m,matrix:T,geometryId:e})),I.push(p)}else s.createMesh(v.apply(D,{id:p,primitive:"triangles",positionsCompressed:_,normalsCompressed:y,indices:M,edgeIndices:E,positionsDecodeMatrix:i.positionsDecodeMatrix,color:f,opacity:m})),I.push(p)}I.length&&s.createEntity(v.apply(A,{id:C,isObject:1===m[w],meshIds:I}))}}(e,t,o,s)}};let Pd=window.pako||md;Pd.inflate||(Pd=Pd.default);const wd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Md={version:3,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],instancedPositionsDecodeMatrix:e[11],batchedPositionsDecodeMatrix:e[12],entityMeshIds:e[13],entityMatrices:e[14],entityUsesInstancing:e[15]}}(i),o=function(e){return{positions:new Uint16Array(Pd.inflate(e.positions).buffer),normals:new Int8Array(Pd.inflate(e.normals).buffer),indices:new Uint32Array(Pd.inflate(e.indices).buffer),edgeIndices:new Uint32Array(Pd.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(Pd.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(Pd.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Pd.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(Pd.inflate(e.meshColors).buffer),entityIDs:Pd.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Pd.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(Pd.inflate(e.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(Pd.inflate(e.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(Pd.inflate(e.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Pd.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(Pd.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Pd.inflate(e.entityUsesInstancing).buffer)}}(r);!function(e,t,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,n=i.indices,a=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,c=i.meshEdgesIndices,u=i.meshColors,d=JSON.parse(i.entityIDs),f=i.entityMeshes,m=i.entityIsObjects,g=i.entityMeshIds,_=i.entityMatrices,b=i.entityUsesInstancing,x=l.length,y=f.length,P={};for(let T=0;T<y;T++){const S=d[T],I=t.globalizeObjectIds?p.globalizeObjectId(s.id,S):S,F=e.metaScene.metaObjects[I],L={},B={},R=_.subarray(16*T,16*T+16);if(F){if(t.excludeTypesMap&&F.type&&t.excludeTypesMap[F.type])continue;if(t.includeTypesMap&&F.type&&!t.includeTypesMap[F.type])continue;const e=t.objectDefaults?t.objectDefaults[F.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(L.visible=!1),!1===e.pickable&&(L.pickable=!1),e.colorize&&(B.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(B.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;const k=T===y-1,O=[];for(let e=f[T],t=k?g.length:f[T+1];e<t;e++){var w=g[e];const t=w===x-1,d=I+".mesh."+w,p=wd(u.subarray(4*w,4*w+3)),f=u[4*w+3]/255;var M=r.subarray(l[w],t?r.length:l[w+1]),C=o.subarray(l[w],t?r.length:l[w+1]),E=n.subarray(h[w],t?n.length:h[w+1]),A=a.subarray(c[w],t?a.length:c[w+1]);if(1===b[T]){var D="geometry."+w;D in P||(s.createGeometry({id:D,positionsCompressed:M,normalsCompressed:C,indices:E,edgeIndices:A,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),P[D]=!0),s.createMesh(v.apply(B,{id:d,color:p,opacity:f,matrix:R,geometryId:D})),O.push(d)}else s.createMesh(v.apply(B,{id:d,primitive:"triangles",positionsCompressed:M,normalsCompressed:C,indices:E,edgeIndices:A,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:p,opacity:f})),O.push(d)}O.length&&s.createEntity(v.apply(L,{id:I,isObject:1===m[T],meshIds:O}))}}(e,t,o,s)}};let Cd=window.pako||md;Cd.inflate||(Cd=Cd.default);const Ed=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Ad={version:4,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],decodeMatrices:e[4],matrices:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveDecodeMatricesPortion:e[9],eachPrimitiveColor:e[10],primitiveInstances:e[11],eachEntityId:e[12],eachEntityPrimitiveInstancesPortion:e[13],eachEntityMatricesPortion:e[14],eachEntityMatrix:e[15]}}(i),o=function(e){return{positions:new Uint16Array(Cd.inflate(e.positions).buffer),normals:new Int8Array(Cd.inflate(e.normals).buffer),indices:new Uint32Array(Cd.inflate(e.indices).buffer),edgeIndices:new Uint32Array(Cd.inflate(e.edgeIndices).buffer),decodeMatrices:new Float32Array(Cd.inflate(e.decodeMatrices).buffer),matrices:new Float32Array(Cd.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Cd.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Cd.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Cd.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(Cd.inflate(e.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(Cd.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Cd.inflate(e.primitiveInstances).buffer),eachEntityId:Cd.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Cd.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Cd.inflate(e.eachEntityMatricesPortion).buffer)}}(r);!function(e,t,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,n=i.indices,a=i.edgeIndices,l=i.decodeMatrices,h=i.matrices,c=i.eachPrimitivePositionsAndNormalsPortion,u=i.eachPrimitiveIndicesPortion,d=i.eachPrimitiveEdgeIndicesPortion,p=i.eachPrimitiveDecodeMatricesPortion,f=i.eachPrimitiveColor,m=i.primitiveInstances,g=JSON.parse(i.eachEntityId),_=i.eachEntityPrimitiveInstancesPortion,b=i.eachEntityMatricesPortion,x=c.length,y=m.length,P=new Uint8Array(x),w=new Uint32Array(x),M=g.length;for(let e=0;e<x;e++)w[e]=e;w.sort(((e,t)=>p[e]<p[t]?-1:p[e]>p[t]?1:0));for(let e=0;e<y;e++)P[m[e]]++;const C={};for(let e=0;e<M;e++){const t=M-1,i=e===t,s=_[e],r=i?_[t]:_[e+1];for(let t=s;t<r;t++){const i=m[t];P[i]>1||(C[i]=e)}}for(let e=0;e<x;e++){const t=w[e],i=t===x-1,h=P[t]>1,m=Ed(f.subarray(4*t,4*t+3)),_=f[4*t+3]/255,b=r.subarray(c[t],i?r.length:c[t+1]),y=o.subarray(c[t],i?o.length:c[t+1]),M=n.subarray(u[t],i?n.length:u[t+1]),A=a.subarray(d[t],i?a.length:d[t+1]),D=l.subarray(p[t],p[t]+16);if(h){var E="geometry"+t;s.createGeometry({id:E,primitive:"triangles",positionsCompressed:b,normalsCompressed:y,indices:M,edgeIndices:A,positionsDecodeMatrix:D})}else{const e=t;g[C[t]];const i={};s.createMesh(v.apply(i,{id:e,primitive:"triangles",positionsCompressed:b,normalsCompressed:y,indices:M,edgeIndices:A,positionsDecodeMatrix:D,color:m,opacity:_}))}}let A=0;for(let e=0;e<M;e++){const t=M-1,i=e===t,r=g[e],o=_[e],n=i?_[t]:_[e+1],a=[];for(let t=o;t<n;t++){const i=m[t];if(P[i]>1){const t={},r="instance."+A++,o="geometry"+i,n=16*b[e],l=h.subarray(n,n+16);s.createMesh(v.apply(t,{id:r,geometryId:o,matrix:l})),a.push(r)}else a.push(i)}if(a.length>0){const e={};s.createEntity(v.apply(e,{id:r,isObject:!0,meshIds:a}))}}}(0,0,o,s)}};let Dd=window.pako||md;Dd.inflate||(Dd=Dd.default);const Td=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Sd={version:5,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],eachPrimitivePositionsAndNormalsPortion:e[5],eachPrimitiveIndicesPortion:e[6],eachPrimitiveEdgeIndicesPortion:e[7],eachPrimitiveColor:e[8],primitiveInstances:e[9],eachEntityId:e[10],eachEntityPrimitiveInstancesPortion:e[11],eachEntityMatricesPortion:e[12]}}(i),o=function(e){return{positions:new Float32Array(Dd.inflate(e.positions).buffer),normals:new Int8Array(Dd.inflate(e.normals).buffer),indices:new Uint32Array(Dd.inflate(e.indices).buffer),edgeIndices:new Uint32Array(Dd.inflate(e.edgeIndices).buffer),matrices:new Float32Array(Dd.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Dd.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Dd.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Dd.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(Dd.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Dd.inflate(e.primitiveInstances).buffer),eachEntityId:Dd.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Dd.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Dd.inflate(e.eachEntityMatricesPortion).buffer)}}(r);!function(e,t,i,s){s.positionsCompression="disabled",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,n=i.indices,a=i.edgeIndices,l=i.matrices,h=i.eachPrimitivePositionsAndNormalsPortion,c=i.eachPrimitiveIndicesPortion,u=i.eachPrimitiveEdgeIndicesPortion,d=i.eachPrimitiveColor,p=i.primitiveInstances,f=JSON.parse(i.eachEntityId),m=i.eachEntityPrimitiveInstancesPortion,g=i.eachEntityMatricesPortion,_=h.length,b=p.length,x=new Uint8Array(_),y=f.length;for(let e=0;e<b;e++)x[p[e]]++;const P={};for(let e=0;e<y;e++){const t=y-1,i=e===t,s=m[e],r=i?m[t]:m[e+1];for(let t=s;t<r;t++){const i=p[t];x[i]>1||(P[i]=e)}}for(let e=0;e<_;e++){const t=e===_-1,i=x[e]>1,l=Td(d.subarray(4*e,4*e+3)),p=d[4*e+3]/255,m=r.subarray(h[e],t?r.length:h[e+1]),g=o.subarray(h[e],t?o.length:h[e+1]),b=n.subarray(c[e],t?n.length:c[e+1]),y=a.subarray(u[e],t?a.length:u[e+1]);if(i){var w="geometry"+e;s.createGeometry({id:w,primitive:"triangles",positionsCompressed:m,normalsCompressed:g,indices:b,edgeIndices:y})}else{const t=e;f[P[e]];const i={};s.createMesh(v.apply(i,{id:t,primitive:"triangles",positionsCompressed:m,normalsCompressed:g,indices:b,edgeIndices:y,color:l,opacity:p}))}}let M=0;for(let e=0;e<y;e++){const t=y-1,i=e===t,r=f[e],o=m[e],n=i?m[t]:m[e+1],a=[];for(let t=o;t<n;t++){const i=p[t];if(x[i]>1){const t={},r="instance."+M++,o="geometry"+i,n=16*g[e],h=l.subarray(n,n+16);s.createMesh(v.apply(t,{id:r,geometryId:o,matrix:h})),a.push(r)}else a.push(i)}if(a.length>0){const e={};s.createEntity(v.apply(e,{id:r,isObject:!0,meshIds:a}))}}}(0,0,o,s)}};let Id=window.pako||md;Id.inflate||(Id=Id.default);const Fd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const Ld={version:6,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],reusedPrimitivesDecodeMatrix:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveColorAndOpacity:e[9],primitiveInstances:e[10],eachEntityId:e[11],eachEntityPrimitiveInstancesPortion:e[12],eachEntityMatricesPortion:e[13],eachTileAABB:e[14],eachTileEntitiesPortion:e[15]}}(i),o=function(e){function t(e,t){return 0===e.length?[]:Id.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(t(e.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(t(e.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(t(e.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(t(e.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(t(e.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(t(e.primitiveInstances)),eachEntityId:Id.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(t(e.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(t(e.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,i,s){const r=i.positions,o=i.normals,n=i.indices,a=i.edgeIndices,l=i.matrices,h=i.reusedPrimitivesDecodeMatrix,c=i.eachPrimitivePositionsAndNormalsPortion,u=i.eachPrimitiveIndicesPortion,d=i.eachPrimitiveEdgeIndicesPortion,f=i.eachPrimitiveColorAndOpacity,m=i.primitiveInstances,g=JSON.parse(i.eachEntityId),_=i.eachEntityPrimitiveInstancesPortion,b=i.eachEntityMatricesPortion,x=i.eachTileAABB,y=i.eachTileEntitiesPortion,P=c.length,w=m.length,M=g.length,C=y.length;let E=0;const A=new Uint32Array(P);for(let e=0;e<w;e++){const t=m[e];void 0!==A[t]?A[t]++:A[t]=1}const D=p.vec3(),T=p.AABB3();for(let i=0;i<C;i++){const w=i===C-1,S=y[i],I=w?M:y[i+1],F=6*i,L=x.subarray(F,F+6);p.getAABB3Center(L,D),T[0]=L[0]-D[0],T[1]=L[1]-D[1],T[2]=L[2]-D[2],T[3]=L[3]-D[0],T[4]=L[4]-D[1],T[5]=L[5]-D[2];const B=rt.createPositionsDecodeMatrix(T),R={};for(let x=S;x<I;x++){const y=g[x],w=t.globalizeObjectIds?p.globalizeObjectId(s.id,y):y,C=b[x],T=l.slice(C,C+16),S=x===M-1,I=_[x],F=S?m.length:_[x+1],L=[],k=e.metaScene.metaObjects[w],O={},N={};if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;const e=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(O.visible=!1),!1===e.pickable&&(O.pickable=!1),e.colorize&&(N.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(N.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(let e=I;e<F;e++){const t=m[e],l=A[t]>1,p=t===P-1,g=r.subarray(c[t],p?r.length:c[t+1]),_=o.subarray(c[t],p?o.length:c[t+1]),b=n.subarray(u[t],p?n.length:u[t+1]),x=a.subarray(d[t],p?a.length:d[t+1]),y=Fd(f.subarray(4*t,4*t+3)),w=f[4*t+3]/255,M=E++;if(l){const e="geometry."+i+"."+t;R[e]||(s.createGeometry({id:e,primitive:"triangles",positionsCompressed:g,normalsCompressed:_,indices:b,edgeIndices:x,positionsDecodeMatrix:h}),R[e]=!0),s.createMesh(v.apply(N,{id:M,geometryId:e,origin:D,matrix:T,color:y,opacity:w})),L.push(M)}else s.createMesh(v.apply(N,{id:M,origin:D,primitive:"triangles",positionsCompressed:g,normalsCompressed:_,indices:b,edgeIndices:x,positionsDecodeMatrix:B,color:y,opacity:w})),L.push(M)}L.length>0&&s.createEntity(v.apply(O,{id:w,isObject:!0,meshIds:L}))}}}(e,t,o,s)}};let Bd=window.pako||md;Bd.inflate||(Bd=Bd.default);const Rd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function kd(e){const t=[];for(let i=0,s=e.length;i<s;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}const Od={version:7,parse:function(e,t,i,s){const r=function(e){return{positions:e[0],normals:e[1],colors:e[2],indices:e[3],edgeIndices:e[4],matrices:e[5],reusedGeometriesDecodeMatrix:e[6],eachGeometryPrimitiveType:e[7],eachGeometryPositionsPortion:e[8],eachGeometryNormalsPortion:e[9],eachGeometryColorsPortion:e[10],eachGeometryIndicesPortion:e[11],eachGeometryEdgeIndicesPortion:e[12],eachMeshGeometriesPortion:e[13],eachMeshMatricesPortion:e[14],eachMeshMaterial:e[15],eachEntityId:e[16],eachEntityMeshesPortion:e[17],eachTileAABB:e[18],eachTileEntitiesPortion:e[19]}}(i),o=function(e){function t(e,t){return 0===e.length?[]:Bd.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:Bd.inflate(e.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,i,s){const r=i.positions,o=i.normals,n=i.colors,a=i.indices,l=i.edgeIndices,h=i.matrices,c=i.reusedGeometriesDecodeMatrix,u=i.eachGeometryPrimitiveType,d=i.eachGeometryPositionsPortion,f=i.eachGeometryNormalsPortion,m=i.eachGeometryColorsPortion,g=i.eachGeometryIndicesPortion,_=i.eachGeometryEdgeIndicesPortion,b=i.eachMeshGeometriesPortion,x=i.eachMeshMatricesPortion,y=i.eachMeshMaterial,P=JSON.parse(i.eachEntityId),w=i.eachEntityMeshesPortion,M=i.eachTileAABB,C=i.eachTileEntitiesPortion,E=d.length,A=b.length,D=P.length,T=C.length;let S=0;const I=new Uint32Array(E);for(let e=0;e<A;e++){const t=b[e];void 0!==I[t]?I[t]++:I[t]=1}const F=p.vec3(),L=p.AABB3();for(let i=0;i<T;i++){const A=i===T-1,B=C[i],R=A?D:C[i+1],k=6*i,O=M.subarray(k,k+6);p.getAABB3Center(O,F),L[0]=O[0]-F[0],L[1]=O[1]-F[1],L[2]=O[2]-F[2],L[3]=O[3]-F[0],L[4]=O[4]-F[1],L[5]=O[5]-F[2];const N=rt.createPositionsDecodeMatrix(L),j={};for(let M=B;M<R;M++){const C=P[M],A=t.globalizeObjectIds?p.globalizeObjectId(s.id,C):C,T=M===D-1,L=w[M],B=T?b.length:w[M+1],R=[],k=e.metaScene.metaObjects[A],O={},V={};if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;const e=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(O.visible=!1),!1===e.pickable&&(O.pickable=!1),e.colorize&&(V.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(V.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(V.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(V.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=L;e<B;e++){const t=b[e],p=I[t]>1,P=t===E-1,w=Rd(y.subarray(6*e,6*e+3)),M=y[6*e+3]/255,C=y[6*e+4]/255,A=y[6*e+5]/255,D=S++;if(p){const p=x[e],b=h.slice(p,p+16),y="geometry."+i+"."+t;if(!j[y]){let e,i,h,p,v,b;switch(u[t]){case 0:e="solid",i=r.subarray(d[t],P?r.length:d[t+1]),h=o.subarray(f[t],P?o.length:f[t+1]),v=a.subarray(g[t],P?a.length:g[t+1]),b=l.subarray(_[t],P?l.length:_[t+1]);break;case 1:e="surface",i=r.subarray(d[t],P?r.length:d[t+1]),h=o.subarray(f[t],P?o.length:f[t+1]),v=a.subarray(g[t],P?a.length:g[t+1]),b=l.subarray(_[t],P?l.length:_[t+1]);break;case 2:e="points",i=r.subarray(d[t],P?r.length:d[t+1]),p=kd(n.subarray(m[t],P?n.length:m[t+1]));break;case 3:e="lines",i=r.subarray(d[t],P?r.length:d[t+1]),v=a.subarray(g[t],P?a.length:g[t+1]);break;default:continue}s.createGeometry({id:y,primitive:e,positionsCompressed:i,normalsCompressed:h,colors:p,indices:v,edgeIndices:b,positionsDecodeMatrix:c}),j[y]=!0}s.createMesh(v.apply(V,{id:D,geometryId:y,origin:F,matrix:b,color:w,metallic:C,roughness:A,opacity:M})),R.push(D)}else{let e,i,h,c,p,b;switch(u[t]){case 0:e="solid",i=r.subarray(d[t],P?r.length:d[t+1]),h=o.subarray(f[t],P?o.length:f[t+1]),p=a.subarray(g[t],P?a.length:g[t+1]),b=l.subarray(_[t],P?l.length:_[t+1]);break;case 1:e="surface",i=r.subarray(d[t],P?r.length:d[t+1]),h=o.subarray(f[t],P?o.length:f[t+1]),p=a.subarray(g[t],P?a.length:g[t+1]),b=l.subarray(_[t],P?l.length:_[t+1]);break;case 2:e="points",i=r.subarray(d[t],P?r.length:d[t+1]),c=kd(n.subarray(m[t],P?n.length:m[t+1]));break;case 3:e="lines",i=r.subarray(d[t],P?r.length:d[t+1]),p=a.subarray(g[t],P?a.length:g[t+1]);break;default:continue}s.createMesh(v.apply(V,{id:D,origin:F,primitive:e,positionsCompressed:i,normalsCompressed:h,colors:c,indices:p,edgeIndices:b,positionsDecodeMatrix:N,color:w,metallic:C,roughness:A,opacity:M})),R.push(D)}}R.length>0&&s.createEntity(v.apply(O,{id:A,isObject:!0,meshIds:R}))}}}(e,t,o,s)}};let Nd=window.pako||md;Nd.inflate||(Nd=Nd.default);const jd=p.vec4(),Vd=p.vec4();const zd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function Ud(e){const t=[];for(let i=0,s=e.length;i<s;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}const Gd={version:8,parse:function(e,t,i,s){const r=function(e){return{types:e[0],eachMetaObjectId:e[1],eachMetaObjectType:e[2],eachMetaObjectName:e[3],eachMetaObjectParent:e[4],positions:e[5],normals:e[6],colors:e[7],indices:e[8],edgeIndices:e[9],matrices:e[10],reusedGeometriesDecodeMatrix:e[11],eachGeometryPrimitiveType:e[12],eachGeometryPositionsPortion:e[13],eachGeometryNormalsPortion:e[14],eachGeometryColorsPortion:e[15],eachGeometryIndicesPortion:e[16],eachGeometryEdgeIndicesPortion:e[17],eachMeshGeometriesPortion:e[18],eachMeshMatricesPortion:e[19],eachMeshMaterial:e[20],eachEntityMetaObject:e[21],eachEntityMeshesPortion:e[22],eachTileAABB:e[23],eachTileEntitiesPortion:e[24]}}(i),o=function(e){function t(e,t){return 0===e.length?[]:Nd.inflate(e,t).buffer}return{types:Nd.inflate(e.types,{to:"string"}),eachMetaObjectId:Nd.inflate(e.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(t(e.eachMetaObjectType)),eachMetaObjectName:Nd.inflate(e.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(t(e.eachMetaObjectParent)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(t(e.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,i,s){const r=JSON.parse(i.types),o=JSON.parse(i.eachMetaObjectId),n=i.eachMetaObjectType,a=JSON.parse(i.eachMetaObjectName),l=i.eachMetaObjectParent,h=i.positions,c=i.normals,u=i.colors,d=i.indices,f=i.edgeIndices,m=i.matrices,g=i.reusedGeometriesDecodeMatrix,_=i.eachGeometryPrimitiveType,b=i.eachGeometryPositionsPortion,x=i.eachGeometryNormalsPortion,y=i.eachGeometryColorsPortion,P=i.eachGeometryIndicesPortion,w=i.eachGeometryEdgeIndicesPortion,M=i.eachMeshGeometriesPortion,C=i.eachMeshMatricesPortion,E=i.eachMeshMaterial,A=i.eachEntityMetaObject,D=i.eachEntityMeshesPortion,T=i.eachTileAABB,S=i.eachTileEntitiesPortion,I=o.length,F=b.length,L=M.length,B=A.length,R=S.length;let k=0;const O=s.id;if(!e.metaScene.metaModels[O]){const i={metaObjects:[]};for(let e=0;e<I;e++){const t=o[e],s=r[n[e]]||"default",h=a[e],c=l[e],u=c!==e?o[c]:null;i.metaObjects.push({id:t,type:s,name:h,parent:u})}e.metaScene.createMetaModel(O,i,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),s.once("destroyed",(()=>{e.metaScene.destroyMetaModel(O)}))}const N=new Uint32Array(F);for(let e=0;e<L;e++){const t=M[e];void 0!==N[t]?N[t]++:N[t]=1}const j=p.vec3(),V=p.AABB3(),z={};for(let i=0;i<R;i++){const r=i===R-1,n=S[i],a=r?B:S[i+1],l=6*i,I=T.subarray(l,l+6);p.getAABB3Center(I,j),V[0]=I[0]-j[0],V[1]=I[1]-j[1],V[2]=I[2]-j[2],V[3]=I[3]-j[0],V[4]=I[4]-j[1],V[5]=I[5]-j[2];const L=rt.createPositionsDecodeMatrix(V),O={};for(let r=n;r<a;r++){const n=o[A[r]],a=t.globalizeObjectIds?p.globalizeObjectId(s.id,n):n,l=r===B-1,T=D[r],S=l?M.length:D[r+1],I=[],R=e.metaScene.metaObjects[a],U={},G={};if(R){if(t.excludeTypesMap&&R.type&&t.excludeTypesMap[R.type])continue;if(t.includeTypesMap&&R.type&&!t.includeTypesMap[R.type])continue;const e=t.objectDefaults?t.objectDefaults[R.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(U.visible=!1),!1===e.pickable&&(U.pickable=!1),e.colorize&&(G.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(G.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(G.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(G.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=T;e<S;e++){const r=M[e],o=N[r]>1,n=r===F-1,a=zd(E.subarray(6*e,6*e+3)),l=E[6*e+3]/255,A=E[6*e+4]/255,D=E[6*e+5]/255,T=k++;if(o){const o=C[e],M=m.slice(o,o+16),E="geometry."+i+"."+r;let S=z[E];if(!S){S={batchThisMesh:!t.reuseGeometries};let e=!1;switch(_[r]){case 0:S.primitiveName="solid",S.geometryPositions=h.subarray(b[r],n?h.length:b[r+1]),S.geometryNormals=c.subarray(x[r],n?c.length:x[r+1]),S.geometryIndices=d.subarray(P[r],n?d.length:P[r+1]),S.geometryEdgeIndices=f.subarray(w[r],n?f.length:w[r+1]),e=S.geometryPositions.length>0&&S.geometryIndices.length>0;break;case 1:S.primitiveName="surface",S.geometryPositions=h.subarray(b[r],n?h.length:b[r+1]),S.geometryNormals=c.subarray(x[r],n?c.length:x[r+1]),S.geometryIndices=d.subarray(P[r],n?d.length:P[r+1]),S.geometryEdgeIndices=f.subarray(w[r],n?f.length:w[r+1]),e=S.geometryPositions.length>0&&S.geometryIndices.length>0;break;case 2:S.primitiveName="points",S.geometryPositions=h.subarray(b[r],n?h.length:b[r+1]),S.geometryColors=Ud(u.subarray(y[r],n?u.length:y[r+1])),e=S.geometryPositions.length>0;break;case 3:S.primitiveName="lines",S.geometryPositions=h.subarray(b[r],n?h.length:b[r+1]),S.geometryIndices=d.subarray(P[r],n?d.length:P[r+1]),e=S.geometryPositions.length>0&&S.geometryIndices.length>0;break;default:continue}if(e||(S=null),S&&(S.geometryPositions.length,S.batchThisMesh)){S.decompressedPositions=new Float32Array(S.geometryPositions.length);const e=S.geometryPositions,t=S.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*g[0]+g[12],t[i+1]=e[i+1]*g[5]+g[13],t[i+2]=e[i+2]*g[10]+g[14];S.geometryPositions=null,z[E]=S}}if(S)if(S.batchThisMesh){const e=S.decompressedPositions,t=new Uint16Array(e.length);for(let i=0,s=e.length;i<s;i+=3)jd[0]=e[i+0],jd[1]=e[i+1],jd[2]=e[i+2],jd[3]=1,p.transformVec4(M,jd,Vd),rt.compressPosition(Vd,V,jd),t[i+0]=jd[0],t[i+1]=jd[1],t[i+2]=jd[2];s.createMesh(v.apply(G,{id:T,origin:j,primitive:S.primitiveName,positionsCompressed:t,normalsCompressed:S.geometryNormals,colorsCompressed:S.geometryColors,indices:S.geometryIndices,edgeIndices:S.geometryEdgeIndices,positionsDecodeMatrix:L,color:a,metallic:A,roughness:D,opacity:l})),I.push(T)}else O[E]||(s.createGeometry({id:E,primitive:S.primitiveName,positionsCompressed:S.geometryPositions,normalsCompressed:S.geometryNormals,colorsCompressed:S.geometryColors,indices:S.geometryIndices,edgeIndices:S.geometryEdgeIndices,positionsDecodeMatrix:g}),O[E]=!0),s.createMesh(v.apply(G,{id:T,geometryId:E,origin:j,matrix:M,color:a,metallic:A,roughness:D,opacity:l})),I.push(T)}else{let e,t,i,o,p,m,g=!1;switch(_[r]){case 0:e="solid",t=h.subarray(b[r],n?h.length:b[r+1]),i=c.subarray(x[r],n?c.length:x[r+1]),p=d.subarray(P[r],n?d.length:P[r+1]),m=f.subarray(w[r],n?f.length:w[r+1]),g=t.length>0&&p.length>0;break;case 1:e="surface",t=h.subarray(b[r],n?h.length:b[r+1]),i=c.subarray(x[r],n?c.length:x[r+1]),p=d.subarray(P[r],n?d.length:P[r+1]),m=f.subarray(w[r],n?f.length:w[r+1]),g=t.length>0&&p.length>0;break;case 2:e="points",t=h.subarray(b[r],n?h.length:b[r+1]),o=Ud(u.subarray(y[r],n?u.length:y[r+1])),g=t.length>0;break;case 3:e="lines",t=h.subarray(b[r],n?h.length:b[r+1]),p=d.subarray(P[r],n?d.length:P[r+1]),g=t.length>0&&p.length>0;break;default:continue}g&&(s.createMesh(v.apply(G,{id:T,origin:j,primitive:e,positionsCompressed:t,normalsCompressed:i,colorsCompressed:o,indices:p,edgeIndices:m,positionsDecodeMatrix:L,color:a,metallic:A,roughness:D,opacity:l})),I.push(T))}}I.length>0&&s.createEntity(v.apply(U,{id:a,isObject:!0,meshIds:I}))}}}(e,t,o,s)}};let Wd=window.pako||md;Wd.inflate||(Wd=Wd.default);const Hd=p.vec4(),Xd=p.vec4();const Yd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const qd={version:9,parse:function(e,t,i,s){const r=function(e){return{metadata:e[0],positions:e[1],normals:e[2],colors:e[3],indices:e[4],edgeIndices:e[5],matrices:e[6],reusedGeometriesDecodeMatrix:e[7],eachGeometryPrimitiveType:e[8],eachGeometryPositionsPortion:e[9],eachGeometryNormalsPortion:e[10],eachGeometryColorsPortion:e[11],eachGeometryIndicesPortion:e[12],eachGeometryEdgeIndicesPortion:e[13],eachMeshGeometriesPortion:e[14],eachMeshMatricesPortion:e[15],eachMeshMaterial:e[16],eachEntityId:e[17],eachEntityMeshesPortion:e[18],eachTileAABB:e[19],eachTileEntitiesPortion:e[20]}}(i),o=function(e){function t(e,t){return 0===e.length?[]:Wd.inflate(e,t).buffer}return{metadata:JSON.parse(Wd.inflate(e.metadata,{to:"string"})),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:JSON.parse(Wd.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,i,s){const r=i.metadata,o=i.positions,n=i.normals,a=i.colors,l=i.indices,h=i.edgeIndices,c=i.matrices,u=i.reusedGeometriesDecodeMatrix,d=i.eachGeometryPrimitiveType,f=i.eachGeometryPositionsPortion,m=i.eachGeometryNormalsPortion,g=i.eachGeometryColorsPortion,_=i.eachGeometryIndicesPortion,b=i.eachGeometryEdgeIndicesPortion,x=i.eachMeshGeometriesPortion,y=i.eachMeshMatricesPortion,P=i.eachMeshMaterial,w=i.eachEntityId,M=i.eachEntityMeshesPortion,C=i.eachTileAABB,E=i.eachTileEntitiesPortion,A=f.length,D=x.length,T=M.length,S=E.length;let I=0;const F=s.id;e.metaScene.metaModels[F]||(e.metaScene.createMetaModel(F,r,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),s.once("destroyed",(()=>{e.metaScene.destroyMetaModel(F)})));const L=new Uint32Array(A);for(let e=0;e<D;e++){const t=x[e];void 0!==L[t]?L[t]++:L[t]=1}const B=p.vec3(),R=p.AABB3(),k={};for(let i=0;i<S;i++){const r=i===S-1,D=E[i],F=r?T-1:E[i+1]-1,O=6*i,N=C.subarray(O,O+6);p.getAABB3Center(N,B),R[0]=N[0]-B[0],R[1]=N[1]-B[1],R[2]=N[2]-B[2],R[3]=N[3]-B[0],R[4]=N[4]-B[1],R[5]=N[5]-B[2];const j=rt.createPositionsDecodeMatrix(R),V={};for(let r=D;r<=F;r++){const C=w[r],E=t.globalizeObjectIds?p.globalizeObjectId(s.id,C):C,D=r===T-1,S=M[r],F=D?x.length-1:M[r+1]-1,O=[],N=e.metaScene.metaObjects[E],z={},U={};if(N){if(t.excludeTypesMap&&N.type&&t.excludeTypesMap[N.type])continue;if(t.includeTypesMap&&N.type&&!t.includeTypesMap[N.type])continue;const e=t.objectDefaults?t.objectDefaults[N.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(z.visible=!1),!1===e.pickable&&(z.pickable=!1),e.colorize&&(U.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(U.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(U.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(U.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=S;e<=F;e++){const r=x[e],w=L[r]>1,M=r===A-1,C=Yd(P.subarray(6*e,6*e+3)),E=P[6*e+3]/255,D=P[6*e+4]/255,T=P[6*e+5]/255,S=I++;if(w){const x=y[e],P=c.slice(x,x+16),w="geometry."+i+"."+r;let A=k[w];if(!A){A={batchThisMesh:!t.reuseGeometries};let e=!1;switch(d[r]){case 0:A.primitiveName="solid",A.geometryPositions=o.subarray(f[r],M?o.length:f[r+1]),A.geometryNormals=n.subarray(m[r],M?n.length:m[r+1]),A.geometryIndices=l.subarray(_[r],M?l.length:_[r+1]),A.geometryEdgeIndices=h.subarray(b[r],M?h.length:b[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;case 1:A.primitiveName="surface",A.geometryPositions=o.subarray(f[r],M?o.length:f[r+1]),A.geometryNormals=n.subarray(m[r],M?n.length:m[r+1]),A.geometryIndices=l.subarray(_[r],M?l.length:_[r+1]),A.geometryEdgeIndices=h.subarray(b[r],M?h.length:b[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;case 2:A.primitiveName="points",A.geometryPositions=o.subarray(f[r],M?o.length:f[r+1]),A.geometryColors=a.subarray(g[r],M?a.length:g[r+1]),e=A.geometryPositions.length>0;break;case 3:A.primitiveName="lines",A.geometryPositions=o.subarray(f[r],M?o.length:f[r+1]),A.geometryIndices=l.subarray(_[r],M?l.length:_[r+1]),e=A.geometryPositions.length>0&&A.geometryIndices.length>0;break;default:continue}if(e||(A=null),A&&(A.geometryPositions.length,A.batchThisMesh)){A.decompressedPositions=new Float32Array(A.geometryPositions.length),A.transformedAndRecompressedPositions=new Uint16Array(A.geometryPositions.length);const e=A.geometryPositions,t=A.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*u[0]+u[12],t[i+1]=e[i+1]*u[5]+u[13],t[i+2]=e[i+2]*u[10]+u[14];A.geometryPositions=null,k[w]=A}}if(A)if(A.batchThisMesh){const e=A.decompressedPositions,t=A.transformedAndRecompressedPositions;for(let i=0,s=e.length;i<s;i+=3)Hd[0]=e[i+0],Hd[1]=e[i+1],Hd[2]=e[i+2],Hd[3]=1,p.transformVec4(P,Hd,Xd),rt.compressPosition(Xd,R,Hd),t[i+0]=Hd[0],t[i+1]=Hd[1],t[i+2]=Hd[2];s.createMesh(v.apply(U,{id:S,origin:B,primitive:A.primitiveName,positionsCompressed:t,normalsCompressed:A.geometryNormals,colorsCompressed:A.geometryColors,indices:A.geometryIndices,edgeIndices:A.geometryEdgeIndices,positionsDecodeMatrix:j,color:C,metallic:D,roughness:T,opacity:E})),O.push(S)}else V[w]||(s.createGeometry({id:w,primitive:A.primitiveName,positionsCompressed:A.geometryPositions,normalsCompressed:A.geometryNormals,colorsCompressed:A.geometryColors,indices:A.geometryIndices,edgeIndices:A.geometryEdgeIndices,positionsDecodeMatrix:u}),V[w]=!0),s.createMesh(v.apply(U,{id:S,geometryId:w,origin:B,matrix:P,color:C,metallic:D,roughness:T,opacity:E})),O.push(S)}else{let e,t,i,c,u,p,x=!1;switch(d[r]){case 0:e="solid",t=o.subarray(f[r],M?o.length:f[r+1]),i=n.subarray(m[r],M?n.length:m[r+1]),u=l.subarray(_[r],M?l.length:_[r+1]),p=h.subarray(b[r],M?h.length:b[r+1]),x=t.length>0&&u.length>0;break;case 1:e="surface",t=o.subarray(f[r],M?o.length:f[r+1]),i=n.subarray(m[r],M?n.length:m[r+1]),u=l.subarray(_[r],M?l.length:_[r+1]),p=h.subarray(b[r],M?h.length:b[r+1]),x=t.length>0&&u.length>0;break;case 2:e="points",t=o.subarray(f[r],M?o.length:f[r+1]),c=a.subarray(g[r],M?a.length:g[r+1]),x=t.length>0;break;case 3:e="lines",t=o.subarray(f[r],M?o.length:f[r+1]),u=l.subarray(_[r],M?l.length:_[r+1]),x=t.length>0&&u.length>0;break;default:continue}x&&(s.createMesh(v.apply(U,{id:S,origin:B,primitive:e,positionsCompressed:t,normalsCompressed:i,colorsCompressed:c,indices:u,edgeIndices:p,positionsDecodeMatrix:j,color:C,metallic:D,roughness:T,opacity:E})),O.push(S))}}O.length>0&&s.createEntity(v.apply(z,{id:E,isObject:!0,meshIds:O}))}}}(e,t,o,s)}};let $d=window.pako||md;$d.inflate||($d=$d.default);const Zd=p.vec4(),Kd=p.vec4();const Qd=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();!function(){const e=document.createElement("canvas"),t=e.getContext("2d")}();const Jd={version:10,parse:function(e,t,i,s){const r=function(e){let t=0;return{metadata:e[t++],textureData:e[t++],eachTextureDataPortion:e[t++],eachTextureAttributes:e[t++],positions:e[t++],normals:e[t++],colors:e[t++],uvs:e[t++],indices:e[t++],edgeIndices:e[t++],eachTextureSetTextures:e[t++],matrices:e[t++],reusedGeometriesDecodeMatrix:e[t++],eachGeometryPrimitiveType:e[t++],eachGeometryPositionsPortion:e[t++],eachGeometryNormalsPortion:e[t++],eachGeometryColorsPortion:e[t++],eachGeometryUVsPortion:e[t++],eachGeometryIndicesPortion:e[t++],eachGeometryEdgeIndicesPortion:e[t++],eachMeshGeometriesPortion:e[t++],eachMeshMatricesPortion:e[t++],eachMeshTextureSet:e[t++],eachMeshMaterialAttributes:e[t++],eachEntityId:e[t++],eachEntityMeshesPortion:e[t++],eachTileAABB:e[t++],eachTileEntitiesPortion:e[t++]}}(i),o=function(e){function t(e,t){return 0===e.length?[]:$d.inflate(e,t).buffer}return{metadata:JSON.parse($d.inflate(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(t(e.eachTextureAttributes)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(t(e.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachEntityId:JSON.parse($d.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(r);!function(e,t,i,s){const r=i.metadata,o=i.textureData,n=i.eachTextureDataPortion,a=i.eachTextureAttributes,l=i.positions,h=i.normals,c=i.colors,u=i.uvs,d=i.indices,f=i.edgeIndices,m=i.eachTextureSetTextures,g=i.matrices,_=i.reusedGeometriesDecodeMatrix,b=i.eachGeometryPrimitiveType,x=i.eachGeometryPositionsPortion,y=i.eachGeometryNormalsPortion,P=i.eachGeometryColorsPortion,w=i.eachGeometryUVsPortion,M=i.eachGeometryIndicesPortion,C=i.eachGeometryEdgeIndicesPortion,E=i.eachMeshGeometriesPortion,A=i.eachMeshMatricesPortion,D=i.eachMeshTextureSet,T=i.eachMeshMaterialAttributes,S=i.eachEntityId,I=i.eachEntityMeshesPortion,F=i.eachTileAABB,L=i.eachTileEntitiesPortion,B=n.length,R=m.length/5,k=x.length,O=E.length,N=I.length,j=L.length;let V=0;const z=s.id;e.metaScene.metaModels[z]||(e.metaScene.createMetaModel(z,r,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds}),s.once("destroyed",(()=>{e.metaScene.destroyMetaModel(z)})));for(let e=0;e<B;e++){const t=e===B-1,i=n[e],r=t?o.length:n[e+1],l=r-i>0,h=9*e,c=1===a[h+0],u=a[h+1];a[h+2],a[h+3];const d=a[h+4],p=a[h+5],f=a[h+6],m=a[h+7],g=a[h+8];if(l){const t=new Uint8Array(o.subarray(i,r)).buffer,n=`texture-${e}`;if(c)s.createTexture({id:n,buffers:[t],minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g});else{const e=new Blob([t],{type:10001===u?"image/jpeg":10002===u?"image/png":"image/gif"}),i=(window.URL||window.webkitURL).createObjectURL(e),r=document.createElement("img");r.src=i,s.createTexture({id:n,image:r,minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g})}}}for(let e=0;e<R;e++){const t=5*e,i=`textureSet-${e}`,r=m[t+0],o=m[t+1],n=m[t+2],a=m[t+3],l=m[t+4];s.createTextureSet({id:i,colorTextureId:r>=0?`texture-${r}`:null,normalsTextureId:n>=0?`texture-${n}`:null,metallicRoughnessTextureId:o>=0?`texture-${o}`:null,emissiveTextureId:a>=0?`texture-${a}`:null,occlusionTextureId:l>=0?`texture-${l}`:null})}const U=new Uint32Array(k);for(let e=0;e<O;e++){const t=E[e];void 0!==U[t]?U[t]++:U[t]=1}const G=p.vec3(),W=p.AABB3(),H={};for(let i=0;i<j;i++){const r=i===j-1,o=L[i],n=r?N-1:L[i+1]-1,a=6*i,m=F.subarray(a,a+6);p.getAABB3Center(m,G),W[0]=m[0]-G[0],W[1]=m[1]-G[1],W[2]=m[2]-G[2],W[3]=m[3]-G[0],W[4]=m[4]-G[1],W[5]=m[5]-G[2];const B=rt.createPositionsDecodeMatrix(W),R={};for(let r=o;r<=n;r++){const o=S[r],n=t.globalizeObjectIds?p.globalizeObjectId(s.id,o):o,a=r===N-1,m=I[r],F=a?E.length-1:I[r+1]-1,L=[],O=e.metaScene.metaObjects[n],j={},z={};if(O){if(t.excludeTypesMap&&O.type&&t.excludeTypesMap[O.type])continue;if(t.includeTypesMap&&O.type&&!t.includeTypesMap[O.type])continue;const e=t.objectDefaults?t.objectDefaults[O.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(j.visible=!1),!1===e.pickable&&(j.pickable=!1),e.colorize&&(z.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(z.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(z.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(z.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=m;e<=F;e++){const r=E[e],o=U[r]>1,n=r===k-1,a=D[e],m=a>=0?`textureSet-${a}`:null,S=Qd(T.subarray(6*e,6*e+3)),I=T[6*e+3]/255,F=T[6*e+4]/255,O=T[6*e+5]/255,N=V++;if(o){const o=A[e],a=g.slice(o,o+16),E="geometry."+i+"."+r;let D=H[E];if(!D){D={batchThisMesh:!t.reuseGeometries};let e=!1;switch(b[r]){case 0:D.primitiveName="solid",D.geometryPositions=l.subarray(x[r],n?l.length:x[r+1]),D.geometryNormals=h.subarray(y[r],n?h.length:y[r+1]),D.geometryUVs=u.subarray(w[r],n?u.length:w[r+1]),D.geometryIndices=d.subarray(M[r],n?d.length:M[r+1]),D.geometryEdgeIndices=f.subarray(C[r],n?f.length:C[r+1]),e=D.geometryPositions.length>0&&D.geometryIndices.length>0;break;case 1:D.primitiveName="surface",D.geometryPositions=l.subarray(x[r],n?l.length:x[r+1]),D.geometryNormals=h.subarray(y[r],n?h.length:y[r+1]),D.geometryUVs=u.subarray(w[r],n?u.length:w[r+1]),D.geometryIndices=d.subarray(M[r],n?d.length:M[r+1]),D.geometryEdgeIndices=f.subarray(C[r],n?f.length:C[r+1]),e=D.geometryPositions.length>0&&D.geometryIndices.length>0;break;case 2:D.primitiveName="points",D.geometryPositions=l.subarray(x[r],n?l.length:x[r+1]),D.geometryColors=c.subarray(P[r],n?c.length:P[r+1]),e=D.geometryPositions.length>0;break;case 3:D.primitiveName="lines",D.geometryPositions=l.subarray(x[r],n?l.length:x[r+1]),D.geometryIndices=d.subarray(M[r],n?d.length:M[r+1]),e=D.geometryPositions.length>0&&D.geometryIndices.length>0;break;default:continue}if(e||(D=null),D&&(D.geometryPositions.length,D.batchThisMesh)){D.decompressedPositions=new Float32Array(D.geometryPositions.length),D.transformedAndRecompressedPositions=new Uint16Array(D.geometryPositions.length);const e=D.geometryPositions,t=D.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*_[0]+_[12],t[i+1]=e[i+1]*_[5]+_[13],t[i+2]=e[i+2]*_[10]+_[14];D.geometryPositions=null,H[E]=D}}if(D)if(D.batchThisMesh){const e=D.decompressedPositions,t=D.transformedAndRecompressedPositions;for(let i=0,s=e.length;i<s;i+=3)Zd[0]=e[i+0],Zd[1]=e[i+1],Zd[2]=e[i+2],Zd[3]=1,p.transformVec4(a,Zd,Kd),rt.compressPosition(Kd,W,Zd),t[i+0]=Zd[0],t[i+1]=Zd[1],t[i+2]=Zd[2];s.createMesh(v.apply(z,{id:N,textureSetId:m,origin:G,primitive:D.primitiveName,positionsCompressed:t,normalsCompressed:D.geometryNormals,uv:D.geometryUVs,colorsCompressed:D.geometryColors,indices:D.geometryIndices,edgeIndices:D.geometryEdgeIndices,positionsDecodeMatrix:B,color:S,metallic:F,roughness:O,opacity:I})),L.push(N)}else R[E]||(s.createGeometry({id:E,primitive:D.primitiveName,positionsCompressed:D.geometryPositions,normalsCompressed:D.geometryNormals,uv:D.geometryUVs,colorsCompressed:D.geometryColors,indices:D.geometryIndices,edgeIndices:D.geometryEdgeIndices,positionsDecodeMatrix:_}),R[E]=!0),s.createMesh(v.apply(z,{id:N,geometryId:E,textureSetId:m,matrix:a,color:S,metallic:F,roughness:O,opacity:I,origin:G})),L.push(N)}else{let e,t,i,o,a,p,g,_=!1;switch(b[r]){case 0:e="solid",t=l.subarray(x[r],n?l.length:x[r+1]),i=h.subarray(y[r],n?h.length:y[r+1]),o=u.subarray(w[r],n?u.length:w[r+1]),p=d.subarray(M[r],n?d.length:M[r+1]),g=f.subarray(C[r],n?f.length:C[r+1]),_=t.length>0&&p.length>0;break;case 1:e="surface",t=l.subarray(x[r],n?l.length:x[r+1]),i=h.subarray(y[r],n?h.length:y[r+1]),o=u.subarray(w[r],n?u.length:w[r+1]),p=d.subarray(M[r],n?d.length:M[r+1]),g=f.subarray(C[r],n?f.length:C[r+1]),_=t.length>0&&p.length>0;break;case 2:e="points",t=l.subarray(x[r],n?l.length:x[r+1]),a=c.subarray(P[r],n?c.length:P[r+1]),_=t.length>0;break;case 3:e="lines",t=l.subarray(x[r],n?l.length:x[r+1]),p=d.subarray(M[r],n?d.length:M[r+1]),_=t.length>0&&p.length>0;break;default:continue}_&&(s.createMesh(v.apply(z,{id:N,textureSetId:m,origin:G,primitive:e,positionsCompressed:t,normalsCompressed:i,uv:o&&o.length>0?o:null,colorsCompressed:a,indices:p,edgeIndices:g,positionsDecodeMatrix:B,color:S,metallic:F,roughness:O,opacity:I})),L.push(N))}}L.length>0&&s.createEntity(v.apply(j,{id:n,isObject:!0,meshIds:L}))}}}(e,t,o,s)}},ep={};ep[vd.version]=vd,ep[yd.version]=yd,ep[Md.version]=Md,ep[Ad.version]=Ad,ep[Sd.version]=Sd,ep[Ld.version]=Ld,ep[Od.version]=Od,ep[Gd.version]=Gd,ep[qd.version]=qd,ep[Jd.version]=Jd;class tp extends a{constructor(e,t={}){super("XKTLoader",e,t),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this.textureTranscoder=t.textureTranscoder,this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults,this.includeTypes=t.includeTypes,this.excludeTypes=t.excludeTypes,this.excludeUnclassifiedObjects=t.excludeUnclassifiedObjects,this.reuseGeometries=t.reuseGeometries}get supportedVersions(){return Object.keys(ep)}get textureTranscoder(){return this._textureTranscoder}set textureTranscoder(e){this._textureTranscoder=e}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new fd}get objectDefaults(){return this._objectDefaults}set objectDefaults(e){this._objectDefaults=e||td}get includeTypes(){return this._includeTypes}set includeTypes(e){this._includeTypes=e}get excludeTypes(){return this._excludeTypes}set excludeTypes(e){this._excludeTypes=e}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(e){this._excludeUnclassifiedObjects=!!e}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(e){this._globalizeObjectIds=!!e}get reuseGeometries(){return this._reuseGeometries}set reuseGeometries(e){this._reuseGeometries=!1!==e}load(e={}){let t;e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id),t=e.useDataTextures?new Ji(this.viewer.scene,v.apply(e,{isModel:!0,origin:e.origin,targetLodFps:e.useDataTextures.targetLodFps||!1,enableViewFrustumCulling:e.useDataTextures.enableViewFrustumCulling||!1,disableVertexWelding:e.useDataTextures.disableVertexWelding||!1,disableIndexRebucketing:e.useDataTextures.disableIndexRebucketing||!1})):new qh(this.viewer.scene,v.apply(e,{isModel:!0,textureTranscoder:this._textureTranscoder,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:e.origin}));const i=t.id;if(!e.src&&!e.xkt)return this.error("load() param expected: src or xkt"),t;const s={},r=e.includeTypes||this._includeTypes,o=e.excludeTypes||this._excludeTypes,n=e.objectDefaults||this._objectDefaults;if(s.reuseGeometries=null!==e.reuseGeometries&&void 0!==e.reuseGeometries?e.reuseGeometries:!1!==this._reuseGeometries,r){s.includeTypesMap={};for(let e=0,t=r.length;e<t;e++)s.includeTypesMap[r[e]]=!0}if(o){s.excludeTypesMap={};for(let e=0,t=o.length;e<t;e++)s.excludeTypesMap[o[e]]=!0}if(n&&(s.objectDefaults=n),s.excludeUnclassifiedObjects=void 0!==e.excludeUnclassifiedObjects?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,s.globalizeObjectIds=void 0!==e.globalizeObjectIds&&null!==e.globalizeObjectIds?!!e.globalizeObjectIds:this._globalizeObjectIds,e.metaModelSrc||e.metaModelData){const n=n=>!!this.viewer.metaScene.createMetaModel(i,n,{includeTypes:r,excludeTypes:o,globalizeObjectIds:s.globalizeObjectIds})&&(e.src?this._loadModel(e.src,e,s,t):this._parseModel(e.xkt,e,s,t),t.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(t.id)})),!0);if(e.metaModelSrc){const s=e.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(s,(e=>{t.destroyed||(n(e)||(this.error(`load(): Failed to load model metadata for model '${i} from '${s}' - metadata not valid`),t.fire("error","Metadata not valid")),this.viewer.scene.canvas.spinner.processes--)}),(e=>{this.error(`load(): Failed to load model metadata for model '${i} from  '${s}' - ${e}`),t.fire("error",`Failed to load model metadata from  '${s}' - ${e}`),this.viewer.scene.canvas.spinner.processes--}))}else e.metaModelData&&(n(e.metaModelData)||(this.error(`load(): Failed to load model metadata for model '${i} from '${e.metaModelSrc}' - metadata not valid`),t.fire("error","Metadata not valid")))}else e.src?this._loadModel(e.src,e,s,t):this._parseModel(e.xkt,e,s,t);return t}_loadModel(e,t,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getXKT(t.src,(e=>{this._parseModel(e,t,i,s),r.processes--}),(e=>{r.processes--,this.error(e),s.fire("error",e)}))}_parseModel(e,t,i,s){if(s.destroyed)return;const r=new DataView(e),o=new Uint8Array(e),n=r.getUint32(0,!0),a=ep[n];if(!a)return void this.error("Unsupported .XKT file version: "+n+" - this XKTLoaderPlugin supports versions "+Object.keys(ep));this.log("Loading .xkt V"+n);const l=r.getUint32(4,!0),h=[];let c=4*(l+2);for(let e=0;e<l;e++){const t=r.getUint32(4*(e+2),!0);h.push(o.subarray(c,c+t)),c+=t}a.parse(this.viewer,i,h,s),s.finalize(),this._createDefaultMetaModelIfNeeded(s,t,i),s.scene.once("tick",(()=>{s.destroyed||(s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!1))}))}_createDefaultMetaModelIfNeeded(e,t,i){const s=e.id;if(!this.viewer.metaScene.metaModels[s]){const r={metaObjects:[]};r.metaObjects.push({id:s,type:"default",name:s,parent:null});const o=e.entityList;for(let e=0,t=o.length;e<t;e++){const t=o[e];t.isObject&&r.metaObjects.push({id:t.id,type:"default",name:t.id,parent:s})}const n=t.src;this.viewer.metaScene.createMetaModel(s,r,{includeTypes:i.includeTypes,excludeTypes:i.excludeTypes,globalizeObjectIds:i.globalizeObjectIds,getProperties:async e=>await this._dataSource.getProperties(n,e)}),e.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(s)}))}}}var ip={};!function(e){var t,i="File format is not recognized.",s="Error while reading zip file.",r="Error while reading file data.",o=524288,n="text/plain";try{t=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function a(){this.crc=-1}function l(){}function h(e,t){var i,s;return i=new ArrayBuffer(e),s=new Uint8Array(i),t&&s.set(t,0),{buffer:i,array:s,view:new DataView(i)}}function c(){}function u(e){var t,i=this;i.size=0,i.init=function(s,r){var o=new Blob([e],{type:n});(t=new p(o)).init((function(){i.size=t.size,s()}),r)},i.readUint8Array=function(e,i,s,r){t.readUint8Array(e,i,s,r)}}function d(t){var i,s=this;s.size=0,s.init=function(e){for(var r=t.length;"="==t.charAt(r-1);)r--;i=t.indexOf(",")+1,s.size=Math.floor(.75*(r-i)),e()},s.readUint8Array=function(s,r,o){var n,a=h(r),l=4*Math.floor(s/3),c=4*Math.ceil((s+r)/3),u=e.atob(t.substring(l+i,c+i)),d=s-3*Math.floor(l/4);for(n=d;n<d+r;n++)a.array[n-d]=u.charCodeAt(n);o(a.array)}}function p(e){var t=this;t.size=0,t.init=function(i){t.size=e.size,i()},t.readUint8Array=function(t,i,s,r){var o=new FileReader;o.onload=function(e){s(new Uint8Array(e.target.result))},o.onerror=r;try{o.readAsArrayBuffer(function(e,t,i){if(t<0||i<0||t+i>e.size)throw new RangeError("offset:"+t+", length:"+i+", size:"+e.size);return e.slice?e.slice(t,t+i):e.webkitSlice?e.webkitSlice(t,t+i):e.mozSlice?e.mozSlice(t,t+i):e.msSlice?e.msSlice(t,t+i):void 0}(e,t,i))}catch(e){r(e)}}}function f(){}function m(e){var i,s=this;s.init=function(e){i=new Blob([],{type:n}),e()},s.writeUint8Array=function(e,s){i=new Blob([i,t?e:e.buffer],{type:n}),s()},s.getData=function(t,s){var r=new FileReader;r.onload=function(e){t(e.target.result)},r.onerror=s,r.readAsText(i,e)}}function g(t){var i=this,s="",r="";i.init=function(e){s+="data:"+(t||"")+";base64,",e()},i.writeUint8Array=function(t,i){var o,n=r.length,a=r;for(r="",o=0;o<3*Math.floor((n+t.length)/3)-n;o++)a+=String.fromCharCode(t[o]);for(;o<t.length;o++)r+=String.fromCharCode(t[o]);a.length>2?s+=e.btoa(a):r=a,i()},i.getData=function(t){t(s+e.btoa(r))}}function _(e){var i,s=this;s.init=function(t){i=new Blob([],{type:e}),t()},s.writeUint8Array=function(s,r){i=new Blob([i,t?s:s.buffer],{type:e}),r()},s.getData=function(e){e(i)}}function v(e,t,i,s,r,n,a,l,h,c){var u,d,p,f=0,m=t.sn;function g(){e.removeEventListener("message",_,!1),l(d,p)}function _(t){var i=t.data,r=i.data,o=i.error;if(o)return o.toString=function(){return"Error: "+this.message},void h(o);if(i.sn===m)switch("number"==typeof i.codecTime&&(e.codecTime+=i.codecTime),"number"==typeof i.crcTime&&(e.crcTime+=i.crcTime),i.type){case"append":r?(d+=r.length,s.writeUint8Array(r,(function(){v()}),c)):v();break;case"flush":p=i.crc,r?(d+=r.length,s.writeUint8Array(r,(function(){g()}),c)):g();break;case"progress":a&&a(u+i.loaded,n);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",i)}}function v(){(u=f*o)<=n?i.readUint8Array(r+u,Math.min(o,n-u),(function(i){a&&a(u,n);var s=0===u?t:{sn:m};s.type="append",s.data=i;try{e.postMessage(s,[i.buffer])}catch(t){e.postMessage(s)}f++}),h):e.postMessage({sn:m,type:"flush"})}d=0,e.addEventListener("message",_,!1),v()}function b(e,t,i,s,r,n,l,h,c,u){var d,p=0,f=0,m="input"===n,g="output"===n,_=new a;!function n(){var a;if((d=p*o)<r)t.readUint8Array(s+d,Math.min(o,r-d),(function(t){var s;try{s=e.append(t,(function(e){l&&l(d+e,r)}))}catch(e){return void c(e)}s?(f+=s.length,i.writeUint8Array(s,(function(){p++,setTimeout(n,1)}),u),g&&_.append(s)):(p++,setTimeout(n,1)),m&&_.append(t),l&&l(d,r)}),c);else{try{a=e.flush()}catch(e){return void c(e)}a?(g&&_.append(a),f+=a.length,i.writeUint8Array(a,(function(){h(f,_.get())}),u)):h(f,_.get())}}()}function x(t,i,s,r,o,n,a,h,c,u,d){var p="input";e.zip.useWebWorkers&&a?v(t,{sn:i,codecClass:"NOOP",crcType:p},s,r,o,n,c,h,u,d):b(new l,s,r,o,n,p,c,h,u,d)}function y(e){var t,i,s="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)s+=(i=255&e.charCodeAt(t))>127?r[i-128]:String.fromCharCode(i);return s}function P(e){return decodeURIComponent(escape(e))}function w(e){var t,i="";for(t=0;t<e.length;t++)i+=String.fromCharCode(e[t]);return i}function M(e,t,i,s,r){e.version=t.view.getUint16(i,!0),e.bitFlag=t.view.getUint16(i+2,!0),e.compressionMethod=t.view.getUint16(i+4,!0),e.lastModDateRaw=t.view.getUint32(i+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,i=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&i)>>11,(2016&i)>>5,2*(31&i),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?((s||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(i+10,!0),e.compressedSize=t.view.getUint32(i+14,!0),e.uncompressedSize=t.view.getUint32(i+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(i+22,!0),e.extraFieldLength=t.view.getUint16(i+24,!0)):r("File is using Zip64 (4gb+ file size).")):r("File contains encrypted entry.")}function C(t,o,n){var a=0;function l(){}l.prototype.getData=function(s,o,l,c){var u=this;function d(e,t){c&&!function(e){var t=h(4);return t.view.setUint32(0,e),u.crc32==t.view.getUint32(0)}(t)?n("CRC failed."):s.getData((function(e){o(e)}))}function p(e){n(e||r)}function f(e){n(e||"Error while writing file data.")}t.readUint8Array(u.offset,30,(function(r){var o,m=h(r.length,r);1347093252==m.view.getUint32(0)?(M(u,m,4,!1,n),o=u.offset+30+u.filenameLength+u.extraFieldLength,s.init((function(){0===u.compressionMethod?x(u._worker,a++,t,s,o,u.compressedSize,c,d,l,p,f):function(t,i,s,r,o,n,a,l,h,c,u){var d=a?"output":"none";e.zip.useWebWorkers?v(t,{sn:i,codecClass:"Inflater",crcType:d},s,r,o,n,h,l,c,u):b(new e.zip.Inflater,s,r,o,n,d,h,l,c,u)}(u._worker,a++,t,s,o,u.compressedSize,c,d,l,p,f)}),f)):n(i)}),p)};var c={getEntries:function(e){var r=this._worker;!function(e){t.size<22?n(i):r(22,(function(){r(Math.min(65558,t.size),(function(){n(i)}))}));function r(i,r){t.readUint8Array(t.size-i,i,(function(t){for(var i=t.length-22;i>=0;i--)if(80===t[i]&&75===t[i+1]&&5===t[i+2]&&6===t[i+3])return void e(new DataView(t.buffer,i,22));r()}),(function(){n(s)}))}}((function(o){var a,c;a=o.getUint32(16,!0),c=o.getUint16(8,!0),a<0||a>=t.size?n(i):t.readUint8Array(a,t.size-a,(function(t){var s,o,a,u,d=0,p=[],f=h(t.length,t);for(s=0;s<c;s++){if((o=new l)._worker=r,1347092738!=f.view.getUint32(d))return void n(i);M(o,f,d+6,!0,n),o.commentLength=f.view.getUint16(d+32,!0),o.directory=16==(16&f.view.getUint8(d+38)),o.offset=f.view.getUint32(d+42,!0),a=w(f.array.subarray(d+46,d+46+o.filenameLength)),o.filename=2048==(2048&o.bitFlag)?P(a):y(a),o.directory||"/"!=o.filename.charAt(o.filename.length-1)||(o.directory=!0),u=w(f.array.subarray(d+46+o.filenameLength+o.extraFieldLength,d+46+o.filenameLength+o.extraFieldLength+o.commentLength)),o.comment=2048==(2048&o.bitFlag)?P(u):y(u),p.push(o),d+=46+o.filenameLength+o.extraFieldLength+o.commentLength}e(p)}),(function(){n(s)}))}))},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};e.zip.useWebWorkers?S("inflater",(function(e){c._worker=e,o(c)}),(function(e){n(e)})):o(c)}function E(e){return unescape(encodeURIComponent(e))}function A(e){var t,i=[];for(t=0;t<e.length;t++)i.push(e.charCodeAt(t));return i}function D(t,i,s,o){var n={},a=[],l=0,c=0;function u(e){s(e||"Error while writing zip file.")}function d(e){s(e||r)}var p={add:function(i,r,p,f,m){var g,_,y,P=this._worker;function w(e,i){var s=h(16);l+=e||0,s.view.setUint32(0,1347094280),void 0!==i&&(g.view.setUint32(10,i,!0),s.view.setUint32(4,i,!0)),r&&(s.view.setUint32(8,e,!0),g.view.setUint32(14,e,!0),s.view.setUint32(12,r.size,!0),g.view.setUint32(18,r.size,!0)),t.writeUint8Array(s.array,(function(){l+=16,p()}),u)}function M(){m=m||{},i=i.trim(),m.directory&&"/"!=i.charAt(i.length-1)&&(i+="/"),n.hasOwnProperty(i)?s("File already exists."):(_=A(E(i)),a.push(i),function(e){var s;y=m.lastModDate||new Date,g=h(26),n[i]={headerArray:g.array,directory:m.directory,filename:_,offset:l,comment:A(E(m.comment||""))},g.view.setUint32(0,335546376),m.version&&g.view.setUint8(0,m.version),o||0===m.level||m.directory||g.view.setUint16(4,2048),g.view.setUint16(6,(y.getHours()<<6|y.getMinutes())<<5|y.getSeconds()/2,!0),g.view.setUint16(8,(y.getFullYear()-1980<<4|y.getMonth()+1)<<5|y.getDate(),!0),g.view.setUint16(22,_.length,!0),(s=h(30+_.length)).view.setUint32(0,1347093252),s.array.set(g.array,4),s.array.set(_,30),l+=s.array.length,t.writeUint8Array(s.array,e,u)}((function(){r?o||0===m.level?x(P,c++,r,t,0,r.size,!0,w,f,d,u):function(t,i,s,r,o,n,a,l,h){var c="input";e.zip.useWebWorkers?v(t,{sn:i,options:{level:o},codecClass:"Deflater",crcType:c},s,r,0,s.size,a,n,l,h):b(new e.zip.Deflater,s,r,0,s.size,c,a,n,l,h)}(P,c++,r,t,m.level,w,f,d,u):w()})))}r?r.init(M,d):M()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var i,s,r,o=0,c=0;for(s=0;s<a.length;s++)o+=46+(r=n[a[s]]).filename.length+r.comment.length;for(i=h(o+22),s=0;s<a.length;s++)r=n[a[s]],i.view.setUint32(c,1347092738),i.view.setUint16(c+4,5120),i.array.set(r.headerArray,c+6),i.view.setUint16(c+32,r.comment.length,!0),r.directory&&i.view.setUint8(c+38,16),i.view.setUint32(c+42,r.offset,!0),i.array.set(r.filename,c+46),i.array.set(r.comment,c+46+r.filename.length),c+=46+r.filename.length+r.comment.length;i.view.setUint32(c,1347093766),i.view.setUint16(c+8,a.length,!0),i.view.setUint16(c+10,a.length,!0),i.view.setUint32(c+12,o,!0),i.view.setUint32(c+16,l,!0),t.writeUint8Array(i.array,(function(){t.getData(e)}),u)},_worker:null};e.zip.useWebWorkers?S("deflater",(function(e){p._worker=e,i(p)}),(function(e){s(e)})):i(p)}a.prototype.append=function(e){for(var t=0|this.crc,i=this.table,s=0,r=0|e.length;s<r;s++)t=t>>>8^i[255&(t^e[s])];this.crc=t},a.prototype.get=function(){return~this.crc},a.prototype.table=function(){var e,t,i,s=[];for(e=0;e<256;e++){for(i=e,t=0;t<8;t++)1&i?i=i>>>1^3988292384:i>>>=1;s[e]=i}return s}(),l.prototype.append=function(e,t){return e},l.prototype.flush=function(){},u.prototype=new c,u.prototype.constructor=u,d.prototype=new c,d.prototype.constructor=d,p.prototype=new c,p.prototype.constructor=p,f.prototype.getData=function(e){e(this.data)},m.prototype=new f,m.prototype.constructor=m,g.prototype=new f,g.prototype.constructor=g,_.prototype=new f,_.prototype.constructor=_;var T={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function S(t,i,s){if(null===e.zip.workerScripts||null===e.zip.workerScriptsPath){var r;if(e.zip.workerScripts){if(r=e.zip.workerScripts[t],!Array.isArray(r))return void s(new Error("zip.workerScripts."+t+" is not an array!"));r=function(e){var t=document.createElement("a");return e.map((function(e){return t.href=e,t.href}))}(r)}else(r=T[t].slice(0))[0]=(e.zip.workerScriptsPath||"")+r[0];var o=new Worker(r[0]);o.codecTime=o.crcTime=0,o.postMessage({type:"importScripts",scripts:r.slice(1)}),o.addEventListener("message",(function e(t){var r=t.data;if(r.error)return o.terminate(),void s(r.error);"importScripts"===r.type&&(o.removeEventListener("message",e),o.removeEventListener("error",n),i(o))})),o.addEventListener("error",n)}else s(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function n(e){o.terminate(),s(e)}}function I(e){console.error(e)}e.zip={Reader:c,Writer:f,BlobReader:p,Data64URIReader:d,TextReader:u,BlobWriter:_,Data64URIWriter:g,TextWriter:m,createReader:function(e,t,i){i=i||I,e.init((function(){C(e,t,i)}),i)},createWriter:function(e,t,i,s){i=i||I,s=!!s,e.init((function(){D(e,t,i,s)}),i)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(ip);!function(e){var t,i,s=e.Reader,r=e.Writer;try{i=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function o(e){var t=this;function i(i,s){var r;t.data?i():((r=new XMLHttpRequest).addEventListener("load",(function(){t.size||(t.size=Number(r.getResponseHeader("Content-Length"))||Number(r.response.byteLength)),t.data=new Uint8Array(r.response),i()}),!1),r.addEventListener("error",s,!1),r.open("GET",e),r.responseType="arraybuffer",r.send())}t.size=0,t.init=function(s,r){if(function(e){var t=document.createElement("a");return t.href=e,"http:"===t.protocol||"https:"===t.protocol}(e)){var o=new XMLHttpRequest;o.addEventListener("load",(function(){t.size=Number(o.getResponseHeader("Content-Length")),t.size?s():i(s,r)}),!1),o.addEventListener("error",r,!1),o.open("HEAD",e),o.send()}else i(s,r)},t.readUint8Array=function(e,s,r,o){i((function(){r(new Uint8Array(t.data.subarray(e,e+s)))}),o)}}function n(e){var t=this;t.size=0,t.init=function(i,s){var r=new XMLHttpRequest;r.addEventListener("load",(function(){t.size=Number(r.getResponseHeader("Content-Length")),"bytes"==r.getResponseHeader("Accept-Ranges")?i():s("HTTP Range not supported.")}),!1),r.addEventListener("error",s,!1),r.open("HEAD",e),r.send()},t.readUint8Array=function(t,i,s,r){!function(t,i,s,r){var o=new XMLHttpRequest;o.open("GET",e),o.responseType="arraybuffer",o.setRequestHeader("Range","bytes="+t+"-"+(t+i-1)),o.addEventListener("load",(function(){s(o.response)}),!1),o.addEventListener("error",r,!1),o.send()}(t,i,(function(e){s(new Uint8Array(e))}),r)}}function a(e){var t=this;t.size=0,t.init=function(i,s){t.size=e.byteLength,i()},t.readUint8Array=function(t,i,s,r){s(new Uint8Array(e.slice(t,t+i)))}}function l(){var e,t=this;t.init=function(t,i){e=new Uint8Array,t()},t.writeUint8Array=function(t,i,s){var r=new Uint8Array(e.length+t.length);r.set(e),r.set(t,e.length),e=r,i()},t.getData=function(t){t(e.buffer)}}function h(e,t){var s,r=this;r.init=function(t,i){e.createWriter((function(e){s=e,t()}),i)},r.writeUint8Array=function(e,r,o){var n=new Blob([i?e:e.buffer],{type:t});s.onwrite=function(){s.onwrite=null,r()},s.onerror=o,s.write(n)},r.getData=function(t){e.file(t)}}o.prototype=new s,o.prototype.constructor=o,n.prototype=new s,n.prototype.constructor=n,a.prototype=new s,a.prototype.constructor=a,l.prototype=new r,l.prototype.constructor=l,h.prototype=new r,h.prototype.constructor=h,e.FileWriter=h,e.HttpReader=o,e.HttpRangeReader=n,e.ArrayBufferReader=a,e.ArrayBufferWriter=l,e.fs&&((t=e.fs.ZipDirectoryEntry).prototype.addHttpContent=function(i,s,r){return function(i,s,r,o){if(i.directory)return o?new t(i.fs,s,r,i):new e.fs.ZipFileEntry(i.fs,s,r,i);throw"Parent entry is not a directory."}(this,i,{data:s,Reader:r?n:o})},t.prototype.importHttpContent=function(e,t,i,s){this.importZip(t?new n(e):new o(e),i,s)},e.fs.FS.prototype.importHttpContent=function(e,i,s,r){this.entries=[],this.root=new t(this),this.root.importHttpContent(e,i,s,r)})}(ip.zip);var sp=e=>{if("undefined"!=typeof require)return require(e);throw new Error('Dynamic require of "'+e+'" is not supported')},rp=(e,t)=>function(){return t||(0,e[Object.keys(e)[0]])((t={exports:{}}).exports,t),t.exports},op=rp({"(disabled):crypto"(){}}),np=rp({"dist/web-ifc-mt.js"(e,t){var i,s=(i="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(i=i||__filename),function(e){function t(){return F.buffer!=W&&ne(F.buffer),H}function s(){return F.buffer!=W&&ne(F.buffer),X}function r(){return F.buffer!=W&&ne(F.buffer),Y}function o(){return F.buffer!=W&&ne(F.buffer),q}function n(){return F.buffer!=W&&ne(F.buffer),$}function a(){return F.buffer!=W&&ne(F.buffer),Z}function l(){return F.buffer!=W&&ne(F.buffer),Q}var h,c,u=void 0!==(e=e||{})?e:{};u.ready=new Promise((function(e,t){h=e,c=t}));var d,p={};for(d in u)u.hasOwnProperty(d)&&(p[d]=u[d]);var f,m,g,_,v,b="./this.program",x=function(e,t){throw t},y="object"==typeof window,P="function"==typeof importScripts,w="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,M=u.ENVIRONMENT_IS_PTHREAD||!1,C="";function E(e){return u.locateFile?u.locateFile(e,C):C+e}if(w){var A;C=P?sp("path").dirname(C)+"/":__dirname+"/",f=function(e,t){return _||(_=sp("fs")),v||(v=sp("path")),e=v.normalize(e),_.readFileSync(e,t?null:"utf8")},g=function(e){var t=f(e,!0);return t.buffer||(t=new Uint8Array(t)),k(t.buffer),t},m=function(e,t,i){_||(_=sp("fs")),v||(v=sp("path")),e=v.normalize(e),_.readFile(e,(function(e,s){e?i(e):t(s.buffer)}))},process.argv.length>1&&(b=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),process.on("uncaughtException",(function(e){if(!(e instanceof ms))throw e})),process.on("unhandledRejection",Pe),x=function(e,t){if(pe())throw process.exitCode=e,t;process.exit(e)},u.inspect=function(){return"[Emscripten Module object]"};try{A=sp("worker_threads")}catch(e){throw console.error('The "worker_threads" module is not supported in this node.js build - perhaps a newer version is needed?'),e}global.Worker=A.Worker}else(y||P)&&(P?C=self.location.href:"undefined"!=typeof document&&document.currentScript&&(C=document.currentScript.src),i&&(C=i),C=0!==C.indexOf("blob:")?C.substr(0,C.lastIndexOf("/")+1):"",w?(f=function(e,t){return _||(_=sp("fs")),v||(v=sp("path")),e=v.normalize(e),_.readFileSync(e,t?null:"utf8")},g=function(e){var t=f(e,!0);return t.buffer||(t=new Uint8Array(t)),k(t.buffer),t},m=function(e,t,i){_||(_=sp("fs")),v||(v=sp("path")),e=v.normalize(e),_.readFile(e,(function(e,s){e?i(e):t(s.buffer)}))}):(f=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},P&&(g=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),m=function(e,t,i){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){200==s.status||0==s.status&&s.response?t(s.response):i()},s.onerror=i,s.send(null)}));w&&"undefined"==typeof performance&&(global.performance=sp("perf_hooks").performance);var D,T=u.print||console.log.bind(console),S=u.printErr||console.warn.bind(console);for(d in p)p.hasOwnProperty(d)&&(u[d]=p[d]);function I(e){I.shown||(I.shown={}),I.shown[e]||(I.shown[e]=1,S(e))}p=null,u.arguments,u.thisProgram&&(b=u.thisProgram),u.quit&&(x=u.quit),u.wasmBinary&&(D=u.wasmBinary);var F,L,B=u.noExitRuntime||!0;"object"!=typeof WebAssembly&&Pe("no native wasm support detected");var R=!1;function k(e,t){e||Pe("Assertion failed: "+t)}function O(e){var t=new TextDecoder(e);this.decode=function(e){return e.buffer instanceof SharedArrayBuffer&&(e=new Uint8Array(e)),t.decode.call(t,e)}}var N="undefined"!=typeof TextDecoder?new O("utf8"):void 0;function j(e,t,i){for(var s=(t>>>=0)+i,r=t;e[r>>>0]&&!(r>=s);)++r;if(r-t>16&&e.subarray&&N)return N.decode(e.subarray(t>>>0,r>>>0));for(var o="";t<r;){var n=e[t++>>>0];if(128&n){var a=63&e[t++>>>0];if(192!=(224&n)){var l=63&e[t++>>>0];if((n=224==(240&n)?(15&n)<<12|a<<6|l:(7&n)<<18|a<<12|l<<6|63&e[t++>>>0])<65536)o+=String.fromCharCode(n);else{var h=n-65536;o+=String.fromCharCode(55296|h>>10,56320|1023&h)}}else o+=String.fromCharCode((31&n)<<6|a)}else o+=String.fromCharCode(n)}return o}function V(e,t){return(e>>>=0)?j(s(),e,t):""}function z(e,t,i,s){if(!(s>0))return 0;for(var r=i>>>=0,o=i+s-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),a<=127){if(i>=o)break;t[i++>>>0]=a}else if(a<=2047){if(i+1>=o)break;t[i++>>>0]=192|a>>6,t[i++>>>0]=128|63&a}else if(a<=65535){if(i+2>=o)break;t[i++>>>0]=224|a>>12,t[i++>>>0]=128|a>>6&63,t[i++>>>0]=128|63&a}else{if(i+3>=o)break;t[i++>>>0]=240|a>>18,t[i++>>>0]=128|a>>12&63,t[i++>>>0]=128|a>>6&63,t[i++>>>0]=128|63&a}}return t[i>>>0]=0,i-r}function U(e,t,i){return z(e,s(),t,i)}function G(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++i)),s<=127?++t:t+=s<=2047?2:s<=65535?3:4}return t}var W,H,X,Y,q,$,Z,K,Q,J="undefined"!=typeof TextDecoder?new O("utf-16le"):void 0;function ee(e,t){for(var i=e,n=i>>1,a=n+t/2;!(n>=a)&&o()[n>>>0];)++n;if((i=n<<1)-e>32&&J)return J.decode(s().subarray(e>>>0,i>>>0));for(var l="",h=0;!(h>=t/2);++h){var c=r()[e+2*h>>>1];if(0==c)break;l+=String.fromCharCode(c)}return l}function te(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var s=t,o=(i-=2)<2*e.length?i/2:e.length,n=0;n<o;++n){var a=e.charCodeAt(n);r()[t>>>1]=a,t+=2}return r()[t>>>1]=0,t-s}function ie(e){return 2*e.length}function se(e,t){for(var i=0,s="";!(i>=t/4);){var r=n()[e+4*i>>>2];if(0==r)break;if(++i,r>=65536){var o=r-65536;s+=String.fromCharCode(55296|o>>10,56320|1023&o)}else s+=String.fromCharCode(r)}return s}function re(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var s=t>>>=0,r=s+i-4,o=0;o<e.length;++o){var a=e.charCodeAt(o);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++o)),n()[t>>>2]=a,(t+=4)+4>r)break}return n()[t>>>2]=0,t-s}function oe(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&++i,t+=4}return t}function ne(e){W=e,u.HEAP8=H=new Int8Array(e),u.HEAP16=Y=new Int16Array(e),u.HEAP32=$=new Int32Array(e),u.HEAPU8=X=new Uint8Array(e),u.HEAPU16=q=new Uint16Array(e),u.HEAPU32=Z=new Uint32Array(e),u.HEAPF32=K=new Float32Array(e),u.HEAPF64=Q=new Float64Array(e)}M&&(W=u.buffer);var ae,le=u.INITIAL_MEMORY||16777216;if(M)F=u.wasmMemory,W=u.buffer;else if(u.wasmMemory)F=u.wasmMemory;else if(!((F=new WebAssembly.Memory({initial:le/65536,maximum:65536,shared:!0})).buffer instanceof SharedArrayBuffer))throw S("requested a shared WebAssembly.Memory but the returned buffer is not a SharedArrayBuffer, indicating that while the browser has SharedArrayBuffer it does not have WebAssembly threads support - you may need to set a flag"),w&&console.log("(on node you may need: --experimental-wasm-threads --experimental-wasm-bulk-memory and also use a recent version)"),Error("bad memory");F&&(W=F.buffer),le=W.byteLength,ne(W);var he=[],ce=[],ue=[],de=[];function pe(){return B||!1}function fe(){M||(u.noFSInit||Ne.init.initialized||Ne.init(),Ne.ignorePermissions=!1,Ae(ce))}var me,ge,_e,ve=0,be=null;function xe(e){ve++,u.monitorRunDependencies&&u.monitorRunDependencies(ve)}function ye(e){if(ve--,u.monitorRunDependencies&&u.monitorRunDependencies(ve),0==ve&&be){var t=be;be=null,t()}}function Pe(e){u.onAbort&&u.onAbort(e),M&&console.error("Pthread aborting at "+(new Error).stack),S(e+=""),R=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw c(t),t}function we(e){return e.startsWith("data:application/octet-stream;base64,")}function Me(e){return e.startsWith("file://")}function Ce(e){try{if(e==me&&D)return new Uint8Array(D);if(g)return g(e);throw"both async and sync fetching of the wasm failed"}catch(e){Pe(e)}}u.preloadedImages={},u.preloadedAudios={},we(me="web-ifc-mt.wasm")||(me=E(me));var Ee={44848:function(){throw"Canceled!"},44866:function(e,t){setTimeout((function(){Ki(e,t)}),0)}};function Ae(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var i=t.func;"number"==typeof i?void 0===t.arg?ae.get(i)():ae.get(i)(t.arg):i(void 0===t.arg?null:t.arg)}else t(u)}}function De(e,i){if(e<=0||e>t().length||!0&e||i<0)return-28;if(0==i)return 0;i>=2147483647&&(i=1/0);var s=Atomics.load(n(),fs>>2),r=0;if(s==e&&Atomics.compareExchange(n(),fs>>2,s,0)==s&&(r=1,--i<=0))return 1;var o=Atomics.notify(n(),e>>2,i);if(o>=0)return o+r;throw"Atomics.notify returned an unexpected value "+o}u._emscripten_futex_wake=De;var Te,Se={unusedWorkers:[],runningWorkers:[],tlsInitFunctions:[],initMainThreadBlock:function(){for(var e=navigator.hardwareConcurrency,t=0;t<e;++t)Se.allocateUnusedWorker()},initRuntime:function(){for(var e=Yi(228),t=0;t<57;++t)a()[e/4+t>>>0]=0;n()[e+12>>>2]=e;var i=e+152;n()[i>>>2]=i;var s=Yi(512);for(t=0;t<128;++t)a()[s/4+t>>>0]=0;Atomics.store(a(),e+100>>2,s),Atomics.store(a(),e+40>>2,e),is(e,!P,1),Zi(e)},initWorker:function(){},pthreads:{},threadExitHandlers:[],runExitHandlers:function(){for(;Se.threadExitHandlers.length>0;)Se.threadExitHandlers.pop()();ns()},runExitHandlersAndDeinitThread:function(e,t){Atomics.store(a(),e+56>>2,1),Atomics.store(a(),e+60>>2,0),Se.runExitHandlers(),Atomics.store(a(),e+4>>2,t),Atomics.store(a(),e+0>>2,1),De(e+0,2147483647),is(0,0,0)},setExitStatus:function(e){},threadExit:function(e){var t=os();t&&(Se.runExitHandlersAndDeinitThread(t,e),M&&postMessage({cmd:"exit"}))},threadCancel:function(){Se.runExitHandlersAndDeinitThread(os(),-1),postMessage({cmd:"cancelDone"})},terminateAllThreads:function(){for(var e in Se.pthreads)(s=Se.pthreads[e])&&s.worker&&Se.returnWorkerToPool(s.worker);Se.pthreads={};for(var t=0;t<Se.unusedWorkers.length;++t)(i=Se.unusedWorkers[t]).terminate();for(Se.unusedWorkers=[],t=0;t<Se.runningWorkers.length;++t){var i,s=(i=Se.runningWorkers[t]).pthread;Se.freeThreadData(s),i.terminate()}Se.runningWorkers=[]},freeThreadData:function(e){if(e){if(e.threadInfoStruct){var t=n()[e.threadInfoStruct+100>>>2];n()[e.threadInfoStruct+100>>>2]=0,qi(t),qi(e.threadInfoStruct)}e.threadInfoStruct=0,e.allocatedOwnStack&&e.stackBase&&qi(e.stackBase),e.stackBase=0,e.worker&&(e.worker.pthread=null)}},returnWorkerToPool:function(e){Se.runWithoutMainThreadQueuedCalls((function(){delete Se.pthreads[e.pthread.threadInfoStruct],Se.unusedWorkers.push(e),Se.runningWorkers.splice(Se.runningWorkers.indexOf(e),1),Se.freeThreadData(e.pthread),e.pthread=void 0}))},runWithoutMainThreadQueuedCalls:function(e){n()[ps>>>2]=0;try{e()}finally{n()[ps>>>2]=1}},receiveObjectTransfer:function(e){},threadInit:function(){for(var e in Se.tlsInitFunctions)Se.tlsInitFunctions[e]()},loadWasmModuleToWorker:function(e,t){e.onmessage=function(i){var s=i.data,r=s.cmd;if(e.pthread&&(Se.currentProxiedOperationCallerThread=e.pthread.threadInfoStruct),s.targetThread&&s.targetThread!=os()){var o=Se.pthreads[s.targetThread];return o?o.worker.postMessage(i.data,s.transferList):console.error('Internal error! Worker sent a message "'+r+'" to target pthread '+s.targetThread+", but that thread no longer exists!"),void(Se.currentProxiedOperationCallerThread=void 0)}if("processQueuedMainThreadWork"===r)Ji();else if("spawnThread"===r)Li(i.data);else if("cleanupThread"===r)!function(e){if(M)throw"Internal Error! cleanupThread() can only ever be called from main application thread!";if(!e)throw"Internal Error! Null pthread_ptr in cleanupThread!";var t=Se.pthreads[e];if(t){n()[e+12>>>2]=0;var i=t.worker;Se.returnWorkerToPool(i)}}(s.thread);else if("killThread"===r)!function(e){if(M)throw"Internal Error! killThread() can only ever be called from main application thread!";if(!e)throw"Internal Error! Null pthread_ptr in killThread!";n()[e+12>>>2]=0;var t=Se.pthreads[e];t.worker.terminate(),Se.freeThreadData(t),Se.runningWorkers.splice(Se.runningWorkers.indexOf(t.worker),1),t.worker.pthread=void 0}(s.thread);else if("cancelThread"===r)!function(e){if(M)throw"Internal Error! cancelThread() can only ever be called from main application thread!";if(!e)throw"Internal Error! Null pthread_ptr in cancelThread!";Se.pthreads[e].worker.postMessage({cmd:"cancel"})}(s.thread);else if("loaded"===r)e.loaded=!0,t&&t(e),e.runPthread&&(e.runPthread(),delete e.runPthread);else if("print"===r)T("Thread "+s.threadId+": "+s.text);else if("printErr"===r)S("Thread "+s.threadId+": "+s.text);else if("alert"===r)alert("Thread "+s.threadId+": "+s.text);else if("exit"===r)e.pthread&&Atomics.load(a(),e.pthread.threadInfoStruct+64>>2)&&Se.returnWorkerToPool(e);else if("exitProcess"===r)try{_s(s.returnCode)}catch(e){if(e instanceof ms)return;throw e}else"cancelDone"===r?Se.returnWorkerToPool(e):"objectTransfer"===r?Se.receiveObjectTransfer(i.data):"setimmediate"===i.data.target?e.postMessage(i.data):S("worker sent an unknown command "+r);Se.currentProxiedOperationCallerThread=void 0},e.onerror=function(e){S("pthread sent an error! "+e.filename+":"+e.lineno+": "+e.message)},w&&(e.on("message",(function(t){e.onmessage({data:t})})),e.on("error",(function(t){e.onerror(t)})),e.on("exit",(function(e){}))),e.postMessage({cmd:"load",urlOrBlob:u.mainScriptUrlOrBlob||i,wasmMemory:F,wasmModule:L})},allocateUnusedWorker:function(){var e=E("web-ifc-mt.worker.js");Se.unusedWorkers.push(new Worker(e))},getNewWorker:function(){return 0==Se.unusedWorkers.length&&(Se.allocateUnusedWorker(),Se.loadWasmModuleToWorker(Se.unusedWorkers[0])),Se.unusedWorkers.pop()},busySpinWait:function(e){for(var t=performance.now()+e;performance.now()<t;);}};function Ie(e){return n()[rs()>>>2]=e,e}function Fe(e){this.excPtr=e,this.ptr=e-16,this.set_type=function(e){n()[this.ptr+4>>>2]=e},this.get_type=function(){return n()[this.ptr+4>>>2]},this.set_destructor=function(e){n()[this.ptr+8>>>2]=e},this.get_destructor=function(){return n()[this.ptr+8>>>2]},this.set_refcount=function(e){n()[this.ptr>>>2]=e},this.set_caught=function(e){e=e?1:0,t()[this.ptr+12>>>0]=e},this.get_caught=function(){return 0!=t()[this.ptr+12>>>0]},this.set_rethrown=function(e){e=e?1:0,t()[this.ptr+13>>>0]=e},this.get_rethrown=function(){return 0!=t()[this.ptr+13>>>0]},this.init=function(e,t){this.set_type(e),this.set_destructor(t),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){Atomics.add(n(),this.ptr+0>>2,1)},this.release_ref=function(){return 1===Atomics.sub(n(),this.ptr+0>>2,1)}}u.establishStackSpace=function(e,t){cs(e,t),ls(e)},u.invokeEntryPoint=function(e,t){return ae.get(e)(t)},Te=w?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:M?function(){return performance.now()-u.__performance_now_clock_drift}:function(){return performance.now()};var Le={splitPath:function(e){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1)},normalizeArray:function(e,t){for(var i=0,s=e.length-1;s>=0;s--){var r=e[s];"."===r?e.splice(s,1):".."===r?(e.splice(s,1),i++):i&&(e.splice(s,1),i--)}if(t)for(;i;i--)e.unshift("..");return e},normalize:function(e){var t="/"===e.charAt(0),i="/"===e.substr(-1);return e=Le.normalizeArray(e.split("/").filter((function(e){return!!e})),!t).join("/"),e||t||(e="."),e&&i&&(e+="/"),(t?"/":"")+e},dirname:function(e){var t=Le.splitPath(e),i=t[0],s=t[1];return i||s?(s&&(s=s.substr(0,s.length-1)),i+s):"."},basename:function(e){if("/"===e)return"/";var t=(e=(e=Le.normalize(e)).replace(/\/$/,"")).lastIndexOf("/");return-1===t?e:e.substr(t+1)},extname:function(e){return Le.splitPath(e)[3]},join:function(){var e=Array.prototype.slice.call(arguments,0);return Le.normalize(e.join("/"))},join2:function(e,t){return Le.normalize(e+"/"+t)}},Be={resolve:function(){for(var e="",t=!1,i=arguments.length-1;i>=-1&&!t;i--){var s=i>=0?arguments[i]:Ne.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");if(!s)return"";e=s+"/"+e,t="/"===s.charAt(0)}return e=Le.normalizeArray(e.split("/").filter((function(e){return!!e})),!t).join("/"),(t?"/":"")+e||"."},relative:function(e,t){function i(e){for(var t=0;t<e.length&&""===e[t];t++);for(var i=e.length-1;i>=0&&""===e[i];i--);return t>i?[]:e.slice(t,i-t+1)}e=Be.resolve(e).substr(1),t=Be.resolve(t).substr(1);for(var s=i(e.split("/")),r=i(t.split("/")),o=Math.min(s.length,r.length),n=o,a=0;a<o;a++)if(s[a]!==r[a]){n=a;break}var l=[];for(a=n;a<s.length;a++)l.push("..");return(l=l.concat(r.slice(n))).join("/")}},Re={ttys:[],init:function(){},shutdown:function(){},register:function(e,t){Re.ttys[e]={input:[],output:[],ops:t},Ne.registerDevice(e,Re.stream_ops)},stream_ops:{open:function(e){var t=Re.ttys[e.node.rdev];if(!t)throw new Ne.ErrnoError(43);e.tty=t,e.seekable=!1},close:function(e){e.tty.ops.flush(e.tty)},flush:function(e){e.tty.ops.flush(e.tty)},read:function(e,t,i,s,r){if(!e.tty||!e.tty.ops.get_char)throw new Ne.ErrnoError(60);for(var o=0,n=0;n<s;n++){var a;try{a=e.tty.ops.get_char(e.tty)}catch(e){throw new Ne.ErrnoError(29)}if(void 0===a&&0===o)throw new Ne.ErrnoError(6);if(null==a)break;o++,t[i+n]=a}return o&&(e.node.timestamp=Date.now()),o},write:function(e,t,i,s,r){if(!e.tty||!e.tty.ops.put_char)throw new Ne.ErrnoError(60);try{for(var o=0;o<s;o++)e.tty.ops.put_char(e.tty,t[i+o])}catch(e){throw new Ne.ErrnoError(29)}return s&&(e.node.timestamp=Date.now()),o}},default_tty_ops:{get_char:function(e){if(!e.input.length){var t=null;if(w){var i=Buffer.alloc(256),s=0;try{s=_.readSync(process.stdin.fd,i,0,256,null)}catch(e){if(!e.toString().includes("EOF"))throw e;s=0}t=s>0?i.slice(0,s).toString("utf-8"):null}else"undefined"!=typeof window&&"function"==typeof window.prompt?null!==(t=window.prompt("Input: "))&&(t+="\n"):"function"==typeof readline&&null!==(t=readline())&&(t+="\n");if(!t)return null;e.input=Hi(t,!0)}return e.input.shift()},put_char:function(e,t){null===t||10===t?(T(j(e.output,0)),e.output=[]):0!=t&&e.output.push(t)},flush:function(e){e.output&&e.output.length>0&&(T(j(e.output,0)),e.output=[])}},default_tty1_ops:{put_char:function(e,t){null===t||10===t?(S(j(e.output,0)),e.output=[]):0!=t&&e.output.push(t)},flush:function(e){e.output&&e.output.length>0&&(S(j(e.output,0)),e.output=[])}}};function ke(e){e=function(e,t){return t||(t=16),Math.ceil(e/t)*t}(e,65536);var t=us(65536,e);return t?(function(e,t){s().fill(0,e,e+t)}(t,e),t):0}var Oe={ops_table:null,mount:function(e){return Oe.createNode(null,"/",16895,0)},createNode:function(e,t,i,s){if(Ne.isBlkdev(i)||Ne.isFIFO(i))throw new Ne.ErrnoError(63);Oe.ops_table||(Oe.ops_table={dir:{node:{getattr:Oe.node_ops.getattr,setattr:Oe.node_ops.setattr,lookup:Oe.node_ops.lookup,mknod:Oe.node_ops.mknod,rename:Oe.node_ops.rename,unlink:Oe.node_ops.unlink,rmdir:Oe.node_ops.rmdir,readdir:Oe.node_ops.readdir,symlink:Oe.node_ops.symlink},stream:{llseek:Oe.stream_ops.llseek}},file:{node:{getattr:Oe.node_ops.getattr,setattr:Oe.node_ops.setattr},stream:{llseek:Oe.stream_ops.llseek,read:Oe.stream_ops.read,write:Oe.stream_ops.write,allocate:Oe.stream_ops.allocate,mmap:Oe.stream_ops.mmap,msync:Oe.stream_ops.msync}},link:{node:{getattr:Oe.node_ops.getattr,setattr:Oe.node_ops.setattr,readlink:Oe.node_ops.readlink},stream:{}},chrdev:{node:{getattr:Oe.node_ops.getattr,setattr:Oe.node_ops.setattr},stream:Ne.chrdev_stream_ops}});var r=Ne.createNode(e,t,i,s);return Ne.isDir(r.mode)?(r.node_ops=Oe.ops_table.dir.node,r.stream_ops=Oe.ops_table.dir.stream,r.contents={}):Ne.isFile(r.mode)?(r.node_ops=Oe.ops_table.file.node,r.stream_ops=Oe.ops_table.file.stream,r.usedBytes=0,r.contents=null):Ne.isLink(r.mode)?(r.node_ops=Oe.ops_table.link.node,r.stream_ops=Oe.ops_table.link.stream):Ne.isChrdev(r.mode)&&(r.node_ops=Oe.ops_table.chrdev.node,r.stream_ops=Oe.ops_table.chrdev.stream),r.timestamp=Date.now(),e&&(e.contents[t]=r,e.timestamp=r.timestamp),r},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0)},expandFileStorage:function(e,t){t>>>=0;var i=e.contents?e.contents.length:0;if(!(i>=t)){t=Math.max(t,i*(i<1048576?2:1.125)>>>0),0!=i&&(t=Math.max(t,256));var s=e.contents;e.contents=new Uint8Array(t),e.usedBytes>0&&e.contents.set(s.subarray(0,e.usedBytes),0)}},resizeFileStorage:function(e,t){if(t>>>=0,e.usedBytes!=t)if(0==t)e.contents=null,e.usedBytes=0;else{var i=e.contents;e.contents=new Uint8Array(t),i&&e.contents.set(i.subarray(0,Math.min(t,e.usedBytes))),e.usedBytes=t}},node_ops:{getattr:function(e){var t={};return t.dev=Ne.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,Ne.isDir(e.mode)?t.size=4096:Ne.isFile(e.mode)?t.size=e.usedBytes:Ne.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr:function(e,t){void 0!==t.mode&&(e.mode=t.mode),void 0!==t.timestamp&&(e.timestamp=t.timestamp),void 0!==t.size&&Oe.resizeFileStorage(e,t.size)},lookup:function(e,t){throw Ne.genericErrors[44]},mknod:function(e,t,i,s){return Oe.createNode(e,t,i,s)},rename:function(e,t,i){if(Ne.isDir(e.mode)){var s;try{s=Ne.lookupNode(t,i)}catch(e){}if(s)for(var r in s.contents)throw new Ne.ErrnoError(55)}delete e.parent.contents[e.name],e.parent.timestamp=Date.now(),e.name=i,t.contents[i]=e,t.timestamp=e.parent.timestamp,e.parent=t},unlink:function(e,t){delete e.contents[t],e.timestamp=Date.now()},rmdir:function(e,t){var i=Ne.lookupNode(e,t);for(var s in i.contents)throw new Ne.ErrnoError(55);delete e.contents[t],e.timestamp=Date.now()},readdir:function(e){var t=[".",".."];for(var i in e.contents)e.contents.hasOwnProperty(i)&&t.push(i);return t},symlink:function(e,t,i){var s=Oe.createNode(e,t,41471,0);return s.link=i,s},readlink:function(e){if(!Ne.isLink(e.mode))throw new Ne.ErrnoError(28);return e.link}},stream_ops:{read:function(e,t,i,s,r){var o=e.node.contents;if(r>=e.node.usedBytes)return 0;var n=Math.min(e.node.usedBytes-r,s);if(n>8&&o.subarray)t.set(o.subarray(r,r+n),i);else for(var a=0;a<n;a++)t[i+a]=o[r+a];return n},write:function(e,i,s,r,o,n){if(i.buffer===t().buffer&&(n=!1),!r)return 0;var a=e.node;if(a.timestamp=Date.now(),i.subarray&&(!a.contents||a.contents.subarray)){if(n)return a.contents=i.subarray(s,s+r),a.usedBytes=r,r;if(0===a.usedBytes&&0===o)return a.contents=i.slice(s,s+r),a.usedBytes=r,r;if(o+r<=a.usedBytes)return a.contents.set(i.subarray(s,s+r),o),r}if(Oe.expandFileStorage(a,o+r),a.contents.subarray&&i.subarray)a.contents.set(i.subarray(s,s+r),o);else for(var l=0;l<r;l++)a.contents[o+l]=i[s+l];return a.usedBytes=Math.max(a.usedBytes,o+r),r},llseek:function(e,t,i){var s=t;if(1===i?s+=e.position:2===i&&Ne.isFile(e.node.mode)&&(s+=e.node.usedBytes),s<0)throw new Ne.ErrnoError(28);return s},allocate:function(e,t,i){Oe.expandFileStorage(e.node,t+i),e.node.usedBytes=Math.max(e.node.usedBytes,t+i)},mmap:function(e,i,s,r,o,n){if(0!==i)throw new Ne.ErrnoError(28);if(!Ne.isFile(e.node.mode))throw new Ne.ErrnoError(43);var a,l,h=e.node.contents;if(2&n||h.buffer!==W){if((r>0||r+s<h.length)&&(h=h.subarray?h.subarray(r,r+s):Array.prototype.slice.call(h,r,r+s)),l=!0,!(a=ke(s)))throw new Ne.ErrnoError(48);a>>>=0,t().set(h,a>>>0)}else l=!1,a=h.byteOffset;return{ptr:a,allocated:l}},msync:function(e,t,i,s,r){if(!Ne.isFile(e.node.mode))throw new Ne.ErrnoError(43);return 2&r||Oe.stream_ops.write(e,t,0,s,i,!1),0}}},Ne={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,trackingDelegate:{},tracking:{openFlags:{READ:1,WRITE:2}},ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:function(e,t){if(t=t||{},!(e=Be.resolve(Ne.cwd(),e)))return{path:"",node:null};var i={follow_mount:!0,recurse_count:0};for(var s in i)void 0===t[s]&&(t[s]=i[s]);if(t.recurse_count>8)throw new Ne.ErrnoError(32);for(var r=Le.normalizeArray(e.split("/").filter((function(e){return!!e})),!1),o=Ne.root,n="/",a=0;a<r.length;a++){var l=a===r.length-1;if(l&&t.parent)break;if(o=Ne.lookupNode(o,r[a]),n=Le.join2(n,r[a]),Ne.isMountpoint(o)&&(!l||l&&t.follow_mount)&&(o=o.mounted.root),!l||t.follow)for(var h=0;Ne.isLink(o.mode);){var c=Ne.readlink(n);if(n=Be.resolve(Le.dirname(n),c),o=Ne.lookupPath(n,{recurse_count:t.recurse_count}).node,h++>40)throw new Ne.ErrnoError(32)}}return{path:n,node:o}},getPath:function(e){for(var t;;){if(Ne.isRoot(e)){var i=e.mount.mountpoint;return t?"/"!==i[i.length-1]?i+"/"+t:i+t:i}t=t?e.name+"/"+t:e.name,e=e.parent}},hashName:function(e,t){for(var i=0,s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s)|0;return(e+i>>>0)%Ne.nameTable.length},hashAddNode:function(e){var t=Ne.hashName(e.parent.id,e.name);e.name_next=Ne.nameTable[t],Ne.nameTable[t]=e},hashRemoveNode:function(e){var t=Ne.hashName(e.parent.id,e.name);if(Ne.nameTable[t]===e)Ne.nameTable[t]=e.name_next;else for(var i=Ne.nameTable[t];i;){if(i.name_next===e){i.name_next=e.name_next;break}i=i.name_next}},lookupNode:function(e,t){var i=Ne.mayLookup(e);if(i)throw new Ne.ErrnoError(i,e);for(var s=Ne.hashName(e.id,t),r=Ne.nameTable[s];r;r=r.name_next){var o=r.name;if(r.parent.id===e.id&&o===t)return r}return Ne.lookup(e,t)},createNode:function(e,t,i,s){var r=new Ne.FSNode(e,t,i,s);return Ne.hashAddNode(r),r},destroyNode:function(e){Ne.hashRemoveNode(e)},isRoot:function(e){return e===e.parent},isMountpoint:function(e){return!!e.mounted},isFile:function(e){return 32768==(61440&e)},isDir:function(e){return 16384==(61440&e)},isLink:function(e){return 40960==(61440&e)},isChrdev:function(e){return 8192==(61440&e)},isBlkdev:function(e){return 24576==(61440&e)},isFIFO:function(e){return 4096==(61440&e)},isSocket:function(e){return 49152==(49152&e)},flagModes:{r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},modeStringToFlags:function(e){var t=Ne.flagModes[e];if(void 0===t)throw new Error("Unknown file open mode: "+e);return t},flagsToPermissionString:function(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t},nodePermissions:function(e,t){return Ne.ignorePermissions||(!t.includes("r")||292&e.mode)&&(!t.includes("w")||146&e.mode)&&(!t.includes("x")||73&e.mode)?0:2},mayLookup:function(e){var t=Ne.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:2)},mayCreate:function(e,t){try{return Ne.lookupNode(e,t),20}catch(e){}return Ne.nodePermissions(e,"wx")},mayDelete:function(e,t,i){var s;try{s=Ne.lookupNode(e,t)}catch(e){return e.errno}var r=Ne.nodePermissions(e,"wx");if(r)return r;if(i){if(!Ne.isDir(s.mode))return 54;if(Ne.isRoot(s)||Ne.getPath(s)===Ne.cwd())return 10}else if(Ne.isDir(s.mode))return 31;return 0},mayOpen:function(e,t){return e?Ne.isLink(e.mode)?32:Ne.isDir(e.mode)&&("r"!==Ne.flagsToPermissionString(t)||512&t)?31:Ne.nodePermissions(e,Ne.flagsToPermissionString(t)):44},MAX_OPEN_FDS:4096,nextfd:function(e,t){e=e||0,t=t||Ne.MAX_OPEN_FDS;for(var i=e;i<=t;i++)if(!Ne.streams[i])return i;throw new Ne.ErrnoError(33)},getStream:function(e){return Ne.streams[e]},createStream:function(e,t,i){Ne.FSStream||(Ne.FSStream=function(){},Ne.FSStream.prototype={object:{get:function(){return this.node},set:function(e){this.node=e}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}}});var s=new Ne.FSStream;for(var r in e)s[r]=e[r];e=s;var o=Ne.nextfd(t,i);return e.fd=o,Ne.streams[o]=e,e},closeStream:function(e){Ne.streams[e]=null},chrdev_stream_ops:{open:function(e){var t=Ne.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open&&e.stream_ops.open(e)},llseek:function(){throw new Ne.ErrnoError(70)}},major:function(e){return e>>8},minor:function(e){return 255&e},makedev:function(e,t){return e<<8|t},registerDevice:function(e,t){Ne.devices[e]={stream_ops:t}},getDevice:function(e){return Ne.devices[e]},getMounts:function(e){for(var t=[],i=[e];i.length;){var s=i.pop();t.push(s),i.push.apply(i,s.mounts)}return t},syncfs:function(e,t){"function"==typeof e&&(t=e,e=!1),Ne.syncFSRequests++,Ne.syncFSRequests>1&&S("warning: "+Ne.syncFSRequests+" FS.syncfs operations in flight at once, probably just doing extra work");var i=Ne.getMounts(Ne.root.mount),s=0;function r(e){return Ne.syncFSRequests--,t(e)}function o(e){if(e)return o.errored?void 0:(o.errored=!0,r(e));++s>=i.length&&r(null)}i.forEach((function(t){if(!t.type.syncfs)return o(null);t.type.syncfs(t,e,o)}))},mount:function(e,t,i){var s,r="/"===i,o=!i;if(r&&Ne.root)throw new Ne.ErrnoError(10);if(!r&&!o){var n=Ne.lookupPath(i,{follow_mount:!1});if(i=n.path,s=n.node,Ne.isMountpoint(s))throw new Ne.ErrnoError(10);if(!Ne.isDir(s.mode))throw new Ne.ErrnoError(54)}var a={type:e,opts:t,mountpoint:i,mounts:[]},l=e.mount(a);return l.mount=a,a.root=l,r?Ne.root=l:s&&(s.mounted=a,s.mount&&s.mount.mounts.push(a)),l},unmount:function(e){var t=Ne.lookupPath(e,{follow_mount:!1});if(!Ne.isMountpoint(t.node))throw new Ne.ErrnoError(28);var i=t.node,s=i.mounted,r=Ne.getMounts(s);Object.keys(Ne.nameTable).forEach((function(e){for(var t=Ne.nameTable[e];t;){var i=t.name_next;r.includes(t.mount)&&Ne.destroyNode(t),t=i}})),i.mounted=null;var o=i.mount.mounts.indexOf(s);i.mount.mounts.splice(o,1)},lookup:function(e,t){return e.node_ops.lookup(e,t)},mknod:function(e,t,i){var s=Ne.lookupPath(e,{parent:!0}).node,r=Le.basename(e);if(!r||"."===r||".."===r)throw new Ne.ErrnoError(28);var o=Ne.mayCreate(s,r);if(o)throw new Ne.ErrnoError(o);if(!s.node_ops.mknod)throw new Ne.ErrnoError(63);return s.node_ops.mknod(s,r,t,i)},create:function(e,t){return t=void 0!==t?t:438,t&=4095,t|=32768,Ne.mknod(e,t,0)},mkdir:function(e,t){return t=void 0!==t?t:511,t&=1023,t|=16384,Ne.mknod(e,t,0)},mkdirTree:function(e,t){for(var i=e.split("/"),s="",r=0;r<i.length;++r)if(i[r]){s+="/"+i[r];try{Ne.mkdir(s,t)}catch(e){if(20!=e.errno)throw e}}},mkdev:function(e,t,i){return void 0===i&&(i=t,t=438),t|=8192,Ne.mknod(e,t,i)},symlink:function(e,t){if(!Be.resolve(e))throw new Ne.ErrnoError(44);var i=Ne.lookupPath(t,{parent:!0}).node;if(!i)throw new Ne.ErrnoError(44);var s=Le.basename(t),r=Ne.mayCreate(i,s);if(r)throw new Ne.ErrnoError(r);if(!i.node_ops.symlink)throw new Ne.ErrnoError(63);return i.node_ops.symlink(i,s,e)},rename:function(e,t){var i,s,r=Le.dirname(e),o=Le.dirname(t),n=Le.basename(e),a=Le.basename(t);if(i=Ne.lookupPath(e,{parent:!0}).node,s=Ne.lookupPath(t,{parent:!0}).node,!i||!s)throw new Ne.ErrnoError(44);if(i.mount!==s.mount)throw new Ne.ErrnoError(75);var l,h=Ne.lookupNode(i,n),c=Be.relative(e,o);if("."!==c.charAt(0))throw new Ne.ErrnoError(28);if("."!==(c=Be.relative(t,r)).charAt(0))throw new Ne.ErrnoError(55);try{l=Ne.lookupNode(s,a)}catch(e){}if(h!==l){var u=Ne.isDir(h.mode),d=Ne.mayDelete(i,n,u);if(d)throw new Ne.ErrnoError(d);if(d=l?Ne.mayDelete(s,a,u):Ne.mayCreate(s,a))throw new Ne.ErrnoError(d);if(!i.node_ops.rename)throw new Ne.ErrnoError(63);if(Ne.isMountpoint(h)||l&&Ne.isMountpoint(l))throw new Ne.ErrnoError(10);if(s!==i&&(d=Ne.nodePermissions(i,"w")))throw new Ne.ErrnoError(d);try{Ne.trackingDelegate.willMovePath&&Ne.trackingDelegate.willMovePath(e,t)}catch(i){S("FS.trackingDelegate['willMovePath']('"+e+"', '"+t+"') threw an exception: "+i.message)}Ne.hashRemoveNode(h);try{i.node_ops.rename(h,s,a)}catch(e){throw e}finally{Ne.hashAddNode(h)}try{Ne.trackingDelegate.onMovePath&&Ne.trackingDelegate.onMovePath(e,t)}catch(i){S("FS.trackingDelegate['onMovePath']('"+e+"', '"+t+"') threw an exception: "+i.message)}}},rmdir:function(e){var t=Ne.lookupPath(e,{parent:!0}).node,i=Le.basename(e),s=Ne.lookupNode(t,i),r=Ne.mayDelete(t,i,!0);if(r)throw new Ne.ErrnoError(r);if(!t.node_ops.rmdir)throw new Ne.ErrnoError(63);if(Ne.isMountpoint(s))throw new Ne.ErrnoError(10);try{Ne.trackingDelegate.willDeletePath&&Ne.trackingDelegate.willDeletePath(e)}catch(t){S("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.rmdir(t,i),Ne.destroyNode(s);try{Ne.trackingDelegate.onDeletePath&&Ne.trackingDelegate.onDeletePath(e)}catch(t){S("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readdir:function(e){var t=Ne.lookupPath(e,{follow:!0}).node;if(!t.node_ops.readdir)throw new Ne.ErrnoError(54);return t.node_ops.readdir(t)},unlink:function(e){var t=Ne.lookupPath(e,{parent:!0}).node,i=Le.basename(e),s=Ne.lookupNode(t,i),r=Ne.mayDelete(t,i,!1);if(r)throw new Ne.ErrnoError(r);if(!t.node_ops.unlink)throw new Ne.ErrnoError(63);if(Ne.isMountpoint(s))throw new Ne.ErrnoError(10);try{Ne.trackingDelegate.willDeletePath&&Ne.trackingDelegate.willDeletePath(e)}catch(t){S("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.unlink(t,i),Ne.destroyNode(s);try{Ne.trackingDelegate.onDeletePath&&Ne.trackingDelegate.onDeletePath(e)}catch(t){S("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readlink:function(e){var t=Ne.lookupPath(e).node;if(!t)throw new Ne.ErrnoError(44);if(!t.node_ops.readlink)throw new Ne.ErrnoError(28);return Be.resolve(Ne.getPath(t.parent),t.node_ops.readlink(t))},stat:function(e,t){var i=Ne.lookupPath(e,{follow:!t}).node;if(!i)throw new Ne.ErrnoError(44);if(!i.node_ops.getattr)throw new Ne.ErrnoError(63);return i.node_ops.getattr(i)},lstat:function(e){return Ne.stat(e,!0)},chmod:function(e,t,i){var s;if(!(s="string"==typeof e?Ne.lookupPath(e,{follow:!i}).node:e).node_ops.setattr)throw new Ne.ErrnoError(63);s.node_ops.setattr(s,{mode:4095&t|-4096&s.mode,timestamp:Date.now()})},lchmod:function(e,t){Ne.chmod(e,t,!0)},fchmod:function(e,t){var i=Ne.getStream(e);if(!i)throw new Ne.ErrnoError(8);Ne.chmod(i.node,t)},chown:function(e,t,i,s){var r;if(!(r="string"==typeof e?Ne.lookupPath(e,{follow:!s}).node:e).node_ops.setattr)throw new Ne.ErrnoError(63);r.node_ops.setattr(r,{timestamp:Date.now()})},lchown:function(e,t,i){Ne.chown(e,t,i,!0)},fchown:function(e,t,i){var s=Ne.getStream(e);if(!s)throw new Ne.ErrnoError(8);Ne.chown(s.node,t,i)},truncate:function(e,t){if(t<0)throw new Ne.ErrnoError(28);var i;if(!(i="string"==typeof e?Ne.lookupPath(e,{follow:!0}).node:e).node_ops.setattr)throw new Ne.ErrnoError(63);if(Ne.isDir(i.mode))throw new Ne.ErrnoError(31);if(!Ne.isFile(i.mode))throw new Ne.ErrnoError(28);var s=Ne.nodePermissions(i,"w");if(s)throw new Ne.ErrnoError(s);i.node_ops.setattr(i,{size:t,timestamp:Date.now()})},ftruncate:function(e,t){var i=Ne.getStream(e);if(!i)throw new Ne.ErrnoError(8);if(0==(2097155&i.flags))throw new Ne.ErrnoError(28);Ne.truncate(i.node,t)},utime:function(e,t,i){var s=Ne.lookupPath(e,{follow:!0}).node;s.node_ops.setattr(s,{timestamp:Math.max(t,i)})},open:function(e,t,i,s,r){if(""===e)throw new Ne.ErrnoError(44);var o;if(i=void 0===i?438:i,i=64&(t="string"==typeof t?Ne.modeStringToFlags(t):t)?4095&i|32768:0,"object"==typeof e)o=e;else{e=Le.normalize(e);try{o=Ne.lookupPath(e,{follow:!(131072&t)}).node}catch(e){}}var n=!1;if(64&t)if(o){if(128&t)throw new Ne.ErrnoError(20)}else o=Ne.mknod(e,i,0),n=!0;if(!o)throw new Ne.ErrnoError(44);if(Ne.isChrdev(o.mode)&&(t&=-513),65536&t&&!Ne.isDir(o.mode))throw new Ne.ErrnoError(54);if(!n){var a=Ne.mayOpen(o,t);if(a)throw new Ne.ErrnoError(a)}512&t&&Ne.truncate(o,0),t&=-131713;var l=Ne.createStream({node:o,path:Ne.getPath(o),flags:t,seekable:!0,position:0,stream_ops:o.stream_ops,ungotten:[],error:!1},s,r);l.stream_ops.open&&l.stream_ops.open(l),!u.logReadFiles||1&t||(Ne.readFiles||(Ne.readFiles={}),e in Ne.readFiles||(Ne.readFiles[e]=1,S("FS.trackingDelegate error on read file: "+e)));try{if(Ne.trackingDelegate.onOpenFile){var h=0;1!=(2097155&t)&&(h|=Ne.tracking.openFlags.READ),0!=(2097155&t)&&(h|=Ne.tracking.openFlags.WRITE),Ne.trackingDelegate.onOpenFile(e,h)}}catch(t){S("FS.trackingDelegate['onOpenFile']('"+e+"', flags) threw an exception: "+t.message)}return l},close:function(e){if(Ne.isClosed(e))throw new Ne.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e)}catch(e){throw e}finally{Ne.closeStream(e.fd)}e.fd=null},isClosed:function(e){return null===e.fd},llseek:function(e,t,i){if(Ne.isClosed(e))throw new Ne.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new Ne.ErrnoError(70);if(0!=i&&1!=i&&2!=i)throw new Ne.ErrnoError(28);return e.position=e.stream_ops.llseek(e,t,i),e.ungotten=[],e.position},read:function(e,t,i,s,r){if(i>>>=0,s<0||r<0)throw new Ne.ErrnoError(28);if(Ne.isClosed(e))throw new Ne.ErrnoError(8);if(1==(2097155&e.flags))throw new Ne.ErrnoError(8);if(Ne.isDir(e.node.mode))throw new Ne.ErrnoError(31);if(!e.stream_ops.read)throw new Ne.ErrnoError(28);var o=void 0!==r;if(o){if(!e.seekable)throw new Ne.ErrnoError(70)}else r=e.position;var n=e.stream_ops.read(e,t,i,s,r);return o||(e.position+=n),n},write:function(e,t,i,s,r,o){if(i>>>=0,s<0||r<0)throw new Ne.ErrnoError(28);if(Ne.isClosed(e))throw new Ne.ErrnoError(8);if(0==(2097155&e.flags))throw new Ne.ErrnoError(8);if(Ne.isDir(e.node.mode))throw new Ne.ErrnoError(31);if(!e.stream_ops.write)throw new Ne.ErrnoError(28);e.seekable&&1024&e.flags&&Ne.llseek(e,0,2);var n=void 0!==r;if(n){if(!e.seekable)throw new Ne.ErrnoError(70)}else r=e.position;var a=e.stream_ops.write(e,t,i,s,r,o);n||(e.position+=a);try{e.path&&Ne.trackingDelegate.onWriteToFile&&Ne.trackingDelegate.onWriteToFile(e.path)}catch(t){S("FS.trackingDelegate['onWriteToFile']('"+e.path+"') threw an exception: "+t.message)}return a},allocate:function(e,t,i){if(Ne.isClosed(e))throw new Ne.ErrnoError(8);if(t<0||i<=0)throw new Ne.ErrnoError(28);if(0==(2097155&e.flags))throw new Ne.ErrnoError(8);if(!Ne.isFile(e.node.mode)&&!Ne.isDir(e.node.mode))throw new Ne.ErrnoError(43);if(!e.stream_ops.allocate)throw new Ne.ErrnoError(138);e.stream_ops.allocate(e,t,i)},mmap:function(e,t,i,s,r,o){if(t>>>=0,0!=(2&r)&&0==(2&o)&&2!=(2097155&e.flags))throw new Ne.ErrnoError(2);if(1==(2097155&e.flags))throw new Ne.ErrnoError(2);if(!e.stream_ops.mmap)throw new Ne.ErrnoError(43);return e.stream_ops.mmap(e,t,i,s,r,o)},msync:function(e,t,i,s,r){return i>>>=0,e&&e.stream_ops.msync?e.stream_ops.msync(e,t,i,s,r):0},munmap:function(e){return 0},ioctl:function(e,t,i){if(!e.stream_ops.ioctl)throw new Ne.ErrnoError(59);return e.stream_ops.ioctl(e,t,i)},readFile:function(e,t){if((t=t||{}).flags=t.flags||0,t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error('Invalid encoding type "'+t.encoding+'"');var i,s=Ne.open(e,t.flags),r=Ne.stat(e).size,o=new Uint8Array(r);return Ne.read(s,o,0,r,0),"utf8"===t.encoding?i=j(o,0):"binary"===t.encoding&&(i=o),Ne.close(s),i},writeFile:function(e,t,i){(i=i||{}).flags=i.flags||577;var s=Ne.open(e,i.flags,i.mode);if("string"==typeof t){var r=new Uint8Array(G(t)+1),o=z(t,r,0,r.length);Ne.write(s,r,0,o,void 0,i.canOwn)}else{if(!ArrayBuffer.isView(t))throw new Error("Unsupported data type");Ne.write(s,t,0,t.byteLength,void 0,i.canOwn)}Ne.close(s)},cwd:function(){return Ne.currentPath},chdir:function(e){var t=Ne.lookupPath(e,{follow:!0});if(null===t.node)throw new Ne.ErrnoError(44);if(!Ne.isDir(t.node.mode))throw new Ne.ErrnoError(54);var i=Ne.nodePermissions(t.node,"x");if(i)throw new Ne.ErrnoError(i);Ne.currentPath=t.path},createDefaultDirectories:function(){Ne.mkdir("/tmp"),Ne.mkdir("/home"),Ne.mkdir("/home/web_user")},createDefaultDevices:function(){Ne.mkdir("/dev"),Ne.registerDevice(Ne.makedev(1,3),{read:function(){return 0},write:function(e,t,i,s,r){return s}}),Ne.mkdev("/dev/null",Ne.makedev(1,3)),Re.register(Ne.makedev(5,0),Re.default_tty_ops),Re.register(Ne.makedev(6,0),Re.default_tty1_ops),Ne.mkdev("/dev/tty",Ne.makedev(5,0)),Ne.mkdev("/dev/tty1",Ne.makedev(6,0));var e=function(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues){var e=new Uint8Array(1);return function(){return crypto.getRandomValues(e),e[0]}}if(w)try{var t=op();return function(){return t.randomBytes(1)[0]}}catch(e){}return function(){Pe("randomDevice")}}();Ne.createDevice("/dev","random",e),Ne.createDevice("/dev","urandom",e),Ne.mkdir("/dev/shm"),Ne.mkdir("/dev/shm/tmp")},createSpecialDirectories:function(){Ne.mkdir("/proc");var e=Ne.mkdir("/proc/self");Ne.mkdir("/proc/self/fd"),Ne.mount({mount:function(){var t=Ne.createNode(e,"fd",16895,73);return t.node_ops={lookup:function(e,t){var i=+t,s=Ne.getStream(i);if(!s)throw new Ne.ErrnoError(8);var r={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:function(){return s.path}}};return r.parent=r,r}},t}},{},"/proc/self/fd")},createStandardStreams:function(){u.stdin?Ne.createDevice("/dev","stdin",u.stdin):Ne.symlink("/dev/tty","/dev/stdin"),u.stdout?Ne.createDevice("/dev","stdout",null,u.stdout):Ne.symlink("/dev/tty","/dev/stdout"),u.stderr?Ne.createDevice("/dev","stderr",null,u.stderr):Ne.symlink("/dev/tty1","/dev/stderr"),Ne.open("/dev/stdin",0),Ne.open("/dev/stdout",1),Ne.open("/dev/stderr",1)},ensureErrnoError:function(){Ne.ErrnoError||(Ne.ErrnoError=function(e,t){this.node=t,this.setErrno=function(e){this.errno=e},this.setErrno(e),this.message="FS error"},Ne.ErrnoError.prototype=new Error,Ne.ErrnoError.prototype.constructor=Ne.ErrnoError,[44].forEach((function(e){Ne.genericErrors[e]=new Ne.ErrnoError(e),Ne.genericErrors[e].stack="<generic error, no stack>"})))},staticInit:function(){Ne.ensureErrnoError(),Ne.nameTable=new Array(4096),Ne.mount(Oe,{},"/"),Ne.createDefaultDirectories(),Ne.createDefaultDevices(),Ne.createSpecialDirectories(),Ne.filesystems={MEMFS:Oe}},init:function(e,t,i){Ne.init.initialized=!0,Ne.ensureErrnoError(),u.stdin=e||u.stdin,u.stdout=t||u.stdout,u.stderr=i||u.stderr,Ne.createStandardStreams()},quit:function(){Ne.init.initialized=!1;var e=u._fflush;e&&e(0);for(var t=0;t<Ne.streams.length;t++){var i=Ne.streams[t];i&&Ne.close(i)}},getMode:function(e,t){var i=0;return e&&(i|=365),t&&(i|=146),i},findObject:function(e,t){var i=Ne.analyzePath(e,t);return i.exists?i.object:null},analyzePath:function(e,t){try{e=(s=Ne.lookupPath(e,{follow:!t})).path}catch(e){}var i={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var s=Ne.lookupPath(e,{parent:!0});i.parentExists=!0,i.parentPath=s.path,i.parentObject=s.node,i.name=Le.basename(e),s=Ne.lookupPath(e,{follow:!t}),i.exists=!0,i.path=s.path,i.object=s.node,i.name=s.node.name,i.isRoot="/"===s.path}catch(e){i.error=e.errno}return i},createPath:function(e,t,i,s){e="string"==typeof e?e:Ne.getPath(e);for(var r=t.split("/").reverse();r.length;){var o=r.pop();if(o){var n=Le.join2(e,o);try{Ne.mkdir(n)}catch(e){}e=n}}return n},createFile:function(e,t,i,s,r){var o=Le.join2("string"==typeof e?e:Ne.getPath(e),t),n=Ne.getMode(s,r);return Ne.create(o,n)},createDataFile:function(e,t,i,s,r,o){var n=t?Le.join2("string"==typeof e?e:Ne.getPath(e),t):e,a=Ne.getMode(s,r),l=Ne.create(n,a);if(i){if("string"==typeof i){for(var h=new Array(i.length),c=0,u=i.length;c<u;++c)h[c]=i.charCodeAt(c);i=h}Ne.chmod(l,146|a);var d=Ne.open(l,577);Ne.write(d,i,0,i.length,0,o),Ne.close(d),Ne.chmod(l,a)}return l},createDevice:function(e,t,i,s){var r=Le.join2("string"==typeof e?e:Ne.getPath(e),t),o=Ne.getMode(!!i,!!s);Ne.createDevice.major||(Ne.createDevice.major=64);var n=Ne.makedev(Ne.createDevice.major++,0);return Ne.registerDevice(n,{open:function(e){e.seekable=!1},close:function(e){s&&s.buffer&&s.buffer.length&&s(10)},read:function(e,t,s,r,o){for(var n=0,a=0;a<r;a++){var l;try{l=i()}catch(e){throw new Ne.ErrnoError(29)}if(void 0===l&&0===n)throw new Ne.ErrnoError(6);if(null==l)break;n++,t[s+a]=l}return n&&(e.node.timestamp=Date.now()),n},write:function(e,t,i,r,o){for(var n=0;n<r;n++)try{s(t[i+n])}catch(e){throw new Ne.ErrnoError(29)}return r&&(e.node.timestamp=Date.now()),n}}),Ne.mkdev(r,o,n)},forceLoadFile:function(e){if(e.isDevice||e.isFolder||e.link||e.contents)return!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!f)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=Hi(f(e.url),!0),e.usedBytes=e.contents.length}catch(e){throw new Ne.ErrnoError(29)}},createLazyFile:function(e,t,i,s,r){function o(){this.lengthKnown=!1,this.chunks=[]}if(o.prototype.get=function(e){if(!(e>this.length-1||e<0)){var t=e%this.chunkSize,i=e/this.chunkSize|0;return this.getter(i)[t]}},o.prototype.setDataGetter=function(e){this.getter=e},o.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",i,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+i+". Status: "+e.status);var t,s=Number(e.getResponseHeader("Content-length")),r=(t=e.getResponseHeader("Accept-Ranges"))&&"bytes"===t,o=(t=e.getResponseHeader("Content-Encoding"))&&"gzip"===t,n=1048576;r||(n=s);var a=this;a.setDataGetter((function(e){var t=e*n,r=(e+1)*n-1;if(r=Math.min(r,s-1),void 0===a.chunks[e]&&(a.chunks[e]=function(e,t){if(e>t)throw new Error("invalid range ("+e+", "+t+") or no bytes requested!");if(t>s-1)throw new Error("only "+s+" bytes available! programmer error!");var r=new XMLHttpRequest;if(r.open("GET",i,!1),s!==n&&r.setRequestHeader("Range","bytes="+e+"-"+t),"undefined"!=typeof Uint8Array&&(r.responseType="arraybuffer"),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),!(r.status>=200&&r.status<300||304===r.status))throw new Error("Couldn't load "+i+". Status: "+r.status);return void 0!==r.response?new Uint8Array(r.response||[]):Hi(r.responseText||"",!0)}(t,r)),void 0===a.chunks[e])throw new Error("doXHR failed!");return a.chunks[e]})),!o&&s||(n=s=1,s=this.getter(0).length,n=s,T("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=s,this._chunkSize=n,this.lengthKnown=!0},"undefined"!=typeof XMLHttpRequest){if(!P)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var n=new o;Object.defineProperties(n,{length:{get:function(){return this.lengthKnown||this.cacheLength(),this._length}},chunkSize:{get:function(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}});var a={isDevice:!1,contents:n}}else a={isDevice:!1,url:i};var l=Ne.createFile(e,t,a,s,r);a.contents?l.contents=a.contents:a.url&&(l.contents=null,l.url=a.url),Object.defineProperties(l,{usedBytes:{get:function(){return this.contents.length}}});var h={};return Object.keys(l.stream_ops).forEach((function(e){var t=l.stream_ops[e];h[e]=function(){return Ne.forceLoadFile(l),t.apply(null,arguments)}})),h.read=function(e,t,i,s,r){Ne.forceLoadFile(l);var o=e.node.contents;if(r>=o.length)return 0;var n=Math.min(o.length-r,s);if(o.slice)for(var a=0;a<n;a++)t[i+a]=o[r+a];else for(a=0;a<n;a++)t[i+a]=o.get(r+a);return n},l.stream_ops=h,l},createPreloadedFile:function(e,t,i,s,r,o,n,a,l,h){Browser.init();var c=t?Be.resolve(Le.join2(e,t)):e;function d(i){function d(i){h&&h(),a||Ne.createDataFile(e,t,i,s,r,l),o&&o(),ye()}var p=!1;u.preloadPlugins.forEach((function(e){p||e.canHandle(c)&&(e.handle(i,c,d,(function(){n&&n(),ye()})),p=!0)})),p||d(i)}xe(),"string"==typeof i?function(e,t,i,s){var r=s?"":"al "+e;m(e,(function(i){k(i,'Loading data file "'+e+'" failed (no arrayBuffer).'),t(new Uint8Array(i)),r&&ye()}),(function(t){if(!i)throw'Loading data file "'+e+'" failed.';i()})),r&&xe()}(i,(function(e){d(e)}),n):d(i)},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return"EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(e,t,i){t=t||function(){},i=i||function(){};var s=Ne.indexedDB();try{var r=s.open(Ne.DB_NAME(),Ne.DB_VERSION)}catch(e){return i(e)}r.onupgradeneeded=function(){T("creating db"),r.result.createObjectStore(Ne.DB_STORE_NAME)},r.onsuccess=function(){var s=r.result.transaction([Ne.DB_STORE_NAME],"readwrite"),o=s.objectStore(Ne.DB_STORE_NAME),n=0,a=0,l=e.length;function h(){0==a?t():i()}e.forEach((function(e){var t=o.put(Ne.analyzePath(e).object.contents,e);t.onsuccess=function(){++n+a==l&&h()},t.onerror=function(){a++,n+a==l&&h()}})),s.onerror=i},r.onerror=i},loadFilesFromDB:function(e,t,i){t=t||function(){},i=i||function(){};var s=Ne.indexedDB();try{var r=s.open(Ne.DB_NAME(),Ne.DB_VERSION)}catch(e){return i(e)}r.onupgradeneeded=i,r.onsuccess=function(){var s=r.result;try{var o=s.transaction([Ne.DB_STORE_NAME],"readonly")}catch(e){return void i(e)}var n=o.objectStore(Ne.DB_STORE_NAME),a=0,l=0,h=e.length;function c(){0==l?t():i()}e.forEach((function(e){var t=n.get(e);t.onsuccess=function(){Ne.analyzePath(e).exists&&Ne.unlink(e),Ne.createDataFile(Le.dirname(e),Le.basename(e),t.result,!0,!0,!0),++a+l==h&&c()},t.onerror=function(){l++,a+l==h&&c()}})),o.onerror=i},r.onerror=i}},je={mappings:{},DEFAULT_POLLMASK:5,umask:511,calculateAt:function(e,t,i){if("/"===t[0])return t;var s;if(-100===e)s=Ne.cwd();else{var r=Ne.getStream(e);if(!r)throw new Ne.ErrnoError(8);s=r.path}if(0==t.length){if(!i)throw new Ne.ErrnoError(44);return s}return Le.join2(s,t)},doStat:function(e,t,i){try{var s=e(t)}catch(e){if(e&&e.node&&Le.normalize(t)!==Le.normalize(Ne.getPath(e.node)))return-54;throw e}return n()[i>>>2]=s.dev,n()[i+4>>>2]=0,n()[i+8>>>2]=s.ino,n()[i+12>>>2]=s.mode,n()[i+16>>>2]=s.nlink,n()[i+20>>>2]=s.uid,n()[i+24>>>2]=s.gid,n()[i+28>>>2]=s.rdev,n()[i+32>>>2]=0,_e=[s.size>>>0,(ge=s.size,+Math.abs(ge)>=1?ge>0?(0|Math.min(+Math.floor(ge/4294967296),4294967295))>>>0:~~+Math.ceil((ge-+(~~ge>>>0))/4294967296)>>>0:0)],n()[i+40>>>2]=_e[0],n()[i+44>>>2]=_e[1],n()[i+48>>>2]=4096,n()[i+52>>>2]=s.blocks,n()[i+56>>>2]=s.atime.getTime()/1e3|0,n()[i+60>>>2]=0,n()[i+64>>>2]=s.mtime.getTime()/1e3|0,n()[i+68>>>2]=0,n()[i+72>>>2]=s.ctime.getTime()/1e3|0,n()[i+76>>>2]=0,_e=[s.ino>>>0,(ge=s.ino,+Math.abs(ge)>=1?ge>0?(0|Math.min(+Math.floor(ge/4294967296),4294967295))>>>0:~~+Math.ceil((ge-+(~~ge>>>0))/4294967296)>>>0:0)],n()[i+80>>>2]=_e[0],n()[i+84>>>2]=_e[1],0},doMsync:function(e,t,i,r,o){var n=s().slice(e,e+i);Ne.msync(t,n,o,i,r)},doMkdir:function(e,t){return"/"===(e=Le.normalize(e))[e.length-1]&&(e=e.substr(0,e.length-1)),Ne.mkdir(e,t,0),0},doMknod:function(e,t,i){switch(61440&t){case 32768:case 8192:case 24576:case 4096:case 49152:break;default:return-28}return Ne.mknod(e,t,i),0},doReadlink:function(e,i,s){if(s<=0)return-28;var r=Ne.readlink(e),o=Math.min(s,G(r)),n=t()[i+o>>>0];return U(r,i,s+1),t()[i+o>>>0]=n,o},doAccess:function(e,t){if(-8&t)return-28;var i;if(!(i=Ne.lookupPath(e,{follow:!0}).node))return-44;var s="";return 4&t&&(s+="r"),2&t&&(s+="w"),1&t&&(s+="x"),s&&Ne.nodePermissions(i,s)?-2:0},doDup:function(e,t,i){var s=Ne.getStream(i);return s&&Ne.close(s),Ne.open(e,t,0,i,i).fd},doReadv:function(e,i,s,r){for(var o=0,a=0;a<s;a++){var l=n()[i+8*a>>>2],h=n()[i+(8*a+4)>>>2],c=Ne.read(e,t(),l,h,r);if(c<0)return-1;if(o+=c,c<h)break}return o},doWritev:function(e,i,s,r){for(var o=0,a=0;a<s;a++){var l=n()[i+8*a>>>2],h=n()[i+(8*a+4)>>>2],c=Ne.write(e,t(),l,h,r);if(c<0)return-1;o+=c}return o},varargs:void 0,get:function(){return je.varargs+=4,n()[je.varargs-4>>>2]},getStr:function(e){return V(e)},getStreamFromFD:function(e){var t=Ne.getStream(e);if(!t)throw new Ne.ErrnoError(8);return t},get64:function(e,t){return e}};function Ve(e,t,i){if(M)return pi(2,1,e,t,i);je.varargs=i;try{var s=je.getStreamFromFD(e);switch(t){case 0:return(o=je.get())<0?-28:Ne.open(s.path,s.flags,0,o).fd;case 1:case 2:case 13:case 14:return 0;case 3:return s.flags;case 4:var o=je.get();return s.flags|=o,0;case 12:return o=je.get(),r()[o+0>>>1]=2,0;case 16:case 8:default:return-28;case 9:return Ie(28),-1}}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),-e.errno}}function ze(e,t,i){if(M)return pi(3,1,e,t,i);je.varargs=i;try{var s=je.getStreamFromFD(e);switch(t){case 21509:case 21505:case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:case 21523:case 21524:return s.tty?0:-59;case 21519:if(!s.tty)return-59;var r=je.get();return n()[r>>>2]=0,0;case 21520:return s.tty?-28:-59;case 21531:return r=je.get(),Ne.ioctl(s,t,r);default:Pe("bad ioctl syscall "+t)}}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),-e.errno}}function Ue(e,t,i){if(M)return pi(4,1,e,t,i);je.varargs=i;try{var s=je.getStr(e),r=i?je.get():0;return Ne.open(s,t,r).fd}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),-e.errno}}var Ge={};function We(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function He(e){return this.fromWireType(a()[e>>>2])}var Xe={},Ye={},qe={};function $e(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function Ze(e,t){return e=$e(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function Ke(e,t){var i=Ze(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var Qe=void 0;function Je(e){throw new Qe(e)}function et(e,t,i){function s(t){var s=i(t);s.length!==e.length&&Je("Mismatched type converter count");for(var r=0;r<e.length;++r)at(e[r],s[r])}e.forEach((function(e){qe[e]=t}));var r=new Array(t.length),o=[],n=0;t.forEach((function(e,t){Ye.hasOwnProperty(e)?r[t]=Ye[e]:(o.push(e),Xe.hasOwnProperty(e)||(Xe[e]=[]),Xe[e].push((function(){r[t]=Ye[e],++n===o.length&&s(r)})))})),0===o.length&&s(r)}var tt={};function it(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var st=void 0;function rt(e){for(var t="",i=e;s()[i>>>0];)t+=st[s()[i++>>>0]];return t}var ot=void 0;function nt(e){throw new ot(e)}function at(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var s=t.name;if(e||nt('type "'+s+'" must have a positive integer typeid pointer'),Ye.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;nt("Cannot register type '"+s+"' twice")}if(Ye[e]=t,delete qe[e],Xe.hasOwnProperty(e)){var r=Xe[e];delete Xe[e],r.forEach((function(e){e()}))}}function lt(e){if(!(this instanceof Pt))return!1;if(!(e instanceof Pt))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,s=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;s.baseClass;)r=s.upcast(r),s=s.baseClass;return t===s&&i===r}function ht(e){return{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType}}function ct(e){nt(e.$$.ptrType.registeredClass.name+" instance already deleted")}var ut=!1;function dt(e){}function pt(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function ft(e){return"undefined"==typeof FinalizationGroup?(ft=function(e){return e},e):(ut=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?pt(i):console.warn("object already deleted: "+i.ptr)}})),dt=function(e){ut.unregister(e.$$)},(ft=function(e){return ut.register(e,e.$$,e.$$),e})(e))}function mt(){if(this.$$.ptr||ct(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e=ft(Object.create(Object.getPrototypeOf(this),{$$:{value:ht(this.$$)}}));return e.$$.count.value+=1,e.$$.deleteScheduled=!1,e}function gt(){this.$$.ptr||ct(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&nt("Object already scheduled for deletion"),dt(this),pt(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function _t(){return!this.$$.ptr}var vt=void 0,bt=[];function xt(){for(;bt.length;){var e=bt.pop();e.$$.deleteScheduled=!1,e.delete()}}function yt(){return this.$$.ptr||ct(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&nt("Object already scheduled for deletion"),bt.push(this),1===bt.length&&vt&&vt(xt),this.$$.deleteScheduled=!0,this}function Pt(){}var wt={};function Mt(e,t,i){if(void 0===e[t].overloadTable){var s=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||nt("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[s.argCount]=s}}function Ct(e,t,i){u.hasOwnProperty(e)?((void 0===i||void 0!==u[e].overloadTable&&void 0!==u[e].overloadTable[i])&&nt("Cannot register public name '"+e+"' twice"),Mt(u,e,e),u.hasOwnProperty(i)&&nt("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),u[e].overloadTable[i]=t):(u[e]=t,void 0!==i&&(u[e].numArguments=i))}function Et(e,t,i,s,r,o,n,a){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=s,this.baseClass=r,this.getActualType=o,this.upcast=n,this.downcast=a,this.pureVirtualFunctions=[]}function At(e,t,i){for(;t!==i;)t.upcast||nt("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Dt(e,t){if(null===t)return this.isReference&&nt("null is not a valid "+this.name),0;t.$$||nt('Cannot pass "'+oi(t)+'" as a '+this.name),t.$$.ptr||nt("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return At(t.$$.ptr,i,this.registeredClass)}function Tt(e,t){var i;if(null===t)return this.isReference&&nt("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||nt('Cannot pass "'+oi(t)+'" as a '+this.name),t.$$.ptr||nt("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&nt("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var s=t.$$.ptrType.registeredClass;if(i=At(t.$$.ptr,s,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&nt("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:nt("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var r=t.clone();i=this.rawShare(i,ii((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:nt("Unsupporting sharing policy")}return i}function St(e,t){if(null===t)return this.isReference&&nt("null is not a valid "+this.name),0;t.$$||nt('Cannot pass "'+oi(t)+'" as a '+this.name),t.$$.ptr||nt("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&nt("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return At(t.$$.ptr,i,this.registeredClass)}function It(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function Ft(e){this.rawDestructor&&this.rawDestructor(e)}function Lt(e){null!==e&&e.delete()}function Bt(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var s=Bt(e,t,i.baseClass);return null===s?null:i.downcast(s)}function Rt(){return Object.keys(Nt).length}function kt(){var e=[];for(var t in Nt)Nt.hasOwnProperty(t)&&e.push(Nt[t]);return e}function Ot(e){vt=e,bt.length&&vt&&vt(xt)}var Nt={};function jt(e,t){return t=function(e,t){for(void 0===t&&nt("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),Nt[t]}function Vt(e,t){return t.ptrType&&t.ptr||Je("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!=!!t.smartPtr&&Je("Both smartPtrType and smartPtr must be specified"),t.count={value:1},ft(Object.create(e,{$$:{value:t}}))}function zt(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=jt(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var s=i.clone();return this.destructor(e),s}function r(){return this.isSmartPointer?Vt(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Vt(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var o,n=this.registeredClass.getActualType(t),a=wt[n];if(!a)return r.call(this);o=this.isConst?a.constPointerType:a.pointerType;var l=Bt(t,this.registeredClass,o.registeredClass);return null===l?r.call(this):this.isSmartPointer?Vt(o.registeredClass.instancePrototype,{ptrType:o,ptr:l,smartPtrType:this,smartPtr:e}):Vt(o.registeredClass.instancePrototype,{ptrType:o,ptr:l})}function Ut(e,t,i,s,r,o,n,a,l,h,c){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=s,this.isSmartPointer=r,this.pointeeType=o,this.sharingPolicy=n,this.rawGetPointee=a,this.rawConstructor=l,this.rawShare=h,this.rawDestructor=c,r||void 0!==t.baseClass?this.toWireType=Tt:s?(this.toWireType=Dt,this.destructorFunction=null):(this.toWireType=St,this.destructorFunction=null)}function Gt(e,t,i){u.hasOwnProperty(e)||Je("Replacing nonexistant public symbol"),void 0!==u[e].overloadTable&&void 0!==i?u[e].overloadTable[i]=t:(u[e]=t,u[e].argCount=i)}function Wt(e,t,i){return e.includes("j")?function(e,t,i){var s=u["dynCall_"+e];return i&&i.length?s.apply(null,[t].concat(i)):s.call(null,t)}(e,t,i):ae.get(t).apply(null,i)}function Ht(e,t){var i,s,r,o=(e=rt(e)).includes("j")?(i=e,s=t,r=[],function(){r.length=arguments.length;for(var e=0;e<arguments.length;e++)r[e]=arguments[e];return Wt(i,s,r)}):ae.get(t);return"function"!=typeof o&&nt("unknown function pointer with signature "+e+": "+t),o}var Xt=void 0;function Yt(e){var t=$i(e),i=rt(t);return qi(t),i}function qt(e,t){var i=[],s={};throw t.forEach((function e(t){s[t]||Ye[t]||(qe[t]?qe[t].forEach(e):(i.push(t),s[t]=!0))})),new Xt(e+": "+i.map(Yt).join([", "]))}function $t(e,t){for(var i=[],s=0;s<e;s++)i.push(n()[(t>>2)+s>>>0]);return i}function Zt(e,t,i,s,r){var o=t.length;o<2&&nt("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var n=null!==t[1]&&null!==i,a=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){a=!0;break}var h="void"!==t[0].name,c="",u="";for(l=0;l<o-2;++l)c+=(0!==l?", ":"")+"arg"+l,u+=(0!==l?", ":"")+"arg"+l+"Wired";var d="return function "+$e(e)+"("+c+") {\nif (arguments.length !== "+(o-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(o-2)+" args!');\n}\n";a&&(d+="var destructors = [];\n");var p=a?"destructors":"null",f=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],m=[nt,s,r,We,t[0],t[1]];for(n&&(d+="var thisWired = classParam.toWireType("+p+", this);\n"),l=0;l<o-2;++l)d+="var arg"+l+"Wired = argType"+l+".toWireType("+p+", arg"+l+"); // "+t[l+2].name+"\n",f.push("argType"+l),m.push(t[l+2]);if(n&&(u="thisWired"+(u.length>0?", ":"")+u),d+=(h?"var rv = ":"")+"invoker(fn"+(u.length>0?", ":"")+u+");\n",a)d+="runDestructors(destructors);\n";else for(l=n?1:2;l<t.length;++l){var g=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(d+=g+"_dtor("+g+"); // "+t[l].name+"\n",f.push(g+"_dtor"),m.push(t[l].destructorFunction))}h&&(d+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),d+="}\n",f.push(d);var _=function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var i=Ze(e.name||"unknownFunctionName",(function(){}));i.prototype=e.prototype;var s=new i,r=e.apply(s,t);return r instanceof Object?r:s}(Function,f).apply(null,m);return _}var Kt=[],Qt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function Jt(e){e>4&&0==--Qt[e].refcount&&(Qt[e]=void 0,Kt.push(e))}function ei(){for(var e=0,t=5;t<Qt.length;++t)void 0!==Qt[t]&&++e;return e}function ti(){for(var e=5;e<Qt.length;++e)if(void 0!==Qt[e])return Qt[e];return null}function ii(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Kt.length?Kt.pop():Qt.length;return Qt[t]={refcount:1,value:e},t}}function si(e,i,l){switch(i){case 0:return function(e){var i=l?t():s();return this.fromWireType(i[e>>>0])};case 1:return function(e){var t=l?r():o();return this.fromWireType(t[e>>>1])};case 2:return function(e){var t=l?n():a();return this.fromWireType(t[e>>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function ri(e,t){var i=Ye[e];return void 0===i&&nt(t+" has unknown type "+Yt(e)),i}function oi(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function ni(e,t){switch(t){case 2:return function(e){return this.fromWireType((F.buffer!=W&&ne(F.buffer),K)[e>>>2])};case 3:return function(e){return this.fromWireType(l()[e>>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ai(e,i,l){switch(i){case 0:return l?function(e){return t()[e>>>0]}:function(e){return s()[e>>>0]};case 1:return l?function(e){return r()[e>>>1]}:function(e){return o()[e>>>1]};case 2:return l?function(e){return n()[e>>>2]}:function(e){return a()[e>>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function li(e){return e||nt("Cannot use deleted val. handle = "+e),Qt[e].value}var hi={};function ci(e){var t=hi[e];return void 0===t?rt(e):t}function ui(){return"object"==typeof globalThis?globalThis:Function("return this")()}var di=[];function pi(e,t){for(var i=arguments.length-2,s=as(),r=i,o=hs(8*r),n=o>>3,a=0;a<i;a++){var h=arguments[2+a];l()[n+a>>>0]=h}var c=es(e,r,o,t);return ls(s),c}var fi=[];function mi(e){try{return F.grow(e-W.byteLength+65535>>>16),ne(F.buffer),1}catch(e){}}var gi={inEventHandler:0,removeAllEventListeners:function(){for(var e=gi.eventHandlers.length-1;e>=0;--e)gi._removeHandler(e);gi.eventHandlers=[],gi.deferredCalls=[]},registerRemoveEventListeners:function(){gi.removeEventListenersRegistered||(gi.removeEventListenersRegistered=!0)},deferredCalls:[],deferCall:function(e,t,i){function s(e,t){if(e.length!=t.length)return!1;for(var i in e)if(e[i]!=t[i])return!1;return!0}for(var r in gi.deferredCalls){var o=gi.deferredCalls[r];if(o.targetFunction==e&&s(o.argsList,i))return}gi.deferredCalls.push({targetFunction:e,precedence:t,argsList:i}),gi.deferredCalls.sort((function(e,t){return e.precedence<t.precedence}))},removeDeferredCalls:function(e){for(var t=0;t<gi.deferredCalls.length;++t)gi.deferredCalls[t].targetFunction==e&&(gi.deferredCalls.splice(t,1),--t)},canPerformEventHandlerRequests:function(){return gi.inEventHandler&&gi.currentEventHandler.allowsDeferredCalls},runDeferredCalls:function(){if(gi.canPerformEventHandlerRequests())for(var e=0;e<gi.deferredCalls.length;++e){var t=gi.deferredCalls[e];gi.deferredCalls.splice(e,1),--e,t.targetFunction.apply(null,t.argsList)}},eventHandlers:[],removeAllHandlersOnTarget:function(e,t){for(var i=0;i<gi.eventHandlers.length;++i)gi.eventHandlers[i].target!=e||t&&t!=gi.eventHandlers[i].eventTypeString||gi._removeHandler(i--)},_removeHandler:function(e){var t=gi.eventHandlers[e];t.target.removeEventListener(t.eventTypeString,t.eventListenerFunc,t.useCapture),gi.eventHandlers.splice(e,1)},registerOrRemoveHandler:function(e){var t=function(t){++gi.inEventHandler,gi.currentEventHandler=e,gi.runDeferredCalls(),e.handlerFunc(t),gi.runDeferredCalls(),--gi.inEventHandler};if(e.callbackfunc)e.eventListenerFunc=t,e.target.addEventListener(e.eventTypeString,t,e.useCapture),gi.eventHandlers.push(e),gi.registerRemoveEventListeners();else for(var i=0;i<gi.eventHandlers.length;++i)gi.eventHandlers[i].target==e.target&&gi.eventHandlers[i].eventTypeString==e.eventTypeString&&gi._removeHandler(i--)},queueEventHandlerOnThread_iiii:function(e,t,i,s,r){var o=as(),a=hs(12);n()[a>>>2]=i,n()[a+4>>>2]=s,n()[a+8>>>2]=r,ts(0,e,637534208,t,s,a),ls(o)},getTargetThreadForEventCallback:function(e){switch(e){case 1:return 0;case 2:return Se.currentProxiedOperationCallerThread;default:return e}},getNodeNameForTarget:function(e){return e?e==window?"#window":e==screen?"#screen":e&&e.nodeName?e.nodeName:"":""},fullscreenEnabled:function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled}};function _i(e,t,i,s){var r,o,a,l=as(),h=hs(12),c=0;t&&(o=G(r=t)+1,a=Yi(o),U(r,a,o),c=a),n()[h>>>2]=c,n()[h+4>>>2]=i,n()[h+8>>>2]=s,ts(0,e,657457152,0,c,h),ls(l)}var vi=[0,"undefined"!=typeof document?document:0,"undefined"!=typeof window?window:0];function bi(e){var t;return e=(t=e)>2?V(t):t,vi[e]||("undefined"!=typeof document?document.querySelector(e):void 0)}function xi(e){return bi(e)}function yi(e,t,i){var s=xi(e);if(!s)return-4;if(s.canvasSharedPtr&&(n()[s.canvasSharedPtr>>>2]=t,n()[s.canvasSharedPtr+4>>>2]=i),!s.offscreenCanvas&&s.controlTransferredOffscreen)return s.canvasSharedPtr?(function(e,t,i,s){_i(e,t=t?V(t):"",i,s)}(n()[s.canvasSharedPtr+8>>>2],e,t,i),1):-4;s.offscreenCanvas&&(s=s.offscreenCanvas);var r=!1;if(s.GLctxObject&&s.GLctxObject.GLctx){var o=s.GLctxObject.GLctx.getParameter(2978);r=0===o[0]&&0===o[1]&&o[2]===s.width&&o[3]===s.height}return s.width=t,s.height=i,r&&s.GLctxObject.GLctx.viewport(0,0,t,i),0}function Pi(e,t,i){return M?pi(5,1,e,t,i):yi(e,t,i)}var wi={counter:1,buffers:[],programs:[],framebuffers:[],renderbuffers:[],textures:[],shaders:[],vaos:[],contexts:{},offscreenCanvases:{},queries:[],stringCache:{},unpackAlignment:4,recordError:function(e){wi.lastError||(wi.lastError=e)},getNewId:function(e){for(var t=wi.counter++,i=e.length;i<t;i++)e[i]=null;return t},getSource:function(e,t,i,s){for(var r="",o=0;o<t;++o){var a=s?n()[s+4*o>>>2]:-1;r+=V(n()[i+4*o>>>2],a<0?void 0:a)}return r},createContext:function(e,t){e.getContextSafariWebGL2Fixed||(e.getContextSafariWebGL2Fixed=e.getContext,e.getContext=function(t,i){var s=e.getContextSafariWebGL2Fixed(t,i);return"webgl"==t==s instanceof WebGLRenderingContext?s:null});var i=e.getContext("webgl",t);return i?wi.registerContext(i,t):0},registerContext:function(e,t){var i=Yi(8);n()[i+4>>>2]=os();var s={handle:i,attributes:t,version:t.majorVersion,GLctx:e};return e.canvas&&(e.canvas.GLctxObject=s),wi.contexts[i]=s,(void 0===t.enableExtensionsByDefault||t.enableExtensionsByDefault)&&wi.initExtensions(s),i},makeContextCurrent:function(e){return wi.currentContext=wi.contexts[e],u.ctx=Vi=wi.currentContext&&wi.currentContext.GLctx,!(e&&!Vi)},getContext:function(e){return wi.contexts[e]},deleteContext:function(e){wi.currentContext===wi.contexts[e]&&(wi.currentContext=null),"object"==typeof gi&&gi.removeAllHandlersOnTarget(wi.contexts[e].GLctx.canvas),wi.contexts[e]&&wi.contexts[e].GLctx.canvas&&(wi.contexts[e].GLctx.canvas.GLctxObject=void 0),qi(wi.contexts[e].handle),wi.contexts[e]=null},initExtensions:function(e){if(e||(e=wi.currentContext),!e.initExtensionsDone){e.initExtensionsDone=!0;var t,i=e.GLctx;!function(e){var t=e.getExtension("ANGLE_instanced_arrays");t&&(e.vertexAttribDivisor=function(e,i){t.vertexAttribDivisorANGLE(e,i)},e.drawArraysInstanced=function(e,i,s,r){t.drawArraysInstancedANGLE(e,i,s,r)},e.drawElementsInstanced=function(e,i,s,r,o){t.drawElementsInstancedANGLE(e,i,s,r,o)})}(i),function(e){var t=e.getExtension("OES_vertex_array_object");t&&(e.createVertexArray=function(){return t.createVertexArrayOES()},e.deleteVertexArray=function(e){t.deleteVertexArrayOES(e)},e.bindVertexArray=function(e){t.bindVertexArrayOES(e)},e.isVertexArray=function(e){return t.isVertexArrayOES(e)})}(i),function(e){var t=e.getExtension("WEBGL_draw_buffers");t&&(e.drawBuffers=function(e,i){t.drawBuffersWEBGL(e,i)})}(i),i.disjointTimerQueryExt=i.getExtension("EXT_disjoint_timer_query"),(t=i).multiDrawWebgl=t.getExtension("WEBGL_multi_draw"),(i.getSupportedExtensions()||[]).forEach((function(e){e.includes("lose_context")||e.includes("debug")||i.getExtension(e)}))}}},Mi=["default","low-power","high-performance"],Ci={};function Ei(){if(!Ei.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:b||"./this.program"};for(var t in Ci)void 0===Ci[t]?delete e[t]:e[t]=Ci[t];var i=[];for(var t in e)i.push(t+"="+e[t]);Ei.strings=i}return Ei.strings}function Ai(e,i){if(M)return pi(6,1,e,i);try{var s=0;return Ei().forEach((function(r,o){var a=i+s;n()[e+4*o>>>2]=a,function(e,i,s){for(var r=0;r<e.length;++r)t()[i++>>>0]=e.charCodeAt(r);s||(t()[i>>>0]=0)}(r,a),s+=r.length+1})),0}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),e.errno}}function Di(e,t){if(M)return pi(7,1,e,t);try{var i=Ei();n()[e>>>2]=i.length;var s=0;return i.forEach((function(e){s+=e.length+1})),n()[t>>>2]=s,0}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),e.errno}}function Ti(e){if(M)return pi(8,1,e);try{var t=je.getStreamFromFD(e);return Ne.close(t),0}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),e.errno}}function Si(e,t,i,s){if(M)return pi(9,1,e,t,i,s);try{var r=je.getStreamFromFD(e),o=je.doReadv(r,t,i);return n()[s>>>2]=o,0}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),e.errno}}function Ii(e,t,i,s,r){if(M)return pi(10,1,e,t,i,s,r);try{var o=je.getStreamFromFD(e),a=4294967296*i+(t>>>0),l=9007199254740992;return a<=-l||a>=l?-61:(Ne.llseek(o,a,s),_e=[o.position>>>0,(ge=o.position,+Math.abs(ge)>=1?ge>0?(0|Math.min(+Math.floor(ge/4294967296),4294967295))>>>0:~~+Math.ceil((ge-+(~~ge>>>0))/4294967296)>>>0:0)],n()[r>>>2]=_e[0],n()[r+4>>>2]=_e[1],o.getdents&&0===a&&0===s&&(o.getdents=null),0)}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),e.errno}}function Fi(e,t,i,s){if(M)return pi(11,1,e,t,i,s);try{var r=je.getStreamFromFD(e),o=je.doWritev(r,t,i);return n()[s>>>2]=o,0}catch(e){return void 0!==Ne&&e instanceof Ne.ErrnoError||Pe(e),e.errno}}function Li(e){if(M)throw"Internal Error! spawnThread() can only ever be called from main application thread!";var t=Se.getNewWorker();if(!t)return 6;if(void 0!==t.pthread)throw"Internal error!";if(!e.pthread_ptr)throw"Internal error, no pthread ptr!";Se.runningWorkers.push(t);for(var i=Yi(512),s=0;s<128;++s)n()[i+4*s>>>2]=0;var r=e.stackBase+e.stackSize,o=Se.pthreads[e.pthread_ptr]={worker:t,stackBase:e.stackBase,stackSize:e.stackSize,allocatedOwnStack:e.allocatedOwnStack,threadInfoStruct:e.pthread_ptr},l=o.threadInfoStruct>>2;Atomics.store(a(),l+16,e.detached),Atomics.store(a(),l+25,i),Atomics.store(a(),l+10,o.threadInfoStruct),Atomics.store(a(),l+20,e.stackSize),Atomics.store(a(),l+19,r),Atomics.store(a(),l+26,e.stackSize),Atomics.store(a(),l+28,r),Atomics.store(a(),l+29,e.detached);var h=ss()+40;Atomics.store(a(),l+43,h),t.pthread=o;var c={cmd:"run",start_routine:e.startRoutine,arg:e.arg,threadInfoStruct:e.pthread_ptr,stackBase:e.stackBase,stackSize:e.stackSize};return t.runPthread=function(){c.time=performance.now(),t.postMessage(c,e.transferList)},t.loaded&&(t.runPthread(),delete t.runPthread),0}function Bi(e){return e%4==0&&(e%100!=0||e%400==0)}function Ri(e,t){for(var i=0,s=0;s<=t;i+=e[s++]);return i}var ki=[31,29,31,30,31,30,31,31,30,31,30,31],Oi=[31,28,31,30,31,30,31,31,30,31,30,31];function Ni(e,t){for(var i=new Date(e.getTime());t>0;){var s=Bi(i.getFullYear()),r=i.getMonth(),o=(s?ki:Oi)[r];if(!(t>o-i.getDate()))return i.setDate(i.getDate()+t),i;t-=o-i.getDate()+1,i.setDate(1),r<11?i.setMonth(r+1):(i.setMonth(0),i.setFullYear(i.getFullYear()+1))}return i}function ji(e,i,s,r){var o=n()[r+40>>>2],a={tm_sec:n()[r>>>2],tm_min:n()[r+4>>>2],tm_hour:n()[r+8>>>2],tm_mday:n()[r+12>>>2],tm_mon:n()[r+16>>>2],tm_year:n()[r+20>>>2],tm_wday:n()[r+24>>>2],tm_yday:n()[r+28>>>2],tm_isdst:n()[r+32>>>2],tm_gmtoff:n()[r+36>>>2],tm_zone:o?V(o):""},l=V(s),h={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var c in h)l=l.replace(new RegExp(c,"g"),h[c]);var u=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=["January","February","March","April","May","June","July","August","September","October","November","December"];function p(e,t,i){for(var s="number"==typeof e?e.toString():e||"";s.length<t;)s=i[0]+s;return s}function f(e,t){return p(e,t,"0")}function m(e,t){function i(e){return e<0?-1:e>0?1:0}var s;return 0===(s=i(e.getFullYear()-t.getFullYear()))&&0===(s=i(e.getMonth()-t.getMonth()))&&(s=i(e.getDate()-t.getDate())),s}function g(e){switch(e.getDay()){case 0:return new Date(e.getFullYear()-1,11,29);case 1:return e;case 2:return new Date(e.getFullYear(),0,3);case 3:return new Date(e.getFullYear(),0,2);case 4:return new Date(e.getFullYear(),0,1);case 5:return new Date(e.getFullYear()-1,11,31);case 6:return new Date(e.getFullYear()-1,11,30)}}function _(e){var t=Ni(new Date(e.tm_year+1900,0,1),e.tm_yday),i=new Date(t.getFullYear(),0,4),s=new Date(t.getFullYear()+1,0,4),r=g(i),o=g(s);return m(r,t)<=0?m(o,t)<=0?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}var v={"%a":function(e){return u[e.tm_wday].substring(0,3)},"%A":function(e){return u[e.tm_wday]},"%b":function(e){return d[e.tm_mon].substring(0,3)},"%B":function(e){return d[e.tm_mon]},"%C":function(e){return f((e.tm_year+1900)/100|0,2)},"%d":function(e){return f(e.tm_mday,2)},"%e":function(e){return p(e.tm_mday,2," ")},"%g":function(e){return _(e).toString().substring(2)},"%G":function(e){return _(e)},"%H":function(e){return f(e.tm_hour,2)},"%I":function(e){var t=e.tm_hour;return 0==t?t=12:t>12&&(t-=12),f(t,2)},"%j":function(e){return f(e.tm_mday+Ri(Bi(e.tm_year+1900)?ki:Oi,e.tm_mon-1),3)},"%m":function(e){return f(e.tm_mon+1,2)},"%M":function(e){return f(e.tm_min,2)},"%n":function(){return"\n"},"%p":function(e){return e.tm_hour>=0&&e.tm_hour<12?"AM":"PM"},"%S":function(e){return f(e.tm_sec,2)},"%t":function(){return"\t"},"%u":function(e){return e.tm_wday||7},"%U":function(e){var t=new Date(e.tm_year+1900,0,1),i=0===t.getDay()?t:Ni(t,7-t.getDay()),s=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(m(i,s)<0){var r=Ri(Bi(s.getFullYear())?ki:Oi,s.getMonth()-1)-31,o=31-i.getDate()+r+s.getDate();return f(Math.ceil(o/7),2)}return 0===m(i,t)?"01":"00"},"%V":function(e){var t,i=new Date(e.tm_year+1900,0,4),s=new Date(e.tm_year+1901,0,4),r=g(i),o=g(s),n=Ni(new Date(e.tm_year+1900,0,1),e.tm_yday);return m(n,r)<0?"53":m(o,n)<=0?"01":(t=r.getFullYear()<e.tm_year+1900?e.tm_yday+32-r.getDate():e.tm_yday+1-r.getDate(),f(Math.ceil(t/7),2))},"%w":function(e){return e.tm_wday},"%W":function(e){var t=new Date(e.tm_year,0,1),i=1===t.getDay()?t:Ni(t,0===t.getDay()?1:7-t.getDay()+1),s=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(m(i,s)<0){var r=Ri(Bi(s.getFullYear())?ki:Oi,s.getMonth()-1)-31,o=31-i.getDate()+r+s.getDate();return f(Math.ceil(o/7),2)}return 0===m(i,t)?"01":"00"},"%y":function(e){return(e.tm_year+1900).toString().substring(2)},"%Y":function(e){return e.tm_year+1900},"%z":function(e){var t=e.tm_gmtoff,i=t>=0;return t=(t=Math.abs(t)/60)/60*100+t%60,(i?"+":"-")+String("0000"+t).slice(-4)},"%Z":function(e){return e.tm_zone},"%%":function(){return"%"}};for(var c in v)l.includes(c)&&(l=l.replace(new RegExp(c,"g"),v[c](a)));var b,x,y=Hi(l,!1);return y.length>i?0:(b=y,x=e,t().set(b,x>>>0),y.length-1)}M||Se.initMainThreadBlock();var Vi,zi=function(e,t,i,s){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=Ne.nextInode++,this.name=t,this.mode=i,this.node_ops={},this.stream_ops={},this.rdev=s},Ui=365,Gi=146;Object.defineProperties(zi.prototype,{read:{get:function(){return(this.mode&Ui)===Ui},set:function(e){e?this.mode|=Ui:this.mode&=-366}},write:{get:function(){return(this.mode&Gi)===Gi},set:function(e){e?this.mode|=Gi:this.mode&=-147}},isFolder:{get:function(){return Ne.isDir(this.mode)}},isDevice:{get:function(){return Ne.isChrdev(this.mode)}}}),Ne.FSNode=zi,Ne.staticInit(),u.FS_createPath=Ne.createPath,u.FS_createDataFile=Ne.createDataFile,u.FS_createPreloadedFile=Ne.createPreloadedFile,u.FS_createLazyFile=Ne.createLazyFile,u.FS_createDevice=Ne.createDevice,u.FS_unlink=Ne.unlink,Qe=u.InternalError=Ke(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);st=e}(),ot=u.BindingError=Ke(Error,"BindingError"),Pt.prototype.isAliasOf=lt,Pt.prototype.clone=mt,Pt.prototype.delete=gt,Pt.prototype.isDeleted=_t,Pt.prototype.deleteLater=yt,Ut.prototype.getPointee=It,Ut.prototype.destructor=Ft,Ut.prototype.argPackAdvance=8,Ut.prototype.readValueFromPointer=He,Ut.prototype.deleteObject=Lt,Ut.prototype.fromWireType=zt,u.getInheritedInstanceCount=Rt,u.getLiveInheritedInstances=kt,u.flushPendingDeletes=xt,u.setDelayFunction=Ot,Xt=u.UnboundTypeError=Ke(Error,"UnboundTypeError"),u.count_emval_handles=ei,u.get_first_emval=ti;var Wi=[null,function(e,t){if(M)return pi(1,1,e,t)},Ve,ze,Ue,Pi,Ai,Di,Ti,Si,Ii,Fi];function Hi(e,t,i){var s=i>0?i:G(e)+1,r=new Array(s),o=z(e,r,0,r.length);return t&&(r.length=o),r}var Xi={l:function(e,t,i,s){Pe("Assertion failed: "+V(e)+", at: "+[t?V(t):"unknown filename",i,s?V(s):"unknown function"])},B:function(e){return Yi(e+16)+16},ka:function(e,t){Se.threadExitHandlers.push((function(){ae.get(e)(t)}))},A:function(e,t,i){throw new Fe(e).init(t,i),e},D:Ve,V:ze,W:Ue,ma:function(e){var t=Ge[e];delete Ge[e];var i=t.elements,s=i.length,r=i.map((function(e){return e.getterReturnType})).concat(i.map((function(e){return e.setterArgumentType}))),o=t.rawConstructor,n=t.rawDestructor;et([e],r,(function(e){return i.forEach((function(t,i){var r=e[i],o=t.getter,n=t.getterContext,a=e[i+s],l=t.setter,h=t.setterContext;t.read=function(e){return r.fromWireType(o(n,e))},t.write=function(e,t){var i=[];l(h,e,a.toWireType(i,t)),We(i)}})),[{name:t.name,fromWireType:function(e){for(var t=new Array(s),r=0;r<s;++r)t[r]=i[r].read(e);return n(e),t},toWireType:function(e,r){if(s!==r.length)throw new TypeError("Incorrect number of tuple elements for "+t.name+": expected="+s+", actual="+r.length);for(var a=o(),l=0;l<s;++l)i[l].write(a,r[l]);return null!==e&&e.push(n,a),a},argPackAdvance:8,readValueFromPointer:He,destructorFunction:n}]}))},s:function(e){var t=tt[e];delete tt[e];var i=t.rawConstructor,s=t.rawDestructor,r=t.fields;et([e],r.map((function(e){return e.getterReturnType})).concat(r.map((function(e){return e.setterArgumentType}))),(function(e){var o={};return r.forEach((function(t,i){var s=t.fieldName,n=e[i],a=t.getter,l=t.getterContext,h=e[i+r.length],c=t.setter,u=t.setterContext;o[s]={read:function(e){return n.fromWireType(a(l,e))},write:function(e,t){var i=[];c(u,e,h.toWireType(i,t)),We(i)}}})),[{name:t.name,fromWireType:function(e){var t={};for(var i in o)t[i]=o[i].read(e);return s(e),t},toWireType:function(e,t){for(var r in o)if(!(r in t))throw new TypeError('Missing field:  "'+r+'"');var n=i();for(r in o)o[r].write(n,t[r]);return null!==e&&e.push(s,n),n},argPackAdvance:8,readValueFromPointer:He,destructorFunction:s}]}))},O:function(e,t,i,s,r){},ia:function(e,i,s,o,a){var l=it(s);at(e,{name:i=rt(i),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?o:a},argPackAdvance:8,readValueFromPointer:function(e){var o;if(1===s)o=t();else if(2===s)o=r();else{if(4!==s)throw new TypeError("Unknown boolean type size: "+i);o=n()}return this.fromWireType(o[e>>>l])},destructorFunction:null})},v:function(e,t,i,s,r,o,n,a,l,h,c,u,d){c=rt(c),o=Ht(r,o),a&&(a=Ht(n,a)),h&&(h=Ht(l,h)),d=Ht(u,d);var p=$e(c);Ct(p,(function(){qt("Cannot construct "+c+" due to unbound types",[s])})),et([e,t,i],s?[s]:[],(function(t){var i,r;t=t[0],r=s?(i=t.registeredClass).instancePrototype:Pt.prototype;var n=Ze(p,(function(){if(Object.getPrototypeOf(this)!==l)throw new ot("Use 'new' to construct "+c);if(void 0===u.constructor_body)throw new ot(c+" has no accessible constructor");var e=u.constructor_body[arguments.length];if(void 0===e)throw new ot("Tried to invoke ctor of "+c+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(u.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),l=Object.create(r,{constructor:{value:n}});n.prototype=l;var u=new Et(c,n,l,d,i,o,a,h),f=new Ut(c,u,!0,!1,!1),m=new Ut(c+"*",u,!1,!1,!1),g=new Ut(c+" const*",u,!1,!0,!1);return wt[e]={pointerType:m,constPointerType:g},Gt(p,n),[f,m,g]}))},u:function(e,t,i,s,r,o){k(t>0);var n=$t(t,i);r=Ht(s,r);var a=[o],l=[];et([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ot("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){qt("Cannot construct "+e.name+" due to unbound types",n)},et([],n,(function(s){return e.registeredClass.constructor_body[t-1]=function(){arguments.length!==t-1&&nt(i+" called with "+arguments.length+" arguments, expected "+(t-1)),l.length=0,a.length=t;for(var e=1;e<t;++e)a[e]=s[e].toWireType(l,arguments[e-1]);var o=r.apply(null,a);return We(l),s[0].fromWireType(o)},[]})),[]}))},c:function(e,t,i,s,r,o,n,a){var l=$t(i,s);t=rt(t),o=Ht(r,o),et([],[e],(function(e){var s=(e=e[0]).name+"."+t;function r(){qt("Cannot call "+s+" due to unbound types",l)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),a&&e.registeredClass.pureVirtualFunctions.push(t);var h=e.registeredClass.instancePrototype,c=h[t];return void 0===c||void 0===c.overloadTable&&c.className!==e.name&&c.argCount===i-2?(r.argCount=i-2,r.className=e.name,h[t]=r):(Mt(h,t,s),h[t].overloadTable[i-2]=r),et([],l,(function(r){var a=Zt(s,r,e,o,n);return void 0===h[t].overloadTable?(a.argCount=i-2,h[t]=a):h[t].overloadTable[i-2]=a,[]})),[]}))},ha:function(e,t){at(e,{name:t=rt(t),fromWireType:function(e){var t=Qt[e].value;return Jt(e),t},toWireType:function(e,t){return ii(t)},argPackAdvance:8,readValueFromPointer:He,destructorFunction:null})},la:function(e,t,i,s){var r=it(i);function o(){}t=rt(t),o.values={},at(e,{name:t,constructor:o,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:si(t,r,s),destructorFunction:null}),Ct(t,o)},y:function(e,t,i){var s=ri(e,"enum");t=rt(t);var r=s.constructor,o=Object.create(s.constructor.prototype,{value:{value:i},constructor:{value:Ze(s.name+"_"+t,(function(){}))}});r.values[i]=o,r[t]=o},J:function(e,t,i){var s=it(i);at(e,{name:t=rt(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+oi(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:ni(t,s),destructorFunction:null})},f:function(e,t,i,s,r,o){var n=$t(t,i);e=rt(e),r=Ht(s,r),Ct(e,(function(){qt("Cannot call "+e+" due to unbound types",n)}),t-1),et([],n,(function(i){var s=[i[0],null].concat(i.slice(1));return Gt(e,Zt(e,s,null,r,o),t-1),[]}))},p:function(e,t,i,s,r){t=rt(t),-1===r&&(r=4294967295);var o=it(i),n=function(e){return e};if(0===s){var a=32-8*i;n=function(e){return e<<a>>>a}}var l=t.includes("unsigned");at(e,{name:t,fromWireType:n,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+oi(i)+'" to '+this.name);if(i<s||i>r)throw new TypeError('Passing a number "'+oi(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+s+", "+r+"]!");return l?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:ai(t,o,0!==s),destructorFunction:null})},k:function(e,t,i){var s=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){e>>=2;var t=a(),i=t[e>>>0],r=t[e+1>>>0];return new s(W,r,i)}at(e,{name:i=rt(i),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},K:function(e,t){var i="std::string"===(t=rt(t));at(e,{name:t,fromWireType:function(e){var t,r=a()[e>>>2];if(i)for(var o=e+4,n=0;n<=r;++n){var l=e+4+n;if(n==r||0==s()[l>>>0]){var h=V(o,l-o);void 0===t?t=h:(t+=String.fromCharCode(0),t+=h),o=l+1}}else{var c=new Array(r);for(n=0;n<r;++n)c[n]=String.fromCharCode(s()[e+4+n>>>0]);t=c.join("")}return qi(e),t},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||nt("Cannot pass non-string to std::string");var o=(i&&r?function(){return G(t)}:function(){return t.length})(),n=Yi(4+o+1);if(n>>>=0,a()[n>>>2]=o,i&&r)U(t,n+4,o+1);else if(r)for(var l=0;l<o;++l){var h=t.charCodeAt(l);h>255&&(qi(n),nt("String has UTF-16 code units that do not fit in 8 bits")),s()[n+4+l>>>0]=h}else for(l=0;l<o;++l)s()[n+4+l>>>0]=t[l];return null!==e&&e.push(qi,n),n},argPackAdvance:8,readValueFromPointer:He,destructorFunction:function(e){qi(e)}})},z:function(e,t,i){var s,r,n,l,h;i=rt(i),2===t?(s=ee,r=te,l=ie,n=function(){return o()},h=1):4===t&&(s=se,r=re,l=oe,n=function(){return a()},h=2),at(e,{name:i,fromWireType:function(e){for(var i,r=a()[e>>>2],o=n(),l=e+4,c=0;c<=r;++c){var u=e+4+c*t;if(c==r||0==o[u>>>h]){var d=s(l,u-l);void 0===i?i=d:(i+=String.fromCharCode(0),i+=d),l=u+t}}return qi(e),i},toWireType:function(e,s){"string"!=typeof s&&nt("Cannot pass non-string to C++ string type "+i);var o=l(s),n=Yi(4+o+t);return n>>>=0,a()[n>>>2]=o>>h,r(s,n+4,o+t),null!==e&&e.push(qi,n),n},argPackAdvance:8,readValueFromPointer:He,destructorFunction:function(e){qi(e)}})},na:function(e,t,i,s,r,o){Ge[e]={name:rt(t),rawConstructor:Ht(i,s),rawDestructor:Ht(r,o),elements:[]}},h:function(e,t,i,s,r,o,n,a,l){Ge[e].elements.push({getterReturnType:t,getter:Ht(i,s),getterContext:r,setterArgumentType:o,setter:Ht(n,a),setterContext:l})},t:function(e,t,i,s,r,o){tt[e]={name:rt(t),rawConstructor:Ht(i,s),rawDestructor:Ht(r,o),fields:[]}},e:function(e,t,i,s,r,o,n,a,l,h){tt[e].fields.push({fieldName:rt(t),getterReturnType:i,getter:Ht(s,r),getterContext:o,setterArgumentType:n,setter:Ht(a,l),setterContext:h})},ja:function(e,t){at(e,{isVoid:!0,name:t=rt(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},ea:function(e,t){if(e==t)postMessage({cmd:"processQueuedMainThreadWork"});else if(M)postMessage({targetThread:e,cmd:"processThreadQueue"});else{var i=Se.pthreads[e],s=i&&i.worker;if(!s)return;s.postMessage({cmd:"processThreadQueue"})}return 1},n:function(e,t,i){e=li(e),t=ri(t,"emval::as");var s=[],r=ii(s);return n()[i>>>2]=r,t.toWireType(s,e)},L:function(e,t,i,s){e=li(e);for(var r=function(e,t){for(var i=new Array(e),s=0;s<e;++s)i[s]=ri(n()[(t>>2)+s>>>0],"parameter "+s);return i}(t,i),o=new Array(t),a=0;a<t;++a){var l=r[a];o[a]=l.readValueFromPointer(s),s+=l.argPackAdvance}return ii(e.apply(void 0,o))},b:Jt,U:function(e){return 0===e?ii(ui()):(e=ci(e),ii(ui()[e]))},o:function(e,t){return ii((e=li(e))[t=li(t)])},j:function(e){e>4&&(Qt[e].refcount+=1)},ca:function(e,t){return(e=li(e))instanceof(t=li(t))},M:function(e){return"number"==typeof(e=li(e))},C:function(){return ii([])},g:function(e){return ii(ci(e))},w:function(){return ii({})},m:function(e){We(Qt[e].value),Jt(e)},i:function(e,t,i){e=li(e),t=li(t),i=li(i),e[t]=i},d:function(e,t){return ii((e=ri(e,"_emval_take_value")).readValueFromPointer(t))},I:function(){Pe()},T:function(e,t){var i;if(0===e)i=Date.now();else{if(1!==e&&4!==e)return Ie(28),-1;i=Te()}return n()[t>>>2]=i/1e3|0,n()[t+4>>>2]=i%1e3*1e3*1e3|0,0},G:function(e,t,i){var r=function(e,t){var i;for(di.length=0,t>>=2;i=s()[e++>>>0];){var r=i<105;r&&1&t&&t++,di.push(r?l()[t++>>>1]:n()[t>>>0]),++t}return di}(t,i);return Ee[e].apply(null,r)},_:function(){w||P||I("Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread")},F:function(e,t){},r:function(e,i,s){if(e<=0||e>t().length||!0&e)return-28;if(y){if(Atomics.load(n(),e>>2)!=i)return-6;var r=performance.now(),o=r+s;for(Atomics.exchange(n(),fs>>2,e);;){if((r=performance.now())>o)return Atomics.exchange(n(),fs>>2,0),-73;if(0==Atomics.exchange(n(),fs>>2,0))break;if(Ji(),Atomics.load(n(),e>>2)!=i)return-6;Atomics.exchange(n(),fs>>2,e)}return 0}var a=Atomics.wait(n(),e>>2,i,s);if("timed-out"===a)return-73;if("not-equal"===a)return-6;if("ok"===a)return 0;throw"Atomics.wait returned an unexpected value "+a},q:De,x:Te,R:function(e,t,i){s().copyWithin(e>>>0,t>>>0,t+i>>>0)},$:function(e,t,i){fi.length=t;for(var s=i>>3,r=0;r<t;r++)fi[r]=l()[s+r>>>0];return(e<0?Ee[-e-1]:Wi[e]).apply(null,fi)},S:function(e){var t=s().length;if((e>>>=0)<=t)return!1;var i,r,o=4294901760;if(e>o)return!1;for(var n=1;n<=4;n*=2){var a=t*(1+.2/n);if(a=Math.min(a,e+100663296),mi(Math.min(o,((i=Math.max(e,a))%(r=65536)>0&&(i+=r-i%r),i))))return!0}return!1},aa:function(e,t,i){return xi(e)?yi(e,t,i):Pi(e,t,i)},E:function(e){},ba:function(e,t){return function(e,t){var i=t>>2,s=n()[i+6>>>0],r={alpha:!!n()[i+0>>>0],depth:!!n()[i+1>>>0],stencil:!!n()[i+2>>>0],antialias:!!n()[i+3>>>0],premultipliedAlpha:!!n()[i+4>>>0],preserveDrawingBuffer:!!n()[i+5>>>0],powerPreference:Mi[s],failIfMajorPerformanceCaveat:!!n()[i+7>>>0],majorVersion:n()[i+8>>>0],minorVersion:n()[i+9>>>0],enableExtensionsByDefault:n()[i+10>>>0],explicitSwapControl:n()[i+11>>>0],proxyContextToMainThread:n()[i+12>>>0],renderViaOffscreenBackBuffer:n()[i+13>>>0]},o=xi(e);return o?r.explicitSwapControl?0:wi.createContext(o,r):0}(e,t)},Y:Ai,Z:Di,H:Ti,ga:Si,N:Ii,fa:Fi,Q:function(){Se.initRuntime()},a:F||u.wasmMemory,da:function(e,t,i,s){if("undefined"==typeof SharedArrayBuffer)return S("Current environment does not support SharedArrayBuffer, pthreads are not available!"),6;if(!e)return S("pthread_create called with a null thread pointer!"),28;var r=[];if(M&&0===r.length)return Qi(687865856,e,t,i,s);var o=0,l=0,h=0;t&&-1!=t?(o=n()[t>>>2],o+=81920,l=n()[t+8>>>2],h=0!==n()[t+12>>>2]):o=2097152;var c=0==l;c?l=us(16,o):k((l-=o)>0);for(var u=Yi(228),d=0;d<57;++d)a()[(u>>2)+d>>>0]=0;n()[e>>>2]=u,n()[u+12>>>2]=u;var p=u+152;n()[p>>>2]=p;var f={stackBase:l,stackSize:o,allocatedOwnStack:c,detached:h,startRoutine:i,pthread_ptr:u,arg:s,transferList:r};return M?(f.cmd="spawnThread",postMessage(f,r),0):Li(f)},P:function(e){},X:function(e,t,i,s){return ji(e,t,i,s)}};!function(){var e={a:Xi};function t(e,t){var i,s=e.exports;if(u.asm=s,ae=u.asm.ta,i=u.asm.oa,ce.unshift(i),Se.tlsInitFunctions.push(u.asm.sa),L=t,!M){var r=Se.unusedWorkers.length;Se.unusedWorkers.forEach((function(e){Se.loadWasmModuleToWorker(e,(function(){--r||ye()}))}))}}function i(e){t(e.instance,e.module)}function s(t){return function(){if(!D&&(y||P)){if("function"==typeof fetch&&!Me(me))return fetch(me,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+me+"'";return e.arrayBuffer()})).catch((function(){return Ce(me)}));if(m)return new Promise((function(e,t){m(me,(function(t){e(new Uint8Array(t))}),t)}))}return Promise.resolve().then((function(){return Ce(me)}))}().then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){S("failed to asynchronously prepare wasm: "+e),Pe(e)}))}if(M||xe(),u.instantiateWasm)try{return u.instantiateWasm(e,t)}catch(e){return S("Module.instantiateWasm callback failed with error: "+e),!1}(D||"function"!=typeof WebAssembly.instantiateStreaming||we(me)||Me(me)||"function"!=typeof fetch?s(i):fetch(me,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(i,(function(e){return S("wasm streaming compile failed: "+e),S("falling back to ArrayBuffer instantiation"),s(i)}))}))).catch(c)}(),u.___wasm_call_ctors=function(){return(u.___wasm_call_ctors=u.asm.oa).apply(null,arguments)},u._main=function(){return(u._main=u.asm.pa).apply(null,arguments)};var Yi=u._malloc=function(){return(Yi=u._malloc=u.asm.qa).apply(null,arguments)},qi=u._free=function(){return(qi=u._free=u.asm.ra).apply(null,arguments)};u._emscripten_tls_init=function(){return(u._emscripten_tls_init=u.asm.sa).apply(null,arguments)};var $i=u.___getTypeName=function(){return($i=u.___getTypeName=u.asm.ua).apply(null,arguments)};u.___embind_register_native_and_builtin_types=function(){return(u.___embind_register_native_and_builtin_types=u.asm.va).apply(null,arguments)},u._emscripten_current_thread_process_queued_calls=function(){return(u._emscripten_current_thread_process_queued_calls=u.asm.wa).apply(null,arguments)};var Zi=u._emscripten_register_main_browser_thread_id=function(){return(Zi=u._emscripten_register_main_browser_thread_id=u.asm.xa).apply(null,arguments)},Ki=u.__emscripten_do_dispatch_to_thread=function(){return(Ki=u.__emscripten_do_dispatch_to_thread=u.asm.ya).apply(null,arguments)},Qi=u._emscripten_sync_run_in_main_thread_4=function(){return(Qi=u._emscripten_sync_run_in_main_thread_4=u.asm.za).apply(null,arguments)},Ji=u._emscripten_main_thread_process_queued_calls=function(){return(Ji=u._emscripten_main_thread_process_queued_calls=u.asm.Aa).apply(null,arguments)},es=u._emscripten_run_in_main_runtime_thread_js=function(){return(es=u._emscripten_run_in_main_runtime_thread_js=u.asm.Ba).apply(null,arguments)},ts=u.__emscripten_call_on_thread=function(){return(ts=u.__emscripten_call_on_thread=u.asm.Ca).apply(null,arguments)},is=u.__emscripten_thread_init=function(){return(is=u.__emscripten_thread_init=u.asm.Da).apply(null,arguments)},ss=u._emscripten_get_global_libc=function(){return(ss=u._emscripten_get_global_libc=u.asm.Ea).apply(null,arguments)},rs=u.___errno_location=function(){return(rs=u.___errno_location=u.asm.Fa).apply(null,arguments)},os=u._pthread_self=function(){return(os=u._pthread_self=u.asm.Ga).apply(null,arguments)},ns=u.___pthread_tsd_run_dtors=function(){return(ns=u.___pthread_tsd_run_dtors=u.asm.Ha).apply(null,arguments)},as=u.stackSave=function(){return(as=u.stackSave=u.asm.Ia).apply(null,arguments)},ls=u.stackRestore=function(){return(ls=u.stackRestore=u.asm.Ja).apply(null,arguments)},hs=u.stackAlloc=function(){return(hs=u.stackAlloc=u.asm.Ka).apply(null,arguments)},cs=u._emscripten_stack_set_limits=function(){return(cs=u._emscripten_stack_set_limits=u.asm.La).apply(null,arguments)},us=u._memalign=function(){return(us=u._memalign=u.asm.Ma).apply(null,arguments)};u.dynCall_jiji=function(){return(u.dynCall_jiji=u.asm.Na).apply(null,arguments)},u.dynCall_viijii=function(){return(u.dynCall_viijii=u.asm.Oa).apply(null,arguments)},u.dynCall_iiiiij=function(){return(u.dynCall_iiiiij=u.asm.Pa).apply(null,arguments)},u.dynCall_iiiiijj=function(){return(u.dynCall_iiiiijj=u.asm.Qa).apply(null,arguments)},u.dynCall_iiiiiijj=function(){return(u.dynCall_iiiiiijj=u.asm.Ra).apply(null,arguments)};var ds,ps=u.__emscripten_allow_main_runtime_queued_calls=44840,fs=u.__emscripten_main_thread_futex=48292;function ms(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function gs(e){if(!(ve>0)){if(M)return h(u),fe(),void postMessage({cmd:"loaded"});!function(){if(!M){if(u.preRun)for("function"==typeof u.preRun&&(u.preRun=[u.preRun]);u.preRun.length;)e=u.preRun.shift(),he.unshift(e);var e;Ae(he)}}(),ve>0||(u.setStatus?(u.setStatus("Running..."),setTimeout((function(){setTimeout((function(){u.setStatus("")}),1),t()}),1)):t())}function t(){ds||(ds=!0,u.calledRun=!0,R||(fe(),M||Ae(ue),h(u),u.onRuntimeInitialized&&u.onRuntimeInitialized(),vs&&function(e){var t=u._main;try{_s(t(0,0),!0)}catch(e){if(e instanceof ms||"unwind"==e)return;var i=e;e&&"object"==typeof e&&e.stack&&(i=[e,e.stack]),S("exception thrown: "+i),x(1,e)}}(),function(){if(!M){if(u.postRun)for("function"==typeof u.postRun&&(u.postRun=[u.postRun]);u.postRun.length;)e=u.postRun.shift(),de.unshift(e);var e;Ae(de)}}()))}}function _s(e,t){if(!t&&M)throw postMessage({cmd:"exitProcess",returnCode:e}),new ms(e);pe()||(Se.terminateAllThreads(),u.onExit&&u.onExit(e),R=!0),x(e,new ms(e))}if(u.addRunDependency=xe,u.removeRunDependency=ye,u.FS_createPath=Ne.createPath,u.FS_createDataFile=Ne.createDataFile,u.FS_createPreloadedFile=Ne.createPreloadedFile,u.FS_createLazyFile=Ne.createLazyFile,u.FS_createDevice=Ne.createDevice,u.FS_unlink=Ne.unlink,u.keepRuntimeAlive=pe,u.FS=Ne,u.PThread=Se,u.PThread=Se,u.wasmMemory=F,u.ExitStatus=ms,be=function e(){ds||gs(),ds||(be=e)},u.run=gs,u.preInit)for("function"==typeof u.preInit&&(u.preInit=[u.preInit]);u.preInit.length>0;)u.preInit.pop()();var vs=!0;return u.noInitialRun&&(vs=!1),M&&(B=!1,Se.initWorker()),gs(),e.ready});"object"==typeof e&&"object"==typeof t?t.exports=s:"function"==typeof define&&define.amd?define([],(function(){return s})):"object"==typeof e&&(e.WebIFCWasm=s)}}),ap=rp({"dist/web-ifc.js"(e,t){var i,s=(i="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,"undefined"!=typeof __filename&&(i=i||__filename),function(e){var t,s,r=void 0!==(e=e||{})?e:{};r.ready=new Promise((function(e,i){t=e,s=i}));var o,n={};for(o in r)r.hasOwnProperty(o)&&(n[o]=r[o]);var a,l,h,c,u,d="./this.program",p=function(e,t){throw t},f="object"==typeof window,m="function"==typeof importScripts,g="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,_="";g?(_=m?sp("path").dirname(_)+"/":__dirname+"/",a=function(e,t){return c||(c=sp("fs")),u||(u=sp("path")),e=u.normalize(e),c.readFileSync(e,t?null:"utf8")},h=function(e){var t=a(e,!0);return t.buffer||(t=new Uint8Array(t)),M(t.buffer),t},l=function(e,t,i){c||(c=sp("fs")),u||(u=sp("path")),e=u.normalize(e),c.readFile(e,(function(e,s){e?i(e):t(s.buffer)}))},process.argv.length>1&&(d=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),process.on("uncaughtException",(function(e){if(!(e instanceof ci))throw e})),process.on("unhandledRejection",le),p=function(e,t){if(J())throw process.exitCode=e,t;process.exit(e)},r.inspect=function(){return"[Emscripten Module object]"}):(f||m)&&(m?_=self.location.href:"undefined"!=typeof document&&document.currentScript&&(_=document.currentScript.src),i&&(_=i),_=0!==_.indexOf("blob:")?_.substr(0,_.lastIndexOf("/")+1):"",a=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},m&&(h=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),l=function(e,t,i){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){200==s.status||0==s.status&&s.response?t(s.response):i()},s.onerror=i,s.send(null)});var v,b=r.print||console.log.bind(console),x=r.printErr||console.warn.bind(console);for(o in n)n.hasOwnProperty(o)&&(r[o]=n[o]);n=null,r.arguments,r.thisProgram&&(d=r.thisProgram),r.quit&&(p=r.quit),r.wasmBinary&&(v=r.wasmBinary);var y,P=r.noExitRuntime||!0;"object"!=typeof WebAssembly&&le("no native wasm support detected");var w=!1;function M(e,t){e||le("Assertion failed: "+t)}var C="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function E(e,t,i){for(var s=(t>>>=0)+i,r=t;e[r>>>0]&&!(r>=s);)++r;if(r-t>16&&e.subarray&&C)return C.decode(e.subarray(t>>>0,r>>>0));for(var o="";t<r;){var n=e[t++>>>0];if(128&n){var a=63&e[t++>>>0];if(192!=(224&n)){var l=63&e[t++>>>0];if((n=224==(240&n)?(15&n)<<12|a<<6|l:(7&n)<<18|a<<12|l<<6|63&e[t++>>>0])<65536)o+=String.fromCharCode(n);else{var h=n-65536;o+=String.fromCharCode(55296|h>>10,56320|1023&h)}}else o+=String.fromCharCode((31&n)<<6|a)}else o+=String.fromCharCode(n)}return o}function A(e,t){return(e>>>=0)?E(L,e,t):""}function D(e,t,i,s){if(!(s>0))return 0;for(var r=i>>>=0,o=i+s-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),a<=127){if(i>=o)break;t[i++>>>0]=a}else if(a<=2047){if(i+1>=o)break;t[i++>>>0]=192|a>>6,t[i++>>>0]=128|63&a}else if(a<=65535){if(i+2>=o)break;t[i++>>>0]=224|a>>12,t[i++>>>0]=128|a>>6&63,t[i++>>>0]=128|63&a}else{if(i+3>=o)break;t[i++>>>0]=240|a>>18,t[i++>>>0]=128|a>>12&63,t[i++>>>0]=128|a>>6&63,t[i++>>>0]=128|63&a}}return t[i>>>0]=0,i-r}function T(e,t,i){return D(e,L,t,i)}function S(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++i)),s<=127?++t:t+=s<=2047?2:s<=65535?3:4}return t}var I,F,L,B,R,k,O,N,j,V,z="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function U(e,t){for(var i=e,s=i>>1,r=s+t/2;!(s>=r)&&R[s>>>0];)++s;if((i=s<<1)-e>32&&z)return z.decode(L.subarray(e>>>0,i>>>0));for(var o="",n=0;!(n>=t/2);++n){var a=B[e+2*n>>>1];if(0==a)break;o+=String.fromCharCode(a)}return o}function G(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var s=t,r=(i-=2)<2*e.length?i/2:e.length,o=0;o<r;++o){var n=e.charCodeAt(o);B[t>>>1]=n,t+=2}return B[t>>>1]=0,t-s}function W(e){return 2*e.length}function H(e,t){for(var i=0,s="";!(i>=t/4);){var r=k[e+4*i>>>2];if(0==r)break;if(++i,r>=65536){var o=r-65536;s+=String.fromCharCode(55296|o>>10,56320|1023&o)}else s+=String.fromCharCode(r)}return s}function X(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var s=t>>>=0,r=s+i-4,o=0;o<e.length;++o){var n=e.charCodeAt(o);if(n>=55296&&n<=57343&&(n=65536+((1023&n)<<10)|1023&e.charCodeAt(++o)),k[t>>>2]=n,(t+=4)+4>r)break}return k[t>>>2]=0,t-s}function Y(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&++i,t+=4}return t}function q(e){I=e,r.HEAP8=F=new Int8Array(e),r.HEAP16=B=new Int16Array(e),r.HEAP32=k=new Int32Array(e),r.HEAPU8=L=new Uint8Array(e),r.HEAPU16=R=new Uint16Array(e),r.HEAPU32=O=new Uint32Array(e),r.HEAPF32=N=new Float32Array(e),r.HEAPF64=j=new Float64Array(e)}r.INITIAL_MEMORY;var $=[],Z=[],K=[],Q=[];function J(){return P||!1}var ee,te,ie,se,re=0,oe=null;function ne(e){re++,r.monitorRunDependencies&&r.monitorRunDependencies(re)}function ae(e){if(re--,r.monitorRunDependencies&&r.monitorRunDependencies(re),0==re&&oe){var t=oe;oe=null,t()}}function le(e){r.onAbort&&r.onAbort(e),x(e+=""),w=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw s(t),t}function he(e){return e.startsWith("data:application/octet-stream;base64,")}function ce(e){return e.startsWith("file://")}function ue(e){try{if(e==ee&&v)return new Uint8Array(v);if(h)return h(e);throw"both async and sync fetching of the wasm failed"}catch(e){le(e)}}function de(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var i=t.func;"number"==typeof i?void 0===t.arg?V.get(i)():V.get(i)(t.arg):i(void 0===t.arg?null:t.arg)}else t(r)}}function pe(e){this.excPtr=e,this.ptr=e-16,this.set_type=function(e){k[this.ptr+4>>>2]=e},this.get_type=function(){return k[this.ptr+4>>>2]},this.set_destructor=function(e){k[this.ptr+8>>>2]=e},this.get_destructor=function(){return k[this.ptr+8>>>2]},this.set_refcount=function(e){k[this.ptr>>>2]=e},this.set_caught=function(e){e=e?1:0,F[this.ptr+12>>>0]=e},this.get_caught=function(){return 0!=F[this.ptr+12>>>0]},this.set_rethrown=function(e){e=e?1:0,F[this.ptr+13>>>0]=e},this.get_rethrown=function(){return 0!=F[this.ptr+13>>>0]},this.init=function(e,t){this.set_type(e),this.set_destructor(t),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){var e=k[this.ptr>>>2];k[this.ptr>>>2]=e+1},this.release_ref=function(){var e=k[this.ptr>>>2];return k[this.ptr>>>2]=e-1,1===e}}function fe(e){return k[hi()>>>2]=e,e}r.preloadedImages={},r.preloadedAudios={},he(ee="web-ifc.wasm")||(te=ee,ee=r.locateFile?r.locateFile(te,_):_+te);var me={splitPath:function(e){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1)},normalizeArray:function(e,t){for(var i=0,s=e.length-1;s>=0;s--){var r=e[s];"."===r?e.splice(s,1):".."===r?(e.splice(s,1),i++):i&&(e.splice(s,1),i--)}if(t)for(;i;i--)e.unshift("..");return e},normalize:function(e){var t="/"===e.charAt(0),i="/"===e.substr(-1);return e=me.normalizeArray(e.split("/").filter((function(e){return!!e})),!t).join("/"),e||t||(e="."),e&&i&&(e+="/"),(t?"/":"")+e},dirname:function(e){var t=me.splitPath(e),i=t[0],s=t[1];return i||s?(s&&(s=s.substr(0,s.length-1)),i+s):"."},basename:function(e){if("/"===e)return"/";var t=(e=(e=me.normalize(e)).replace(/\/$/,"")).lastIndexOf("/");return-1===t?e:e.substr(t+1)},extname:function(e){return me.splitPath(e)[3]},join:function(){var e=Array.prototype.slice.call(arguments,0);return me.normalize(e.join("/"))},join2:function(e,t){return me.normalize(e+"/"+t)}},ge={resolve:function(){for(var e="",t=!1,i=arguments.length-1;i>=-1&&!t;i--){var s=i>=0?arguments[i]:be.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");if(!s)return"";e=s+"/"+e,t="/"===s.charAt(0)}return e=me.normalizeArray(e.split("/").filter((function(e){return!!e})),!t).join("/"),(t?"/":"")+e||"."},relative:function(e,t){function i(e){for(var t=0;t<e.length&&""===e[t];t++);for(var i=e.length-1;i>=0&&""===e[i];i--);return t>i?[]:e.slice(t,i-t+1)}e=ge.resolve(e).substr(1),t=ge.resolve(t).substr(1);for(var s=i(e.split("/")),r=i(t.split("/")),o=Math.min(s.length,r.length),n=o,a=0;a<o;a++)if(s[a]!==r[a]){n=a;break}var l=[];for(a=n;a<s.length;a++)l.push("..");return(l=l.concat(r.slice(n))).join("/")}},_e={ttys:[],init:function(){},shutdown:function(){},register:function(e,t){_e.ttys[e]={input:[],output:[],ops:t},be.registerDevice(e,_e.stream_ops)},stream_ops:{open:function(e){var t=_e.ttys[e.node.rdev];if(!t)throw new be.ErrnoError(43);e.tty=t,e.seekable=!1},close:function(e){e.tty.ops.flush(e.tty)},flush:function(e){e.tty.ops.flush(e.tty)},read:function(e,t,i,s,r){if(!e.tty||!e.tty.ops.get_char)throw new be.ErrnoError(60);for(var o=0,n=0;n<s;n++){var a;try{a=e.tty.ops.get_char(e.tty)}catch(e){throw new be.ErrnoError(29)}if(void 0===a&&0===o)throw new be.ErrnoError(6);if(null==a)break;o++,t[i+n]=a}return o&&(e.node.timestamp=Date.now()),o},write:function(e,t,i,s,r){if(!e.tty||!e.tty.ops.put_char)throw new be.ErrnoError(60);try{for(var o=0;o<s;o++)e.tty.ops.put_char(e.tty,t[i+o])}catch(e){throw new be.ErrnoError(29)}return s&&(e.node.timestamp=Date.now()),o}},default_tty_ops:{get_char:function(e){if(!e.input.length){var t=null;if(g){var i=Buffer.alloc(256),s=0;try{s=c.readSync(process.stdin.fd,i,0,256,null)}catch(e){if(!e.toString().includes("EOF"))throw e;s=0}t=s>0?i.slice(0,s).toString("utf-8"):null}else"undefined"!=typeof window&&"function"==typeof window.prompt?null!==(t=window.prompt("Input: "))&&(t+="\n"):"function"==typeof readline&&null!==(t=readline())&&(t+="\n");if(!t)return null;e.input=si(t,!0)}return e.input.shift()},put_char:function(e,t){null===t||10===t?(b(E(e.output,0)),e.output=[]):0!=t&&e.output.push(t)},flush:function(e){e.output&&e.output.length>0&&(b(E(e.output,0)),e.output=[])}},default_tty1_ops:{put_char:function(e,t){null===t||10===t?(x(E(e.output,0)),e.output=[]):0!=t&&e.output.push(t)},flush:function(e){e.output&&e.output.length>0&&(x(E(e.output,0)),e.output=[])}}},ve={ops_table:null,mount:function(e){return ve.createNode(null,"/",16895,0)},createNode:function(e,t,i,s){if(be.isBlkdev(i)||be.isFIFO(i))throw new be.ErrnoError(63);ve.ops_table||(ve.ops_table={dir:{node:{getattr:ve.node_ops.getattr,setattr:ve.node_ops.setattr,lookup:ve.node_ops.lookup,mknod:ve.node_ops.mknod,rename:ve.node_ops.rename,unlink:ve.node_ops.unlink,rmdir:ve.node_ops.rmdir,readdir:ve.node_ops.readdir,symlink:ve.node_ops.symlink},stream:{llseek:ve.stream_ops.llseek}},file:{node:{getattr:ve.node_ops.getattr,setattr:ve.node_ops.setattr},stream:{llseek:ve.stream_ops.llseek,read:ve.stream_ops.read,write:ve.stream_ops.write,allocate:ve.stream_ops.allocate,mmap:ve.stream_ops.mmap,msync:ve.stream_ops.msync}},link:{node:{getattr:ve.node_ops.getattr,setattr:ve.node_ops.setattr,readlink:ve.node_ops.readlink},stream:{}},chrdev:{node:{getattr:ve.node_ops.getattr,setattr:ve.node_ops.setattr},stream:be.chrdev_stream_ops}});var r=be.createNode(e,t,i,s);return be.isDir(r.mode)?(r.node_ops=ve.ops_table.dir.node,r.stream_ops=ve.ops_table.dir.stream,r.contents={}):be.isFile(r.mode)?(r.node_ops=ve.ops_table.file.node,r.stream_ops=ve.ops_table.file.stream,r.usedBytes=0,r.contents=null):be.isLink(r.mode)?(r.node_ops=ve.ops_table.link.node,r.stream_ops=ve.ops_table.link.stream):be.isChrdev(r.mode)&&(r.node_ops=ve.ops_table.chrdev.node,r.stream_ops=ve.ops_table.chrdev.stream),r.timestamp=Date.now(),e&&(e.contents[t]=r,e.timestamp=r.timestamp),r},getFileDataAsTypedArray:function(e){return e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0)},expandFileStorage:function(e,t){t>>>=0;var i=e.contents?e.contents.length:0;if(!(i>=t)){t=Math.max(t,i*(i<1048576?2:1.125)>>>0),0!=i&&(t=Math.max(t,256));var s=e.contents;e.contents=new Uint8Array(t),e.usedBytes>0&&e.contents.set(s.subarray(0,e.usedBytes),0)}},resizeFileStorage:function(e,t){if(t>>>=0,e.usedBytes!=t)if(0==t)e.contents=null,e.usedBytes=0;else{var i=e.contents;e.contents=new Uint8Array(t),i&&e.contents.set(i.subarray(0,Math.min(t,e.usedBytes))),e.usedBytes=t}},node_ops:{getattr:function(e){var t={};return t.dev=be.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,be.isDir(e.mode)?t.size=4096:be.isFile(e.mode)?t.size=e.usedBytes:be.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.timestamp),t.mtime=new Date(e.timestamp),t.ctime=new Date(e.timestamp),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr:function(e,t){void 0!==t.mode&&(e.mode=t.mode),void 0!==t.timestamp&&(e.timestamp=t.timestamp),void 0!==t.size&&ve.resizeFileStorage(e,t.size)},lookup:function(e,t){throw be.genericErrors[44]},mknod:function(e,t,i,s){return ve.createNode(e,t,i,s)},rename:function(e,t,i){if(be.isDir(e.mode)){var s;try{s=be.lookupNode(t,i)}catch(e){}if(s)for(var r in s.contents)throw new be.ErrnoError(55)}delete e.parent.contents[e.name],e.parent.timestamp=Date.now(),e.name=i,t.contents[i]=e,t.timestamp=e.parent.timestamp,e.parent=t},unlink:function(e,t){delete e.contents[t],e.timestamp=Date.now()},rmdir:function(e,t){var i=be.lookupNode(e,t);for(var s in i.contents)throw new be.ErrnoError(55);delete e.contents[t],e.timestamp=Date.now()},readdir:function(e){var t=[".",".."];for(var i in e.contents)e.contents.hasOwnProperty(i)&&t.push(i);return t},symlink:function(e,t,i){var s=ve.createNode(e,t,41471,0);return s.link=i,s},readlink:function(e){if(!be.isLink(e.mode))throw new be.ErrnoError(28);return e.link}},stream_ops:{read:function(e,t,i,s,r){var o=e.node.contents;if(r>=e.node.usedBytes)return 0;var n=Math.min(e.node.usedBytes-r,s);if(n>8&&o.subarray)t.set(o.subarray(r,r+n),i);else for(var a=0;a<n;a++)t[i+a]=o[r+a];return n},write:function(e,t,i,s,r,o){if(t.buffer===F.buffer&&(o=!1),!s)return 0;var n=e.node;if(n.timestamp=Date.now(),t.subarray&&(!n.contents||n.contents.subarray)){if(o)return n.contents=t.subarray(i,i+s),n.usedBytes=s,s;if(0===n.usedBytes&&0===r)return n.contents=t.slice(i,i+s),n.usedBytes=s,s;if(r+s<=n.usedBytes)return n.contents.set(t.subarray(i,i+s),r),s}if(ve.expandFileStorage(n,r+s),n.contents.subarray&&t.subarray)n.contents.set(t.subarray(i,i+s),r);else for(var a=0;a<s;a++)n.contents[r+a]=t[i+a];return n.usedBytes=Math.max(n.usedBytes,r+s),s},llseek:function(e,t,i){var s=t;if(1===i?s+=e.position:2===i&&be.isFile(e.node.mode)&&(s+=e.node.usedBytes),s<0)throw new be.ErrnoError(28);return s},allocate:function(e,t,i){ve.expandFileStorage(e.node,t+i),e.node.usedBytes=Math.max(e.node.usedBytes,t+i)},mmap:function(e,t,i,s,r,o){if(0!==t)throw new be.ErrnoError(28);if(!be.isFile(e.node.mode))throw new be.ErrnoError(43);var n,a,l=e.node.contents;if(2&o||l.buffer!==I){if((s>0||s+i<l.length)&&(l=l.subarray?l.subarray(s,s+i):Array.prototype.slice.call(l,s,s+i)),a=!0,!(n=void le()))throw new be.ErrnoError(48);n>>>=0,F.set(l,n>>>0)}else a=!1,n=l.byteOffset;return{ptr:n,allocated:a}},msync:function(e,t,i,s,r){if(!be.isFile(e.node.mode))throw new be.ErrnoError(43);return 2&r||ve.stream_ops.write(e,t,0,s,i,!1),0}}},be={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,trackingDelegate:{},tracking:{openFlags:{READ:1,WRITE:2}},ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:function(e,t){if(t=t||{},!(e=ge.resolve(be.cwd(),e)))return{path:"",node:null};var i={follow_mount:!0,recurse_count:0};for(var s in i)void 0===t[s]&&(t[s]=i[s]);if(t.recurse_count>8)throw new be.ErrnoError(32);for(var r=me.normalizeArray(e.split("/").filter((function(e){return!!e})),!1),o=be.root,n="/",a=0;a<r.length;a++){var l=a===r.length-1;if(l&&t.parent)break;if(o=be.lookupNode(o,r[a]),n=me.join2(n,r[a]),be.isMountpoint(o)&&(!l||l&&t.follow_mount)&&(o=o.mounted.root),!l||t.follow)for(var h=0;be.isLink(o.mode);){var c=be.readlink(n);if(n=ge.resolve(me.dirname(n),c),o=be.lookupPath(n,{recurse_count:t.recurse_count}).node,h++>40)throw new be.ErrnoError(32)}}return{path:n,node:o}},getPath:function(e){for(var t;;){if(be.isRoot(e)){var i=e.mount.mountpoint;return t?"/"!==i[i.length-1]?i+"/"+t:i+t:i}t=t?e.name+"/"+t:e.name,e=e.parent}},hashName:function(e,t){for(var i=0,s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s)|0;return(e+i>>>0)%be.nameTable.length},hashAddNode:function(e){var t=be.hashName(e.parent.id,e.name);e.name_next=be.nameTable[t],be.nameTable[t]=e},hashRemoveNode:function(e){var t=be.hashName(e.parent.id,e.name);if(be.nameTable[t]===e)be.nameTable[t]=e.name_next;else for(var i=be.nameTable[t];i;){if(i.name_next===e){i.name_next=e.name_next;break}i=i.name_next}},lookupNode:function(e,t){var i=be.mayLookup(e);if(i)throw new be.ErrnoError(i,e);for(var s=be.hashName(e.id,t),r=be.nameTable[s];r;r=r.name_next){var o=r.name;if(r.parent.id===e.id&&o===t)return r}return be.lookup(e,t)},createNode:function(e,t,i,s){var r=new be.FSNode(e,t,i,s);return be.hashAddNode(r),r},destroyNode:function(e){be.hashRemoveNode(e)},isRoot:function(e){return e===e.parent},isMountpoint:function(e){return!!e.mounted},isFile:function(e){return 32768==(61440&e)},isDir:function(e){return 16384==(61440&e)},isLink:function(e){return 40960==(61440&e)},isChrdev:function(e){return 8192==(61440&e)},isBlkdev:function(e){return 24576==(61440&e)},isFIFO:function(e){return 4096==(61440&e)},isSocket:function(e){return 49152==(49152&e)},flagModes:{r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},modeStringToFlags:function(e){var t=be.flagModes[e];if(void 0===t)throw new Error("Unknown file open mode: "+e);return t},flagsToPermissionString:function(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t},nodePermissions:function(e,t){return be.ignorePermissions||(!t.includes("r")||292&e.mode)&&(!t.includes("w")||146&e.mode)&&(!t.includes("x")||73&e.mode)?0:2},mayLookup:function(e){var t=be.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:2)},mayCreate:function(e,t){try{return be.lookupNode(e,t),20}catch(e){}return be.nodePermissions(e,"wx")},mayDelete:function(e,t,i){var s;try{s=be.lookupNode(e,t)}catch(e){return e.errno}var r=be.nodePermissions(e,"wx");if(r)return r;if(i){if(!be.isDir(s.mode))return 54;if(be.isRoot(s)||be.getPath(s)===be.cwd())return 10}else if(be.isDir(s.mode))return 31;return 0},mayOpen:function(e,t){return e?be.isLink(e.mode)?32:be.isDir(e.mode)&&("r"!==be.flagsToPermissionString(t)||512&t)?31:be.nodePermissions(e,be.flagsToPermissionString(t)):44},MAX_OPEN_FDS:4096,nextfd:function(e,t){e=e||0,t=t||be.MAX_OPEN_FDS;for(var i=e;i<=t;i++)if(!be.streams[i])return i;throw new be.ErrnoError(33)},getStream:function(e){return be.streams[e]},createStream:function(e,t,i){be.FSStream||(be.FSStream=function(){},be.FSStream.prototype={object:{get:function(){return this.node},set:function(e){this.node=e}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}}});var s=new be.FSStream;for(var r in e)s[r]=e[r];e=s;var o=be.nextfd(t,i);return e.fd=o,be.streams[o]=e,e},closeStream:function(e){be.streams[e]=null},chrdev_stream_ops:{open:function(e){var t=be.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open&&e.stream_ops.open(e)},llseek:function(){throw new be.ErrnoError(70)}},major:function(e){return e>>8},minor:function(e){return 255&e},makedev:function(e,t){return e<<8|t},registerDevice:function(e,t){be.devices[e]={stream_ops:t}},getDevice:function(e){return be.devices[e]},getMounts:function(e){for(var t=[],i=[e];i.length;){var s=i.pop();t.push(s),i.push.apply(i,s.mounts)}return t},syncfs:function(e,t){"function"==typeof e&&(t=e,e=!1),be.syncFSRequests++,be.syncFSRequests>1&&x("warning: "+be.syncFSRequests+" FS.syncfs operations in flight at once, probably just doing extra work");var i=be.getMounts(be.root.mount),s=0;function r(e){return be.syncFSRequests--,t(e)}function o(e){if(e)return o.errored?void 0:(o.errored=!0,r(e));++s>=i.length&&r(null)}i.forEach((function(t){if(!t.type.syncfs)return o(null);t.type.syncfs(t,e,o)}))},mount:function(e,t,i){var s,r="/"===i,o=!i;if(r&&be.root)throw new be.ErrnoError(10);if(!r&&!o){var n=be.lookupPath(i,{follow_mount:!1});if(i=n.path,s=n.node,be.isMountpoint(s))throw new be.ErrnoError(10);if(!be.isDir(s.mode))throw new be.ErrnoError(54)}var a={type:e,opts:t,mountpoint:i,mounts:[]},l=e.mount(a);return l.mount=a,a.root=l,r?be.root=l:s&&(s.mounted=a,s.mount&&s.mount.mounts.push(a)),l},unmount:function(e){var t=be.lookupPath(e,{follow_mount:!1});if(!be.isMountpoint(t.node))throw new be.ErrnoError(28);var i=t.node,s=i.mounted,r=be.getMounts(s);Object.keys(be.nameTable).forEach((function(e){for(var t=be.nameTable[e];t;){var i=t.name_next;r.includes(t.mount)&&be.destroyNode(t),t=i}})),i.mounted=null;var o=i.mount.mounts.indexOf(s);i.mount.mounts.splice(o,1)},lookup:function(e,t){return e.node_ops.lookup(e,t)},mknod:function(e,t,i){var s=be.lookupPath(e,{parent:!0}).node,r=me.basename(e);if(!r||"."===r||".."===r)throw new be.ErrnoError(28);var o=be.mayCreate(s,r);if(o)throw new be.ErrnoError(o);if(!s.node_ops.mknod)throw new be.ErrnoError(63);return s.node_ops.mknod(s,r,t,i)},create:function(e,t){return t=void 0!==t?t:438,t&=4095,t|=32768,be.mknod(e,t,0)},mkdir:function(e,t){return t=void 0!==t?t:511,t&=1023,t|=16384,be.mknod(e,t,0)},mkdirTree:function(e,t){for(var i=e.split("/"),s="",r=0;r<i.length;++r)if(i[r]){s+="/"+i[r];try{be.mkdir(s,t)}catch(e){if(20!=e.errno)throw e}}},mkdev:function(e,t,i){return void 0===i&&(i=t,t=438),t|=8192,be.mknod(e,t,i)},symlink:function(e,t){if(!ge.resolve(e))throw new be.ErrnoError(44);var i=be.lookupPath(t,{parent:!0}).node;if(!i)throw new be.ErrnoError(44);var s=me.basename(t),r=be.mayCreate(i,s);if(r)throw new be.ErrnoError(r);if(!i.node_ops.symlink)throw new be.ErrnoError(63);return i.node_ops.symlink(i,s,e)},rename:function(e,t){var i,s,r=me.dirname(e),o=me.dirname(t),n=me.basename(e),a=me.basename(t);if(i=be.lookupPath(e,{parent:!0}).node,s=be.lookupPath(t,{parent:!0}).node,!i||!s)throw new be.ErrnoError(44);if(i.mount!==s.mount)throw new be.ErrnoError(75);var l,h=be.lookupNode(i,n),c=ge.relative(e,o);if("."!==c.charAt(0))throw new be.ErrnoError(28);if("."!==(c=ge.relative(t,r)).charAt(0))throw new be.ErrnoError(55);try{l=be.lookupNode(s,a)}catch(e){}if(h!==l){var u=be.isDir(h.mode),d=be.mayDelete(i,n,u);if(d)throw new be.ErrnoError(d);if(d=l?be.mayDelete(s,a,u):be.mayCreate(s,a))throw new be.ErrnoError(d);if(!i.node_ops.rename)throw new be.ErrnoError(63);if(be.isMountpoint(h)||l&&be.isMountpoint(l))throw new be.ErrnoError(10);if(s!==i&&(d=be.nodePermissions(i,"w")))throw new be.ErrnoError(d);try{be.trackingDelegate.willMovePath&&be.trackingDelegate.willMovePath(e,t)}catch(i){x("FS.trackingDelegate['willMovePath']('"+e+"', '"+t+"') threw an exception: "+i.message)}be.hashRemoveNode(h);try{i.node_ops.rename(h,s,a)}catch(e){throw e}finally{be.hashAddNode(h)}try{be.trackingDelegate.onMovePath&&be.trackingDelegate.onMovePath(e,t)}catch(i){x("FS.trackingDelegate['onMovePath']('"+e+"', '"+t+"') threw an exception: "+i.message)}}},rmdir:function(e){var t=be.lookupPath(e,{parent:!0}).node,i=me.basename(e),s=be.lookupNode(t,i),r=be.mayDelete(t,i,!0);if(r)throw new be.ErrnoError(r);if(!t.node_ops.rmdir)throw new be.ErrnoError(63);if(be.isMountpoint(s))throw new be.ErrnoError(10);try{be.trackingDelegate.willDeletePath&&be.trackingDelegate.willDeletePath(e)}catch(t){x("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.rmdir(t,i),be.destroyNode(s);try{be.trackingDelegate.onDeletePath&&be.trackingDelegate.onDeletePath(e)}catch(t){x("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readdir:function(e){var t=be.lookupPath(e,{follow:!0}).node;if(!t.node_ops.readdir)throw new be.ErrnoError(54);return t.node_ops.readdir(t)},unlink:function(e){var t=be.lookupPath(e,{parent:!0}).node,i=me.basename(e),s=be.lookupNode(t,i),r=be.mayDelete(t,i,!1);if(r)throw new be.ErrnoError(r);if(!t.node_ops.unlink)throw new be.ErrnoError(63);if(be.isMountpoint(s))throw new be.ErrnoError(10);try{be.trackingDelegate.willDeletePath&&be.trackingDelegate.willDeletePath(e)}catch(t){x("FS.trackingDelegate['willDeletePath']('"+e+"') threw an exception: "+t.message)}t.node_ops.unlink(t,i),be.destroyNode(s);try{be.trackingDelegate.onDeletePath&&be.trackingDelegate.onDeletePath(e)}catch(t){x("FS.trackingDelegate['onDeletePath']('"+e+"') threw an exception: "+t.message)}},readlink:function(e){var t=be.lookupPath(e).node;if(!t)throw new be.ErrnoError(44);if(!t.node_ops.readlink)throw new be.ErrnoError(28);return ge.resolve(be.getPath(t.parent),t.node_ops.readlink(t))},stat:function(e,t){var i=be.lookupPath(e,{follow:!t}).node;if(!i)throw new be.ErrnoError(44);if(!i.node_ops.getattr)throw new be.ErrnoError(63);return i.node_ops.getattr(i)},lstat:function(e){return be.stat(e,!0)},chmod:function(e,t,i){var s;if(!(s="string"==typeof e?be.lookupPath(e,{follow:!i}).node:e).node_ops.setattr)throw new be.ErrnoError(63);s.node_ops.setattr(s,{mode:4095&t|-4096&s.mode,timestamp:Date.now()})},lchmod:function(e,t){be.chmod(e,t,!0)},fchmod:function(e,t){var i=be.getStream(e);if(!i)throw new be.ErrnoError(8);be.chmod(i.node,t)},chown:function(e,t,i,s){var r;if(!(r="string"==typeof e?be.lookupPath(e,{follow:!s}).node:e).node_ops.setattr)throw new be.ErrnoError(63);r.node_ops.setattr(r,{timestamp:Date.now()})},lchown:function(e,t,i){be.chown(e,t,i,!0)},fchown:function(e,t,i){var s=be.getStream(e);if(!s)throw new be.ErrnoError(8);be.chown(s.node,t,i)},truncate:function(e,t){if(t<0)throw new be.ErrnoError(28);var i;if(!(i="string"==typeof e?be.lookupPath(e,{follow:!0}).node:e).node_ops.setattr)throw new be.ErrnoError(63);if(be.isDir(i.mode))throw new be.ErrnoError(31);if(!be.isFile(i.mode))throw new be.ErrnoError(28);var s=be.nodePermissions(i,"w");if(s)throw new be.ErrnoError(s);i.node_ops.setattr(i,{size:t,timestamp:Date.now()})},ftruncate:function(e,t){var i=be.getStream(e);if(!i)throw new be.ErrnoError(8);if(0==(2097155&i.flags))throw new be.ErrnoError(28);be.truncate(i.node,t)},utime:function(e,t,i){var s=be.lookupPath(e,{follow:!0}).node;s.node_ops.setattr(s,{timestamp:Math.max(t,i)})},open:function(e,t,i,s,o){if(""===e)throw new be.ErrnoError(44);var n;if(i=void 0===i?438:i,i=64&(t="string"==typeof t?be.modeStringToFlags(t):t)?4095&i|32768:0,"object"==typeof e)n=e;else{e=me.normalize(e);try{n=be.lookupPath(e,{follow:!(131072&t)}).node}catch(e){}}var a=!1;if(64&t)if(n){if(128&t)throw new be.ErrnoError(20)}else n=be.mknod(e,i,0),a=!0;if(!n)throw new be.ErrnoError(44);if(be.isChrdev(n.mode)&&(t&=-513),65536&t&&!be.isDir(n.mode))throw new be.ErrnoError(54);if(!a){var l=be.mayOpen(n,t);if(l)throw new be.ErrnoError(l)}512&t&&be.truncate(n,0),t&=-131713;var h=be.createStream({node:n,path:be.getPath(n),flags:t,seekable:!0,position:0,stream_ops:n.stream_ops,ungotten:[],error:!1},s,o);h.stream_ops.open&&h.stream_ops.open(h),!r.logReadFiles||1&t||(be.readFiles||(be.readFiles={}),e in be.readFiles||(be.readFiles[e]=1,x("FS.trackingDelegate error on read file: "+e)));try{if(be.trackingDelegate.onOpenFile){var c=0;1!=(2097155&t)&&(c|=be.tracking.openFlags.READ),0!=(2097155&t)&&(c|=be.tracking.openFlags.WRITE),be.trackingDelegate.onOpenFile(e,c)}}catch(t){x("FS.trackingDelegate['onOpenFile']('"+e+"', flags) threw an exception: "+t.message)}return h},close:function(e){if(be.isClosed(e))throw new be.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e)}catch(e){throw e}finally{be.closeStream(e.fd)}e.fd=null},isClosed:function(e){return null===e.fd},llseek:function(e,t,i){if(be.isClosed(e))throw new be.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new be.ErrnoError(70);if(0!=i&&1!=i&&2!=i)throw new be.ErrnoError(28);return e.position=e.stream_ops.llseek(e,t,i),e.ungotten=[],e.position},read:function(e,t,i,s,r){if(i>>>=0,s<0||r<0)throw new be.ErrnoError(28);if(be.isClosed(e))throw new be.ErrnoError(8);if(1==(2097155&e.flags))throw new be.ErrnoError(8);if(be.isDir(e.node.mode))throw new be.ErrnoError(31);if(!e.stream_ops.read)throw new be.ErrnoError(28);var o=void 0!==r;if(o){if(!e.seekable)throw new be.ErrnoError(70)}else r=e.position;var n=e.stream_ops.read(e,t,i,s,r);return o||(e.position+=n),n},write:function(e,t,i,s,r,o){if(i>>>=0,s<0||r<0)throw new be.ErrnoError(28);if(be.isClosed(e))throw new be.ErrnoError(8);if(0==(2097155&e.flags))throw new be.ErrnoError(8);if(be.isDir(e.node.mode))throw new be.ErrnoError(31);if(!e.stream_ops.write)throw new be.ErrnoError(28);e.seekable&&1024&e.flags&&be.llseek(e,0,2);var n=void 0!==r;if(n){if(!e.seekable)throw new be.ErrnoError(70)}else r=e.position;var a=e.stream_ops.write(e,t,i,s,r,o);n||(e.position+=a);try{e.path&&be.trackingDelegate.onWriteToFile&&be.trackingDelegate.onWriteToFile(e.path)}catch(t){x("FS.trackingDelegate['onWriteToFile']('"+e.path+"') threw an exception: "+t.message)}return a},allocate:function(e,t,i){if(be.isClosed(e))throw new be.ErrnoError(8);if(t<0||i<=0)throw new be.ErrnoError(28);if(0==(2097155&e.flags))throw new be.ErrnoError(8);if(!be.isFile(e.node.mode)&&!be.isDir(e.node.mode))throw new be.ErrnoError(43);if(!e.stream_ops.allocate)throw new be.ErrnoError(138);e.stream_ops.allocate(e,t,i)},mmap:function(e,t,i,s,r,o){if(t>>>=0,0!=(2&r)&&0==(2&o)&&2!=(2097155&e.flags))throw new be.ErrnoError(2);if(1==(2097155&e.flags))throw new be.ErrnoError(2);if(!e.stream_ops.mmap)throw new be.ErrnoError(43);return e.stream_ops.mmap(e,t,i,s,r,o)},msync:function(e,t,i,s,r){return i>>>=0,e&&e.stream_ops.msync?e.stream_ops.msync(e,t,i,s,r):0},munmap:function(e){return 0},ioctl:function(e,t,i){if(!e.stream_ops.ioctl)throw new be.ErrnoError(59);return e.stream_ops.ioctl(e,t,i)},readFile:function(e,t){if((t=t||{}).flags=t.flags||0,t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error('Invalid encoding type "'+t.encoding+'"');var i,s=be.open(e,t.flags),r=be.stat(e).size,o=new Uint8Array(r);return be.read(s,o,0,r,0),"utf8"===t.encoding?i=E(o,0):"binary"===t.encoding&&(i=o),be.close(s),i},writeFile:function(e,t,i){(i=i||{}).flags=i.flags||577;var s=be.open(e,i.flags,i.mode);if("string"==typeof t){var r=new Uint8Array(S(t)+1),o=D(t,r,0,r.length);be.write(s,r,0,o,void 0,i.canOwn)}else{if(!ArrayBuffer.isView(t))throw new Error("Unsupported data type");be.write(s,t,0,t.byteLength,void 0,i.canOwn)}be.close(s)},cwd:function(){return be.currentPath},chdir:function(e){var t=be.lookupPath(e,{follow:!0});if(null===t.node)throw new be.ErrnoError(44);if(!be.isDir(t.node.mode))throw new be.ErrnoError(54);var i=be.nodePermissions(t.node,"x");if(i)throw new be.ErrnoError(i);be.currentPath=t.path},createDefaultDirectories:function(){be.mkdir("/tmp"),be.mkdir("/home"),be.mkdir("/home/web_user")},createDefaultDevices:function(){be.mkdir("/dev"),be.registerDevice(be.makedev(1,3),{read:function(){return 0},write:function(e,t,i,s,r){return s}}),be.mkdev("/dev/null",be.makedev(1,3)),_e.register(be.makedev(5,0),_e.default_tty_ops),_e.register(be.makedev(6,0),_e.default_tty1_ops),be.mkdev("/dev/tty",be.makedev(5,0)),be.mkdev("/dev/tty1",be.makedev(6,0));var e=function(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues){var e=new Uint8Array(1);return function(){return crypto.getRandomValues(e),e[0]}}if(g)try{var t=op();return function(){return t.randomBytes(1)[0]}}catch(e){}return function(){le("randomDevice")}}();be.createDevice("/dev","random",e),be.createDevice("/dev","urandom",e),be.mkdir("/dev/shm"),be.mkdir("/dev/shm/tmp")},createSpecialDirectories:function(){be.mkdir("/proc");var e=be.mkdir("/proc/self");be.mkdir("/proc/self/fd"),be.mount({mount:function(){var t=be.createNode(e,"fd",16895,73);return t.node_ops={lookup:function(e,t){var i=+t,s=be.getStream(i);if(!s)throw new be.ErrnoError(8);var r={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:function(){return s.path}}};return r.parent=r,r}},t}},{},"/proc/self/fd")},createStandardStreams:function(){r.stdin?be.createDevice("/dev","stdin",r.stdin):be.symlink("/dev/tty","/dev/stdin"),r.stdout?be.createDevice("/dev","stdout",null,r.stdout):be.symlink("/dev/tty","/dev/stdout"),r.stderr?be.createDevice("/dev","stderr",null,r.stderr):be.symlink("/dev/tty1","/dev/stderr"),be.open("/dev/stdin",0),be.open("/dev/stdout",1),be.open("/dev/stderr",1)},ensureErrnoError:function(){be.ErrnoError||(be.ErrnoError=function(e,t){this.node=t,this.setErrno=function(e){this.errno=e},this.setErrno(e),this.message="FS error"},be.ErrnoError.prototype=new Error,be.ErrnoError.prototype.constructor=be.ErrnoError,[44].forEach((function(e){be.genericErrors[e]=new be.ErrnoError(e),be.genericErrors[e].stack="<generic error, no stack>"})))},staticInit:function(){be.ensureErrnoError(),be.nameTable=new Array(4096),be.mount(ve,{},"/"),be.createDefaultDirectories(),be.createDefaultDevices(),be.createSpecialDirectories(),be.filesystems={MEMFS:ve}},init:function(e,t,i){be.init.initialized=!0,be.ensureErrnoError(),r.stdin=e||r.stdin,r.stdout=t||r.stdout,r.stderr=i||r.stderr,be.createStandardStreams()},quit:function(){be.init.initialized=!1;var e=r._fflush;e&&e(0);for(var t=0;t<be.streams.length;t++){var i=be.streams[t];i&&be.close(i)}},getMode:function(e,t){var i=0;return e&&(i|=365),t&&(i|=146),i},findObject:function(e,t){var i=be.analyzePath(e,t);return i.exists?i.object:null},analyzePath:function(e,t){try{e=(s=be.lookupPath(e,{follow:!t})).path}catch(e){}var i={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var s=be.lookupPath(e,{parent:!0});i.parentExists=!0,i.parentPath=s.path,i.parentObject=s.node,i.name=me.basename(e),s=be.lookupPath(e,{follow:!t}),i.exists=!0,i.path=s.path,i.object=s.node,i.name=s.node.name,i.isRoot="/"===s.path}catch(e){i.error=e.errno}return i},createPath:function(e,t,i,s){e="string"==typeof e?e:be.getPath(e);for(var r=t.split("/").reverse();r.length;){var o=r.pop();if(o){var n=me.join2(e,o);try{be.mkdir(n)}catch(e){}e=n}}return n},createFile:function(e,t,i,s,r){var o=me.join2("string"==typeof e?e:be.getPath(e),t),n=be.getMode(s,r);return be.create(o,n)},createDataFile:function(e,t,i,s,r,o){var n=t?me.join2("string"==typeof e?e:be.getPath(e),t):e,a=be.getMode(s,r),l=be.create(n,a);if(i){if("string"==typeof i){for(var h=new Array(i.length),c=0,u=i.length;c<u;++c)h[c]=i.charCodeAt(c);i=h}be.chmod(l,146|a);var d=be.open(l,577);be.write(d,i,0,i.length,0,o),be.close(d),be.chmod(l,a)}return l},createDevice:function(e,t,i,s){var r=me.join2("string"==typeof e?e:be.getPath(e),t),o=be.getMode(!!i,!!s);be.createDevice.major||(be.createDevice.major=64);var n=be.makedev(be.createDevice.major++,0);return be.registerDevice(n,{open:function(e){e.seekable=!1},close:function(e){s&&s.buffer&&s.buffer.length&&s(10)},read:function(e,t,s,r,o){for(var n=0,a=0;a<r;a++){var l;try{l=i()}catch(e){throw new be.ErrnoError(29)}if(void 0===l&&0===n)throw new be.ErrnoError(6);if(null==l)break;n++,t[s+a]=l}return n&&(e.node.timestamp=Date.now()),n},write:function(e,t,i,r,o){for(var n=0;n<r;n++)try{s(t[i+n])}catch(e){throw new be.ErrnoError(29)}return r&&(e.node.timestamp=Date.now()),n}}),be.mkdev(r,o,n)},forceLoadFile:function(e){if(e.isDevice||e.isFolder||e.link||e.contents)return!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!a)throw new Error("Cannot load without read() or XMLHttpRequest.");try{e.contents=si(a(e.url),!0),e.usedBytes=e.contents.length}catch(e){throw new be.ErrnoError(29)}},createLazyFile:function(e,t,i,s,r){function o(){this.lengthKnown=!1,this.chunks=[]}if(o.prototype.get=function(e){if(!(e>this.length-1||e<0)){var t=e%this.chunkSize,i=e/this.chunkSize|0;return this.getter(i)[t]}},o.prototype.setDataGetter=function(e){this.getter=e},o.prototype.cacheLength=function(){var e=new XMLHttpRequest;if(e.open("HEAD",i,!1),e.send(null),!(e.status>=200&&e.status<300||304===e.status))throw new Error("Couldn't load "+i+". Status: "+e.status);var t,s=Number(e.getResponseHeader("Content-length")),r=(t=e.getResponseHeader("Accept-Ranges"))&&"bytes"===t,o=(t=e.getResponseHeader("Content-Encoding"))&&"gzip"===t,n=1048576;r||(n=s);var a=this;a.setDataGetter((function(e){var t=e*n,r=(e+1)*n-1;if(r=Math.min(r,s-1),void 0===a.chunks[e]&&(a.chunks[e]=function(e,t){if(e>t)throw new Error("invalid range ("+e+", "+t+") or no bytes requested!");if(t>s-1)throw new Error("only "+s+" bytes available! programmer error!");var r=new XMLHttpRequest;if(r.open("GET",i,!1),s!==n&&r.setRequestHeader("Range","bytes="+e+"-"+t),"undefined"!=typeof Uint8Array&&(r.responseType="arraybuffer"),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.send(null),!(r.status>=200&&r.status<300||304===r.status))throw new Error("Couldn't load "+i+". Status: "+r.status);return void 0!==r.response?new Uint8Array(r.response||[]):si(r.responseText||"",!0)}(t,r)),void 0===a.chunks[e])throw new Error("doXHR failed!");return a.chunks[e]})),!o&&s||(n=s=1,s=this.getter(0).length,n=s,b("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=s,this._chunkSize=n,this.lengthKnown=!0},"undefined"!=typeof XMLHttpRequest){if(!m)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var n=new o;Object.defineProperties(n,{length:{get:function(){return this.lengthKnown||this.cacheLength(),this._length}},chunkSize:{get:function(){return this.lengthKnown||this.cacheLength(),this._chunkSize}}});var a={isDevice:!1,contents:n}}else a={isDevice:!1,url:i};var l=be.createFile(e,t,a,s,r);a.contents?l.contents=a.contents:a.url&&(l.contents=null,l.url=a.url),Object.defineProperties(l,{usedBytes:{get:function(){return this.contents.length}}});var h={};return Object.keys(l.stream_ops).forEach((function(e){var t=l.stream_ops[e];h[e]=function(){return be.forceLoadFile(l),t.apply(null,arguments)}})),h.read=function(e,t,i,s,r){be.forceLoadFile(l);var o=e.node.contents;if(r>=o.length)return 0;var n=Math.min(o.length-r,s);if(o.slice)for(var a=0;a<n;a++)t[i+a]=o[r+a];else for(a=0;a<n;a++)t[i+a]=o.get(r+a);return n},l.stream_ops=h,l},createPreloadedFile:function(e,t,i,s,o,n,a,h,c,u){Browser.init();var d=t?ge.resolve(me.join2(e,t)):e;function p(i){function l(i){u&&u(),h||be.createDataFile(e,t,i,s,o,c),n&&n(),ae()}var p=!1;r.preloadPlugins.forEach((function(e){p||e.canHandle(d)&&(e.handle(i,d,l,(function(){a&&a(),ae()})),p=!0)})),p||l(i)}ne(),"string"==typeof i?function(e,t,i,s){var r=s?"":"al "+e;l(e,(function(i){M(i,'Loading data file "'+e+'" failed (no arrayBuffer).'),t(new Uint8Array(i)),r&&ae()}),(function(t){if(!i)throw'Loading data file "'+e+'" failed.';i()})),r&&ne()}(i,(function(e){p(e)}),a):p(i)},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return"EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(e,t,i){t=t||function(){},i=i||function(){};var s=be.indexedDB();try{var r=s.open(be.DB_NAME(),be.DB_VERSION)}catch(e){return i(e)}r.onupgradeneeded=function(){b("creating db"),r.result.createObjectStore(be.DB_STORE_NAME)},r.onsuccess=function(){var s=r.result.transaction([be.DB_STORE_NAME],"readwrite"),o=s.objectStore(be.DB_STORE_NAME),n=0,a=0,l=e.length;function h(){0==a?t():i()}e.forEach((function(e){var t=o.put(be.analyzePath(e).object.contents,e);t.onsuccess=function(){++n+a==l&&h()},t.onerror=function(){a++,n+a==l&&h()}})),s.onerror=i},r.onerror=i},loadFilesFromDB:function(e,t,i){t=t||function(){},i=i||function(){};var s=be.indexedDB();try{var r=s.open(be.DB_NAME(),be.DB_VERSION)}catch(e){return i(e)}r.onupgradeneeded=i,r.onsuccess=function(){var s=r.result;try{var o=s.transaction([be.DB_STORE_NAME],"readonly")}catch(e){return void i(e)}var n=o.objectStore(be.DB_STORE_NAME),a=0,l=0,h=e.length;function c(){0==l?t():i()}e.forEach((function(e){var t=n.get(e);t.onsuccess=function(){be.analyzePath(e).exists&&be.unlink(e),be.createDataFile(me.dirname(e),me.basename(e),t.result,!0,!0,!0),++a+l==h&&c()},t.onerror=function(){l++,a+l==h&&c()}})),o.onerror=i},r.onerror=i}},xe={mappings:{},DEFAULT_POLLMASK:5,umask:511,calculateAt:function(e,t,i){if("/"===t[0])return t;var s;if(-100===e)s=be.cwd();else{var r=be.getStream(e);if(!r)throw new be.ErrnoError(8);s=r.path}if(0==t.length){if(!i)throw new be.ErrnoError(44);return s}return me.join2(s,t)},doStat:function(e,t,i){try{var s=e(t)}catch(e){if(e&&e.node&&me.normalize(t)!==me.normalize(be.getPath(e.node)))return-54;throw e}return k[i>>>2]=s.dev,k[i+4>>>2]=0,k[i+8>>>2]=s.ino,k[i+12>>>2]=s.mode,k[i+16>>>2]=s.nlink,k[i+20>>>2]=s.uid,k[i+24>>>2]=s.gid,k[i+28>>>2]=s.rdev,k[i+32>>>2]=0,se=[s.size>>>0,(ie=s.size,+Math.abs(ie)>=1?ie>0?(0|Math.min(+Math.floor(ie/4294967296),4294967295))>>>0:~~+Math.ceil((ie-+(~~ie>>>0))/4294967296)>>>0:0)],k[i+40>>>2]=se[0],k[i+44>>>2]=se[1],k[i+48>>>2]=4096,k[i+52>>>2]=s.blocks,k[i+56>>>2]=s.atime.getTime()/1e3|0,k[i+60>>>2]=0,k[i+64>>>2]=s.mtime.getTime()/1e3|0,k[i+68>>>2]=0,k[i+72>>>2]=s.ctime.getTime()/1e3|0,k[i+76>>>2]=0,se=[s.ino>>>0,(ie=s.ino,+Math.abs(ie)>=1?ie>0?(0|Math.min(+Math.floor(ie/4294967296),4294967295))>>>0:~~+Math.ceil((ie-+(~~ie>>>0))/4294967296)>>>0:0)],k[i+80>>>2]=se[0],k[i+84>>>2]=se[1],0},doMsync:function(e,t,i,s,r){var o=L.slice(e,e+i);be.msync(t,o,r,i,s)},doMkdir:function(e,t){return"/"===(e=me.normalize(e))[e.length-1]&&(e=e.substr(0,e.length-1)),be.mkdir(e,t,0),0},doMknod:function(e,t,i){switch(61440&t){case 32768:case 8192:case 24576:case 4096:case 49152:break;default:return-28}return be.mknod(e,t,i),0},doReadlink:function(e,t,i){if(i<=0)return-28;var s=be.readlink(e),r=Math.min(i,S(s)),o=F[t+r>>>0];return T(s,t,i+1),F[t+r>>>0]=o,r},doAccess:function(e,t){if(-8&t)return-28;var i;if(!(i=be.lookupPath(e,{follow:!0}).node))return-44;var s="";return 4&t&&(s+="r"),2&t&&(s+="w"),1&t&&(s+="x"),s&&be.nodePermissions(i,s)?-2:0},doDup:function(e,t,i){var s=be.getStream(i);return s&&be.close(s),be.open(e,t,0,i,i).fd},doReadv:function(e,t,i,s){for(var r=0,o=0;o<i;o++){var n=k[t+8*o>>>2],a=k[t+(8*o+4)>>>2],l=be.read(e,F,n,a,s);if(l<0)return-1;if(r+=l,l<a)break}return r},doWritev:function(e,t,i,s){for(var r=0,o=0;o<i;o++){var n=k[t+8*o>>>2],a=k[t+(8*o+4)>>>2],l=be.write(e,F,n,a,s);if(l<0)return-1;r+=l}return r},varargs:void 0,get:function(){return xe.varargs+=4,k[xe.varargs-4>>>2]},getStr:function(e){return A(e)},getStreamFromFD:function(e){var t=be.getStream(e);if(!t)throw new be.ErrnoError(8);return t},get64:function(e,t){return e}},ye={};function Pe(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function we(e){return this.fromWireType(O[e>>>2])}var Me={},Ce={},Ee={};function Ae(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function De(e,t){return e=Ae(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function Te(e,t){var i=De(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var Se=void 0;function Ie(e){throw new Se(e)}function Fe(e,t,i){function s(t){var s=i(t);s.length!==e.length&&Ie("Mismatched type converter count");for(var r=0;r<e.length;++r)je(e[r],s[r])}e.forEach((function(e){Ee[e]=t}));var r=new Array(t.length),o=[],n=0;t.forEach((function(e,t){Ce.hasOwnProperty(e)?r[t]=Ce[e]:(o.push(e),Me.hasOwnProperty(e)||(Me[e]=[]),Me[e].push((function(){r[t]=Ce[e],++n===o.length&&s(r)})))})),0===o.length&&s(r)}var Le={};function Be(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var Re=void 0;function ke(e){for(var t="",i=e;L[i>>>0];)t+=Re[L[i++>>>0]];return t}var Oe=void 0;function Ne(e){throw new Oe(e)}function je(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var s=t.name;if(e||Ne('type "'+s+'" must have a positive integer typeid pointer'),Ce.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;Ne("Cannot register type '"+s+"' twice")}if(Ce[e]=t,delete Ee[e],Me.hasOwnProperty(e)){var r=Me[e];delete Me[e],r.forEach((function(e){e()}))}}function Ve(e){if(!(this instanceof et))return!1;if(!(e instanceof et))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,s=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;s.baseClass;)r=s.upcast(r),s=s.baseClass;return t===s&&i===r}function ze(e){return{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType}}function Ue(e){Ne(e.$$.ptrType.registeredClass.name+" instance already deleted")}var Ge=!1;function We(e){}function He(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function Xe(e){return"undefined"==typeof FinalizationGroup?(Xe=function(e){return e},e):(Ge=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?He(i):console.warn("object already deleted: "+i.ptr)}})),We=function(e){Ge.unregister(e.$$)},(Xe=function(e){return Ge.register(e,e.$$,e.$$),e})(e))}function Ye(){if(this.$$.ptr||Ue(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e=Xe(Object.create(Object.getPrototypeOf(this),{$$:{value:ze(this.$$)}}));return e.$$.count.value+=1,e.$$.deleteScheduled=!1,e}function qe(){this.$$.ptr||Ue(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Ne("Object already scheduled for deletion"),We(this),He(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function $e(){return!this.$$.ptr}var Ze=void 0,Ke=[];function Qe(){for(;Ke.length;){var e=Ke.pop();e.$$.deleteScheduled=!1,e.delete()}}function Je(){return this.$$.ptr||Ue(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&Ne("Object already scheduled for deletion"),Ke.push(this),1===Ke.length&&Ze&&Ze(Qe),this.$$.deleteScheduled=!0,this}function et(){}var tt={};function it(e,t,i){if(void 0===e[t].overloadTable){var s=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||Ne("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[s.argCount]=s}}function st(e,t,i){r.hasOwnProperty(e)?((void 0===i||void 0!==r[e].overloadTable&&void 0!==r[e].overloadTable[i])&&Ne("Cannot register public name '"+e+"' twice"),it(r,e,e),r.hasOwnProperty(i)&&Ne("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),r[e].overloadTable[i]=t):(r[e]=t,void 0!==i&&(r[e].numArguments=i))}function rt(e,t,i,s,r,o,n,a){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=s,this.baseClass=r,this.getActualType=o,this.upcast=n,this.downcast=a,this.pureVirtualFunctions=[]}function ot(e,t,i){for(;t!==i;)t.upcast||Ne("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function nt(e,t){if(null===t)return this.isReference&&Ne("null is not a valid "+this.name),0;t.$$||Ne('Cannot pass "'+Ot(t)+'" as a '+this.name),t.$$.ptr||Ne("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return ot(t.$$.ptr,i,this.registeredClass)}function at(e,t){var i;if(null===t)return this.isReference&&Ne("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||Ne('Cannot pass "'+Ot(t)+'" as a '+this.name),t.$$.ptr||Ne("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&Ne("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var s=t.$$.ptrType.registeredClass;if(i=ot(t.$$.ptr,s,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&Ne("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:Ne("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var r=t.clone();i=this.rawShare(i,Bt((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:Ne("Unsupporting sharing policy")}return i}function lt(e,t){if(null===t)return this.isReference&&Ne("null is not a valid "+this.name),0;t.$$||Ne('Cannot pass "'+Ot(t)+'" as a '+this.name),t.$$.ptr||Ne("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&Ne("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return ot(t.$$.ptr,i,this.registeredClass)}function ht(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function ct(e){this.rawDestructor&&this.rawDestructor(e)}function ut(e){null!==e&&e.delete()}function dt(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var s=dt(e,t,i.baseClass);return null===s?null:i.downcast(s)}function pt(){return Object.keys(gt).length}function ft(){var e=[];for(var t in gt)gt.hasOwnProperty(t)&&e.push(gt[t]);return e}function mt(e){Ze=e,Ke.length&&Ze&&Ze(Qe)}var gt={};function _t(e,t){return t=function(e,t){for(void 0===t&&Ne("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),gt[t]}function vt(e,t){return t.ptrType&&t.ptr||Ie("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!=!!t.smartPtr&&Ie("Both smartPtrType and smartPtr must be specified"),t.count={value:1},Xe(Object.create(e,{$$:{value:t}}))}function bt(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=_t(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var s=i.clone();return this.destructor(e),s}function r(){return this.isSmartPointer?vt(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):vt(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var o,n=this.registeredClass.getActualType(t),a=tt[n];if(!a)return r.call(this);o=this.isConst?a.constPointerType:a.pointerType;var l=dt(t,this.registeredClass,o.registeredClass);return null===l?r.call(this):this.isSmartPointer?vt(o.registeredClass.instancePrototype,{ptrType:o,ptr:l,smartPtrType:this,smartPtr:e}):vt(o.registeredClass.instancePrototype,{ptrType:o,ptr:l})}function xt(e,t,i,s,r,o,n,a,l,h,c){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=s,this.isSmartPointer=r,this.pointeeType=o,this.sharingPolicy=n,this.rawGetPointee=a,this.rawConstructor=l,this.rawShare=h,this.rawDestructor=c,r||void 0!==t.baseClass?this.toWireType=at:s?(this.toWireType=nt,this.destructorFunction=null):(this.toWireType=lt,this.destructorFunction=null)}function yt(e,t,i){r.hasOwnProperty(e)||Ie("Replacing nonexistant public symbol"),void 0!==r[e].overloadTable&&void 0!==i?r[e].overloadTable[i]=t:(r[e]=t,r[e].argCount=i)}function Pt(e,t,i){return e.includes("j")?function(e,t,i){var s=r["dynCall_"+e];return i&&i.length?s.apply(null,[t].concat(i)):s.call(null,t)}(e,t,i):V.get(t).apply(null,i)}function wt(e,t){var i,s,r,o=(e=ke(e)).includes("j")?(i=e,s=t,r=[],function(){r.length=arguments.length;for(var e=0;e<arguments.length;e++)r[e]=arguments[e];return Pt(i,s,r)}):V.get(t);return"function"!=typeof o&&Ne("unknown function pointer with signature "+e+": "+t),o}var Mt=void 0;function Ct(e){var t=ai(e),i=ke(t);return ni(t),i}function Et(e,t){var i=[],s={};throw t.forEach((function e(t){s[t]||Ce[t]||(Ee[t]?Ee[t].forEach(e):(i.push(t),s[t]=!0))})),new Mt(e+": "+i.map(Ct).join([", "]))}function At(e,t){for(var i=[],s=0;s<e;s++)i.push(k[(t>>2)+s>>>0]);return i}function Dt(e,t,i,s,r){var o=t.length;o<2&&Ne("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var n=null!==t[1]&&null!==i,a=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){a=!0;break}var h="void"!==t[0].name,c="",u="";for(l=0;l<o-2;++l)c+=(0!==l?", ":"")+"arg"+l,u+=(0!==l?", ":"")+"arg"+l+"Wired";var d="return function "+Ae(e)+"("+c+") {\nif (arguments.length !== "+(o-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(o-2)+" args!');\n}\n";a&&(d+="var destructors = [];\n");var p=a?"destructors":"null",f=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],m=[Ne,s,r,Pe,t[0],t[1]];for(n&&(d+="var thisWired = classParam.toWireType("+p+", this);\n"),l=0;l<o-2;++l)d+="var arg"+l+"Wired = argType"+l+".toWireType("+p+", arg"+l+"); // "+t[l+2].name+"\n",f.push("argType"+l),m.push(t[l+2]);if(n&&(u="thisWired"+(u.length>0?", ":"")+u),d+=(h?"var rv = ":"")+"invoker(fn"+(u.length>0?", ":"")+u+");\n",a)d+="runDestructors(destructors);\n";else for(l=n?1:2;l<t.length;++l){var g=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(d+=g+"_dtor("+g+"); // "+t[l].name+"\n",f.push(g+"_dtor"),m.push(t[l].destructorFunction))}h&&(d+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),d+="}\n",f.push(d);var _=function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var i=De(e.name||"unknownFunctionName",(function(){}));i.prototype=e.prototype;var s=new i,r=e.apply(s,t);return r instanceof Object?r:s}(Function,f).apply(null,m);return _}var Tt=[],St=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function It(e){e>4&&0==--St[e].refcount&&(St[e]=void 0,Tt.push(e))}function Ft(){for(var e=0,t=5;t<St.length;++t)void 0!==St[t]&&++e;return e}function Lt(){for(var e=5;e<St.length;++e)if(void 0!==St[e])return St[e];return null}function Bt(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Tt.length?Tt.pop():St.length;return St[t]={refcount:1,value:e},t}}function Rt(e,t,i){switch(t){case 0:return function(e){var t=i?F:L;return this.fromWireType(t[e>>>0])};case 1:return function(e){var t=i?B:R;return this.fromWireType(t[e>>>1])};case 2:return function(e){var t=i?k:O;return this.fromWireType(t[e>>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function kt(e,t){var i=Ce[e];return void 0===i&&Ne(t+" has unknown type "+Ct(e)),i}function Ot(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Nt(e,t){switch(t){case 2:return function(e){return this.fromWireType(N[e>>>2])};case 3:return function(e){return this.fromWireType(j[e>>>3])};default:throw new TypeError("Unknown float type: "+e)}}function jt(e,t,i){switch(t){case 0:return i?function(e){return F[e>>>0]}:function(e){return L[e>>>0]};case 1:return i?function(e){return B[e>>>1]}:function(e){return R[e>>>1]};case 2:return i?function(e){return k[e>>>2]}:function(e){return O[e>>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function Vt(e){return e||Ne("Cannot use deleted val. handle = "+e),St[e].value}var zt,Ut={};function Gt(e){var t=Ut[e];return void 0===t?ke(e):t}function Wt(){return"object"==typeof globalThis?globalThis:Function("return this")()}function Ht(e){try{return y.grow(e-I.byteLength+65535>>>16),q(y.buffer),1}catch(e){}}zt=g?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:function(){return performance.now()};var Xt={};function Yt(){if(!Yt.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:d||"./this.program"};for(var t in Xt)void 0===Xt[t]?delete e[t]:e[t]=Xt[t];var i=[];for(var t in e)i.push(t+"="+e[t]);Yt.strings=i}return Yt.strings}function qt(e){return e%4==0&&(e%100!=0||e%400==0)}function $t(e,t){for(var i=0,s=0;s<=t;i+=e[s++]);return i}var Zt=[31,29,31,30,31,30,31,31,30,31,30,31],Kt=[31,28,31,30,31,30,31,31,30,31,30,31];function Qt(e,t){for(var i=new Date(e.getTime());t>0;){var s=qt(i.getFullYear()),r=i.getMonth(),o=(s?Zt:Kt)[r];if(!(t>o-i.getDate()))return i.setDate(i.getDate()+t),i;t-=o-i.getDate()+1,i.setDate(1),r<11?i.setMonth(r+1):(i.setMonth(0),i.setFullYear(i.getFullYear()+1))}return i}function Jt(e,t,i,s){var r=k[s+40>>>2],o={tm_sec:k[s>>>2],tm_min:k[s+4>>>2],tm_hour:k[s+8>>>2],tm_mday:k[s+12>>>2],tm_mon:k[s+16>>>2],tm_year:k[s+20>>>2],tm_wday:k[s+24>>>2],tm_yday:k[s+28>>>2],tm_isdst:k[s+32>>>2],tm_gmtoff:k[s+36>>>2],tm_zone:r?A(r):""},n=A(i),a={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var l in a)n=n.replace(new RegExp(l,"g"),a[l]);var h=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],c=["January","February","March","April","May","June","July","August","September","October","November","December"];function u(e,t,i){for(var s="number"==typeof e?e.toString():e||"";s.length<t;)s=i[0]+s;return s}function d(e,t){return u(e,t,"0")}function p(e,t){function i(e){return e<0?-1:e>0?1:0}var s;return 0===(s=i(e.getFullYear()-t.getFullYear()))&&0===(s=i(e.getMonth()-t.getMonth()))&&(s=i(e.getDate()-t.getDate())),s}function f(e){switch(e.getDay()){case 0:return new Date(e.getFullYear()-1,11,29);case 1:return e;case 2:return new Date(e.getFullYear(),0,3);case 3:return new Date(e.getFullYear(),0,2);case 4:return new Date(e.getFullYear(),0,1);case 5:return new Date(e.getFullYear()-1,11,31);case 6:return new Date(e.getFullYear()-1,11,30)}}function m(e){var t=Qt(new Date(e.tm_year+1900,0,1),e.tm_yday),i=new Date(t.getFullYear(),0,4),s=new Date(t.getFullYear()+1,0,4),r=f(i),o=f(s);return p(r,t)<=0?p(o,t)<=0?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}var g={"%a":function(e){return h[e.tm_wday].substring(0,3)},"%A":function(e){return h[e.tm_wday]},"%b":function(e){return c[e.tm_mon].substring(0,3)},"%B":function(e){return c[e.tm_mon]},"%C":function(e){return d((e.tm_year+1900)/100|0,2)},"%d":function(e){return d(e.tm_mday,2)},"%e":function(e){return u(e.tm_mday,2," ")},"%g":function(e){return m(e).toString().substring(2)},"%G":function(e){return m(e)},"%H":function(e){return d(e.tm_hour,2)},"%I":function(e){var t=e.tm_hour;return 0==t?t=12:t>12&&(t-=12),d(t,2)},"%j":function(e){return d(e.tm_mday+$t(qt(e.tm_year+1900)?Zt:Kt,e.tm_mon-1),3)},"%m":function(e){return d(e.tm_mon+1,2)},"%M":function(e){return d(e.tm_min,2)},"%n":function(){return"\n"},"%p":function(e){return e.tm_hour>=0&&e.tm_hour<12?"AM":"PM"},"%S":function(e){return d(e.tm_sec,2)},"%t":function(){return"\t"},"%u":function(e){return e.tm_wday||7},"%U":function(e){var t=new Date(e.tm_year+1900,0,1),i=0===t.getDay()?t:Qt(t,7-t.getDay()),s=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(p(i,s)<0){var r=$t(qt(s.getFullYear())?Zt:Kt,s.getMonth()-1)-31,o=31-i.getDate()+r+s.getDate();return d(Math.ceil(o/7),2)}return 0===p(i,t)?"01":"00"},"%V":function(e){var t,i=new Date(e.tm_year+1900,0,4),s=new Date(e.tm_year+1901,0,4),r=f(i),o=f(s),n=Qt(new Date(e.tm_year+1900,0,1),e.tm_yday);return p(n,r)<0?"53":p(o,n)<=0?"01":(t=r.getFullYear()<e.tm_year+1900?e.tm_yday+32-r.getDate():e.tm_yday+1-r.getDate(),d(Math.ceil(t/7),2))},"%w":function(e){return e.tm_wday},"%W":function(e){var t=new Date(e.tm_year,0,1),i=1===t.getDay()?t:Qt(t,0===t.getDay()?1:7-t.getDay()+1),s=new Date(e.tm_year+1900,e.tm_mon,e.tm_mday);if(p(i,s)<0){var r=$t(qt(s.getFullYear())?Zt:Kt,s.getMonth()-1)-31,o=31-i.getDate()+r+s.getDate();return d(Math.ceil(o/7),2)}return 0===p(i,t)?"01":"00"},"%y":function(e){return(e.tm_year+1900).toString().substring(2)},"%Y":function(e){return e.tm_year+1900},"%z":function(e){var t=e.tm_gmtoff,i=t>=0;return t=(t=Math.abs(t)/60)/60*100+t%60,(i?"+":"-")+String("0000"+t).slice(-4)},"%Z":function(e){return e.tm_zone},"%%":function(){return"%"}};for(var l in g)n.includes(l)&&(n=n.replace(new RegExp(l,"g"),g[l](o)));var _,v,b=si(n,!1);return b.length>t?0:(_=b,v=e,F.set(_,v>>>0),b.length-1)}var ei=function(e,t,i,s){e||(e=this),this.parent=e,this.mount=e.mount,this.mounted=null,this.id=be.nextInode++,this.name=t,this.mode=i,this.node_ops={},this.stream_ops={},this.rdev=s},ti=365,ii=146;function si(e,t,i){var s=i>0?i:S(e)+1,r=new Array(s),o=D(e,r,0,r.length);return t&&(r.length=o),r}Object.defineProperties(ei.prototype,{read:{get:function(){return(this.mode&ti)===ti},set:function(e){e?this.mode|=ti:this.mode&=-366}},write:{get:function(){return(this.mode&ii)===ii},set:function(e){e?this.mode|=ii:this.mode&=-147}},isFolder:{get:function(){return be.isDir(this.mode)}},isDevice:{get:function(){return be.isChrdev(this.mode)}}}),be.FSNode=ei,be.staticInit(),r.FS_createPath=be.createPath,r.FS_createDataFile=be.createDataFile,r.FS_createPreloadedFile=be.createPreloadedFile,r.FS_createLazyFile=be.createLazyFile,r.FS_createDevice=be.createDevice,r.FS_unlink=be.unlink,Se=r.InternalError=Te(Error,"InternalError"),function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);Re=e}(),Oe=r.BindingError=Te(Error,"BindingError"),et.prototype.isAliasOf=Ve,et.prototype.clone=Ye,et.prototype.delete=qe,et.prototype.isDeleted=$e,et.prototype.deleteLater=Je,xt.prototype.getPointee=ht,xt.prototype.destructor=ct,xt.prototype.argPackAdvance=8,xt.prototype.readValueFromPointer=we,xt.prototype.deleteObject=ut,xt.prototype.fromWireType=bt,r.getInheritedInstanceCount=pt,r.getLiveInheritedInstances=ft,r.flushPendingDeletes=Qe,r.setDelayFunction=mt,Mt=r.UnboundTypeError=Te(Error,"UnboundTypeError"),r.count_emval_handles=Ft,r.get_first_emval=Lt;var ri={y:function(e,t,i,s){le("Assertion failed: "+A(e)+", at: "+[t?A(t):"unknown filename",i,s?A(s):"unknown function"])},x:function(e){return oi(e+16)+16},w:function(e,t,i){throw new pe(e).init(t,i),e},A:function(e,t,i){xe.varargs=i;try{var s=xe.getStreamFromFD(e);switch(t){case 0:return(r=xe.get())<0?-28:be.open(s.path,s.flags,0,r).fd;case 1:case 2:case 13:case 14:return 0;case 3:return s.flags;case 4:var r=xe.get();return s.flags|=r,0;case 12:return r=xe.get(),B[r+0>>>1]=2,0;case 16:case 8:default:return-28;case 9:return fe(28),-1}}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),-e.errno}},O:function(e,t,i){xe.varargs=i;try{var s=xe.getStreamFromFD(e);switch(t){case 21509:case 21505:case 21510:case 21511:case 21512:case 21506:case 21507:case 21508:case 21523:case 21524:return s.tty?0:-59;case 21519:if(!s.tty)return-59;var r=xe.get();return k[r>>>2]=0,0;case 21520:return s.tty?-28:-59;case 21531:return r=xe.get(),be.ioctl(s,t,r);default:le("bad ioctl syscall "+t)}}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),-e.errno}},P:function(e,t,i){xe.varargs=i;try{var s=xe.getStr(e),r=i?xe.get():0;return be.open(s,t,r).fd}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),-e.errno}},Z:function(e){var t=ye[e];delete ye[e];var i=t.elements,s=i.length,r=i.map((function(e){return e.getterReturnType})).concat(i.map((function(e){return e.setterArgumentType}))),o=t.rawConstructor,n=t.rawDestructor;Fe([e],r,(function(e){return i.forEach((function(t,i){var r=e[i],o=t.getter,n=t.getterContext,a=e[i+s],l=t.setter,h=t.setterContext;t.read=function(e){return r.fromWireType(o(n,e))},t.write=function(e,t){var i=[];l(h,e,a.toWireType(i,t)),Pe(i)}})),[{name:t.name,fromWireType:function(e){for(var t=new Array(s),r=0;r<s;++r)t[r]=i[r].read(e);return n(e),t},toWireType:function(e,r){if(s!==r.length)throw new TypeError("Incorrect number of tuple elements for "+t.name+": expected="+s+", actual="+r.length);for(var a=o(),l=0;l<s;++l)i[l].write(a,r[l]);return null!==e&&e.push(n,a),a},argPackAdvance:8,readValueFromPointer:we,destructorFunction:n}]}))},o:function(e){var t=Le[e];delete Le[e];var i=t.rawConstructor,s=t.rawDestructor,r=t.fields;Fe([e],r.map((function(e){return e.getterReturnType})).concat(r.map((function(e){return e.setterArgumentType}))),(function(e){var o={};return r.forEach((function(t,i){var s=t.fieldName,n=e[i],a=t.getter,l=t.getterContext,h=e[i+r.length],c=t.setter,u=t.setterContext;o[s]={read:function(e){return n.fromWireType(a(l,e))},write:function(e,t){var i=[];c(u,e,h.toWireType(i,t)),Pe(i)}}})),[{name:t.name,fromWireType:function(e){var t={};for(var i in o)t[i]=o[i].read(e);return s(e),t},toWireType:function(e,t){for(var r in o)if(!(r in t))throw new TypeError('Missing field:  "'+r+'"');var n=i();for(r in o)o[r].write(n,t[r]);return null!==e&&e.push(s,n),n},argPackAdvance:8,readValueFromPointer:we,destructorFunction:s}]}))},J:function(e,t,i,s,r){},W:function(e,t,i,s,r){var o=Be(i);je(e,{name:t=ke(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?s:r},argPackAdvance:8,readValueFromPointer:function(e){var s;if(1===i)s=F;else if(2===i)s=B;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);s=k}return this.fromWireType(s[e>>>o])},destructorFunction:null})},r:function(e,t,i,s,r,o,n,a,l,h,c,u,d){c=ke(c),o=wt(r,o),a&&(a=wt(n,a)),h&&(h=wt(l,h)),d=wt(u,d);var p=Ae(c);st(p,(function(){Et("Cannot construct "+c+" due to unbound types",[s])})),Fe([e,t,i],s?[s]:[],(function(t){var i,r;t=t[0],r=s?(i=t.registeredClass).instancePrototype:et.prototype;var n=De(p,(function(){if(Object.getPrototypeOf(this)!==l)throw new Oe("Use 'new' to construct "+c);if(void 0===u.constructor_body)throw new Oe(c+" has no accessible constructor");var e=u.constructor_body[arguments.length];if(void 0===e)throw new Oe("Tried to invoke ctor of "+c+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(u.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),l=Object.create(r,{constructor:{value:n}});n.prototype=l;var u=new rt(c,n,l,d,i,o,a,h),f=new xt(c,u,!0,!1,!1),m=new xt(c+"*",u,!1,!1,!1),g=new xt(c+" const*",u,!1,!0,!1);return tt[e]={pointerType:m,constPointerType:g},yt(p,n),[f,m,g]}))},q:function(e,t,i,s,r,o){M(t>0);var n=At(t,i);r=wt(s,r);var a=[o],l=[];Fe([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new Oe("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){Et("Cannot construct "+e.name+" due to unbound types",n)},Fe([],n,(function(s){return e.registeredClass.constructor_body[t-1]=function(){arguments.length!==t-1&&Ne(i+" called with "+arguments.length+" arguments, expected "+(t-1)),l.length=0,a.length=t;for(var e=1;e<t;++e)a[e]=s[e].toWireType(l,arguments[e-1]);var o=r.apply(null,a);return Pe(l),s[0].fromWireType(o)},[]})),[]}))},b:function(e,t,i,s,r,o,n,a){var l=At(i,s);t=ke(t),o=wt(r,o),Fe([],[e],(function(e){var s=(e=e[0]).name+"."+t;function r(){Et("Cannot call "+s+" due to unbound types",l)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),a&&e.registeredClass.pureVirtualFunctions.push(t);var h=e.registeredClass.instancePrototype,c=h[t];return void 0===c||void 0===c.overloadTable&&c.className!==e.name&&c.argCount===i-2?(r.argCount=i-2,r.className=e.name,h[t]=r):(it(h,t,s),h[t].overloadTable[i-2]=r),Fe([],l,(function(r){var a=Dt(s,r,e,o,n);return void 0===h[t].overloadTable?(a.argCount=i-2,h[t]=a):h[t].overloadTable[i-2]=a,[]})),[]}))},V:function(e,t){je(e,{name:t=ke(t),fromWireType:function(e){var t=St[e].value;return It(e),t},toWireType:function(e,t){return Bt(t)},argPackAdvance:8,readValueFromPointer:we,destructorFunction:null})},Y:function(e,t,i,s){var r=Be(i);function o(){}t=ke(t),o.values={},je(e,{name:t,constructor:o,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:Rt(t,r,s),destructorFunction:null}),st(t,o)},t:function(e,t,i){var s=kt(e,"enum");t=ke(t);var r=s.constructor,o=Object.create(s.constructor.prototype,{value:{value:i},constructor:{value:De(s.name+"_"+t,(function(){}))}});r.values[i]=o,r[t]=o},D:function(e,t,i){var s=Be(i);je(e,{name:t=ke(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+Ot(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Nt(t,s),destructorFunction:null})},e:function(e,t,i,s,r,o){var n=At(t,i);e=ke(e),r=wt(s,r),st(e,(function(){Et("Cannot call "+e+" due to unbound types",n)}),t-1),Fe([],n,(function(i){var s=[i[0],null].concat(i.slice(1));return yt(e,Dt(e,s,null,r,o),t-1),[]}))},n:function(e,t,i,s,r){t=ke(t),-1===r&&(r=4294967295);var o=Be(i),n=function(e){return e};if(0===s){var a=32-8*i;n=function(e){return e<<a>>>a}}var l=t.includes("unsigned");je(e,{name:t,fromWireType:n,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+Ot(i)+'" to '+this.name);if(i<s||i>r)throw new TypeError('Passing a number "'+Ot(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+s+", "+r+"]!");return l?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:jt(t,o,0!==s),destructorFunction:null})},j:function(e,t,i){var s=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=O,i=t[(e>>=2)>>>0],r=t[e+1>>>0];return new s(I,r,i)}je(e,{name:i=ke(i),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},E:function(e,t){var i="std::string"===(t=ke(t));je(e,{name:t,fromWireType:function(e){var t,s=O[e>>>2];if(i)for(var r=e+4,o=0;o<=s;++o){var n=e+4+o;if(o==s||0==L[n>>>0]){var a=A(r,n-r);void 0===t?t=a:(t+=String.fromCharCode(0),t+=a),r=n+1}}else{var l=new Array(s);for(o=0;o<s;++o)l[o]=String.fromCharCode(L[e+4+o>>>0]);t=l.join("")}return ni(e),t},toWireType:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t));var s="string"==typeof t;s||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||Ne("Cannot pass non-string to std::string");var r=(i&&s?function(){return S(t)}:function(){return t.length})(),o=oi(4+r+1);if(O[(o>>>=0)>>>2]=r,i&&s)T(t,o+4,r+1);else if(s)for(var n=0;n<r;++n){var a=t.charCodeAt(n);a>255&&(ni(o),Ne("String has UTF-16 code units that do not fit in 8 bits")),L[o+4+n>>>0]=a}else for(n=0;n<r;++n)L[o+4+n>>>0]=t[n];return null!==e&&e.push(ni,o),o},argPackAdvance:8,readValueFromPointer:we,destructorFunction:function(e){ni(e)}})},v:function(e,t,i){var s,r,o,n,a;i=ke(i),2===t?(s=U,r=G,n=W,o=function(){return R},a=1):4===t&&(s=H,r=X,n=Y,o=function(){return O},a=2),je(e,{name:i,fromWireType:function(e){for(var i,r=O[e>>>2],n=o(),l=e+4,h=0;h<=r;++h){var c=e+4+h*t;if(h==r||0==n[c>>>a]){var u=s(l,c-l);void 0===i?i=u:(i+=String.fromCharCode(0),i+=u),l=c+t}}return ni(e),i},toWireType:function(e,s){"string"!=typeof s&&Ne("Cannot pass non-string to C++ string type "+i);var o=n(s),l=oi(4+o+t);return O[(l>>>=0)>>>2]=o>>a,r(s,l+4,o+t),null!==e&&e.push(ni,l),l},argPackAdvance:8,readValueFromPointer:we,destructorFunction:function(e){ni(e)}})},_:function(e,t,i,s,r,o){ye[e]={name:ke(t),rawConstructor:wt(i,s),rawDestructor:wt(r,o),elements:[]}},g:function(e,t,i,s,r,o,n,a,l){ye[e].elements.push({getterReturnType:t,getter:wt(i,s),getterContext:r,setterArgumentType:o,setter:wt(n,a),setterContext:l})},p:function(e,t,i,s,r,o){Le[e]={name:ke(t),rawConstructor:wt(i,s),rawDestructor:wt(r,o),fields:[]}},d:function(e,t,i,s,r,o,n,a,l,h){Le[e].fields.push({fieldName:ke(t),getterReturnType:i,getter:wt(s,r),getterContext:o,setterArgumentType:n,setter:wt(a,l),setterContext:h})},X:function(e,t){je(e,{isVoid:!0,name:t=ke(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},l:function(e,t,i){e=Vt(e),t=kt(t,"emval::as");var s=[],r=Bt(s);return k[i>>>2]=r,t.toWireType(s,e)},F:function(e,t,i,s){e=Vt(e);for(var r=function(e,t){for(var i=new Array(e),s=0;s<e;++s)i[s]=kt(k[(t>>2)+s>>>0],"parameter "+s);return i}(t,i),o=new Array(t),n=0;n<t;++n){var a=r[n];o[n]=a.readValueFromPointer(s),s+=a.argPackAdvance}return Bt(e.apply(void 0,o))},a:It,H:function(e){return 0===e?Bt(Wt()):(e=Gt(e),Bt(Wt()[e]))},m:function(e,t){return Bt((e=Vt(e))[t=Vt(t)])},i:function(e){e>4&&(St[e].refcount+=1)},L:function(e,t){return(e=Vt(e))instanceof(t=Vt(t))},G:function(e){return"number"==typeof(e=Vt(e))},z:function(){return Bt([])},f:function(e){return Bt(Gt(e))},s:function(){return Bt({})},k:function(e){Pe(St[e].value),It(e)},h:function(e,t,i){e=Vt(e),t=Vt(t),i=Vt(i),e[t]=i},c:function(e,t){return Bt((e=kt(e,"_emval_take_value")).readValueFromPointer(t))},C:function(){le()},N:function(e,t){var i;if(0===e)i=Date.now();else{if(1!==e&&4!==e)return fe(28),-1;i=zt()}return k[t>>>2]=i/1e3|0,k[t+4>>>2]=i%1e3*1e3*1e3|0,0},M:function(e,t,i){L.copyWithin(e>>>0,t>>>0,t+i>>>0)},u:function(e){var t,i,s=L.length,r=4294901760;if((e>>>=0)>r)return!1;for(var o=1;o<=4;o*=2){var n=s*(1+.2/o);if(n=Math.min(n,e+100663296),Ht(Math.min(r,((t=Math.max(e,n))%(i=65536)>0&&(t+=i-t%i),t))))return!0}return!1},R:function(e,t){try{var i=0;return Yt().forEach((function(s,r){var o=t+i;k[e+4*r>>>2]=o,function(e,t,i){for(var s=0;s<e.length;++s)F[t++>>>0]=e.charCodeAt(s);i||(F[t>>>0]=0)}(s,o),i+=s.length+1})),0}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),e.errno}},S:function(e,t){try{var i=Yt();k[e>>>2]=i.length;var s=0;return i.forEach((function(e){s+=e.length+1})),k[t>>>2]=s,0}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),e.errno}},B:function(e){try{var t=xe.getStreamFromFD(e);return be.close(t),0}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),e.errno}},U:function(e,t,i,s){try{var r=xe.getStreamFromFD(e),o=xe.doReadv(r,t,i);return k[s>>>2]=o,0}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),e.errno}},I:function(e,t,i,s,r){try{var o=xe.getStreamFromFD(e),n=4294967296*i+(t>>>0),a=9007199254740992;return n<=-a||n>=a?-61:(be.llseek(o,n,s),se=[o.position>>>0,(ie=o.position,+Math.abs(ie)>=1?ie>0?(0|Math.min(+Math.floor(ie/4294967296),4294967295))>>>0:~~+Math.ceil((ie-+(~~ie>>>0))/4294967296)>>>0:0)],k[r>>>2]=se[0],k[r+4>>>2]=se[1],o.getdents&&0===n&&0===s&&(o.getdents=null),0)}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),e.errno}},T:function(e,t,i,s){try{var r=xe.getStreamFromFD(e),o=xe.doWritev(r,t,i);return k[s>>>2]=o,0}catch(e){return void 0!==be&&e instanceof be.ErrnoError||le(e),e.errno}},K:function(e){},Q:function(e,t,i,s){return Jt(e,t,i,s)}};!function(){var e={a:ri};function t(e,t){var i,s=e.exports;r.asm=s,q((y=r.asm.$).buffer),V=r.asm.ha,i=r.asm.aa,Z.unshift(i),ae()}function i(e){t(e.instance)}function o(t){return function(){if(!v&&(f||m)){if("function"==typeof fetch&&!ce(ee))return fetch(ee,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+ee+"'";return e.arrayBuffer()})).catch((function(){return ue(ee)}));if(l)return new Promise((function(e,t){l(ee,(function(t){e(new Uint8Array(t))}),t)}))}return Promise.resolve().then((function(){return ue(ee)}))}().then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){x("failed to asynchronously prepare wasm: "+e),le(e)}))}if(ne(),r.instantiateWasm)try{return r.instantiateWasm(e,t)}catch(e){return x("Module.instantiateWasm callback failed with error: "+e),!1}(v||"function"!=typeof WebAssembly.instantiateStreaming||he(ee)||ce(ee)||"function"!=typeof fetch?o(i):fetch(ee,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(i,(function(e){return x("wasm streaming compile failed: "+e),x("falling back to ArrayBuffer instantiation"),o(i)}))}))).catch(s)}(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.aa).apply(null,arguments)},r._main=function(){return(r._main=r.asm.ba).apply(null,arguments)};var oi=r._malloc=function(){return(oi=r._malloc=r.asm.ca).apply(null,arguments)},ni=r._free=function(){return(ni=r._free=r.asm.da).apply(null,arguments)},ai=r.___getTypeName=function(){return(ai=r.___getTypeName=r.asm.ea).apply(null,arguments)};r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.fa).apply(null,arguments)};var li,hi=r.___errno_location=function(){return(hi=r.___errno_location=r.asm.ga).apply(null,arguments)};function ci(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function ui(e){var t,i=r._main;try{t=i(0,0),J()||(r.onExit&&r.onExit(t),w=!0),p(t,new ci(t))}catch(e){if(e instanceof ci||"unwind"==e)return;var s=e;e&&"object"==typeof e&&e.stack&&(s=[e,e.stack]),x("exception thrown: "+s),p(1,e)}}function di(e){function i(){li||(li=!0,r.calledRun=!0,w||(r.noFSInit||be.init.initialized||be.init(),be.ignorePermissions=!1,de(Z),de(K),t(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),pi&&ui(),function(){if(r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)e=r.postRun.shift(),Q.unshift(e);var e;de(Q)}()))}re>0||(function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)e=r.preRun.shift(),$.unshift(e);var e;de($)}(),re>0||(r.setStatus?(r.setStatus("Running..."),setTimeout((function(){setTimeout((function(){r.setStatus("")}),1),i()}),1)):i()))}if(r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm.ia).apply(null,arguments)},r.dynCall_viijii=function(){return(r.dynCall_viijii=r.asm.ja).apply(null,arguments)},r.dynCall_iiiiij=function(){return(r.dynCall_iiiiij=r.asm.ka).apply(null,arguments)},r.dynCall_iiiiijj=function(){return(r.dynCall_iiiiijj=r.asm.la).apply(null,arguments)},r.dynCall_iiiiiijj=function(){return(r.dynCall_iiiiiijj=r.asm.ma).apply(null,arguments)},r.addRunDependency=ne,r.removeRunDependency=ae,r.FS_createPath=be.createPath,r.FS_createDataFile=be.createDataFile,r.FS_createPreloadedFile=be.createPreloadedFile,r.FS_createLazyFile=be.createLazyFile,r.FS_createDevice=be.createDevice,r.FS_unlink=be.unlink,r.FS=be,oe=function e(){li||di(),li||(oe=e)},r.run=di,r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();var pi=!0;return r.noInitialRun&&(pi=!1),di(),e.ready});"object"==typeof e&&"object"==typeof t?t.exports=s:"function"==typeof define&&define.amd?define([],(function(){return s})):"object"==typeof e&&(e.WebIFCWasm=s)}});"undefined"!=typeof self&&self.crossOriginIsolated?np():ap(),p.vec2(),p.vec3(),p.vec3(),p.vec3();class lp{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(2===arguments.length){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}class hp{constructor(e,t,i,s){this.bimViewer=e?e.bimViewer||e:this,this.server=e?e.server:i,this.viewer=e?e.viewer:s,this._children=[],e&&e._children.push(this),this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._enabled=null,this._active=null}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(e,t,i){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new lp),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={});let s=this._eventSubs[e];s||(s={},this._eventSubs[e]=s);const r=this._subIdMap.addItem();s[r]={callback:t,scope:i||this},this._subIdEvents[r]=e;const o=this._events[e];return void 0!==o&&t.call(i||this,o),r}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,(function(e){s.off(r),t.call(i||this,e)}),i)}log(e){e="[LOG] "+e,window.console.log(e)}warn(e){e="[WARN] "+e,window.console.warn(e)}error(e){e="[ERROR] "+e,window.console.error(e)}_mutexActivation(e){const t=e.length;for(let i=0;i<t;i++){e[i].on("active",function(){const s=i;return function(i){if(i)for(let i=0;i<t;i++)i!==s&&e[i].setActive(!1)}}())}}setEnabled(e){this._enabled!==e&&(this._enabled=e,this.fire("enabled",this._enabled))}getEnabled(){return this._enabled}setActive(e){this._active!==e&&(this._active=e,this.fire("active",this._active))}getActive(){return this._active}destroy(){if(!this.destroyed){this.fire("destroyed",this.destroyed=!0),this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0;for(let e=0,t=this._children.length;e<t;e++)this._children[e].destroy();this._children=[]}}}class cp extends hp{constructor(e,t={}){super(e,t);const i=t.busyModalBackdropElement||document.body;if(!i)throw"Missing config: busyModalBackdropElement";this._modal=document.createElement("div"),this._modal.classList.add("xeokit-busy-modal"),this._modal.innerHTML='<div class="xeokit-busy-modal-content"><div class="xeokit-busy-modal-body"><div class="xeokit-busy-modal-message">Default text</div></div></div>',i.appendChild(this._modal),this._modalVisible=!1,this._modal.style.display="hidden"}show(e){this._modalVisible=!0,this._modal.querySelector(".xeokit-busy-modal-message").innerText=e,this._modal.style.display="block"}hide(){this._modalVisible=!1,this._modal.style.display="none"}destroy(){super.destroy(),this._modal&&(this._modal.parentNode.removeChild(this._modal),this._modal=null)}}const up=p.vec3();class dp extends hp{constructor(e,t={}){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";const i=t.buttonElement,s=this.viewer.camera;this._modelMementos={},s.eye=[.577,.577,.577],s.look=[0,0,0],s.up=[-1,1,-1],this.bimViewer._modelsExplorer.on("modelLoaded",(e=>{this._saveModelMemento(e)})),this.bimViewer._modelsExplorer.on("modelUnloaded",(e=>{this._destroyModelMemento(e)})),this.on("enabled",(e=>{e?i.classList.remove("disabled"):i.classList.add("disabled")})),this.on("active",(e=>{e?i.classList.add("active"):i.classList.remove("active")})),i.addEventListener("click",(e=>{this.getEnabled()&&this.reset(),e.preventDefault()}))}_saveModelMemento(e){const t=this.viewer.metaScene.metaModels[e];if(!t)return;const i=new Ho;i.saveObjects(this.viewer.scene,t,{visible:!0,edges:!0,xrayed:!0,highlighted:!0,selected:!0,clippable:!0,pickable:!0,colorize:!1,opacity:!1}),this._modelMementos[e]=i}_restoreModelMemento(e){const t=this.viewer.metaScene.metaModels[e];if(!t)return;this._modelMementos[e].restoreObjects(this.viewer.scene,t)}_destroyModelMemento(e){delete this._modelMementos[e]}reset(){const e=this.viewer.scene.modelIds;for(var t=0,i=e.length;t<i;t++){const i=e[t];this._restoreModelMemento(i)}this.bimViewer.unShowObjectInExplorers(),this.fire("reset",!0),this._resetCamera()}_resetCamera(){const e=this.viewer,t=e.scene,i=t.getAABB(t.visibleObjectIds),s=p.getAABB3Diag(i),r=p.getAABB3Center(i,up),o=t.camera;o.perspective.fov;const n=Math.abs(s/Math.tan(45*p.DEGTORAD)),a=p.normalizeVec3(o.yUp?[-.5,-.7071,-.5]:[-1,1,-1]),l=p.normalizeVec3(o.yUp?[-.5,.7071,-.5]:[-1,1,1]);e.cameraControl.pivotPos=r,e.cameraControl.planView=!1,e.cameraFlight.flyTo({look:r,eye:[r[0]-n*a[0],r[1]-n*a[1],r[2]-n*a[2]],up:l,orthoScale:1.3*s,projection:"perspective",duration:1})}}const pp=p.vec3();class fp extends hp{constructor(e,t={}){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";const i=t.buttonElement;this.on("enabled",(e=>{e?i.classList.remove("disabled"):i.classList.add("disabled")})),this.on("active",(e=>{e?i.classList.add("active"):i.classList.remove("active")})),i.addEventListener("click",(e=>{this.getEnabled()&&this.fit(),e.preventDefault()}))}fit(){const e=this.viewer.scene,t=e.getAABB(e.visibleObjectIds);this.viewer.cameraFlight.flyTo({aabb:t}),this.viewer.cameraControl.pivotPos=p.getAABB3Center(t,pp)}set fov(e){this.viewer.scene.cameraFlight.fitFOV=e}get fov(){return this.viewer.scene.cameraFlight.fitFOV}set duration(e){this.viewer.scene.cameraFlight.duration=e}get duration(){return this.viewer.scene.cameraFlight.duration}}class mp extends hp{constructor(e,t){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";const i=t.buttonElement,s=this.viewer.cameraControl,r=t.cameraControlNavModeMediator;s.navMode="orbit",s.followPointer=!0,this.on("enabled",(e=>{e?i.classList.remove("disabled"):i.classList.add("disabled")})),this.on("active",(e=>{e?i.classList.add("active"):i.classList.remove("active")})),this.on("active",(e=>{r.setFirstPersonModeActive(e),e?(s.followPointer=!0,s.pivoting=!1):s.pivoting=!0})),i.addEventListener("click",(e=>{if(this.getEnabled()){const e=this.getActive();this.setActive(!e)}e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!1)}))}}class gp extends hp{constructor(e,t){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";const i=t.buttonElement;this.on("enabled",(e=>{e?i.classList.remove("disabled"):i.classList.add("disabled")})),this.on("active",(e=>{e?(i.classList.add("active"),this.viewer.cameraControl.doublePickFlyTo=!1,this._onPick=this.viewer.cameraControl.on("picked",(e=>{e.entity&&(e.entity.visible=!1)}))):(i.classList.remove("active"),this.viewer.cameraControl.doublePickFlyTo=!1,void 0!==this._onPick&&(this.viewer.cameraControl.off(this._onPick),this._onPick=void 0))})),i.addEventListener("click",(e=>{if(this.getEnabled()){this.bimViewer._sectionTool.hideControl();const e=this.getActive();this.setActive(!e)}e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!1)}))}}class _p extends hp{constructor(e,t){if(super(e),!t.buttonElement)throw"Missing config: buttonElement";const i=t.buttonElement;this.on("enabled",(e=>{e?i.classList.remove("disabled"):i.classList.add("disabled")})),this.on("active",(e=>{e?(i.classList.add("active"),this._onPick=this.viewer.cameraControl.on("picked",(e=>{e.entity&&(e.entity.selected=!e.entity.selected)}))):(i.classList.remove("active"),void 0!==this._onPick&&(this.viewer.cameraControl.off(this._onPick),this._onPick=void 0))})),i.addEventListener("click",(e=>{if(this.getEnabled()){this.bimViewer._sectionTool.hideControl();const e=this.getActive();this.setActive(!e)}e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!1)}))}}class vp extends hp{constructor(e,t){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";this._buttonElement=t.buttonElement,this.on("enabled",(e=>{e?this._buttonElement.classList.remove("disabled"):this._buttonElement.classList.add("disabled")})),this._buttonElement.addEventListener("click",(e=>{this.getEnabled()&&this.setActive(!this.getActive(),(()=>{})),e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!1)})),this.viewer.scene.on("modelLoaded",(e=>{if(!this._active){const e=this.viewer.metaScene.getObjectIDsByType("IfcSpace");this.viewer.scene.setObjectsCulled(e,!0)}})),this._active=!1,this._buttonElement.classList.remove("active")}setActive(e){this._active!==e&&(this._active=e,e?(this._buttonElement.classList.add("active"),this._enterShowSpacesMode(),this.fire("active",this._active)):(this._buttonElement.classList.remove("active"),this._exitShowSpacesMode(),this.fire("active",this._active)))}_enterShowSpacesMode(){const e=this.viewer,t=e.scene,i=e.metaScene.getObjectIDsByType("IfcSpace");t.setObjectsCulled(i,!1)}_exitShowSpacesMode(){const e=this.viewer,t=e.scene,i=e.metaScene.getObjectIDsByType("IfcSpace");t.setObjectsCulled(i,!0)}}class bp extends hp{constructor(e,t){super(e)}}const xp=p.AABB3(),yp=p.vec3();class Pp extends n{constructor(e={}){if(!e.sectionPlanesPlugin)throw"Missing config: sectionPlanesPlugin";super(v.apply({},e)),this._sectionPlanesPlugin=e.sectionPlanesPlugin,this._viewer=this._sectionPlanesPlugin.viewer,this._onSceneSectionPlaneCreated=this._viewer.scene.on("sectionPlaneCreated",(()=>{this._buildMenu()})),this._onSceneSectionPlaneDestroyed=this._viewer.scene.on("sectionPlaneDestroyed",(()=>{this._buildMenu()})),this._buildMenu()}_buildMenu(){const e=this._sectionPlanesPlugin,t=Object.values(e.sectionPlanes),i=[];for(let s=0,r=t.length;s<r;s++){const r=t[s];i.push({getTitle:e=>`${e.viewer.localeService.translate("sectionToolContextMenu.slice")||"Slice"} #`+(s+1),doHoverEnter(t){e.hideControl(),e.showControl(r.id)},doHoverLeave(t){e.hideControl()},items:[[{getTitle:e=>e.viewer.localeService.translate("sectionToolContextMenu.edit")||"Edit",doAction:t=>{e.hideControl(),e.showControl(r.id);const i=r.pos;xp.set(this._viewer.scene.aabb),p.getAABB3Center(xp,yp),xp[0]+=i[0]-yp[0],xp[1]+=i[1]-yp[1],xp[2]+=i[2]-yp[2],xp[3]+=i[0]-yp[0],xp[4]+=i[1]-yp[1],xp[5]+=i[2]-yp[2],this._viewer.cameraFlight.flyTo({aabb:xp,fitFOV:65})}},{getTitle:e=>e.viewer.localeService.translate("sectionToolContextMenu.flip")||"Flip",doAction:e=>{r.flipDir()}},{getTitle:e=>e.viewer.localeService.translate("sectionToolContextMenu.delete")||"Delete",doAction:e=>{r.destroy()}}]]})}this.items=[[{getTitle:e=>e.viewer.localeService.translate("sectionToolContextMenu.clearSlices")||"Clear Slices",getEnabled:e=>e.bimViewer.getNumSections()>0,doAction:e=>{e.bimViewer.clearSections()}},{getTitle:e=>e.viewer.localeService.translate("sectionToolContextMenu.flipSlices")||"Flip Slices",getEnabled:e=>e.bimViewer.getNumSections()>0,doAction:e=>{e.bimViewer.flipSections()}}],i]}destroy(){super.destroy();const e=this._viewer.scene;e.off(this._onSceneSectionPlaneCreated),e.off(this._onSceneSectionPlaneDestroyed)}}class wp extends hp{constructor(e,t){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";if(!t.menuButtonElement)throw"Missing config: menuButtonElement";this._buttonElement=t.buttonElement,this._counterElement=t.counterElement,this._menuButtonElement=t.menuButtonElement,this._menuButtonArrowElement=t.menuButtonArrowElement,this._sectionPlanesPlugin=new ud(this.viewer,{}),this._sectionToolContextMenu=new Pp({sectionPlanesPlugin:this._sectionPlanesPlugin,hideOnMouseDown:!1}),this._sectionPlanesPlugin.setOverviewVisible(!1),this.on("enabled",(e=>{e?(this._buttonElement.classList.remove("disabled"),this._counterElement&&this._counterElement.classList.remove("disabled"),this._menuButtonElement.classList.remove("disabled"),this._menuButtonArrowElement.classList.remove("disabled")):(this._buttonElement.classList.add("disabled"),this._counterElement&&this._counterElement.classList.add("disabled"),this._menuButtonElement.classList.add("disabled"),this._menuButtonArrowElement.classList.add("disabled"))})),this.on("active",(e=>{e?(this._buttonElement.classList.add("active"),this._counterElement&&this._counterElement.classList.add("active"),this._menuButtonElement.classList.add("active"),this._menuButtonArrowElement.classList.add("active")):(this._buttonElement.classList.remove("active"),this._counterElement&&this._counterElement.classList.remove("active"),this._menuButtonElement.classList.remove("active"),this._menuButtonArrowElement.classList.remove("active"))})),this.on("active",(e=>{e||this._sectionPlanesPlugin.hideControl()})),this._buttonElement.addEventListener("click",(e=>{if(!this.getEnabled())return;if(e.target===this._menuButtonElement||e.target.parentNode===this._menuButtonElement)return;const t=this.getActive();this.setActive(!t),e.preventDefault()})),document.addEventListener("mousedown",(e=>{if(!e.target.classList.contains("xeokit-context-menu-item"))if(e.target===this._menuButtonElement||e.target.parentNode===this._menuButtonElement)if(e.preventDefault(),this._sectionToolContextMenu.shown)this._sectionToolContextMenu.hide();else{this._sectionToolContextMenu.context={bimViewer:this.bimViewer,viewer:this.viewer,sectionTool:this};const e=this._menuButtonElement.getBoundingClientRect();this._sectionToolContextMenu.show(e.left,e.bottom+5)}else this._sectionToolContextMenu.hide()})),this._sectionToolContextMenu.on("shown",(()=>{this._menuButtonArrowElement.classList.remove("xeokit-arrow-down"),this._menuButtonArrowElement.classList.add("xeokit-arrow-up")})),this._sectionToolContextMenu.on("hidden",(()=>{this._menuButtonArrowElement.classList.remove("xeokit-arrow-up"),this._menuButtonArrowElement.classList.add("xeokit-arrow-down")})),this.bimViewer.on("reset",(()=>{this.clear(),this.setActive(!1)})),this.viewer.scene.on("sectionPlaneCreated",(()=>{this._updateSectionPlanesCount()})),this.viewer.scene.on("sectionPlaneDestroyed",(()=>{this._updateSectionPlanesCount()})),this._initSectionMode()}_initSectionMode(){this.viewer.scene.input.on("mouseclicked",(e=>{if(!this.getActive()||!this.getEnabled())return;const t=this.viewer.scene.pick({canvasPos:e,pickSurface:!0});if(t){const e=this._sectionPlanesPlugin.createSectionPlane({pos:t.worldPos,dir:p.mulVec3Scalar(t.worldNormal,-1)});this._sectionPlanesPlugin.showControl(e.id)}})),this._updateSectionPlanesCount()}_updateSectionPlanesCount(){this._counterElement&&(this._counterElement.innerText=""+this.getNumSections())}getNumSections(){return Object.keys(this.viewer.scene.sectionPlanes).length}clear(){this._sectionPlanesPlugin.clear(),this._updateSectionPlanesCount()}flipSections(){this._sectionPlanesPlugin.flipSectionPlanes()}hideControl(){this._sectionPlanesPlugin.hideControl()}destroy(){this._sectionPlanesPlugin.destroy(),this._sectionToolContextMenu.destroy(),super.destroy()}}class Mp extends hp{constructor(e,t){if(super(e,t),!t.navCubeCanvasElement)throw"Missing config: navCubeCanvasElement";const i=t.navCubeCanvasElement;this._navCube=new sd(this.viewer,{canvasElement:i,fitVisible:!0,color:"#CFCFCF"}),this._navCube.setVisible(this._active),this.on("active",(e=>{this._navCube.setVisible(e)}))}destroy(){this._navCube.destroy(),super.destroy()}}const Cp={IfcSpace:{opacity:.3},IfcWindow:{opacity:.4},IfcOpeningElement:{opacity:.3},IfcPlate:{opacity:.3}},Ep={IfcRoof:{colorize:[.837255,.203922,.270588],priority:0},IfcSlab:{colorize:[.637255,.603922,.670588],priority:0},IfcWall:{colorize:[.537255,.337255,.237255],priority:0},IfcWallStandardCase:{colorize:[.537255,.337255,.237255],priority:0},IfcCovering:{colorize:[.8470588235,.427450980392,0],priority:0},IfcDoor:{colorize:[.637255,.603922,.670588],priority:1},IfcStair:{colorize:[.637255,.603922,.670588],priority:2},IfcStairFlight:{colorize:[.637255,.603922,.670588],priority:2},IfcProxy:{colorize:[.137255,.403922,.870588],priority:2},IfcRamp:{colorize:[.8470588235,.427450980392,0],priority:2},IfcColumn:{colorize:[.137255,.403922,.870588],priority:3},IfcBeam:{colorize:[.137255,.403922,.870588],priority:3},IfcCurtainWall:{colorize:[.137255,.403922,.870588],priority:3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.5,priority:3},IfcTransportElement:{colorize:[.8470588235,.427450980392,0],priority:3},IfcFooting:{colorize:[.8470588235,.427450980392,0],priority:3},IfcRailing:{colorize:[.137255,.403922,.870588],priority:4},IfcFurnishingElement:{colorize:[.137255,.403922,.870588],priority:4},IfcFurniture:{colorize:[.8470588235,.427450980392,0],priority:4},IfcSystemFurnitureElement:{colorize:[.8470588235,.427450980392,0],priority:4},IfcFlowSegment:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowitting:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowTerminal:{colorize:[.137255,.403922,.870588],priority:5},IfcFlowController:{colorize:[.8470588235,.427450980392,0],priority:5},IfcFlowFitting:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDuctSegment:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDistributionFlowElement:{colorize:[.8470588235,.427450980392,0],priority:5},IfcDuctFitting:{colorize:[.8470588235,.427450980392,0],priority:5},IfcLightFixture:{colorize:[.8470588235,.8470588235,.870588],priority:5},IfcAirTerminal:{colorize:[.8470588235,.427450980392,0],priority:6},IfcOpeningElement:{colorize:[.137255,.403922,.870588],opacity:.3,priority:6},IfcSpace:{opacity:.5},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.4,priority:6},IfcBuildingElementProxy:{colorize:[.5,.5,.5]},IfcSite:{colorize:[.137255,.403922,.870588]},IfcMember:{colorize:[.8470588235,.427450980392,0]},DEFAULT:{colorize:[.5,.5,.5],priority:10}};class Ap extends n{constructor(e={}){const t=[[{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.loadModel")||"Load",getEnabled:e=>!e.bimViewer.isModelLoaded(e.modelId),doAction:e=>{e.bimViewer.loadModel(e.modelId)}},{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.unloadModel")||"Unload",getEnabled:e=>e.bimViewer.isModelLoaded(e.modelId),doAction:e=>{e.bimViewer.unloadModel(e.modelId)}}]];!!e.enableEditModels&&t.push([{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.editModel")||"Edit",getEnabled:e=>!0,doAction:e=>{e.bimViewer.editModel(e.modelId)}},{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.deleteModel")||"Delete",getEnabled:e=>!0,doAction:e=>{e.bimViewer.deleteModel(e.modelId)}}]),t.push([{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.loadAllModels")||"Load All",getEnabled:e=>{const t=e.bimViewer,i=t.getModelIds();return t.getLoadedModelIds().length<i.length},doAction:e=>{e.bimViewer.loadAllModels()}},{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.unloadAllModels")||"Unload All",getEnabled:e=>e.bimViewer.getLoadedModelIds().length>0,doAction:e=>{e.bimViewer.unloadAllModels()}}]),t.push([{getTitle:e=>e.viewer.localeService.translate("modelsContextMenu.clearSlices")||"Clear Slices",getEnabled:e=>e.bimViewer.getNumSections()>0,doAction:e=>{e.bimViewer.clearSections()}}]),super({context:e.context,items:t})}}const Dp=p.vec3();class Tp extends hp{constructor(e,t){if(super(e,t),!t.modelsTabElement)throw"Missing config: modelsTabElement";if(!t.unloadModelsButtonElement)throw"Missing config: unloadModelsButtonElement";if(!t.modelsElement)throw"Missing config: modelsElement";if(this._enableAddModels=!!t.enableEditModels,this._modelsTabElement=t.modelsTabElement,this._loadModelsButtonElement=t.loadModelsButtonElement,this._unloadModelsButtonElement=t.unloadModelsButtonElement,this._addModelButtonElement=t.addModelButtonElement,this._modelsElement=t.modelsElement,this._modelsTabButtonElement=this._modelsTabElement.querySelector(".xeokit-tab-btn"),!this._modelsTabButtonElement)throw"Missing DOM element: ,xeokit-tab-btn";this._xktLoader=new tp(this.viewer,{objectDefaults:Cp}),this._modelsContextMenu=new Ap({enableEditModels:t.enableEditModels}),this._modelsInfo={},this._numModels=0,this._numModelsLoaded=0,this._projectId=null}loadProject(e,t,i){this.server.getProject(e,(i=>{this.unloadProject(),this._projectId=e,this._modelsInfo={},this._numModels=0,this._parseProject(i,t),this._numModelsLoaded<this._numModels&&this._loadModelsButtonElement.classList.remove("disabled"),this._numModelsLoaded>0&&this._unloadModelsButtonElement.classList.remove("disabled"),this._enableAddModels&&this._addModelButtonElement.classList.remove("disabled")}),(e=>{this.error(e),i&&i(e)}))}_parseProject(e,t){this._buildModelsMenu(e),this._parseViewerConfigs(e),this._parseViewerContent(e,(()=>{this._parseViewerState(e,(()=>{t()}))}))}_buildModelsMenu(e){var t="";const i=e.models||[];this._modelsInfo={},this._numModels=i.length;for(let e=0,s=i.length;e<s;e++){const s=i[e];this._modelsInfo[s.id]=s,t+="<div class='xeokit-form-check'>",t+="<input id='"+s.id+"' type='checkbox' value=''><span id='span-"+s.id+"' class='disabled'>"+s.name+"</span>",t+="</div>"}this._modelsElement.innerHTML=t;for(let e=0,t=i.length;e<t;e++){const t=i[e],s=t.id,r=document.getElementById(""+s),o=document.getElementById("span-"+s);r.addEventListener("click",(()=>{r.checked?this.loadModel(s):this.unloadModel(t.id)})),o.addEventListener("click",(()=>{!!this.viewer.scene.models[s]?this.unloadModel(t.id):this.loadModel(s)})),o.oncontextmenu=e=>{this._modelsContextMenu.context={bimViewer:this.bimViewer,viewer:this.viewer,modelId:s},this._modelsContextMenu.show(e.pageX,e.pageY),e.preventDefault()}}}_parseViewerConfigs(e){const t=e.viewerConfigs;t&&this.bimViewer.setConfigs(t)}_parseViewerContent(e,t){const i=e.viewerContent;i?this._parseModelsLoaded(i,(()=>{t()})):t()}_parseModelsLoaded(e,t){const i=e.modelsLoaded;i&&0!==i.length?this._loadNextModel(i.slice(0),t):t()}_loadNextModel(e,t){if(0===e.length)return void t();const i=e.pop();this.loadModel(i,(()=>{this._loadNextModel(e,t)}),(()=>{this._loadNextModel(e,t)}))}_parseViewerState(e,t){const i=e.viewerState;i?this.bimViewer.setViewerState(i,t):t()}unloadProject(){if(!this._projectId)return;const e=this.viewer.scene.models;for(var t in e)if(e.hasOwnProperty(t)){e[t].destroy()}this._modelsElement.innerHTML="",this._numModelsLoaded=0,this._loadModelsButtonElement.classList.add("disabled"),this._unloadModelsButtonElement.classList.add("disabled"),this._enableAddModels&&this._addModelButtonElement.classList.add("disabled");const i=this._projectId;this._projectId=null,this.fire("projectUnloaded",{projectId:i})}getLoadedProjectId(){return this._projectId}getModelIds(){return Object.keys(this._modelsInfo)}loadModel(e,t,i){if(!this._projectId){const e="No project currently loaded";return this.error(e),void(i&&i(e))}const s=this._modelsInfo[e];if(!s){const e="Model not in currently loaded project";return this.error(e),void(i&&i(e))}this.bimViewer._busyModal.show(`${this.viewer.localeService.translate("busyModal.loading")||"Loading"} ${s.name}`);this.bimViewer.getConfig("externalMetadata")?this.server.getMetadata(this._projectId,e,(r=>{this._loadGeometry(e,s,r,t,i)}),(e=>{this.bimViewer._busyModal.hide(),this.error(e),i&&i(e)})):this._loadGeometry(e,s,null,t,i)}_loadGeometry(e,t,i,s,r){this.server.getGeometry(this._projectId,e,(r=>{const o="model"===(t.objectColorSource||this.bimViewer.getObjectColorSource())?Cp:Ep;this._xktLoader.load({id:e,metaModelData:i,xkt:r,objectDefaults:o,excludeUnclassifiedObjects:!0,origin:t.origin||t.position,scale:t.scale,rotation:t.rotation,matrix:t.matrix,edges:!1!==t.edges,saoEnabled:t.saoEnabled,pbrEnabled:t.pbrEnabled,backfaces:t.backfaces,globalizeObjectIds:t.globalizeObjectIds,reuseGeometries:!1!==t.reuseGeometries,useDataTextures:t.useDataTextures}).on("loaded",(()=>{document.getElementById(""+e).checked=!0,this.viewer.scene,this._numModelsLoaded++,this._unloadModelsButtonElement.classList.remove("disabled"),this._numModelsLoaded<this._numModels?this._loadModelsButtonElement.classList.remove("disabled"):this._loadModelsButtonElement.classList.add("disabled"),1===this._numModelsLoaded?(this._jumpToInitialCamera(),this.fire("modelLoaded",e),this.bimViewer._busyModal.hide(),s&&s()):(this.fire("modelLoaded",e),this.bimViewer._busyModal.hide(),s&&s())}))}),(e=>{this.bimViewer._busyModal.hide(),this.error(e),r&&r(e)}))}_jumpToInitialCamera(){const e=this.viewer,t=e.scene,i=t.getAABB(t.visibleObjectIds),s=p.getAABB3Diag(i),r=p.getAABB3Center(i,Dp),o=t.camera;o.perspective.fov;const n=Math.abs(s/Math.tan(45*p.DEGTORAD)),a=p.normalizeVec3(o.yUp?[-.5,-.7071,-.5]:[-1,1,-1]),l=p.normalizeVec3(o.yUp?[-.5,.7071,-.5]:[-1,1,1]);e.cameraControl.pivotPos=r,e.cameraControl.planView=!1,e.cameraFlight.jumpTo({look:r,eye:[r[0]-n*a[0],r[1]-n*a[1],r[2]-n*a[2]],up:l,orthoScale:1.1*s})}unloadModel(e){const t=this.viewer.scene.models[e];if(!t)return void this.error("Model not loaded: "+e);t.destroy();document.getElementById(""+e).checked=!1,document.getElementById("span-"+e),this._numModelsLoaded--,this._numModelsLoaded>0?this._unloadModelsButtonElement.classList.remove("disabled"):this._unloadModelsButtonElement.classList.add("disabled"),this._numModelsLoaded<this._numModels?this._loadModelsButtonElement.classList.remove("disabled"):this._loadModelsButtonElement.classList.add("disabled"),this.fire("modelUnloaded",e)}unloadAllModels(){const e=this.viewer.scene.models,t=Object.keys(e);for(var i=0,s=t.length;i<s;i++){const e=t[i];this.unloadModel(e)}}getNumModelsLoaded(){return this._numModelsLoaded}_getLoadedModelIds(){return Object.keys(this.viewer.scene.models)}isModelLoaded(e){return!!this.viewer.scene.models[e]}getModelsInfo(){return this._modelsInfo}getModelInfo(e){return this._modelsInfo[e]}setEnabled(e){e?(this._modelsTabButtonElement.classList.remove("disabled"),this._unloadModelsButtonElement.classList.remove("disabled")):(this._modelsTabButtonElement.classList.add("disabled"),this._unloadModelsButtonElement.classList.add("disabled"))}destroy(){super.destroy(),this._xktLoader.destroy()}}const Sp=p.vec3();class Ip extends n{constructor(e){super(),this._bimViewer=e,this._buildMenu()}_buildMenu(){const e=[],t=[];this._bimViewer._enablePropertiesInspector&&e.push({getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.inspectProperties")||"Inspect Properties",getShown:e=>!!e.viewer.metaScene.metaObjects[e.treeViewNode.objectId],doAction:e=>{const t=e.treeViewNode.objectId;e.bimViewer.showObjectProperties(t)}}),t.push({getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.viewFit")||"View Fit",doAction:function(e){const t=e.viewer,i=t.scene,s=[];e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{e.objectId&&s.push(e.objectId)})),i.setObjectsVisible(s,!0),i.setObjectsHighlighted(s,!0);const r=i.getAABB(s);t.cameraFlight.flyTo({aabb:r,duration:.5},(()=>{setTimeout((function(){i.setObjectsHighlighted(i.highlightedObjectIds,!1)}),500)})),t.cameraControl.pivotPos=p.getAABB3Center(r)}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.viewFitAll")||"View Fit All",doAction:function(e){const t=e.viewer,i=t.scene,s=i.getAABB(i.visibleObjectIds);t.cameraFlight.flyTo({aabb:s,duration:.5}),t.cameraControl.pivotPos=p.getAABB3Center(s)}}),this.items=[e,t,[{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.isolate")||"Isolate",doAction:function(e){const t=e.viewer,i=t.scene,s=[];e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{e.objectId&&s.push(e.objectId)}));const r=i.getAABB(s);t.cameraControl.pivotPos=p.getAABB3Center(r,Sp),i.setObjectsXRayed(i.xrayedObjectIds,!1),i.setObjectsVisible(i.visibleObjectIds,!1),i.setObjectsSelected(i.selectedObjectIds,!1),i.setObjectsVisible(s,!0),t.cameraFlight.flyTo({aabb:r},(()=>{}))}}],[{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.hide")||"Hide",doAction:function(e){e.treeViewPlugin.withNodeTree(e.treeViewNode,(t=>{if(t.objectId){const i=e.viewer.scene.objects[t.objectId];i&&(i.visible=!1)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.hideOthers")||"Hide Others",doAction:function(e){const t=e.viewer.scene;t.setObjectsVisible(t.visibleObjectIds,!1),t.setObjectsPickable(t.xrayedObjectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1),e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{if(e.objectId){const i=t.objects[e.objectId];i&&(i.visible=!0)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.hideAll")||"Hide All",getEnabled:function(e){return e.viewer.scene.visibleObjectIds.length>0},doAction:function(e){e.viewer.scene.setObjectsVisible(e.viewer.scene.visibleObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.show")||"Show",doAction:function(e){e.treeViewPlugin.withNodeTree(e.treeViewNode,(t=>{if(t.objectId){const i=e.viewer.scene.objects[t.objectId];i&&(i.visible=!0,i.xrayed&&(i.pickable=!0),i.xrayed=!1,i.selected=!1)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.showOthers")||"Shows Others",doAction:function(e){const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsPickable(t.xrayedObjectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1),e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{if(e.objectId){const i=t.objects[e.objectId];i&&(i.visible=!1)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.showAll")||"Show All",getEnabled:function(e){const t=e.viewer.scene;return t.numVisibleObjects<t.numObjects||e.viewer.scene.numXRayedObjects>0},doAction:function(e){const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsPickable(t.xrayedObjectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.xray")||"X-Ray",doAction:function(e){e.treeViewPlugin.withNodeTree(e.treeViewNode,(t=>{if(t.objectId){const i=e.viewer.scene.objects[t.objectId];i&&(i.selected=!1,i.xrayed=!0,i.visible=!0,i.pickable=e.bimViewer.getConfig("xrayPickable"))}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.undoXray")||"Undo X-Ray",doAction:function(e){e.treeViewPlugin.withNodeTree(e.treeViewNode,(t=>{if(t.objectId){const i=e.viewer.scene.objects[t.objectId];i&&(i.xrayed=!1,i.pickable=!0)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.xrayOthers")||"X-Ray Others",doAction:function(e){const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),e.bimViewer.getConfig("xrayPickable")||t.setObjectsPickable(t.objectIds,!1),t.setObjectsXRayed(t.objectIds,!0),t.setObjectsSelected(t.selectedObjectIds,!1),e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{if(e.objectId){const i=t.objects[e.objectId];i&&(i.xrayed=!1,i.pickable=!0)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.xrayAll")||"X-Ray All",doAction:function(e){const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsXRayed(t.objectIds,!0),t.setObjectsSelected(t.selectedObjectIds,!1),t.setObjectsPickable(t.objectIds,!1)}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.xrayNone")||"X-Ray None",getEnabled:function(e){return e.viewer.scene.numXRayedObjects>0},doAction:function(e){const t=e.viewer.scene,i=t.xrayedObjectIds;t.setObjectsPickable(i,!0),t.setObjectsXRayed(i,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.select")||"Select",doAction:function(e){e.treeViewPlugin.withNodeTree(e.treeViewNode,(t=>{if(t.objectId){const i=e.viewer.scene.objects[t.objectId];i&&(i.selected=!0,i.visible=!0)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.undoSelect")||"Undo Select",doAction:function(e){e.treeViewPlugin.withNodeTree(e.treeViewNode,(t=>{if(t.objectId){const i=e.viewer.scene.objects[t.objectId];i&&(i.selected=!1)}}))}},{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.selectNone")||"Select None",getEnabled:function(e){return e.viewer.scene.numSelectedObjects>0},doAction:function(e){e.viewer.scene.setObjectsSelected(e.viewer.scene.selectedObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("treeViewContextMenu.clearSlices")||"Clear Slices",getEnabled:function(e){return e.bimViewer.getNumSections()>0},doAction:function(e){e.bimViewer.clearSections()}}]]}}class Fp extends hp{constructor(e,t={}){if(super(e),!t.objectsTabElement)throw"Missing config: objectsTabElement";if(!t.showAllObjectsButtonElement)throw"Missing config: showAllObjectsButtonElement";if(!t.hideAllObjectsButtonElement)throw"Missing config: hideAllObjectsButtonElement";if(!t.objectsElement)throw"Missing config: objectsElement";if(this._objectsTabElement=t.objectsTabElement,this._showAllObjectsButtonElement=t.showAllObjectsButtonElement,this._hideAllObjectsButtonElement=t.hideAllObjectsButtonElement,this._objectsTabButtonElement=this._objectsTabElement.querySelector(".xeokit-tab-btn"),!this._objectsTabButtonElement)throw"Missing DOM element: ,xeokit-tab-btn";const i=t.objectsElement;this._treeView=new pd(this.viewer,{containerElement:i,hierarchy:"containment",autoAddModels:!1,pruneEmptyNodes:!0}),this._treeViewContextMenu=new Ip(this.bimViewer),this._treeView.on("contextmenu",(e=>{this._treeViewContextMenu.context={bimViewer:this.bimViewer,viewer:e.viewer,treeViewPlugin:e.treeViewPlugin,treeViewNode:e.treeViewNode},this._treeViewContextMenu.show(e.event.pageX,e.event.pageY)})),this._treeView.on("nodeTitleClicked",(e=>{const t=this.viewer.scene,i=[];e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{e.objectId&&i.push(e.objectId)}));e.treeViewNode.checked?(t.setObjectsXRayed(i,!1),t.setObjectsVisible(i,!1),t.setObjectsPickable(i,!0)):(t.setObjectsXRayed(i,!1),t.setObjectsVisible(i,!0),t.setObjectsPickable(i,!0))})),this._onModelLoaded=this.viewer.scene.on("modelLoaded",(e=>{if(this.viewer.metaScene.metaModels[e]){const t=this.bimViewer._modelsExplorer.getModelInfo(e);if(!t)return;this._treeView.addModel(e,{rootName:t.name})}})),this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(e=>{this.viewer.metaScene.metaModels[e]&&this._treeView.removeModel(e)})),this.bimViewer.on("reset",(()=>{this._treeView.collapse()}))}setEnabled(e){e?(this._objectsTabButtonElement.classList.remove("disabled"),this._showAllObjectsButtonElement.classList.remove("disabled"),this._hideAllObjectsButtonElement.classList.remove("disabled")):(this._objectsTabButtonElement.classList.add("disabled"),this._showAllObjectsButtonElement.classList.add("disabled"),this._hideAllObjectsButtonElement.classList.add("disabled"))}expandTreeViewToDepth(e){this._treeView.expandToDepth(e)}showNodeInTreeView(e){this._treeView.collapse(),this._treeView.showNode(e)}unShowNodeInTreeView(){this._treeView.unShowNode()}destroy(){super.destroy(),this._treeView.destroy(),this._treeViewContextMenu.destroy(),this.viewer.scene.off(this._onModelLoaded),this.viewer.scene.off(this._onModelUnloaded)}}class Lp extends hp{constructor(e,t={}){if(super(e),!t.classesTabElement)throw"Missing config: classesTabElement";if(!t.showAllClassesButtonElement)throw"Missing config: showAllClassesButtonElement";if(!t.hideAllClassesButtonElement)throw"Missing config: hideAllClassesButtonElement";if(!t.classesElement)throw"Missing config: classesElement";if(this._classesTabElement=t.classesTabElement,this._showAllClassesButtonElement=t.showAllClassesButtonElement,this._hideAllClassesButtonElement=t.hideAllClassesButtonElement,this._classesTabButtonElement=this._classesTabElement.querySelector(".xeokit-tab-btn"),!this._classesTabButtonElement)throw"Missing DOM element: xeokit-tab-btn";const i=t.classesElement;this._treeView=new pd(this.viewer,{containerElement:i,hierarchy:"types",autoAddModels:!1,pruneEmptyNodes:!0}),this._treeViewContextMenu=new Ip(this.bimViewer),this._treeView.on("contextmenu",(e=>{this._treeViewContextMenu.context={bimViewer:this.bimViewer,viewer:e.viewer,treeViewPlugin:e.treeViewPlugin,treeViewNode:e.treeViewNode},this._treeViewContextMenu.show(e.event.pageX,e.event.pageY)})),this._treeView.on("nodeTitleClicked",(e=>{const t=this.viewer.scene,i=[];e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{e.objectId&&i.push(e.objectId)}));e.treeViewNode.checked?(t.setObjectsXRayed(i,!1),t.setObjectsVisible(i,!1),t.setObjectsPickable(i,!0)):(t.setObjectsXRayed(i,!1),t.setObjectsVisible(i,!0),t.setObjectsPickable(i,!0))})),this._onModelLoaded=this.viewer.scene.on("modelLoaded",(e=>{if(this.viewer.metaScene.metaModels[e]){const t=this.bimViewer._modelsExplorer.getModelInfo(e);if(!t)return;this._treeView.addModel(e,{rootName:t.name})}})),this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(e=>{this.viewer.metaScene.metaModels[e]&&this._treeView.removeModel(e)})),this.bimViewer.on("reset",(()=>{this._treeView.collapse()}))}setEnabled(e){e?(this._classesTabButtonElement.classList.remove("disabled"),this._showAllClassesButtonElement.classList.remove("disabled"),this._hideAllClassesButtonElement.classList.remove("disabled")):(this._classesTabButtonElement.classList.add("disabled"),this._showAllClassesButtonElement.classList.add("disabled"),this._hideAllClassesButtonElement.classList.add("disabled"))}expandTreeViewToDepth(e){this._treeView.expandToDepth(e)}showNodeInTreeView(e){this._treeView.collapse(),this._treeView.showNode(e)}unShowNodeInTreeView(){this._treeView.unShowNode()}destroy(){super.destroy(),this._treeView.destroy(),this._treeViewContextMenu.destroy(),this.viewer.scene.off(this._onModelLoaded),this.viewer.scene.off(this._onModelUnloaded)}}const Bp=p.vec3();class Rp extends hp{constructor(e,t={}){if(super(e),!t.storeysTabElement)throw"Missing config: storeysTabElement";if(!t.showAllStoreysButtonElement)throw"Missing config: showAllStoreysButtonElement";if(!t.hideAllStoreysButtonElement)throw"Missing config: hideAllStoreysButtonElement";if(!t.storeysElement)throw"Missing config: storeysElement";if(this._storeysTabElement=t.storeysTabElement,this._showAllStoreysButtonElement=t.showAllStoreysButtonElement,this._hideAllStoreysButtonElement=t.hideAllStoreysButtonElement,this._storeysTabButtonElement=this._storeysTabElement.querySelector(".xeokit-tab-btn"),!this._storeysTabButtonElement)throw"Missing DOM element: .xeokit-tab-btn";const i=t.storeysElement;this._treeView=new pd(this.viewer,{containerElement:i,autoAddModels:!1,hierarchy:"storeys",autoExpandDepth:1}),this._treeViewContextMenu=new Ip(this.bimViewer),this._treeView.on("contextmenu",(e=>{this._treeViewContextMenu.context={bimViewer:this.bimViewer,viewer:e.viewer,treeViewPlugin:e.treeViewPlugin,treeViewNode:e.treeViewNode,pruneEmptyNodes:!0},this._treeViewContextMenu.show(e.event.pageX,e.event.pageY)})),this._treeView.on("nodeTitleClicked",(e=>{const t=this.viewer.scene,i=[];e.treeViewPlugin.withNodeTree(e.treeViewNode,(e=>{e.objectId&&i.push(e.objectId)}));e.treeViewNode.checked?(t.setObjectsXRayed(i,!1),t.setObjectsVisible(i,!1),t.setObjectsPickable(i,!0)):(t.setObjectsXRayed(i,!1),t.setObjectsVisible(i,!0),t.setObjectsPickable(i,!0))})),this._onModelLoaded=this.viewer.scene.on("modelLoaded",(e=>{const t=this.bimViewer._modelsExplorer.getModelInfo(e);t&&this._treeView.addModel(e,{rootName:t.name})})),this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(e=>{this.viewer.metaScene.metaModels[e]&&this._treeView.removeModel(e)})),this.bimViewer.on("reset",(()=>{this._treeView.collapse(),this._treeView.expandToDepth(1)}))}setEnabled(e){e?(this._storeysTabButtonElement.classList.remove("disabled"),this._showAllStoreysButtonElement.classList.remove("disabled"),this._hideAllStoreysButtonElement.classList.remove("disabled")):(this._storeysTabButtonElement.classList.add("disabled"),this._showAllStoreysButtonElement.classList.add("disabled"),this._hideAllStoreysButtonElement.classList.add("disabled"))}expandTreeViewToDepth(e){this._treeView.expandToDepth(e)}showNodeInTreeView(e){this._treeView.collapse(),this._treeView.showNode(e)}unShowNodeInTreeView(){this._treeView.unShowNode()}selectStorey(e,t){const i=this.viewer.metaScene.metaObjects[e];if(!i)return void this.error("selectStorey() - object is not found: '"+e+"'");if("IfcBuildingStorey"!==i.type)return void this.error("selectStorey() - object is not found: '"+e+"'");const s=i.getObjectIDsInSubtree();this._selectObjects(s,t)}_selectObjects(e,t){const i=this.viewer.scene,s=i.getAABB(e);this.viewer.cameraControl.pivotPos=p.getAABB3Center(s,Bp),t?(i.setObjectsXRayed(i.objectIds,!0),i.setObjectsVisible(i.objectIds,!0),i.setObjectsPickable(i.objectIds,!1),i.setObjectsSelected(i.selectedObjectIds,!1),i.setObjectsXRayed(e,!1),i.setObjectsVisible(e,!0),i.setObjectsPickable(e,!0),this.viewer.cameraFlight.flyTo({aabb:s},(()=>{setTimeout((function(){i.setObjectsVisible(i.xrayedObjectIds,!1),i.setObjectsXRayed(i.xrayedObjectIds,!1)}),500),t()}))):(i.setObjectsVisible(i.objectIds,!1),i.setObjectsPickable(i.xrayedObjectIds,!0),i.setObjectsXRayed(i.xrayedObjectIds,!1),i.setObjectsSelected(i.selectedObjectIds,!1),i.setObjectsVisible(e,!0),this.viewer.cameraFlight.jumpTo({aabb:s}))}destroy(){super.destroy(),this._treeView.destroy(),this._treeViewContextMenu.destroy(),this.viewer.scene.off(this._onModelLoaded),this.viewer.scene.off(this._onModelUnloaded)}}const kp=p.vec3();class Op extends hp{constructor(e,t){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";this._saveOrthoActive=null,this._buttonElement=t.buttonElement,this._cameraControlNavModeMediator=t.cameraControlNavModeMediator,this._active=!1,this.on("enabled",(e=>{e?this._buttonElement.classList.remove("disabled"):this._buttonElement.classList.add("disabled")})),this._buttonElement.addEventListener("click",(e=>{this.getEnabled()&&(this.bimViewer._sectionTool.hideControl(),this.setActive(!this.getActive(),(()=>{}))),e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!0,(()=>{}))}))}setEnabled(e){super.setEnabled(e),this._saveOrthoActive=this.bimViewer._orthoMode.getActive()}setActive(e,t){this._active!==e?(this._active=e,e?(this._buttonElement.classList.add("active"),t?this._enterThreeDMode((()=>{this.fire("active",this._active),t()})):(this._enterThreeDMode(),this.fire("active",this._active))):(this._buttonElement.classList.remove("active"),t?this._exitThreeDMode((()=>{this.fire("active",this._active),t()})):(this._exitThreeDMode(),this.fire("active",this._active)))):t&&t()}_enterThreeDMode(e){const t=this.viewer,i=t.scene,s=i.getAABB(i.visibleObjectIds),r=p.getAABB3Diag(s),o=p.getAABB3Center(s,kp),n=Math.abs(r/Math.tan(32.5)),a=i.camera,l=a.yUp?[-1,-1,-1]:[1,1,1],h=a.yUp?[-1,1,-1]:[-1,1,1];t.cameraControl.pivotPos=o,this.bimViewer._navCubeMode.setActive(!0),this.bimViewer._firstPersonMode.setEnabled(!0),this._cameraControlNavModeMediator.setThreeDModeActive(!0),this.bimViewer._sectionTool.setEnabled(!0),this.bimViewer._orthoMode.setEnabled(!0),e?t.cameraFlight.flyTo({look:o,eye:[o[0]-n*l[0],o[1]-n*l[1],o[2]-n*l[2]],up:h,orthoScale:1.3*r,duration:1,projection:this._saveOrthoActive?"ortho":"perspective"},(()=>{e()})):t.cameraFlight.jumpTo({look:o,eye:[o[0]-n*l[0],o[1]-n*l[1],o[2]-n*l[2]],up:h,orthoScale:1.3*r,projection:this._saveOrthoActive?"ortho":"perspective"})}_exitThreeDMode(e){const t=this.viewer,i=t.scene,s=i.camera,r=i.getAABB(i.visibleObjectIds),o=p.getAABB3Center(r),n=p.getAABB3Diag(r),a=Math.abs(n/Math.tan(45*p.DEGTORAD)),l=1.3*n,h=kp;h[0]=o[0]+s.worldUp[0]*a,h[1]=o[1]+s.worldUp[1]*a,h[2]=o[2]+s.worldUp[2]*a;const c=p.mulVec3Scalar(s.worldForward,-1,[]);this.bimViewer._sectionTool.setActive(!1),this.bimViewer._firstPersonMode.setEnabled(!1),this._saveOrthoActive=this.bimViewer._orthoMode.getActive(),this.bimViewer._orthoMode.setEnabled(!1),this._cameraControlNavModeMediator.setThreeDModeActive(!1),e?t.cameraFlight.flyTo({eye:h,look:o,up:c,orthoScale:l,projection:"ortho"},(()=>{this.bimViewer._navCubeMode.setActive(!1)})):(t.cameraFlight.jumpTo({eye:h,look:o,up:c,orthoScale:l,projection:"ortho"}),this.bimViewer._navCubeMode.setActive(!1))}}class Np extends n{constructor(e){super(),this._bimViewer=e,this._buildMenu()}_buildMenu(){const e=[],t=[];this._bimViewer._enablePropertiesInspector&&e.push({getTitle:e=>e.viewer.localeService.translate("objectContextMenu.inspectProperties")||"Inspect Properties",doAction:e=>{const t=e.entity.id;e.bimViewer.showObjectProperties(t)}}),e.push({getTitle:e=>e.viewer.localeService.translate("objectContextMenu.showInTree")||"Show in Explorer",doAction:e=>{const t=e.entity.id;e.showObjectInExplorers(t)}}),t.push({getTitle:e=>e.viewer.localeService.translate("objectContextMenu.viewFit")||"View Fit",doAction:e=>{const t=e.viewer,i=t.scene,s=e.entity;t.cameraFlight.flyTo({aabb:s.aabb,duration:.5},(()=>{setTimeout((function(){i.setObjectsHighlighted(i.highlightedObjectIds,!1)}),500)})),t.cameraControl.pivotPos=p.getAABB3Center(s.aabb)}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.viewFitAll")||"View Fit All",doAction:e=>{const t=e.viewer,i=t.scene,s=i.getAABB(i.visibleObjectIds);t.cameraFlight.flyTo({aabb:s,duration:.5}),t.cameraControl.pivotPos=p.getAABB3Center(s)}}),this.items=[e,t,[{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.hide")||"Hide",getEnabled:e=>e.entity.visible,doAction:e=>{e.entity.visible=!1}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.hideOthers")||"Hide Others",doAction:e=>{const t=e.viewer,i=t.scene,s=e.entity,r=t.metaScene.metaObjects[s.id];r&&(i.setObjectsVisible(i.visibleObjectIds,!1),r.withMetaObjectsInSubtree((e=>{const t=i.objects[e.id];t&&(t.visible=!0)})))}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.hideAll")||"Hide All",getEnabled:e=>e.viewer.scene.numVisibleObjects>0,doAction:e=>{e.viewer.scene.setObjectsVisible(e.viewer.scene.visibleObjectIds,!1)}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.showAll")||"Show All",getEnabled:e=>{const t=e.viewer.scene;return t.numVisibleObjects<t.numObjects||e.viewer.scene.numXRayedObjects>0},doAction:e=>{const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsPickable(t.xrayedObjectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.xray")||"X-Ray",getEnabled:e=>!e.entity.xrayed,doAction:e=>{const t=e.entity;t.xrayed=!0,t.pickable=e.bimViewer.getConfig("xrayPickable")}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.xrayOthers")||"X-Ray Others",doAction:e=>{const t=e.viewer,i=t.scene,s=e.entity,r=t.metaScene.metaObjects[s.id];r&&(i.setObjectsVisible(i.objectIds,!0),i.setObjectsXRayed(i.objectIds,!0),e.bimViewer.getConfig("xrayPickable")||i.setObjectsPickable(i.objectIds,!1),r.withMetaObjectsInSubtree((e=>{const t=i.objects[e.id];t&&(t.xrayed=!1,t.pickable=!0)})))}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.xrayAll")||"X-Ray All",getEnabled:e=>{const t=e.viewer.scene;return t.numXRayedObjects<t.numObjects},doAction:e=>{const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),e.bimViewer.getConfig("xrayPickable")||t.setObjectsPickable(t.objectIds,!1),t.setObjectsXRayed(t.objectIds,!0)}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.xrayNone")||"X-Ray None",getEnabled:e=>e.viewer.scene.numXRayedObjects>0,doAction:e=>{const t=e.viewer.scene,i=t.xrayedObjectIds;t.setObjectsPickable(i,!0),t.setObjectsXRayed(i,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.select")||"Select",getEnabled:e=>!e.entity.selected,doAction:e=>{e.entity.selected=!0}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.undoSelect")||"Undo Select",getEnabled:e=>e.entity.selected,doAction:e=>{e.entity.selected=!1}},{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.selectNone")||"Select None",getEnabled:e=>e.viewer.scene.numSelectedObjects>0,doAction:e=>{e.viewer.scene.setObjectsSelected(e.viewer.scene.selectedObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("objectContextMenu.clearSlices")||"Clear Slices",getEnabled:e=>e.bimViewer.getNumSections()>0,doAction:e=>{e.bimViewer.clearSections()}}]]}}class jp extends n{constructor(e={}){super({context:e.context,items:[[{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.viewFitAll")||"View Fit All",doAction:e=>{const t=e.viewer,i=t.scene,s=i.getAABB(i.visibleObjectIds);t.cameraFlight.flyTo({aabb:s,duration:.5}),t.cameraControl.pivotPos=p.getAABB3Center(s)}}],[{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.hideAll")||"Hide All",getEnabled:e=>e.viewer.scene.numVisibleObjects>0,doAction:e=>{e.viewer.scene.setObjectsVisible(e.viewer.scene.visibleObjectIds,!1)}},{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.showAll")||"Show All",getEnabled:e=>{const t=e.viewer.scene;return t.numVisibleObjects<t.numObjects||e.viewer.scene.numXRayedObjects>0},doAction:e=>{const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsXRayed(t.xrayedObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.xRayAll")||"X-Ray All",getEnabled:e=>{const t=e.viewer.scene;return t.numXRayedObjects<t.numObjects},doAction:e=>{const t=e.viewer.scene;t.setObjectsVisible(t.objectIds,!0),t.setObjectsXRayed(t.objectIds,!0),e.bimViewer.getConfig("xrayPickable")||t.setObjectsPickable(t.objectIds,!1)}},{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.xRayNone")||"X-Ray None",getEnabled:e=>e.viewer.scene.numXRayedObjects>0,doAction:e=>{const t=e.viewer.scene.xrayedObjectIds;e.viewer.scene.setObjectsPickable(t,!0),e.viewer.scene.setObjectsXRayed(t,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.selectNone")||"Select None",getEnabled:e=>e.viewer.scene.numSelectedObjects>0,doAction:e=>{e.viewer.scene.setObjectsSelected(e.viewer.scene.selectedObjectIds,!1)}}],[{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.resetView")||"Reset View",doAction:e=>{e.bimViewer.resetView()}}],[{getTitle:e=>e.viewer.localeService.translate("canvasContextMenu.clearSlices")||"Clear Slices",getEnabled:e=>e.bimViewer.getNumSections()>0,doAction:e=>{e.bimViewer.clearSections()}}]]})}}class Vp extends hp{constructor(e,t){if(super(e,t),!t.buttonElement)throw"Missing config: buttonElement";this._buttonElement=t.buttonElement,this.on("enabled",(e=>{e?this._buttonElement.classList.remove("disabled"):this._buttonElement.classList.add("disabled")})),this._buttonElement.addEventListener("click",(e=>{this.getEnabled()&&this.setActive(!this.getActive(),(()=>{})),e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!1)})),this.viewer.camera.on("projection",(()=>{const e="ortho"===this.viewer.camera.projection;this._active=e,this._active?this._buttonElement.classList.add("active"):this._buttonElement.classList.remove("active")})),this._active=!1,this._buttonElement.classList.remove("active")}setActive(e,t){this._active!==e?(this._active=e,e?(this._buttonElement.classList.add("active"),t?this._enterOrthoMode((()=>{this.fire("active",this._active),t()})):(this._enterOrthoMode(),this.fire("active",this._active))):(this._buttonElement.classList.remove("active"),t?this._exitOrthoMode((()=>{this.fire("active",this._active),t()})):(this._exitOrthoMode(),this.fire("active",this._active)))):t&&t()}_enterOrthoMode(e){e?this.viewer.cameraFlight.flyTo({projection:"ortho",duration:.5},e):this.viewer.cameraFlight.jumpTo({projection:"ortho"})}_exitOrthoMode(e){e?this.viewer.cameraFlight.flyTo({projection:"perspective",duration:.5},e):this.viewer.cameraFlight.jumpTo({projection:"perspective"})}}class zp extends hp{constructor(e,t={}){if(super(e),!t.propertiesTabElement)throw"Missing config: propertiesTabElement";if(!t.propertiesElement)throw"Missing config: propertiesElement";if(this._metaObject=null,this._propertiesTabElement=t.propertiesTabElement,this._propertiesElement=t.propertiesElement,this._propertiesTabButtonElement=this._propertiesTabElement.querySelector(".xeokit-tab-btn"),!this._propertiesTabButtonElement)throw"Missing DOM element: ,xeokit-tab-btn";this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(e=>{this._metaObject&&this._metaObject.metaModel.id===e&&this.clear()})),this.bimViewer.on("reset",(()=>{this.clear()})),document.addEventListener("click",this._clickListener=e=>{e.target.matches(".xeokit-accordion .xeokit-accordion-button")&&(e.target.parentElement.classList.contains("active")?e.target.parentElement.classList.remove("active"):e.target.parentElement.classList.add("active"))}),this.clear()}showObjectPropertySets(e){const t=this.viewer.metaScene.metaObjects[e];if(!t)return;const i=t.propertySets;i&&i.length>0?this._setPropertySets(t,i):this._setPropertySets(t),this._metaObject=t}clear(){const e=[],t=this.viewer.localeService.translate("propertiesInspector.noObjectSelectedWarning")||"No object inspected. Right-click or long-tab an object and select 'Inspect Properties' to view its properties here.";e.push('<div class="element-attributes">'),e.push(`<p class="xeokit-i18n subsubtitle no-object-selected-warning" data-xeokit-i18n="propertiesInspector.noObjectSelectedWarning">${t}</p>`),e.push("</div>");const i=e.join("");this._propertiesElement.innerHTML=i}_setPropertySets(e,t){const i=[];if(i.push('<div class="element-attributes">'),e)if(i.push('<table class="xeokit-table">'),i.push(`<tr><td class="td1">Name:</td><td class="td2">${e.name}</td></tr>`),e.type&&i.push(`<tr><td class="td1">Class:</td><td class="td2">${e.type}</td></tr>`),i.push(`<tr><td class="td1">UUID:</td><td class="td2">${e.originalSystemId}</td></tr>`),i.push(`<tr><td class="td1">Viewer ID:</td><td class="td2">${e.id}</td></tr>`),i.push("</table>"),t&&0!==t.length){i.push("</div>"),i.push('<div class="xeokit-accordion">');for(let e=0,s=t.length;e<s;e++){const s=t[e],r=s.properties||[];if(r.length>0){i.push(`<div class="xeokit-accordion-container">\n                                        <p class="xeokit-accordion-button"><span></span>${s.name}</p>                                       \n                                        <div class="xeokit-accordion-panel">                                           \n                                            <table class="xeokit-table"><tbody>`);for(let e=0,t=r.length;e<t;e++){const t=r[e];i.push(`<tr><td class="td1">${t.name||t.label}:</td><td class="td2">${t.value}</td></tr>`)}i.push("</tbody></table>\n                        </div>\n                        </div>")}}i.push("</div>")}else{const e=this.viewer.localeService.translate("propertiesInspector.noPropSetWarning")||"No properties sets found for this object";i.push(`<p class="xeokit-i18n subtitle xeokit-no-prop-set-warning" data-xeokit-i18n="propertiesInspector.noPropSetWarning">${e}</p>`),i.push("</div>")}else i.push('<p class="subsubtitle">No object selected</p>');this._propertiesElement.innerHTML=i.join("")}setEnabled(e){e?this._propertiesTabButtonElement.classList.remove("disabled"):this._propertiesTabButtonElement.classList.add("disabled")}destroy(){super.destroy(),this.viewer.scene.off(this._onModelLoaded),this.viewer.scene.off(this._onModelUnloaded),document.removeEventListener("click",this._clickListener)}}const Up=new Float32Array(3);class Gp{constructor(e){if(!e)throw"Parameter expected: cfg";if(!e.viewer)throw"Parameter expected: cfg.viewer";this.viewer=e.viewer,this._maxTreeDepth=e.maxTreeDepth||15,this._root=null,this._needsRebuild=!0,this._onModelLoaded=this.viewer.scene.on("modelLoaded",(e=>{this._needsRebuild=!0})),this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(e=>{this._needsRebuild=!0}))}get root(){return this._needsRebuild&&this._rebuild(),this._root}_rebuild(){const e=this.viewer.scene;this._root={aabb:e.getAABB()};for(let t in e.objects){const i=e.objects[t];this._insertEntity(this._root,i,1)}this._needsRebuild=!1}_insertEntity(e,t,i){const s=t.aabb;if(i>=this._maxTreeDepth)return e.entities=e.entities||[],void e.entities.push(t);if(e.left&&p.containsAABB3(e.left.aabb,s))return void this._insertEntity(e.left,t,i+1);if(e.right&&p.containsAABB3(e.right.aabb,s))return void this._insertEntity(e.right,t,i+1);const r=e.aabb;Up[0]=r[3]-r[0],Up[1]=r[4]-r[1],Up[2]=r[5]-r[2];let o=0;if(Up[1]>Up[o]&&(o=1),Up[2]>Up[o]&&(o=2),!e.left){const n=r.slice();if(n[o+3]=(r[o]+r[o+3])/2,e.left={aabb:n},p.containsAABB3(n,s))return void this._insertEntity(e.left,t,i+1)}if(!e.right){const n=r.slice();if(n[o]=(r[o]+r[o+3])/2,e.right={aabb:n},p.containsAABB3(n,s))return void this._insertEntity(e.right,t,i+1)}e.entities=e.entities||[],e.entities.push(t)}destroy(){const e=this.viewer.scene;e.off(this._onModelLoaded),e.off(this._onModelUnloaded),this._root=null,this._needsRebuild=!0}}class Wp extends hp{constructor(e,t){if(super(e),!t.buttonElement)throw"Missing config: buttonElement";this._objectsKdTree3=t.objectsKdTree3,this._marquee=p.AABB2(),this._marqueeFrustum=new Uo,this._marqueeFrustumProjMat=p.mat4(),this._marqueeDir=!1;const i=t.buttonElement;this.on("enabled",(e=>{e?i.classList.remove("disabled"):i.classList.add("disabled")})),this.on("active",(e=>{e?(i.classList.add("active"),this._objectsKdTree3.root):i.classList.remove("active")})),i.addEventListener("click",(e=>{if(this.getEnabled()){const e=this.getActive();this.setActive(!e)}e.preventDefault()})),this.bimViewer.on("reset",(()=>{this.setActive(!1)}));const s=this.viewer.scene,r=s.canvas.canvas;this._marqueeElement=document.createElement("div"),document.body.appendChild(this._marqueeElement);const o=this._marqueeElement.style;let n,a,l,h,c,u,d,f;o.position="absolute",o["z-index"]="40000005",o.width="8px",o.height="8px",o.visibility="hidden",o.top="0px",o.left="0px",o["box-shadow"]="0 2px 5px 0 #182A3D;",o.opacity=1,o["pointer-events"]="none";let m=!1,g=!1;r.addEventListener("keydown",(e=>{e.ctrlKey&&"ControlLeft"===e.code&&console.log("CTRL key is pressed down!")})),r.addEventListener("keyup",(e=>{e.ctrlKey&&"ControlLeft"===e.code&&console.log("CTRL key is released!")})),r.addEventListener("mousedown",(e=>{if(!this.getActive()||!this.getEnabled())return;if(0!==e.button)return;const t=this.bimViewer.viewer.scene.input;t.keyDown[t.KEY_CTRL]||s.setObjectsSelected(s.selectedObjectIds,!1),n=e.pageX,a=e.pageY,o.visibility="visible",o.left=`${n}px`,o.top=`${a}px`,o.width="0px",o.height="0px",o.display="block",c=e.offsetX,u=e.offsetY,m=!0,this.viewer.cameraControl.pointerEnabled=!1})),r.addEventListener("mouseup",(e=>{if(!this.getActive()||!this.getEnabled())return;if(!m&&!g)return;if(0!==e.button)return;l=e.pageX,h=e.pageY;const t=Math.abs(l-n),i=Math.abs(h-a);o.width=`${t}px`,o.height=`${i}px`,o.visibility="hidden",m=!1,this.viewer.cameraControl.pointerEnabled=!0,g&&(g=!1),(t>3||i>3)&&this._marqueePick()})),document.addEventListener("mouseup",(e=>{this.getActive()&&this.getEnabled()&&0===e.button&&m&&(o.visibility="hidden",m=!1,g=!0,this.viewer.cameraControl.pointerEnabled=!0)}),!0),r.addEventListener("mousemove",(e=>{if(!this.getActive()||!this.getEnabled())return;if(0!==e.button)return;if(!m)return;const t=e.pageX,i=e.pageY,s=t-n,r=i-a;o.width=`${Math.abs(s)}px`,o.height=`${Math.abs(r)}px`,o.left=`${Math.min(n,t)}px`,o.top=`${Math.min(a,i)}px`,d=e.offsetX,f=e.offsetY;const l=c<d?0:1;this._setMarqueeDir(l),this._marquee[0]=Math.min(c,d),this._marquee[1]=Math.min(u,f),this._marquee[2]=Math.max(c,d),this._marquee[3]=Math.max(u,f)}))}_setMarqueeDir(e){e!==this._marqueeDir&&(this._marqueeElement.style["background-image"]=0===e?"url(\"data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4'/%3e%3c/svg%3e\")":"url(\"data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e\")",this._marqueeDir=e)}_marqueePick(){this._buildMarqueeFrustum();const e=[],t=(i,s=Uo.INTERSECT)=>{if(s===Uo.INTERSECT&&(s=Go(this._marqueeFrustum,i.aabb)),s!==Uo.OUTSIDE){if(i.entities){const t=i.entities;for(let i=0,s=t.length;i<s;i++){const s=t[i],r=s.aabb;if(0===this._marqueeDir){Go(this._marqueeFrustum,r)===Uo.INSIDE&&e.push(s)}else{Go(this._marqueeFrustum,r)!==Uo.OUTSIDE&&e.push(s)}}}i.left&&t(i.left,s),i.right&&t(i.right,s)}};t(this._objectsKdTree3.root);for(let t=0,i=e.length;t<i;t++)e[t].selected=!0;return e}_buildMarqueeFrustum(){const e=this.viewer.scene.canvas.canvas,t=2/e.clientWidth,i=2/e.clientHeight,s=e.clientHeight/e.clientWidth,r=this._marquee[0]*t-1,o=this._marquee[2]*t-1,n=-this._marquee[3]*i+1,a=-this._marquee[1]*i+1,l=this.viewer.scene.camera.frustum.near*(17*s);p.frustumMat4(r,o,n*s,a*s,l,1e4,this._marqueeFrustumProjMat),function(e,t,i){const s=p.mulMat4(i,t,Vo),r=s[0],o=s[1],n=s[2],a=s[3],l=s[4],h=s[5],c=s[6],u=s[7],d=s[8],f=s[9],m=s[10],g=s[11],_=s[12],v=s[13],b=s[14],x=s[15];e.planes[0].set(a-r,u-l,g-d,x-_),e.planes[1].set(a+r,u+l,g+d,x+_),e.planes[2].set(a-o,u-h,g-f,x-v),e.planes[3].set(a+o,u+h,g+f,x+v),e.planes[4].set(a-n,u-c,g-m,x-b),e.planes[5].set(a+n,u+c,g+m,x+b)}(this._marqueeFrustum,this.viewer.scene.camera.viewMatrix,this._marqueeFrustumProjMat)}}function Hp(e){const t="xeokit-tab",i="active";function s(e){let s=e.parentNode.querySelectorAll("."+t);for(let t=0;t<s.length;t++){let r=s[t];r.isEqualNode(e)?r.classList.add(i):r.classList.remove(i)}}let r=e.querySelectorAll(".xeokit-tabs");for(let e=0;e<r.length;e++){let i=r[e].querySelectorAll("."+t);s(i[0]);for(let e=0;e<i.length;e++){i[e].querySelector(".xeokit-tab-btn").addEventListener("click",(function(e){e.preventDefault(),this.classList.contains("disabled")||s(e.target.parentNode)}))}}}e.BIMViewer=class extends hp{constructor(e,t={}){if(!t.canvasElement)throw"Config expected: canvasElement";if(!t.explorerElement)throw"Config expected: explorerElement";if(!t.toolbarElement)throw"Config expected: toolbarElement";if(!t.navCubeCanvasElement)throw"Config expected: navCubeCanvasElement";const i=t.canvasElement,s=t.explorerElement,r=t.inspectorElement,o=t.toolbarElement,n=t.navCubeCanvasElement,a=t.busyModelBackdropElement;s.oncontextmenu=e=>{e.preventDefault()},o.oncontextmenu=e=>{e.preventDefault()},n.oncontextmenu=e=>{e.preventDefault()};const l=new jc({localeService:t.localeService,canvasElement:i,keyboardEventsElement:t.keyboardEventsElement,transparent:!1,backgroundColor:[1,1,1],backgroundColorFromAmbientLight:!1,saoEnabled:!0,pbrEnabled:!1,colorTextureEnabled:!0});super(null,t,e,l),this._configs={},this._enableAddModels=!!t.enableEditModels,this._enablePropertiesInspector=!!t.inspectorElement,this.viewer=l,this._objectsKdTree3=new Gp({viewer:l}),this._customizeViewer(),this._initCanvasContextMenus(),s.innerHTML=function(e){return'<div class="xeokit-tabs"> \n    <div class="xeokit-tab xeokit-modelsTab">\n        <a class="xeokit-i18n xeokit-tab-btn" href="#" data-xeokit-i18n="modelsExplorer.title">Models</a>\n        <div class="xeokit-tab-content">\n            <div class="xeokit-btn-group">\n                <button type="button" class="xeokit-i18n xeokit-loadAllModels xeokit-btn disabled" data-xeokit-i18n="modelsExplorer.loadAll" data-xeokit-i18ntip="modelsExplorer.loadAllTip" data-tippy-content="Load all models">Load all</button>\n                <button type="button" class="xeokit-i18n xeokit-unloadAllModels xeokit-btn disabled" data-xeokit-i18n="modelsExplorer.unloadAll"  data-xeokit-i18ntip="modelsExplorer.unloadAllTip" data-tippy-content="Unload all models">Unload all</button>'+(e.enableEditModels?'<button type="button" class="xeokit-i18n xeokit-addModel xeokit-btn disabled" data-xeokit-i18n="modelsExplorer.add"  data-xeokit-i18ntip="modelsExplorer.addTip" data-tippy-content="Add model">Add</button>':"")+'</div>\n            <div class="xeokit-models" ></div>\n        </div>\n    </div>\n    <div class="xeokit-tab xeokit-objectsTab">\n        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="objectsExplorer.title">Objects</a>\n        <div class="xeokit-tab-content">\n         <div class="xeokit-btn-group">\n            <button type="button" class="xeokit-i18n xeokit-showAllObjects xeokit-btn disabled" data-xeokit-i18n="objectsExplorer.showAll" data-xeokit-i18ntip="objectsExplorer.showAllTip" data-tippy-content="Show all objects">Show all</button>\n            <button type="button" class="xeokit-i18n xeokit-hideAllObjects xeokit-btn disabled" data-xeokit-i18n="objectsExplorer.hideAll" data-xeokit-i18ntip="objectsExplorer.hideAllTip" data-tippy-content="Hide all objects">Hide all</button>\n        </div>\n        <div class="xeokit-objects xeokit-tree-panel" ></div>\n        </div>\n    </div>\n    <div class="xeokit-i18n xeokit-tab xeokit-classesTab">\n        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="classesExplorer.title">Classes</a>\n        <div class="xeokit-tab-content">\n            <div class="xeokit-btn-group">\n                <button type="button" class="xeokit-i18n xeokit-showAllClasses xeokit-btn disabled" data-xeokit-i18n="classesExplorer.showAll"  data-xeokit-i18ntip="classesExplorer.hideAllTip" data-tippy-content="Show all classes">Show all</button>\n                <button type="button" class="xeokit-i18n xeokit-hideAllClasses xeokit-btn disabled" data-xeokit-i18n="classesExplorer.hideAll" data-xeokit-i18ntip="classesExplorer.hideAllTip" data-tippy-content="Hide all classes">Hide all</button>\n            </div>\n            <div class="xeokit-classes xeokit-tree-panel" ></div>\n        </div>\n    </div>\n     <div class="xeokit-tab xeokit-storeysTab">\n        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="storeysExplorer.title">Storeys</a>\n        <div class="xeokit-tab-content">\n         <div class="xeokit-btn-group">\n                <button type="button" class="xeokit-i18n xeokit-showAllStoreys xeokit-btn disabled" data-xeokit-i18n="storeysExplorer.showAll" data-xeokit-i18ntip="storeysExplorer.showAllTip" data-tippy-content="Show all storeys">Show all</button>\n                <button type="button" class="xeokit-i18n xeokit-hideAllStoreys xeokit-btn disabled" data-xeokit-i18n="storeysExplorer.hideAll" data-xeokit-i18ntip="storeysExplorer.hideAllTip" data-tippy-content="Hide all storeys">Hide all</button>\n            </div>\n             <div class="xeokit-storeys xeokit-tree-panel"></div>\n        </div>\n    </div>\n</div>'}(t),o.innerHTML='<div class="xeokit-toolbar">\n    \x3c!-- Reset button --\x3e\n    <div class="xeokit-btn-group">\n        <button type="button" class="xeokit-i18n xeokit-reset xeokit-btn fa fa-home fa-2x disabled" data-xeokit-i18ntip="toolbar.resetViewTip" data-tippy-content="Reset view"></button>\n    </div>\n    <div class="xeokit-btn-group" role="group">\n        \x3c!-- 3D Mode button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-threeD xeokit-btn fa fa-cube fa-2x disabled" data-xeokit-i18ntip="toolbar.toggle2d3dTip" data-tippy-content="Toggle 2D/3D"></button>\n        \x3c!-- Perspective/Ortho Mode button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-ortho xeokit-btn fa fa-th fa-2x  disabled" data-xeokit-i18ntip="toolbar.togglePerspectiveTip" data-tippy-content="Toggle Perspective/Ortho"></button>\n        \x3c!-- Fit button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-fit xeokit-btn fa fa-crop fa-2x disabled" data-xeokit-i18ntip="toolbar.viewFitTip" data-tippy-content="View fit"></button>\n        \x3c!-- First Person mode button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-firstPerson xeokit-btn fa fa-male fa-2x disabled" data-xeokit-i18ntip="toolbar.firstPersonTip" data-tippy-content="Toggle first-person mode"></button>\n          \x3c!-- Show/hide IFCSpaces --\x3e\n        <button type="button" class="xeokit-i18n xeokit-showSpaces xeokit-btn fab fa-codepen fa-2x disabled" data-xeokit-i18ntip="toolbar.showSpacesTip" data-tippy-content="Show IFCSpaces"></button>   \n    </div>\n    \x3c!-- Tools button group --\x3e\n    <div class="xeokit-btn-group" role="group">\n        \x3c!-- Hide tool button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-hide xeokit-btn fa fa-eraser fa-2x disabled" data-xeokit-i18ntip="toolbar.hideObjectsTip" data-tippy-content="Hide objects"></button>\n        \x3c!-- Select tool button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-select xeokit-btn fa fa-mouse-pointer fa-2x disabled" data-xeokit-i18ntip="toolbar.selectObjectsTip" data-tippy-content="Select objects"></button>    \n          \x3c!-- Marquee select tool button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-marquee xeokit-btn fas fa-object-group fa-2x disabled" data-xeokit-i18ntip="toolbar.marqueeSelectTip" data-tippy-content="Marquee select objects"></button>    \n        \x3c!-- section tool button --\x3e\n        <button type="button" class="xeokit-i18n xeokit-section xeokit-btn fa fa-cut fa-2x disabled" data-xeokit-i18ntip="toolbar.sliceObjectsTip" data-tippy-content="Slice objects">\n            <div class="xeokit-i18n xeokit-section-menu-button disabled" data-xeokit-i18ntip="toolbar.slicesMenuTip"  data-tippy-content="Slices menu">\n                <span class="xeokit-arrow-down xeokit-section-menu-button-arrow"></span>\n            </div>\n            <div class="xeokit-i18n xeokit-section-counter" data-xeokit-i18ntip="toolbar.numSlicesTip" data-tippy-content="Number of existing slices"></div>\n        </button>\n    </div>\n</div>',this._enablePropertiesInspector&&(r.innerHTML='<div class="xeokit-tabs">  \n    <div class="xeokit-tab xeokit-propertiesTab">\n        <a class="xeokit-i18n xeokit-tab-btn disabled" href="#" data-xeokit-i18n="propertiesInspector.title">Properties</a>\n        <div class="xeokit-tab-content">        \n        <div class="xeokit-properties"></div>\n        </div>\n    </div>\n</div>'),this._explorerElement=s,this._inspectorElement=r,Hp(s),this._enablePropertiesInspector&&Hp(r),this._modelsExplorer=new Tp(this,{modelsTabElement:s.querySelector(".xeokit-modelsTab"),loadModelsButtonElement:s.querySelector(".xeokit-loadAllModels"),unloadModelsButtonElement:s.querySelector(".xeokit-unloadAllModels"),addModelButtonElement:s.querySelector(".xeokit-addModel"),modelsElement:s.querySelector(".xeokit-models"),enableEditModels:this._enableAddModels}),this._objectsExplorer=new Fp(this,{objectsTabElement:s.querySelector(".xeokit-objectsTab"),showAllObjectsButtonElement:s.querySelector(".xeokit-showAllObjects"),hideAllObjectsButtonElement:s.querySelector(".xeokit-hideAllObjects"),objectsElement:s.querySelector(".xeokit-objects")}),this._classesExplorer=new Lp(this,{classesTabElement:s.querySelector(".xeokit-classesTab"),showAllClassesButtonElement:s.querySelector(".xeokit-showAllClasses"),hideAllClassesButtonElement:s.querySelector(".xeokit-hideAllClasses"),classesElement:s.querySelector(".xeokit-classes")}),this._storeysExplorer=new Rp(this,{storeysTabElement:s.querySelector(".xeokit-storeysTab"),showAllStoreysButtonElement:s.querySelector(".xeokit-showAllStoreys"),hideAllStoreysButtonElement:s.querySelector(".xeokit-hideAllStoreys"),storeysElement:s.querySelector(".xeokit-storeys")}),this._enablePropertiesInspector&&(this._propertiesInspector=new zp(this,{propertiesTabElement:r.querySelector(".xeokit-propertiesTab"),propertiesElement:r.querySelector(".xeokit-properties")})),this._resetAction=new dp(this,{buttonElement:o.querySelector(".xeokit-reset"),active:!1}),this._fitAction=new fp(this,{buttonElement:o.querySelector(".xeokit-fit"),active:!1});const h=new function(e){let t=!1;this.setThreeDModeActive=i=>{i?(e._firstPersonMode.setActive(!1),e._marqueeSelectionTool.setEnabled(!0),e.viewer.cameraControl.navMode="orbit"):(e._marqueeSelectionTool.setEnabled(!1),e._marqueeSelectionTool.setActive(!1),e._firstPersonMode.setActive(!1),e.viewer.cameraControl.navMode="planView"),t=i},this.setFirstPersonModeActive=i=>{e.viewer.cameraControl.navMode=i?"firstPerson":t?"orbit":"planView"}}(this);this._threeDMode=new Op(this,{buttonElement:o.querySelector(".xeokit-threeD"),cameraControlNavModeMediator:h,active:!1}),this._orthoMode=new Vp(this,{buttonElement:o.querySelector(".xeokit-ortho"),active:!1}),this._firstPersonMode=new mp(this,{buttonElement:o.querySelector(".xeokit-firstPerson"),cameraControlNavModeMediator:h,active:!1}),this._hideTool=new gp(this,{buttonElement:o.querySelector(".xeokit-hide"),active:!1}),this._selectionTool=new _p(this,{buttonElement:o.querySelector(".xeokit-select"),active:!1}),this._marqueeSelectionTool=new Wp(this,{buttonElement:o.querySelector(".xeokit-marquee"),active:!1,objectsKdTree3:this._objectsKdTree3}),this._showSpacesMode=new vp(this,{buttonElement:o.querySelector(".xeokit-showSpaces"),active:!1}),this._queryTool=new bp(this,{active:!1}),this._sectionTool=new wp(this,{buttonElement:o.querySelector(".xeokit-section"),counterElement:o.querySelector(".xeokit-section-counter"),menuButtonElement:o.querySelector(".xeokit-section-menu-button"),menuButtonArrowElement:o.querySelector(".xeokit-section-menu-button-arrow"),active:!1}),this._navCubeMode=new Mp(this,{navCubeCanvasElement:n,active:!0}),this._busyModal=new cp(this,{busyModalBackdropElement:a}),this._threeDMode.setActive(!0),this._firstPersonMode.setActive(!1),this._navCubeMode.setActive(!0),this._modelsExplorer.on("modelLoaded",(e=>{this._modelsExplorer.getNumModelsLoaded()>0&&this.setControlsEnabled(!0),this.fire("modelLoaded",e)})),this._modelsExplorer.on("modelUnloaded",(e=>{0===this._modelsExplorer.getNumModelsLoaded()&&(this.setControlsEnabled(!1),this.openTab("models")),this.fire("modelUnloaded",e)})),this._resetAction.on("reset",(()=>{this.fire("reset",!0)})),this._mutexActivation([this._hideTool,this._selectionTool,this._marqueeSelectionTool,this._sectionTool]),s.querySelector(".xeokit-showAllObjects").addEventListener("click",(e=>{this.setAllObjectsVisible(!0),this.setAllObjectsXRayed(!1),e.preventDefault()})),s.querySelector(".xeokit-hideAllObjects").addEventListener("click",(e=>{this.setAllObjectsVisible(!1),e.preventDefault()})),s.querySelector(".xeokit-showAllClasses").addEventListener("click",(e=>{this.setAllObjectsVisible(!0),this.setAllObjectsXRayed(!1),e.preventDefault()})),s.querySelector(".xeokit-hideAllClasses").addEventListener("click",(e=>{this.setAllObjectsVisible(!1),e.preventDefault()})),s.querySelector(".xeokit-showAllStoreys").addEventListener("click",(e=>{this.setAllObjectsVisible(!0),this.setAllObjectsXRayed(!1),e.preventDefault()})),s.querySelector(".xeokit-hideAllStoreys").addEventListener("click",(e=>{this.setAllObjectsVisible(!1),e.preventDefault()})),s.querySelector(".xeokit-loadAllModels").addEventListener("click",(e=>{this.setControlsEnabled(!1),this.loadAllModels(),e.preventDefault()})),s.querySelector(".xeokit-unloadAllModels").addEventListener("click",(e=>{this.setControlsEnabled(!1),this._modelsExplorer.unloadAllModels(),e.preventDefault()})),this._enableAddModels&&s.querySelector(".xeokit-addModel").addEventListener("click",(e=>{this.fire("addModel",{}),e.preventDefault()})),this._bcfViewpointsPlugin=new wo(this.viewer,{}),this._fastNavPlugin=new Vc(l,{hideEdges:!0,hideSAO:!0,hidePBR:!1,hideColorTexture:!1,hideTransparentObjects:!1,scaleCanvasResolution:!1,scaleCanvasResolutionFactor:.6}),this.viewer.scene.on("rendered",(()=>{const e=this._fastNavPlugin;e.hideEdges=5<f.frame.drawElements+f.frame.drawArrays,e.scaleCanvasResolution=1e3<f.frame.drawElements+f.frame.drawArrays})),this._initConfigs(),this.setControlsEnabled(!1)}get localeService(){return this.viewer.localeService}_customizeViewer(){const e=this.viewer.scene;e.xrayMaterial.fill=!1,e.xrayMaterial.fillAlpha=.3,e.xrayMaterial.fillColor=[0,0,0],e.xrayMaterial.edges=!0,e.xrayMaterial.edgeAlpha=.1,e.xrayMaterial.edgeColor=[0,0,0],e.highlightMaterial.edges=!0,e.highlightMaterial.edgeColor=[1,1,0],e.highlightMaterial.edgeAlpha=.9,e.highlightMaterial.fill=!0,e.highlightMaterial.fillAlpha=.1,e.highlightMaterial.fillColor=[1,0,0],e.pointsMaterial.pointSize=1,e.pointsMaterial.roundPoints=!0,e.pointsMaterial.perspectivePoints=!0,e.pointsMaterial.minPerspectivePointSize=2,e.pointsMaterial.maxPerspectivePointSize=4,this.viewer.cameraControl.panRightClick=!0,this.viewer.cameraControl.followPointer=!0,this.viewer.cameraControl.doublePickFlyTo=!1,this.viewer.cameraControl.smartPivot=!0,this.viewer.cameraControl.keyboardDollyRate=100,this.viewer.cameraControl.mouseWheelDollyRate=100,this.viewer.cameraControl.dollyInertia=0,this.viewer.cameraControl.dollyMinSpeed=.04,this.viewer.cameraControl.dollyProximityThreshold=30;const t=document.createRange().createContextualFragment("<div class='xeokit-camera-pivot-marker'></div>").firstChild;document.body.appendChild(t),this.viewer.cameraControl.pivotElement=t,e.camera.perspective.near=.01,e.camera.perspective.far=3e3,e.camera.ortho.near=.01,e.camera.ortho.far=2e3;const i=e.sao;i.enabled=!0,i.numSamples=50,i.kernelRadius=200}_initCanvasContextMenus(){this._canvasContextMenu=new jp(this),this._objectContextMenu=new Np(this),this.viewer.cameraControl.on("rightClick",(e=>{e.event;const t=this.viewer.scene.pick({canvasPos:e.canvasPos});t&&t.entity.isObject?(this._canvasContextMenu.hide(),this._objectContextMenu.context={viewer:this.viewer,bimViewer:this,showObjectInExplorers:e=>{const t=this.getOpenTab();"objects"!==t&&"classes"!==t&&"storeys"!==t&&this.openTab("objects"),this.showObjectInExplorers(e)},entity:t.entity},this._objectContextMenu.show(e.pagePos[0],e.pagePos[1])):(this._objectContextMenu.hide(),this._canvasContextMenu.context={viewer:this.viewer,bimViewer:this},this._canvasContextMenu.show(e.pagePos[0],e.pagePos[1]))}))}_initConfigs(){this.setConfigs({cameraNear:"0.05",cameraFar:"3000.0",smartPivot:"true",saoEnabled:"true",pbrEnabled:"false",saoBias:"0.5",saoIntensity:"0.15",saoNumSamples:"40",saoKernelRadius:"100",edgesEnabled:!0,xrayContext:!0,xrayPickable:!1,selectedGlowThrough:!0,highlightGlowThrough:!0,backgroundColor:[1,1,1],objectColorSource:"model",externalMetadata:!1})}setConfigs(e){for(let t in e)if(e.hasOwnProperty(t)){const i=e[t];this.setConfig(t,i)}}setConfig(e,t){function i(e){return!0===e||"true"===e}try{switch(e){case"backgroundColor":const s=t;this.setBackgroundColor(s),this._configs[e]=s;break;case"cameraNear":const r=parseFloat(t);this.viewer.scene.camera.perspective.near=r,this.viewer.scene.camera.ortho.near=r,this._configs[e]=r;break;case"cameraFar":const o=parseFloat(t);this.viewer.scene.camera.perspective.far=o,this._configs[e]=o;break;case"smartPivot":this.viewer.cameraControl.smartPivot=this._configs[e]=i(t);break;case"saoEnabled":this._fastNavPlugin.saoEnabled=this._configs[e]=i(t);break;case"saoBias":this.viewer.scene.sao.bias=parseFloat(t);break;case"saoIntensity":this.viewer.scene.sao.intensity=parseFloat(t);break;case"saoKernelRadius":this.viewer.scene.sao.kernelRadius=this._configs[e]=parseFloat(t);break;case"saoNumSamples":this.viewer.scene.sao.numSamples=this._configs[e]=parseFloat(t);break;case"saoBlur":this.viewer.scene.sao.blur=this._configs[e]=i(t);break;case"edgesEnabled":this._fastNavPlugin.edgesEnabled=this._configs[e]=i(t);break;case"pbrEnabled":this._fastNavPlugin.pbrEnabled=this._configs[e]=i(t);break;case"viewFitFOV":this.viewer.cameraFlight.fitFOV=this._configs[e]=parseFloat(t);break;case"viewFitDuration":this.viewer.cameraFlight.duration=this._configs[e]=parseFloat(t);break;case"perspectiveFOV":this.viewer.camera.perspective.fov=this._configs[e]=parseFloat(t);break;case"excludeUnclassifiedObjects":case"xrayPickable":case"externalMetadata":this._configs[e]=i(t);break;case"objectColorSource":this.setObjectColorSource(t),this._configs[e]=t;break;case"xrayContext":this._configs[e]=t;break;case"selectedGlowThrough":const n=this._configs[e]=i(t),a=this.viewer.scene.selectedMaterial;a.glowThrough=n,a.fillAlpha=n?.5:1,a.edgeAlpha=n?.5:1;break;case"highlightGlowThrough":const l=this._configs[e]=i(t),h=this.viewer.scene.highlightMaterial;h.glowThrough=l,h.fillAlpha=l?.5:1,h.edgeAlpha=l?.5:1;break;case"showSpaces":this._configs[e]=i(t),this._showSpacesMode.setActive(t);break;default:this.error("setConfig() - unsupported configuration: '"+e+"'")}}catch(t){this.error("setConfig() - failed to configure '"+e+"': "+t)}}getConfig(e){return this._configs[e]}getProjectsInfo(e,t){e?this.server.getProjects(e,(e=>{this.error("getProjectsInfo() - "+e),t&&t(e)})):this.error("getProjectsInfo() - Argument expected: 'done'")}getProjectInfo(e,t,i){e?t?this.server.getProject(e,t,(e=>{this.error("getProjectInfo() - "+e),i&&i(e)})):this.error("getProjectInfo() - Argument expected: 'done'"):this.error("getProjectInfo() - Argument expected: projectId")}getObjectInfo(e,t,i,s,r){e?t?i?s?this.server.getObjectInfo(e,t,i,s,(e=>{r&&r(e)})):this.error("getProjectInfo() - Argument expected: 'done'"):this.error("getObjectInfo() - Argument expected: objectId"):this.error("getObjectInfo() - Argument expected: modelId"):this.error("getObjectInfo() - Argument expected: projectId")}loadProject(e,t,i){e?this._modelsExplorer.loadProject(e,(()=>{t&&t()}),(e=>{this.error("loadProject() - "+e),i&&i(e)})):this.error("loadProject() - Argument expected: objectId")}unloadProject(){this._modelsExplorer.unloadProject(),this.openTab("models"),this.setControlsEnabled(!1)}getLoadedProjectId(){return this._modelsExplorer.getLoadedProjectId()}getModelIds(){return this._modelsExplorer.getModelIds()}loadModel(e,t,i){e?this._modelsExplorer.loadModel(e,(()=>{t&&t()}),(e=>{this.error("loadModel() - "+e),i&&i(e)})):this.error("loadModel() - Argument expected: modelId")}loadAllModels(e=function(){}){const t=this._modelsExplorer.getModelIds(),i=(e,s)=>{if(e>=t.length)s();else{const r=t[e];this._modelsExplorer.isModelLoaded(r)?i(e+1,s):this._modelsExplorer.loadModel(r,(()=>{i(e+1,s)}),(t=>{this.error("loadAllModels() - "+t),i(e+1,s)}))}};i(0,e)}getLoadedModelIds(){return this._modelsExplorer._getLoadedModelIds()}isModelLoaded(e){if(e)return this._modelsExplorer.isModelLoaded(e);this.error("unloadModel() - Argument expected: modelId")}unloadModel(e){e?this._modelsExplorer.unloadModel(e):this.error("unloadModel() - Argument expected: modelId")}unloadAllModels(){this._modelsExplorer.unloadAllModels()}editModel(e){this.fire("editModel",{modelId:e})}deleteModel(e){this.fire("deleteModel",{modelId:e})}addModel(){this.fire("addModel",{})}setBackgroundColor(e){this.viewer.scene.canvas.backgroundColor=e}setObjectColorSource(e){switch(e){case"model":case"viewer":break;default:return e="model",void this.error("setObjectColorSource() - Unsupported value - accepted values are 'model' and 'viewer' - defaulting to 'model'")}this._objectColorSource=e}getObjectColorSource(){return this._objectColorSource||"model"}setViewerState(e,t=(()=>{})){e.tabOpen&&this.openTab(e.tabOpen),e.expandObjectsTree&&this._objectsExplorer.expandTreeViewToDepth(e.expandObjectsTree),e.expandClassesTree&&this._classesExplorer.expandTreeViewToDepth(e.expandClassesTree),e.expandStoreysTree&&this._storeysExplorer.expandTreeViewToDepth(e.expandStoreysTree),e.setCamera&&this.setCamera(e.setCamera),this._parseSelectedStorey(e,(()=>{this._parseThreeDMode(e,(()=>{t()}))}))}_parseSelectedStorey(e,t){e.selectedStorey?(this.selectStorey(e.selectedStorey),t()):t()}_parseThreeDMode(e,t){const i=!1!==e.threeDActive;this.set3DEnabled(i,t)}showObjectInExplorers(e){e?(this._objectsExplorer.showNodeInTreeView(e),this._classesExplorer.showNodeInTreeView(e),this._storeysExplorer.showNodeInTreeView(e),this.fire("openExplorer",{})):this.error("showObjectInExplorers() - Argument expected: objectId")}unShowObjectInExplorers(){this._objectsExplorer.unShowNodeInTreeView(),this._classesExplorer.unShowNodeInTreeView(),this._storeysExplorer.unShowNodeInTreeView()}showObjectProperties(e){e?(this._enablePropertiesInspector&&this._propertiesInspector.showObjectPropertySets(e),this.fire("openInspector",{})):this.error("showObjectInExplorers() - Argument expected: objectId")}setObjectsVisible(e,t){this._withObjectsInSubtree(e,(e=>{e.visible=t}))}setAllObjectsVisible(e){e?this.viewer.scene.setObjectsVisible(this.viewer.scene.objectIds,!0):this.viewer.scene.setObjectsVisible(this.viewer.scene.visibleObjectIds,!1)}setObjectsXRayed(e,t){this._withObjectsInSubtree(e,(e=>{e.xrayed=t}))}setAllObjectsXRayed(e){e?this.viewer.scene.setObjectsXRayed(this.viewer.scene.objectIds,!0):this.viewer.scene.setObjectsXRayed(this.viewer.scene.xrayedObjectIds,!1)}setObjectsSelected(e,t){this._withObjectsInSubtree(e,(e=>{e.selected=t}))}setAllObjectsSelected(e){e?this.viewer.scene.setObjectsSelected(this.viewer.scene.objectIds,!0):this.viewer.scene.setObjectsSelected(this.viewer.scene.selectedObjectIds,!1)}_withObjectsInSubtree(e,t){if(e)for(let i=0,s=e.length;i<s;i++){const s=e[i];this.viewer.metaScene.withMetaObjectsInSubtree(s,(e=>{const i=this.viewer.scene.objects[e.id];i&&t(i)}))}else this.error("Argument expected: objectIds")}flyToObject(e,t){if(!e)return void this.error("flyToObject() - Argument expected: objectId");const i=this.viewer,s=i.scene,r=[];if(this.viewer.metaScene.withMetaObjectsInSubtree(e,(e=>{s.objects[e.id]&&r.push(e.id)})),0===r.length)return this.error("Object not found in viewer: '"+e+"'"),void(t&&t());s.setObjectsVisible(r,!0),s.setObjectsHighlighted(r,!0);const o=s.getAABB(r);i.cameraFlight.flyTo({aabb:o},(()=>{t&&t(),setTimeout((function(){s.setObjectsHighlighted(s.highlightedObjectIds,!1)}),500)})),i.cameraControl.pivotPos=p.getAABB3Center(o)}viewFitObjects(e,t){if(!e)return void this.error("flyToObject() - Argument expected: objectIds");const i=this.viewer,s=i.scene,r=[];for(var o=0,n=e.length;o<n;o++){const t=e[o];this.viewer.metaScene.withMetaObjectsInSubtree(t,(e=>{s.objects[e.id]&&r.push(e.id)}))}if(0===r.length)return void(t&&t());s.setObjectsVisible(r,!0),s.setObjectsHighlighted(r,!0);const a=s.getAABB(r);i.cameraFlight.flyTo({aabb:a},(()=>{t&&t(),setTimeout((function(){s.setObjectsHighlighted(s.highlightedObjectIds,!1)}),500)})),i.cameraControl.pivotPos=p.getAABB3Center(a)}viewFitAll(e){const t=this.viewer,i=t.scene.getAABB();t.cameraFlight.flyTo({aabb:i},(()=>{e&&e()})),t.cameraControl.pivotPos=p.getAABB3Center(i)}jumpToObject(e){if(!e)return void this.error("jumpToObject() - Argument expected: objectId");const t=this.viewer,i=t.scene,s=[];if(this.viewer.metaScene.withMetaObjectsInSubtree(e,(e=>{i.objects[e.id]&&s.push(e.id)})),0===s.length)return void this.error("Object not found in viewer: '"+e+"'");i.setObjectsVisible(s,!0);const r=i.getAABB(s);t.cameraFlight.jumpTo({aabb:r}),t.cameraControl.pivotPos=p.getAABB3Center(r)}setCamera(e){const t=this.viewer.scene.camera;e.eye&&(t.eye=e.eye),e.look&&(t.look=e.look),e.up&&(t.up=e.up)}viewFitModels(e,t){if(!e)return void this.error("viewFitModels() - Argument expected: modelIds");const i=this.viewer,s=i.scene,r=p.AABB3();p.collapseAABB3(r);for(var o=0,n=e.length;o<n;o++){const t=e[o],i=s.models[t];i?(i.visible=!0,i.highlighted=!0,p.expandAABB3(r,i.aabb)):this.error("Model not found in viewer: '"+t+"'")}t?i.cameraFlight.flyTo({aabb:r},(()=>{t(),setTimeout((function(){s.setObjectsHighlighted(s.highlightedObjectIds,!1)}),500)})):(i.cameraFlight.jumpTo({aabb:r}),setTimeout((function(){s.setObjectsHighlighted(s.highlightedObjectIds,!1)}),500)),i.cameraControl.pivotPos=p.getAABB3Center(r)}openTab(e){if(!e)return void this.error("openTab() - Argument expected: tabId");let t;switch(e){case"models":t="xeokit-modelsTab";break;case"objects":t="xeokit-objectsTab";break;case"classes":t="xeokit-classesTab";break;case"storeys":t="xeokit-storeysTab";break;case"properties":t="xeokit-propertiesTab";break;default:return void this.error("openTab() - tab not recognized: '"+e+"'")}this._openTab(this._explorerElement,t)}_openTab(e,t){const i="active";let s=e.querySelectorAll(".xeokit-tab"),r=e.querySelector("."+t);for(let e=0;e<s.length;e++){let t=s[e];t.isEqualNode(r)?t.classList.add(i):t.classList.remove(i)}}getOpenTab(){function e(e,t){return!!e&&(" "+e.className+" ").indexOf(" "+t+" ")>-1}const t="active";return e(this._explorerElement.querySelector(".xeokit-modelsTab"),t)?"models":e(this._explorerElement.querySelector(".xeokit-objectsTab"),t)?"objects":e(this._explorerElement.querySelector(".xeokit-classesTab"),t)?"classes":e(this._explorerElement.querySelector(".xeokit-storeysTab"),t)?"storeys":e(this._inspectorElement.querySelector(".xeokit-propertiesTab"),t)?"properties":"none"}set3DEnabled(e,t){this._threeDMode.setActive(e,t)}get3DEnabled(){return this._threeDMode.getActive()}setSpacesShown(e){this._showSpacesMode.setActive(e)}getSpacesShown(){return this._showSpacesMode.getActive()}setOrthoEnabled(e,t){this._orthoMode.setActive(e,t)}getOrthoEnabled(){return this._orthoMode.getActive()}selectStorey(e,t){const i=this.viewer.metaScene.metaObjects[e];i?"IfcBuildingStorey"===i.type?this._storeysExplorer.selectStorey(e,t):this.error("selectStorey() - Object is not an IfcBuildingStorey: '"+e+"'"):this.error("selectStorey() - Object is not found: '"+e+"'")}saveBCFViewpoint(e){return this._bcfViewpointsPlugin.getViewpoint(e)}loadBCFViewpoint(e,t){e?(this._orthoMode.setActive("ortho"===this.viewer.camera.projection),this._bcfViewpointsPlugin.setViewpoint(e,t)):this.error("loadBCFViewpoint() - Argument expected: bcfViewpoint")}resetView(){this._resetAction.reset()}setControlsEnabled(e){this._objectsExplorer.setEnabled(e),this._classesExplorer.setEnabled(e),this._storeysExplorer.setEnabled(e),this._resetAction.setEnabled(e),this._fitAction.setEnabled(e),this._threeDMode.setEnabled(e),this._orthoMode.setEnabled(e),this._firstPersonMode.setEnabled(e),this._queryTool.setEnabled(e),this._hideTool.setEnabled(e),this._selectionTool.setEnabled(e),this._marqueeSelectionTool.setEnabled(e),this._showSpacesMode.setEnabled(e),this._sectionTool.setEnabled(e),this._enablePropertiesInspector&&this._propertiesInspector.setEnabled(e)}setKeyboardEnabled(e){this.viewer.scene.input.keyboardEnabled=e}getKeyboardEnabled(){return this.viewer.scene.input.keyboardEnabled}clearSections(){this._sectionTool.clear()}flipSections(){this._sectionTool.flipSections()}hideSectionEditControl(){this._sectionTool.hideControl()}getNumSections(){return this._sectionTool.getNumSections()}destroy(){this.viewer.destroy(),this._bcfViewpointsPlugin.destroy(),this._canvasContextMenu.destroy(),this._objectContextMenu.destroy()}},e.LocaleService=Do,e.Server=class{constructor(e={}){this._dataDir=e.dataDir||""}getProjects(e,t){const i=this._dataDir+"/projects/index.json";v.loadJSON(i,e,t)}getProject(e,t,i){const s=this._dataDir+"/projects/"+e+"/index.json";v.loadJSON(s,t,i)}getMetadata(e,t,i,s){const r=this._dataDir+"/projects/"+e+"/models/"+t+"/metadata.json";v.loadJSON(r,i,s)}getGeometry(e,t,i,s){const r=this._dataDir+"/projects/"+e+"/models/"+t+"/geometry.xkt";v.loadArraybuffer(r,i,s)}getObjectInfo(e,t,i,s,r){const o=this._dataDir+"/projects/"+e+"/models/"+t+"/props/"+i+".json";v.loadJSON(o,s,r)}getIssues(e,t,i,s){const r=this._dataDir+"/projects/"+e+"/models/"+t+"/issues.json";v.loadJSON(r,i,s)}},Object.defineProperty(e,"__esModule",{value:!0})}));
